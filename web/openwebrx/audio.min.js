

/* web/openwebrx/audio.min.js (web/openwebrx/audio.js = Thu Feb  2 10:15:31 2023) */
var audio_stat_output_bufs,audio_stat_last_time,audio_running,audio_started,audio_last_output_offset,audio_mode_iq,audio_compression,audio_stat_input_epoch,audio_prepared_buffers,audio_prepared_buffers2,audio_prepared_seq,audio_prepared_flags,audio_prepared_smeter,audio_buffering,audio_convolver_running,audio_meas_dly,audio_meas_dly_start,resample_new,resample_old,resample_init1,resample_init2,resample_input_buffer,resample_input_available,resample_input_processed,resample_last_taps_delay,resample_output_buffer,resample_output_buffer2,resample_output_size,resample_taps,resample_taps_length,resample_last,resample_last2,audio_ext_adc_ovfl,audio_need_stats_reset,audio_change_LPF_latch,audio_change_freq_latch,audio_change_sq_UI_latch,audio_last_sq,audio_gain,comp_lpf_freq,comp_lpf_taps,comp_lpf_taps_length,audio_buffer_size,audio_buffer_min_length_sec,audio_buffer_max_length_sec,audio_data,audio_data_unsquelched,audio_last_output_buffer,audio_last_output_buffer2,audio_silence_buffer,audio_stats_interval,audio_periodic_interval,audio_context,audio_output_rate,audio_last_is_local,audio_last_compression,audio_input_rate,audio_interpolation,audio_decimation,audio_resample_ratio,audio_transition_bw,audio_min_nbuf,audio_max_nbuf,audio_stat_output_epoch,audio_channels,audio_source,audio_watchdog,audio_change_LPF_delayed,audio_disconnected,audio_convolver,audio={d:!1,last_flags:0,trim_bufs:!1,buffer_size:8192,lo_cut:0,hi_cut:0,SND_FLAG_LPF:1,SND_FLAG_ADC_OVFL:2,SND_FLAG_NEW_FREQ:4,SND_FLAG_MODE_IQ:8,SND_FLAG_COMPRESSED:16,SND_FLAG_RESTART:32,SND_FLAG_SQUELCH_UI:64,SND_FLAG_LITTLE_ENDIAN:128,SND_FLAG_SET_ACTIVE:256,SND_FLAG_CLR_ACTIVE:512,SND_FLAG_TUNE_ACK:1024,cur_flags2:0,last_msec:0,_last:0},audio_periodic_interval_ms=1e3,audio_ext_sequence=0,audio_meas_dly_ena=0,audio_initial_connect=!1,audio_watchdog_restart=!1,audio_stat_input_size=0,audio_stat_total_input_size=0,audio_reconnect=0,audio_silence_count=0,audio_restart_count=0,audio_underrun_errors=0,audio_overrun_errors=0,audio_last_underruns=0,audio_last_reconnect=0,audio_last_restart_count=0,resample_new_default=!1,audio_adpcm={index:0,previousValue:0},audio_panner=null,audio_instance=0,audio_camping=0,audio_init_disconnect=0,audio_firefox_watchdog=0;function audio_camp(e,_,a,o){audio_camping=e?0:1,audio_init_disconnect=e,audio_init(_,a,o),audio_meas_dly_ena=audio_ext_sequence=0,audio_watchdog_restart=audio_initial_connect=!1}function audio_reset(){audio.trim_bufs=!0}function audio_init(e,_,a){if(audio_running=!1,kiwi_clearInterval(audio_periodic_interval),console.log("--------------------------"),audio.d&&console.log("AUDIO audio_init CALLED audio_init_disconnect="+audio_init_disconnect+" is_local="+e+" less_buffering="+_+" compression="+a),_=!1,audio.d&&console.log("AUDIO audio_init LAST audio_last_is_local="+audio_last_is_local+" audio_last_compression="+audio_last_compression),audio_last_is_local=e=null==e?audio_last_is_local:e,audio_last_compression=a=null==a?audio_last_compression:a,console.log("AUDIO audio_init FINAL is_local="+e+" less_buffering="+_+" compression="+a),!audio_init_disconnect&&null==audio_source||(audio.d&&console.log("AUDIO audio_init audio_disconnect"),audio_disconnect()),audio_mode_iq=audio_started=!1,audio_compression=!!a,audio_stat_input_epoch=-1,audio_prepared_buffers=[],audio_prepared_buffers2=[],audio_prepared_seq=[],audio_prepared_flags=[],audio_convolver_running=audio_buffering=!(audio_prepared_smeter=[]),audio_meas_dly_start=audio_meas_dly=audio_last_output_offset=0,resample_new=!kiwi_isMobile()&&resample_new_default,resample_old=!resample_new,resample_init2=resample_init1=!1,resample_input_buffer=[],resample_output_buffer=[],resample_output_buffer2=[],resample_taps=[],comp_lpf_freq=resample_last2=resample_last=resample_last_taps_delay=resample_input_processed=resample_input_available=0,comp_lpf_taps=[],comp_lpf_taps_length=255,audio_adpcm.index=0,audio_adpcm.previousValue=0,audio_change_sq_UI_latch=audio_change_freq_latch=audio_change_LPF_latch=!(audio_need_stats_reset=!(audio_ext_adc_ovfl=!1)),audio_last_sq=void 0,audio_firefox_watchdog=0,kiwi_clearInterval(audio_stats_interval),audio_init_disconnect)return audio.d&&console.log("AUDIO audio_init DISCONNECT"),audio_init_disconnect=0,!1;var o,i=0,u=kiwi_url_param("abuf",null,null),t=0;null!=u&&(a=u.split(","),t=parseFloat(a[0]),!isNaN(t)&&.25<=t&&t<=5?(console.log("AUDIO override abuf="+u),o=3*t,2<=a.length?(a=parseFloat(a[1]),!isNaN(a)&&.25<=a&&a<=5&&t<a&&(o=a)):o=3*t,audio_buffer_min_length_sec=t,audio_buffer_max_length_sec=o,audio_buffer_size=audio.buffer_size,i=9,o="abuf="):t=0),0==t&&(2==(i=_?e?2:1:0)?(audio_buffer_size=audio.buffer_size,audio_buffer_min_length_sec=.37,audio_buffer_max_length_sec=2,o="less buf, local"):1==i?(audio_buffer_size=audio.buffer_size,audio_buffer_min_length_sec=.74,audio_buffer_max_length_sec=3,o="less buf, remote"):0==i&&(audio_buffer_size=audio.buffer_size,audio_buffer_min_length_sec=.85,audio_buffer_max_length_sec=3.4,o="more buf")),audio_data=new Int16Array(audio_buffer_size),audio_data_unsquelched=new Int16Array(audio_buffer_size),audio_last_output_buffer=new Float32Array(audio_buffer_size),audio_last_output_buffer2=new Float32Array(audio_buffer_size),audio_silence_buffer=new Float32Array(audio_buffer_size),console.log("AUDIO buffer_size="+audio_buffer_size+" buffering_scheme: "+o),audio_stats_interval=setInterval(audio_stats,1e3);try{window.AudioContext=window.AudioContext||window.webkitAudioContext,(audio_context=new AudioContext).sampleRate=44100,audio_output_rate=audio_context.sampleRate;try{audio_panner=audio_context.createStereoPanner(),audio_panner_ui_init()}catch(e){audio_panner=null}"LG"==kiwi_isSmartTV()&&(audio_gain=audio_context.createGain())}catch(e){return kiwi_serious_error("Your browser does not support Web Audio API, which is required for OpenWebRX to run. Please use an HTML5 compatible browser."),audio_context=null,!(audio_output_rate=0)}return audio_instance++,setTimeout(function(e){snd_send("SET little-endian")},1e4,audio_instance),!(audio_running=!0)}function audio_rate(e){if(0==(audio_input_rate=e))snd_send("SET x-DEBUG user's browser gave zero audio_input_rate?"),kiwi_serious_error("Audio initialization problem.");else if(0==audio_output_rate)snd_send("SET x-DEBUG user's browser doesn't support WebAudio"),snd_send("SET x-DEBUG "+navigator.userAgent),kiwi_serious_error("Browser doesn't support WebAudio:<br>"+navigator.userAgent+"<br><br>Please update to the latest version of your browser.");else if(resample_old)audio_interpolation=audio_output_rate/audio_input_rate,audio_decimation=1;else if((audio_interpolation=0)==audio_interpolation){for(var _=2;_<=1024;_++){var a=e*_/audio_output_rate,o=Math.floor(a);if(Math.abs(a-o)<1e-5)break}1024<_?(snd_send("SET UAR in="+e+" out="+audio_output_rate),kiwi_serious_error("Your system uses an audio output rate of "+audio_output_rate+" sps which we do not support.")):(audio_interpolation=_,audio_decimation=o)}0!=audio_interpolation?(audio_transition_bw=.001,audio_resample_ratio=audio_output_rate/audio_input_rate,snd_send("SET AR OK in="+e+" out="+audio_output_rate)):audio_resample_ratio=1,audio_min_nbuf=Math.ceil(audio_buffer_min_length_sec*audio_output_rate/audio_buffer_size),audio_max_nbuf=Math.ceil(audio_buffer_max_length_sec*audio_output_rate/audio_buffer_size),console.log("AUDIO audio_input_rate="+audio_input_rate+" audio_output_rate="+audio_output_rate),console.log("AUDIO min_length_sec="+audio_buffer_min_length_sec+"("+audio_min_nbuf+" bufs) max_length_sec="+audio_buffer_max_length_sec+"("+audio_max_nbuf+" bufs)")}function audio_start(){if(audio.d&&console.log("AUDIO audio_start"),null!=audio_context){audio_started=!0,audio_connect(0),audio_periodic_interval=setInterval(audio_periodic,audio_periodic_interval_ms);try{demodulator_analog_replace(init_mode)}catch(e){snd_send("SET x-DEBUG audio_start.demodulator_analog_replace: catch: "+e.toString())}}}function audio_disconnect(){audio.d&&console.log("AUDIO audio_disconnect"),audio_source&&(audio_disconnected=!0,audio_source.disconnect(),audio_source.onaudioprocess=null,audio_source=null),audio_convolver_running&&(audio_convolver.disconnect(),audio_convolver_running=!1),audio_watchdog&&(audio_watchdog.disconnect(),audio_watchdog.onaudioprocess=null,audio_watchdog=null),audio_panner&&audio_panner.disconnect()}function audio_connect_destination(e){"LG"==kiwi_isSmartTV()&&(audio_gain.gain.value=.3,e.connect(audio_gain),e=audio_gain),audio_panner?(e.connect(audio_panner),audio_panner.connect(audio_context.destination)):e.connect(audio_context.destination)}function audio_set_pan(e){if(audio_panner)try{audio_panner.pan.value=e}catch(e){}}function audio_connect(e){null!=audio_context&&(!audio_initial_connect&&e||(e||(audio_initial_connect=!0),e&&(audio_disconnect(),resample_init1=resample_init2=!1,audio_reconnect++,kiwi_log("AUDIO reconnect BUFFERING true"),audio_buffering=!0),audio_change_LPF_delayed=!(audio_stat_output_epoch=-1),(audio_source=audio_context.createScriptProcessor(audio_buffer_size,0,audio_channels)).onaudioprocess=audio_onprocess,audio_disconnected=!1,audio_convolver_running?(audio_source.connect(audio_convolver),audio_connect_destination(audio_convolver)):audio_connect_destination(audio_source),kiwi_isFirefox()&&((audio_watchdog=audio_context.createScriptProcessor(audio_buffer_size,audio_channels,0)).onaudioprocess=audio_watchdog_process,(audio_convolver_running?audio_convolver:audio_source).connect(audio_watchdog)),audio_pre_record_buf_init()))}function audio_watchdog_process(e){kiwi.muted||audio_buffering?audio_silence_count=0:(e=0==e.inputBuffer.getChannelData(0)[0],kiwi_gc_snd,16<(audio_silence_count=e?audio_silence_count+1:0)&&(audio_connect(1),audio_silence_count=0,audio_restart_count++,add_problem("FF silence"),kiwi_log("AUDIO FF SILENCE")))}function audio_onprocess(e){if(audio_firefox_watchdog++,!audio_disconnected){if(-1==audio_stat_output_epoch&&(audio_stat_output_epoch=(new Date).getTime(),audio_stat_output_bufs=0),audio_stat_output_bufs++,audio_started&&0==audio_prepared_buffers.length&&(audio_underrun_errors++,audio_buffering=!0),!audio_started||audio_buffering)return audio_need_stats_reset=!0,e.outputBuffer.copyToChannel(audio_silence_buffer,0),void(2==audio_channels&&e.outputBuffer.copyToChannel(audio_silence_buffer,1));e.outputBuffer.copyToChannel(audio_prepared_buffers.shift(),0),2==audio_channels&&e.outputBuffer.copyToChannel(audio_prepared_buffers2.shift(),1),audio_ext_sequence=audio_prepared_seq.shift(),audio_change_LPF_delayed&&(audio_recompute_LPF(0),audio_change_LPF_delayed=!1),owrx.sMeter_dBm_biased=audio_prepared_smeter.shift()/10,owrx.sMeter_dBm=owrx.sMeter_dBm_biased-SMETER_BIAS;var _=audio_prepared_flags.shift();audio_ext_adc_ovfl=!!(_&audio.SND_FLAG_ADC_OVFL),_&audio.SND_FLAG_LPF&&(audio_change_LPF_delayed=!0);e=!!(_&audio.SND_FLAG_SQUELCH_UI);e!=audio_last_sq&&isDefined(squelch_action)&&(setTimeout(function(e){squelch_action(e)},1,e),audio_last_sq=e),_&audio.SND_FLAG_TUNE_ACK&&setTimeout(function(e){w3_call("ale_2g_tune_ack",e)},10,audio.tune_freq),audio_meas_dly_ena&&audio_meas_dly_start&&_&audio.SND_FLAG_NEW_FREQ&&(audio_meas_dly=(new Date).getTime()-audio_meas_dly_start,kiwi_log("AUDIO dly="+audio_meas_dly),audio_meas_dly_start=0)}}var audio_watchdog_restart_cnt=0;function audio_periodic(){if("running"==audio_context.state){audio_started&&audio_prepared_buffers.length&&0==audio_firefox_watchdog&&kiwi_isFirefox()&&!cfg.disable_recent_changes&&(add_problem("FF watchdog"),console.log("AUDIO FF WATCHDOG Q"+audio_prepared_buffers.length+" WD="+audio_firefox_watchdog+" ============================================"),audio_init(null,!1,null),audio_watchdog_restart=!(audio_initial_connect=!1),snd_send("SET reinit"));for(var e=!1;audio_prepared_buffers.length>audio_max_nbuf;)e=!0,audio_prepared_buffers.shift(),2==audio_channels&&audio_prepared_buffers2.shift(),audio_prepared_seq.shift(),audio_prepared_flags.shift(),audio_prepared_smeter.shift();e&&(add_problem("audio overrun"),audio_overrun_errors++),audio_last_underruns!=audio_underrun_errors&&(add_problem("audio underrun"),snd_send("SET underrun="+audio_underrun_errors),audio_last_underruns=audio_underrun_errors)}else for(;0<audio_prepared_buffers.length;)audio_prepared_buffers.shift(),2==audio_channels&&audio_prepared_buffers2.shift(),audio_prepared_seq.shift(),audio_prepared_flags.shift(),audio_prepared_smeter.shift()}function audio_adpcm_state(e,_){audio_adpcm.index=e,audio_adpcm.previousValue=_,audio_camping=2}function audio_pre_record_buf_init(){var e,_,a;0==pre_record||isUndefined(cur_mode)?kiwi.pre_buf=null:(a=Math.round(audio_input_rate||12e3),e=ext_is_IQ_or_stereo_curmode()?2:1,_=pre_record_v[pre_record]+1,1&(a=Math.round(_*e*a))&&a++,console.log("AUDIO pre_record init: samps="+a+" time="+pre_record_v[pre_record]),kiwi.pre_samps=a,kiwi.pre_size=2*a,kiwi.pre_last=kiwi.pre_size-2,kiwi.pre_buf=new ArrayBuffer(kiwi.pre_size),kiwi.pre_data=new DataView(kiwi.pre_buf),kiwi.pre_off=0,kiwi.pre_wrapped=!1,kiwi.pre_captured=!1,kiwi.pre_ping_pong=0)}function audio_recv(e){if(audio_running){var _=new Uint8Array(e,0,8),a=_[3],o=a&audio.SND_FLAG_SQUELCH_UI,i=_[7]<<24|_[6]<<16|_[5]<<8|_[4];if(!(1==audio_camping&&a&audio.SND_FLAG_COMPRESSED)){var u,t,r,d,n=new Uint8Array(e,8,2),s=n[0]<<8|n[1],_=a&audio.SND_FLAG_MODE_IQ,p=new DataView(e,_?20:10),n=p.byteLength;if(audio_watchdog_restart){if(!(a&audio.SND_FLAG_RESTART))return;audio_watchdog_restart=!1,audio_prepared_buffers=[],audio_prepared_buffers2=[],audio_prepared_seq=[],audio_prepared_flags=[],audio_prepared_smeter=[],resample_old=audio_mode_iq?!(resample_new=!1):(audio_adpcm.index=audio_adpcm.previousValue=0,!(resample_new=!kiwi_isMobile()&&resample_new_default)),audio_connect(1)}else audio_mode_iq=_?(audio_mode_iq||(audio_prepared_buffers=[],audio_prepared_buffers2=[],audio_prepared_seq=[],audio_prepared_flags=[],resample_old=!(resample_new=!(audio_prepared_smeter=[])),audio_mode_iq=!0,audio_channels=2,audio.d&&console.log("AUDIO !IQ -> IQ transition"),audio_connect(1)),audio_last_compression=audio_compression=!1,!0):(e=!!(a&audio.SND_FLAG_COMPRESSED),!audio_mode_iq&&audio_compression==e||(audio_prepared_buffers=[],audio_prepared_buffers2=[],audio_prepared_seq=[],audio_prepared_flags=[],audio_prepared_smeter=[],audio_adpcm.index=audio_adpcm.previousValue=0,resample_new=!kiwi_isMobile()&&resample_new_default,resample_old=!resample_new,audio.d&&(audio_mode_iq?console.log("AUDIO IQ -> !IQ transition, compressed="+e):console.log("AUDIO !IQ, compression change="+(audio_compression!=e)+" compressed="+e)),audio_mode_iq=!1,audio_last_compression=audio_compression=e,audio_connect(audio_channels=1)),audio_last_compression=audio_compression=e,!1);if(audio_channels=audio_mode_iq?2:1,audio_compression)audio.d&&(d=(r=Date.now())-audio.last_msec,audio.last_msec=r,console.log("AC Q"+audio_prepared_buffers.length+" "+audio_channels+"ch "+d)),decode_ima_adpcm_e8_i16(p,audio_data,audio_data_unsquelched,o,n,audio_adpcm),t=2*n;else for(audio.d&&(d=(r=Date.now())-audio.last_msec,audio.last_msec=r,_?console.log("ANC IQ Q"+audio_prepared_buffers.length+"/"+audio_prepared_buffers2.length+" "+audio_channels+"ch "+d):console.log("ANC Q"+audio_prepared_buffers.length+" "+audio_channels+"ch "+d)),t=n/2,u=0;u<t;u++)audio_data_unsquelched[u]=p.getInt16(2*u,!!(a&audio.SND_FLAG_LITTLE_ENDIAN)),audio_data[u]=o?1:audio_data_unsquelched[u];audio_prepare(audio_data,t,i,a,s),audio_started||audio_prepared_buffers.length>audio_min_nbuf&&audio_start(),audio_need_stats_reset&&audio_stats_reset(),audio_stat_input_size+=t,audio_stat_total_input_size+=t,extint_audio_data(audio_data,t),wf.audioFFT_active&&wf_audio_FFT(audio_data,t),audio_record(audio_compression)}}}function audio_record(e){var a=audio_mode_iq?1024:e?2048:512,e=function(){if(kiwi.pre_buf){for(var e=0;e<a;e++){var _=audio_data_unsquelched[e];kiwi.pre_data.setInt16(kiwi.pre_off,_,!0),kiwi.pre_off+=2,kiwi.pre_off>=kiwi.pre_size&&(kiwi.pre_off=0,kiwi.pre_wrapped=!0,kiwi.pre_ping_pong^=1)}kiwi.pre_captured=!0}};if(window.recording){function _(){65536==window.recording_meta.offset&&(window.recording_meta.buffers.push(new ArrayBuffer(65536)),window.recording_meta.data=new DataView(window.recording_meta.buffers[window.recording_meta.buffers.length-1]),window.recording_meta.offset=0)}if(1==audio_last_sq)e();else{if(kiwi.pre_captured){if(kiwi.pre_wrapped){console.log("AUDIO pre_record WRAPPED insert pre_off="+kiwi.pre_off+" "+(kiwi.pre_size-kiwi.pre_off)+"+"+kiwi.pre_off+"="+kiwi.pre_size+" ping_pong="+kiwi.pre_ping_pong);for(var o=kiwi.pre_off;o<kiwi.pre_size;o+=2){var i=kiwi.pre_data.getInt16(o,!0);window.recording_meta.data.setInt16(window.recording_meta.offset,i,!0),window.recording_meta.offset+=2,_()}window.recording_meta.total_size+=kiwi.pre_size-kiwi.pre_off;for(o=0;o<kiwi.pre_off;o+=2){i=kiwi.pre_data.getInt16(o,!0);window.recording_meta.data.setInt16(window.recording_meta.offset,i,!0),window.recording_meta.offset+=2,_()}window.recording_meta.total_size+=kiwi.pre_off}else{console.log("AUDIO pre_record NOT-WRAPPED insert pre_off="+kiwi.pre_off+"/"+kiwi.pre_size+" ping_pong="+kiwi.pre_ping_pong);for(o=0;o<kiwi.pre_off;o+=2){i=kiwi.pre_data.getInt16(o,!0);window.recording_meta.data.setInt16(window.recording_meta.offset,i,!0),window.recording_meta.offset+=2,_()}window.recording_meta.total_size+=kiwi.pre_off}kiwi.pre_off=0,kiwi.pre_wrapped=!1,kiwi.pre_captured=!1,kiwi.pre_ping_pong=0}for(o=0;o<a;++o)window.recording_meta.data.setInt16(window.recording_meta.offset,audio_data[o],!0),window.recording_meta.offset+=2,_();window.recording_meta.total_size+=2*a}}else e()}function audio_recv_flags2(e){var _=e.split(":");switch(_[0]){case"active":var a=+_[1];console.log("$ active="+a),audio.cur_flags2|=a?audio.SND_FLAG_SET_ACTIVE:SND_FLAG_CLR_ACTIVE;break;case"tune_ack":audio.tune_freq=+_[1],console.log("$ tune_ack="+audio.tune_freq),audio.cur_flags2|=audio.SND_FLAG_TUNE_ACK}}var audio_push_ct=0;function audio_prepare(e,_,a,o,i){function u(){audio_prepared_buffers.push(audio_last_output_buffer),2==audio_channels&&audio_prepared_buffers2.push(audio_last_output_buffer2),audio_prepared_seq.push(a),audio_change_LPF_latch&&(audio_change_LPF_latch=!1,o|=audio.SND_FLAG_LPF),audio_change_freq_latch&&(audio_change_freq_latch=!1,o|=audio.SND_FLAG_NEW_FREQ),audio_change_sq_UI_latch&&(audio_change_sq_UI_latch=!1,o|=audio.SND_FLAG_SQUELCH_UI),audio.cur_flags2&&(o|=audio.cur_flags2,audio.cur_flags2=0),audio_prepared_flags.push(o),audio_prepared_smeter.push(i),audio_last_output_offset=0,audio_last_output_buffer=new Float32Array(audio_buffer_size),2==audio_channels&&(audio_last_output_buffer2=new Float32Array(audio_buffer_size))}function t(e,_,a,o,i){for(var u=0;u<i;u++)e[_+u]=a[o+u]}var r,d,n,s,p=resample_new&&audio_compression&&comp_lpf_taps_length;if(0!=_){if(1!=audio_resample_ratio){if(resample_init1||((resample_taps_length=Math.round(4/audio_transition_bw))%2==0&&resample_taps_length++,rational_resampler_get_lowpass_f(resample_taps,resample_taps_length,audio_interpolation,audio_decimation),resample_init1=!0),!resample_init2&&resample_init1&&(p||resample_old)&&null!=audio_source&&(audio_recompute_LPF(1),p=comp_lpf_taps,s=comp_lpf_taps_length,(audio_convolver=audio_context.createConvolver()).normalize=!1,audio_reload_convolver_buffer(p,s),audio.d&&console.log("AUDIO splice in convolver"),audio_source.disconnect(),audio_source.connect(audio_convolver),audio_connect_destination(audio_convolver),kiwi_isFirefox()&&audio_convolver.connect(audio_watchdog),resample_init2=audio_convolver_running=!0),resample_old)if(2==audio_channels){resample_output_size=Math.round(_/2*audio_resample_ratio);var l,f=1/audio_resample_ratio,c=0,m=0;for(b=0;b<resample_output_size;b++)g=e[2*c],w=resample_last,resample_output_buffer[b]=(g-w)*m+w,l=e[2*c+1],w=resample_last2,resample_output_buffer2[b]=(l-w)*m+w,1<=(m+=f)&&(--m,resample_last=g,resample_last2=l,c++);resample_last=g,resample_last2=l}else{resample_output_size=Math.round(_*audio_resample_ratio);var g,w,f=1/audio_resample_ratio,c=0,m=0;for(b=0;b<resample_output_size;b++)g=e[c],w=resample_last,resample_output_buffer[b]=(g-w)*m+w,1<=(m+=f)&&(--m,resample_last=g,c++);resample_last=g}else 0!=resample_input_processed&&(t(resample_input_buffer,0,resample_input_buffer,resample_input_processed,s=resample_input_available-resample_input_processed),resample_input_available=s,resample_input_processed=0),t(resample_input_buffer,resample_input_available,e,0,_),resample_input_available+=_,2==audio_channels?rational_resampler_cc(resample_input_buffer,resample_output_buffer,resample_output_buffer2,resample_input_available,audio_interpolation,audio_decimation,resample_taps,resample_taps_length,resample_last_taps_delay):rational_resampler_ff(resample_input_buffer,resample_output_buffer,resample_input_available,audio_interpolation,audio_decimation,resample_taps,resample_taps_length,resample_last_taps_delay);r=resample_output_buffer,d=resample_output_buffer2,n=resample_output_size}else r=e,n=_;if(o&audio.SND_FLAG_LPF&&(audio_change_LPF_latch=!0),o&audio.SND_FLAG_NEW_FREQ||audio.trim_bufs){audio_change_freq_latch=!0,audio.trim_bufs=!1;for(var _=audio_prepared_buffers.length,h=audio_min_nbuf;audio_prepared_buffers.length>h;)audio_prepared_buffers.pop(),2==audio_channels&&audio_prepared_buffers2.pop(),audio_prepared_seq.pop(),audio_prepared_flags.pop(),audio_prepared_smeter.pop()}if(o&audio.SND_FLAG_SQUELCH_UI&&(audio_change_sq_UI_latch=!0),audio_last_output_offset+n<=audio_buffer_size){if(2==audio_channels)for(var b=0;b<n;b++)audio_last_output_buffer[b+audio_last_output_offset]=r[b]/32768*kiwi.volume_f,audio_last_output_buffer2[b+audio_last_output_offset]=d[b]/32768*kiwi.volume_f;else for(b=0;b<n;b++)audio_last_output_buffer[b+audio_last_output_offset]=r[b]/32768*kiwi.volume_f;(audio_last_output_offset+=n)==audio_buffer_size&&u()}else{var v=audio_buffer_size-audio_last_output_offset,A=n-v;if(2==audio_channels)for(var b=0;b<audio_buffer_size-audio_last_output_offset;b++)audio_last_output_buffer[b+audio_last_output_offset]=r[b]/32768*kiwi.volume_f,audio_last_output_buffer2[b+audio_last_output_offset]=d[b]/32768*kiwi.volume_f;else for(b=0;b<audio_buffer_size-audio_last_output_offset;b++)audio_last_output_buffer[b+audio_last_output_offset]=r[b]/32768*kiwi.volume_f;u();do{for(b=0;b<A;b++){if(b==audio_buffer_size){u();break}audio_last_output_buffer[b]=r[b+v]/32768*kiwi.volume_f,2==audio_channels&&(audio_last_output_buffer2[b]=d[b+v]/32768*kiwi.volume_f)}}while(v+=b,A-=b);audio_last_output_offset+=b}audio_buffering&&audio_prepared_buffers.length>audio_min_nbuf&&(audio_buffering=!1)}}try{AudioBuffer.prototype.copyToChannel||(AudioBuffer.prototype.copyToChannel=function(e,_){for(var a=this.getChannelData(_),o=0;o<e.length;o++)a[o]=e[o]})}catch(e){console.log("CATCH: AudioBuffer.prototype.copyToChannel")}function audio_stats_reset(){audio_stat_input_epoch=(new Date).getTime(),audio_stat_last_time=audio_stat_input_epoch,audio_stat_input_size=audio_stat_total_input_size=0,audio_need_stats_reset=!1}function audio_stats(){var e,_,a;-1!=audio_stat_input_epoch&&-1!=audio_stat_output_epoch&&(_=(new Date).getTime(),e=audio_stat_input_size/((_-audio_stat_last_time)/1e3),a=audio_stat_total_input_size/(((audio_stat_last_time=_)-audio_stat_input_epoch)/1e3),_=audio_stat_output_bufs*audio_buffer_size/((_-audio_stat_output_epoch)/1e3),audio.d&&(a="Audio: network "+e.toFixed(0)+" sps ("+a.toFixed(0)+" avg), output "+_.toFixed(0)+" sps",a+=", Qlen "+audio_prepared_buffers.length,audio_underrun_errors&&(a+=", underruns "+audio_underrun_errors.toString()),audio_restart_count&&(a+=", restart "+audio_restart_count.toString()),console.log(a)),isNaN(_)&&(_=0),w3_innerHTML("id-status-audio",w3_text(optbar_prefix_color,"WF"),w3_text("",kiwi.wf_fps.toFixed(0)+" fps"),w3_text(optbar_prefix_color,"Audio"),w3_text("",(_/1e3).toFixed(1)+"k, Qlen "+audio_prepared_buffers.length)),audio_stat_input_size=0)}function audio_recompute_LPF(e,_,a){isDefined(_)&&isDefined(a)&&(audio.lo_cut=Math.abs(_),audio.hi_cut=Math.abs(a)),audio_camping?(_=audio.lo_cut,a=audio.hi_cut):isDefined(demodulators[0])?(a=Math.abs(demodulators[0].high_cut),isNaN(a)&&console.log(demodulators[0]),_=Math.abs(demodulators[0].low_cut)):(_=0,a=4e3);_=Math.max(a,_);!e&&_==comp_lpf_freq||(firdes_lowpass_f(comp_lpf_taps,comp_lpf_taps_length,_/audio_output_rate),comp_lpf_freq=_,audio_convolver_running&&audio_reload_convolver_buffer(comp_lpf_taps,comp_lpf_taps_length))}function audio_reload_convolver_buffer(e,_){var a=audio_context.createBuffer(2,_,audio_output_rate),_=a.getChannelData(0);_.set(e),(_=a.getChannelData(1)).set(e),audio_convolver.buffer=a}function rational_resampler_ff(e,_,a,o,i,u,t,r){for(var d,n,s=Math.round(a*o/i),p=0;p<s&&(d=Math.floor((p*i+o-1-r)/o),n=Math.floor((r+d*o-p*i)%o),!(a<d+t/o+1));p++){for(var l=Math.floor((t-n)/o),f=0,c=0;c<l;c++)f+=e[d+c]*u[n+c*o];_[p]=f*o}resample_input_processed=d,resample_output_size=p,resample_last_taps_delay=n}function rational_resampler_cc(e,_,a,o,i,u,t,r,d){console.log("WARNING rational_resampler_cc() not working yet!")}function rational_resampler_get_lowpass_f(e,_,a,o){a=1/a,o=1/o;firdes_lowpass_f(e,_,(a<o?a:o)/2)}function firdes_lowpass_f(e,_,a){var o=Math.floor(_/2);for(e[o]=2*Math.PI*a*firdes_wkernel_hamming(0),u=1;u<=o;u++)e[o-u]=e[o+u]=Math.sin(2*Math.PI*a*u)/u*firdes_wkernel_hamming(u/o);for(var i=0,u=0;u<_;u++)i+=e[u];for(u=0;u<_;u++)e[u]/=i}function firdes_wkernel_hamming(e){return e=.5+e/2,.54-.46*Math.cos(2*Math.PI*e)}



