

/* web/extensions/ALE_2G/ALE_2G.min.js */
var ale={ext_name:"ALE_2G",first_time:!0,dataH:300,ctrlW:600,ctrlH:185,freq:0,freq_next:0,tune_ack_expecting:0,tune_ack_got:0,sfmt:"w3-text-red w3-ext-retain-input-focus",scan:["scan","w3-bold w3-text-blue"],scan_lsb:["scan","id-ale_2g-lsb w3-bold w3-text-blue"],pb:{lo:600,hi:2650},nets:null,url:"http://kiwisdr.com/ale/ALE_nets.cjson",using_default:!1,double_fault:!1,SHOW_SCAN:0,SHOW_STOP:1,action_s:["SCAN","STOP"],SET:-2,RESUME:-1,STOP:0,START:1,scan_s:["SET","RESUME","STOP","START"],SHOW_FORMAT_EXPAND:0,SHOW_FORMAT_SORT_HI_LO:1,SHOW_FORMAT_COLLAPSE:2,format_m:0,format_s:["expand","exp H>L","collapse","col H>L"],dsp:0,dsp_s:["DX","+cmds","all","+debug"],scan_t_ms:1e3,scan_t_m:1,scan_t_custom_i:5,scan_t_s:["0.75s","1s","2s","3s","5s","custom"],scan_t_f:"",scan_list:null,scan_cur_idx:0,scan_cur_val:0,scanning:!1,scan_timeout:null,have_user_scan_list:!1,user_scan_list:[],isActive:!1,ignore_resume:!1,testing:!1,REC:1,LOG:2,record_m:0,record_s:["off","rec","log","r+l"],recording:!1,record_secs:30,record_timeout:null,log_mins:10,log_interval:null,log_txt:"",f_limit:0,f_sign:1,f_limit_m:0,f_limit_le_custom_i:5,f_limit_ge_custom_i:10,f_limit_s:["none","&le; 6 MHz","&le; 8 MHz","&le; 10 MHz","&le; 12 MHz","&le; custom","&ge; 6 MHz","&ge; 8 MHz","&ge; 10 MHz","&ge; 12 MHz","&ge; custom"],f_limit_v:[0,6,8,10,12,null,6,8,10,12,null],f_limit_f:"",resamp_m:1,resamp_s:["ok fast","better slow"],menu_n:0,menu_s:[],menus:[],menu_sel:"",console_status_msg_p:{scroll_only_at_bottom:!0,process_return_alone:!1,remove_returns:!0,ncol:135}};function ALE_2G_main(){ext_switch_to_client(ale.ext_name,ale.first_time,ale_2g_recv),ale.first_time||ale_2g_controls_setup(),ale.first_time=!1}function ale_2g_recv(e){if("DAT"!=arrayBufferToStringLen(e,3))for(var a=arrayBufferToString(e).substring(4).split(" "),_=0;_<a.length;_++){var l=a[_].split("=");switch(l[0]){case"ready":ale_2g_controls_setup();break;case"bar_pct":if(ale.testing){var s=w3_clamp(parseInt(l[1]),0,100),n=w3_el("id-ale_2g-bar");n&&(n.style.width=s+"%")}break;case"test_start":ale_2g_test_cb("",1);break;case"test_done":ale.testing&&(w3_hide("id-ale_2g-bar-container"),w3_show("id-ale_2g-record"));break;case"chars":ale_2g_decoder_output_chars(l[1]);break;case"tune_ack":ale.tune_ack_got++,ale_2g_tune_ack(l[1]);break;case"active":var t=+l[1];if(ale.scanning&&0!=t)dbgUs&&console.log("#### $active STOP freq="+t.toFixed(2)+" ale.freq="+ale.freq+" scanning="+ale.scanning+" ignore_resume="+ale.ignore_resume),ale.isActive=!0,ale_2g_scanner(ale.STOP),t!=ale.freq_next&&(dbgUs&&console.log("#### $GO BACK #### freq="+t.toFixed(2)+" != ale.freq="+ale.freq+" != ale.freq_next="+ale.freq_next),ale_2g_tune_ack(t,!0));else if(!ale.scanning&&ale.scan_list&&0==t){if(dbgUs&&console.log("#### $active RESUME ignore_resume="+ale.ignore_resume+" freq="+t.toFixed(2)+" scanning="+ale.scanning),ale.recording){dbgUs&&console.log("#### $active RESUME: delayed due to recording"),ale_2g_msg("w3-text-css-lime",ale.menu_s[ale.cur_menu]+", "+ale.cur_header+": scanning paused, waiting for recording");break}ale.isActive=!1,ale.ignore_resume||ale_2g_scanner(ale.RESUME),ale.ignore_resume=!1}else ale.ignore_resume=!0,dbgUs&&console.log("#### $active NOP freq="+t.toFixed(2)+" scanning="+ale.scanning+" scanlist="+ale.scan_list);break;case"call_est_test":if(!dbgUs)break;case"call_est":var i=ale.record_secs;console.log(l[0]+" rec_log="+ale.record_m+" rtime="+i),ale.record_m&ale.REC&&i&&(ale.recording?console.log("call_est: already recording"):(console.log("call_est: rec_log="+ale.record_m+" rtime "+i),ale_2g_decoder_output_chars("--- call established --- recording ---\n"),ale.recording=!0,toggle_or_set_rec(1),ale.record_timeout=setTimeout(function(){ale_2g_recording_stop()},1e3*i)));break;case"event":break;default:console.log("ale_2g_recv: UNKNOWN CMD "+l[0])}}else{var o=new Uint8Array(e,4),c=o[0];console.log("ale_2g_recv: DATA UNKNOWN cmd="+c+" len="+(o.length-1))}}function ale_2g_toggle_recording_cb(){toggle_or_set_rec(),ale.recording&&ale_2g_recording_stop()}function ale_2g_recording_stop(){toggle_or_set_rec(0),kiwi_clearTimeout(ale.record_timeout),ale.recording=!1,ale.isActive&&(dbgUs&&console.log("#### $active RESUME: after recording"),ale_2g_scanner(ale.RESUME),ale.isActive=!1)}function ale_2g_decoder_output_chars(e){ale.console_status_msg_p.s=e,ale.log_txt+=kiwi_remove_ANSI_escape_sequences(kiwi_decodeURIComponent("ALE_2G",e)),kiwi_output_msg("id-ale_2g-console-msgs","id-ale_2g-console-msg",ale.console_status_msg_p)}function ale_2g_controls_setup(){var e=time_display_html("ale_2g")+w3_div("id-ale_2g-data|left:150px; width:1044px; height:"+px(ale.dataH)+"; overflow:hidden; position:relative; background-color:mediumBlue;",w3_div("id-ale_2g-console-msg w3-text-output w3-scroll-down w3-small w3-text-black|left: 10px; width:1024px; position:absolute; overflow-x:hidden;",'<pre><code id="id-ale_2g-console-msgs"></code></pre>')),a=w3_div("id-ale_2g-controls w3-text-white",w3_col_percent("w3-tspace-8 w3-valign/",w3_div("w3-medium w3-text-aqua","<b>ALE 2G decoder</b>"),30,w3_div("",'Based on <b><a href="https://github.com/gat3way/gr-ale" target="_blank">gr-ale</a></b> by Milen Rangelov et al.</b>')),w3_inline("w3-tspace-4 w3-halign-space-between/",w3_div("id-ale_2g-msg")),w3_inline("id-ale_2g-menus w3-tspace-6 w3-halign-space-between/"),w3_inline("w3-tspace-8/w3-margin-between-16",w3_select(ale.sfmt,"","menus","ale.format_m",ale.format_m,ale.format_s,"ale_2g_format_cb"),w3_select(ale.sfmt,"","display","ale.dsp",ale.dsp,ale.dsp_s,"ale_2g_display_cb"),w3_inline("",w3_select("id-ale_2g-scan-t "+ale.sfmt,"","scan T","ale.scan_t_m",ale.scan_t_m,ale.scan_t_s,"ale_2g_scan_t_cb"),w3_input("id-ale_2g-scan-t-custom w3-margin-left w3-ext-retain-input-focus w3-hide|padding:0;width:auto|size=4","","ale.scan_t_f",ale.scan_t_f,"ale_2g_scan_t_custom_cb")),w3_inline("",w3_select("id-ale_2g-f-limit "+ale.sfmt,"","F limit","ale.f_limit_m",ale.f_limit_m,ale.f_limit_s,"ale_2g_f_limit_cb"),w3_input("id-ale_2g-f-limit-custom w3-margin-left w3-ext-retain-input-focus w3-hide|padding:0;width:auto|size=8","","ale.f_limit_f",ale.f_limit_f,"ale_2g_f_limit_custom_cb"))),w3_inline("w3-tspace-4 w3-valign/w3-margin-between-12",w3_button("w3-padding-smaller","Next","w3_select_next_prev_cb",{dir:w3_MENU_NEXT,id:"ale.menu",isNumeric:!0,func:"ale_2g_np_pre_select_cb"}),w3_button("w3-padding-smaller","Prev","w3_select_next_prev_cb",{dir:w3_MENU_PREV,id:"ale.menu",isNumeric:!0,func:"ale_2g_np_pre_select_cb"}),w3_button("id-ale_2g-scan-button w3-padding-smaller w3-green","Scan","ale_2g_scan_button_cb"),w3_button("id-ale_2g-clear-button w3-padding-smaller w3-css-yellow","Clear","ale_2g_clear_button_cb"),w3_button("id-ale_2g-log w3-padding-smaller w3-purple","Log","ale_2g_log_cb"),w3_button("id-ale_2g-test w3-padding-smaller w3-aqua","Test","ale_2g_test_cb",1),w3_div("id-ale_2g-bar-container w3-progress-container w3-round-large w3-white w3-hide|width:70px; height:16px",w3_div("id-ale_2g-bar w3-progressbar w3-round-large w3-light-green|width:0%","&nbsp;")),w3_select("id-ale_2g-record "+ale.sfmt,"","record","ale.record_m",ale.record_m,ale.record_s,"ale_2g_record_cb"),w3_input("id-ale_2g-record-secs/w3-label-not-bold/w3-ext-retain-input-focus|padding:0;width:auto|size=4","rec sec","ale.record_secs",ale.record_secs,"ale_2g_record_secs_cb"),w3_div('fa-stack||title="record"',w3_icon("id-rec2","fa-repeat fa-stack-1x w3-text-pink",22,"","ale_2g_toggle_recording_cb")),w3_input("id-ale_2g-log-mins/w3-label-not-bold/w3-ext-retain-input-focus|padding:0;width:auto|size=4","log min","ale.log_mins",ale.log_mins,"ale_2g_log_mins_cb"),""));ext_panel_show(a,e,null),ext_set_data_height(ale.dataH),ext_set_controls_width_height(ale.ctrlW,ale.ctrlH),time_display_setup("ale_2g"),ale_2g_msg("w3-text-css-yellow","&nbsp;"),ale_2g_set_scan(ale.SHOW_SCAN),ALE_2G_environment_changed({resize:1,freq:1}),ext_send("SET start"),ext_send("SET use_new_resampler="+ale.resamp_m),ale.saved_mode=ext_get_mode(),ext_set_mode("usb"),ext_set_passband(ale.pb.lo,ale.pb.hi),12e3!=ext_nom_sample_rate()&&w3_add("id-ale_2g-test","w3-disabled"),w3_do_when_rendered("id-ale_2g-menus",function(){ext_send("SET reset"),ale.double_fault=!1,dbgUs?kiwi_ajax(ale.url+".xxx","ale_2g_get_nets_done_cb",0,-500):kiwi_ajax(ale.url,"ale_2g_get_nets_done_cb",0,1e4)})}function ale_2g_watchdog(){}function ale_2g_get_nets_done_cb(e){var a=ale.url,_=!1;if(e?e.AJAX_error&&"timeout"==e.AJAX_error?(console.log("ale_2g_get_nets_done_cb: TIMEOUT"),ale.using_default=!0,_=!0):isObject(e)||(console.log("ale_2g_get_nets_done_cb: not array"),_=!0):(console.log("ale_2g_get_nets_done_cb: nets="+e),_=!0),_){if(ale.double_fault)return console.log("ale_2g_get_nets_done_cb: default station list fetch FAILED"),void console.log(e);console.log(e);a=kiwi_url_origin()+"/extensions/ALE_2G/ALE_nets.cjson";return console.log("ale_2g_get_nets_done_cb: using default station list "+a),ale.using_default=!0,ale.double_fault=!0,void kiwi_ajax(a,"ale_2g_get_nets_done_cb",0,1e4)}if(console.log("ale_2g_get_nets_done_cb: from "+a),isDefined(e.AJAX_error))console.log(e);else{if(ale.nets=e,ale_2g_render_menus(),ale.url_params=ext_param(),dbgUs&&console.log("url_params="+ale.url_params),ale.url_params){var l=ale.url_params.split(","),s=l[0].parseFloatWithUnits("kM",.001),n=kiwi_decodeURIComponent("ale",l[0]).toLowerCase();dbgUs&&console.log("URL freq="+s);var t,i,o=!1,c=!1,r=!1,g=0;if(isNumber(s)&&l.length>=2){var d=!1;l.forEach(function(e,a){var _=e.parseFloatWithUnits("kM",.001);isNumber(_)||(d=!0),d||ale.user_scan_list.push(_)})}if(ale.user_scan_list.length>=2){ale.have_user_scan_list=!0;var m=!1;l.forEach(function(e,a){w3_ext_param("lsb",e).match&&(m=!0)}),m&&ale.user_scan_list.unshift("lsb"),ale.user_scan_list.unshift(0),dbgUs&&console.log("user_scan_list=..."),dbgUs&&console.log(ale.user_scan_list),ale_2g_render_menus();for(var u=0;u<ale.user_scan_list.length-1;u++)l.shift()}if(l.forEach(function(e,a){var _;if((_=w3_ext_param("format",e)).match&&isNumber(_.num)){var l=w3_clamp(_.num,0,ale.format_s.length-1,0);console.log("menus "+_.num+" "+l),ale_2g_format_cb("id-ale.format_m",l)}}),!ale.have_user_scan_list)for(u=0;u<ale.menu_n;u++){var b="ale.menu"+u,f=!1,w=!1;if(dbgUs&&console.log("CONSIDER "+b+" -----------------------------------------"),w3_select_enum(b,function(e,a){var _=+e.value;if(!c&&-1!=_){var l=parseFloat(e.innerHTML),o=e.innerHTML.toLowerCase();if(dbgUs&&console.log("CONSIDER "+_+" "+e.innerHTML),f){if(e.disabled)return;w=!0,isNumber(l)&&(r=!0)}else if(isNumber(l))l==s&&(dbgUs&&console.log("MATCH num: "+o+"["+a+"]"),w=!0,r=!0);else if(o.includes(n))return f=!0,void(dbgUs&&console.log("MATCH str: "+o+"["+a+"] BEGIN look_for_first_entry"));w&&(dbgUs&&console.log("MATCH "+_+" "+e.innerHTML),t=b,i=_,c=!0)}}),c){l.shift();break}}l.forEach(function(e,a){var _;if(dbgUs&&console.log("ALE param2 <"+e+">"),w3_ext_param("help",e).match)extint_help_click();else if((_=w3_ext_param("display",e)).match){if(isNumber(_.num)){var l=w3_clamp(_.num,0,ale.dsp_s.length-1,0);console.log("display "+_.num+" "+l),ale_2g_display_cb("id-ale.dsp",l)}}else if((_=w3_ext_param("scan",e)).match)o=!0,isNumber(_.num)&&(ale_2g_scan_t_custom_cb("id-ale_2g-scan-t-custom",_.num),ale_2g_scan_t_cb("id-ale_2g-scan-t",ale.scan_t_custom_i));else if((_=w3_ext_param("limit_le",e)).match)_.has_value&&(ale_2g_f_limit_custom_cb("id-ale_2g-f-limit-custom",_.string_case),ale_2g_f_limit_cb("id-ale_2g-f-limit",ale.f_limit_le_custom_i));else if((_=w3_ext_param("limit_ge",e)).match)_.has_value&&(ale_2g_f_limit_custom_cb("id-ale_2g-f-limit-custom",_.string_case),ale_2g_f_limit_cb("id-ale_2g-f-limit",ale.f_limit_ge_custom_i));else if((_=w3_ext_param("rec",e)).match){var s=_.has_value?_.num:1;if(isNumber(s)){l=w3_clamp(s,0,ale.record_s.length-1,0);console.log("record "+s+" "+l),ale_2g_record_cb("id-ale.record_m",l)}}else(_=w3_ext_param("rec_time",e)).match?isNumber(_.num)&&ale_2g_record_secs_cb("id-ale.record_secs",_.num):(_=w3_ext_param("log_time",e)).match?isNumber(_.num)&&ale_2g_log_mins_cb("id-ale.log_mins",_.num):w3_ext_param("test",e).match?g=1:console.log('ALE 2G: unknown URL param "'+e+'"')}),c&&ale_2g_pre_select_cb(t,i,!1),o&&c&&(console.log("found_scan_param && found_menu_match"),f&&ale_2g_scanner(ale.SET,void 0,1),r||ale_2g_scanner(ale.RESUME))}ale.have_user_scan_list&&(console.log("have_user_scan_list"),ale_2g_pre_select_cb("ale.menu"+(ale.menu_n-1),1,!1),ale_2g_scanner(ale.SET,void 0,1),ale_2g_scanner(ale.RESUME)),g&&ale_2g_test_cb("",1),dbgUs&&console.log(ale.nets)}}function ale_2g_render_menus(){var e,a=function(e,a,_,l){var s=kiwi_deep_copy(_);ale.menu_n++,ale["menu"+a]=-1,ale.menus[a]=s,ale.menu_s[a]=l,w3_obj_enum(s,function(e,a,_){ale.format_m&ale.SHOW_FORMAT_SORT_HI_LO&&_.sort(function(e,a){return 0==e?-1e20:0==a?1e20:a-e}),isArray(_)&&0==_[0]&&_.length>=2&&(_[0]=isString(_[1])&&_[1].includes("lsb")?ale.scan_lsb:ale.scan),isArray(_)&&_.length>=2&&isString(_[1])&&_.splice(1,1)});var n=ale.format_m&ale.SHOW_FORMAT_COLLAPSE?1:0,t=w3_select_hier_collapse(ale.sfmt,l,"select","ale.menu"+a,-1,n,s,"ale_2g_pre_select_cb"),i=w3_create_appendElement(e,"div",t);w3_add(i,"id-"+l)},_=w3_el("id-ale_2g-menus");_.innerHTML="",ale.menu_n=0,w3_obj_enum(ale.nets,function(e,l,s){a(_,l,s,e)});var l={},s=!1;if(ale.have_user_scan_list&&(l["URL list"]=ale.user_scan_list,s=!0),isDefined(cfg.ale_2g)&&isDefined(cfg.ale_2g.admin_menu)){var n;e=kiwi_remove_cjson_comments(decodeURIComponent(cfg.ale_2g.admin_menu));try{n=JSON.parse(e),w3_obj_enum(n,function(e,a,_){l[e]=_,s=!0})}catch(e){console.log("JSON parse error"),console.log(e),console.log(cfg.ale_2g.admin_menu),n={}}}s&&(dbgUs&&console.log(l),a(_,ale.menu_n,l,"Local"))}function ale_2g_format_cb(e,a,_){_||(ale.format_m=+a,w3_set_value(e,+a),ale_2g_render_menus())}function ale_2g_msg(e,a){var _=w3_el("id-ale_2g-msg");w3_remove_then_add(_,ale.msg_last_color,e),ale.msg_last_color=e,_.innerHTML="<b>"+a+"</b>"}function ale_2g_clear_menus(e){for(var a=0;a<ale.menu_n;a++)isArg(e)&&a==e||w3_select_value("ale.menu"+a,-1)}function ale_2g_np_pre_select_cb(e,a,_){ale.scanning&&ale.scan_list?dbgUs&&console.log("ale_2g_pre_select_cb path="+e+" $$$$ BUSY $$$$"):ale_2g_pre_select_cb(e,a,_)}function ale_2g_pre_select_cb(e,a,_){if(!_)if(a=+a,dbgUs&&console.log("ale_2g_pre_select_cb path="+e+" scanning="+ale.scanning+" isActive="+ale.isActive+" scan_list="+ale.scan_list),0!=a){var l=parseInt(e.split("ale.menu")[1]);dbgUs&&console.log("ale_2g_pre_select_cb path="+e+" val="+a+" menu_n="+l);var s,n=!1,t=0,i=!1;w3_select_enum(e,function(_){if(!i&&(dbgUs&&console.log("ale_2g_pre_select_cb opt.val="+_.value+" opt.disabled="+_.disabled+" opt.inner="+_.innerHTML),_.disabled&&-1!=_.value?(s=t?s+" "+_.innerHTML:_.innerHTML,t=1,n=!1):t=0,w3_contains(_,"id-ale_2g-lsb")&&(n=!0),_.value==a)){i=!0,ale.cur_menu=l,ale.cur_header=s,ale.lsb=n,ale.menu_sel=_.innerHTML+" ",dbgUs&&console.log("ale_2g_pre_select_cb opt.val="+_.value+" menu_sel="+ale.menu_sel+" opt.id="+_.id);var o=_.id.split("id-")[1];if(isUndefined(o))return console.log("ale_2g_pre_select_cb: option.id isUndefined"),console.log("ale_2g_pre_select_cb opt.val="+_.value+" opt.disabled="+_.disabled+" opt.inner="+_.innerHTML),void console.log(_);var c=(o=o.split("-"))[0],r=o[1];dbgUs&&console.log("ale_2g_pre_select_cb i="+c+" j="+r);var g=w3_obj_seq_el(ale.menus[l],c);dbgUs&&w3_console.log(g,"o1"),o2=w3_obj_seq_el(g,r),dbgUs&&w3_console.log(o2,"o2");var d,m=0;isNumber(o2)?(dbgUs&&console.log(o2),ale_2g_tune(o2),d=(+o2).toFixedNZ(1)+" kHz",ale_2g_scanner(ale.SET,g,r),m=1):isArray(o2)?(dbgUs&&console.log(o2[0]),d=o2[0],dbgUs&&console.log(g),ale_2g_scanner(ale.START,g)):isString(o2)&&(console.log("$str freq"),console.log(o2),ale_2g_scanner(ale.STOP,null)),m&&ale_2g_msg("w3-text-css-yellow",ale.menu_s[l]+", "+ale.cur_header+": "+d),w3_select_value(e,a)}}),ale_2g_clear_menus(l)}else dbgUs&&console.log("ale_2g_pre_select_cb path="+e+" $$$$ val=0 $$$$ cur_idx="+ale.scan_cur_idx)}function ale_2g_tune(e){ale.freq_next=e,ale.tune_ack_expecting++,dbgUs&&console.log("ale_2g_tune tx f="+e.toFixed(2)),ext_send("SET tune="+e.toFixed(2))}function ale_2g_tune_ack(e,a){dbgUs&&console.log("ale_2g_tune_ack rx f="+e+" isActive="+ale.isActive+" go_back_override="+a),ale.isActive&&1!=a||(ale.freq=e,ext_tune(e,ale.lsb?"lsb":"usb",ext_zoom.CUR))}function ale_2g_set_scan(e){var a=function(e,a){var _=w3_el("id-ale_2g-scan-button");w3_button_text(_,e),w3_remove_then_add(_,ale.scan_last_color,a),ale.scan_last_color=a};switch(ale.action=e,ale.action){case ale.SHOW_STOP:a("Stop","w3-red");break;case ale.SHOW_SCAN:a("Scan","w3-green")}}function ale_2g_scan_button_cb(e,a,_){if(!_)switch(ale.action){case ale.SHOW_SCAN:ale_2g_scanner(ale.RESUME);break;case ale.SHOW_STOP:ale_2g_scanner(ale.STOP)}}function ale_2g_scan(e){dbgUs&&console.log("ale_2g_scan scan="+(e?"T":"F")),ale.scanning=e,ext_set_scanning(e?1:0)}function ale_2g_scanner(e,a,_){var l,s,n;if(dbgUs&&console.log("ale_2g_scanner idx="+(e<=1?ale.scan_s[e+2]:e)+" scan_cur_idx="+ale.scan_cur_idx+" new_idx(PARAM)="+_+" scan_list(PARAM)="+kiwi_typeof(a)+" ale.scan_list="+kiwi_typeof(ale.scan_list)),isDefined(a)&&(ale.scan_list=a),isDefined(_)&&(ale.scan_cur_idx=+_),e==ale.SET)return dbgUs&&console.log("SET scan_list="+ale.scan_list+" cur_idx="+ale.scan_cur_idx),kiwi_clearTimeout(ale.scan_timeout),ale_2g_set_scan(ale.SHOW_SCAN),void ale_2g_scan(0);if(e==ale.RESUME){if(dbgUs&&console.log("RESUME scan_list="+ale.scan_list+" cur_idx="+ale.scan_cur_idx),!ale.scan_list)return dbgUs&&console.log("RESUME but no scan_list"),ale.scan_cur_idx=0,kiwi_clearTimeout(ale.scan_timeout),ale_2g_set_scan(ale.SHOW_SCAN),void ale_2g_scan(0);e=ale.scan_cur_idx,ale_2g_set_scan(ale.SHOW_STOP),ale_2g_scan(1)}if(e==ale.STOP)return kiwi_clearTimeout(ale.scan_timeout),s=ale.scanning&&ale.scan_list,ale_2g_set_scan(ale.SHOW_SCAN),ale_2g_scan(0),l=ale.isActive?", signal detected":"",void(s&&ale_2g_msg("w3-text-css-lime",s?ale.menu_s[ale.cur_menu]+", "+ale.cur_header+": scanning paused"+l:"&nbsp;"));if(e==ale.START&&(ale.scan_list&&ale_2g_scan(1),ale_2g_set_scan(ale.scan_list?ale.SHOW_STOP:ale.SHOW_SCAN)),!(s=ale.scanning&&ale.scan_list))return ale.scan_cur_idx=e,void(dbgUs&&console.log("ale_2g_scanner: IMMEDIATE CHANGE scan_cur_idx="+e));var t=ale.f_limit<0,i=Math.abs(ale.f_limit),o=ale.scan_list.length,c=0;do{if(e,n=+ale.scan_list[e],++e>=o&&(e=1),c++>o)return ale_2g_msg("w3-text-orange","settings give empty scanlist"),kiwi_clearTimeout(ale.scan_timeout),void(ale.scan_timeout=setTimeout(function(){ale_2g_scanner(e)},ale.scan_t_ms))}while(i&&(t&&n>i||!t&&n<i));ale_2g_msg("w3-text-css-lime",ale.menu_s[ale.cur_menu]+", "+ale.cur_header+": scanning "+n.toFixedNZ(1)+" kHz"),ale_2g_tune(n),kiwi_clearTimeout(ale.scan_timeout),ale.scan_timeout=setTimeout(function(){ale.scan_cur_idx=e,ale_2g_scanner(e)},ale.scan_t_ms)}function ale_2g_clear_button_cb(e,a,_){_||(ale.console_status_msg_p.s=encodeURIComponent("\f"),kiwi_output_msg("id-ale_2g-console-msgs","id-ale_2g-console-msg",ale.console_status_msg_p),ale.log_txt="",ale_2g_test_cb("",0))}function ale_2g_scan_t_cb(e,a,_){if(!_){var l=ale.scan_t_s[+a];w3_set_value(e,a);var s="custom"==l;dbgUs&&console.log("ale_2g_scan_t_cb idx="+a+" scan_t_s="+l+" isCustom="+s);var n=w3_el("id-ale_2g-scan-t-custom");w3_show_hide(n,s),s?ale_2g_scan_t_custom_cb(n,w3_get_value(n)):ale.scan_t_ms=1e3*parseFloat(l)}}function ale_2g_scan_t_custom_cb(e,a){var _=w3_clamp(parseFloat(a),.75,60,1);console.log("ale_2g_scan_t_custom_cb path="+e+" val="+a+" scan_t="+_),w3_set_value(e,_),ale.scan_t_ms=1e3*_,w3_show_block(e)}function ale_2g_f_limit_cb(e,a,_){if(!_){var l=ale.f_limit_s[+a];ale.f_sign=l.includes("&le;")?-1:1;var s=l.includes("custom");console.log("ale_2g_f_limit_cb idx="+a+" f_limit_s="+l+" isCustom="+s),w3_set_value(e,+a);var n=w3_el("id-ale_2g-f-limit-custom");w3_show_hide(n,s),s?ale_2g_f_limit_custom_cb(n,w3_get_value(n)):ale.f_limit=1e3*ale.f_limit_v[+a]*ale.f_sign,console.log("MENU f_limit="+ale.f_limit)}}function ale_2g_f_limit_custom_cb(e,a){var _=a.toString().parseFloatWithUnits("kM",.001);_=w3_clamp(_,1,32e3,1),console.log("ale_2g_f_limit_custom_cb path="+e+" val="+a+" f_limit_kHz="+_),w3_set_value(e,_),ale.f_limit=_*ale.f_sign,w3_show_block(e),console.log("CUSTOM f_limit="+ale.f_limit)}function ale_2g_display_cb(e,a,_){a=+a,ext_send("SET display="+a),w3_set_value(e,a)}function ale_2g_resamp_cb(e,a,_){a=+a,ext_send("SET use_new_resampler="+a)}function ale_2g_test_cb(e,a,_){if(!_){a=+a,dbgUs&&console.log("ale_2g_test_cb: val="+a),ale.testing=a,w3_el("id-ale_2g-bar").style.width="0%",w3_show_hide("id-ale_2g-bar-container",ale.testing),w3_show_hide("id-ale_2g-record",!ale.testing),a&&!ale.scanning&&ale.isActive&&ale.scan_list&&(ale.isActive=!1,dbgUs&&console.log("#### $active FORCED RESUME ignore_resume="+ale.ignore_resume),ale.ignore_resume||(ale_2g_scanner(ale.RESUME),ext_send("SET reset")),ale.ignore_resume=!1);var l=-(+ext_get_freq_kHz()).toFixed(2);dbgUs&&console.log("ale_2g_test_cb="+(a?l:0)),ext_send("SET test="+(a?l:0))}}function ale_2g_record_cb(e,a,_){_||(a=+a,console.log("ale_2g_record_cb idx="+a),ale.record_m=a,w3_set_value(e,a),ale_2g_log_mins_cb("",ale.log_mins))}function ale_2g_record_secs_cb(e,a){ale.record_secs=w3_clamp(+a,1,86400,1),console.log("ale_2g_record_secs_cb path="+e+" val="+a+" record_secs="+ale.record_secs),w3_set_value(e,ale.record_secs)}function ale_2g_log_mins_cb(e,a){ale.log_mins=w3_clamp(+a,1,1440,1),console.log("ale_2g_log_mins_cb path="+e+" val="+a+" log_mins="+ale.log_mins),w3_set_value(e,ale.log_mins),kiwi_clearInterval(ale.log_interval),ale.record_m&ale.LOG&&(ale.log_interval=setInterval(function(){ale_2g_log_cb()},6e4*ale.log_mins))}function ale_2g_log_cb(){var e=kiwi_host()+"_"+(new Date).toISOString().replace(/:/g,"_").replace(/\.[0-9]+Z$/,"Z")+"_"+w3_el("id-freq-input").value+"_"+cur_mode,a=new Blob([ale.log_txt],{type:"text/plain"}),_=document.createElement("a");_.style="display: none",_.href=window.URL.createObjectURL(a),_.download="ALE_2G."+e+".log.txt",document.body.appendChild(_),console.log("ale_2g_log: "+_.download),_.click(),window.URL.revokeObjectURL(_.href),document.body.removeChild(_)}function ALE_2G_environment_changed(e){if(e.freq||e.mode){var a=ext_get_freq_kHz(),_=ext_get_mode();(ale.freq!=a||"lsb"!=_&&"usb"!=_)&&ale_2g_clear_menus()}if(e.resize){var l=w3_el("id-ale_2g-data"),s=(window.innerWidth-1024-time_display_width())/2;l.style.left=px(s)}}function ALE_2G_blur(){ale_2g_scanner(ale.STOP,null),ext_send("SET stop"),console.log("ALE_2G_blur saved_mode="+ale.saved_mode),ext_set_mode(ale.saved_mode)}function ALE_2G_help(e){if(e){var a=w3_text("w3-medium w3-bold w3-text-aqua","ALE 2G decoder help")+w3_div("w3-margin-T-8 w3-scroll-y|height:90%",w3_div("w3-margin-R-8",'The menu content is fetched from <a href="http://kiwisdr.com/ale/ALE_nets.cjson" target="_blank">kiwisdr.com</a> each time the extension is opened.<br><br>Because the menus can be long (many frequency entries) the <i>format</i> setting can be used to collapse them to show just their net names followed by the <i>scan</i> entry (or single frequency). Menus can also be sorted by high-to-low frequency since this is optimal for some types of ALE monitoring.<br><br>The <i>display</i> setting controls the ALE message detail shown. The <i>DX</i> setting limits the information displayed per ALE transaction. The <i>scan time</i> setting has preset entries and supports custom scan rates from  0.75 to 60 secs.<br><br>The frequencies of a scan list can be limited by the <i>frequency limit</i> setting. This is useful when the scan list covers a wide range of HF frequencies but propagation makes scanning some of them pointless (e.g. > 12 MHz at night).<br><br><i>record</i> settings: Automatic audio recording can be setup when an ALE call between two stations is established. Also periodic downloading of the ALE message log to a file. Adjust your browser settings so these files are downloaded and saved automatically without causing a browser popup window for each download.<br><br>The Kiwi owner/admin can define the contents of the <i>Local</i> menu on the <br><i>Admin > Extensions > ALE_2G</i> page. JSON format is used. Users cannot currently define their own menus (except via URL parameters, see below) but suggestions for the downloaded menus on extension startup can be made on the Kiwi forum.<br><br>URL parameters: <br><i>(menu match or frequency list)</i> &nbsp; lsb &nbsp; format:[0123] &nbsp; display:[0123] &nbsp; scan[:<i>secs</i>] &nbsp; <br>limit_le:<i>freq</i> &nbsp; limit_ge:<i>freq</i> &nbsp; rec:[0123] &nbsp; rec_time:<i>secs</i> &nbsp; log_time:<i>mins</i> &nbsp; test<br><br>The first URL parameter can be a frequency entry from one of the menus (e.g. "3596") or the name of a menu scan list (e.g. "MARS" in the Amateur menu). Or it can be a list of frequencies separated by commas. Such a list will appear as the first entry in the <i>Local</i> menu for subsequent selection. The parameter <i>lsb</i> will make this list use lsb mode.<br><br>Frequencies can use the suffixes \'k\' and \'M\'. [0123] refers to the order of selections in the corresponding menu.<br><br>Keywords are case-insensitive and can be abbreviated. So for example these are valid: <br><i>ext=ale,3596</i> &nbsp;&nbsp; <i>ext=ale,mars,scan</i> &nbsp;&nbsp; <i>ext=ale,cothen,s:0.75</i> &nbsp;&nbsp; <i>ext=ale,4M,5M,6M,lsb</i> <br><i>ext=ale,7102,14.1M,18106,s</i> &nbsp;&nbsp; <i>ext=ale,ham,s,disp:1,limit_le:10M,rec,rec_t:10</i><br><i>ext=ale,mars,scan,rec:3,rec_t:60,log_t:10</i> &nbsp; (i.e. <i>rec:3</i> is the "r+l" record menu entry)<br>'));confirmation_show_content(a,610,375),w3_el("id-confirmation-container").style.height="100%"}return!0}function ale_2g_admin_menu_cb(e,a){var _,l,s,n=w3_el("id-ale_2g-admin-textarea");w3_set_value(e,a);try{_=kiwi_remove_cjson_comments(a),JSON.parse(_),l=!1}catch(e){console.log("JSON parse error"),s=e.message,console.log(e.message),console.log(_),l=!0}w3_remove_then_add(n,"w3-css-pink",l?"w3-css-pink":""),w3_innerHTML("id-ale_2g-admin-textarea-status",l?s:""),l||w3_json_set_cfg_cb(e,a)}function ALE_2G_config_html(){var e=w3_div("",w3_textarea_get_param("id-ale_2g-admin-textarea w3-input-any-change|width:100%",w3_inline("",w3_text("w3-bold w3-text-teal","Admin menu"),w3_text("w3-text-black w3-margin-left","Data in JSON format. Press enter (return) key while positioned at end of text to change menu data.")),"cfg.ale_2g.admin_menu",16,100,"ale_2g_admin_menu_cb",'{\n// Data in JSON format.\n// Double-slash comments MUST start in column one!\n// Underscores in net/station names are converted to line breaks in menu entries\n// A zero as the first element of the frequency array converts to a "scan" menu entry\n\n    "Admin-1": [1111],\n    "Admin-2": [0, 2222, 3333, 4444],\n    "Admin-3_Test": [0, 5555.5, 6666.6]\n}\n'),w3_inline("w3-valign w3-margin-top/",w3_text("w3-text-teal","Status:"),w3_div("id-ale_2g-admin-textarea-status w3-margin-left w3-text-black w3-background-pale-aqua","")),w3_text("w3-margin-top w3-text-black","Note: Line numbers in JSON.parse error messages do not include comment lines. Adjust accordingly."));ext_config_html(ale,"ale_2g","ALE_2G","ALE_2G configuration",e)}


