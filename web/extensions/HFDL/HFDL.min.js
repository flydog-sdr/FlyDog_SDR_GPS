

/* web/extensions/HFDL/HFDL.min.js (web/extensions/HFDL/HFDL.js = Mon Jun  6 12:13:01 2022) */
var hfdl={ext_name:"HFDL",first_time:!0,test_flight:!1,dataH:445,dataW:1024,ctrlW:600,ctrlH:185,freq:0,sfmt:"w3-text-red w3-ext-retain-input-focus",pb:{lo:300,hi:2600},stations:null,url:kiwi_SSL()+"files.kiwisdr.com/hfdl/systable.cjson",using_default:!1,double_fault:!1,bf_cf:[3500,4670,5600,6625,8900,10065,11290,13310,15020,17945,21965],bf_z:[4,9,6,7,7,8,7,8,8,8,8],bf:[],bf_gs:{},bf_color:["pink","lightCoral","lightSalmon","khaki","gold","yellowGreen","lime","cyan","deepSkyBlue","lavender","violet"],SHOW_MSGS:0,SHOW_MAP:1,SHOW_SPLIT:2,show:0,show_s:["messages","map","split"],ALL:0,DX:1,ACARS:2,SQUITTER:3,dsp:0,dsp_s:["all","DX","ACARS","squitter"],uplink:!0,downlink:!0,testing:!1,log_mins:0,log_interval:null,log_txt:"",menu_n:0,menu_s:[],menus:[],menu_sel:"",flights:{},too_old_min:10,flights_visible:!0,gs_visible:!0,console_status_msg_p:{scroll_only_at_bottom:!0,process_return_alone:!1,remove_returns:!0,ncol:135}};function HFDL_main(){ext_switch_to_client(hfdl.ext_name,hfdl.first_time,hfdl_recv),hfdl.first_time||hfdl_controls_setup(),hfdl.first_time=!1}function hfdl_recv(e){if("DAT"!=arrayBufferToStringLen(e,3))for(var l=arrayBufferToString(e).substring(4).split(" "),t=0;t<l.length;t++){var d=l[t].split("=");switch(0,d[0]){case"ready":var i="pkgs_maps/";kiwi_load_js(["pkgs/js/sprintf/sprintf.js",i+"pkgs_maps.js",i+"pkgs_maps.css"],"hfdl_controls_setup");break;case"lowres_latlon":var n=kiwi_decodeURIComponent("",d[1]);dbgUs&&console.log("lowres_latlon="+n),n=JSON.parse(n),kiwi_map_add_marker_icon(hfdl.kmap,kmap.ADD_TO_MAP,"kiwi/gfx/kiwi-with-headphones.51x67.png",n,[25,33],1,function(e){w3_add(e,"id-hfdl-kiwi-icon w3-hide"),e.style.zIndex=99999});break;case"bar_pct":hfdl.testing&&(i=w3_clamp(parseInt(d[1]),0,100),(n=w3_el("id-hfdl-bar"))&&(n.style.width=i+"%"));break;case"test_start":hfdl_test_cb("",1);break;case"test_done":hfdl.testing&&(w3_hide("id-hfdl-bar-container"),w3_show("id-hfdl-record"));break;case"chars":var _=d[1],s=kiwi_decodeURIComponent("",d[1]).split("\n"),o=s[1].startsWith("Uplink"),a=s[1].startsWith("Downlink");if(!hfdl.uplink&&o)break;if(!hfdl.downlink&&a)break;var h=null,f=null,r=null;switch(s.forEach(function(e,l){s[l]=e.trim(),o||(l=(e=s[l].split(":"))[0],e=e[1]&&""!=e[1]?e[1].slice(1):null,"Flight ID"==l&&e?h=e:"Lat"==l&&e?f=+e:"Lon"==l&&e&&(r=+e))}),h&&f&&r&&(180!=f||180!=r)&&hfdl_flight_update(h,f,r),s[3].startsWith("Squitter")&&(s.forEach(function(e,l){e.startsWith("ID:")?v=e.split(": ")[1]:e.startsWith("Frequencies in use:")&&(e=e.split(": ")[1],hfdl.dsp==hfdl.SQUITTER&&(_+=v+": "+e+"\n"),e=e.split(", "),hfdl_update_AFT(v.split(", ")[1],e))}),hfdl.test_flight&&(hfdl_flight_update("XYZ123",0,0),hfdl_flight_update("ABC987",60,-20),hfdl.test_flight=!1)),hfdl.dsp){case hfdl.ALL:break;case hfdl.DX:if(_=s[0]+"\n"+s[1].slice(0,-1)+" | "+s[2],s[3].startsWith("Squitter")){_+=" | Squitter: ";var c=!0;s.forEach(function(e,l){l<=3||!e.startsWith("ID:")||((e=e.split(", ")).length<2||""==e[1]||(_+=(c?"":", ")+e[1],c=!1))}),_+="\n";break}_+=" | "+s[3];var u,m=!1,g=!1,p="",w="";["Logon request","Logon resume","Logon confirm","Unnumbered data","Unnumbered ack'ed"].forEach(function(e,l){!m&&s[4].includes(e)&&(m=!0,u=e,s.forEach(function(e,l){var t;l<=4||(l=(t=e.split(":"))[0],e=t[1]&&""!=t[1]?t[1].slice(1):null,t=t[2]&&""!=t[2]?t[2].slice(1):null,"Flight ID"==l&&e?p+=" | Flight "+e:"Lat"==l&&e?p+=" | Lat "+(+e).toFixed(4):"Lon"==l&&e?p+=" | Lon "+(+e).toFixed(4):"ACARS"==l?g="ACARS data":"Message"==l?g="ACARS message":o&&"Src GS"==l?w=" | "+e:a&&e&&e.endsWith("Flight")&&(w=" | Flight "+t))}))}),_+=m?" | "+(g?g+w+p:u+p):" | "+s[4],_+="\n";break;case hfdl.ACARS:var _="",w="",b=!1,g="";s.forEach(function(e,l){var t=e.split(":"),d=t[0],i=t[1]&&""!=t[1]?t[1].slice(1):null,t=t[2]&&""!=t[2]?t[2].slice(1):null;if(o&&"Src GS"==d)w=i;else if(a&&i&&i.endsWith("Flight"))w="Flight "+t;else{if("Message"==d)return _=s[0]+"\nACARS message from "+w+"\n",void(b=!0);d.startsWith("Media Advisory")&&(b=!1)}b&&""!=e&&(g+=" "+e+"\n")}),""!=g&&(_+=g);break;case hfdl.SQUITTER:if(!s[3].startsWith("Squitter")){_="";break}_=s[0]+"\nSquitter | "+s[2]+"\n";var v="";s.forEach(function(e,l){e.startsWith("ID:")?v=e.split(": ")[1]:e.startsWith("Frequencies in use:")&&(e=e.split(": ")[1],_+=v+": "+e+"\n")})}""!=_&&hfdl_decoder_output_chars(_);break;default:console.log("hfdl_recv: UNKNOWN CMD "+d[0])}}else{var k=new Uint8Array(e,4),e=k[0];console.log("hfdl_recv: DATA UNKNOWN cmd="+e+" len="+(k.length-1))}}function hfdl_decoder_output_chars(e){hfdl.console_status_msg_p.s=e,hfdl.log_txt+=kiwi_remove_escape_sequences(kiwi_decodeURIComponent("HFDL",e)),kiwi_output_msg("id-hfdl-console-msgs","id-hfdl-console-msg",hfdl.console_status_msg_p)}function hfdl_controls_setup(){for(i=0;i<hfdl.bf_cf.length;i++)hfdl.bf[i]=Math.floor(hfdl.bf_cf[i]/1e3);var e=sprintf("width:%dpx; height:%dpx;",hfdl.dataW,hfdl.dataH),l="w3-label-inline w3-label-not-bold",e=time_display_html("hfdl")+w3_div("id-hfdl-data w3-display-container|left:0px; "+e,w3_div("id-hfdl-msgs w3-hide|"+e+"; z-index:1; overflow:hidden; position:absolute;",w3_div(sprintf("id-hfdl-console-msg w3-text-output w3-scroll-down w3-small w3-text-black|width:%dpx; position:absolute; overflow-x:hidden;",1024),'<pre><code id="id-hfdl-console-msgs"></code></pre>')),w3_div("|"+e+' position:absolute; z-index:0|id="id-hfdl-map"'))+w3_div("id-hfdl-options w3-display-right w3-text-white|top:230px; right:0px; width:250px; height:200px",w3_text("w3-text-aqua w3-bold","HFDL options"),w3_select("w3-margin-T-4 w3-width-auto "+hfdl.sfmt,"","show","hfdl.show",hfdl.show,hfdl.show_s,"hfdl_show_cb"),w3_button("id-hfdl-show-kiwi w3-margin-T-10 class-button w3-cyan w3-momentary","Show Kiwi","hfdl_show_kiwi_cb",1),w3_checkbox("w3-margin-T-10//"+l,"Show day/night","hfdl.day_night_visible",!0,"hfdl_day_night_visible_cb"),w3_checkbox(l,"Show graticule","hfdl.graticule_visible",!0,"hfdl_graticule_visible_cb"),w3_inline("w3-margin-T-10 w3-valign/",w3_checkbox("//"+l,"Show flights","hfdl.flights_visible",!0,"hfdl_flights_visible_cb"),w3_button("id-hfdl-clear-old w3-margin-left class-button w3-small w3-grey w3-momentary","Clear old","hfdl_clear_old_cb",1)),w3_checkbox(l,"Show ground stations","hfdl.gs_visible",!0,"hfdl_gs_visible_cb")),l=w3_div("id-hfdl-controls w3-text-white",w3_col_percent("w3-tspace-8 w3-valign/",w3_div("w3-medium w3-text-aqua","<b>HFDL decoder</b>"),25,w3_div("",'From <b><a href="https://github.com/szpajder/dumphfdl" target="_blank">dumphfdl</a></b> by Tomasz Lemiech &copy;2021 GPL-3.0</b>')),w3_inline("w3-tspace-4 w3-halign-space-between/",w3_div("id-hfdl-msg")),w3_inline("w3-margin-T-16/w3-margin-between-16",w3_inline("w3-valign-end w3-round-large w3-padding-small w3-text-white w3-grey/",w3_select(hfdl.sfmt,"Display","","hfdl.dsp",hfdl.dsp,hfdl.dsp_s,"hfdl_display_cb"),w3_div("w3-margin-L-16",w3_checkbox("/w3-label-inline w3-label-not-bold","Uplink","hfdl.uplink",hfdl.uplink,"w3_bool_cb"),w3_checkbox("/w3-label-inline w3-label-not-bold","Downlink","hfdl.downlink",hfdl.downlink,"w3_bool_cb"))),w3_inline("id-hfdl-menus w3-tspace-6 w3-gap-16/")),w3_inline("w3-tspace-8 w3-valign/w3-margin-between-12",w3_button("w3-padding-smaller","Next","w3_select_next_prev_cb",{dir:w3_MENU_NEXT,id:"hfdl.menu",isNumeric:!0,func:"hfdl_np_pre_select_cb"}),w3_button("w3-padding-smaller","Prev","w3_select_next_prev_cb",{dir:w3_MENU_PREV,id:"hfdl.menu",isNumeric:!0,func:"hfdl_np_pre_select_cb"}),w3_button("id-hfdl-clear-button w3-padding-smaller w3-css-yellow","Clear","hfdl_clear_button_cb"),w3_button("id-hfdl-log w3-padding-smaller w3-purple","Log","hfdl_log_cb"),w3_button("id-id-hfdl-test w3-padding-smaller w3-aqua","Test","hfdl_test_cb",1),w3_div("id-hfdl-bar-container w3-progress-container w3-round-large w3-white w3-hide|width:70px; height:16px",w3_div("id-hfdl-bar w3-progressbar w3-round-large w3-light-green|width:0%","&nbsp;")),w3_input("id-hfdl-log-mins/w3-label-not-bold/w3-ext-retain-input-focus|padding:0;width:auto|size=4","log min","hfdl.log_mins",hfdl.log_mins,"hfdl_log_mins_cb")));ext_panel_show(l,e,null),ext_set_data_height(hfdl.dataH),ext_set_controls_width_height(hfdl.ctrlW,hfdl.ctrlH),time_display_setup("hfdl"),w3_el("hfdl-time-display").style.top=px(10),hfdl_msg("w3-text-css-yellow","&nbsp;"),HFDL_environment_changed({resize:1,freq:1}),hfdl.save_agc_delay=ext_agc_delay(100),ext_send("SET start"),hfdl.saved_mode=ext_get_mode(),ext_set_mode("iq"),ext_set_passband(hfdl.pb.lo,hfdl.pb.hi),12e3!=ext_nom_sample_rate()&&w3_add("id-hfdl-test","w3-disabled"),hfdl.kmap=kiwi_map_init("hfdl",[28,15],2,17),hfdl.locations_age_interval=setInterval(function(){var d=Date.now()-60*hfdl.too_old_min*1e3;w3_obj_enum(hfdl.flights,function(e,l,t){t.upd<d&&(console.log("FL-OLD "+t.loc_name+" > "+hfdl.too_old_min+"m"),t.el.style.background="grey")})},6e4),w3_do_when_rendered("id-hfdl-menus",function(){ext_send("SET reset"),hfdl.double_fault=!1,kiwi_ajax(hfdl.url,"hfdl_get_systable_done_cb",0,1e4)})}function hfdl_show_kiwi_cb(e,l,t){l=!(l=+l);w3_color(e,l?"lime":"white"),hfdl.flights_visible&&kiwi_map_markers_visible("id-hfdl-flight",!l),hfdl.gs_visible&&hfdl_gs_visible(!l),w3_hide2("id-hfdl-kiwi-icon",!l)}function hfdl_clear_old_cb(e,l,t){var d;+l&&(d=Date.now()-60*hfdl.too_old_min*1e3,w3_obj_enum(hfdl.flights,function(e,l,t){t.upd>d||(console.log("FL-CLR "+t.flight),t.mkr.remove(),delete hfdl.flights[t.flight])}))}function hfdl_flights_visible_cb(e,l,t){t||(hfdl.flights_visible=l,kiwi_map_markers_visible("id-hfdl-flight",l))}function hfdl_gs_visible(e){kiwi_map_markers_visible("id-hfdl-AFT-active",e),kiwi_map_markers_visible("id-hfdl-gs",e)}function hfdl_gs_visible_cb(e,l,t){t||(hfdl.gs_visible=l,w3_checkbox_set(e,l),hfdl_gs_visible(l))}function hfdl_day_night_visible_cb(e,l,t){t||hfdl.kmap.day_night&&(l=w3_checkbox_get(e),kiwi_map_day_night_visible(hfdl.kmap,l))}function hfdl_graticule_visible_cb(e,l,t){t||hfdl.kmap.graticule&&(l=w3_checkbox_get(e),kiwi_map_graticule_visible(hfdl.kmap,l))}function hfdl_map_stations(){hfdl.refs=kiwi_deep_copy(hfdl.stations.stations);var t=[];hfdl.refs.forEach(function(e,l){l=hfdl_place_gs_marker(l);t.push(l),e.mkr=l}),ext_send("SET send_lowres_latlon")}function hfdl_place_gs_marker(e){var l=hfdl.refs[e];l.id=l.name.split(", ")[1],l.title=l.name,hfdl.bf_gs[l.id]=e;var t=kiwi_map_add_marker_div(hfdl.kmap,kmap.NO_ADD_TO_MAP,[l.lat,l.lon],"",[12,12],[0,0],1);if(hfdl.kmap.map){var d="New Zealand"==l.id;kiwi_style_marker(hfdl.kmap,kmap.ADD_TO_MAP,t,l.id,"id-hfdl-gs",d);for(var i=d?1:-1,n=0;n<hfdl.bf.length;n++){var _=19*i*n;kiwi_map_add_marker_div(hfdl.kmap,kmap.ADD_TO_MAP,[l.lat,l.lon],"id-hfdl-AFT id-hfdl-AFT-"+e+"-"+n+" w3-hide",[i*(d?26:6)+_,d?33:-13],[0,0],1);_=w3_el("id-hfdl-AFT-"+e+"-"+n);_.addEventListener("mouseenter",function(e){e=e.target;hfdl.saved_color=e.style.background,e.style.background="yellow"}),_.addEventListener("mouseleave",function(e){e.target.style.background=hfdl.saved_color}),_.addEventListener("click",function(e){console.log("*click*"),console.log(e);var l,t=e.target,d=w3_match_wildcard(t,"id-hfdl-AFT-f-");0!=d&&(console.log("click cf1="+dq(d)),d=(d=d.split("f-")[1]).toLowerCase().replace(/_/g," "),console.log("click cf2="+dq(d)),(l=hfdl_menu_match(null,d)).found_menu_match&&(t=hfdl_menu_match(e=hfdl_freq_2_band(parseInt(d)),e.toString()),console.log("click BAND cf="+dq(d)+" b="+e+" "+dq(t.match_menu)+" "+dq(t.match_val)),hfdl_pre_select_cb(t.match_menu,t.match_val,!1),hfdl_pre_select_cb(l.match_menu,l.match_val,!1)))}),_.innerHTML=(hfdl.bf[n].toString().length<2?"&nbsp;":"")+hfdl.bf[n],_.style.background=hfdl.bf_color[n]}}return l.type_host=!1,t}function hfdl_flight_update(l,e,t){var d,i,n,_,s;hfdl.flights[l]?((_=(s=hfdl.flights[l]).mkr).setLatLng([e,t]),d=s.pos.push([e,t]),s.el.style.background="blue",i=Date.now(),n=Math.floor((i-s.upd)/6e4%60),s.upd=i,console.log("FL-UPD "+l+" "+e.toFixed(4)+" "+t.toFixed(4)+" #"+d+" "+n+"m")):(console.log("FL-NEW "+l+" "+e.toFixed(4)+" "+t.toFixed(4)),_=kiwi_map_add_marker_div(hfdl.kmap,kmap.NO_ADD_TO_MAP,[e,t],"",[12,12],[0,0],1),s={flight:l,mkr:_,upd:Date.now(),pos:[]},hfdl.test_flight&&l.startsWith("ABC")&&(s.upd-=60*(hfdl.too_old_min+10)*1e3),s.pos.push([e,t]),hfdl.flights[l]=s,kiwi_style_marker(hfdl.kmap,kmap.ADD_TO_MAP,_,l,"id-hfdl-flight id-hfdl-flight-"+l+(hfdl.flights_visible?"":" w3-hide"),kmap.DIR_RIGHT,function(e){w3_iterate_classname("id-hfdl-flight-"+l,function(e){e&&(w3_color(e,"white","blue"),s.el=e)})}))}function hfdl_update_AFT(i,e){var l;"New Zealand"==i||e.sort(function(e,l){return parseFloat(e)-parseFloat(l)});var n=hfdl.bf_gs[i],_=0;for(e.forEach(function(e,l){var d=w3_el("id-hfdl-AFT-"+n+"-"+l),t=hfdl_freq_2_band(e);d.innerHTML=(t.toString().length<2?"&nbsp;":"")+t,w3_remove_wildcard(d,"id-hfdl-AFT-f-"),w3_add(d,"id-hfdl-AFT-f-"+(+e).toFixed(0)+"_"+i.replace(/ /g,"_")),w3_obj_enum(hfdl.bf,function(e,l,t){d.style.background=hfdl.bf_color[l]},{value_match:t}),hfdl.gs_visible&&w3_remove(d,"w3-hide"),w3_add(d,"id-hfdl-AFT-active"),_=l+1}),l=_;l<hfdl.bf_cf.length;l++){var t=w3_el("id-hfdl-AFT-"+n+"-"+l);w3_add(t,"w3-hide"),w3_remove(t,"id-hfdl-AFT-active")}}function hfdl_map_click_cb(e,l){}function hfdl_map_move_end_cb(e,l){}function hfdl_freq_2_band(e){e=Math.floor(+e/1e3);return e=2==e?3:e}function hfdl_menu_match(n,_){var s={found_menu_match:!1,match_menu:0,match_val:0},o="hfdl.menu1",a=!1;return dbgUs&&console.log("CONSIDER "+o+" "+dq(_)+" -----------------------------------------"),w3_select_enum(o,function(e,l){var t,d,i;e.disabled||(t=+e.value,s.found_menu_match||-1==t||(d=parseFloat(e.innerHTML),i=e.innerHTML.toLowerCase(),dbgUs&&console.log("CONSIDER "+t+" "+dq(e.innerHTML)),isNumber(n)&&isNumber(d)?d==n&&(dbgUs&&console.log("MATCH num: "+dq(i)+"["+l+"]"),a=!0):(dbgUs&&console.log("menu_s "+dq(i)+" m_str "+dq(_)+" "+(i.includes(_)?"T":"F")),i.includes(_)&&(dbgUs&&console.log("MATCH str: "+dq(i)+"["+l+"]"),a=!0)),a&&(dbgUs&&console.log("MATCH rv menu="+o+" val="+t+" "+dq(e.innerHTML)),s.match_menu=o,s.match_val=t,s.match_entry=e.innerHTML,s.found_menu_match=!0)))}),s}function hfdl_get_systable_done_cb(e){var d,l=hfdl.url,t=!1;if(e?e.AJAX_error&&"timeout"==e.AJAX_error?(console.log("hfdl_get_systable_done_cb: TIMEOUT"),t=hfdl.using_default=!0):e.AJAX_error&&"status"==e.AJAX_error?(console.log("hfdl_get_systable_done_cb: status="+e.status),t=hfdl.using_default=!0):isObject(e)||(console.log("hfdl_get_systable_done_cb: not array"),t=!0):(console.log("hfdl_get_systable_done_cb: stations="+e),t=!0),t){if(hfdl.double_fault)return console.log("hfdl_get_systable_done_cb: default station list fetch FAILED"),void console.log(e);console.log(e);var l=kiwi_url_origin()+"/extensions/HFDL/systable.backup.cjson";return console.log("hfdl_get_systable_done_cb: using default station list "+l),hfdl.using_default=!0,hfdl.double_fault=!0,void kiwi_ajax(l,"hfdl_get_systable_done_cb",0,1e4)}console.log("hfdl_get_systable_done_cb: from "+l),isDefined(e.AJAX_error)?console.log(e):(hfdl.stations=e,hfdl_map_stations(),hfdl_render_menus(),hfdl.url_params=ext_param(),dbgUs&&console.log("url_params="+hfdl.url_params),hfdl.url_params&&(l=(t=hfdl.url_params.split(","))[0].parseFloatWithUnits("kM",.001),e=kiwi_decodeURIComponent("hfdl",t[0]).toLowerCase(),dbgUs&&console.log("URL freq="+l),d=0,(l=hfdl_menu_match(l,e)).found_menu_match&&t.shift(),t.forEach(function(e,l){var t;dbgUs&&console.log("HFDL param2 <"+e+">"),w3_ext_param("help",e).match?extint_help_click():w3_ext_param("map",e).match?hfdl.show=hfdl.SHOW_MAP:w3_ext_param("split",e).match?hfdl.show=hfdl.SHOW_SPLIT:(t=w3_ext_param("display",e)).match?isNumber(t.num)&&hfdl_display_cb("id-hfdl.dsp",w3_clamp(t.num,0,hfdl.dsp_s.length-1,0)):(t=w3_ext_param("log_time",e)).match?isNumber(t.num)&&hfdl_log_mins_cb("id-hfdl.log_mins",t.num):(t=w3_ext_param("gs",e)).match?isNumber(t.num)&&0==t.num&&hfdl_gs_visible_cb("id-hfdl.gs_visible",!1):w3_ext_param("test",e).match?d=1:console.log('HFDL: unknown URL param "'+e+'"')}),l.found_menu_match&&(2<(e=l.match_entry.split(" ")[0]).length&&(e=hfdl_menu_match(t=hfdl_freq_2_band(e),t.toString()),console.log("BAND b="+t+" "+dq(e.match_menu)+" "+dq(e.match_val)),hfdl_pre_select_cb(e.match_menu,e.match_val,!1)),hfdl_pre_select_cb(l.match_menu,l.match_val,!1))),setTimeout(function(){hfdl_show_cb("id-hfdl.show",hfdl.show)},1e3),d&&hfdl_test_cb("",1),dbgUs&&console.log(hfdl.stations))}function hfdl_render_menus(){for(var s=[],o=0;o<hfdl.bf.length;o++)s[o]=[];function d(e,n,l,t){l=kiwi_deep_copy(l),hfdl.menu_n++,hfdl["menu"+n]=-1,hfdl.menus[n]=l,hfdl.menu_s[n]=t;var _=[];w3_obj_enum(l,function(e,l,t){var d=t.name.split(", ")[1];t.frequencies.sort(function(e,l){return parseInt(e)-parseInt(l)});var i=[];t.frequencies.forEach(function(e){var l;e<hfdl.bf.length?(l=[d,"w3-bold w3-text-blue"],i.push(l)):i.push(e),0==n&&0!=e&&function(e){var l=parseInt(e);for(o=0;o<hfdl.bf.length;o++)if(l<1e3*(hfdl.bf[o]+1)){s[o].push(e);break}}(e+" "+d)}),0==n?_[d]=i:_.push(i)}),l=w3_select_hier(hfdl.sfmt,t,"select","hfdl.menu"+n,-1,_,"hfdl_pre_select_cb"),l=w3_create_appendElement(e,"div",l),w3_add(l,"id-"+t)}var i=w3_el("id-hfdl-menus");i.innerHTML="",hfdl.menu_n=0,w3_obj_enum(hfdl.stations,function(e,l,t){"stations"==e&&d(i,0,t,"Stations")});var e=[];for(o=0;o<hfdl.bf.length;o++){s[o].sort(function(e,l){return parseInt(l)-parseInt(e)});var l={};l.name="x, "+hfdl.bf[o]+" MHz",l.frequencies=[o],s[o].forEach(function(e){l.frequencies.push(e)}),e[o.toString()]=l}d(i,1,e,"Bands")}function hfdl_format_cb(e,l,t){t||(hfdl.format_m=+l,w3_set_value(e,+l),hfdl_render_menus())}function hfdl_msg(e,l){var t=w3_el("id-hfdl-msg");w3_remove_then_add(t,hfdl.msg_last_color,e),hfdl.msg_last_color=e,t.innerHTML="<b>"+l+"</b>"}function hfdl_clear_menus(e){for(var l=0;l<hfdl.menu_n;l++)isArg(e)&&l==e||w3_select_value("hfdl.menu"+l,-1)}function hfdl_np_pre_select_cb(e,l,t){hfdl_pre_select_cb(e,l,t)}function hfdl_pre_select_cb(i,n,e){var _,s,o,a;e||(n=+n,dbgUs&&console.log("hfdl_pre_select_cb path="+i+" val="+n),_=parseInt(i.split("hfdl.menu")[1]),dbgUs&&console.log("hfdl_pre_select_cb path="+i+" val="+n+" menu_n="+_),s="",o=0,a=!1,w3_select_enum(i,function(e){if(!a){dbgUs&&console.log("hfdl_pre_select_cb menu_n="+_+" opt.val="+e.value+" opt.disabled="+e.disabled+" opt.inner="+e.innerHTML+" opt.id="+e.id);var l=0==_&&e.disabled&&-1!=e.value,t=1==_&&e.id&&0==e.id.split("-")[2];if(dbgUs&&console.log("menu0_hdr="+l+" menu1_hdr="+t),o=l||t?(s=o?s+" "+e.innerHTML:e.innerHTML,1):0,e.value==n){a=!0,hfdl.cur_menu=_,hfdl.cur_header=s,hfdl.menu_sel=e.innerHTML+" ",dbgUs&&console.log("hfdl_pre_select_cb opt.val="+e.value+" menu_sel="+hfdl.menu_sel+" opt.id="+e.id);var d=e.id.split("id-")[1];if(isUndefined(d))return console.log("hfdl_pre_select_cb: option.id isUndefined"),console.log("hfdl_pre_select_cb opt.val="+e.value+" opt.disabled="+e.disabled+" opt.inner="+e.innerHTML),void console.log(e);l=+(d=d.split("-"))[0],t=+d[1];dbgUs&&console.log("hfdl_pre_select_cb i="+l+" j="+t);e=w3_obj_seq_el(hfdl.menus[_],l);dbgUs&&w3_console.log(e,"o1"),o2=w3_obj_seq_el(e.frequencies,t),dbgUs&&w3_console.log(o2,"o2");d=null,l=0;o2=parseInt(o2),isNumber(o2)&&(dbgUs&&console.log(o2),l=(o2<hfdl.bf.length?(e=hfdl.bf_z[o2],t=hfdl.bf_cf[o2],zoom_level==e&&zoom_step(ext_zoom.OUT),ext_tune(t,"iq",ext_zoom.ABS,e),dx.db==dx.DB_EiBi&&dx_is_single_type(dx.DX_HFDL)||(dx_set_type(dx.DX_HFDL),dx_database_cb("",dx.DB_EiBi))):(hfdl_tune(o2),d=(+o2).toFixedNZ(1)+" kHz"),1)),l&&hfdl_msg("w3-text-css-yellow",hfdl.menu_s[_]+", "+hfdl.cur_header+(d?": "+d:"")),w3_select_value(i,n)}}}),hfdl_clear_menus(_))}function hfdl_tune(e){dbgUs&&console.log("hfdl_tune tx f="+e.toFixed(2)),hfdl.freq=e,ext_tune(e,"iq",ext_zoom.CUR),ext_set_passband(hfdl.pb.lo,hfdl.pb.hi),ext_send("SET display_freq="+e.toFixed(2))}function hfdl_clear_button_cb(e,l,t){t||(hfdl.console_status_msg_p.s=encodeURIComponent("\f"),kiwi_output_msg("id-hfdl-console-msgs","id-hfdl-console-msg",hfdl.console_status_msg_p),hfdl_test_cb(hfdl.log_txt="",0))}function hfdl_show_cb(e,l,t){t||(l=+l,hfdl.show=l,w3_set_value(e,l),w3_hide2("id-hfdl-msgs",l==hfdl.SHOW_MAP),w3_hide2("id-hfdl-map",l==hfdl.SHOW_MSGS),w3_el("id-hfdl-msgs").style.top=px(l==hfdl.SHOW_SPLIT?hfdl.dataH-150:0),w3_el("id-hfdl-msgs").style.height=px(l==hfdl.SHOW_SPLIT?150:hfdl.dataH),l==hfdl.SHOW_SPLIT&&w3_scrollDown("id-hfdl-console-msg"))}function hfdl_display_cb(e,l,t){t||(l=+l,hfdl.dsp=l,w3_set_value(e,l))}function hfdl_test_cb(e,l,t){t||(l=+l,dbgUs&&console.log("hfdl_test_cb: val="+l),hfdl.testing=l,w3_el("id-hfdl-bar").style.width="0%",w3_show_hide("id-hfdl-bar-container",hfdl.testing),t=-(+ext_get_freq_kHz()).toFixed(2),dbgUs&&console.log("hfdl_test_cb="+(l?t:0)),ext_send("SET test="+(l?t:0)))}function hfdl_log_mins_cb(e,l){hfdl.log_mins=w3_clamp(+l,0,1440,0),console.log("hfdl_log_mins_cb path="+e+" val="+l+" log_mins="+hfdl.log_mins),w3_set_value(e,hfdl.log_mins),kiwi_clearInterval(hfdl.log_interval),0!=hfdl.log_mins&&(console.log("HFDL logging.."),hfdl.log_interval=setInterval(function(){hfdl_log_cb()},6e4*hfdl.log_mins))}function hfdl_log_cb(){var e=kiwi_host()+"_"+(new Date).toISOString().replace(/:/g,"_").replace(/\.[0-9]+Z$/,"Z")+"_"+w3_el("id-freq-input").value+"_"+cur_mode,l=new Blob([hfdl.log_txt],{type:"text/plain"}),t=document.createElement("a");t.style="display: none",t.href=window.URL.createObjectURL(l),t.download="HFDL."+e+".log.txt",document.body.appendChild(t),console.log("hfdl_log: "+t.download),t.click(),window.URL.revokeObjectURL(t.href),document.body.removeChild(t)}function HFDL_environment_changed(e){var l,t,d,i;(e.freq||e.mode)&&(l=(+ext_get_freq_kHz()).toFixed(0),t=(+hfdl.freq).toFixed(0),"iq"!=(d=ext_get_mode())?hfdl_clear_menus():t==l||"iq"!=d||(i=hfdl_menu_match(+l,l)).found_menu_match&&hfdl_pre_select_cb(i.match_menu,i.match_val,!1)),!e.resize||(i=w3_el("id-hfdl-data"))&&(e=Math.max(0,(window.innerWidth-hfdl.dataW-time_display_width())/2),i.style.left=px(e))}function HFDL_blur(){ext_set_mode(hfdl.saved_mode),ext_agc_delay(hfdl.save_agc_delay),kiwi_clearInterval(hfdl.log_interval),kiwi_clearInterval(hfdl.locations_age_interval),kiwi_map_blur(hfdl.kmap)}function HFDL_help(e){return e&&(e=w3_text("w3-medium w3-bold w3-text-aqua","HFDL decoder help")+w3_div("w3-margin-T-8 w3-scroll-y|height:90%",w3_div("w3-margin-R-8",'Periodic downloading of the HFDL message log to a file can be specified via the <i>log min</i> value. Adjust your browser settings so these files are downloaded and saved automatically without causing a browser popup window for each download.<br><br>URL parameters: <br><i>(menu match)</i> &nbsp; map|split &nbsp; display:[012] &nbsp; log_time:<i>mins</i> &nbsp; gs:0 &nbsp; test<br><br>The first URL parameter can be a frequency entry from the "Bands" menu (e.g. "8977") or the numeric part of the blue "full band" entry (e.g. "5" part of "5 MHz" entry). <br><i>map</i> will initially show the map instead of the message panel. <i>split</i> will show both. <br>[012] refers to the order of selections in the corresponding menu. <br><i>gs:0</i> initially disables display of the ground stations.<br><br>Keywords are case-insensitive and can be abbreviated. So for example these are valid: <br><i>ext=hfdl,8977</i> &nbsp;&nbsp; <i>ext=hfdl,8977,d:1</i> &nbsp;&nbsp; <i>ext=hfdl,8977,l:10</i> &nbsp;&nbsp; <i>ext=hfdl,5,map</i><br>')),confirmation_show_content(e,610,300),w3_el("id-confirmation-container").style.height="100%"),!0}function HFDL_config_html(){ext_config_html(hfdl,"hfdl","HFDL","HFDL configuration")}



