

/* web/extensions/HFDL/HFDL.min.js */
var hfdl={ext_name:"HFDL",first_time:!0,dataH:445,dataW:1024,ctrlW:600,ctrlH:185,freq:0,sfmt:"w3-text-red w3-ext-retain-input-focus",pb:{lo:300,hi:2600},stations:null,url:kiwi_SSL()+"files.kiwisdr.com/hfdl/systable.cjson",using_default:!1,double_fault:!1,bf_cf:[3500,4670,5600,6625,8900,10065,11290,13310,15020,17945,21965],bf_z:[4,9,6,7,7,8,7,8,8,8,8],bf:[],bf_gs:{},bf_color:["pink","lightCoral","lightSalmon","khaki","gold","yellowGreen","lime","cyan","deepSkyBlue","lavender","violet"],MSGS:0,MAP:1,SPLIT:2,show:0,show_s:["messages","map","split"],ALL:0,DX:1,ACARS:2,SQUITTER:3,dsp:0,dsp_s:["all","DX","ACARS","squitter"],uplink:!0,downlink:!0,testing:!1,log_mins:0,log_interval:null,log_txt:"",menu_n:0,menu_s:[],menus:[],menu_sel:"",flights:{},too_old_min:10,flights_visible:!0,gs_visible:!0,cur_map:null,map_layers:[],init_latlon:[28,15],init_zoom:2,mapZoom_nom:17,hosts_clusterer:null,refs_clusterer:null,heatmap_visible:!0,show_hosts:!0,show_refs:!0,console_status_msg_p:{scroll_only_at_bottom:!0,process_return_alone:!1,remove_returns:!0,ncol:135}};function HFDL_main(){ext_switch_to_client(hfdl.ext_name,hfdl.first_time,hfdl_recv),hfdl.first_time||hfdl_controls_setup(),hfdl.first_time=!1}function hfdl_recv(e){if("DAT"!=arrayBufferToStringLen(e,3))for(var l=arrayBufferToString(e).substring(4).split(" "),t=0;t<l.length;t++){var i=l[t].split("=");switch(i[0]){case"ready":kiwi_load_js(["pkgs/js/sprintf/sprintf.js"]),kiwi_load_js_dir("pkgs_maps/",["pkgs_maps.js","pkgs_maps.css"],"hfdl_controls_setup");break;case"lowres_latlon":var o=kiwi_decodeURIComponent("",i[1]);dbgUs&&console.log("lowres_latlon="+o),o=JSON.parse(o);var n=L.icon({iconUrl:"kiwi/gfx/kiwi-with-headphones.51x67.png",iconAnchor:[25,33]}),d=L.marker(o,{icon:n,opacity:1});d.addTo(hfdl.cur_map),w3_add(d._icon,"id-hfdl-kiwi-icon w3-hide"),d._icon.style.zIndex=99999;break;case"bar_pct":if(hfdl.testing){var _=w3_clamp(parseInt(i[1]),0,100),s=w3_el("id-hfdl-bar");s&&(s.style.width=_+"%")}break;case"test_start":hfdl_test_cb("",1);break;case"test_done":hfdl.testing&&(w3_hide("id-hfdl-bar-container"),w3_show("id-hfdl-record"));break;case"chars":var a=i[1],f=kiwi_decodeURIComponent("",i[1]).split("\n"),h=f[1].startsWith("Uplink"),r=f[1].startsWith("Downlink");if(!hfdl.uplink&&h)break;if(!hfdl.downlink&&r)break;var c=null,u=null,m=null;switch(f.forEach(function(e,l){if(f[l]=e.trim(),!h){var t=f[l].split(":"),i=t[0],o=t[1]&&""!=t[1]?t[1].slice(1):null;"Flight ID"==i&&o?c=o:"Lat"==i&&o?u=+o:"Lon"==i&&o&&(m=+o)}}),c&&u&&m&&(180!=u||180!=m)&&hfdl_flight_update(c,u,m),f[3].startsWith("Squitter")&&f.forEach(function(e,l){if(e.startsWith("ID:"))y=e.split(": ")[1];else if(e.startsWith("Frequencies in use:")){e=e.split(": ")[1],hfdl.dsp==hfdl.SQUITTER&&(a+=y+": "+e+"\n");var t=e.split(", ");hfdl_update_AFT(y.split(", ")[1],t)}}),hfdl.dsp){case hfdl.ALL:break;case hfdl.DX:if(a=f[0]+"\n"+f[1].slice(0,-1)+" | "+f[2],f[3].startsWith("Squitter")){a+=" | Squitter: ";var g=!0;f.forEach(function(e,l){if(!(l<=3)&&e.startsWith("ID:")){var t=e.split(", ");t.length<2||""==t[1]||(a+=(g?"":", ")+t[1],g=!1)}}),a+="\n";break}a+=" | "+f[3];var p,b=!1,w=!1,v="",k="";["Logon request","Logon resume","Logon confirm","Unnumbered data","Unnumbered ack'ed"].forEach(function(e,l){!b&&f[4].includes(e)&&(b=!0,p=e,f.forEach(function(e,l){if(!(l<=4)){var t=e.split(":"),i=t[0],o=t[1]&&""!=t[1]?t[1].slice(1):null,n=t[2]&&""!=t[2]?t[2].slice(1):null;"Flight ID"==i&&o?v+=" | Flight "+o:"Lat"==i&&o?v+=" | Lat "+(+o).toFixed(4):"Lon"==i&&o?v+=" | Lon "+(+o).toFixed(4):"ACARS"==i?w="ACARS data":"Message"==i?w="ACARS message":h&&"Src GS"==i?k=" | "+o:r&&o&&o.endsWith("Flight")&&(k=" | Flight "+n)}}))}),a+=b?" | "+(w?w+k+v:p+v):" | "+f[4],a+="\n";break;case hfdl.ACARS:a="",k="";var x=!1;w="";f.forEach(function(e,l){var t=e.split(":"),i=t[0],o=t[1]&&""!=t[1]?t[1].slice(1):null,n=t[2]&&""!=t[2]?t[2].slice(1):null;if(h&&"Src GS"==i)k=o;else if(r&&o&&o.endsWith("Flight"))k="Flight "+n;else{if("Message"==i)return a=f[0]+"\nACARS message from "+k+"\n",void(x=!0);i.startsWith("Media Advisory")&&(x=!1)}x&&""!=e&&(w+=" "+e+"\n")}),""!=w&&(a+=w);break;case hfdl.SQUITTER:if(!f[3].startsWith("Squitter")){a="";break}a=f[0]+"\nSquitter | "+f[2]+"\n";var y="";f.forEach(function(e,l){e.startsWith("ID:")?y=e.split(": ")[1]:e.startsWith("Frequencies in use:")&&(e=e.split(": ")[1],a+=y+": "+e+"\n")})}""!=a&&hfdl_decoder_output_chars(a);break;default:console.log("hfdl_recv: UNKNOWN CMD "+i[0])}}else{var T=new Uint8Array(e,4),F=T[0];console.log("hfdl_recv: DATA UNKNOWN cmd="+F+" len="+(T.length-1))}}function hfdl_decoder_output_chars(e){hfdl.console_status_msg_p.s=e,hfdl.log_txt+=kiwi_remove_ANSI_escape_sequences(kiwi_decodeURIComponent("HFDL",e)),kiwi_output_msg("id-hfdl-console-msgs","id-hfdl-console-msg",hfdl.console_status_msg_p)}function hfdl_controls_setup(){for(i=0;i<hfdl.bf_cf.length;i++)hfdl.bf[i]=Math.floor(hfdl.bf_cf[i]/1e3);var e=sprintf("width:%dpx; height:%dpx;",hfdl.dataW,hfdl.dataH),l="w3-label-inline w3-label-not-bold",t=time_display_html("hfdl")+w3_div("id-hfdl-data w3-display-container|left:0px; "+e,w3_div("id-hfdl-msgs w3-hide|width:1024px; height:"+px(hfdl.dataH)+";  z-index:1; overflow:hidden; position:absolute;",w3_div(sprintf("id-hfdl-console-msg w3-text-output w3-scroll-down w3-small w3-text-black|width:%dpx; position:absolute; overflow-x:hidden;",1024),'<pre><code id="id-hfdl-console-msgs"></code></pre>')),w3_div("|"+e+' position:absolute; z-index:0|id="id-hfdl-map"'))+w3_div("id-hfdl-options w3-display-right w3-text-white|top:230px; right:0px; width:250px; height:200px",w3_text("w3-text-aqua w3-bold","HFDL options"),w3_select("w3-margin-T-4 w3-width-auto "+hfdl.sfmt,"","show","hfdl.show",hfdl.show,hfdl.show_s,"hfdl_show_cb"),w3_button("id-hfdl-show-kiwi w3-margin-T-10 class-button w3-cyan w3-momentary","Show Kiwi","hfdl_show_kiwi_cb",1),w3_checkbox("w3-margin-T-10//"+l,"Show day/night","hfdl.day_night_visible",!0,"hfdl_day_night_visible_cb"),w3_checkbox(l,"Show graticule","hfdl.graticule_visible",!0,"hfdl_graticule_visible_cb"),w3_inline("w3-margin-T-10 w3-valign/",w3_checkbox("//"+l,"Show flights","hfdl.flights_visible",!0,"hfdl_flights_visible_cb"),w3_button("id-hfdl-show-kiwi w3-margin-left class-button w3-small w3-grey w3-momentary","Clear old","hfdl_clear_old_cb",1)),w3_checkbox(l,"Show ground stations","hfdl.gs_visible",!0,"hfdl_gs_visible_cb")),o=w3_div("id-hfdl-controls w3-text-white",w3_col_percent("w3-tspace-8 w3-valign/",w3_div("w3-medium w3-text-aqua","<b>HFDL decoder</b>"),25,w3_div("",'From <b><a href="https://github.com/szpajder/dumphfdl" target="_blank">dumphfdl</a></b> by Tomasz Lemiech &copy;2021 GPL-3.0</b>')),w3_inline("w3-tspace-4 w3-halign-space-between/",w3_div("id-hfdl-msg")),w3_inline("w3-margin-T-16/w3-margin-between-16",w3_inline("w3-valign-end w3-round-large w3-padding-small w3-text-white w3-grey/",w3_select(hfdl.sfmt,"Display","","hfdl.dsp",hfdl.dsp,hfdl.dsp_s,"hfdl_display_cb"),w3_div("w3-margin-L-16",w3_checkbox("/w3-label-inline w3-label-not-bold","Uplink","hfdl.uplink",hfdl.uplink,"w3_bool_cb"),w3_checkbox("/w3-label-inline w3-label-not-bold","Downlink","hfdl.downlink",hfdl.downlink,"w3_bool_cb"))),w3_inline("id-hfdl-menus w3-tspace-6 w3-gap-16/")),w3_inline("w3-tspace-8 w3-valign/w3-margin-between-12",w3_button("w3-padding-smaller","Next","w3_select_next_prev_cb",{dir:w3_MENU_NEXT,id:"hfdl.menu",isNumeric:!0,func:"hfdl_np_pre_select_cb"}),w3_button("w3-padding-smaller","Prev","w3_select_next_prev_cb",{dir:w3_MENU_PREV,id:"hfdl.menu",isNumeric:!0,func:"hfdl_np_pre_select_cb"}),w3_button("id-hfdl-clear-button w3-padding-smaller w3-css-yellow","Clear","hfdl_clear_button_cb"),w3_button("id-id-hfdl-test w3-padding-smaller w3-aqua","Test","hfdl_test_cb",1),w3_div("id-hfdl-bar-container w3-progress-container w3-round-large w3-white w3-hide|width:70px; height:16px",w3_div("id-hfdl-bar w3-progressbar w3-round-large w3-light-green|width:0%","&nbsp;")),w3_input("id-hfdl-log-mins/w3-label-not-bold/w3-ext-retain-input-focus|padding:0;width:auto|size=4","log min","hfdl.log_mins",hfdl.log_mins,"hfdl_log_mins_cb")));ext_panel_show(o,t,null),ext_set_data_height(hfdl.dataH),ext_set_controls_width_height(hfdl.ctrlW,hfdl.ctrlH),time_display_setup("hfdl"),w3_el("hfdl-time-display").style.top=px(10),hfdl_msg("w3-text-css-yellow","&nbsp;"),HFDL_environment_changed({resize:1,freq:1}),hfdl.save_agc_delay=ext_agc_delay(100),ext_send("SET start"),hfdl.saved_mode=ext_get_mode(),ext_set_mode("iq"),ext_set_passband(hfdl.pb.lo,hfdl.pb.hi),12e3!=ext_nom_sample_rate()&&w3_add("id-hfdl-test","w3-disabled"),hfdl_map_init(),w3_do_when_rendered("id-hfdl-menus",function(){ext_send("SET reset"),hfdl.double_fault=!1,kiwi_ajax(hfdl.url,"hfdl_get_systable_done_cb",0,1e4)})}function hfdl_map_init(){var e=19,l=function(){return e=18,L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{tileSize:256,zoomOffset:0,attribution:'<a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',crossOrigin:!0})}(),t=L.map("id-hfdl-map",{maxZoom:e,minZoom:1,doubleClickZoom:!1,zoomControl:!1}).setView(hfdl.init_latlon,hfdl.init_zoom);t.on("baselayerchange",function(e){var l=e.target,t=l.getCenter();hfdl_pan_zoom(l,[t.lat+.1,t.lng],-1),hfdl_pan_zoom(l,[t.lat,t.lng],-1)}),t.on("click",hfdl_click_info_cb),t.on("moveend",function(e){hfdl_pan_end(e)}),t.on("zoomend",function(e){hfdl_zoom_end(e)}),L.control.zoom_Kiwi({position:"topright",zoomNomText:"2",zoomNomLatLon:hfdl.init_latlon}).addTo(t),l.addTo(t),hfdl.cur_map=t;var i=L.control.scale();i.addTo(t),i.setPosition("bottomleft");var o=new Terminator;o.setStyle({fillOpacity:.35}),o.addTo(t),setInterval(function(){var e=new Terminator;o.setLatLngs(e.getLatLngs()),o.redraw()},6e4),o._path.style.cursor="grab",hfdl.day_night=o,dbgUs&&(o.getPane()._jks="Terminator"),hfdl.graticule=L.latlngGraticule(),hfdl.graticule.addTo(t),hfdl.map_layers.push(hfdl.graticule),t.on("zoom",hfdl_info_cb),t.on("move",hfdl_info_cb),setInterval(function(){hfdl_flights_age()},6e4)}function hfdl_flights_age(){var e=Date.now()-60*hfdl.too_old_min*1e3;w3_obj_enum(hfdl.flights,function(l,t,i){i.upd<e&&(console.log("FL-OLD "+i.flight+" > "+hfdl.too_old_min+"m"),i.el.style.background="grey")})}function hfdl_flight_update(e,l,t){if(hfdl.flights[e]){(s=(d=hfdl.flights[e]).mkr).setLatLng([l,t]);var i=d.pos.push([l,t]);d.el.style.background="blue";var o=Date.now(),n=Math.floor((o-d.upd)/6e4%60);d.upd=o,console.log("FL-UPD "+e+" "+l.toFixed(4)+" "+t.toFixed(4)+" #"+i+" "+n+"m")}else{console.log("FL-NEW "+e+" "+l.toFixed(4)+" "+t.toFixed(4));var d,_=L.divIcon({className:"",iconAnchor:[12,12],tooltipAnchor:[0,0],html:""}),s=L.marker([l,t],{icon:_,opacity:1});(d={flight:e,mkr:s,upd:Date.now(),pos:[]}).pos.push([l,t]),hfdl.flights[e]=d,s.bindTooltip(e,{className:"id-hfdl-flight id-hfdl-flight-"+e+(hfdl.flights_visible?"":" w3-hide"),permanent:!0,direction:"right"}),s.on("add",function(l){w3_iterate_classname("id-hfdl-flight-"+e,function(e){e&&(w3_color(e,"white","blue"),d.el=e)})}),s.addTo(hfdl.cur_map)}}function hfdl_place_gs_marker(e,l){var t,i=hfdl.refs[e];i.idx=e,i.id=i.name.split(", ")[1],i.title=i.name,hfdl.bf_gs[i.id]=e;var o=L.divIcon({className:"",iconAnchor:[12,12],tooltipAnchor:[0,0],html:""}),n=L.marker([i.lat,i.lon],{icon:o,opacity:1});if(l){n.kiwi_mkr_2_ref_or_host=i;var d="New Zealand"==i.id;hfdl_style_marker(n,i.idx,i.id,"gs",l,d);var _=d?1:-1;for(t=0;t<hfdl.bf.length;t++){var s=19*_*t;o=L.divIcon({className:"id-hfdl-AFT id-hfdl-AFT-"+e+"-"+t+" w3-hide",iconAnchor:[_*(d?26:6)+s,d?33:-13]});L.marker([i.lat,i.lon],{icon:o,opacity:1}).addTo(l);var a=w3_el("id-hfdl-AFT-"+e+"-"+t);a.addEventListener("mouseenter",function(e){var l=e.target;hfdl.saved_color=l.style.background,l.style.background="yellow"}),a.addEventListener("mouseleave",function(e){e.target.style.background=hfdl.saved_color}),a.addEventListener("click",function(e){console.log("*click*"),console.log(e);var l=e.target,t=w3_match_wildcard(l,"id-hfdl-AFT-f-");if(0!=t){console.log("click cf1="+dq(t)),t=(t=t.split("f-")[1]).toLowerCase().replace(/_/g," "),console.log("click cf2="+dq(t));var i=hfdl_menu_match(null,t);if(i.found_menu_match){var o=hfdl_freq_2_band(parseInt(t)),n=hfdl_menu_match(o,o.toString());console.log("click BAND cf="+dq(t)+" b="+o+" "+dq(n.match_menu)+" "+dq(n.match_val)),hfdl_pre_select_cb(n.match_menu,n.match_val,!1),hfdl_pre_select_cb(i.match_menu,i.match_val,!1)}}}),a.innerHTML=(hfdl.bf[t].toString().length<2?"&nbsp;":"")+hfdl.bf[t],a.style.background=hfdl.bf_color[t]}}return i.type_host=!1,n.kiwi_mkr_2_ref_or_host=i,n}function hfdl_style_marker(e,l,t,i,o,n){e.bindTooltip(t,{className:"id-hfdl-"+i+" id-hfdl-"+i+"-"+l,permanent:!0,direction:n?"left":"right"}),e.on("add",function(e){var l=e.sourceTarget.kiwi_mkr_2_ref_or_host;w3_iterate_classname("id-hfdl-"+i+"-"+l.idx,function(e){e&&(l.type_host&&(l.selected?w3_color(e,"black","yellow"):w3_color(e,"white","blue")),e.title=l.title,e.kiwi_mkr_2_ref_or_host=l)})}),o&&(e.addTo(o),hfdl.map_layers.push(e))}function hfdl_freq_2_band(e){var l=Math.floor(+e/1e3);return 2==l&&(l=3),l}function hfdl_update_AFT(e,l){var t;"New Zealand"==e||l.sort(function(e,l){return parseFloat(e)-parseFloat(l)});var i=hfdl.bf_gs[e],o=0;for(l.forEach(function(l,t){var n=w3_el("id-hfdl-AFT-"+i+"-"+t),d=hfdl_freq_2_band(l);n.innerHTML=(d.toString().length<2?"&nbsp;":"")+d,w3_remove_wildcard(n,"id-hfdl-AFT-f-"),w3_add(n,"id-hfdl-AFT-f-"+(+l).toFixed(0)+"_"+e.replace(/ /g,"_")),w3_obj_enum(hfdl.bf,function(e,l,t){n.style.background=hfdl.bf_color[l]},{value_match:d}),hfdl.gs_visible&&w3_remove(n,"w3-hide"),w3_add(n,"id-hfdl-AFT-active"),o=t+1}),t=o;t<hfdl.bf_cf.length;t++){var n=w3_el("id-hfdl-AFT-"+i+"-"+t);w3_add(n,"w3-hide"),w3_remove(n,"id-hfdl-AFT-active")}}function hfdl_day_night_visible_cb(e,l,t){t||hfdl.day_night&&(w3_checkbox_get(e)?(hfdl.day_night.addTo(hfdl.cur_map),hfdl.map_layers.push(hfdl.day_night),hfdl.day_night._path.style.cursor="grab"):hfdl.day_night.remove())}function hfdl_graticule_visible_cb(e,l,t){t||hfdl.graticule&&(w3_checkbox_get(e)?(hfdl.graticule.addTo(hfdl.cur_map),hfdl.map_layers.push(hfdl.graticule)):hfdl.graticule.remove())}function hfdl_map_markers_visible(e,l,t){w3_iterate_children(e,function(e,i){e.className.includes(l)&&w3_hide2(e,!t)})}function hfdl_show_kiwi_cb(e,l,t){var i=!(l=+l);w3_color(e,i?"lime":"white"),hfdl.flights_visible&&hfdl_map_markers_visible("leaflet-tooltip-pane","id-hfdl-flight",!i),hfdl.gs_visible&&hfdl_gs_visible(!i),w3_hide2("id-hfdl-kiwi-icon",!i)}function hfdl_clear_old_cb(e,l,t){if(+l){var i=Date.now()-60*hfdl.too_old_min*1e3;w3_obj_enum(hfdl.flights,function(e,l,t){t.upd>i||(console.log("FL-CLR "+t.flight),t.mkr.remove(),delete hfdl.flights[t.flight])})}}function hfdl_flights_visible_cb(e,l,t){t||(hfdl.flights_visible=l,hfdl_map_markers_visible("leaflet-tooltip-pane","id-hfdl-flight",l))}function hfdl_gs_visible(e){hfdl_map_markers_visible("leaflet-marker-pane","id-hfdl-AFT-active",e),hfdl_map_markers_visible("leaflet-tooltip-pane","id-hfdl-gs",e)}function hfdl_gs_visible_cb(e,l,t){t||(hfdl.gs_visible=l,w3_checkbox_set(e,l),hfdl_gs_visible(l))}function hfdl_click_info_cb(e){}function hfdl_zoom_end(e){}function hfdl_pan_end(e){}function hfdl_info_cb(){}function hfdl_pan_zoom(e,l,t){null==l&&(l=e.getCenter()),-1==t&&(t=e.getZoom()),e.setView(l,t,{duration:0,animate:!1})}function hfdl_quick_zoom_cb(e,l,t){if(!t){var i=hfdl.quick_zoom[+l];hfdl_pan_zoom(hfdl.cur_map,[i.lat+.1,i.lon],i.z),hfdl_pan_zoom(hfdl.cur_map,[i.lat,i.lon],-1)}}function hfdl_ref_marker_offset(e){if(hfdl.known_location_idx){var l=hfdl.refs[hfdl.known_location_idx];l.mkr.setLatLng([l.lat,l.lon])}}function hfdl_marker_click(e){var l=e.kiwi_mkr_2_ref_or_host,t=l.title.replace("\n"," "),i=l.lat.toFixed(2)+" "+l.lon.toFixed(2)+" "+l.id+" "+t+(l.f?" "+l.f+" kHz":"");if(w3_set_value("id-hfdl-known-location",i),hfdl.known_location_idx){var o=hfdl.refs[hfdl.known_location_idx];o.selected=!1,console.log("ref_click: deselect ref "+o.id),hfdl_ref_marker_offset(!1)}hfdl.known_location_idx=l.idx,l.selected=!0,console.log("ref_click: select ref "+l.id),hfdl_rebuild_stations(),l.f&&ext_tune(l.f,"iq",ext_zoom.ABS,l.z,-l.p/2,l.p/2),hfdl_update_link(),hfdl_ref_marker_offset(!0)}function hfdl_map_stations(){hfdl.refs=kiwi_deep_copy(hfdl.stations.stations);var e=[];hfdl.refs.forEach(function(l,t){var i=hfdl_place_gs_marker(t,hfdl.cur_map);e.push(i),l.mkr=i}),hfdl.gs_markers=e,ext_send("SET send_lowres_latlon"),hfdl_rebuild_stations()}function hfdl_rebuild_stations(e){}function hfdl_menu_match(e,l){var t={found_menu_match:!1,match_menu:0,match_val:0},i="hfdl.menu1",o=!1;return dbgUs&&console.log("CONSIDER "+i+" "+dq(l)+" -----------------------------------------"),w3_select_enum(i,function(n,d){if(!n.disabled){var _=+n.value;if(!t.found_menu_match&&-1!=_){var s=parseFloat(n.innerHTML),a=n.innerHTML.toLowerCase();dbgUs&&console.log("CONSIDER "+_+" "+dq(n.innerHTML)),isNumber(e)&&isNumber(s)?s==e&&(dbgUs&&console.log("MATCH num: "+dq(a)+"["+d+"]"),o=!0):(dbgUs&&console.log("menu_s "+dq(a)+" m_str "+dq(l)+" "+(a.includes(l)?"T":"F")),a.includes(l)&&(dbgUs&&console.log("MATCH str: "+dq(a)+"["+d+"]"),o=!0)),o&&(dbgUs&&console.log("MATCH rv menu="+i+" val="+_+" "+dq(n.innerHTML)),t.match_menu=i,t.match_val=_,t.match_entry=n.innerHTML,t.found_menu_match=!0)}}}),t}function hfdl_get_systable_done_cb(e){var l=hfdl.url,t=!1;if(e?e.AJAX_error&&"timeout"==e.AJAX_error?(console.log("hfdl_get_systable_done_cb: TIMEOUT"),hfdl.using_default=!0,t=!0):e.AJAX_error&&"status"==e.AJAX_error?(console.log("hfdl_get_systable_done_cb: status="+e.status),hfdl.using_default=!0,t=!0):isObject(e)||(console.log("hfdl_get_systable_done_cb: not array"),t=!0):(console.log("hfdl_get_systable_done_cb: stations="+e),t=!0),t){if(hfdl.double_fault)return console.log("hfdl_get_systable_done_cb: default station list fetch FAILED"),void console.log(e);console.log(e);l=kiwi_url_origin()+"/extensions/HFDL/systable.backup.cjson";return console.log("hfdl_get_systable_done_cb: using default station list "+l),hfdl.using_default=!0,hfdl.double_fault=!0,void kiwi_ajax(l,"hfdl_get_systable_done_cb",0,1e4)}if(console.log("hfdl_get_systable_done_cb: from "+l),isDefined(e.AJAX_error))console.log(e);else{if(hfdl.stations=e,hfdl_map_stations(),hfdl_render_menus(),hfdl.url_params=ext_param(),dbgUs&&console.log("url_params="+hfdl.url_params),hfdl.url_params){var i=hfdl.url_params.split(","),o=i[0].parseFloatWithUnits("kM",.001),n=kiwi_decodeURIComponent("hfdl",i[0]).toLowerCase();dbgUs&&console.log("URL freq="+o);var d=0,_=hfdl_menu_match(o,n);if(_.found_menu_match&&i.shift(),i.forEach(function(e,l){var t;if(dbgUs&&console.log("HFDL param2 <"+e+">"),w3_ext_param("help",e).match)extint_help_click();else if(w3_ext_param("map",e).match)hfdl.show=hfdl.MAP;else if(w3_ext_param("split",e).match)hfdl.show=hfdl.SPLIT;else if((t=w3_ext_param("display",e)).match){if(isNumber(t.num))hfdl_display_cb("id-hfdl.dsp",w3_clamp(t.num,0,hfdl.dsp_s.length-1,0))}else(t=w3_ext_param("log_time",e)).match?isNumber(t.num)&&hfdl_log_mins_cb("id-hfdl.log_mins",t.num):(t=w3_ext_param("gs",e)).match?isNumber(t.num)&&0==t.num&&hfdl_gs_visible_cb("id-hfdl.gs_visible",!1):w3_ext_param("test",e).match?d=1:console.log('HFDL: unknown URL param "'+e+'"')}),_.found_menu_match){var s=_.match_entry.split(" ")[0];if(s.length>2){var a=hfdl_freq_2_band(s),f=hfdl_menu_match(a,a.toString());console.log("BAND b="+a+" "+dq(f.match_menu)+" "+dq(f.match_val)),hfdl_pre_select_cb(f.match_menu,f.match_val,!1)}hfdl_pre_select_cb(_.match_menu,_.match_val,!1)}}setTimeout(function(){hfdl_show_cb("id-hfdl.show",hfdl.show)},1e3),d&&hfdl_test_cb("",1),dbgUs&&console.log(hfdl.stations)}}function hfdl_render_menus(){var e,l=[];for(e=0;e<hfdl.bf.length;e++)l[e]=[];var t=function(t){var i=parseInt(t);for(e=0;e<hfdl.bf.length;e++)if(i<1e3*(hfdl.bf[e]+1)){l[e].push(t);break}},i=function(e,l,i,o){var n=kiwi_deep_copy(i);hfdl.menu_n++,hfdl["menu"+l]=-1,hfdl.menus[l]=n,hfdl.menu_s[l]=o;var d=[];w3_obj_enum(n,function(e,i,o){var n=o.name.split(", ")[1];o.frequencies.sort(function(e,l){return parseInt(e)-parseInt(l)});var _=[];o.frequencies.forEach(function(e){if(e<hfdl.bf.length){var i=[n,"w3-bold w3-text-blue"];_.push(i)}else _.push(e);0==l&&0!=e&&t(e+" "+n)}),0==l?d[n]=_:d.push(_)});var _=w3_select_hier(hfdl.sfmt,o,"select","hfdl.menu"+l,-1,d,"hfdl_pre_select_cb"),s=w3_create_appendElement(e,"div",_);w3_add(s,"id-"+o)},o=w3_el("id-hfdl-menus");o.innerHTML="",hfdl.menu_n=0,w3_obj_enum(hfdl.stations,function(e,l,t){"stations"==e&&i(o,0,t,"Stations")});var n=[];for(e=0;e<hfdl.bf.length;e++){l[e].sort(function(e,l){return parseInt(l)-parseInt(e)});var d={};d.name="x, "+hfdl.bf[e]+" MHz",d.frequencies=[e],l[e].forEach(function(e){d.frequencies.push(e)}),n[e.toString()]=d}i(o,1,n,"Bands")}function hfdl_format_cb(e,l,t){t||(hfdl.format_m=+l,w3_set_value(e,+l),hfdl_render_menus())}function hfdl_msg(e,l){var t=w3_el("id-hfdl-msg");w3_remove_then_add(t,hfdl.msg_last_color,e),hfdl.msg_last_color=e,t.innerHTML="<b>"+l+"</b>"}function hfdl_clear_menus(e){for(var l=0;l<hfdl.menu_n;l++)isArg(e)&&l==e||w3_select_value("hfdl.menu"+l,-1)}function hfdl_np_pre_select_cb(e,l,t){hfdl_pre_select_cb(e,l,t)}function hfdl_pre_select_cb(e,l,t){if(!t){l=+l,dbgUs&&console.log("hfdl_pre_select_cb path="+e+" val="+l);var i=parseInt(e.split("hfdl.menu")[1]);dbgUs&&console.log("hfdl_pre_select_cb path="+e+" val="+l+" menu_n="+i);var o="",n=0,d=!1;w3_select_enum(e,function(t){if(!d){dbgUs&&console.log("hfdl_pre_select_cb menu_n="+i+" opt.val="+t.value+" opt.disabled="+t.disabled+" opt.inner="+t.innerHTML+" opt.id="+t.id);var _=0==i&&t.disabled&&-1!=t.value,s=1==i&&t.id&&0==t.id.split("-")[2];if(dbgUs&&console.log("menu0_hdr="+_+" menu1_hdr="+s),_||s?(o=n?o+" "+t.innerHTML:t.innerHTML,n=1):n=0,t.value==l){d=!0,hfdl.cur_menu=i,hfdl.cur_header=o,hfdl.menu_sel=t.innerHTML+" ",dbgUs&&console.log("hfdl_pre_select_cb opt.val="+t.value+" menu_sel="+hfdl.menu_sel+" opt.id="+t.id);var a=t.id.split("id-")[1];if(isUndefined(a))return console.log("hfdl_pre_select_cb: option.id isUndefined"),console.log("hfdl_pre_select_cb opt.val="+t.value+" opt.disabled="+t.disabled+" opt.inner="+t.innerHTML),void console.log(t);var f=(a=a.split("-"))[0],h=a[1];dbgUs&&console.log("hfdl_pre_select_cb i="+f+" j="+h);var r=w3_obj_seq_el(hfdl.menus[i],f);dbgUs&&w3_console.log(r,"o1"),o2=w3_obj_seq_el(r.frequencies,h),dbgUs&&w3_console.log(o2,"o2");var c=null,u=0;if(o2=parseInt(o2),isNumber(o2))if(dbgUs&&console.log(o2),o2<hfdl.bf.length){var m=hfdl.bf_z[o2],g=hfdl.bf_cf[o2];zoom_level==m&&zoom_step(ext_zoom.OUT),ext_tune(g,"iq",ext_zoom.ABS,m),dx.db==dx.DB_EiBi&&dx_is_single_type(dx.DX_HFDL)||(dx_set_type(dx.DX_HFDL),dx_database_cb("",dx.DB_EiBi)),u=1}else hfdl_tune(o2),c=(+o2).toFixedNZ(1)+" kHz",u=1;u&&hfdl_msg("w3-text-css-yellow",hfdl.menu_s[i]+", "+hfdl.cur_header+(c?": "+c:"")),w3_select_value(e,l)}}}),hfdl_clear_menus(i)}}function hfdl_tune(e){dbgUs&&console.log("hfdl_tune tx f="+e.toFixed(2)),hfdl.freq=e,ext_tune(e,"iq",ext_zoom.CUR),ext_set_passband(hfdl.pb.lo,hfdl.pb.hi),ext_send("SET display_freq="+e.toFixed(2))}function hfdl_clear_button_cb(e,l,t){t||(hfdl.console_status_msg_p.s=encodeURIComponent("\f"),kiwi_output_msg("id-hfdl-console-msgs","id-hfdl-console-msg",hfdl.console_status_msg_p),hfdl.log_txt="",hfdl_test_cb("",0))}function hfdl_show_cb(e,l,t){if(!t){l=+l,hfdl.show=l,w3_set_value(e,l),w3_hide2("id-hfdl-msgs",l==hfdl.MAP),w3_hide2("id-hfdl-map",l==hfdl.MSGS);w3_el("id-hfdl-msgs").style.top=px(l==hfdl.SPLIT?hfdl.dataH-150:0),w3_el("id-hfdl-msgs").style.height=px(l==hfdl.SPLIT?150:hfdl.dataH),l==hfdl.SPLIT&&w3_scrollDown("id-hfdl-console-msg")}}function hfdl_display_cb(e,l,t){t||(l=+l,hfdl.dsp=l,w3_set_value(e,l))}function hfdl_test_cb(e,l,t){if(!t){l=+l,dbgUs&&console.log("hfdl_test_cb: val="+l),hfdl.testing=l,w3_el("id-hfdl-bar").style.width="0%",w3_show_hide("id-hfdl-bar-container",hfdl.testing);var i=-(+ext_get_freq_kHz()).toFixed(2);dbgUs&&console.log("hfdl_test_cb="+(l?i:0)),ext_send("SET test="+(l?i:0))}}function hfdl_log_mins_cb(e,l){hfdl.log_mins=w3_clamp(+l,0,1440,0),console.log("hfdl_log_mins_cb path="+e+" val="+l+" log_mins="+hfdl.log_mins),w3_set_value(e,hfdl.log_mins),kiwi_clearInterval(hfdl.log_interval),hfdl.log_mins&&(hfdl.log_interval=setInterval(function(){hfdl_log_cb()},6e4*hfdl.log_mins))}function hfdl_log_cb(){var e=kiwi_host()+"_"+(new Date).toISOString().replace(/:/g,"_").replace(/\.[0-9]+Z$/,"Z")+"_"+w3_el("id-freq-input").value+"_"+cur_mode,l=new Blob([hfdl.log_txt],{type:"text/plain"}),t=document.createElement("a");t.style="display: none",t.href=window.URL.createObjectURL(l),t.download="HFDL."+e+".log.txt",document.body.appendChild(t),console.log("hfdl_log: "+t.download),t.click(),window.URL.revokeObjectURL(t.href),document.body.removeChild(t)}function HFDL_environment_changed(e){if(e.freq||e.mode){var l=(+ext_get_freq_kHz()).toFixed(0),t=(+hfdl.freq).toFixed(0),i=ext_get_mode();if("iq"!=i)hfdl_clear_menus();else if(t!=l&&"iq"==i){var o=hfdl_menu_match(+l,l);o.found_menu_match&&hfdl_pre_select_cb(o.match_menu,o.match_val,!1)}}if(e.resize){var n=w3_el("id-hfdl-data");if(!n)return;var d=Math.max(0,(window.innerWidth-hfdl.dataW-time_display_width())/2);n.style.left=px(d)}else;}function HFDL_blur(){ext_set_mode(hfdl.saved_mode),ext_agc_delay(hfdl.save_agc_delay)}function HFDL_help(e){if(e){var l=w3_text("w3-medium w3-bold w3-text-aqua","HFDL decoder help")+w3_div("w3-margin-T-8 w3-scroll-y|height:90%",w3_div("w3-margin-R-8",'Periodic downloading of the HFDL message log to a file can be specified via the <i>log min</i> value. Adjust your browser settings so these files are downloaded and saved automatically without causing a browser popup window for each download.<br><br>URL parameters: <br><i>(menu match)</i> &nbsp; map|split &nbsp; display:[012] &nbsp; log_time:<i>mins</i> &nbsp; gs:0 &nbsp; test<br><br>The first URL parameter can be a frequency entry from the "Bands" menu (e.g. "8977") or the numeric part of the blue "full band" entry (e.g. "5" part of "5 MHz" entry). <br><i>map</i> will initially show the map instead of the message panel. <i>split</i> will show both. <br>[012] refers to the order of selections in the corresponding menu. <br><i>gs:0</i> initially disables display of the ground stations.<br><br>Keywords are case-insensitive and can be abbreviated. So for example these are valid: <br><i>ext=hfdl,8977</i> &nbsp;&nbsp; <i>ext=hfdl,8977,d:1</i> &nbsp;&nbsp; <i>ext=hfdl,8977,l:10</i> &nbsp;&nbsp; <i>ext=hfdl,5,map</i><br>'));confirmation_show_content(l,610,300),w3_el("id-confirmation-container").style.height="100%"}return!0}function HFDL_config_html(){ext_config_html(hfdl,"hfdl","HFDL","HFDL configuration")}


