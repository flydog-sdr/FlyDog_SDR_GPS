

/* web/extensions/FAX/FAX.min.js (web/extensions/FAX/FAX.js = Sat Feb  4 13:38:30 2023) */
var fax={ext_name:"FAX",first_time:!0,stop_start_state:0,url_params:null,winH:400,winSBW:15,freqs:null,menu_s:[],menus:[],sfmt:"w3-text-red w3-ext-retain-input-focus",phasing:!0,autostop:!1,debug:0,contrast:1,file:0,ch:0,data_canvas:0,copy_canvas:0,freq:0,pbL:1300,black:1500,cf:1900,white:2300,pbH:2500,lpm:120,lpm_i:3,lpm_s:[60,90,100,120,180,240],last_last:0};function FAX_main(){ext_switch_to_client(fax.ext_name,fax.first_time,fax_recv),fax.first_time||fax_controls_setup(),fax.first_time=!1}var fax_tw,fax_scope_colors=["black","red"],fax_image_y=0,fax_w=1024,fax_h=2048,fax_startx=150,fax_mkr=0;function fax_clear_display(){var a=fax.data_canvas.ctx;a.fillStyle="black",a.fillRect(0,0,fax_startx,fax_h),a.fillStyle="lightCyan",a.fillRect(fax_startx,0,fax_w,fax_h),fax_image_y=0}var fax_disabled,fax_prev_disabled,fax_cmd={CLEAR:255,DRAW:254};function fax_recv(a){var t=fax.data_canvas,e=t.ctx;if("DAT"!=arrayBufferToStringLen(a,3))for(var _=arrayBufferToString(a).substring(4).split(" "),i=0;i<_.length;i++){var f=_[i].split("=");switch(0,f[0]){case"ready":fax_controls_setup(),fax.ch=parseInt(f[1]);break;case"fax_download_avail":var s=kiwi_url_origin()+"/kiwi.data/fax.ch"+fax.ch+"_"+f[1],n=s+".gif",s=s+".thumb.gif";w3_remove_then_add("id-fax-file-icon","fa-refresh fa-spin w3-text-aqua","fa-repeat w3-text-pink"),w3_el("id-fax-file-status").innerHTML=w3_link("",n,"<img src="+dq(s)+" />");break;case"fax_sps_changed":fax_mkr&&((e=t.ctx).fillStyle="red",e.fillRect(fax_startx-fax_mkr,fax_image_y-1,fax_mkr,1));break;case"fax_record_line":var x=w3_el("id-fax-line");x&&(x.innerHTML=f[1]);break;case"fax_phased":w3_visible("id-fax-phased",!0),setTimeout(function(){w3_visible("id-fax-phased",!1)},5e3);break;case"fax_autostopped":x=1==f[1];w3_button_text("id-fax-stop-start",x?"Start":"Stop"),w3_visible("id-fax-stopped",x),fax.stop_start_state^=1;break;default:console.log("fax_recv: UNKNOWN CMD "+f[0])}}else{var l=new Uint8Array(a,4),o=l[0];if(o==fax_cmd.CLEAR)fax_clear_display();else if(o==fax_cmd.DRAW){for(var r=t.imd,i=0;i<fax_w;i++)r.data[4*i+0]=l[i+1],r.data[4*i+1]=l[i+1],r.data[4*i+2]=l[i+1],r.data[4*i+3]=255;var c=w3_el("id-fax-data").scrollTop,a=c+fax.winH;c<=fax_image_y&&fax_image_y<=a&&a<=fax_image_y&&(w3_el("id-fax-data").scrollTop=fax_image_y+1-fax.winH),fax_image_y<fax_h?fax_image_y++:(c=fax_w+fax_mkr,a=fax_startx-fax_mkr,e.drawImage(t,a,1,c,fax_h-1,a,0,c,fax_h-1),fax_mkr&&(e.fillStyle="black",e.fillRect(fax_startx-fax_mkr,fax_image_y-1,fax_mkr,1))),e.putImageData(r,fax_startx,fax_image_y-1)}else{e.fillStyle=fax_scope_colors[o];for(i=0;i<fax_w;i++)e.fillRect(fax_startx+i,l[i+1],1,1)}}}function fax_controls_setup(){kiwi_isMobile()&&(fax_startx=0),fax_tw=fax_startx+fax_w+fax.winSBW,fax.debug=0;var a=fax.url_params=ext_param();a&&(a=a.split(",")).forEach(function(a,t){console.log("FAX param1 <"+a+">");var e=(e=a.split(":"))[e.length-1].toLowerCase();(e=w3_ext_param("lpm",a)).match?w3_ext_param_array_match_num(fax.lpm_s,e.num,function(a,t){fax.lpm_i=a,fax.lpm=t}):(e=w3_ext_param("align",a)).match?fax.phasing=0==e.num?0:1:(e=w3_ext_param("stop",a)).match?fax.autostop=0==e.num?0:1:(e=w3_ext_param("debug",a)).match&&(fax.debug=0==e.num?0:1)});var t=time_display_html("fax")+w3_div("id-fax-data|left:0; width:"+px(fax_tw)+"; height:"+px(fax.winH)+"; background-color:black; position:relative; overflow-y:scroll; overflow-x:hidden",'<canvas id="id-fax-data-canvas" width='+dq(fax_tw)+' style="left:'+px(0)+'; position:absolute;"></canvas>','<canvas id="id-fax-copy-canvas" width='+dq(fax_tw)+' style="left:'+px(0)+'; position:absolute;z-index:-1;"></canvas>'),e=w3_div("id-fax-controls w3-text-white",w3_divs("/w3-tspace-8",w3_col_percent("",w3_div("w3-medium w3-text-aqua","<b>HF FAX decoder</b>"),30,w3_div("id-fax-station w3-text-css-yellow"),60,w3_div(),10),w3_inline("id-fax-menus/"),w3_inline("/w3-margin-between-16",w3_select(fax.sfmt,"","LPM","fax.lpm_i",fax.lpm_i,fax.lpm_s,"fax_lpm_cb"),w3_button("w3-padding-smaller","Next","w3_select_next_prev_cb",{dir:w3_MENU_NEXT,id:"fax.menu",func:"fax_pre_select_cb"}),w3_button("w3-padding-smaller","Prev","w3_select_next_prev_cb",{dir:w3_MENU_PREV,id:"fax.menu",func:"fax_pre_select_cb"}),w3_button("id-fax-stop-start w3-padding-smaller","Stop","fax_stop_start_cb"),w3_button("w3-padding-smaller","Clear","fax_clear_cb"),w3_inline("",w3_div("",w3_div('fa-stack||title="record"',w3_icon("id-fax-file-icon","fa-repeat fa-stack-1x w3-text-pink",22,"","fax_file_cb"))),w3_div("id-fax-file-status w3-margin-left"))),w3_inline("",w3_checkbox("w3-label-inline w3-label-not-bold/","auto align","fax.phasing",fax.phasing,"fax_phasing_cb"),w3_div("id-fax-phased w3-margin-left w3-padding-small w3-text-black w3-css-lime w3-hidden","aligned"),w3_checkbox("w3-margin-left/w3-label-inline w3-label-not-bold/","auto stop","fax.autostop",fax.autostop,"fax_autostop_cb"),w3_div("id-fax-stopped w3-margin-left w3-padding-small w3-text-black w3-css-orange w3-hidden","stopped")),w3_div("",w3_inline("w3-halign-space-between/",w3_link("","https://www.weather.gov/media/marine/rfax.pdf","FAX transmission schedules")),w3_div("","Shift-click (PC) or touch (mobile) the image to align."))));ext_panel_show(e,t,null),time_display_setup("fax"),fax.url_params&&(a=fax.url_params.split(",")).forEach(function(a,t){w3_ext_param("help",a).match&&extint_help_click()}),fax.data_canvas=w3_el("id-fax-data-canvas"),fax.copy_canvas=w3_el("id-fax-copy-canvas"),fax.data_canvas.ctx=fax.data_canvas.getContext("2d"),fax.copy_canvas.ctx=fax.copy_canvas.getContext("2d"),fax.data_canvas.imd=fax.data_canvas.ctx.createImageData(fax_w,1),fax.data_canvas.addEventListener("mousedown",fax_mousedown,!1),kiwi_isMobile()&&fax.data_canvas.addEventListener("touchstart",fax_touchstart,!1),fax.data_canvas.height=fax_h.toString(),fax.copy_canvas.height=fax_h.toString(),ext_set_data_height(fax.winH),w3_scrollTop("id-fax-data"),fax_clear_display(),w3_attribute(fax.data_canvas,"title","shift-click/touch to align horizontally"),ext_set_controls_width_height(550,200),fax.saved_mode=ext_get_mode(),ext_set_mode("usb"),w3_do_when_rendered("id-fax-menus",function(){fax.ext_url=kiwi_SSL()+"files.kiwisdr.com/fax/FAX_freq_menus.cjson",fax.int_url=kiwi_url_origin()+"/extensions/FAX/FAX_freq_menus.cjson",fax.using_default=!1,fax.double_fault=!1,kiwi_ajax(fax.ext_url,"fax_get_menus_cb",0,1e4)}),fax_start_stop(1)}function fax_get_menus_cb(a){fax.freqs=a,ext_get_menus_cb(fax,a,"fax_get_menus_cb",function(a){ext_render_menus(fax,"fax");var t=!1;if(fax.url_params){var e=parseFloat(fax.url_params);if(!isNaN(e))for(var _=0;_<fax.n_menu;_++){var i="fax.menu"+_;if(w3_select_enum(i,function(a){t||parseFloat(a.innerHTML)!=e||(fax_pre_select_cb(i,a.value,!1),t=!0)}),t)break}}t||ext_set_passband(fax.pbL,fax.pbH)},null)}function fax_pre_select_cb(i,f,a){a||(f=+f,a=parseInt(i.split("fax.menu")[1]),w3_select_enum(i,function(a){var t,e,_;a.disabled&&(fax_prev_disabled=fax_disabled,fax_disabled=a),a.value!=f||a.disabled||(t=a.innerHTML,console.log("fax_pre_select_cb opt.val="+a.value+" opt.inner="+t),e=t.includes("lsb"),a=parseFloat(t),ext_tune(a+(e?1.9:-1.9),e?"lsb":"usb",ext_zoom.ABS,11),a=e?-fax.pbH:fax.pbL,e=e?-fax.pbL:fax.pbH,ext_set_passband(a,e),fax.freq=ext_get_freq()/1e3,w3_el("id-fax-station").innerHTML="<b>Station: "+fax_prev_disabled.innerHTML+", "+fax_disabled.innerHTML+"</b>",e=120,fax_lpm(e=1<(t=t.split("/")).length&&!isNaN(_=parseInt(t[1]))?_:e),w3_select_set_if_includes("fax.lpm_i","\\b"+e+"\\b"),w3_select_value(i,f))}),fax_clear_menus(a))}function fax_clear_menus(a){for(var t=0;t<fax.n_menu;t++)isArg(a)&&t==a||w3_select_value("fax.menu"+t,-1)}function FAX_environment_changed(a){var t;(a.freq||a.mode)&&(t=ext_get_freq()/1e3,a=ext_get_mode().substr(0,2),(fax.freq!=t||"us"!=a&&"ls"!=a)&&(fax_clear_menus(),w3_el("id-fax-station").innerHTML="&nbsp;"))}function fax_mousedown(a){fax_shift(a,!0)}function fax_touchstart(a){fax_shift(a,!1)}function fax_shift(a,t){var e,_,i,f,s,n=a.clientX||a.offsetX||a.layerX,x=fax_startx;t&&!a.shiftKey||n<x||x+fax_w<=n||(e=((n-=x)/fax_w).toFixed(6),console.log("FAX offset="+n+" shift="+e),_=fax.data_canvas,i=fax.copy_canvas,f=_.ctx,s=i.ctx,t=fax_h,n=fax_w-(a=n),s.drawImage(_,x+a,0,n,t,x,0,n,t),f.drawImage(_,x,0,a,t,x+n,0,a,t),f.drawImage(i,x,0,n,t,x,0,n,t),ext_send("SET fax_shift="+e))}function fax_start_stop(a){a?ext_send("SET fax_start lpm="+fax.lpm+" phasing="+(fax.phasing?1:0)+" autostop="+(fax.autostop?1:0)+" debug="+(fax.debug?1:0)):ext_send("SET fax_stop")}function fax_stop_start_cb(a,t,e){fax_start_stop(fax.stop_start_state),fax.stop_start_state^=1,w3_button_text(a,fax.stop_start_state?"Start":"Stop"),w3_visible("id-fax-stopped",!1)}function fax_phasing_cb(a,t,e){e||(fax.phasing=t,fax.stop_start_state||(fax_start_stop(0),fax_start_stop(1)))}function fax_autostop_cb(a,t,e){e||(fax.autostop=t,fax.stop_start_state||(fax_start_stop(0),fax_start_stop(1)))}function fax_lpm(a){console.log("fax_lpm lpm="+a+" fax.lpm="+fax.lpm),isNaN(a)||fax.lpm!=a&&(fax.lpm=a,fax.stop_start_state||(fax_start_stop(0),fax_start_stop(1)))}function fax_lpm_cb(a,t,e){e||(t=+t,lpm=fax.lpm_s[t],fax_lpm(lpm))}function fax_clear_cb(){fax_clear_display(),fax.file||(w3_remove_then_add("id-fax-file-icon","fa-repeat fa-refresh fa-spin w3-text-aqua","fa-repeat  w3-text-pink"),w3_el("id-fax-file-status").innerHTML="")}function fax_file_cb(a,t,e){e||(fax.file^=1,e=w3_el("id-fax-file-icon"),fax.file?(ext_send("SET fax_file_open"),w3_spin(e),w3_el("id-fax-file-status").innerHTML=w3_div("w3-show-inline-block","recording<br>line "+w3_div("id-fax-line w3-show-inline-block"))):(ext_send("SET fax_file_close"),w3_remove_then_add(e,"fa-repeat w3-text-pink","fa-refresh fa-spin w3-text-aqua"),w3_el("id-fax-file-status").innerHTML="processing"))}function FAX_blur(){ext_send("SET fax_stop"),ext_send("SET fax_close"),ext_set_data_height(),ext_set_mode(fax.saved_mode)}function FAX_config_html(){ext_config_html(fax,"fax","FAX","FAX configuration")}function FAX_help(a){return a&&(a=w3_text("w3-medium w3-bold w3-text-aqua","FAX decoder help")+'<br>When "auto align" is checked the phasing information sent at the beginning of most <br>FAXes is used to horizontally align the image. This may not work if the signal is not strong.<br><br>When "auto stop" is checked the start and stop tones sent at the beginning and end of most <br>FAXes is used to stop the window scrolling. This may not work if the signal is not strong.<br><br>Most stations use an LPM (lines per minute) value of 120. The exception is JJC/JSC which <br>mostly uses 60. <br><br>You can manually align the image by shift-clicking (touch on mobile devices) at the location <br>you want moved to the left edge. <br><br>URL parameters: <br>First parameter can be a frequency matching an entry in station menus. <br>align<i>[:0|1]</i> &nbsp; stop<i>[:0|1]</i> &nbsp; lpm:<i>value</i> <br>So for example this is valid: <i>ext=fax,3855,auto,stop</i> <br>',confirmation_show_content(a,620,325)),!0}



