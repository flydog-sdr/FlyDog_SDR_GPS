

/* web/extensions/CW_decoder/CW_decoder.min.js (web/extensions/CW_decoder/CW_decoder.js = Fri May 27 09:15:52 2022) */
var cw={ext_name:"CW_decoder",first_time:!0,pboff:-1,wspace:!0,thresh:!1,threshold:49,console_status_msg_p:{scroll_only_at_bottom:!0,process_return_alone:!1,remove_returns:!0,ncol:135},log_mins:0,log_interval:null,log_txt:"",last_last:0};function CW_decoder_main(){ext_switch_to_client(cw.ext_name,cw.first_time,cw_decoder_recv),cw.first_time||cw_decoder_controls_setup(),cw.first_time=!1}function cw_decoder_recv(e){if("DAT"!=arrayBufferToStringLen(e,3))for(var o=arrayBufferToString(e).substring(4).split(" "),c=0;c<o.length;c++){var t=o[c].split("=");switch(t[0]){case"ready":kiwi_load_js(["pkgs/js/graph.js"],"cw_decoder_controls_setup");break;case"cw_chars":cw_decoder_output_chars(t[1]);break;case"cw_wpm":w3_innerHTML("id-cw-wpm",t[1]+" WPM");break;case"cw_train":var _=w3_el("id-cw-train");if(!_)break;var n=+t[1];n<0?w3_innerHTML(_,"error "+-n+"/4"):w3_innerHTML(_,"train "+n+"/98"),w3_background_color(_,n<0?"orange":"lime"),w3_show_hide(_,n);break;case"cw_plot":graph_plot(cw.gr,+t[1]);break;default:console.log("cw_decoder_recv: UNKNOWN CMD "+t[0])}}else{var r=new Uint8Array(e,4),w=r[0],s=r.length-1;console.log("cw_decoder_recv: DATA UNKNOWN cmd="+w+" len="+s)}}function cw_decoder_output_chars(e){cw.console_status_msg_p.s=e,cw.log_txt+=kiwi_remove_escape_sequences(kiwi_decodeURIComponent("CW",e)),kiwi_output_msg("id-cw-console-msgs","id-cw-console-msg",cw.console_status_msg_p)}function cw_decoder_controls_setup(){var e=time_display_html("cw")+w3_div("id-cw-data|left:150px; width:1044px; height:300px; overflow:hidden; position:relative; background-color:mediumBlue;",'<canvas id="id-cw-canvas" width="1024" height="180" style="position:absolute; padding: 10px"></canvas>',w3_div("id-cw-console-msg w3-text-output w3-scroll-down w3-small w3-text-black|top:200px; width:1024px; height:100px; position:absolute; overflow-x:hidden;",'<pre><code id="id-cw-console-msgs"></code></pre>')),o=w3_div("id-cw-controls w3-text-white",w3_divs("/w3-tspace-8",w3_col_percent("",w3_div("w3-medium w3-text-aqua","<b>CW decoder</b>"),30,w3_div("",'From Loftur Jonasson, TF3LJ / VE2LJX <br> and the <b><a href="https://github.com/df8oe/UHSDR" target="_blank">UHSDR project</a></b> &copy; 2016'),55),w3_inline("/w3-margin-between-16",w3_button("w3-padding-smaller","Clear","cw_clear_button_cb",0),w3_div("id-cw-wpm","0 WPM"),w3_checkbox("w3-label-inline w3-label-not-bold","word space<br>correction","cw.wspace",!0,"cw_decoder_wsc_cb"),w3_input("id-cw-threshold/w3-label-not-bold/|padding:0;width:auto|size=4","threshold","cw.threshold",cw.threshold,"cw_decoder_threshold_cb"),w3_button("w3-padding-smaller","Reset","cw_reset_cb",0),w3_div("id-cw-train w3-padding-small w3-text-black w3-hide","train"),w3_button("id-cw-log w3-padding-smaller w3-purple","Log","cw_log_cb"),w3_input("id-cw-log-mins/w3-label-not-bold/w3-ext-retain-input-focus|padding:0;width:auto|size=4","log min","cw.log_mins",cw.log_mins,"cw_log_mins_cb"))));ext_panel_show(o,e,null),time_display_setup("cw"),cw.canvas=w3_el("id-cw-canvas"),cw.canvas.ctx=cw.canvas.getContext("2d"),cw.gr=graph_init(cw.canvas,{dBm:0,speed:1,averaging:!0}),graph_mode(cw.gr,"fixed",45,35),graph_clear(cw.gr),cw_decoder_threshold_cb("cw.threshold",cw.threshold),ext_set_data_height(300),ext_set_controls_width_height(550,100);var c=ext_param();cw.pboff_locked=parseFloat(c),console.log("CW pboff_locked="+cw.pboff_locked),cw_clear_button_cb(),ext_send("SET cw_start"),cw.pboff=-1,CW_decoder_environment_changed()}function CW_decoder_environment_changed(e){var o=Math.abs(ext_get_passband_center_freq()-ext_get_carrier_freq());if(cw.pboff!=o){var c=-1==cw.pboff&&cw.pboff_locked,t=c?cw.pboff_locked:o;!c&&cw.pboff_locked||(console.log("CW ENV new pbo="+t),ext_send("SET cw_pboff="+t)),cw.pboff=o}}function cw_clear_button_cb(e,o,c){c||(cw.console_status_msg_p.s=encodeURIComponent("\f"),kiwi_output_msg("id-cw-console-msgs","id-cw-console-msg",cw.console_status_msg_p),cw.log_txt="")}function cw_log_mins_cb(e,o){cw.log_mins=w3_clamp(+o,0,1440,0),console.log("cw_log_mins_cb path="+e+" val="+o+" log_mins="+cw.log_mins),w3_set_value(e,cw.log_mins),kiwi_clearInterval(cw.log_interval),0!=cw.log_mins&&(console.log("CW logging.."),cw.log_interval=setInterval(function(){cw_log_cb()},6e4*cw.log_mins))}function cw_log_cb(){var e=kiwi_host()+"_"+(new Date).toISOString().replace(/:/g,"_").replace(/\.[0-9]+Z$/,"Z")+"_"+w3_el("id-freq-input").value+"_"+cur_mode,o=new Blob([cw.log_txt],{type:"text/plain"}),c=document.createElement("a");c.style="display: none",c.href=window.URL.createObjectURL(o),c.download="CW."+e+".log.txt",document.body.appendChild(c),console.log("cw_log: "+c.download),c.click(),window.URL.revokeObjectURL(c.href),document.body.removeChild(c)}function cw_decoder_wsc_cb(e,o,c){c||ext_send("SET cw_wsc="+(o?1:0))}function cw_decoder_thresh_cb(e,o,c){c||ext_send("SET cw_thresh="+(o?1:0))}function cw_decoder_threshold_cb(e,o){var c=parseFloat(o);c&&!isNaN(c)&&(console.log("cw_decoder_threshold_cb path="+e+" val="+o+" threshold_dB="+c),w3_num_cb(e,c),cw.threshold=c,graph_threshold(cw.gr,cw.threshold),ext_send("SET cw_threshold="+Math.pow(10,cw.threshold/10).toFixed(0)))}function cw_reset_cb(e,o,c){c||(ext_send("SET cw_reset"),cw.pboff=-1,CW_decoder_environment_changed())}function CW_decoder_blur(){ext_set_data_height(),ext_send("SET cw_stop"),kiwi_clearInterval(cw.log_interval)}function CW_decoder_config_html(){ext_config_html(cw,"cw","CW","CW decoder configuration")}function CW_decoder_help(e){if(e){var o=w3_text("w3-medium w3-bold w3-text-aqua","CW decoder help")+"<br>Use the CWN mode with its narrow passband to maximize the signal/noise ratio. <br>The decoder doesn't do very well with weak or fading signals. <br><br>Adjust the <i>threshold</i> value so the red line in the signal level display is just under the <br>average value of the signal peaks. <br>The <i>word space correction</i> checkbox sets the algorithm used to determine word spacing. ";confirmation_show_content(o,610,150)}return!0}


