

/* web/extensions/noise_filter/noise_filter.min.js (web/extensions/noise_filter/noise_filter.js = Sun May  8 06:48:49 2022) */
var noise_filter={ext_name:"noise_filter",first_time:!0,algo:0,algo_s:["(none)","wdsp LMS","original LMS","spectral NR"],width:400,height:[100,475,400,185],NR_OFF:0,denoise:0,autonotch:0,NR_DENOISE:0,NR_AUTONOTCH:1,NR_WDSP:1,wdsp_de_taps:64,wdsp_de_delay:16,wdsp_de_gain:10,wdsp_de_leakage:7,wdsp_an_taps:64,wdsp_an_delay:16,wdsp_an_gain:10,wdsp_an_leakage:7,NR_ORIG:2,orig_de_delay:1,orig_de_beta:.05,orig_de_decay:.98,orig_an_delay:48,orig_an_beta:.125,orig_an_decay:.99915,NR_SPECTRAL:3,spec_gain:0,spec_alpha:.95,active_snr:30};function noise_filter_main(){ext_switch_to_client(noise_filter.ext_name,noise_filter.first_time,noise_filter_recv),noise_filter.first_time||noise_filter_controls_setup(),noise_filter.first_time=!1}function noise_filter_recv(e){if("DAT"!=arrayBufferToStringLen(e,3))for(var _=arrayBufferToString(e).substring(4).split(" "),i=0;i<_.length;i++){var n=_[i].split("=");switch(n[0]){case"ready":noise_filter_controls_setup();break;default:console.log("noise_filter_recv: UNKNOWN CMD "+n[0])}}else{var s=new Uint8Array(e,4),t=s[0],r=s.length-1;console.log("noise_filter_recv: DATA UNKNOWN cmd="+t+" len="+r)}}function noise_filter_controls_html(){var e="";switch(noise_filter.algo){case noise_filter.NR_WDSP:e=w3_inline("w3-margin-between-16",w3_checkbox("w3-label-inline w3-text-css-orange/","Denoiser","noise_filter.denoise",noise_filter.denoise,"noise_filter_cb"))+w3_div("w3-section",w3_slider("","Taps","noise_filter.wdsp_de_taps",noise_filter.wdsp_de_taps,16,128,1,"nf_wdsp_taps_cb"),w3_slider("","Delay","noise_filter.wdsp_de_delay",noise_filter.wdsp_de_delay,2,128,1,"nf_wdsp_delay_cb"),w3_slider("","Gain","noise_filter.wdsp_de_gain",noise_filter.wdsp_de_gain,1,20,1,"nf_wdsp_gain_cb"),w3_slider("","Leakage","noise_filter.wdsp_de_leakage",noise_filter.wdsp_de_leakage,1,23,1,"nf_wdsp_leakage_cb"))+w3_inline("w3-margin-between-16",w3_checkbox("w3-label-inline w3-text-css-orange/","Autonotch","noise_filter.autonotch",noise_filter.autonotch,"noise_filter_cb"))+w3_div("w3-section",w3_slider("","Taps","noise_filter.wdsp_an_taps",noise_filter.wdsp_an_taps,16,128,1,"nf_wdsp_taps_cb"),w3_slider("","Delay","noise_filter.wdsp_an_delay",noise_filter.wdsp_an_delay,2,128,1,"nf_wdsp_delay_cb"),w3_slider("","Gain","noise_filter.wdsp_an_gain",noise_filter.wdsp_an_gain,1,20,1,"nf_wdsp_gain_cb"),w3_slider("","Leakage","noise_filter.wdsp_an_leakage",noise_filter.wdsp_an_leakage,1,23,1,"nf_wdsp_leakage_cb"));break;case noise_filter.NR_ORIG:e=w3_inline("w3-margin-between-16",w3_checkbox("w3-label-inline w3-text-css-orange/","Denoiser","noise_filter.denoise",noise_filter.denoise,"noise_filter_cb"),w3_button("w3-padding-tiny","SSB #1","noise_filter_de_presets_cb",0),w3_button("w3-padding-tiny","SSB #2","noise_filter_de_presets_cb",1))+w3_div("w3-section",w3_slider("","Delay line","noise_filter.orig_de_delay",noise_filter.orig_de_delay,1,200,1,"noise_filter_delay_cb"),w3_slider("","Beta","noise_filter.orig_de_beta",noise_filter.orig_de_beta,1e-4,.15,1e-4,"noise_filter_beta_cb"),w3_slider("","Decay","noise_filter.orig_de_decay",noise_filter.orig_de_decay,.9,1,1e-4,"noise_filter_decay_cb"))+w3_inline("w3-margin-between-16",w3_checkbox("w3-label-inline w3-text-css-orange/","Autonotch","noise_filter.autonotch",noise_filter.autonotch,"noise_filter_cb"),w3_button("w3-padding-tiny","Voice","noise_filter_an_presets_cb",0),w3_button("w3-padding-tiny","Slow CW","noise_filter_an_presets_cb",1),w3_button("w3-padding-tiny","Fast CW","noise_filter_an_presets_cb",2))+w3_div("w3-section",w3_slider("","Delay line","noise_filter.orig_an_delay",noise_filter.orig_an_delay,1,200,1,"noise_filter_delay_cb"),w3_slider("","Beta","noise_filter.orig_an_beta",noise_filter.orig_an_beta,1e-4,.15,1e-4,"noise_filter_beta_cb"),w3_slider("","Decay","noise_filter.orig_an_decay",noise_filter.orig_an_decay,.9,1,1e-4,"noise_filter_decay_cb"));break;case noise_filter.NR_SPECTRAL:e=w3_div("w3-section",w3_slider("","Gain","noise_filter.spec_gain",noise_filter.spec_gain,-30,30,1,"nf_spectral_gain_cb"),w3_slider("","Alpha","noise_filter.spec_alpha",noise_filter.spec_alpha,.9,.99,.01,"nf_spectral_alpha_cb"),w3_slider("","Active SNR","noise_filter.active_snr",noise_filter.active_snr,2,30,1,"nf_spectral_asnr_cb"))}return ext_is_IQ_or_stereo_curmode()&&(e="No noise filtering in IQ or stereo modes"),w3_div("id-noise-filter-controls w3-text-white",w3_divs("/w3-tspace-8",w3_inline("w3-halign-space-between|width:75%/",w3_div("w3-medium w3-text-aqua","<b>Noise filter: </b>"),w3_div("w3-text-white",noise_filter.algo_s[noise_filter.algo]),w3_button("w3-padding-tiny w3-aqua","Defaults","noise_filter_load_defaults")),w3_div("w3-section",e)))}function noise_filter_controls_setup(){ext_panel_show(noise_filter_controls_html(),null,null),ext_set_controls_width_height(noise_filter.width,noise_filter.height[noise_filter.algo])}function noise_filter_controls_refresh(){ext_panel_displayed("noise_filter")&&(ext_panel_redisplay(noise_filter_controls_html()),ext_set_controls_width_height(noise_filter.width,noise_filter.height[noise_filter.algo]))}function noise_filter_environment_changed(e){if(e.mode){var _=ext_is_IQ_or_stereo_curmode();_!=noise_filter.is_IQ_or_stereo_mode&&(noise_filter_controls_refresh(),noise_filter.is_IQ_or_stereo_mode=_)}}function noise_filter_init(){noise_filter.wdsp_de_taps=+kiwi_storeGet("last_nr_wdspDeTaps",cfg.nr_wdspDeTaps),noise_filter.wdsp_de_delay=+kiwi_storeGet("last_nr_wdspDeDelay",cfg.nr_wdspDeDelay),noise_filter.wdsp_de_gain=+kiwi_storeGet("last_nr_wdspDeGain",cfg.nr_wdspDeGain),noise_filter.wdsp_de_leakage=+kiwi_storeGet("last_nr_wdspDeLeak",cfg.nr_wdspDeLeak),noise_filter.wdsp_an_taps=+kiwi_storeGet("last_nr_wdspAnTaps",cfg.nr_wdspAnTaps),noise_filter.wdsp_an_delay=+kiwi_storeGet("last_nr_wdspAnDelay",cfg.nr_wdspAnDelay),noise_filter.wdsp_an_gain=+kiwi_storeGet("last_nr_wdspAnGain",cfg.nr_wdspAnGain),noise_filter.wdsp_an_leakage=+kiwi_storeGet("last_nr_wdspAnLeak",cfg.nr_wdspAnLeak),noise_filter.orig_de_delay=+kiwi_storeGet("last_nr_origDeDelay",cfg.nr_origDeDelay),noise_filter.orig_de_beta=+kiwi_storeGet("last_nr_origDeBeta",cfg.nr_origDeBeta),noise_filter.orig_de_decay=+kiwi_storeGet("last_nr_origDeDecay",cfg.nr_origDeDecay),noise_filter.orig_an_delay=+kiwi_storeGet("last_nr_origAnDelay",cfg.nr_origAnDelay),noise_filter.orig_an_beta=+kiwi_storeGet("last_nr_origAnBeta",cfg.nr_origAnBeta),noise_filter.orig_an_decay=+kiwi_storeGet("last_nr_origAnDecay",cfg.nr_origAnDecay),noise_filter.spec_gain=+kiwi_storeGet("last_nr_SpecGain",cfg.nr_specGain),noise_filter.spec_alpha=+kiwi_storeGet("last_nr_SpecAlpha",cfg.nr_specAlpha),noise_filter.active_snr=+kiwi_storeGet("last_nr_SpecSNR",cfg.nr_specSNR),noise_filter.denoise=+kiwi_storeGet("last_nr_de",cfg.nr_de),noise_filter.autonotch=+kiwi_storeGet("last_nr_an",cfg.nr_an),noise_filter.algo=+kiwi_storeGet("last_nr_algo",cfg.nr_algo),nr_algo_cb("nr_algo",noise_filter.algo,!1,"i")}function noise_filter_load_defaults(){noise_filter.wdsp_de_taps=cfg.nr_wdspDeTaps,noise_filter.wdsp_de_delay=cfg.nr_wdspDeDelay,noise_filter.wdsp_de_gain=cfg.nr_wdspDeGain,noise_filter.wdsp_de_leakage=cfg.nr_wdspDeLeak,noise_filter.wdsp_an_taps=cfg.nr_wdspAnTaps,noise_filter.wdsp_an_delay=cfg.nr_wdspAnDelay,noise_filter.wdsp_an_gain=cfg.nr_wdspAnGain,noise_filter.wdsp_an_leakage=cfg.nr_wdspAnLeak,noise_filter.orig_de_delay=cfg.nr_origDeDelay,noise_filter.orig_de_beta=cfg.nr_origDeBeta,noise_filter.orig_de_decay=cfg.nr_origDeDecay,noise_filter.orig_an_delay=cfg.nr_origAnDelay,noise_filter.orig_an_beta=cfg.nr_origAnBeta,noise_filter.orig_an_decay=cfg.nr_origAnDecay,noise_filter.spec_gain=cfg.nr_specGain,noise_filter.spec_alpha=cfg.nr_specAlpha,noise_filter.active_snr=cfg.nr_specSNR,noise_filter.denoise=cfg.nr_de,noise_filter.autonotch=cfg.nr_an,noise_filter.algo=cfg.nr_algo,nr_algo_cb("nr_algo",noise_filter.algo,!1,"d")}function noise_filter_save_defaults(){cfg.nr_wdspDeTaps=noise_filter.wdsp_de_taps,cfg.nr_wdspDeDelay=noise_filter.wdsp_de_delay,cfg.nr_wdspDeGain=noise_filter.wdsp_de_gain,cfg.nr_wdspDeLeak=noise_filter.wdsp_de_leakage,cfg.nr_wdspAnTaps=noise_filter.wdsp_an_taps,cfg.nr_wdspAnDelay=noise_filter.wdsp_an_delay,cfg.nr_wdspAnGain=noise_filter.wdsp_an_gain,cfg.nr_wdspAnLeak=noise_filter.wdsp_an_leakage,cfg.nr_origDeDelay=noise_filter.orig_de_delay,cfg.nr_origDeBeta=noise_filter.orig_de_beta,cfg.nr_origDeDecay=noise_filter.orig_de_decay,cfg.nr_origAnDelay=noise_filter.orig_an_delay,cfg.nr_origAnBeta=noise_filter.orig_an_beta,cfg.nr_origAnDecay=noise_filter.orig_an_decay,cfg.nr_specGain=noise_filter.spec_gain,cfg.nr_specAlpha=noise_filter.spec_alpha,cfg.nr_specSNR=noise_filter.active_snr,cfg.nr_de=noise_filter.denoise,cfg.nr_an=noise_filter.autonotch,ext_set_cfg_param("cfg.nr_algo",noise_filter.algo,!0)}function noise_filter_send(e){var _,i,n,s;if(noise_filter.algo!=noise_filter.NR_OFF){noise_filter.algo==noise_filter.NR_WDSP?e==noise_filter.NR_DENOISE?(_=noise_filter.wdsp_de_taps,i=noise_filter.wdsp_de_delay,n=noise_filter.wdsp_de_gain,n=.08192/Math.pow(2,20-n),s=noise_filter.wdsp_de_leakage,s=8192/Math.pow(2,23-s)):e==noise_filter.NR_AUTONOTCH&&(_=noise_filter.wdsp_an_taps,i=noise_filter.wdsp_an_delay,n=noise_filter.wdsp_an_gain,n=.08192/Math.pow(2,20-n),s=noise_filter.wdsp_an_leakage,s=8192/Math.pow(2,23-s)):noise_filter.algo==noise_filter.NR_ORIG?e==noise_filter.NR_DENOISE?(_=noise_filter.orig_de_delay,i=noise_filter.orig_de_beta,n=noise_filter.orig_de_decay,s=0):e==noise_filter.NR_AUTONOTCH&&(_=noise_filter.orig_an_delay,i=noise_filter.orig_an_beta,n=noise_filter.orig_an_decay,s=0):noise_filter.algo==noise_filter.NR_SPECTRAL&&(_=Math.pow(10,noise_filter.spec_gain/20),i=noise_filter.spec_alpha,n=Math.pow(10,noise_filter.active_snr/10),s=0),snd_send("SET nr type="+e+" param=0 pval="+_),snd_send("SET nr type="+e+" param=1 pval="+i),snd_send("SET nr type="+e+" param=2 pval="+n),snd_send("SET nr type="+e+" param=3 pval="+s);var t=e==noise_filter.NR_DENOISE?noise_filter.denoise:noise_filter.autonotch;snd_send("SET nr type="+e+" en="+t)}}function nr_algo_cb(e,_,i,n){i||(_=+_,w3_select_value(e,_),noise_filter.algo=_,kiwi_storeSet("last_nr_algo",_.toString()),"m"!=n||noise_filter.denoise||noise_filter.autonotch||noise_filter.algo!=noise_filter.NR_ORIG&&noise_filter.algo!=noise_filter.NR_WDSP||(noise_filter.denoise=1),snd_send("SET nr algo="+noise_filter.algo),noise_filter_send(noise_filter.NR_DENOISE),noise_filter_send(noise_filter.NR_AUTONOTCH),noise_filter_controls_refresh())}function noise_filter_cb(e,_,i){_=_?1:0,console.log("noise_filter_cb "+_+" path="+e),setVarFromString(e,_),w3_checkbox_set(e,_),e.includes("denoise")?(noise_filter.denoise=_,noise_filter_send(noise_filter.NR_DENOISE),kiwi_storeSet("last_nr_de",noise_filter.denoise.toString())):(noise_filter.autonotch=_,noise_filter_send(noise_filter.NR_AUTONOTCH),kiwi_storeSet("last_nr_an",noise_filter.autonotch.toString()))}function nf_wdsp_taps_cb(e,_,i,n){var s=e.includes("de_")?0:1,t=s?noise_filter.wdsp_an_delay:noise_filter.wdsp_de_delay;((_=+_)<t&&(_=t),w3_num_cb(e,_),w3_set_label("Taps: "+_,e),i)&&(snd_send("SET nr type="+s+" param=0 pval="+_),kiwi_storeSet("last_nr_wdsp"+["De","An"][s]+"Taps",_.toString()))}function nf_wdsp_delay_cb(e,_,i,n){var s=e.includes("de_")?0:1,t=s?noise_filter.wdsp_an_taps:noise_filter.wdsp_de_taps;((_=+_)>t&&(_=t),w3_num_cb(e,_),w3_set_label("Delay: "+_,e),i)&&(snd_send("SET nr type="+s+" param=1 pval="+_),kiwi_storeSet("last_nr_wdsp"+["De","An"][s]+"Delay",_.toString()))}function nf_wdsp_gain_cb(e,_,i,n){_=+_,w3_num_cb(e,_);var s=.08192/Math.pow(2,20-_);w3_set_label("Gain: "+s.toExponential(2),e);var t=e.includes("de_")?0:1;i&&(console.log(e+" gain="+s),snd_send("SET nr type="+t+" param=2 pval="+s),kiwi_storeSet("last_nr_wdsp"+["De","An"][t]+"Gain",_.toString()))}function nf_wdsp_leakage_cb(e,_,i,n){_=+_,w3_num_cb(e,_);var s=8192/Math.pow(2,23-_);w3_set_label("Leakage: "+s.toExponential(2),e);var t=e.includes("de_")?0:1;i&&(console.log(e+" leakage="+s),snd_send("SET nr type="+t+" param=3 pval="+s),kiwi_storeSet("last_nr_wdsp"+["De","An"][t]+"Leak",_.toString()))}function nf_spectral_gain_cb(e,_,i,n){_=+_,w3_num_cb(e,_),w3_set_label("Gain: "+_+" dB",e),i&&(console.log(e+" dB="+_),snd_send("SET nr type=0 param=0 pval="+Math.pow(10,_/20)),kiwi_storeSet("last_nr_SpecGain",_.toString()))}function nf_spectral_alpha_cb(e,_,i,n){_=+_,w3_num_cb(e,_),w3_set_label("Alpha: "+_.toFixed(2),e),i&&(console.log(e+"="+_.toFixed(2)),snd_send("SET nr type=0 param=1 pval="+_.toFixed(2)),kiwi_storeSet("last_nr_SpecAlpha",_.toString()))}function nf_spectral_asnr_cb(e,_,i,n){_=+_,w3_num_cb(e,_),w3_set_label("Active SNR: "+_+" dB",e),i&&(console.log(e+" dB="+_),snd_send("SET nr type=0 param=2 pval="+Math.pow(10,_/10)),kiwi_storeSet("last_nr_SpecSNR",_.toString()))}var noise_filter_de_presets=[1,.05,.98,100,.07,.985];function noise_filter_de_presets_cb(e,_,i){var n=noise_filter_de_presets;w3_slider_set("noise_filter.orig_de_delay",n[3*_],"noise_filter_delay_cb"),w3_slider_set("noise_filter.orig_de_beta",n[3*_+1],"noise_filter_beta_cb"),w3_slider_set("noise_filter.orig_de_decay",n[3*_+2],"noise_filter_decay_cb")}var noise_filter_an_presets=[48,.125,.99915,48,.002,.9998,48,.001,.998];function noise_filter_an_presets_cb(e,_,i){var n=noise_filter_an_presets;w3_slider_set("noise_filter.orig_an_delay",n[3*_],"noise_filter_delay_cb"),w3_slider_set("noise_filter.orig_an_beta",n[3*_+1],"noise_filter_beta_cb"),w3_slider_set("noise_filter.orig_an_decay",n[3*_+2],"noise_filter_decay_cb")}function noise_filter_delay_cb(e,_,i,n){_=+_,w3_num_cb(e,_),w3_set_label("Delay line: "+_+" samp"+(1==_?"":"s")+", "+(1*_/12e3*1e3).toFixed(3)+" msec",e);var s=e.includes("de_")?0:1;i&&(snd_send("SET nr type="+s+" param=0 pval="+_),kiwi_storeSet("last_nr_orig"+["De","An"][s]+"Delay",_.toString()))}function noise_filter_beta_cb(e,_,i,n){_=+_,w3_num_cb(e,_),w3_set_label("Beta: "+_.toFixed(4),e);var s=e.includes("de_")?0:1;i&&(snd_send("SET nr type="+s+" param=1 pval="+_),kiwi_storeSet("last_nr_orig"+["De","An"][s]+"Beta",_.toString()))}function noise_filter_decay_cb(e,_,i,n){_=+_,w3_num_cb(e,_),w3_set_label("Decay: "+_.toFixed(4),e);var s=e.includes("de_")?0:1;i&&(snd_send("SET nr type="+s+" param=2 pval="+_),kiwi_storeSet("last_nr_orig"+["De","An"][s]+"Decay",_.toString()))}


