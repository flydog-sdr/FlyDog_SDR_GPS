

/* web/extensions/DRM/DRM.min.js */
var drm={ext_name:"DRM",first_time:!0,active:!1,special_passband:null,dseq:0,interval:null,interval2:null,locked:0,wrong_srate:!1,hacked:!1,run:0,is_stopped:0,is_monitor:0,freq_s:"",freq:0,w_graph_nom:675,w_graph_min:400,panel_0:["info","info","info","info","info","info","info","info"],panel_1:["by-svc","by-time","by-freq","graph","IQ","IQ","IQ","IQ"],BY_SVC:0,BY_TIME:1,BY_FREQ:2,GRAPH:3,IQ_ALL:4,FAC:5,SDC:6,MSC:7,IQ_END:7,display_idx:1,display_idx_s:["schedule","graph","iq"],display_idx_si:[1,5,7],display_s:{Schedule:[{m:"by service"},{m:"by time"},{m:"by freq"}],Display:[{m:"IF/SNR",c:"graph"}],IQ:[{m:"all",c:"IQ"},{m:"FAC",c:"IQ"},{m:"SDC",c:"IQ"},{m:"MSC",c:"IQ"}]},stations:null,using_default:!1,double_fault:!1,loading_msg:"&nbsp;loading data from kiwisdr.com ...",SINGLE:0,MULTI:1,REGION:2,SERVICE:3,monitor:0,database:0,database_s:["drmrx.org","kiwisdr.com"],database_url:["http://DRM.kiwisdr.com/drm/drmrx.cjson","http://DRM.kiwisdr.com/drm/stations2.cjson"],last_occ:-1,last_ilv:-1,last_sdc:-1,last_msc:-1,DRM_DAT_IQ:0,EAudCod:["AAC","OPUS","RESERVED","xHE_AAC",""],AAC:0,xHE_AAC:3,bands:[{n:"LW",b:140,e:300},{n:"MW",b:500,e:1700},{n:"120m",b:22500,e:2500},{n:"90m",b:3100,e:3500},{n:"75m",b:3800,e:4100},{n:"60m",b:4700,e:5100},{n:"49m",b:5800,e:6300},{n:"41m",b:7200,e:7600},{n:"31m",b:9300,e:1e4},{n:"25m",b:11500,e:12200},{n:"22m",b:13500,e:14e3},{n:"19m",b:15e3,e:15900},{n:"16m",b:17400,e:18e3},{n:"15m",b:18800,e:19100},{n:"13m",b:21400,e:22e3},{n:"11m",b:25500,e:26200}],last_last:0};function DRM_main(){ext_switch_to_client(drm.ext_name,drm.first_time,drm_recv),drm.first_time||drm_lock_setup(),drm.first_time=!1}function drm_recv(e){var r,d;if("DAT"!=arrayBufferToStringLen(e,3)){var t=arrayBufferToString(e).substring(4).split(" ");for(r=0;r<t.length;r++){var s=t[r].split("=");switch(s[0]){case"ready":kiwi_load_js(["pkgs/js/graph.js","pkgs/js/sprintf/sprintf.js"],"drm_lock_setup");break;case"inuse":drm.inuse=+s[1];break;case"heavy":drm.heavy=+s[1];break;case"locked":var i=+s[1];-1==i?(drm.wrong_srate=!0,drm.locked=0):-2==i?(drm.hacked=!0,drm.locked=0):drm.locked=1==i?1:0,drm_controls_setup();break;case"drm_status_cb":if(!drm.run||!drm.desktop)break;var n=kiwi_decodeURIComponent("drm_status_cb",s[1]);if(!n)break;var a=kiwi_JSON_parse("drm_status_cb",n);if(!a)break;drm_all_status(a.io,a.time,a.frame,a.FAC,a.SDC,a.MSC),w3_innerHTML("id-drm-if_level","IF Level: "+a.if.toFixed(1)+" dB"),a.if<0&&a.if>-100&&(isUndefined(drm.last_if)&&(drm.last_if=a.if),drm.last_if=graph_plot(drm.gr_if,a.if,{line:drm.last_if,color:"green"})),w3_innerHTML("id-drm-snr",a.snr?"SNR: "+a.snr.toFixed(1)+" dB":""),a.snr>0&&(isUndefined(drm.last_snr)&&(drm.last_snr=a.snr),drm.last_snr=graph_plot(drm.gr_snr,a.snr,{line:drm.last_snr})),isDefined(a.mod)?((r=a.mod)>=0&&r<=3&&w3_color("id-drm-mod-"+["A","B","C","D"][r],"black","lime"),(r=a.occ)>=0&&r<=5&&(drm.last_occ!=r&&w3_color("id-drm-occ-"+["4.5","5","9","10","18","20"][drm.last_occ],"",""),w3_color("id-drm-occ-"+["4.5","5","9","10","18","20"][r],"black","lime"),drm.last_occ=r),(r=a.ilv)>=0&&r<=1&&(drm.last_ilv!=r&&w3_color("id-drm-ilv-"+["L","S"][drm.last_ilv],"",""),w3_color("id-drm-ilv-"+["L","S"][r],"black","lime"),drm.last_ilv=r),(r=a.sdc)>=0&&r<=1&&(drm.last_sdc!=r&&w3_color("id-drm-sdc-"+["4","16"][drm.last_sdc],"",""),w3_color("id-drm-sdc-"+["4","16"][r],"black","lime"),drm.last_sdc=r),(r=a.msc)>2&&(r=2),r>=1&&r<=2&&(drm.last_msc!=r&&w3_color("id-drm-msc-"+["16","64"][drm.last_msc-1],"",""),w3_color("id-drm-msc-"+["16","64"][r-1],"black","lime"),drm.last_msc=r),w3_innerHTML("id-drm-prot",sprintf("Protect: A=%d B=%d",a.pla,a.plb)),w3_innerHTML("id-drm-nsvc",sprintf("Services: A=%d D=%d",a.nas,a.nds)),a.mod>=0&&a.mod<=3&&w3_innerHTML("id-drm-desc",["Local/regional use","Medium range use, multipath resistant","Long distance use, multipath/doppler resistant","Resistance to large delay/doppler spread"][a.mod])):drm_reset_status(),w3_show_hide("id-drm-mode",isDefined(a.mod));var o=drm.AAC;a.svc.forEach(function(e,r){if(d=++r,e.id){var t=kiwi_clean_html(kiwi_clean_newline(decodeURIComponent(e.lbl)));d+=" "+drm.EAudCod[e.ac]+" ("+e.id+") "+t+(e.ep?" UEP ("+e.ep.toFixed(1)+"%) ":" EEP ")+(e.ad?"Audio ":"Data ")+e.br.toFixed(2)+" kbps"}var s=w3_el("id-drm-svc-"+r);s.innerHTML=d,w3_color(s,null,e.cur?"mediumSlateBlue":""),e.cur&&e.ac<4&&(o=e.ac)}),w3_show("id-drm-svcs"),o!=drm.AAC&&o!=drm.xHE_AAC&&console.log("codec="+o),w3_innerHTML("id-drm-error",o!=drm.AAC&&o!=drm.xHE_AAC?"WARNING: codec not supported -- audio will be bad":"<br>"),w3_color("id-drm-error","white","red",o!=drm.AAC&&o!=drm.xHE_AAC),w3_innerHTML("id-drm-msgs",a.msg?kiwi_clean_html(kiwi_clean_newline(decodeURIComponent(a.msg))):"");break;case"drm_bar_pct":if(!drm.run)break;var m=w3_clamp(parseInt(s[1]),0,100),_=w3_el("id-drm-bar");_&&(_.style.width=m+"%");break;case"annotate":switch(+s[1]){case 0:drm_annotate("lime");break;case 1:drm_annotate("gold");break;case 2:drm_annotate("red");break;case 3:drm_annotate("blue")}break;default:console.log("drm_recv: UNKNOWN CMD "+s[0])}}}else{var l=new Uint8Array(e,4)[0],c=new Uint8Array(e,5),p=c.length-1;if(isUndefined(drm.canvas_IQ))return;var w=drm.canvas_IQ.ctx,h=drm.w_IQ,b=drm.h_IQ;switch(l){case drm.DRM_DAT_IQ:if(w.fillStyle="white",w.fillRect(0,0,h,b),w.fillStyle="grey",w.fillRect(0,b/2,h,1),w.fillRect(h/2,0,1,b),drm.display==drm.IQ_ALL||drm.display==drm.FAC)for(w.fillStyle="green",r=0;r<64;r++){var f=c[2*r]/255*h,u=c[2*r+1]/255*b;w.fillRect(f,u,2,2)}if(r=64,drm.display==drm.IQ_ALL||drm.display==drm.SDC)for(w.fillStyle="red";r<320;r++){f=c[2*r]/255*h,u=c[2*r+1]/255*b;w.fillRect(f,u,2,2)}if(r=320,drm.display==drm.IQ_ALL||drm.display==drm.MSC)for(w.fillStyle="blue";r<2368;r++){f=c[2*r]/255*h,u=c[2*r+1]/255*b;w.fillRect(f,u,2,2)}return}console.log("drm_recv: DATA UNKNOWN cmd="+l+" len="+p)}}function drm_annotate(e){graph_annotate(drm.gr_if,e),graph_annotate(drm.gr_snr,e)}function drm_reset_status(){drm_all_status(4,4,4,4,4,4),w3_innerHTML("id-drm-if_level",""),w3_innerHTML("id-drm-snr",""),w3_hide("id-drm-mode");for(var e=0;e<=3;e++)w3_color("id-drm-mod-"+["A","B","C","D"][e],"","");w3_innerHTML("id-drm-error",""),w3_hide("id-drm-svcs"),w3_innerHTML("id-drm-msgs","")}function drm_status(e,r){var d;switch(r){case 0:d="lime";break;case 1:d="yellow";break;case 2:d="red";break;case 3:default:d="red";break;case 4:d="grey"}w3_color("id-drm-status-"+e,d)}function drm_all_status(e,r,d,t,s,i){drm_status("io",e),drm_status("time",r),drm_status("frame",d),drm_status("fac",t),drm_status("sdc",s),drm_status("msc",i)}function drm_lock_setup(){ext_send("SET lock_set")}function drm_saved_mode(){drm.saved_mode=ext_get_mode(),console.log("drm_save_mode FIRST saved_mode="+drm.saved_mode),"drm"==drm.saved_mode&&(drm.saved_mode=ext_get_prev_mode()),console.log("drm_save_mode FINAL saved_mode="+drm.saved_mode)}function drm_tscale(e){var r=drm.mobile?0:20;return(27+e*(drm.w_sched-27-r-15)/24).toFixed(0)}function drm_schedule_static(){for(var e="",r=0;r<=24;r++)e+=w3_div(sprintf("id-drm-sched-tscale|left:%spx;",drm_tscale(r)));return e+=w3_div(sprintf("id-drm-sched-now|left:%spx;",drm_tscale(kiwi_UTC_minutes()/60))),null==drm.interval&&(drm.interval=setInterval(function(){w3_el("id-drm-sched-now").style.left=px(drm_tscale(kiwi_UTC_minutes()/60))},6e4)),e}function drm_pre_set_freq(e,r){1!=isArg(r)&&(console.log("drm_pre_select_cb  RESET special_passband ########"),drm.special_passband=null),drm_station(r||""),drm_set_freq(e),drm_start()}function drm_click(e){var r=drm.stations[e];if(drm.special_passband=null,r.u){var d=new RegExp("^.*?f=/([-0-9.k]*)?,?([-0-9.k]*)?.*$").exec(r.u);console.log(d),d&&3==d.length&&(drm.special_passband={low:d[1].parseFloatWithUnits("k"),high:d[2].parseFloatWithUnits("k")})}console.log("special_passband:"),drm.special_passband?console.log(drm.special_passband):console.log("(none)"),w3_hide("id-drm-bar-container"),drm_pre_set_freq(r.f,r.s)}function drm_schedule_svc(){if(!drm.stations)return"";var e,r=drm.using_default?w3_div("w3-yellow w3-padding w3-show-inline-block","can't contact kiwisdr.com<br>using default data"):"",d=drm.narrow_listing,t=drm_tscale(d?1:.25);for(e=0;e<drm.stations.length;e++){var s=drm.stations[e];if(s.t!=drm.REGION){for(var i=s.s,n=s.f,a=s.u,o="",m=i.replace("_"," "),_=((m+="&nbsp;&nbsp;&nbsp;"+(d?"<br>":"")+n).match(/<br>/g)||[1]).length+(d?2:1),l=Math.max(20*(_-1),30);e<drm.stations.length&&s.s==i&&s.f==n;){var c=drm_tscale(s.b),p=drm_tscale(s.e);o+=w3_div(sprintf('id-drm-sched-time %s|left:%spx; width:%spx; height:%dpx|title="%s" onclick="drm_click(%d);"',s.v?"w3-light-green":"",c,(p-c+2).toFixed(0),l,n.toFixed(0),e)),e++,s=drm.stations[e]}e--;var w="";a&&(w=w3_link("w3-valign",a,w3_icon("w3-link-darker-color cl-drm-sched-info","fa-info-circle",24))),r+=w3_inline("cl-drm-sched-station cl-drm-sched-striped/w3-valign",w3_div(sprintf("|font-size:%dem",_),"&nbsp;"),w,o,w3_div(sprintf("cl-drm-station-name|left:%spx",t),m)),s&&s.t==drm.SERVICE&&(r+=w3_div("cl-drm-sched-hr-div cl-drm-sched-striped",'<hr class="cl-drm-sched-hr">'),e++)}}return r}function drm_schedule_time_freq(e){if(!drm.stations)return"";var r,d,t=drm.using_default?w3_div("w3-yellow w3-padding w3-show-inline-block","can't contact kiwisdr.com<br>using default data"):"",s=drm.narrow_listing;drm.stations_freq=[];kiwi_UTC_minutes();for(r=d=0;r<drm.stations.length;r++){(a=drm.stations[r]).t!=drm.SINGLE&&a.t!=drm.MULTI||(drm.stations_freq[d++]=a)}drm.stations_freq.sort(function(r,d){var t=e?r.f:r.b,s=e?d.f:d.b,i=r.s.startsWith("India,"),n=d.s.startsWith("India,");return i&&!n?1:!i&&n?-1:t<s?-1:t>s?1:0}),console.log("sort_by_freq="+e+" ..."),console.log(drm.stations_freq);var i=drm_tscale(s?1:.25),n="";for(r=0;r<drm.stations_freq.length;r++){var a,o=(a=drm.stations_freq[r]).s,m=a.f,_=a.u,l="",c=o.replace("_",s?"<br>":" ");s&&(c=c.replace(",","<br>"));for(var p=((c=m+"&nbsp;&nbsp;&nbsp;"+(s?"<br>":"")+c).match(/<br>/g)||[1]).length+(s?2:1),w=Math.max(20*(p-1),30);r<drm.stations_freq.length&&a.s==o&&a.f==m;){var h=drm_tscale(a.b),b=drm_tscale(a.e);l+=w3_div(sprintf('id-drm-sched-time %s|left:%spx; width:%spx; height:%dpx|title="%s" onclick="drm_click(%d);"',a.v?"w3-light-green":"",h,(b-h+2).toFixed(0),w,m.toFixed(0),a.i)),r++,a=drm.stations_freq[r]}if(r--,e){var f=null;for(d=0;d<drm.bands.length;d++){var u=drm.bands[d];if(m>=u.b&&m<=u.e){f=u.n;break}}f&&f!=n&&(t+=w3_inline_percent("cl-drm-sched-hr-div cl-drm-sched-striped/",'<hr class="cl-drm-sched-hr">',10,"<b>"+f+"</b>",5,'<hr class="cl-drm-sched-hr">'),n=f)}var g="";_&&(g=w3_link("w3-valign",_,w3_icon("w3-link-darker-color cl-drm-sched-info","fa-info-circle",24))),t+=w3_inline("cl-drm-sched-station cl-drm-sched-striped/w3-valign",w3_div(sprintf("|font-size:%dem",p),"&nbsp;"),g,l,w3_div(sprintf("cl-drm-station-name|left:%spx",i),c))}return t}function drm_get_stations_done_cb(e){var r=!1;if(e?e.AJAX_error&&"timeout"==e.AJAX_error?(console.log("drm_get_stations_done_cb: TIMEOUT"),drm.using_default=!0,r=!0):isArray(e)||(console.log("drm_get_stations_done_cb: not array"),r=!0):(console.log("drm_get_stations_done_cb: stations="+e),r=!0),r){if(drm.double_fault)return void console.log("drm_get_stations_done_cb: default station list fetch FAILED");console.log(e);var d=kiwi_url_origin()+"/extensions/DRM/stations.cjson";return console.log("drm_get_stations_done_cb: using default station list "+d),drm.using_default=!0,drm.double_fault=!0,void kiwi_ajax_progress(d,"drm_get_stations_done_cb",0,1e4)}console.log("drm_get_stations_done_cb: from "+drm.database_url[drm.database]);try{drm.stations=[];var t,s,i,n,a,o,m,_=0,l=!1;e.forEach(function(e,r){o="",w3_obj_enum(e,function(e,r,c){if(0==r)return"India MW"==(t=e)&&(o="India, ",l=!0),drm.stations.push({t:drm.REGION,f:0,s:"",r:t}),void _++;if(isArray(c)){for(s=o+e,d=null,r=0;r<c.length;r++){var p=c[r];if(0==r&&isString(p))d=p;else if(i=p,p=c[++r],isArray(p))for(var w=0;w<p.length;w++)n=kiwi_hh_mm(p[w++]),a=kiwi_hh_mm(p[w]),m=n<0||a<0,0!=drm.database&&(m=!m),n=Math.abs(n),a=Math.abs(a),a<n?(drm.stations.push({t:drm.MULTI,f:i,s:s,r:t,b:n,e:24,v:m,u:d,i:_}),_++,drm.stations.push({t:drm.MULTI,f:i,s:s,r:t,b:0,e:a,v:m,u:d,i:_})):drm.stations.push({t:drm.MULTI,f:i,s:s,r:t,b:n,e:a,v:m,u:d,i:_}),_++;else n=kiwi_hh_mm(c[r++]),a=kiwi_hh_mm(c[r]),m=n<0||a<0,0!=drm.database&&(m=!m),n=Math.abs(n),a=Math.abs(a),a<n?(drm.stations.push({t:drm.SINGLE,f:i,s:s,r:t,b:n,e:24,v:m,u:d,i:_}),_++,drm.stations.push({t:drm.SINGLE,f:i,s:s,r:t,b:0,e:a,v:m,u:d,i:_})):drm.stations.push({t:drm.SINGLE,f:i,s:s,r:t,b:n,e:a,v:m,u:d,i:_}),_++}l||(drm.stations.push({t:drm.SERVICE,f:0,s:s,r:t}),_++)}})}),console.log(drm.stations)}catch(e){console.log("drm_get_stations_done_cb: catch"),console.log(e)}w3_innerHTML("id-drm-panel-by-svc",drm_schedule_svc()),w3_innerHTML("id-drm-panel-by-time",drm_schedule_time_freq(0)),w3_innerHTML("id-drm-panel-by-freq",drm_schedule_time_freq(1))}function drm_panel_show(e,r){var d=w3_div("id-drm-controls w3-text-white",w3_divs("",w3_div("w3-medium w3-text-aqua","<b>Digital Radio Mondiale (DRM30) decoder</b>"),w3_col_percent("w3-margin-T-4/",w3_div("id-drm-station w3-text-css-yellow","&nbsp;"),70,w3_div("",'Based on <b><a href="https://sourceforge.net/projects/drm/" target="_blank">Dream 2.2.1</a></b>')),e));ext_panel_show(d,r,null),ext_set_controls_width_height(600,185)}function drm_mobile_controls_setup(e){drm.mobile=drm.mobile||1,console.log("$ mobile drm mobile_laptop_test="+mobile_laptop_test),drm.w_nom=drm.w_sched=300,drm.h_sched=mobile_laptop_test?100:230,drm.cpanel_margin=20;var r=w3_div(sprintf("id-drm-controls w3-absolute|width:%dpx; height:%dpx;",drm.w_sched,drm.h_sched),w3_div(sprintf("id-drm-panel-container cl-drm-sched|width:100%%; height:100%%;"),w3_div("id-drm-panel-by-svc-static",drm_schedule_static()),w3_div("id-drm-panel-by-svc w3-iphone-scroll w3-absolute|width:100%; height:100%;",drm.loading_msg)));ext_panel_show(r,null,null),ext_set_controls_width_height(drm.w_sched+drm.cpanel_margin,drm.h_sched+drm.cpanel_margin),drm_database_cb("drm.database",0,!0);var d=w3_el("id-ext-controls-close");console.log("DRM mobile setup panelShown="+w3_el("id-ext-controls").panelShown),d.onclick=function(){toggle_panel("ext-controls",0),console.log("DRM mobile ext-controls-close panelShown="+w3_el("id-ext-controls").panelShown)},w3_create_attribute("id-ext-controls-close-img","src","icons/close.black.24.png"),drm.last_mobile={},drm.rescale_cnt=drm.rescale_cnt2=0,drm.fit="",null==drm.interval2&&(drm.interval2=setInterval(function(){if(e=ext_mobile_info(drm.last_mobile),drm.last_mobile=e,!e.orient_unchanged){drm.rescale_cnt++;var r=w3_el("id-control").uiWidth;drm.w_nom+r<=e.width?(drm.w_sched=e.width-r-60,w3_el("id-ext-controls").style.zIndex=125,drm.fit="sbs"+drm.w_sched):(drm.w_sched=e.width-2*drm.cpanel_margin,w3_el("id-ext-controls").style.zIndex=150,drm.fit="fw"+drm.w_sched),ext_set_controls_width_height(drm.w_sched+drm.cpanel_margin,drm.h_sched+drm.cpanel_margin),w3_el("id-drm-controls").style.width=px(drm.w_sched),w3_innerHTML("id-drm-panel-by-svc-static",drm_schedule_static()),w3_innerHTML("id-drm-panel-by-svc",drm_schedule_svc()),w3_innerHTML("id-drm-panel-by-time",drm_schedule_time_freq(0)),w3_innerHTML("id-drm-panel-by-freq",drm_schedule_time_freq(1))}},500))}function drm_desktop_controls_setup(e){var r,d,t=null,s=250;if(drm.wrong_srate)d=w3_text("w3-medium w3-text-css-yellow","Currently, DRM does not support Kiwis configured for 20 kHz wide channels.");else if(drm.hacked)d=w3_text("w3-medium w3-text-css-yellow","Yeah, nah..");else if(0==drm.locked){if(kiwi.is_multi_core)r="DRM not supported on this channel.";else{var i=cfg.DRM.nreg_chans;console_log("drm_nreg_chans",i),r=0==i?"Requires exclusive use of the Kiwi. There can be no other connections.":1==i?"Can only run DRM with one other Kiwi connection.<br>And the other connection is not using any extensions.":"Can only run DRM with "+i+" or fewer other Kiwi connections.<br>And the other connections are not using any extensions.",r+="<br>Please try again when these conditions are met."}d=w3_text("w3-medium w3-text-css-yellow",r)}else{for(var n="Services:<br>",a=1;a<=4;a++)n+=w3_inline("",w3_checkbox("w3-margin-R-8","","drm.svc"+a,1==a,"drm_svcs_cbox_cb"),w3_div("id-drm-svc-"+a+"|width:100%"));var o=function(e){return e+" "+w3_icon("id-drm-status-"+e.toLowerCase(),"fa-square",16,"grey")+" &nbsp;&nbsp;"},m=function(e,r){return w3_span("id-drm-"+e+" cl-drm-blk",r)},_=function(e){return m("mod-"+e,e)},l=function(e){return m("occ-"+e,e)},c=function(e){return m("ilv-"+e,e)},p=function(e){return m("sdc-"+e,e)},w=function(e){return m("msc-"+e,e)},h=500+e;drm.w_sched=e;var b=25+h;t=time_display_html("drm")+w3_div(sprintf("id-drm-panel-0-info w3-relative w3-no-scroll|width:%dpx; height:%dpx; background-color:black;",b,s),w3_div(sprintf("id-drm-console-msg w3-margin-T-8 w3-small w3-text-white w3-absolute|left:%dpx; width:%dpx; height:%dpx; overflow-x:hidden;",25,500,s),w3_div("id-drm-status",o("IO")+o("Time")+o("Frame")+o("FAC")+o("SDC")+o("MSC")),w3_inline("w3-halign-space-between|width:250px/",w3_div("id-drm-if_level"),w3_div("id-drm-snr")),w3_divs("id-drm-mode w3-hide/w3-margin-T-6",w3_inline("/w3-show-inline","DRM mode ",_("A"),_("B"),_("C"),_("D"),"&nbsp;&nbsp;&nbsp; Chan ",l("4.5"),l("5"),l("9"),l("10"),l("18"),l("20")," kHz","&nbsp;&nbsp;&nbsp; ILV ",c("L"),c("S")),w3_inline("/w3-show-inline","SDC ",p("4"),p("16")," QAM","&nbsp;&nbsp;&nbsp; MSC ",w("16"),w("64")," QAM",w3_div("id-drm-prot w3-margin-left"),w3_div("id-drm-nsvc w3-margin-left")),w3_div("id-drm-desc")),w3_div("id-drm-error|width:"+px(450)),w3_div("id-drm-svcs w3-hide|width:"+px(450),n),"<br><br>",w3_div(sprintf("id-drm-msgs|width:%dpx",500))),w3_div(sprintf("id-drm-panel-graph w3-absolute|width:%dpx; height:%dpx; left:%dpx;",e,s,525),w3_div(sprintf("id-drm-panel-1-by-svc cl-drm-sched|width:%dpx; height:100%%;",e),w3_div("id-drm-tscale",drm_schedule_static()),w3_div("id-drm-panel-by-svc w3-scroll-y w3-absolute|width:100%; height:100%;",drm.loading_msg)),w3_div(sprintf("id-drm-panel-1-by-time cl-drm-sched|width:%dpx; height:100%%;",e),w3_div("id-drm-tscale",drm_schedule_static()),w3_div("id-drm-panel-by-time w3-scroll-y w3-absolute|width:100%; height:100%;",drm.loading_msg)),w3_div(sprintf("id-drm-panel-1-by-freq cl-drm-sched|width:%dpx; height:100%%;",e),w3_div("id-drm-tscale",drm_schedule_static()),w3_div("id-drm-panel-by-freq w3-scroll-y w3-absolute|width:100%; height:100%;",drm.loading_msg)),w3_div("id-drm-panel-1-graph w3-show-block",w3_canvas("id-drm-graph-if",e,105,{top:10}),w3_canvas("id-drm-graph-snr",e,105,{top:135})),w3_canvas("id-drm-panel-1-IQ",e,s,{pad:10})))+w3_div("id-drm-options w3-display-right w3-text-white|top:230px; right:0px; width:200px; height:200px",w3_select_hier("w3-text-red","","","drm.display_idx",drm.display_idx,drm.display_s,"drm_display_cb"),w3_div("w3-margin-T-8",w3_divs("id-drm-options-by-svc id-drm-options-by-time id-drm-options-by-freq/w3-tspace-4",w3_div("cl-drm-sched-options-time w3-light-green","verified"),w3_div("cl-drm-sched-options-time","not verified"),w3_link("w3-link-color","http://forum.kiwisdr.com/discussion/1865/drm-heard#latest","Please report<br>schedule changes")))),d=w3_inline("w3-halign-space-between w3-margin-T-8/",w3_text("w3-text-white",'Schedules in top panel: Click on green/pink bars to tune a station. <br>Use menu to sort schedules by service, time or frequency. <br>Gray vertical lines are spaced 1 hour apart beginning at 00:00 UTC on the left. <br>Red line shows current UTC time and updates while the extension is running. <br><span class="w3-text-yellow-highlight">New</span> Database menu below selects source of schedule information including '+w3_link("w3-link-color","https://www.drmrx.org","drmrx.org")))+w3_inline("w3-margin-T-8/w3-margin-between-16",w3_select("w3-text-red","","database","drm.database",drm.database,drm.database_s,"drm_database_cb"),w3_button("id-drm-stop-button w3-padding-smaller w3-pink","Stop","drm_stop_start_cb"),w3_button("w3-padding-smaller w3-pink","Monitor IQ","drm_monitor_IQ_cb"),w3_button("w3-padding-smaller w3-aqua","Test 1","drm_test_cb",1),w3_button("w3-padding-smaller w3-aqua","Test 2","drm_test_cb",2),w3_div("id-drm-bar-container w3-progress-container w3-round-large w3-white w3-hide|width:160px; height:16px",w3_div("id-drm-bar w3-progressbar w3-round-large w3-light-green|width:50%","&nbsp;")))}drm_panel_show(d,t),ext_set_data_height(s),0!=drm.locked&&(time_display_setup("drm"),drm.canvas_if=w3_el("id-drm-graph-if"),drm.canvas_if.ctx=drm.canvas_if.getContext("2d"),drm.gr_if=graph_init(drm.canvas_if,{dBm:0,speed:1,averaging:!1}),graph_mode(drm.gr_if,"auto"),graph_clear(drm.gr_if),drm.canvas_snr=w3_el("id-drm-graph-snr"),drm.canvas_snr.ctx=drm.canvas_snr.getContext("2d"),drm.gr_snr=graph_init(drm.canvas_snr,{dBm:0,speed:1,averaging:!1}),graph_mode(drm.gr_snr,"auto"),graph_clear(drm.gr_snr),drm.canvas_IQ=w3_el("id-drm-panel-1-IQ"),drm.canvas_IQ.ctx=drm.canvas_IQ.getContext("2d"),drm.w_IQ=e-20,drm.h_IQ=230,drm.desktop=1)}function drm_controls_setup(){drm_saved_mode(),console.log("drm_controls_setup saved_mode="+drm.saved_mode),drm.saved_passband=ext_get_passband(),drm.is_stopped=0,console.log("drm_controls_setup is_stopped="+drm.is_stopped),drm.is_monitor=0,console.log("drm_controls_setup is_monitor="+drm.is_monitor),ext_send("SET monitor=0"),(t=drm.url_params=ext_param())&&(t=t.split(",")).forEach(function(e,r){console.log("DRM param1 <"+e+">");var d,t=e.split(":");if(t=t[t.length-1].toLowerCase(),w3_ext_param_array_match_str(drm.display_idx_s,e,function(e){drm.display_idx=drm.display_idx_si[e]}),(d=w3_ext_param("lo",e)).match)drm.pb_lo=d.num;else if((d=w3_ext_param("hi",e)).match)drm.pb_hi=d.num;else if((d=w3_ext_param("mobile",e)).match)drm.mobile=d.has_value?d.num:1;else if((d=w3_ext_param("debug",e)).match){var s=d.has_value?d.num:0;ext_send("SET debug="+s)}});var e=ext_mobile_info(),r=drm.w_graph_nom-Math.max(0,1440-e.width);if(drm.narrow_listing=r<drm.w_graph_nom||2==drm.mobile,drm.mobile||r<=drm.w_graph_min?drm_mobile_controls_setup(e):drm_desktop_controls_setup(r),0!=drm.locked){if(drm.active=!0,drm.url_params){var d=parseFloat(drm.url_params);d&&drm_pre_set_freq(d)}var t;(t=drm.url_params)&&(t=t.split(",")).forEach(function(e,r){var d,t=e.split(":");if(t=t[t.length-1].toLowerCase(),w3_ext_param("help",e).match)extint_help_click();else if((d=w3_ext_param("test",e)).match){var s=d.has_value?d.num:1;drm_station("Test Recording "+(s=w3_clamp(s,1,2,1))),w3_show("id-drm-bar-container"),drm_test(s)}}),drm_run(1),drm_set_freq(ext_get_freq_kHz())}}function drm_run(e){e!=drm.run&&(e&&(drm_saved_mode(),console.log("drm_run saved_mode="+drm.saved_mode),drm.saved_passband=ext_get_passband()),drm.run=e,ext_send("SET run="+drm.run))}function drm_test(e){ext_send("SET test="+e)}function drm_stop(e){drm_test(0),drm_run(0),drm_reset_status(),drm_station(""),w3_hide("id-drm-bar-container"),e?drm_set_mode("iq"):(isDefined(drm.saved_passband)&&(console_log_fqn("drm_stop RESTORE","drm.saved_passband.low","drm.saved_passband.high"),ext_set_passband(drm.saved_passband.low,drm.saved_passband.high)),isDefined(drm.saved_mode)&&(console_log_fqn("drm_stop RESTORE","drm.saved_mode"),drm_set_mode(drm.saved_mode)))}function drm_start(){drm_test(0),drm_run(1),drm_set_mode("drm"),drm.is_stopped=0,w3_button_text("id-drm-stop-button","Stop","w3-pink","w3-green")}function drm_stop_start_cb(e,r){console.log("drm_stop_start_cb ENTRY is_stopped="+drm.is_stopped),drm.is_stopped^=1,drm.is_stopped?(console.log("$drm_stop_start_cb: do stop, show start"),drm_stop(1),w3_button_text(e,"Start","w3-green","w3-pink")):(console.log("$drm_stop_start_cb: do start, show stop"),drm_start())}function drm_monitor_IQ_cb(e,r){console.log("drm_monitor_IQ_cb ENTRY is_monitor="+drm.is_monitor+" cb_param="+r),drm.is_monitor^=1,drm.is_monitor?(console.log("$drm_monitor_IQ_cb: do monitor start"),w3_remove_then_add(e,"w3-pink","w3-green"),ext_send("SET monitor=1")):(console.log("$drm_monitor_IQ_cb: do monitor stop"),w3_remove_then_add(e,"w3-green","w3-pink"),ext_send("SET monitor=0"))}function drm_set_passband(){drm.pb_lo||drm.pb_hi||extint.override_pb?console.log("drm_set_passband pb_lo,hi="+drm.pb_lo+","+drm.pb_hi+" override_pb="+extint.override_pb):drm.special_passband?(console_log_fqn("drm_set_passband SPECIAL PB","drm.special_passband.low","drm.special_passband.high"),ext_set_passband(drm.special_passband.low,drm.special_passband.high)):(console.log("drm_set_passband DEFAULT PB"),ext_set_passband(-5e3,5e3))}function drm_set_mode(e){console_log("drm_set_mode",e),ext_set_mode(e,null,{no_drm_proc:!0}),"drm"==e&&drm_set_passband()}function drm_set_freq(e){drm.freq=e;var r=ext_get_zoom();r<5?r=5:r>9&&(r=9);var d=drm.pb_lo||drm.pb_hi||extint.override_pb,t=d?ext_get_passband():null;ext_tune(drm.freq,"drm",ext_zoom.ABS,r),d&&ext_set_passband(t.low,t.high),drm_set_passband()}function drm_reset_cb(e,r,d){console.log("drm_reset_cb"),ext_send("SET reset")}function drm_test_cb(e,r,d){console.log("drm_test_cb "+r),drm_station("Test Recording "+r),drm_run(0),drm_start(),drm_test(r),drm_set_mode("drm"),w3_show("id-drm-bar-container"),drm_annotate("magenta")}function drm_svcs_cbox_cb(e,r,d){var t=e.substr(-1,1);if(!d){for(var s=1;s<=4;s++)w3_checkbox_set("drm.svc"+s,!1);w3_checkbox_set(e,!0),ext_send("SET svc="+t)}}function drm_database_cb(e,r,d){var t,s;d&&(r=readCookie("last_drm",0)),r=+r,writeCookie("last_drm",r),w3_select_value(e,r),drm.database=r,console.log("drm_database_cb database="+drm.database+" "+drm.database_url[drm.database]),drm.using_default=drm.double_fault=!1,t=drm.database_url[drm.database],s=1e4,kiwi_ajax_progress(t,"drm_get_stations_done_cb",0,s)}function drm_display_cb(e,r,d){r=+r,w3_select_value(e,r);var t=0,s=-1,i=!1;w3_select_enum(e,function(e){e.disabled||(i||e.value!=r||(s=t,i=!0),t++)});var n=drm.display=s;w3_color("id-drm-panel-graph",null,"graph"!=drm.panel_1[n]?"black":"mediumBlue"),console.log("$ drm_display_cb idx="+r+" show="+n+" "+drm.panel_0[n]+"/"+drm.panel_1[n]),drm.panel_0.forEach(function(e){w3_hide("id-drm-panel-0-"+e)}),drm.panel_1.forEach(function(e){w3_hide("id-drm-panel-1-"+e)}),drm.panel_1.forEach(function(e){w3_hide("id-drm-options-"+e)}),w3_show("id-drm-panel-0-"+drm.panel_0[n]),w3_show("id-drm-panel-1-"+drm.panel_1[n]),w3_show("id-drm-options-"+drm.panel_1[n]),ext_send("SET send_iq="+(n>=drm.IQ_ALL&&n<=drm.IQ_END?1:0))}function drm_station(e){if(drm.desktop){var r=w3_el("id-drm-station");drm.last_station=e,""==e&&(e="&nbsp;"),r&&(r.innerHTML="<b>"+e.replace("_"," ")+"</b>",drm_annotate("magenta"))}}function DRM_environment_changed(e){var r=ext_get_freq()/1e3,d=ext_get_mode();drm.freq==r&&"drm"==d||drm_station("")}function DRM_blur(){console.log("DRM_blur saved_mode="+drm.saved_mode),kiwi_clearInterval(drm.interval),drm.interval=null,kiwi_clearInterval(drm.interval2),drm.interval2=null,drm.active=!1,drm_stop(0),(isUndefined(drm.saved_mode)||"drm"==drm.saved_mode)&&(console.log("DRM_blur FORCE iq"),drm_set_mode("iq")),drm.locked=0,ext_send("SET lock_clear"),ext_set_data_height()}function DRM_help(e){if(e){var r=w3_text("w3-medium w3-bold w3-text-aqua","Digital Radio Mondiale (DRM30) decoder help")+w3_div("w3-margin-T-8 w3-scroll-y|height:90%",w3_div("w3-margin-R-8",'Schedules in top panel: Click on green/pink bars to tune a station. <br>Use menu to sort schedules by service, time or frequency. <br>Gray vertical lines are spaced 1 hour apart beginning at 00:00 UTC on the left. <br>Red line shows current UTC time and updates while the extension is running. <br><span class="w3-text-yellow-highlight">New</span> A database menu allows selection of the source of schedule information. <br><br>With DRM selective fading can prevent even the strongest signals from being received properly. To see if signal fading is occurring adjust the waterfall "WF max/min" controls carefully so the waterfall colors are not saturated. The image below shows fading (dark areas) that might cause problems. See the <a href="http://forum.kiwisdr.com/discussion/1842/v1-360-drm-extension-now-available/p1" target="_blank">Kiwi forum</a> for more information. <br><br><img src="gfx/DRM.sel.fade.png" /><br><br>Custom passbands set before invoking the DRM extension will be respected. <br>For example the passband field of a DX label that has mode DRM, or a passband specification in the URL e.g. "my_kiwi.com:8073/?pb=0,5k&ext=drm" <hr>DRM code from <b>Dream 2.2.1</b> <br>Technische Universitaet Darmstadt, Institut fuer Nachrichtentechnik <br>Copyright (c) 2001-2020 &nbsp;&nbsp;&nbsp;&nbsp;<a href="https://sourceforge.net/projects/drm" target="_blank">sourceforge.net/projects/drm</a> <br>License: GNU General Public License version 2.0 (GPLv2) <br><hr><b>Fraunhofer FDK AAC Codec Library for Android</b> <br>© Copyright  1995 - 2018 Fraunhofer-Gesellschaft zur Förderung der angewandten <br>Forschung e.V. All rights reserved. <br>For more information visit <a href="http://www.iis.fraunhofer.de/amm" target="_blank">www.iis.fraunhofer.de/amm</a> <br><hr><b>OpenCORE-AMR modifications to Fraunhofer FDK AAC Codec</b> <br>Copyright (C) 2009-2011 Martin Storsjo &nbsp;&nbsp;&nbsp;&nbsp;<a href="https://sourceforge.net/projects/opencore-amr" target="_blank">sourceforge.net/projects/opencore-amr</a> <br>License: Apache License V2.0 <br><hr>Features <b>NewsService Journaline(R)</b> decoder technology by <br>Fraunhofer IIS, Erlangen, Germany. <br>Copyright (c) 2003, 2004 <br>For more information visit <a href="http://www.iis.fhg.de/dab" target="_blank">www.iis.fhg.de/dab</a> <br>License: GNU General Public License version 2.0 (GPLv2) <br><hr>'));confirmation_show_content(r,610,350),w3_el("id-confirmation-container").style.height="100%"}else if(drm.mobile)return"off";return!0}function DRM_config_html(){var e=ext_get_cfg_param("DRM.nreg_chans",3);-1==e&&(e=3),drm.nreg_chans=Math.min(e,rx_chans-1);var r=Math.max(4,rx_chans);drm.nreg_chans_u={0:"none"};for(var d=1;d<r;d++)drm.nreg_chans_u[d]=d.toFixed(0);var t=w3_inline_percent("w3-container",w3_div("w3-center",w3_select("w3-text-red","Number of non-DRM connections allowed<br>when DRM in use","","DRM.nreg_chans",drm.nreg_chans,drm.nreg_chans_u,"admin_select_cb")),40);ext_config_html(drm,"DRM","DRM","DRM configuration",t)}


