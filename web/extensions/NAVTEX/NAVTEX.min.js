

/* web/extensions/NAVTEX/NAVTEX.min.js (web/extensions/NAVTEX/NAVTEX.js = Mon Jun 20 11:18:13 2022) */
var nt={ext_name:"NAVTEX",first_time:!0,test_location:!1,dataH:445,ctrlW:550,ctrlH:175,splitH:100,lhs:130,tw:1024,x:0,last_y:[],freqs:null,menu_s:[],menus:[],sfmt:"w3-text-red w3-ext-retain-input-focus",SHOW_MSGS:0,SHOW_MAP:1,SHOW_SPLIT:2,show:0,show_s:["messages","map","split"],navtex_mode:0,navtex_mode_s:["normal","DX"],dsc_mode:0,dsc_mode_s:["normal","+errs"],selcall_mode:0,selcall_mode_s:["normal","+errs","+raw","+both"],MODE_NORMAL:0,MODE_DX:1,MODE_SHOW_ERRS:1,MODE_SHOW_RAW:2,MODE_SHOW_BOTH:3,show_errs:0,auto_zoom:1,type:0,TYPE_NAVTEX:0,TYPE_DSC:1,TYPE_SELCALL:2,freq:0,freq_s:"",cf_navtex:500,cf_dsc:500,cf_selcall:1785,cf_selcall_low:785,pb_skirt_width:50,cf:500,shift:170,baud:100,framing:"4/7",inverted:0,encoding:"CCIR476",dx:0,dxn:80,fifo:[],log_mins:0,log_interval:null,log_txt:"",locations:{},too_old_min:30,locations_visible:!0,last_last:0};function NAVTEX_main(){ext_switch_to_client(nt.ext_name,nt.first_time,navtex_recv),nt.first_time||navtex_controls_setup(),nt.first_time=!1}function navtex_recv(t){if("DAT"!=arrayBufferToStringLen(t,3))for(var e=arrayBufferToString(t).substring(4).split(" "),n=0;n<e.length;n++){var _=e[n].split("=");switch(0,_[0]){case"ready":var a="extensions/FSK/";kiwi_load_js(["pkgs_maps/pkgs_maps.js","pkgs_maps/pkgs_maps.css",a+"JNX.js",a+"BiQuadraticFilter.js",a+"CCIR476.js",a+"DSC.js",a+"Selcall.js"],"navtex_controls_setup");break;case"test_done":break;default:console.log("navtex_recv: UNKNOWN CMD "+_[0])}}else{var o=new Uint8Array(t,4),t=o[0],o=o.length-1;console.log("navtex_recv: DATA UNKNOWN cmd="+t+" len="+o)}}function navtex_baud_error_init(){var t=nt.th/2,e=navtex_canvas.ctx;e.fillStyle="white",e.font="14px Verdana",e.fillText("Baud",nt.lhs/2-25,t),e.fillText("Error",nt.lhs/2-25,14+t)}function navtex_baud_error(t){(t=8<t?8:t)<-8&&(t=-8);var e=Math.round(.4*nt.th/2*t/8),n=nt.lhs-40,_=nt.th/2,t=navtex_canvas.ctx;t.fillStyle="black",t.fillRect(n,0,20,nt.th),0<e?(t.fillStyle="lime",t.fillRect(n,_-e,20,e)):(t.fillStyle="red",t.fillRect(n,_,20,-e))}var navtex_canvas,navtex_console_status_msg_p={scroll_only_at_bottom:!0,process_return_alone:!1,remove_returns:!0,ncol:135};function navtex_output_char(t){if(nt.type==nt.TYPE_NAVTEX&&nt.dx){"\r"!=t&&"\n"!=t||(t=" "),nt.fifo.push(t);var e=nt.fifo.join("");if(e.startsWith("ZCZC"))t="",nt.dx_tail&&(t+=" ...\n"),t+=(new Date).toUTCString().substr(5,20)+" UTC | ",""!=nt.freq_s&&(t+=nt.freq_s+" | "),t+=e.substr(0,9)+" | ",nt.fifo=[],nt.dx_tail=nt.dxn;else{for(;9<nt.fifo.length;)nt.fifo.shift();if(!nt.dx_tail)return;if(nt.dx_tail==nt.dxn&&" "==t)return;nt.dx_tail--,0==nt.dx_tail&&(t+=" ...\n")}}navtex_console_status_msg_p.s=encodeURIComponent(t),nt.log_txt+=kiwi_remove_escape_sequences(kiwi_decodeURIComponent("NAVTEX",t)),kiwi_output_msg("id-navtex-console-msgs","id-navtex-console-msg",navtex_console_status_msg_p)}function navtex_audio_data_cb(t,e){nt.jnx.process_data(t,e)}function navtex_controls_setup(){nt.th=nt.dataH,nt.saved_mode=ext_get_mode(),nt.jnx=new JNX,nt.freq=ext_get_freq()/1e3,nt.jnx.set_baud_error_cb(navtex_baud_error),nt.jnx.set_output_char_cb(navtex_output_char);var t=nt.url_params=ext_param();console.log("NAVTEX url_params="+t),t&&(t=t.split(",")).forEach(function(t,e){(t=w3_ext_param("zoom",t)).match&&isNumber(t.num)&&(nt.auto_zoom=0==t.num?0:1)});var e="width:"+px(nt.lhs+1024)+"; height:"+px(nt.dataH)+";",n="w3-label-inline w3-label-not-bold",e=time_display_html("navtex")+w3_div("id-navtex-data w3-display-container|left:0px; "+e,w3_div("id-navtex-msgs w3-hide|"+e+"; z-index:1; overflow:hidden; position:absolute;",'<canvas id="id-navtex-canvas" width='+dq(nt.lhs+1024)+" height="+dq(nt.dataH)+' style="left:0; position:absolute"></canvas>',w3_div("id-navtex-console-msg w3-text-output w3-scroll-down w3-small w3-text-black|left:"+px(nt.lhs)+"; width:1024px; position:absolute; overflow-x:hidden;",'<pre><code id="id-navtex-console-msgs"></code></pre>')),w3_div("|left:"+px(nt.lhs)+"; width:1024px; height:"+px(nt.dataH)+'; position:absolute; z-index:0|id="id-navtex-map"'))+w3_div("id-navtex-options w3-display-right w3-text-white|top:230px; right:0px; width:250px; height:200px",w3_text("w3-text-aqua w3-bold","Display options"),w3_select("w3-margin-T-4 w3-width-auto "+nt.sfmt,"","show","nt.show",nt.show,nt.show_s,"navtex_show_cb"),w3_checkbox("w3-margin-T-10//"+n,"Show day/night","nt.day_night_visible",!0,"navtex_day_night_visible_cb"),w3_checkbox(n,"Show graticule","nt.graticule_visible",!0,"navtex_graticule_visible_cb"),w3_inline("w3-margin-T-10 w3-valign/",w3_checkbox("//"+n,"Show locations","nt.locations_visible",!0,"navtex_locations_visible_cb"),w3_button("id-navtex-show-locations w3-margin-left class-button w3-small w3-grey w3-momentary","Clear old","navtex_clear_old_cb",1))),n=w3_div("id-navtex-controls w3-text-white",w3_divs("/w3-tspace-8",w3_col_percent("",w3_div("w3-medium w3-text-aqua",'<b><a href="https://en.wikipedia.org/wiki/Navtex" target="_blank">NAVTEX</a> / <a href="https://en.wikipedia.org/wiki/Digital_selective_calling" target="_blank">DSC</a> / <a href="http://hflink.com/selcall" target="_blank">Selcall</a></b>'),45,w3_div("",'FSK from <b><a href="https://arachnoid.com/JNX/index.html" target="_blank">JNX</a></b>, P. Lutus &copy; 2011'),55),w3_col_percent("",w3_div("id-navtex-station w3-text-css-yellow","&nbsp;"),50,w3_div("",'NAVTEX schedules: <a href="http://www.dxinfocentre.com/navtex.htm" target="_blank">MF</a>, <a href="http://www.dxinfocentre.com/maritimesafetyinfo.htm" target="_blank">HF</a>'),50),w3_inline("id-navtex-menus/"),w3_inline("/w3-margin-between-16",w3_button("w3-padding-smaller","Next","w3_select_next_prev_cb",{dir:w3_MENU_NEXT,id:"nt.menu",func:"navtex_pre_select_cb"}),w3_button("w3-padding-smaller","Prev","w3_select_next_prev_cb",{dir:w3_MENU_PREV,id:"nt.menu",func:"navtex_pre_select_cb"}),w3_inline("",w3_inline("id-navtex-mode/w3-margin-between-16",w3_select("w3-text-red","","display","nt.navtex_mode",0,nt.navtex_mode_s,"navtex_mode_cb")),w3_inline("id-dsc-mode w3-hide/w3-margin-between-16",w3_select("w3-text-red","","display","nt.dsc_mode",0,nt.dsc_mode_s,"navtex_dsc_mode_cb")),w3_inline("id-selcall-mode w3-hide/w3-margin-between-16",w3_select("w3-text-red","","display","nt.selcall_mode",0,nt.selcall_mode_s,"navtex_selcall_mode_cb"))),w3_checkbox("w3-label-inline w3-label-not-bold/","auto<br>zoom","nt.auto_zoom",nt.auto_zoom,"navtex_auto_zoom_cb"),w3_button("w3-padding-smaller w3-css-yellow","Clear","navtex_clear_button_cb",0),w3_button("id-navtex-log w3-padding-smaller w3-purple","Log","navtex_log_cb"),cfg.navtex.test_file?w3_button("w3-padding-smaller w3-aqua","Test","navtex_test_cb"):"",w3_input("id-navtex-log-mins/w3-label-not-bold/w3-ext-retain-input-focus|padding:0;width:auto|size=4","log min","nt.log_mins",nt.log_mins,"navtex_log_mins_cb"))));ext_panel_show(n,e,null),time_display_setup("navtex"),w3_el("navtex-time-display").style.top=px(10),(navtex_canvas=w3_el("id-navtex-canvas")).ctx=navtex_canvas.getContext("2d"),nt.url_params&&(t=nt.url_params.split(",")).forEach(function(t,e){var n;w3_ext_param("dx",t).match?navtex_mode_cb("id-nt.mode",nt.MODE_DX):w3_ext_param("errors",t).match?(navtex_dsc_mode_cb("id-nt.dsc_mode",nt.MODE_SHOW_ERRS),navtex_selcall_mode_cb("id-nt.selcall_mode",nt.MODE_SHOW_ERRS)):w3_ext_param("raw",t).match?navtex_selcall_mode_cb("id-nt.selcall_mode",nt.MODE_SHOW_RAW):w3_ext_param("both",t).match?navtex_selcall_mode_cb("id-nt.selcall_mode",nt.MODE_SHOW_BOTH):(n=w3_ext_param("log_time",t)).match?isNumber(n.num)&&navtex_log_mins_cb("id-nt.log_mins",n.num):w3_ext_param("map",t).match?nt.show=nt.SHOW_MAP:w3_ext_param("split",t).match?nt.show=nt.SHOW_SPLIT:cfg.navtex.test_file&&w3_ext_param("test",t).match?ext_send("SET test"):w3_ext_param("help",t).match&&extint_help_click()}),navtex_setup(),navtex_baud_error_init(),ext_set_data_height(nt.dataH),ext_set_controls_width_height(nt.ctrlW,nt.ctrlH),nt.kmap=kiwi_map_init("navtex",[12.5,112.5],5,17),w3_do_when_rendered("id-navtex-menus",function(){nt.ext_url=kiwi_SSL()+"files.kiwisdr.com/navtex/NAVTEX_freq_menus.cjson",nt.int_url=kiwi_url_origin()+"/extensions/NAVTEX/NAVTEX_freq_menus.cjson",nt.using_default=!1,nt.double_fault=!1,kiwi_ajax(nt.ext_url,"navtex_get_menus_cb",0,1e4)}),ext_register_audio_data_cb(navtex_audio_data_cb),nt.locations_age_interval=setInterval(function(){var _=Date.now()-60*nt.too_old_min*1e3;w3_obj_enum(nt.locations,function(t,e,n){n.upd<_&&(console.log("LOC-OLD "+n.loc_name+" > "+nt.too_old_min+"m"),n.el.style.background="grey")})},6e4),setTimeout(function(){navtex_show_cb("id-nt.show",nt.show)},1e3),nt.test_location&&setTimeout(function(){navtex_location_update("666666",15,115),navtex_location_update("4444",15,115),nt.test_location=!1},5e3)}function navtex_get_menus_cb(t){nt.freqs=t,ext_get_menus_cb(nt,t,"navtex_get_menus_cb",function(t){if(ext_render_menus(nt,"navtex","nt"),nt.url_params){var e=parseFloat(nt.url_params);if(!isNaN(e))for(var n=!1,_=0;_<nt.n_menu;_++){var a="nt.menu"+_;if(w3_select_enum(a,function(t){parseFloat(t.innerHTML)==e&&(navtex_pre_select_cb(a,t.value,!1),n=!0)}),n)break}}},null)}function navtex_auto_zoom(t){return t<170?14:t<=200?13:t<=450?12:11}function navtex_setup(){nt.freq=ext_get_freq()/1e3,console.log("NAVTEX/DSC SETUP freq="+nt.freq+" cf="+nt.cf+" shift="+nt.shift+" baud="+nt.baud+" framing="+nt.framing+" enc="+nt.encoding+" inv="+nt.inverted+" show_raw="+nt.show_errs+" show_errs="+nt.show_errs),nt.jnx.setup_values(ext_sample_rate(),nt.cf,nt.shift,nt.baud,nt.framing,nt.inverted,nt.encoding,nt.show_raw,nt.show_errs),navtex_crosshairs(1)}function navtex_crosshairs(t){var e=canvas_annotation.ctx;if(e.clearRect(0,0,window.innerWidth,24),t&&10<=ext_get_zoom()){var n=ext_get_freq();"usb"==nt.mode&&(n+=nt.cf);for(var t=get_visible_freq_range(),_=scale_px_from_freq(n-nt.shift/2,t),a=scale_px_from_freq(n+nt.shift/2,t),o=0;o<6;o++){var i=3*o;e.fillStyle=1&o?"black":"white",e.fillRect(_-3,i,3,3),e.fillRect(a-3,i,3,3),e.fillStyle=1&o?"white":"black",e.fillRect(_,i,3,3),e.fillRect(a,i,3,3)}}w3_show_hide_inline("id-navtex-mode",nt.type==nt.TYPE_NAVTEX),w3_show_hide_inline("id-dsc-mode",nt.type==nt.TYPE_DSC),w3_show_hide_inline("id-selcall-mode",nt.type==nt.TYPE_SELCALL)}function navtex_pre_select_cb(e,n,t){var _,a,o,i;t||(n=+n,_=parseInt(e.split("nt.menu")[1]),console.log("navtex_pre_select_cb path="+e+" idx="+n+" menu_n="+_),o=0,i=!1,w3_select_enum(e,function(t){i||(o=t.disabled&&-1!=t.value?(a=o?a+" "+t.innerHTML:t.innerHTML,1):0,t.value!=n||t.disabled||(i=!0,nt.mode="cw",nt.menu_s[_].includes("DSC")?(nt.cf=nt.cf_dsc,nt.type=nt.TYPE_DSC,nt.framing="7/3",nt.encoding="DSC",nt.inverted=1):(nt.menu_s[_].includes("Selcall")?(nt.mode="usb",nt.cf=a.includes("Beacons")?nt.cf_selcall_low:nt.cf_selcall,nt.type=nt.TYPE_SELCALL,nt.framing="7/3",nt.encoding="Selcall"):(nt.cf=nt.cf_navtex,nt.type=nt.TYPE_NAVTEX,nt.framing="4/7",nt.encoding="CCIR476"),nt.inverted=0),nt.freq_s=t.innerHTML,console.log("navtex_pre_select_cb opt.val="+t.value+" freq_s="+nt.freq_s),nt.freq=parseFloat(nt.freq_s),ext_tune(nt.freq,nt.mode,nt.auto_zoom?ext_zoom.ABS:ext_zoom.CUR,navtex_auto_zoom(nt.shift)),navtex_setup(),t=nt.shift/2+nt.pb_skirt_width,console.log("navtex_pre_select_cb cf="+nt.cf+" pb_half="+t),ext_set_passband(nt.cf-t,nt.cf+t),ext_tune(nt.freq,nt.mode,nt.auto_zoom?ext_zoom.ABS:ext_zoom.CUR,navtex_auto_zoom(nt.shift)),console.log("navtex_pre_select_cb path="+e+" idx="+n),w3_select_value(e,n),w3_el("id-navtex-station").innerHTML="<b>"+nt.menu_s[_]+", "+a+"</b>",a.includes("Beacons")&&navtex_show_cb("id-nt.show",nt.SHOW_SPLIT)))}),navtex_clear_menus(_))}function navtex_clear_menus(t){console.log("navtex_clear_menus except="+t);for(var e=0;e<nt.n_menu;e++)isArg(t)&&e==t||w3_select_value("nt.menu"+e,-1)}function navtex_log_mins_cb(t,e){nt.log_mins=w3_clamp(+e,0,1440,0),console.log("navtex_log_mins_cb path="+t+" val="+e+" log_mins="+nt.log_mins),w3_set_value(t,nt.log_mins),kiwi_clearInterval(nt.log_interval),0!=nt.log_mins&&(console.log("NAVTEX logging.."),nt.log_interval=setInterval(function(){navtex_log_cb()},6e4*nt.log_mins))}function navtex_log_cb(){var t=kiwi_host()+"_"+(new Date).toISOString().replace(/:/g,"_").replace(/\.[0-9]+Z$/,"Z")+"_"+w3_el("id-freq-input").value+"_"+cur_mode,e=new Blob([nt.log_txt],{type:"text/plain"}),n=document.createElement("a");n.style="display: none",n.href=window.URL.createObjectURL(e),n.download=(nt.type==nt.TYPE_DSC?"DSC.":"NAVTEX.")+t+".log.txt",document.body.appendChild(n),console.log("navtex_log: "+n.download),n.click(),window.URL.revokeObjectURL(n.href),document.body.removeChild(n)}function NAVTEX_environment_changed(t){var e;t.passband_screen_location&&(navtex_crosshairs(1),(t.freq||t.mode)&&(e=ext_get_freq()/1e3,t=ext_get_mode(),(1<Math.abs(nt.freq-e)||t!=(nt.type==nt.TYPE_SELCALL?"usb":"cw"))&&(navtex_clear_menus(),w3_el("id-navtex-station").innerHTML="&nbsp;")))}function navtex_mode_cb(t,e,n){n||(e=+e,w3_select_value(t,e),nt.dx=nt.show_raw=nt.show_errs=0,e===nt.MODE_DX&&(nt.dx=1),navtex_setup())}function navtex_dsc_mode_cb(t,e,n){n||(e=+e,w3_select_value(t,e),nt.show_raw=nt.show_errs=0,e===nt.MODE_SHOW_ERRS&&(nt.show_errs=1),navtex_setup())}function navtex_selcall_mode_cb(t,e,n){if(!n){switch(e=+e,w3_select_value(t,e),nt.show_raw=nt.show_errs=0,e){case nt.MODE_SHOW_ERRS:nt.show_errs=1;break;case nt.MODE_SHOW_RAW:nt.show_raw=1;break;case nt.MODE_SHOW_BOTH:nt.show_errs=nt.show_raw=1}navtex_setup()}}function navtex_auto_zoom_cb(t,e,n){n||(e=e?1:0,nt.auto_zoom=e,w3_checkbox_set(t,e))}function navtex_clear_button_cb(t,e,n){n||(navtex_console_status_msg_p.s=encodeURIComponent("\f"),kiwi_output_msg("id-navtex-console-msgs","id-navtex-console-msg",navtex_console_status_msg_p),nt.log_txt="",nt.show!=nt.SHOW_MAP&&nt.show!=nt.SHOW_SPLIT||navtex_clear_old_cb("",2))}function navtex_show_cb(t,e,n){n||(e=+e,nt.show=e,w3_set_value(t,e),w3_hide2("id-navtex-msgs",e==nt.SHOW_MAP),w3_hide2("id-navtex-map",e==nt.SHOW_MSGS),w3_el("id-navtex-msgs").style.top=px(e==nt.SHOW_SPLIT?nt.dataH-nt.splitH:0),w3_el("id-navtex-msgs").style.height=px(e==nt.SHOW_SPLIT?nt.splitH:nt.dataH),e==nt.SHOW_SPLIT&&w3_scrollDown("id-navtex-console-msg"))}function navtex_day_night_visible_cb(t,e,n){n||nt.kmap.day_night&&(e=w3_checkbox_get(t),kiwi_map_day_night_visible(nt.kmap,e))}function navtex_graticule_visible_cb(t,e,n){n||nt.kmap.graticule&&(e=w3_checkbox_get(t),kiwi_map_graticule_visible(nt.kmap,e))}function navtex_locations_visible_cb(t,e,n){n||(nt.locations_visible=e,kiwi_map_markers_visible("id-navtex-location",e))}function navtex_clear_old_cb(t,e,n){var _,a;+e&&(_=2==+e,a=Date.now()-60*nt.too_old_min*1e3,w3_obj_enum(nt.locations,function(t,e,n){!_&&n.upd>a||(console.log("LOC-CLR "+n.loc_name),n.mkr.remove(),delete nt.locations[n.loc_name])}))}function navtex_location_update(e,t,n,_,a){var o,i,l,s,c=nt.locations[e]?((c=(s=nt.locations[e]).mkr).setLatLng([t,n]),o=s.pos.push([t,n]),s.el&&(s.el.style.background=s.orig_bg),i=Date.now(),l=Math.floor((i-s.upd)/6e4%60),s.upd=i,console.log("LOC-UPD "+e+" "+t.toFixed(2)+" "+n.toFixed(2)+" #"+o+" "+l+"m"),!0):(console.log("LOC-NEW "+e+" "+t.toFixed(2)+" "+n.toFixed(2)),c=kiwi_map_add_marker_div(nt.kmap,kmap.NO_ADD_TO_MAP,[t,n],"",[12,12],[0,0],1),s={loc_name:e,mkr:c,upd:Date.now(),pos:[]},nt.test_location&&e.startsWith("ABC")&&(s.upd-=60*(nt.too_old_min+10)*1e3),s.pos.push([t,n]),nt.locations[e]=s,kiwi_style_marker(nt.kmap,kmap.ADD_TO_MAP,c,e,"id-navtex-location id-navtex-location-"+e+(nt.locations_visible?"":" w3-hide"),kmap.DIR_RIGHT,function(t){w3_iterate_classname("id-navtex-location-"+e,function(t){var e,n;t&&(s.el=t,e=a?a[0]:"white",n=a?a[1]:"blue",w3_color(t,e,n),s.orig_bg=n,t.addEventListener("mouseenter",function(t){t=t.target;nt.saved_color=t.style.color,nt.saved_bkg=t.style.background,t.style.color="black",t.style.background="yellow",t.style.zIndex=9001}),t.addEventListener("mouseleave",function(t){t=t.target;t.style.color=nt.saved_color,t.style.background=nt.saved_bkg,t.style.zIndex=9e3}),t.addEventListener("click",function(t){var e;console.log("*click*"),_&&((e=document.createElement("a")).setAttribute("href",_),e.setAttribute("target","_blank"),document.body.appendChild(e),console.log(e),e.click(),document.body.removeChild(e))}))})}),!1);return c}function navtex_test_cb(t,e,n){ext_send("SET test")}function NAVTEX_blur(){ext_unregister_audio_data_cb(),ext_set_mode(nt.saved_mode),navtex_crosshairs(0),kiwi_clearInterval(nt.log_interval),kiwi_clearInterval(nt.locations_age_interval),kiwi_map_blur(nt.kmap)}function NAVTEX_config_html(){var t=w3_inline_percent("w3-container",w3_div("w3-restart",w3_input_get("","Test filename","navtex.test_file","w3_string_set_cfg_cb","NAVTEX.test.12k.au")),40);ext_config_html(nt,"navtex","NAVTEX","NAVTEX configuration",t)}



