

/* web/extensions/NAVTEX/NAVTEX.min.js (web/extensions/NAVTEX/NAVTEX.js = Fri May 27 08:29:56 2022) */
var nt={ext_name:"NAVTEX",first_time:!0,dataH:300,ctrlW:550,ctrlH:175,lhs:150,tw:1024,x:0,last_y:[],n_menu:3,menu0:-1,menu1:-1,menu2:-1,mode:0,mode_s:["normal","DX"],dsc_mode:0,dsc_mode_s:["normal","show errs"],MODE_DECODE:0,MODE_DX:1,MODE_SHOW_ERRS:1,show_errs:0,type:0,TYPE_NAVTEX:0,TYPE_DSC:1,decode:1,freq:0,freq_s:"",cf:500,shift:170,baud:100,framing:"4/7",inverted:0,encoding:"CCIR476",dx:0,dxn:80,fifo:[],run:0,single:0,decim:4,sample_count:0,edge:0,log_mins:0,log_interval:null,log_txt:"",last_last:0};function NAVTEX_main(){ext_switch_to_client(nt.ext_name,nt.first_time,navtex_recv),nt.first_time||navtex_controls_setup(),nt.first_time=!1}function navtex_recv(t){if("DAT"!=arrayBufferToStringLen(t,3))for(var e=arrayBufferToString(t).substring(4).split(" "),n=0;n<e.length;n++){var _=e[n].split("=");switch(_[0]){case"ready":kiwi_load_js_dir("extensions/FSK/",["JNX.js","BiQuadraticFilter.js","CCIR476.js","DSC.js"],"navtex_controls_setup");break;case"test_done":break;default:console.log("navtex_recv: UNKNOWN CMD "+_[0])}}else{var a=new Uint8Array(t,4),i=a[0],s=a.length-1;console.log("navtex_recv: DATA UNKNOWN cmd="+i+" len="+s)}}function navtex_baud_error_init(){var t=nt.th/2,e=navtex_canvas.ctx;e.fillStyle="white",e.font="14px Verdana",e.fillText("Baud",nt.lhs/2-15,t),e.fillText("Error",nt.lhs/2-15,t+14)}function navtex_baud_error(t){t>8&&(t=8),t<-8&&(t=-8);var e=Math.round(.4*nt.th/2*t/8),n=nt.lhs-40,_=nt.th/2,a=navtex_canvas.ctx;a.fillStyle="black",a.fillRect(n,0,20,nt.th),e>0?(a.fillStyle="lime",a.fillRect(n,_-e,20,e)):(a.fillStyle="red",a.fillRect(n,_,20,-e))}var navtex_canvas,navtex_console_status_msg_p={scroll_only_at_bottom:!0,process_return_alone:!1,remove_returns:!0,ncol:135};function navtex_output_char(t){if(nt.type==nt.TYPE_NAVTEX&&nt.dx){"\r"!=t&&"\n"!=t||(t=" "),nt.fifo.push(t);var e=nt.fifo.join("");if(e.startsWith("ZCZC"))t="",nt.dx_tail&&(t+=" ...\n"),t+=(new Date).toUTCString().substr(5,20)+" UTC | ",""!=nt.freq_s&&(t+=nt.freq_s+" | "),t+=e.substr(0,9)+" | ",nt.fifo=[],nt.dx_tail=nt.dxn;else{for(;nt.fifo.length>9;)nt.fifo.shift();if(!nt.dx_tail)return;if(nt.dx_tail==nt.dxn&&" "==t)return;nt.dx_tail--,0==nt.dx_tail&&(t+=" ...\n")}}navtex_console_status_msg_p.s=encodeURIComponent(t),nt.log_txt+=kiwi_remove_escape_sequences(kiwi_decodeURIComponent("NAVTEX",t)),kiwi_output_msg("id-navtex-console-msgs","id-navtex-console-msg",navtex_console_status_msg_p)}function navtex_audio_data_cb(t,e){nt.jnx.process_data(t,e)}var navtex_menu_s=["NAVTEX MF","NAVTEX HF","DSC HF"],navtex_MF={International:[518],National:[490],Other:[424,426,472,500]},navtex_HF={Main:[4209.5],NBDP:[4210,6314,8416.5,12779,16806.5,19680.5,22376],Aux:[3165,4212.5,4215,4228,4241,4255,4323,4560,6326,6328,6360.5,6405,6425,6448,6460,8417.5,8424,8425.5,8431,8431.5,8433,8451,8454,8473,8580,8595,8643,12581.5,12599.5,12603,12631,12637.5,12654,12709.9,12729,12799.5,12825,12877.5,13050,16886,16898.5,16927,16974,17045,17175.2,17155]},DSC_HF={"Distress &amp;_Urgency":[2187.5,4207.5,6312,8414.5,12577,16804.5],"Ship/ship_calling":[2177]};function navtex_controls_setup(){nt.th=nt.dataH,nt.saved_mode=ext_get_mode(),nt.jnx=new JNX,nt.freq=ext_get_freq()/1e3,nt.jnx.set_baud_error_cb(navtex_baud_error),nt.jnx.set_output_char_cb(navtex_output_char);var t=time_display_html("navtex")+w3_div("id-navtex-data|width:"+px(nt.lhs+1024)+"; height:"+px(nt.dataH)+"; overflow:hidden; position:relative; background-color:black;",'<canvas id="id-navtex-canvas" width='+dq(nt.lhs+1024)+" height="+dq(nt.dataH)+' style="left:0; position:absolute"></canvas>',w3_div("id-navtex-console-msg w3-text-output w3-scroll-down w3-small w3-text-black|left:"+px(nt.lhs)+"; width:1024px; position:relative; overflow-x:hidden;",'<pre><code id="id-navtex-console-msgs"></code></pre>')),e=w3_div("id-navtex-controls w3-text-white",w3_divs("/w3-tspace-8",w3_col_percent("",w3_div("w3-medium w3-text-aqua",'<b><a href="https://en.wikipedia.org/wiki/Navtex" target="_blank">NAVTEX</a> / <a href="https://en.wikipedia.org/wiki/Digital_selective_calling" target="_blank">DSC</a> decoder</b>'),45,w3_div("",'From <b><a href="https://arachnoid.com/JNX/index.html" target="_blank">JNX</a></b> by P. Lutus &copy; 2011'),55),w3_col_percent("",w3_div("id-navtex-station w3-text-css-yellow","&nbsp;"),50,w3_div("",'NAVTEX schedules: <a href="http://www.dxinfocentre.com/navtex.htm" target="_blank">MF</a>, <a href="http://www.dxinfocentre.com/maritimesafetyinfo.htm" target="_blank">HF</a>'),50),w3_inline("/w3-margin-between-16",w3_select_hier("w3-text-red","NAVTEX MF","select","nt.menu0",nt.menu0,navtex_MF,"navtex_pre_select_cb"),w3_select_hier("w3-text-red","NAVTEX HF","select","nt.menu1",nt.menu1,navtex_HF,"navtex_pre_select_cb"),w3_select_hier("w3-text-red","DSC HF","select","nt.menu2",nt.menu2,DSC_HF,"navtex_pre_select_cb")),w3_inline("/w3-margin-between-16",w3_button("w3-padding-smaller","Next","w3_select_next_prev_cb",{dir:w3_MENU_NEXT,id:"nt.menu",func:"navtex_pre_select_cb"}),w3_button("w3-padding-smaller","Prev","w3_select_next_prev_cb",{dir:w3_MENU_PREV,id:"nt.menu",func:"navtex_pre_select_cb"}),w3_select("w3-text-red","","NAVTEX","nt.mode",0,nt.mode_s,"navtex_mode_cb"),w3_select("w3-text-red","","DSC","nt.dsc_mode",0,nt.dsc_mode_s,"navtex_dsc_mode_cb"),w3_button("w3-padding-smaller w3-css-yellow","Clear","navtex_clear_button_cb",0),w3_button("id-navtex-log w3-padding-smaller w3-purple","Log","navtex_log_cb"),cfg.navtex.test_file?w3_button("w3-padding-smaller w3-aqua","Test","navtex_test_cb"):"",w3_input("id-navtex-log-mins/w3-label-not-bold/w3-ext-retain-input-focus|padding:0;width:auto|size=4","log min","nt.log_mins",nt.log_mins,"navtex_log_mins_cb"))));ext_panel_show(e,t,null),time_display_setup("navtex"),(navtex_canvas=w3_el("id-navtex-canvas")).ctx=navtex_canvas.getContext("2d");var n=nt.url_params=ext_param();if(console.log("NAVTEX url_params="+n),n&&(n=n.split(",")).forEach(function(t,e){var n;w3_ext_param("dx",t).match?navtex_mode_cb("id-nt.mode",nt.MODE_DX):w3_ext_param("errors",t).match?navtex_dsc_mode_cb("id-nt.dsc_mode",nt.MODE_SHOW_ERRS):(n=w3_ext_param("log_time",t)).match?isNumber(n.num)&&navtex_log_mins_cb("id-nt.log_mins",n.num):cfg.navtex.test_file&&w3_ext_param("test",t).match?ext_send("SET test"):w3_ext_param("help",t).match&&extint_help_click()}),navtex_setup(),navtex_baud_error_init(),ext_set_data_height(nt.dataH),ext_set_controls_width_height(nt.ctrlW,nt.ctrlH),nt.url_params){var _=parseFloat(nt.url_params);if(!isNaN(_))for(var a=!1,i=0;i<nt.n_menu;i++){var s="nt.menu"+i;if(w3_select_enum(s,function(t){parseFloat(t.innerHTML)==_&&(navtex_pre_select_cb(s,t.value,!1),a=!0)}),a)break}}ext_register_audio_data_cb(navtex_audio_data_cb)}function navtex_setup(){nt.freq=ext_get_freq()/1e3,console.log("NAVTEX/DSC SETUP freq="+nt.freq+" cf="+nt.cf+" shift="+nt.shift+" baud="+nt.baud+" framing="+nt.framing+" enc="+nt.encoding+" inv="+nt.inverted+" show_errs="+nt.show_errs),nt.jnx.setup_values(ext_sample_rate(),nt.cf,nt.shift,nt.baud,nt.framing,nt.inverted,nt.encoding,nt.show_errs),navtex_crosshairs(1)}function navtex_crosshairs(t){var e=canvas_annotation.ctx;if(e.clearRect(0,0,window.innerWidth,24),t&&ext_get_zoom()>=10)for(var n=ext_get_freq(),_=get_visible_freq_range(),a=scale_px_from_freq(n-nt.shift/2,_),i=scale_px_from_freq(n+nt.shift/2,_),s=0;s<6;s++){var o=3*s;e.fillStyle=1&s?"black":"white",e.fillRect(a-3,o,3,3),e.fillRect(i-3,o,3,3),e.fillStyle=1&s?"white":"black",e.fillRect(a,o,3,3),e.fillRect(i,o,3,3)}}function navtex_pre_select_cb(t,e,n){if(!n){e=+e;var _,a=parseInt(t.split("nt.menu")[1]),i=0,s=!1;w3_select_enum(t,function(n){if(!s&&(n.disabled&&-1!=n.value?(_=i?_+" "+n.innerHTML:n.innerHTML,i=1):i=0,n.value==e&&!n.disabled)){s=!0,nt.freq_s=n.innerHTML,nt.freq=parseFloat(nt.freq_s),ext_tune(nt.freq,"cw",ext_zoom.ABS,13),navtex_menu_s[a].includes("DSC")?(nt.type=nt.TYPE_DSC,nt.framing="7/3",nt.encoding="DSC",nt.inverted=1):(nt.type=nt.TYPE_NAVTEX,nt.framing="4/7",nt.encoding="CCIR476",nt.inverted=0),navtex_setup();var o=nt.shift/2+50;ext_set_passband(nt.cf-o,nt.cf+o),ext_tune(nt.freq,"cw",ext_zoom.ABS,13),w3_select_value(t,e),w3_el("id-navtex-station").innerHTML="<b>"+navtex_menu_s[a]+", "+_+"</b>"}}),navtex_clear_menus(a)}}function navtex_clear_menus(t){for(var e=0;e<nt.n_menu;e++)isArg(t)&&e==t||w3_select_value("nt.menu"+e,-1)}function navtex_log_mins_cb(t,e){nt.log_mins=w3_clamp(+e,0,1440,0),console.log("navtex_log_mins_cb path="+t+" val="+e+" log_mins="+nt.log_mins),w3_set_value(t,nt.log_mins),kiwi_clearInterval(nt.log_interval),0!=nt.log_mins&&(console.log("NAVTEX logging.."),nt.log_interval=setInterval(function(){navtex_log_cb()},6e4*nt.log_mins))}function navtex_log_cb(){var t=kiwi_host()+"_"+(new Date).toISOString().replace(/:/g,"_").replace(/\.[0-9]+Z$/,"Z")+"_"+w3_el("id-freq-input").value+"_"+cur_mode,e=new Blob([nt.log_txt],{type:"text/plain"}),n=document.createElement("a");n.style="display: none",n.href=window.URL.createObjectURL(e),n.download="NAVTEX."+t+".log.txt",document.body.appendChild(n),console.log("navtex_log: "+n.download),n.click(),window.URL.revokeObjectURL(n.href),document.body.removeChild(n)}function NAVTEX_environment_changed(t){if(t.passband_screen_location&&(navtex_crosshairs(1),t.freq||t.mode)){var e=ext_get_freq()/1e3,n=ext_get_mode();nt.freq==e&&"cw"==n||(navtex_clear_menus(),w3_el("id-navtex-station").innerHTML="&nbsp;")}}function navtex_mode_cb(t,e,n){if(!n)switch(e=+e,w3_select_value(t,e),nt.decode=nt.dx=0,e){case nt.MODE_DECODE:default:nt.decode=1;break;case nt.MODE_DX:nt.dx=1}}function navtex_dsc_mode_cb(t,e,n){if(!n){switch(e=+e,w3_select_value(t,e),nt.decode=nt.show_errs=0,e){case nt.MODE_DECODE:default:nt.decode=1;break;case nt.MODE_SHOW_ERRS:nt.show_errs=1}navtex_setup()}}function navtex_clear_button_cb(t,e,n){n||(navtex_console_status_msg_p.s=encodeURIComponent("\f"),kiwi_output_msg("id-navtex-console-msgs","id-navtex-console-msg",navtex_console_status_msg_p),nt.log_txt="")}function navtex_single_cb(t,e,n){n||(nt.single&&(nt.run=1),nt.single^=1,w3_innerHTML(t,nt.single?"Run":"Single"))}function navtex_test_cb(t,e,n){ext_send("SET test")}function NAVTEX_blur(){ext_unregister_audio_data_cb(),ext_set_mode(nt.saved_mode),navtex_crosshairs(0),kiwi_clearInterval(nt.log_interval)}function NAVTEX_config_html(){var t=w3_inline_percent("w3-container",w3_div("w3-restart",w3_input_get("","Test filename","navtex.test_file","w3_string_set_cfg_cb","NAVTEX.test.12k.au")),40);ext_config_html(nt,"navtex","NAVTEX","NAVTEX configuration",t)}


