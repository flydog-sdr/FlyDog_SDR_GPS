

/* web/extensions/wspr/wspr.min.js (web/extensions/wspr/wspr.js = Sun Apr 16 13:42:44 2023) */
var wspr={ext_name:"wspr",first_time:!0,focus_interval:null,server_time_ms:0,local_time_epoch_ms:0,pie_size:25,stack_decoder:0,debug:0,upload:!0,upload_lockout:!1,pie_interval:null,testing:!1,hop_period:20,SYNC:!0,NO_SYNC:!1,autorun_u:["regular use","LF","MF","160m","80m_JA","80m","60m","60m_EU","40m","30m","20m","17m","15m","12m","10m","6m","4m","2m","440","1296","ISM_6","ISM_13","IWBP"],PREEMPT_NO:0,PREEMPT_YES:1,preempt_u:["no","yes"],last_last:0},wspr_canvas_width=1024;function wspr_main(){ext_switch_to_client(wspr.ext_name,wspr.first_time,wspr_recv),wspr.first_time||wspr_controls_setup(),wspr.first_time=!1}var wspr_bins,wspr_startx,wspr_cmd_e={WSPR_DATA:0},wspr_cmd_d={0:"WSPR_DATA"},aw_ypos=0,y_tstamp=-1,span=0,over=16;function wspr_scroll(){var e=wccva.height;wccva.style.top=e-aw_ypos+"px",wccvao.style.top=-aw_ypos+"px",e<=++aw_ypos&&(aw_ypos=0,e=wccvao,wccvao=wccva,wccva=e)}var WSPR_F_BIN=4095,WSPR_F_DECODING=4096,WSPR_F_DELETE=8192,WSPR_F_DECODED=16384,WSPR_F_IMAGE=32768;function wspr_recv(e){if("DAT"!=arrayBufferToStringLen(e,3)){var r=arrayBufferToString(e).substring(4).split(" ");for(b=0;b<r.length;b++){var t=r[b].split("=");switch(0,t[0]){case"ready":var s=parseInt(ext_get_cfg_param("WSPR.BFO",wspr_bfo));isNaN(s)||(wspr_bfo=s),ext_send("SET BFO="+wspr_bfo.toFixed(0)),wspr_controls_setup(),ext_send("SET stack_decoder="+wspr.stack_decoder),ext_send("SET debug="+wspr.debug);break;case"WSPR_TIME_MSEC":wspr.server_time_ms=1e3*t[1]+ +t[2],wspr.local_time_epoch_ms=Date.now();break;case"WSPR_SYNC":break;case"WSPR_STATUS":wspr_set_status(parseInt(t[1]));break;case"WSPR_DECODED":var i=decodeURIComponent(t[1]),_=w3_el("id-wspr-decode"),a=w3_isScrolledDown(_);_.innerHTML+=i+"<br>",a&&w3_scrollDown(_);break;case"WSPR_UPLOAD":i=decodeURIComponent(t[1]),wspr_upload(wspr_report_e.SPOT,i);break;case"WSPR_PEAKS":var w,n=0;""!=(i=decodeURIComponent(t[1]))&&(w=i.split(":")).length&&(n=(w.length-1)/2);for(b=0;b<n;b++){var p=parseInt(w[2*b]),o=p&~WSPR_F_BIN;if(p&=WSPR_F_BIN,!(o&WSPR_F_DELETE)){var c,l=wspr_startx+2*p;if(wspr_canvas_width<l)break;c=b<n-1?wspr_startx+2*parseInt(w[2*(b+1)]):wspr_canvas_width,wspr_canvas_width<=c&&(c=wspr_canvas_width+256);var d=w[2*b+1],p=d.filterInt(),o=isNaN(p)?o&WSPR_F_IMAGE?"cl-wspr-image":"cl-wspr-call":(d=p.toFixed(0),o&WSPR_F_DECODING?"cl-wspr-decoding":"");i+=w3_div("cl-wspr-mkr1|max-width:"+(c-l)+"px; left:"+(l-6)+"px; bottom:8px",w3_div("cl-wspr-mkr2",w3_div("cl-wspr-snr "+o,d)))+w3_div("cl-wspr-line "+o+"|width:1px; height:10px; position:absolute; left:"+l+"px; bottom:0px;")}}w3_el("id-wspr-peaks-labels").innerHTML=i;break;case"nbins":wspr_bins=parseInt(t[1]),wspr_startx=Math.round((wspr_canvas_width-2*wspr_bins)/2);break;case"bar_pct":wspr.testing&&(a=w3_clamp(parseInt(t[1]),0,100),(_=w3_el("id-wspr-bar"))&&(_.style.width=a+"%"));break;case"test_start":wspr_test_cb("",1);break;case"test_done":wspr.testing&&(w3_hide("id-wspr-bar-container"),w3_show_inline("id-wspr-upload-container"));break;default:console.log("wspr_recv: UNKNOWN CMD "+t[0])}}}else{var u=new Uint8Array(e,4),g=u[0];if(g==wspr_cmd_e.WSPR_DATA){var m=u.length-2,f=wccva.height;u[1]&&(y_tstamp=aw_ypos+12,wccva.ct.fillStyle="white",wccva.ct.fillRect(wspr_startx-over,aw_ypos,2*m+2*over,1),wspr_scroll());for(var h=wccva.im,b=0;b<m;b++){var v=u[2+b];for((v=255<v?255:v)<0&&(v=0),j=0;j<2;j++){var S=4*(2*b+j+wspr_startx);h.data[S]=color_map_r[v],h.data[1+S]=color_map_g[v],h.data[2+S]=color_map_b[v],h.data[3+S]=255}}wccva.ct.putImageData(h,0,aw_ypos),f<=y_tstamp&&aw_ypos==f-1&&(span=1),y_tstamp!=aw_ypos&&!span||(wccva.ct.fillStyle="white",wccva.ct.font="10px Verdana",e=wspr_server_Date(),wccva.ct.fillText(e.toUTCString().substr(17,5)+" UTC",wspr_startx+2*m+over,y_tstamp),span?(y_tstamp-=f,span=0):y_tstamp=-1),wspr_scroll()}else console.log("wspr_recv: DATA UNKNOWN cmd="+g+" len="+(u.length-1))}}var wspr_spectrum_A,wspr_spectrum_B,wspr_scale_canvas,wccva,wccva0,wspr_report_e={STATUS:0,SPOT:1},wspr_config={deco:1},wspr_config_okay=!0,wspr_init_band=-1;function wspr_controls_setup(){var e=time_display_html("wspr")+w3_div("id-wspr-peaks|width:1024px; height:30px; background-color:black; position:relative;",w3_div("id-wspr-peaks-labels|width:1024px; height:30px; position:absolute;"))+w3_div("id-wspr-spectrum|width:1024px; height:150px; overflow:hidden; position:relative;",'<canvas id="id-wspr-spectrum-A" width="1024" height="150" style="position:absolute">test</canvas>','<canvas id="id-wspr-spectrum-B" width="1024" height="150" style="position:absolute">test</canvas>')+w3_div("id-wspr-scale|width:1024px; height:20px; background-color:black; position:relative;",'<canvas id="id-wspr-scale-canvas" width="1024" height="20" style="position:absolute"></canvas>'),r=ext_get_cfg_param_string("WSPR.callsign","",EXT_NO_SAVE);null!=r&&null!=r&&""!=r||(wspr_config_okay=!(r="(not set)"));var t=kiwi.WSPR_rgrid;null==t||null==t||""==t?(wspr_config_okay=!(t="(not set)"),wspr.grid=""):wspr.grid=t;var s=ext_get_freq_range();if(32e3<s.lo_kHz&&32e3<s.hi_kHz){for(var i,_,a=!1,w=0;w<wspr_xvtr_center_freqs.length;w++)if((i=wspr_xvtr_center_freqs[w])>=s.lo_kHz&&i<=s.hi_kHz){a=!0;break}console.log("found="+a+" i="+w),wspr_center_freqs=[],wspr_freqs_s={},wspr_freqs_m=[],a&&(wspr_center_freqs[0]=i,_=wspr_xvtr_freqs_s[w],wspr_freqs_m=[_],(wspr_freqs_s[_]=0)<wspr_init_band&&(wspr_init_band=0))}t=w3_div("id-wspr-controls",w3_div("id-wspr-controls-top",w3_inline("w3-halign-space-between w3-margin-B-4|width:83%/",w3_div("w3-medium w3-text-aqua cl-viewer-label","<b>WSPR<br>viewer</b>"),w3_select("w3-text-red","","band","wspr_init_band",wspr_init_band,wspr_freqs_m,"wspr_band_select_cb"),w3_button("w3-ext-btn w3-padding-smaller","stop","wspr_stop_start_cb"),w3_button("cl-w3-ext-btn w3-padding-smaller w3-css-yellow","clear","wspr_clear_cb"),w3_button('cl-w3-ext-btn w3-padding-smaller w3-aqua||title="test spots NOT uploaded\nto wsprnet.org"',"test","wspr_test_cb",1),w3_checkbox("id-wspr-upload-container cl-upload-checkbox/w3-label-inline w3-label-not-bold/","upload<br>spots","wspr.upload",!0,"wspr_set_upload_cb"),w3_div("id-wspr-bar-container w3-progress-container w3-round-large w3-white w3-hide|width:70px; height:16px",w3_div("id-wspr-bar w3-progressbar w3-round-large w3-light-green|width:0%","&nbsp;"))),w3_inline("w3-halign-space-between/",w3_div("cl-wspr-pie|background-color:#575757",kiwi_pie("id-wspr-pie",wspr.pie_size,"#eeeeee","deepSkyBlue")),w3_div("",w3_div("id-wspr-time cl-wspr-text"),w3_div("id-wspr-status cl-wspr-text")),w3_div("",w3_div("cl-wspr-text","BFO "+wspr_bfo),w3_div("id-wspr-cf cl-wspr-text")),w3_div("cl-wspr-text","reporter call "+r),w3_div("id-wspr-rgrid cl-wspr-text","reporter grid "+t)),w3_div("|background-color:lightGray; overflow:auto; width:100%; margin-top:5px; margin-bottom:0px; font-family:monospace; font-size:100%",'<pre style="display:inline"> UTC  dB   dT      Freq dF  Call   Grid    km  dBm</pre>')),w3_div("id-wspr-decode|white-space:pre; background-color:white; overflow:scroll; height:100px; width:100%; margin-top:0px; font-family:monospace; font-size:100%"));ext_panel_show(t,e,null);e=waterfall_height(),e=Math.round(.9*e);ext_set_controls_width_height(null,e);e=e-w3_el("id-wspr-controls-top").clientHeight-20;w3_el("id-wspr-decode").style.height=px(e),time_display_setup("wspr"),wspr.saved_mode=ext_get_mode(),(wspr_spectrum_A=w3_el("id-wspr-spectrum-A")).ct=wspr_spectrum_A.getContext("2d"),wspr_spectrum_A.im=wspr_spectrum_A.ct.createImageData(1024,1),(wspr_spectrum_B=w3_el("id-wspr-spectrum-B")).ct=wspr_spectrum_B.getContext("2d"),wspr_spectrum_B.im=wspr_spectrum_B.ct.createImageData(1024,1),wccva=wspr_spectrum_A,wccvao=wspr_spectrum_B,(wspr_scale_canvas=w3_el("id-wspr-scale-canvas")).ct=wspr_scale_canvas.getContext("2d"),wspr.pie_interval=setInterval(wspr_draw_pie,1e3),wspr_draw_pie(),wspr_draw_scale(100),wspr_reset(),wspr_upload_timeout=setTimeout(function(){wspr_upload(wspr_report_e.STATUS)},1e3);e=ext_param();e?(e=e.toLowerCase().split(",")).forEach(function(e,r){var t;0==r&&isDefined(wspr_freqs_s[e])?(t=wspr_freqs_s[e],console.log("<"+e+"> "+r+" sel="+t),(r=wspr_center_freqs[t])>=s.lo_kHz&&r<=s.hi_kHz&&wspr_band_select_cb("wspr_init_band",t,!1)):(e.startsWith("stack")?wspr.stack_decoder=1:e.startsWith("debug")?wspr.debug=1:e.startsWith("noupload")?wspr_set_upload_cb("",!(wspr.upload_lockout=!0)):e.startsWith("help")&&extint_help_click(),console.log("WSPR unknown URL param <"+e+">"))}):-1!=wspr_init_band&&wspr_freq(wspr_init_band)}function wspr_help(e){return e&&(e=w3_text("w3-medium w3-bold w3-text-aqua","WSPR viewer help")+w3_div("w3-margin-T-8 w3-scroll-y|height:90%",w3_div("w3-margin-R-8",'The WSPR viewer was the first Kiwi extension developed. It\'s more of a demonstration than a serious WSPR decoding utility. An older version of the WSJT-X <i>wsprd</i> decoder is used. Together with the limited processing power of the Beagle this means fewer decodes occur compared to the current WSJT-X. For serious decoding try <a href="http://wsprdaemon.org/index.html" target="_blank">WsprDaemon</a> which runs on a separate computer and makes connections to the Kiwi. <br><br>The <i>band</i> menu contains the standard <a href="http://www.wsprnet.org" target="_blank">ham band frequencies</a> plus the ISM 6/13 MHz bands. Frequency hopping specified by the <a href="https://github.com/HB9VQQ/WSPRBeacon" target="_blank">International WSPR Beacon Project</a> (IWBP) is also supported. <br><br>About dial frequencies: By default the WSPR extension uses a BFO value of 750 Hz instead of the more traditional 1500 Hz (this value is set by the Kiwi owner on the admin page). This lower tone gives less listening fatigue. But it means the number shown in the Kiwi frequency entry box (dial frequency) must be reduced by 750 Hz to match the dial frequencies mentioned in the references above. The BFO value and center frequency (CF) of the passband are displayed in the WSPR control panel. <br><br>Before spots will be uploaded to wsprnet.org the reporter <i>call</i> and <i>grid</i> must be set on the admin page (Extensions > WSPR) and <i>upload spots</i> checked. WSPR decoding still occurs even though spots are not being uploaded. <br><br>Test button: Click when the time clock just becomes fully blue (i.e. at the beginning of an even minute). A two minutes test recording will be played back containing 8 spots. These spots will <b>not</b> be uploaded to wsprnet.org &nbsp;The recording was made with a BFO of 750 Hz, but will still decode even if the Kiwi is configured for another BFO value. <br><br>The decoder column values are the same as with other WSPR programs:<ul><li><i>dB</i> is signal-to-noise ratio (SNR), negative values meaning below the noise floor.</li><li><i>dt</i> and <i>dF</i> indicate how far off the signal is in time and frequency.</li><li><i>Freq</i> is the signal\'s passband frequency as seen in the spectrum display.</li><li><i>km</i> is the signal\'s distance from the receiving Kiwi.</li><li><i>dBm</i> is the transmit power reported by the WSPR beacon.</li></ul>URL parameters: <br>First parameter can be an entry from the band menu, e.g. <i>ext=wspr,40m</i> <br><br>')),confirmation_show_content(e,610,300),w3_el("id-confirmation-container").style.height="100%"),!0}function wspr_band_select_cb(e,r,t){-1==(r=+r)||t||(w3_set_value(e,r),wspr_freq(wspr_init_band=r))}function wspr_focus(){}function wspr_blur(){ext_send("SET capture=0"),kiwi_clearTimeout(wspr_upload_timeout),kiwi_clearInterval(wspr.pie_interval),ext_set_mode(wspr.saved_mode)}function wspr_input_grid_cb(e,r,t){r=r.trim(),w3_string_set_cfg_cb(e,r),kiwi.WSPR_rgrid=wspr.grid=r}function wspr_config_html(){var e=w3_div("w3-show-inline-block w3-width-full",w3_col_percent("w3-container/w3-margin-bottom",w3_divs("w3-restart",w3_input_get("","Reporter callsign","WSPR.callsign","w3_string_set_cfg_cb","")),22,"",3,w3_divs("w3-restart",w3_input_get("",w3_label("w3-bold","Reporter grid square ")+w3_div("id-wspr-grid-set cl-admin-check w3-blue w3-btn w3-round-large w3-hide","set from GPS"),"WSPR.grid","wspr_input_grid_cb","","4 or 6-character grid square location")),22,"",3,w3_div("w3-restart",w3_input_get("","BFO Hz (multiple of 375 Hz)","WSPR.BFO","w3_num_set_cfg_cb","","typically 750 Hz")),22,"",3,w3_div("w3-restart",w3_input_get("","Test filename","WSPR.test_file","w3_string_set_cfg_cb","WSPR.test.au")),22,""),w3_col_percent("w3-container w3-margin-T-8 w3-margin-B-16/",w3_divs("w3-center w3-tspace-8",w3_switch_label("w3-center","Update grid continuously<br>from GPS?","Yes","No","cfg.WSPR.GPS_update_grid",cfg.WSPR.GPS_update_grid,"admin_radio_YN_cb"),w3_text("w3-text-black w3-center","Useful for Kiwis in motion <br> (e.g. marine mobile)")),22,"&nbsp;",3,w3_divs("w3-center w3-tspace-8",w3_switch_label("w3-center","Log decodes to<br>syslog?","Yes","No","cfg.WSPR.syslog",cfg.WSPR.syslog,"admin_radio_YN_cb"),w3_text("w3-text-black w3-center","Use with care as over time <br> filesystem can fill up.")),22,"&nbsp;",3,w3_divs("w3-center w3-tspace-8",w3_switch_label("w3-center","Log spot debug<br>info?","Yes","No","cfg.WSPR.spot_log",cfg.WSPR.spot_log,"admin_radio_YN_cb"),w3_text("w3-text-black w3-center","Logs the actual upload commands<br>used to assist in spot debugging.")),22),"<hr>",w3_div("w3-container",w3_div("","<b>Autorun</b>"),w3_div("w3-container",w3_div("w3-text-black",'On startup automatically begins running the WSPR decoder on the selected band(s).<br>Channels available for regular use are reduced by one for each WSPR autorun enabled.<br>If Kiwi has been configured for a mix of channels with and without waterfalls then channels without waterfalls will be used first.<br><br>Spot decodes are available in the Kiwi log (use "Log" tab above) and are listed on <a href="http://wsprnet.org/drupal/wsprnet/spots" target="_blank">wsprnet.org</a><br>The "Reporter" fields above must be set to valid values for proper spot entry into the <a href="http://wsprnet.org/drupal/wsprnet/spots" target="_blank">wsprnet.org</a> database.'),w3_div("w3-margin-T-10 w3-valign",'<header class="id-wspr-warn-full w3-container w3-yellow"><h6>If your Kiwi is publicly listed you must <b>not</b> configure all the channels to use WSPR-autorun!<br>This defeats the purpose of making your Kiwi public and public registration will be disabled<br>until you make at least one channel available for connection. Check the Admin Public tab.</h6></header>'),w3_button("id-wspr-restart w3-margin-T-16 w3-aqua w3-hide","autorun restart","wspr_autorun_restart_cb"),w3_div("id-wspr-admin-autorun w3-margin-T-16"))));ext_config_html(wspr,"WSPR","WSPR","WSPR configuration",e);for(var e="",r=0;r<rx_chans;){for(var t="",s=0;s<8&&r<rx_chans;s++,r++)t+=w3_div("",w3_select_get_param("w3-margin-right","Autorun "+r,"WSPR band","WSPR.autorun"+r,wspr.autorun_u,"wspr_autorun_select_cb"),w3_select_get_param("w3-margin-right w3-margin-T-8","","preemptible?","WSPR.preempt"+r,wspr.preempt_u,"wspr_autorun_select_cb"));e+=w3_inline("w3-margin-bottom/",t)}w3_innerHTML("id-wspr-admin-autorun",e)}function wspr_autorun_public_check(){for(var e=0,r=0;r<rx_chans;r++)0!=cfg.WSPR["autorun"+r]&&cfg.WSPR["preempt"+r]==wspr.PREEMPT_NO&&e++;ext_set_cfg_param("WSPR.autorun",e,EXT_SAVE);var t=adm.kiwisdr_com_register&&e>=rx_chans;w3_remove_then_add_cond("id-wspr-warn-full",t,"w3-red","w3-yellow"),t&&kiwisdr_com_register_cb("adm.kiwisdr_com_register",w3_SWITCH_NO_IDX)}function wspr_autorun_restart_cb(){wspr_autorun_public_check(),w3_hide("id-wspr-restart"),ext_send("ADM wspr_autorun_restart")}function wspr_autorun_select_cb(e,r,t){admin_select_cb(e,r,t),t||(w3_show("id-wspr-restart"),t=w3_el("id-kiwi-container"),w3_scrollDown(t))}function wspr_config_focus(){wspr_autorun_public_check(),wspr_check_GPS_update_grid(),wspr.focus_interval=setInterval(function(){wspr_check_GPS_update_grid()},1e4);var e=w3_el("id-wspr-grid-set");e&&(e.onclick=function(){wspr.single_shot_update=!0,ext_send("ADM wspr_gps_info")})}function wspr_config_blur(){kiwi_clearInterval(wspr.focus_interval)}function wspr_check_GPS_update_grid(){cfg.WSPR.GPS_update_grid&&cfg.WSPR.grid!=kiwi.WSPR_rgrid&&(w3_set_value("id-WSPR.grid",kiwi.WSPR_rgrid),w3_input_change("WSPR.grid","wspr_input_grid_cb")),kiwi.GPS_fixes&&w3_show_inline_block("id-wspr-grid-set"),wspr.single_shot_update=!1}function wspr_gps_info_cb(e){(cfg.WSPR.GPS_update_grid||wspr.single_shot_update)&&((e=kiwi_JSON_parse("wspr_gps_info_cb",e))&&(kiwi.WSPR_rgrid=e.grid,w3_set_value("id-WSPR.grid",kiwi.WSPR_rgrid),w3_input_change("WSPR.grid","wspr_input_grid_cb")),wspr.single_shot_update=!1)}var wspr_upload_timeout,wspr_stop_start_state=0;function wspr_stop_start_cb(e,r,t){0==wspr_stop_start_state?wspr_reset():-1!=wspr_init_band&&wspr_freq(wspr_init_band),wspr_stop_start_state^=1,w3_button_text(e,wspr_stop_start_state?"start":"stop")}function wspr_test_cb(e,r,t){t||(r=+r,dbgUs&&console.log("wspr_test_cb: val="+r),wspr.testing=r,w3_show_hide("id-wspr-upload-container",!wspr.testing,"w3-show-inline-new"),w3_el("id-wspr-bar").style.width="0%",w3_show_hide("id-wspr-bar-container",wspr.testing),ext_send("SET test="+(r?1:0)))}function wspr_reset(){ext_send("SET capture=0"),wspr_set_status(wspr_status.IDLE),wspr_set_upload_cb("",!0)}function wspr_clear_cb(e,r,t){wspr_reset(),wspr_test_cb("",0),w3_el("id-wspr-decode").innerHTML="",w3_el("id-wspr-peaks-labels").innerHTML=""}function wspr_draw_scale(e){wspr_scale_canvas.ct.fillStyle="black",wspr_scale_canvas.ct.fillRect(0,0,wspr_scale_canvas.width,wspr_scale_canvas.height);wspr_scale_canvas.ct.fillStyle="lime";var r,t=Math.round(512/375*50),s=Math.round(512/375*200);for(wspr_scale_canvas.ct.fillRect(wspr_startx+2*t,2,2*s,3),wspr_scale_canvas.ct.fillStyle="red",t=Math.round(512/375*150),wspr_scale_canvas.ct.fillRect(wspr_startx+2*t-2,2,5,3),wspr_scale_canvas.ct.fillStyle="white",wspr_scale_canvas.ct.font="10px Verdana",r=-150;r<=150;r+=50){var i=Math.round((r+150)*(512/375)),_=r+e;_<0&&(_+=1e3);var a=_<10?4:_<100?7:11;wspr_scale_canvas.ct.fillText(_.toFixed(0),wspr_startx+2*i-a,17)}}function wspr_set_upload_cb(e,r){deleteCookie("wspr_upload"),wspr_config_okay&&!wspr.upload_lockout||(r=!1),wspr.upload=r,w3_checkbox_set("id-wspr.upload",r),w3_color("id-wspr-upload-container",r?"white":"black",r?"inherit":"yellow")}function wspr_upload(e,r){var t,s,i,_=e==wspr_report_e.SPOT?1:0,a=ext_get_cfg_param_string("WSPR.callsign","",EXT_NO_SAVE),w=kiwi.WSPR_rgrid||cfg.WSPR.grid;wspr_rfreq&&wspr_tfreq&&null!=a&&null!=w&&null!=a&&null!=w&&""!=a&&""!=w&&0!=wspr.upload?(_&&(t=r.replace(/[\s]+/g," ").split(" ")),e=kiwi_GETrequest(_?"spot":"stat","http://wsprnet.org/post"),kiwi_GETrequest_param(e,"function",_?"wspr":"wsprstat"),kiwi_GETrequest_param(e,"rcall",a),kiwi_GETrequest_param(e,"rgrid",w),kiwi_GETrequest_param(e,"rqrg",wspr_rfreq.toFixed(6)),i=_?(i=new Date,kiwi_GETrequest_param(e,"date",i.getUTCFullYear().toString().substr(2,2)+(i.getUTCMonth()+1).leadingZeros(2)+i.getUTCDate().leadingZeros(2)),kiwi_GETrequest_param(e,"time",t[0]),kiwi_GETrequest_param(e,"sig",t[1]),kiwi_GETrequest_param(e,"dt",t[2]),kiwi_GETrequest_param(e,"drift",t[4]),s=t[3],t[7]):(kiwi_GETrequest_param(e,"tpct","0"),s=wspr_tfreq.toFixed(6),"0"),kiwi_GETrequest_param(e,"tqrg",s),_&&(kiwi_GETrequest_param(e,"tcall",t[5]),kiwi_GETrequest_param(e,"tgrid","no_grid"!=t[6]?t[6]:"")),kiwi_GETrequest_param(e,"dbm",i),(i="1.4 Kiwi").length<=10&&(kiwi_GETrequest_param(e,"version",i),kiwi_GETrequest_submit(e,{gc:kiwi_gc_wspr}),e=new Date,console.log("WSPR "+(_?"SPOT":"STAT")+" "+e.toUTCString()+(_?" <"+r+">":""))),_||(wspr_upload_timeout=setTimeout(function(){wspr_upload(wspr_report_e.STATUS)},36e4))):wspr_upload_timeout=setTimeout(function(){wspr_upload(wspr_report_e.STATUS)},6e4)}var wspr_cur_status=0,wspr_status={NONE:0,IDLE:1,SYNC:2,RUNNING:3,DECODING:4},wspr_status_text={0:"none",1:"idle",2:"sync",3:"running",4:"decoding"},wspr_status_color={0:"white",1:"lightSkyBlue",2:"violet",3:"cyan",4:"lime"};function wspr_set_status(e){var r=w3_el("id-wspr-status");r.innerHTML=wspr_status_text[e],r.style.backgroundColor=wspr_status_color[e],wspr_cur_status=e}function wspr_server_Date(){return new Date(wspr.server_time_ms+(Date.now()-wspr.local_time_epoch_ms))}function wspr_draw_pie(){var e=wspr_server_Date();w3_el("id-wspr-time").innerHTML=e.toUTCString().substr(17,8)+" UTC";var r=e.getUTCMinutes(),t=60*(1&r)+e.getUTCSeconds()+1;kiwi_draw_pie("id-wspr-pie",wspr.pie_size,t/120);var s,i=kiwi.WSPR_rgrid||cfg.WSPR.grid;w3_innerHTML("id-wspr-rgrid","reporter grid<br>"+i+(cfg.WSPR.GPS_update_grid?" (GPS)":"")),wspr.IWBP&&110==t&&(s=Math.floor(r%wspr.hop_period/2),e=wspr_cf_IWBP[s],i=Math.floor((r+1)%wspr.hop_period/2),t=wspr_cf_IWBP[i],console.log("WSPR IWBP deco: #"+s+"/"+r+"m="+e+" capture: #"+i+"/"+(r+1)%60+"m="+t),wspr_change_freq(t,e,wspr.NO_SYNC))}var wspr_center_freqs=[137.5,475.7,1838.1,3570.1,3594.1,5288.7,5366.2,7040.1,10140.2,14097.1,18106.1,21096.1,24926.1,28126.1,6781.5,13555.4,9999],wspr_freqs_s={lf:0,mf:1,"160m":2,"80m_ja":3,"80m":4,"60m":5,"60m_eu":6,"40m":7,"30m":8,"20m":9,"17m":10,"15m":11,"12m":12,"10m":13,ism_6:14,ism_13:15,iwbp:16},wspr_freqs_m=["LF","MF","160m","80m_JA","80m","60m","60m_EU","40m","30m","20m","17m","15m","12m","10m","ISM_6","ISM_13","IWBP"],wspr_cf_IWBP=[1838.1,3570.1,5288.7,7040.1,10140.2,14097.1,18106.1,21096.1,24926.1,28126.1],wspr_xvtr_center_freqs=[50294.5,70092.5,144490.5,432301.5,1296501.5],wspr_xvtr_freqs_s=["6m","4m","2m","440","1296"],wspr_rfreq=0,wspr_tfreq=0,wspr_bfo=750,wspr_filter_bw=300;function wspr_freq(e){var r;wspr_reset(),wspr_change_freq(e="IWBP"==wspr_freqs_m[e]?(wspr.IWBP=!0,min=wspr_server_Date().getUTCMinutes(),r=Math.floor(min%wspr.hop_period/2),wspr_cf_IWBP[r]):(wspr.IWBP=!1,wspr_center_freqs[e]),e,wspr.SYNC)}function wspr_change_freq(e,r,t){var s=e-wspr_bfo/1e3,i=Math.round(1e3*(e-Math.floor(e))),_=r-wspr_bfo/1e3,a=Math.round(1e3*(r-Math.floor(r)));w3_el("id-wspr-cf").innerHTML="CF "+e.toFixed(1),wspr_rfreq=wspr_tfreq=e/1e3;s-=ext_get_freq_range().offset_kHz;ext_tune(s,"usb",ext_zoom.MAX_IN),ext_set_passband(wspr_bfo-wspr_filter_bw/2,wspr_bfo+wspr_filter_bw/2),ext_tune(s,"usb",ext_zoom.MAX_IN),wspr_draw_scale(i),ext_send("SET dialfreq="+_.toFixed(2)+" centerfreq="+r.toFixed(2)+" cf_offset="+a),t==wspr.SYNC&&ext_send("SET capture=1"),kiwi_clearTimeout(wspr_upload_timeout),wspr_upload_timeout=setTimeout(function(){wspr_upload(wspr_report_e.STATUS)},1e3)}



