

/* web/extensions/FFT/FFT.min.js (web/extensions/FFT/FFT.js = Thu Mar 10 18:00:07 2022) */
var fft_a={KRAS:1,NOVO:2,KHAB:3,REVD:4,SEYD:5,MULT:6},fft={ext_name:"FFT",first_time:!0,update_interval:0,cmd_e:{FFT:0,CLEAR:1},func:1,func_e:{OFF:-1,WF:0,SPEC:1,INTEG:2},func_s:["waterfall","spectrum","integrate"],spec_source_save:0,pre:-1,pre_none:0,pre_ALPHA:1,pre_JJY40:2,pre_RTZ:3,pre_WWVB_MSF_JJY60:4,pre_RBU:5,pre_BPC:6,pre_DCF77:7,pre_s:["none","Alpha (RSDN-20)","40 JJY","50 RTZ","60 WWVB/MSF/JJY","200/3 RBU","68.5 BPC","77.5 DCF77"],itime:10,maxdb:-30,mindb:-115,wf_canvas_i:0,wf_canvas:null,wf1_canvas:null,wf2_canvas:null,actual_line:0,integ_canvas:null,integ_w:1024,integ_th:200,integ_hdr:12,integ_h:0,integ_yo:0,integ_bins:0,integ_bino:0,integ_draw:!1,integ_last_freq:0,integ_last_offset:0,integ_dbl:0,info_canvas:null,alpha_stations:["Krasnodar 38°E","Novosibirsk 84°E","Khabarovsk 136°E","Revda 34°E","Seyda 62°E"],alpha_station_colors:["yellow","red","lime","cyan","magenta"],alpha_sched:{0:["F1","F4/5","F2","F3/p"],1:[11.9,12.09,12.65,14.88],2:[!0,!1,!1,!1],3:[fft_a.NOVO,0,fft_a.REVD,fft_a.KRAS],4:[fft_a.SEYD,fft_a.REVD,fft_a.NOVO,fft_a.KHAB],5:[fft_a.KRAS,fft_a.SEYD,fft_a.KHAB,fft_a.NOVO],6:[fft_a.KHAB,0,fft_a.KRAS,fft_a.MULT],7:[fft_a.REVD,0,0,fft_a.SEYD],8:[0,0,fft_a.SEYD,fft_a.REVD]}};function FFT_main(){ext_switch_to_client(fft.ext_name,fft.first_time,fft_recv),fft.first_time?fft.integ_h=fft.integ_th-fft.integ_hdr:fft_controls_setup(),fft.first_time=!1}function fft_clear(){ext_send("SET clear"),fft.integ_draw=!1;var t=fft.integ_w,f=fft.integ_h,e=fft.integ_th;fft.actual_line=f-1,fft.wf_canvas_i=0,fft.wf_canvas=fft.wf1_canvas;var a=1-f+fft.integ_hdr;fft.wf1_canvas.ctx.clearRect(0,0,t,f),fft.wf1_canvas.top=a,fft.wf1_canvas.style.top=px(a),fft.wf2_canvas.ctx.clearRect(0,0,t,f),fft.wf2_canvas.top=a,fft.wf2_canvas.style.top=px(a);var i=fft.integ_canvas.ctx;fft.func==fft.func_e.WF&&(i.clearRect(0,0,t,e),e=fft.integ_hdr),i.fillStyle="mediumBlue",i.fillRect(0,0,t,e),fft.func==fft.func_e.SPEC&&(spec.clear_avg=!0),(i=fft.info_canvas.ctx).fillStyle="#575757",i.fillRect(0,0,256,280);var _=w3_el("fft-controls-left"),n=w3_el("fft-controls-right");if(fft.pre==fft.pre_ALPHA)ext_set_controls_width_height(525,300),_.style.width="49.9%",n.style.width="49.9%",fft_alpha();else{ext_set_controls_width_height(275,275),_.style.width="0%",n.style.width="100%";var c=ext_get_freq();fft_marker((c/1e3).toFixed(2),!1,c)}ext_send("SET run="+fft.func)}function fft_update(){var t=ext_get_freq(),f=t-ext_get_carrier_freq();t==fft.integ_last_freq&&f==fft.integ_last_offset||(fft_clear(),fft.integ_last_freq=t,fft.integ_last_offset=f)}function fft_marker(t,f,e){var a=fft.integ_canvas.ctx,i=fft.integ_w/ext_sample_rate();t=f?t+"▼":"▼"+t,a.font="12px Verdana",a.fillStyle="white";var _=(e-ext_get_carrier_freq())*i,n=a.measureText("▼").width/2-(f?-1:2),c=Math.round(fft.integ_w/2-1+_+(f?-a.measureText(t).width+n:-n));a.fillText(t,c,10)}function fft_mousedown(t){var f=(t.clientY?t.clientY:t.offsetY?t.offsetY:t.layerY)-fft.integ_yo;if(!(f<0||f>=fft.integ_h)){var e=Math.round(f/fft.integ_dbl);e<0||e>fft.integ_bins||(fft.integ_bino=Math.round((fft.integ_bino+e)%fft.integ_bins))}}function fft_recv(t){if("DAT"!=arrayBufferToStringLen(t,3))for(var f=arrayBufferToString(t).substring(4).split(" "),e=0;e<f.length;e++){var a=f[e].split("=");switch(a[0]){case"ready":fft_controls_setup();break;case"bins":fft.integ_bins=parseInt(a[1]),fft.integ_bino=0,fft.integ_dbl=Math.floor(fft.integ_h/fft.integ_bins),fft.integ_dbl<1&&(fft.integ_dbl=1),fft.integ_yo=(fft.integ_h-fft.integ_dbl*fft.integ_bins)/2,fft.integ_yo<0&&(fft.integ_yo=0),fft.integ_yo+=fft.integ_hdr,fft.integ_draw=!0;break;default:console.log("fft_recv: UNKNOWN CMD "+a[0])}}else{var i=new Uint8Array(t,4),_=i[0],n=1,c=i.length-1,s=i[n];if(n++,c--,_==fft.cmd_e.FFT){if(!fft.integ_draw)return;if(spec.source_audio){var r=new Uint8Array(t,6);spectrum_update(r)}else{var l,o,d;fft.func==fft.func_e.WF?(o=(l=fft.wf_canvas).ctx,d=l.im):(o=fft.integ_canvas.ctx,d=fft.integ_canvas.im,(s-=fft.integ_bino)<0&&(s+=fft.integ_bins));for(var w=0;w<fft.integ_w;w++){var u=waterfall_color_index_max_min(i[w+n],fft.maxdb,fft.mindb);d.data[4*w+0]=color_map_r[u],d.data[4*w+1]=color_map_g[u],d.data[4*w+2]=color_map_b[u],d.data[4*w+3]=255}if(fft.func==fft.func_e.WF){if(o.putImageData(d,0,fft.actual_line),fft.actual_line--,fft.wf1_canvas.style.top=px(fft.wf1_canvas.top++),fft.wf2_canvas.style.top=px(fft.wf2_canvas.top++),fft.actual_line<0){var m=fft.integ_h;fft.wf_canvas_i^=1,fft.wf_canvas=fft.wf_canvas_i?fft.wf2_canvas:fft.wf1_canvas,(l=fft.wf_canvas).top=1-m+fft.integ_hdr,l.style.top=px(l.top),fft.actual_line=m-1}}else for(var p=0;p<fft.integ_dbl;p++)o.putImageData(d,0,fft.integ_yo+(s*fft.integ_dbl+p))}}else _==fft.cmd_e.CLEAR?fft_clear():console.log("fft_recv: DATA UNKNOWN cmd="+_+" len="+c)}}function fft_controls_setup(){var t=time_display_html("fft")+w3_div("id-fft-data|left:150px; width:1024px; height:200px; background-color:mediumBlue; position:relative;",'<canvas id="id-fft-wf1-canvas" width="1024" height="188" style="position:absolute"></canvas>','<canvas id="id-fft-wf2-canvas" width="1024" height="188" style="position:absolute"></canvas>','<canvas id="id-fft-integ-canvas" width="1024" height="200" style="position:absolute"></canvas>'),f=w3_div("id-fft-info|left:0px; height:280px; overflow:hidden; position:relative;",'<canvas id="id-fft-info-canvas" width="256" height="280" style="position:absolute"></canvas>'),e=ext_param();e&&(e=e.split(",")).forEach(function(t,f){var e;console.log("FFT param <"+t+">"),w3_ext_param_array_match_str(fft.func_s,t,function(t){fft.func=t}),w3_ext_param_array_match_str(fft.pre_s,t,function(t){fft.pre=t}),(e=w3_ext_param("itime",t)).match?fft.itime=w3_clamp(e.num,1,60):(e=w3_ext_param("maxdb",t)).match?fft.maxdb=w3_clamp(e.num,-170,-10):(e=w3_ext_param("mindb",t)).match?fft.mindb=w3_clamp(e.num,-190,-30):w3_ext_param("help",t).match&&extint_help_click(!0)});var a=w3_div("id-fft-controls w3-text-white",w3_half("","",f,w3_divs("",w3_div("w3-medium w3-text-aqua","<b>Audio FFT</b>"),w3_inline("w3-margin-T-8 w3-halign-space-between/",w3_select("w3-text-red","Function","","fft.func",fft.func,fft.func_s,"fft_func_cb"),w3_input("w3-width-64 w3-padding-smaller","Integrate time","fft.itime",fft.itime,"fft_itime_cb")),w3_select("w3-margin-T-8//w3-text-red w3-width-auto","Integrate presets","select","fft.pre",W3_SELECT_SHOW_TITLE,fft.pre_s,"fft_pre_select_cb"),w3_div("id-fft-msg-fft w3-margin-T-8",w3_slider("","max","fft.maxdb",fft.maxdb,-170,-10,1,"fft_maxdb_cb"),w3_slider("","min","fft.mindb",fft.mindb,-190,-30,1,"fft_mindb_cb")),w3_text("id-fft-msg-spec  w3-margin-T-8 w3-hide","Spectrum uses main control panel<br>WF tab sliders and settings"),w3_button("w3-margin-T-8 w3-padding-small","Clear","fft_clear_cb")),"id-fft-controls-left","id-fft-controls-right"));ext_panel_show(a,t,null),time_display_setup("fft"),fft.integ_canvas=w3_el("id-fft-integ-canvas"),fft.integ_canvas.ctx=fft.integ_canvas.getContext("2d"),fft.integ_canvas.im=fft.integ_canvas.ctx.createImageData(fft.integ_w,1),fft.integ_canvas.addEventListener("mousedown",fft_mousedown,!1),fft.wf1_canvas=w3_el("id-fft-wf1-canvas"),fft.wf1_canvas.ctx=fft.wf1_canvas.getContext("2d"),fft.wf1_canvas.im=fft.wf1_canvas.ctx.createImageData(fft.integ_w,1),fft.wf2_canvas=w3_el("id-fft-wf2-canvas"),fft.wf2_canvas.ctx=fft.wf2_canvas.getContext("2d"),fft.wf2_canvas.im=fft.wf2_canvas.ctx.createImageData(fft.integ_w,1),fft.info_canvas=w3_el("id-fft-info-canvas"),fft.info_canvas.ctx=fft.info_canvas.getContext("2d"),FFT_environment_changed({resize:1}),fft_itime_cb("fft.itime",fft.itime),fft_clear(),fft.update_interval=setInterval(fft_update,1e3),fft_func_cb("fft.func",fft.func,!1),-1!=fft.pre&&fft_pre_select_cb("fft.pre",fft.pre,!1)}function FFT_environment_changed(t){if(t.mode&&ext_send("SET run="+fft.func),t.resize){var f=w3_el("id-fft-data"),e=(window.innerWidth-fft.integ_w-time_display_width())/2;f.style.left=px(e)}}function fft_alpha(){var t=16;(n=fft.info_canvas.ctx).font="12px Verdana";for(var f=0;f<4;f++){n.fillStyle="white";var e=fft.alpha_sched[0][f],a=4.5-n.measureText(e).width/2;n.fillText(e,64+48*f+a,10);e=fft.alpha_sched[1][f].toFixed(2),a=4.5-n.measureText(e).width/2;n.fillText(e,64+48*f+a,26),t=32;for(var i=1;i<=6;i++){0==f&&(n.fillStyle="white",n.fillText("slot "+i,16,t+15)),(_=fft.alpha_sched[i+2][f])==fft_a.MULT?(n.fillStyle=fft.alpha_station_colors[fft_a.NOVO-1],n.fillRect(64+48*f-5,t,5,20),n.fillStyle=fft.alpha_station_colors[fft_a.REVD-1],n.fillRect(64+48*f+2,t,5,20),n.fillStyle=fft.alpha_station_colors[fft_a.SEYD-1],n.fillRect(64+48*f+9,t,5,20)):_&&(n.fillStyle=fft.alpha_station_colors[_-1],n.fillRect(64+48*f,t,9,20)),t+=24}}t=192,n.font="12px Verdana";for(var _=0;_<=4;_++)n.fillStyle=fft.alpha_station_colors[_],n.fillRect(64,t,20,9),n.fillStyle="white",n.fillText(fft.alpha_stations[_],88,t+9),t+=16;var n=fft.integ_canvas.ctx;fft.integ_w,ext_sample_rate();n.font="12px Verdana",n.fillStyle="white";for(f=0;f<4;f++){var c=fft.alpha_sched[1][f].toFixed(2),s=1e3*parseFloat(c);fft_marker(c,fft.alpha_sched[2][f],s)}}function fft_itime_cb(t,f){var e=parseFloat(f);e<1&&(e=1),e=e.toFixed(3),w3_num_cb(t,e),ext_send("SET itime="+e),fft_clear()}function fft_set_itime(t){w3_set_value("fft.itime",t),fft_itime_cb("fft.itime",t)}function fft_func_cb(t,f,e){if(!e){switch(f=+f){case fft.func_e.SPEC:fft.spec_source_save=spec.source_wf,spec.source_wf=0,spec.source_audio=1,w3_hide("id-ext-data-container"),ext_show_spectrum();break;default:if(fft.func!=fft.func_e.SPEC)break;spec.source_wf=fft.spec_source_save,spec.source_audio=0,ext_hide_spectrum(),w3_show_block("id-ext-data-container")}w3_select_value(t,f),fft.func=f,w3_show_hide("id-fft-msg-fft",fft.func!=fft.func_e.SPEC),w3_show_hide("id-fft-msg-spec",fft.func==fft.func_e.SPEC),fft_clear(),w3_attribute(fft.integ_canvas,"title","click to align vertically",fft.func==fft.func_e.INTEG)}}function fft_pre_select_cb(t,f,e){if(!e){f=+f,fft.integ_draw=!1,fft.pre=f;var a=fft.func_e.INTEG;switch(fft.pre){case fft.pre_none:fft_set_itime(10);break;case fft.pre_ALPHA:ext_tune(11.5,"usb",ext_zoom.NOM_IN),ext_set_passband(300,3470),fft_set_itime(3.6);break;case fft.pre_JJY40:ext_tune(40,"cw",ext_zoom.NOM_IN),fft_set_itime(1);break;case fft.pre_RTZ:ext_tune(50.32,"cwn",ext_zoom.NOM_IN),fft_set_itime(1);break;case fft.pre_WWVB_MSF_JJY60:ext_tune(60,"cw",ext_zoom.NOM_IN),fft_set_itime(1);break;case fft.pre_RBU:ext_tune(66.35,"cwn",ext_zoom.NOM_IN),fft_set_itime(1);break;case fft.pre_BPC:ext_tune(68.5,"cw",ext_zoom.NOM_IN),fft_set_itime(1);break;case fft.pre_DCF77:ext_tune(77.5,"cw",ext_zoom.NOM_IN),fft_set_itime(1);break;default:a=fft.func_e.SPEC}w3_select_value(t,f),fft_func_cb("fft.func",a,!1)}}function fft_maxdb_cb(t,f,e,a){fft.maxdb=parseFloat(f),w3_num_cb(t,f),w3_set_label("WF/integrate max "+f+" dB",t)}function fft_mindb_cb(t,f,e,a){fft.mindb=parseFloat(f),w3_num_cb(t,f),w3_set_label("WF/integrate min "+f+" dB",t)}function fft_clear_cb(t,f){fft_clear(),setTimeout(function(){w3_radio_unhighlight(t)},w3_highlight_time)}function FFT_blur(){console.log("FFT_blur"),kiwi_clearInterval(fft.update_interval),spec.source_audio=0,ext_send("SET run="+fft.func_e.OFF),spec.need_clear_avg=!0}function FFT_config_html(){ext_config_html(fft,"fft","FFT","FFT configuration")}function FFT_help(t){if(t){var f=w3_text("w3-medium w3-bold w3-text-aqua","Audio FFT help")+"<br>Remember that on KiwiSDR the audio and waterfall channels are completely separate. <br>For example you can pan the waterfall frequency without effecting the audio. <br>By contrast this extension allows visualization of the <i>audio</i> channel itself by using<br>an FFT, waterfall and integrator (summing waterfall) for weak signals. <br><br>URL parameters: <br>itime:<i>num</i> &nbsp; maxdb:<i>num</i> &nbsp; mindb:<i>num</i> <br>Non-numeric values are those appearing in their respective menus. <br>Keywords are case-insensitive and can be abbreviated. <br>So for example these are valid: <br><i>ext=fft,integ,itime:5</i> &nbsp;&nbsp; <i>ext=fft,water,min:-130,max:-40</i> &nbsp;&nbsp; <i>ext=fft,alpha</i> <br><br>Clicking on integrate display will restart it such that the click-point is <br>moved to top of the display (i.e. vertical timing can be realigned).";confirmation_show_content(f,610,300)}return!0}


