

/* web/extensions/IQ_display/IQ_display.min.js (web/extensions/IQ_display/IQ_display.js = Mon Jun  6 11:59:54 2022) */
var iq={ext_name:"IQ_display",first_time:!0,cmd_e:{IQ_POINTS:0,IQ_DENSITY:1,IQ_CLEAR:2},draw:1,mode:0,cmaI:0,cmaQ:0,df:0,pll:1,pll_bw:5,size:Math.round(Math.log2(1024)),offset:0,gain:0,update_interval:0,den_max:1,maxdb:255,mindb:0,gps_correcting:0,gps_correcting_initial:1,adc_clock_Hz:0,phase:0};function IQ_display_main(){ext_switch_to_client(iq.ext_name,iq.first_time,iq_display_recv),iq.first_time||iq_display_controls_setup(),iq.first_time=!1}var iq_display_imageData,iq_display_map=new Uint32Array(65536);function iq_display_clear(){var i=iq_display_canvas.ctx;iq.draw==iq.cmd_e.IQ_POINTS&&(i.fillStyle="mediumBlue",i.fillRect(0,0,256,256),i.fillStyle="white",i.fillRect(0,128,256,1),i.fillRect(128,0,1,256)),ext_send("SET clear");for(var _=0;_<256;_++)for(var a=0;a<256;a++)iq_display_map[256*_+a]=0;iq.den_max=1}function iq_display_sched_update(){kiwi_clearInterval(iq.update_interval),iq.update_interval=setInterval(iq_display_update,250)}var iq_display_canvas,iq_display_upd_cnt=0;function iq_display_update(){var i,_=iq_display_canvas.ctx;if(iq.draw==iq.cmd_e.IQ_DENSITY)for(var a=0,e=0;e<65536;e+=256){for(var l=0;l<256;l++){var t=iq_display_map[e+l]/iq.den_max*255,t=color_index_max_min(t,iq.maxdb,iq.mindb);iq_display_imageData.data[4*l+0]=color_map_r[t],iq_display_imageData.data[4*l+1]=color_map_g[t],iq_display_imageData.data[4*l+2]=color_map_b[t],iq_display_imageData.data[4*l+3]=255}_.putImageData(iq_display_imageData,0,a),a++}3==iq_display_upd_cnt&&(w3_el("iq_display-cma").innerHTML="PLL df: "+iq.df.toFixed(1).withSign()+" Hz<br>PLL phase: "+iq.phase.toFixed(3).withSign()+" rad",w3_el("iq_display-adc").innerHTML="ADC clock: "+(iq.adc_clock_Hz/1e6).toFixed(6)+" MHz",i=cfg.ADC_clk_corr&&3<ext_adc_gps_clock_corr()?1:0,w3_innerHTML("iq_display-gps",i?"GPS corrections: "+ext_adc_gps_clock_corr():""),w3_show_hide("id-iq-fcal",!i),i==iq.gps_correcting&&!iq.gps_correcting_initial||(i?(w3_innerHTML("iq-fcal-p","GPS is correcting"),w3_innerHTML("iq-fcal-m","")):(w3_innerHTML("iq-fcal-p",w3_button("w3-css-yellow|margin-left:12px; padding:6px 10px;","Fcal "+w3_icon("","fa-repeat"),"iq_display_IQ_cal_jog_cb",1)),w3_innerHTML("iq-fcal-m",w3_button("w3-css-yellow|margin-left:12px; padding:6px 10px;","Fcal "+w3_icon("","fa-undo"),"iq_display_IQ_cal_jog_cb",-1))),iq.gps_correcting=i,iq.gps_correcting_initial=0),iq_display_upd_cnt=0),iq_display_upd_cnt++}function iq_display_recv(i){if("DAT"!=arrayBufferToStringLen(i,3))for(var _=arrayBufferToString(i).substring(4).split(" "),a=0;a<_.length;a++){var e=_[a].split("=");switch(0,e[0]){case"ready":iq_display_controls_setup();break;case"cmaI":iq.cmaI=parseFloat(e[1]);break;case"cmaQ":iq.cmaQ=parseFloat(e[1]);break;case"df":iq.df=parseFloat(e[1]);break;case"phase":iq.phase=parseFloat(e[1]);break;case"adc_clock":iq.adc_clock_Hz=parseFloat(e[1]);break;default:console.log("iq_display_recv: UNKNOWN CMD "+e[0])}}else{var l=new Uint8Array(i,4),i=l[0]>>1,t=1&l[0],n=l.length-1;if(i==iq.cmd_e.IQ_POINTS)for(var c=iq_display_canvas.ctx,d=1;d<n;d+=4)a=l[d+0],s=l[d+1],c.fillStyle="black",c.fillRect(a,s,2,2),a=l[d+2],s=l[d+3],c.fillStyle=t?"lime":"cyan",c.fillRect(a,s,2,2);else if(i==iq.cmd_e.IQ_DENSITY)for(var a,s,c=iq_display_canvas.ctx,d=1;d<n;d+=2){a=l[d+0],s=l[d+1];var o=iq_display_map[256*s+a];++o>iq.den_max&&(iq.den_max=o),iq_display_map[256*s+a]=o}else i==iq.cmd_e.IQ_CLEAR?iq_display_clear():console.log("iq_display_recv: DATA UNKNOWN cmd="+i+" len="+n)}}function iq_display_controls_setup(){w3_div("id-iq_display-scope|left:150px; width:1024px; height:200px; background-color:mediumBlue; position:relative;",'<canvas id="id-iq_display-scope-canvas" width="1024" height="200" style="position:absolute"></canvas>');var i=w3_div("id-iq_display-data|left:0px; width:256px; height:256px; background-color:mediumBlue; overflow:hidden; position:relative;",'<canvas id="id-iq_display-canvas" width="256" height="256" style="position:absolute"></canvas>'),e=["points","density"],l=["IQ","carrier"],t=["off","on","BPSK","QPSK","8PSK","MSK100","MSK200"],_=ext_param();_&&(_=_.split(",")).forEach(function(i,_){var a;console.log("IQ param <"+i+">"),w3_ext_param_array_match_str(e,i,function(i){iq.draw=i}),w3_ext_param_array_match_str(l,i,function(i){iq.mode=i}),w3_ext_param_array_match_str(t,i,function(i){iq.pll=i}),(a=w3_ext_param("size",i)).match?iq.size=w3_clamp(Math.round(Math.log2(a.num)),4,14):(a=w3_ext_param("pll_bw",i)).match?iq.pll_bw=a.num:(a=w3_ext_param("gain",i)).match?iq.gain=w3_clamp(a.num,0,120):(a=w3_ext_param("cmax",i)).match?iq.maxdb=w3_clamp(a.num,0,255):(a=w3_ext_param("cmin",i)).match&&(iq.mindb=w3_clamp(a.num,0,255))});i=w3_div("id-iq_display-controls w3-text-white",w3_half("","",w3_div("",i,w3_div("id-iq_display-cma w3-margin-T-8"),w3_div("id-iq_display-adc"),w3_div("id-iq_display-gps"),w3_div("id-iq-fcal w3-hide")),w3_div("w3-margin-L-8",w3_div("w3-medium w3-text-aqua","<b>IQ display</b>"),w3_slider("w3-tspace-8//","Gain","iq.gain",iq.gain,0,120,1,"iq_display_gain_cb"),w3_inline("w3-tspace-8/w3-margin-between-6",w3_select("w3-text-red","Draw","","iq.draw",iq.draw,e,"iq_display_draw_select_cb"),w3_select("w3-text-red","Mode","","iq.mode",iq.mode,l,"iq_display_mode_select_cb"),w3_select("w3-text-red","PLL","","iq.pll",iq.pll,t,"iq_display_pll_select_cb")),w3_slider("w3-tspace-8 id-iq-size//","Size","iq.size",iq.size,4,14,1,"iq_display_size_cb"),w3_slider("w3-tspace-8 id-iq-maxdb w3-hide//","Colormap max","iq.maxdb",iq.maxdb,0,255,1,"iq_display_maxdb_cb"),w3_slider("id-iq-mindb w3-hide//","Colormap min","iq.mindb",iq.mindb,0,255,1,"iq_display_mindb_cb"),w3_inline("w3-margin-B-16 w3-tspace-8",w3_input("w3-label-inline w3-padding-smaller|width:auto|size=3","PLL bandwidth","iq.pll_bw",iq.pll_bw,"iq_display_pll_bw_cb"),w3_label("w3-margin-L-8"," Hz")),w3_inline("w3-tspace-8/w3-margin-between-16",w3_button("w3-padding-small","Clear","iq_display_clear_cb"),w3_button("w3-padding-small","2.4k","iq_display_AM_bw_cb",2400),w3_button("w3-padding-small","160","iq_display_AM_bw_cb",160),w3_button("w3-padding-small","40","iq_display_AM_bw_cb",40)),'<hr style="margin:10px 0">',w3_col_percent("w3-tspace-8/",w3_button("w3-css-yellow","IQ bal","iq_display_IQ_balance_cb"),33,w3_div("id-iq-fcal-p"),33,w3_div("id-iq-fcal-m"),33))));ext_panel_show(i,null,null),ext_set_controls_width_height(550,350),iq_display_clk_adj(),(iq_display_canvas=w3_el("id-iq_display-canvas")).ctx=iq_display_canvas.getContext("2d"),iq_display_imageData=iq_display_canvas.ctx.createImageData(256,1),ext_send("SET pll_bandwidth="+iq.pll_bw),ext_send("SET run=1"),setTimeout(function(){iq_display_clear()},500),setTimeout(function(){iq_display_clear()},2e3)}function iq_display_gain_cb(i,_,a,e){_=+_,w3_num_cb(i,_),w3_set_label("Gain "+(0==_?"(auto-scale)":_+" dB"),i),ext_send("SET gain="+_),iq_display_clear()}function iq_display_draw_select_cb(i,_){iq.draw=+_,ext_set_controls_width_height(550,iq.draw==iq.cmd_e.IQ_POINTS?350:360),ext_send("SET draw="+iq.draw),w3_show_hide("id-iq-size",iq.draw==iq.cmd_e.IQ_POINTS),w3_show_hide("id-iq-maxdb",iq.draw==iq.cmd_e.IQ_DENSITY),w3_show_hide("id-iq-mindb",iq.draw==iq.cmd_e.IQ_DENSITY),iq_display_sched_update(),iq_display_clear()}function iq_display_mode_select_cb(i,_){iq.mode=+_,ext_send("SET display_mode="+iq.mode),iq_display_sched_update(),iq_display_clear()}function iq_display_pll_select_cb(i,_){iq.pll=+_,console.log("iq_display_pll_select_cb iq.pll="+iq.pll),ext_send("SET pll_mode="+[0,1,1,1,1,2,2][iq.pll]+" arg="+[0,1,2,4,8,100,200][iq.pll]),iq_display_sched_update(),iq_display_clear()}function iq_display_size_cb(i,_,a,e){var l=1<<(_=+_);w3_num_cb(i,_),w3_set_label("Size "+l,i),ext_send("SET points="+l),iq_display_clear()}function iq_display_maxdb_cb(i,_,a,e){_=+_,w3_set_label("Colormap max "+_,i),iq.maxdb=_,w3_num_cb(i,_)}function iq_display_mindb_cb(i,_,a,e){_=+_,w3_set_label("Colormap min "+_,i),iq.mindb=_,w3_num_cb(i,_)}function iq_display_pll_bw_cb(i,_,a,e){_=+_,w3_num_cb(i,_),ext_send("SET pll_bandwidth="+_),iq_display_clear()}function iq_display_offset_cb(i,_){w3_num_cb(i,_),ext_send("SET offset="+_)}function iq_display_clear_cb(i,_){iq_display_clear(),setTimeout(function(){w3_radio_unhighlight(i)},w3_highlight_time)}function iq_display_AM_bw_cb(i,_){_=+_/2;ext_set_mode("am"),ext_set_passband(-_,_),setTimeout(function(){iq_display_clear()},500)}function iq_display_IQ_balance_cb(i,_){iq.mode_20kHz=3==rx_chans&&3==wf_chans?1:0,iq.DC_offset_I="DC_offset"+(iq.mode_20kHz?"_20kHz":"")+"_I",iq.DC_offset_Q="DC_offset"+(iq.mode_20kHz?"_20kHz":"")+"_Q",console.log("mode_20kHz="+iq.mode_20kHz+" "+iq.DC_offset_I+" "+iq.DC_offset_Q),iq.DC_offset_default=[-.02,-.034],admin_pwd_query(function(){var i=w3_inline("",w3_div("",w3_text("w3-medium w3-bold w3-text-css-yellow","CAUTION")+"<br>Only IQ balance under the following conditions:<br>PLL mode is set to OFF <br>Receive mode is set to AM <br>Antenna is disconnected <br>Tuned to a frequency with no signals <br>Zoom-in and verify no spurs in passband <br><br>Iprev = "+cfg[iq.DC_offset_I].toFixed(6)+"&nbsp; &nbsp; Qprev = "+cfg[iq.DC_offset_Q].toFixed(6)+"<br>Iincr = "+(-iq.cmaI).toFixed(6)+"&nbsp; &nbsp; Qincr = "+(-iq.cmaQ).toFixed(6)),w3_button("w3-green w3-margin-left","Confirm","iq_balance_confirm"),w3_button("w3-red w3-margin-left","Cancel","confirmation_panel_close"))+w3_button("w3-css-yellow w3-margin-left w3-tspace-8","Reset to default values","iq_balance_default");confirmation_show_content(i,550,230)}),setTimeout(function(){w3_radio_unhighlight(i)},w3_highlight_time)}function iq_balance_default(){confirmation_panel_close(),console.log("mode_20kHz="+iq.mode_20kHz+" iq_balance_default="+iq.DC_offset_default[iq.mode_20kHz]),cfg[iq.DC_offset_I]=cfg[iq.DC_offset_Q]=iq.DC_offset_default[iq.mode_20kHz],ext_set_cfg_param("cfg."+iq.DC_offset_I,cfg[iq.DC_offset_I],!0),ext_set_cfg_param("cfg."+iq.DC_offset_Q,cfg[iq.DC_offset_Q],!0)}function iq_balance_confirm(){confirmation_panel_close(),console.log("iq_balance_confirm: PREV I="+cfg[iq.DC_offset_I].toFixed(6)+" Q="+cfg[iq.DC_offset_Q].toFixed(6)),console.log("iq_balance_confirm: INCR ADJ I="+-iq.cmaI+" Q="+-iq.cmaQ),cfg[iq.DC_offset_I]+=-iq.cmaI,ext_set_cfg_param("cfg."+iq.DC_offset_I,cfg[iq.DC_offset_I],!0),cfg[iq.DC_offset_Q]+=-iq.cmaQ,ext_set_cfg_param("cfg."+iq.DC_offset_Q,cfg[iq.DC_offset_Q],!0),console.log("iq_balance_confirm: NEW I="+cfg[iq.DC_offset_I].toFixed(6)+" Q="+cfg[iq.DC_offset_Q].toFixed(6))}function iq_display_IQ_cal_jog_cb(i,a){admin_pwd_query(function(){var i=+a,_=cfg.clk_adj+i,i=100*ext_adc_clock_nom_Hz()/1e6;_<-i||i<_?console.log("jog ADC clock: ADJ TOO LARGE"):(ext_send("SET clk_adj="+_),ext_set_cfg_param("cfg.clk_adj",_,!0),iq_display_clk_adj())}),setTimeout(function(){w3_radio_unhighlight(i)},w3_highlight_time)}function iq_display_clk_adj(){w3_innerHTML("id-iq-fcal","Total Fcal adjustment: "+cfg.clk_adj.toString().withSign()+" Hz")}function IQ_display_blur(){ext_send("SET run=0"),kiwi_clearInterval(iq.update_interval)}function IQ_display_config_html(){ext_config_html(iq,"iq_display","IQ","IQ display configuration")}function IQ_display_help(i){return i&&(i=w3_text("w3-medium w3-bold w3-text-aqua","IQ display help")+"<br>URL parameters: <br>gain:<i>num</i> &nbsp; density|points &nbsp; IQ|carrier &nbsp; off|on|BPSK|QPSK|8PSK|MSK100|MSK200 <br>cmax:<i>num</i> &nbsp; cmin:<i>num</i> &nbsp; pll_bw:<i>num</i> <br>Non-numeric values are those appearing in their respective menus. <br>Keywords are case-insensitive and can be abbreviated. <br>So for example this is valid: <i>ext=iq,g:75,poi,car,q,pll:8</i> <br>",confirmation_show_content(i,610,175)),!0}



