

/* web/extensions/SSTV/SSTV.min.js (web/extensions/SSTV/SSTV.js = Mon Feb 28 06:50:35 2022) */
var sstv={ext_name:"SSTV",first_time:!0,w:1088,h:256,iw:320,isp:64,iws:384,page:0,pg_sp:64,startx:86,tw:0,data_canvas:0,image_y:0,shift_second:!1,auto:!0,CMD_DRAW:0,CMD_REDRAW:1,img_width:0,freqs_s:["3630_ANZ","3730_EU","3845_NA",7171,14230,14233,21340,28680]};function SSTV_main(){ext_switch_to_client(sstv.ext_name,sstv.first_time,sstv_recv),sstv.first_time||sstv_controls_setup(),sstv.first_time=!1}function sstv_recv(s){var t=sstv.data_canvas,e=t.ctx;if("DAT"!=arrayBufferToStringLen(s,3)){var a=arrayBufferToString(s).substring(4).split(" ");for(d=0;d<a.length;d++){var i=a[d].split("=");switch(i[0]){case"ready":sstv_controls_setup();break;case"img_width":sstv.img_width=i[1];break;case"new_img":sstv_clear_display(decodeURIComponent(i[1]));break;case"redraw":sstv.image_y=0;break;case"mode_name":sstv.mode_name=decodeURIComponent(i[1]),sstv_mode_name_cb(sstv.mode_name),sstv.line=1;break;case"status":sstv.status=decodeURIComponent(i[1]),sstv_status_cb(sstv.status);break;case"result":sstv.result=decodeURIComponent(i[1]),sstv_result_cb(sstv.result);break;case"fsk_id":sstv.fsk_id=decodeURIComponent(i[1]),sstv_fsk_id_cb(sstv.fsk_id);break;default:console.log("sstv_recv: UNKNOWN CMD "+i[0])}}}else{var n=new Uint8Array(s,4),_=n[0],v=n[1],o=2,r=n.length-1;if(_==sstv.CMD_DRAW||_==sstv.CMD_REDRAW){for(var l,c=t.imd,d=0;d<sstv.img_width;d++)c.data[4*d+0]=n[o],c.data[4*d+1]=n[o+1],c.data[4*d+2]=n[o+2],c.data[4*d+3]=255,o+=3;if(sstv.image_y<sstv.h)sstv.image_y++;else{l=sstv.startx;var u=sstv.w;e.drawImage(t,l,1,u,sstv.h-1,l,0,u,sstv.h-1)}l=Math.round(sstv.startx+sstv.page*sstv.iws),e.putImageData(c,l,sstv.image_y-1,0,0,sstv.iw,1),_==sstv.CMD_DRAW&&sstv_status_cb("line "+sstv.line+", SNR "+(v-128).toFixed(0)+" dB"),sstv.line++}else console.log("sstv_recv: DATA UNKNOWN cmd="+_+" len="+r)}}function sstv_clear_display(s){var t=sstv.data_canvas.ctx,e=sstv.startx+sstv.page*sstv.iws,a=sstv.h/2,i=sstv.isp;-1!=sstv.page&&(t.fillStyle="dimGray",t.fillRect(e-24,a-12,24,24)),sstv.page=(sstv.page+1)%3,e=sstv.startx+sstv.page*sstv.iws,t.fillStyle="yellow",t.beginPath(),t.moveTo(e-24,a-12),t.lineTo(e,a),t.lineTo(e-24,a+12),t.closePath(),t.fill(),t.fillStyle="dimGray";t.fillRect(e-i,a-24-16,i,24),t.font="16px Arial",t.fillStyle="yellow";var n=e-t.measureText(s).width-4;t.fillText(s,n,a-24),t.fillStyle="lightCyan",t.fillRect(e,0,sstv.iw,sstv.h),sstv.image_y=0,sstv.shift_second=!1}function sstv_controls_setup(){kiwi_isMobile()&&(sstv.startx=0),sstv.tw=sstv.w+sstv.startx;var s=time_display_html("sstv")+w3_div("id-sstv-data|left:0; width:"+px(sstv.tw)+"; background-color:black; position:relative;",'<canvas id="id-sstv-data-canvas" class="w3-crosshair" width='+dq(sstv.tw)+' style="position:absolute;"></canvas>'),t=w3_div("id-test-controls w3-text-white",w3_divs("/w3-tspace-8",w3_col_percent("",w3_div("w3-medium w3-text-aqua","<b>SSTV decoder</b>"),30,w3_div("",'From <b><a href="http://windytan.github.io/slowrx" target="_blank">slowrx</a></b> by Oona Räisänen, OH2EIQ')),w3_inline("",w3_select("id-sstv-freq-menu w3-text-red","","freq","sstv.freq",W3_SELECT_SHOW_TITLE,sstv.freqs_s,"sstv_freq_cb"),w3_checkbox("id-sstv-cbox-auto w3-margin-left w3-label-inline w3-label-not-bold","auto adjust","sstv.auto",!0,"sstv_auto_cbox_cb"),w3_button("id-sstv-btn-auto w3-margin-left w3-padding-smaller","Undo adjust","sstv_auto_cb"),w3_button("w3-margin-left w3-padding-smaller w3-css-yellow","Reset","sstv_reset_cb"),w3_button("w3-margin-left w3-padding-smaller w3-aqua","Test image","sstv_test_cb")),w3_half("","",w3_div("id-sstv-mode-name"),w3_div("id-sstv-fsk-id")),w3_div("id-sstv-status"),w3_div("id-sstv-result w3-hide")));ext_panel_show(t,s,null),ext_set_controls_width_height(560,125),sstv_mode_name_cb(""),sstv_status_cb(""),sstv_result_cb(""),sstv_fsk_id_cb(""),time_display_setup("sstv"),sstv.data_canvas=w3_el("id-sstv-data-canvas"),sstv.data_canvas.ctx=sstv.data_canvas.getContext("2d"),sstv.data_canvas.imd=sstv.data_canvas.ctx.createImageData(sstv.w,1),sstv.data_canvas.addEventListener("mousedown",sstv_mousedown,!1),kiwi_isMobile()&&sstv.data_canvas.addEventListener("touchstart",sstv_touchstart,!1),sstv.data_canvas.height=sstv.h.toString(),ext_set_data_height(sstv.h);var e=sstv.data_canvas.ctx;e.fillStyle="black",e.fillRect(0,0,sstv.tw,sstv.h),e.fillStyle="dimGray",e.fillRect(sstv.startx-sstv.isp,0,sstv.w+sstv.isp,sstv.h),sstv.page=-1,sstv.shift_second=!1,ext_send("SET start");var a=ext_param();if(a){a=a.split(",");for(var i=!1,n=0,_=a.length;n<_;n++){var v=a[n];w3_ext_param("help",v).match?extint_help_click():w3_ext_param("test",v).match?sstv_test_cb():w3_ext_param("noadj",v).match?(sstv.auto=1,sstv_auto_cbox_cb("id-sstv-cbox-auto",!1)):w3_select_enum("id-sstv-freq-menu",function(s,t){!i&&s.innerHTML.startsWith(v)&&(w3_select_value("id-sstv-freq-menu",t-1),sstv_freq_cb("",t-1,!1),i=!0)})}}}function sstv_auto_cbox_cb(s,t,e){e||(w3_checkbox_set(s,t),w3_innerHTML("id-sstv-btn-auto",t?"Undo adjust":"Auto adjust"),sstv.auto=!sstv.auto,ext_send("SET noadj="+(sstv.auto?0:1)))}function sstv_auto_cb(s,t,e){ext_send("SET "+(sstv.auto?"undo":"auto"))}function sstv_freq_cb(s,t,e){if(!e){t=+t;var a=parseInt(sstv.freqs_s[t]);if(!isNaN(a)){var i=a<1e4;ext_tune(a,i?"lsb":"usb",ext_zoom.ABS,9);ext_set_passband((i?-2300:1200)-200,(i?-1200:2300)+200)}}}function sstv_mousedown(s){sstv_shift(s,!0)}function sstv_touchstart(s){sstv_shift(s,!1)}function sstv_shift(s,t){var e=s.clientX?s.clientX:s.offsetX?s.offsetX:s.layerX,a=s.clientY?s.clientY:s.offsetY?s.offsetY:s.layerY;if((e-=sstv.startx)<0||-1==sstv.page)sstv.shift_second=!1;else{var i=sstv.page*sstv.iws,n=i+sstv.iw;if(e<i||e>n)sstv.shift_second=!1;else{if(e-=i,!sstv.shift_second)return sstv.x0=e,sstv.y0=a,void(sstv.shift_second=!0);sstv.shift_second=!1,ext_send("SET shift x0="+sstv.x0+" y0="+sstv.y0+" x1="+e+" y1="+a)}}}function sstv_mode_name_cb(s){w3_el("id-sstv-mode-name").innerHTML="Mode: "+w3_div("w3-show-inline-block w3-text-black w3-background-pale-aqua w3-padding-LR-8",s)}function sstv_status_cb(s){w3_el("id-sstv-status").innerHTML="Status: "+w3_div("w3-show-inline-block w3-text-black w3-background-pale-aqua w3-padding-LR-8",s)}function sstv_result_cb(s){w3_el("id-sstv-result").innerHTML="Result: "+w3_div("w3-show-inline-block w3-text-black w3-background-pale-aqua w3-padding-LR-8",s)}function sstv_fsk_id_cb(s){w3_el("id-sstv-fsk-id").innerHTML="FSK ID: "+w3_div("w3-show-inline-block w3-text-black w3-background-pale-aqua w3-padding-LR-8",s)}function sstv_reset_cb(s,t,e){sstv_mode_name_cb(""),sstv_status_cb(""),sstv_result_cb(""),sstv_fsk_id_cb(""),ext_send("SET reset")}function sstv_test_cb(s,t,e){sstv_result_cb(""),sstv_fsk_id_cb(""),ext_send("SET test")}function SSTV_blur(){ext_send("SET stop")}function SSTV_help(s){if(s){var t=w3_text("w3-medium w3-bold w3-text-aqua","SSTV decoder help")+w3_div("w3-margin-T-8 w3-scroll-y|height:90%",w3_div("w3-margin-R-8",'Select an entry from the SSTV freq menu and wait for a signal to begin decoding.<br>Sometimes activity is +/- the given frequencies. Try the "test image" button.<br><br>Supported modes:<ul><li>Martin: M1 M2 M3 M4</li><li>Scottie: S1 S2 SDX</li><li>Robot: R72 R36 R24 R24-BW R12-BW R8-BW</li><li>Wraase: SC-2-120 SC-2-180</li><li>PD: PD-50 PD-90</li></ul>If the image is still slanted or offset after auto adjustment you can make a manual<br>correction. If you see what looks like an edge in the image then click in two places along<br>the edge. The image will then auto adjust. You can repeat this procedure multiple times<br>if necessary.<br><br>URL parameters: <br><i>(freq menu match)</i> &nbsp; noadj &nbsp; test<br><br>The first URL parameter can be the number from an entry of the freq menu (e.g. "3730"). <i>noadj</i> un-checks the <i>auto adjust</i> box. <br><br>Keywords are case-insensitive and can be abbreviated. So for example these are valid: <br><i>ext=sstv,14230</i> &nbsp;&nbsp; <i>ext=sstv,7171,no &nbsp;&nbsp; <i>ext=sstv,t</i>'));confirmation_show_content(t,610,380),w3_el("id-confirmation-container").style.height="100%"}return!0}function SSTV_config_html(){ext_config_html(sstv,"sstv","SSTV","SSTV configuration")}


