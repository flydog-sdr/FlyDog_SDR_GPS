

/* web/extensions/timecode/timecode.min.js */
var tc={ext_name:"timecode",first_time:!0,update:!1,start_point:0,ref:0,state:0,ACQ_SYNC:0,MIN_MARK:1,ACQ_DATA:2,ACQ_DATA2:3,dbug:"",srate:0,srate_upd:0,pb_cf:500,interval:0,_100Hz:0,_10Hz:0,_1Hz:0,mkr_per:0,mkr:0,trig:0,sample_point:-1,ampl_last:0,data:0,data_last:1,df:0,phase:0,pll_bw:0,config:0,sig:{JJY40:0,RTZ:1,WWVBa:2,WWVBp:3,JJY60:4,MSF:5,RBU:6,BPCa:7,BPCss:8,DCF77a:9,DCF77ss:10,TDF:11,WWV:12},freq:[40,50.1,60,60,60,60,66.566,68.5,68.5,77.5,77.5,162,10000.1],pb:[5,30,5,5,5,5,30,5,5,5,5,5,5],pll_bw_i:[100,100,100,5,100,100,100,100,100,100,100,5,5],pll_off_i:[500,500,500,0,500,500,500,500,500,500,500,0,100],sigid_s:["jjy","rus","wwvb","wwvb","jjy","msf","rus","bpc","bpc","dcf77","dcf77","tdf","wwv"],prev_sig:-1,sig_s:[["40 kHz JJY-40",1,"JJY","https://en.wikipedia.org/wiki/JJY"],["50 kHz RTZ",1,"RTZ","https://en.wikipedia.org/wiki/RTZ_(radio_station)"],["60 kHz WWVB-ampl",1,"WWVB","https://en.wikipedia.org/wiki/WWVB"],["60 kHz WWVB-phase",1,"WWVB","https://en.wikipedia.org/wiki/WWVB"],["60 kHz JJY-60",1,"JJY","https://en.wikipedia.org/wiki/JJY"],["60 kHz MSF",1,"MSF","https://en.wikipedia.org/wiki/Time_from_NPL_(MSF)"],["66.666 kHz RBU",1,"RBU","https://en.wikipedia.org/wiki/RBU_(radio_station)"],["68.5 kHz BPC-ampl",1,"BPC","https://en.wikipedia.org/wiki/BPC_(time_signal)"],["68.5 kHz BPC-ss",0,"BPC","https://en.wikipedia.org/wiki/BPC_(time_signal)"],["77.5 kHz DCF77-ampl",1,"DCF77","https://en.wikipedia.org/wiki/DCF77"],["77.5 kHz DCF77-ss",0,"DCF77","https://en.wikipedia.org/wiki/DCF77"],["162 kHz TDF",1,"TDF","https://en.wikipedia.org/wiki/TDF_time_signal"],["WWV/WWVH",0,"WWV/WWVH","https://en.wikipedia.org/wiki/WWV_(radio_station)"],["EFR Teleswitch (FSK)",2,"EFR","https://www.efr.de/en/efr-system/#/Technical-Data-forTransmitter-Stations"],["CHU (FSK)",2,"CHU","https://en.wikipedia.org/wiki/CHU_(radio_station)"]],tct:{bs:[],bp:[],prev:0,ct:0},dim:[31,28,31,30,31,30,31,31,30,31,30,31],mo:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],MpD:1440,MpY:525600,raw:[],no_modulation:0,end:null};function timecode_main(){ext_switch_to_client(tc.ext_name,tc.first_time,tc_recv),tc.first_time||tc_controls_setup(),tc.first_time=!1}function tc_dmsg(t){null==t?tc.dbug="":tc.dbug+=t,w3_el("id-tc-dbug").innerHTML=tc.dbug}function tc_info(t){w3_el("id-tc-info").innerHTML=t}function tc_stat(t,e){w3_color("id-tc-status",t),w3_el("id-tc-status").innerHTML=e}function tc_stat2(t,e){w3_color("id-tc-status2",t),w3_el("id-tc-status2").innerHTML=e}function tc_bcd(t,e,c,i){for(var s=0,a=0;a<c;a++)s+=t[e+i*a]?[1,2,4,8,10,20,40,80,100,200][a]:0;return s}function tc_gap_bcd(t,e,c,i){for(var s=0,a=0;a<c;a++)s+=t[e+i*a]?[1,2,4,8,0,10,20,40,80,0,100,200][a]:0;return s}function tc_recv(t){if("DAT"!=arrayBufferToStringLen(t,3)){var e=arrayBufferToString(t).substring(4).split(" ");for(_=0;_<e.length;_++){var c=e[_].split("=");switch(c[0]){case"ready":kiwi_load_js_dir("extensions/timecode/",["wwvb.js","jjy.js","msf.js","dcf77.js","tdf.js","bpc.js","rus.js","../../pkgs/js/scope.js"],"tc_controls_setup");break;case"df":tc.df=parseFloat(c[1]);break;case"phase":tc.phase=parseFloat(c[1]);break;default:console.log("tc_recv: UNKNOWN CMD "+c[0])}}}else{var i=new Uint8Array(t,4),s=i[0],a=i.length;if(0==s)for(var _=1;_<a;_++){var o=-(i[_]-127)/127,r=Math.abs(o),n=o>0?1:0;tc.config==tc.sig.TDF&&(o*=4);var l=o+.99*tc.ampl_last,d=l-tc.ampl_last;tc.ampl_last=l;var p=void 0;if(tc._100Hz+=100/tc.srate,tc._100Hz>1){switch(tc.config){case tc.sig.WWVBa:case tc.sig.WWV:p=wwvb_ampl(r);break;case tc.sig.WWVBp:p=wwvb_phase(n);break;case tc.sig.DCF77a:p=dcf77_ampl(r);break;case tc.sig.TDF:p=tdf_phase(d);break;case tc.sig.MSF:p=msf_ampl(r);break;case tc.sig.BPCa:p=bpc_ampl(r);break;case tc.sig.JJY40:case tc.sig.JJY60:p=jjy_ampl(r);break;case tc.sig.RBU:case tc.sig.RTZ:p=rus_ampl(r)}if(tc._10Hz++>=10&&(tc._10Hz=0),tc._1Hz++>=100&&2!=tc.sig_s[tc.config][1]){timecode_update_srate();var g="cf "+tc.pb_cf;g+=", pll: "+tc.df.toFixed(2).withSign()+" Hz ",g+=tc.phase.toFixed(2).withSign()+" &phi; ",tc_stat2("orange",g+=", srate "+tc.srate.toFixed(2)+" ("+tc.srate_upd+"), clock "+(ext_adc_clock_Hz()/1e6).toFixed(6)+" ("+ext_adc_gps_clock_corr()+")"),tc._1Hz=0}tc._100Hz-=1}switch(tc.config){case tc.sig.WWV:scope_draw(tc.trig<=tc.sample_point,r,void 0,tc.data?-.3:-.6,0,0);break;case tc.sig.WWVBa:scope_draw(tc.trig>=0&&tc.trig<=tc.sample_point,r,void 0,tc.data?-.3:-.6,0,0);break;case tc.sig.WWVBp:scope_draw(n,tc.trig==tc.sample_point?{num:.1,color:"blue"}:r,o>=0?void 0:o,tc.trig==tc.sample_point&&isDefined(p)?p>0?.5:-.5:void 0,tc.data?0:{num:0,color:"purple"},tc.trig==tc.sample_point);break;case tc.sig.DCF77a:scope_draw(tc.trig<=tc.sample_point,r,void 0,tc.data?-.3:-.6,0,0);break;case tc.sig.TDF:scope_draw(0,Math.abs(d)>=.3?d:{num:d,color:"orange"},1==tc.trig?{num:1,color:"purple"}:void 0,tc.trig>1?2==tc.trig?.7:.9:tc.no_modulation?-.9:-.7,0,tc.mkr?1==tc.mkr?1:{num:1,color:"blue"}:0),tc.trig=0,tc.mkr=0;break;case tc.sig.MSF:scope_draw(tc.trig<=tc.sample_point,r,void 0,tc.data?-.6:-.3,0,0);break;case tc.sig.BPCa:scope_draw(tc.trig>=0&&tc.trig<=tc.sample_point,r,void 0,tc.data?-.6:-.3,0,0);break;case tc.sig.JJY40:case tc.sig.JJY60:scope_draw(tc.trig>=0&&tc.trig<=tc.sample_point,r,void 0,tc.data?-.3:-.6,0,0);break;case tc.sig.RBU:case tc.sig.RTZ:scope_draw(tc.trig>=0&&tc.trig<=tc.sample_point,r,void 0,tc.data?-.3:-.6,0,0)}}else console.log("tc_recv: DATA UNKNOWN cmd="+s+" len="+len)}}function tc_controls_setup(){var t=time_display_html("tc")+w3_div("id-tc-data|width:1024px; height:200px; background-color:black; position:relative;",'<canvas id="id-tc-scope" width="1024" height="200" style="position:absolute"></canvas>');tc.save_mode=ext_get_mode(),tc.save_agc_delay=ext_agc_delay(5e3),tc.config=tc.sig.WWVBp,tc.pll_bw=tc.pll_bw_i[tc.config];var e=w3_div("id-tc-controls w3-text-white|height:100%",w3_col_percent("",w3_div("w3-medium w3-text-aqua","<b>Time station decoder</b>"),25,w3_div("id-tc-no-audio w3-text-css-lime w3-hide","No audio will be heard due to zero-IF mode used"),60),w3_inline("w3-margin-T-8/w3-margin-right",w3_select_conditional("w3-text-red","","","tc.config",tc.config,tc.sig_s,"tc_signal_menu_cb"),w3_button("w3-padding-small w3-css-yellow","Re-sync","timecode_resync_cb"),w3_button("w3-padding-small w3-aqua","Reset PLL","timecode_reset_pll_cb"),w3_input("w3-padding-tiny w3-label-inline w3-label-not-bold|width:auto|size=3","pll bw:","tc.pll_bw",tc.pll_bw,"timecode_pll_bw_cb"),w3_div("",'<pre id="id-tc-info" style="margin:0"></pre>')),w3_inline("w3-margin-T-4/w3-margin-right",w3_div("id-tc-status w3-show-inline-block"),w3_div("id-tc-status2 w3-show-inline-block")),w3_div("id-tc-addon"),w3_div("w3-scroll w3-margin-TB-8 w3-grey-white|height:70%",'<pre id="id-tc-dbug"></pre>'));ext_panel_show(e,t,null),time_display_setup("tc"),tc.sigid_s.forEach(function(t){w3_call(t+"_init")}),tc_environment_changed({resize:1}),ext_set_controls_width_height(900);var c=ext_param();if(c){var i;for(c=(c=c.split(",")[0]).toLowerCase(),i=0;i<tc.sig_s.length&&(!tc.sig_s[i][1]||!tc.sig_s[i][0].toLowerCase().includes(c));i++);i<tc.sig_s.length&&(tc.config=i,w3_select_value("tc.config",i))}ext_send("SET draw=0"),ext_send("SET display_mode=0"),ext_send("SET gain=0"),tc_signal_menu_cb("tc.config",tc.config,!1),ext_send("SET run=1")}function tc_environment_changed(t){if(t.resize){var e=w3_el("id-tc-data"),c=(window.innerWidth-1024-time_display_width())/2;e.style.left=px(c)}}function tc_signal_menu_cb(t,e,c){if(!c){if(e=+e,tc.config=e,w3_select_value(t,e),tc_info(w3_link("",tc.sig_s[tc.config][3],"Time station info: "+tc.sig_s[tc.config][2])),w3_call(tc.sigid_s[tc.prev_sig]+"_blur"),2==tc.sig_s[tc.config][1])return scope_clr(),tc_stat("",""),tc_stat2("",""),w3_hide("id-tc-no-audio"),tc_dmsg(),void tc_dmsg('This station can be decoded using the FSK extension (see "Ham/Utility" menu).');tc.prev_sig=e,timecode_update_srate();var i=0==tc.pll_off_i[tc.config]?1:0;w3_show_hide("id-tc-no-audio",i),ext_tune(tc.freq[e],"cwn",ext_zoom.ABS,12);var s=tc.pll_off_i[tc.config];switch(ext_set_passband(s-tc.pb[e]/2,s+tc.pb[e]/2),ext_tune(tc.freq[e],"cwn",ext_zoom.ABS,12),tc.pll_bw=tc.pll_bw_i[tc.config],timecode_pll_bw_cb("tc.pll_bw",tc.pll_bw,!0,!1),ext_send("SET pll_offset="+s),ext_send("SET pll_mode=1 arg="+(i?2:1)),e){case tc.sig.WWVBa:case tc.sig.WWVBp:case tc.sig.WWV:wwvb_focus(),scope_init(w3_el("id-tc-scope"),{sec_per_sweep:10,srate:tc.srate,single_shot:0,background_color:"#f5f5f5"});break;case tc.sig.DCF77a:dcf77_focus(),scope_init(w3_el("id-tc-scope"),{sec_per_sweep:10,srate:tc.srate,single_shot:0,background_color:"#f5f5f5"});break;case tc.sig.MSF:scope_init(w3_el("id-tc-scope"),{sec_per_sweep:10,srate:tc.srate,single_shot:0,background_color:"#f5f5f5"});break;case tc.sig.BPCa:scope_init(w3_el("id-tc-scope"),{sec_per_sweep:20,srate:tc.srate,single_shot:0,background_color:"#f5f5f5"});break;case tc.sig.JJY40:case tc.sig.JJY60:jjy_focus(),scope_init(w3_el("id-tc-scope"),{sec_per_sweep:10,srate:tc.srate,single_shot:0,background_color:"#f5f5f5"});break;case tc.sig.RBU:case tc.sig.RTZ:rus_focus(),scope_init(w3_el("id-tc-scope"),{sec_per_sweep:10,srate:tc.srate,single_shot:0,background_color:"#f5f5f5"});break;case tc.sig.TDF:tdf_focus(),scope_init(w3_el("id-tc-scope"),{sec_per_sweep:3,srate:tc.srate,single_shot:0,background_color:"#f5f5f5"});break;default:scope_init(w3_el("id-tc-scope"),{sec_per_sweep:1,srate:tc.srate,single_shot:0,background_color:"#f5f5f5"})}timecode_resync_cb();var a=ext_get_passband();tc.pb_cf=a.low+(a.high-a.low)/2}}function timecode_resync_cb(t,e){tc_dmsg(),tc_stat("yellow",w3_inline("",w3_icon("w3-text-aqua","fa-cog fa-spin",20),w3_div("w3-margin-L-8 w3-text-css-yellow","Looking for sync"))),tc.raw=[],tc.state=tc.ACQ_SYNC,tc.sample_point=-1,tc.data_last=tc.data=0,tc.ref=0,w3_call(tc.sigid_s[tc.config]+"_clr"),scope_clr()}function timecode_reset_pll_cb(t,e){ext_send("SET clear")}function timecode_pll_bw_cb(t,e,c,i){console.log("timecode_pll_bw_cb path="+t+" val="+e+" first="+i),i||(e=+e,tc.pll_bw=e,w3_set_value(t,e),ext_send("SET pll_bandwidth="+e))}function timecode_update_srate(){var t=ext_sample_rate();tc.srate!=t&&(tc.srate=t,tc.srate_upd++)}function timecode_blur(){ext_send("SET run=0"),kiwi_clearInterval(tc.interval),ext_set_mode(tc.save_mode),ext_agc_delay(tc.save_agc_delay)}function timecode_config_html(){ext_config_html(tc,"timecode","Timecode","Timecode decoder configuration")}


