

/* web/extensions/FSK/Selcall.min.js (web/extensions/FSK/Selcall.js = Fri Jun 10 08:11:18 2022) */
function Selcall(e,s){var r=this;console.log("FSK encoder: Selcall"),r.dbg=0,r.dump_always=1,r.dump_non_std_len=1,r.dump_no_eos=0,r.zoom=10,r.start_bit=0,r.seq=0,r.pkt=0,r.MSG_LEN_MIN=30,r.MSG_LEN_MAX=80,r.synced=0,r.sym_s=["   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","RTN","   ","   ","   ","Pr0","Pr1","Pr2","Pr3","Pr4","Pr5","   ","   ","   ","   ","   ","   ","   ","ARQ","   ","   ","SEL","   ","ABQ","SMA","   ","Pdx","  *","EOS"],r.DX=125,r.RX5=109,r.FMT_GEO_AREA=102,r.FMT_DISTRESS=112,r.FMT_COMMON_INTEREST=114,r.FMT_ALL_SHIPS=116,r.FMT_INDIV_STA=120,r.FMT_RESV=121,r.FMT_IS_SEMI_AUTO=123,r.CAT_ROUTINE=100,r.CAT_SAFETY=108,r.CAT_URGENCY=110,r.CAT_DISTRESS=112,r.CMD1_FM_CALL=100,r.CMD1_FM_DUPLEX_CALL=101,r.CMD1_POLLING=103,r.CMD1_UNABLE_COMPLY=104,r.CMD1_END_OF_CALL=105,r.CMD1_F1B_DATA=106,r.CMD1_J3E_RT=109,r.CMD1_DISTRESS_ACK=110,r.CMD1_DISTRESS_ALERT_RELAY=112,r.CMD1_F1B_FEC=113,r.CMD1_F1B_ARQ=115,r.CMD1_TEST=118,r.CMD1_POSITION=121,r.CMD1_NOP=126,r.CMD2_UNABLE_FIRST=100,r.CMD2_BUSY=102,r.CMD2_UNABLE_LAST=109,r.CMD2_NON_CONFLICT=110,r.CMD2_MED_TRANSPORTS=111,r.CMD2_NOP=126,r.ARQ=117,r.ABQ=122,r.EOS=127,r.NOP=126,r.pos_s=["dx","rx5","dx","rx4","dx","rx3","dx","rx2","dx","rx1","dx","rx0","fmt","fmt","B1","fmt","B2","fmt","cat","B1","A1","B2","A2","cat","eos","A1","eos","A2","eos","eos"],r.pos={},r.pos_n={},r.pos_s.forEach(function(e,s){e=e.trim(),isDefined(r.pos_n[e])||(r.pos_n[e]=0),r.pos[e+"-"+r.pos_n[e].toString()]=s,r.pos_n[e]++}),r.dbg&&console.log(r.pos);function n(e){return e=kiwi_bitCount(127^e),kiwi_bitReverse(e,3)}r.DX_w=n(r.DX)<<7|r.DX,r.svec=[];for(var o=r.RX5,_=0;_<12;_++)r.svec[_]=1&_?n(o)<<7|o:r.DX_w,1&_&&o--;r.dbg&&console.log(r.svec)}Selcall.prototype.sym_by_sym_name=function(e){e=this.pos[e];return{pos:e,sym:this.syms[e]}},Selcall.prototype.output_msg=function(e){return(new Date).toUTCString().substr(17,8)+" "+(ext_get_freq()/1e3).toFixed(2)+" "+e+"\n"},Selcall.prototype.code_to_char=function(e){return e<0||127<e?"???":this.sym_s[e]},Selcall.prototype.reset=function(){var e=this;e.syncA=e.syncB=e.syncC=e.syncD=e.syncE=0},Selcall.prototype.get_nbits=function(){return 10},Selcall.prototype.get_msb=function(){return 512},Selcall.prototype.check_bits=function(){return!1},Selcall.prototype.search_sync=function(e){var s=this,r=e,e=1&s.syncA;s.syncA=s.syncA>>1&1023,s.syncA|=r?512:0,r=e,e=1&s.syncB,s.syncB=s.syncB>>1&1023,s.syncB|=r?512:0,r=e,e=1&s.syncC,s.syncC=s.syncC>>1&1023,s.syncC|=r?512:0,r=e,e=1&s.syncD,s.syncD=s.syncD>>1&1023,s.syncD|=r?512:0,r=e,e=1&s.syncE,s.syncE=s.syncE>>1&1023,s.syncE|=r?512:0;for(var n=0;n<=9;n++)if(s.syncC==s.svec[n]&&s.syncB==s.svec[n+1]&&s.syncA==s.svec[n+2])return console.log("SYNC-DRD-"+n),s.seq=n+3,s.full_syms=[],s.syms=[],s.bc_err=[],s.parity_errors=0,s.FEC_errors=0,s.synced=1,!0;for(n=1;n<=7;n+=2)if(s.syncE==s.svec[n]&&s.syncC==s.svec[n+2]&&s.syncA==s.svec[n+4])return console.log("SYNC-RRR-"+n),s.seq=n+5,s.full_syms=[],s.syms=[],s.bc_err=[],s.parity_errors=0,s.FEC_errors=0,s.synced=1,!0;return s.synced=0,!1},Selcall.prototype.process_char=function(e,s,r,n,o){var _=this;if(!_.synced)return{resync:0};12==_.seq&&_.pkt++;var t=(_.full_syms[_.seq]=e)>>7&7,c=127&e;_.syms[_.seq]=c,R=(R=_.pos_s[_.seq])||"unk";var i=_.code_to_char(c),l=(h=(T=kiwi_bitReverse(t,3))!=(N=kiwi_bitCount(127^c)))?" Zck="+T+" Zdata="+N:"";(_.bc_err[_.seq]=h)&&_.parity_errors++,_.dbg&&console.log(_.seq.leadingZeros(2)+" "+R.fieldWidth(6)+": "+i+" "+c.fieldWidth(3)+". "+t.toString(2).leadingZeros(3)+" "+c.toString(2).leadingZeros(7)+l),_.seq++;var a=!1;if(_.seq>=_.MSG_LEN_MIN){function y(e,s){return e+s+ansi.NORM}function u(e,s){return"https://www.marinetraffic.com/en/ais/home/centerx:"+s+"/centery:"+e+"/zoom:"+_.zoom}function S(e,s,r){return w3_link("w3-esc-html w3-link-darker-color",u(s,r),e)}function d(e){var s={code:127&_.full_syms[e],fec_err:!1};if(_.bc_err[e]){if(e+5<_.seq&&!_.bc_err[e+5])return s.code=127&_.full_syms[e+5],s;s.code=-1,s.fec_err=!0}return s}var f=function(e){var s=0;return _.bc_err[_.seq-1]||_.syms[_.seq-1]!=e||s++,_.bc_err[_.seq-2]||_.syms[_.seq-2]!=e||s++,_.bc_err[_.seq-4]||_.syms[_.seq-4]!=e||s++,_.bc_err[_.seq-6]||_.syms[_.seq-6]!=e||s++,3<=s&&console.log("eos_n("+e+")="+s),3<=s};if((a=f(_.EOS)||f(_.ARQ)||f(_.ABQ)?!0:a)||_.seq>_.MSG_LEN_MAX){var p=_.dump_always;if(a?_.seq!=_.MSG_LEN_MIN&&(console.log("$$ non-std len="+_.seq),p|=_.dump_non_std_len):(h=_.parity_errors?" "+y(ansi.BLUE,_.parity_errors+" PE"):"",console.log("$$ no EOS pe="+_.parity_errors),p|=_.dump_no_eos),p){for(var C,E,M=!1,A=-1,D=0,m=[],T=ext_get_freq()/1e3,g=(new Date).toUTCString().substr(17,8)+" "+T.toFixed(2)+" ",N=d(12).code,L=0;L<_.seq;L++){var R,v,O,T,e=_.full_syms[L],c=127&(e=isUndefined(e)?119:e);R=(R=_.pos_s[L])||"unk",1&L||L<12||(c=(v=d(L)).code,v.fec_err&&(M=!0),14==L&&(99<d(18).code?(m.push("  "),g+="__ "):d(20).code),20==L&&(99<(E=d(24).code)?(m.push("  "),g+="__ "):E=d(28).code),v.fec_err?(g+="X ",O="0"):(D!=(O=c<=99?c.leadingZeros(2):c.toString()).length&&(A=(A+1)%ansi.rolling_n,C=ansi[ansi.rolling[A]],D=O.length),g+=C+O+ansi.NORM+" "),m.push(O))}i=null;if(M)g+=y(ansi.RED,"FEC");else{if(N==_.FMT_IS_SEMI_AUTO&&E==_.CMD1_POSITION){for(var F,t=+m[1]?y(ansi.CYAN,m[1]+m[2]+m[3]):y(ansi.CYAN,"__"+m[2]+m[3]),l=+m[5]?(F=m[5]+m[6]+m[7],y(ansi.YELLOW,F)):(F=m[6]+m[7],y(ansi.YELLOW,"__"+F)),i=l+" calling "+t,b="",L=0;L<=6;L++)b+=m[L+10];var f=b.slice(1,3),a=b.slice(5,8),h=b.slice(3,5),p=b.slice(8,10),N=f+"."+h,l=a+"."+p;i+=", position "+S("["+N+","+l+"]",+N,+l);t=!1,N=+h,l=+p;60<=N&&(N=59,t=!0),60<=l&&(l=59,t=!0);var h=f+"°"+h+"'",p=a+"°"+p+"'",N=f+(N/60).toFixed(2).slice(1),l=a+(l/60).toFixed(2).slice(1);i+=" "+S("["+h+","+p+"]",+N,+l),i+=" "+b.slice(10,12)+":"+b.slice(12,14),navtex_location_update(F,+N,+l,u(+N,+l),t?["white","red"]:["white",T<7500?"magenta":"blue"])&&(i+=" "+y(ansi.YELLOW,"(dupe)"))}i=i&&(new Date).toUTCString().substr(17,8)+" "+T.toFixed(2)+" "+i}console.log("fec_errors="+M+" show_errs="+o),!M&&i&&r(i+"\n"),(!M&&(!i||n)||M&&o)&&r(g+"\n")}return _.synced=0,{resync:1}}}return{resync:0}};



