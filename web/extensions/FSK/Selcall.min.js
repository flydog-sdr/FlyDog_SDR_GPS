

/* web/extensions/FSK/Selcall.min.js (web/extensions/FSK/Selcall.js = Fri Jun  3 19:25:52 2022) */
function Selcall(e,s){var r=this;console.log("FSK encoder: Selcall"),r.dbg=0,r.dump_always=1,r.dump_non_std_len=1,r.dump_no_eos=0,r.zoom=10,r.start_bit=0,r.seq=0,r.pkt=0,r.MSG_LEN_MIN=30,r.MSG_LEN_MAX=80,r.synced=0,r.sym_s=["   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","RTN","   ","   ","   ","Pr0","Pr1","Pr2","Pr3","Pr4","Pr5","   ","   ","   ","   ","   ","   ","   ","ARQ","   ","   ","SEL","   ","ABQ","SMA","   ","Pdx","  *","EOS"],r.DX=125,r.RX5=109,r.FMT_GEO_AREA=102,r.FMT_DISTRESS=112,r.FMT_COMMON_INTEREST=114,r.FMT_ALL_SHIPS=116,r.FMT_INDIV_STA=120,r.FMT_RESV=121,r.FMT_IS_SEMI_AUTO=123,r.CAT_ROUTINE=100,r.CAT_SAFETY=108,r.CAT_URGENCY=110,r.CAT_DISTRESS=112,r.CMD1_FM_CALL=100,r.CMD1_FM_DUPLEX_CALL=101,r.CMD1_POLLING=103,r.CMD1_UNABLE_COMPLY=104,r.CMD1_END_OF_CALL=105,r.CMD1_F1B_DATA=106,r.CMD1_J3E_RT=109,r.CMD1_DISTRESS_ACK=110,r.CMD1_DISTRESS_ALERT_RELAY=112,r.CMD1_F1B_FEC=113,r.CMD1_F1B_ARQ=115,r.CMD1_TEST=118,r.CMD1_POSITION=121,r.CMD1_NOP=126,r.CMD2_UNABLE_FIRST=100,r.CMD2_BUSY=102,r.CMD2_UNABLE_LAST=109,r.CMD2_NON_CONFLICT=110,r.CMD2_MED_TRANSPORTS=111,r.CMD2_NOP=126,r.ARQ=117,r.ABQ=122,r.EOS=127,r.NOP=126,r.pos_s=["dx","rx5","dx","rx4","dx","rx3","dx","rx2","dx","rx1","dx","rx0","fmt","fmt","B1","fmt","B2","fmt","cat","B1","A1","B2","A2","cat","eos","A1","eos","A2","eos","eos"],r.pos={},r.pos_n={},r.pos_s.forEach(function(e,s){e=e.trim(),isDefined(r.pos_n[e])||(r.pos_n[e]=0),r.pos[e+"-"+r.pos_n[e].toString()]=s,r.pos_n[e]++}),r.dbg&&console.log(r.pos);function n(e){return e=kiwi_bitCount(127^e),kiwi_bitReverse(e,3)}r.DX_w=n(r.DX)<<7|r.DX,r.svec=[];for(var o=r.RX5,_=0;_<12;_++)r.svec[_]=1&_?n(o)<<7|o:r.DX_w,1&_&&o--;r.dbg&&console.log(r.svec)}Selcall.prototype.sym_by_sym_name=function(e){e=this.pos[e];return{pos:e,sym:this.syms[e]}},Selcall.prototype.output_msg=function(e){return(new Date).toUTCString().substr(17,8)+" "+(ext_get_freq()/1e3).toFixed(2)+" "+e+"\n"},Selcall.prototype.code_to_char=function(e){return e<0||127<e?"???":this.sym_s[e]},Selcall.prototype.reset=function(){var e=this;e.syncA=e.syncB=e.syncC=e.syncD=e.syncE=0},Selcall.prototype.get_nbits=function(){return 10},Selcall.prototype.get_msb=function(){return 512},Selcall.prototype.check_bits=function(){return!1},Selcall.prototype.search_sync=function(e){var s=this,r=e,e=1&s.syncA;s.syncA=s.syncA>>1&1023,s.syncA|=r?512:0,r=e,e=1&s.syncB,s.syncB=s.syncB>>1&1023,s.syncB|=r?512:0,r=e,e=1&s.syncC,s.syncC=s.syncC>>1&1023,s.syncC|=r?512:0,r=e,e=1&s.syncD,s.syncD=s.syncD>>1&1023,s.syncD|=r?512:0,r=e,e=1&s.syncE,s.syncE=s.syncE>>1&1023,s.syncE|=r?512:0;for(var n=0;n<=9;n++)if(s.syncC==s.svec[n]&&s.syncB==s.svec[n+1]&&s.syncA==s.svec[n+2])return console.log("SYNC-DRD-"+n),s.seq=n+3,s.full_syms=[],s.syms=[],s.bc_err=[],s.parity_errors=0,s.FEC_errors=0,s.synced=1,!0;for(n=1;n<=7;n+=2)if(s.syncE==s.svec[n]&&s.syncC==s.svec[n+2]&&s.syncA==s.svec[n+4])return console.log("SYNC-RRR-"+n),s.seq=n+5,s.full_syms=[],s.syms=[],s.bc_err=[],s.parity_errors=0,s.FEC_errors=0,s.synced=1,!0;return s.synced=0,!1},Selcall.prototype.process_char=function(e,s,r,n){var o=this;if(!o.synced)return{resync:0};12==o.seq&&o.pkt++;var _=(o.full_syms[o.seq]=e)>>7&7,t=127&e;o.syms[o.seq]=t,m=(m=o.pos_s[o.seq])||"unk";var c=o.code_to_char(t),i=(v=(f=kiwi_bitReverse(_,3))!=(h=kiwi_bitCount(127^t)))?" Zck="+f+" Zdata="+h:"";(o.bc_err[o.seq]=v)&&o.parity_errors++,o.dbg&&console.log(o.seq.leadingZeros(2)+" "+m.fieldWidth(6)+": "+c+" "+t.fieldWidth(3)+". "+_.toString(2).leadingZeros(3)+" "+t.toString(2).leadingZeros(7)+i),o.seq++;var l=!1;if(o.seq>=o.MSG_LEN_MIN){function y(e,s){return"https://www.marinetraffic.com/en/ais/home/centerx:"+s+"/centery:"+e+"/zoom:"+o.zoom}function a(e){var s={code:127&o.full_syms[e],fec_err:!1};if(o.bc_err[e]){if(e+5<o.seq&&!o.bc_err[e+5])return s.code=127&o.full_syms[e+5],s;s.code=-1,s.fec_err=!0}return s}var u=function(e){var s=0;return o.bc_err[o.seq-1]||o.syms[o.seq-1]!=e||s++,o.bc_err[o.seq-2]||o.syms[o.seq-2]!=e||s++,o.bc_err[o.seq-4]||o.syms[o.seq-4]!=e||s++,o.bc_err[o.seq-6]||o.syms[o.seq-6]!=e||s++,3<=s&&console.log("eos_n("+e+")="+s),3<=s},S=function(e,s){return e+s+ansi.NORM},f=function(e,s,r){return w3_link("w3-esc-html w3-link-darker-color",y(s,r),e)};if((l=u(o.EOS)||u(o.ARQ)||u(o.ABQ)?!0:l)||o.seq>o.MSG_LEN_MAX){h=o.dump_always;if(l?o.seq!=o.MSG_LEN_MIN&&(console.log("$$ non-std len="+o.seq),h|=o.dump_non_std_len):(v=o.parity_errors?" "+S(ansi.BLUE,o.parity_errors+" PE"):"",console.log("$$ no EOS pe="+o.parity_errors),h|=o.dump_no_eos),h){for(var d,p=!1,C=-1,E=0,M=[],c=ext_get_freq()/1e3,D=(new Date).toUTCString().substr(17,8)+" "+c.toFixed(2)+" ",A=0;A<o.seq;A++){var m,T,g,f,e=o.full_syms[A],t=127&(e=isUndefined(e)?119:e);m=(m=o.pos_s[A])||"unk",1&A||A<12||(t=(T=a(A)).code,T.fec_err&&(p=!0),14==A&&99<a(18).code&&(M.push("  "),D+="__ "),20==A&&99<a(24).code&&(M.push("  "),D+="__ "),T.fec_err?(D+="X ",g="0"):(E!=(g=t<=99?t.leadingZeros(2):t.toString()).length&&(C=(C+1)%ansi.rolling_n,d=ansi[ansi.rolling[C]],E=g.length),D+=d+g+ansi.NORM+" "),M.push(g))}if(p)D+=S(ansi.RED,"FEC");else{var N=0;if(N=121==+M[8]?10:N){for(var R="",A=0;A<=6;A++)R+=M[N+A];var _=R.slice(1,3),i=R.slice(5,8),u=R.slice(3,5),l=R.slice(8,10),v=_+"."+u,h=i+"."+l;D+=f("["+v+","+h+"]",+v,+h),D+=f("*",-v,+h)+" ";S=!1,v=+u,h=+l;60<=v&&(v=59,S=!0),60<=h&&(h=59,S=!0);u=_+"°"+u+"'",l=i+"°"+l+"'",v=_+(v/60).toFixed(2).slice(1),h=i+(h/60).toFixed(2).slice(1);D+=f("["+u+","+l+"]",+v,+h)+" ";l=(0!=+M[5]?M[5]:"")+M[6]+M[7];navtex_location_update(l,+v,+h,y(+v,+h),S?["white","red"]:["white",c<7500?"magenta":"blue"]),D+=R.slice(10,12)+":"+R.slice(12,14)}}console.log("fec_errors="+p+" show_errs="+n),p&&!n||r(D+"\n")}return o.synced=0,{resync:1}}}return{resync:0}};



