

/* web/extensions/FSK/JNX.min.js (web/extensions/FSK/JNX.js = Sun May 29 11:21:22 2022) */
function JNX(){var t=this;t.init=!0,t.State_e={NOSIGNAL:0,SYNC1:1,SYNC2:2,READ_DATA:3,FIXED_LENGTH:4},t.states=["NOSIGNAL","SYNC1","SYNC2","READ_DATA","FIXED_LENGTH"],t.state=t.State_e.NOSIGNAL,t.fp_OFF=0,t.fp_WAIT=1,t.fp_WAIT2=2,t.fp_START=3,t.fp_PASS=4,t.fp_SYNC=5,t.fp_SYNC_START=6,t.invsqr2=1/Math.sqrt(2),t.audio_average=0,t.signal_accumulator=0,t.bit_duration=0,t.succeed_tally=t.fail_tally=0,t.bit_count=t.code_bits=t.code_word=t.idle_word=0,t.error_count=t.valid_count=0,t.inverted=0,t.biquad_mark=new BiQuadraticFilter,t.biquad_space=new BiQuadraticFilter,t.biquad_lowpass=new BiQuadraticFilter}JNX.prototype.setup_values=function(t,e,_,s,a,c,o,n){var i=this;switch(i.sample_rate=t,i.center_frequency_f=null==e?500:e,i.baud_rate=null==s?100:s,i.shift_Hz=null==_?850:_,i.deviation_f=i.shift_Hz/2,i.lowpass_filter_f=140,i.audio_average_tc=1e3/t,i.audio_minimum=256,i.baud_rate=i.baud_rate<10?10:i.baud_rate,i.bit_duration_seconds=1/i.baud_rate,i.bit_sample_count=Math.floor(i.sample_rate*i.bit_duration_seconds+.5),i.trace&&console.log("JNX bit_sample_count="+i.bit_sample_count+" sr+bds="+i.sample_rate*i.bit_duration_seconds),i.half_bit_sample_count=i.bit_sample_count/2,i.framing=a,i.stop_variable=a.endsWith("V")||a.includes("EFR")?1:0,"CHU"==a?(i.fp=i.fp_WAIT,i.fp_mark_bits=32,i.fp_pass_bits=110):i.fp="DSC"==o||"Selcall"==o?i.fp_SYNC:i.fp_OFF,i.inverted=c,i.show_errs=n,o){case"ITA2":case"ASCII":default:i.encoding=new FSK_async(a,o);break;case"CCIR476":i.encoding=new CCIR476;break;case"DSC":i.encoding=new DSC(i.init,i.output_char_cb),i.init=!1;break;case"Selcall":i.encoding=new Selcall(i.init,i.output_char_cb),i.init=!1}i.msb=i.encoding.get_msb(),i.nbits=i.encoding.get_nbits(),i.pulse_edge_event=!1,i.error_count=0,i.valid_count=0,i.bbuffer=[],i.out_buffer=[],i.sbuffer=[],i.sample_count=0,i.next_event_count=0,i.averaged_mark_state=0,i.zero_crossing_samples=16,i.zero_crossings_divisor=4,i.zero_crossing_count=0,i.zero_crossings=[],i.sync_delta=0,i.update_filters(),i.state=i.State_e.NOSIGNAL},JNX.prototype.set_baud_error_cb=function(t){this.baud_error_cb=t},JNX.prototype.set_scope_cb=function(t){this.scope_cb=t},JNX.prototype.set_output_char_cb=function(t){this.output_char_cb=t},JNX.prototype.set_output_bit_cb=function(t){this.output_bit_cb=t},JNX.prototype.get_encoding_obj=function(t){return this.encoding},JNX.prototype.update_filters=function(){this.set_filter_values(),this.configure_filters()},JNX.prototype.set_filter_values=function(){var t=this;t.mark_space_filter_q=6*t.center_frequency_f/1e3;var e=t.center_frequency_f+4e3/t.center_frequency_f;t.mark_f=e+t.deviation_f,t.space_f=e-t.deviation_f},JNX.prototype.configure_filters=function(){var t=this;t.biquad_mark.configure(t.biquad_mark.Type_e.BANDPASS,t.mark_f,t.sample_rate,t.mark_space_filter_q),t.biquad_space.configure(t.biquad_space.Type_e.BANDPASS,t.space_f,t.sample_rate,t.mark_space_filter_q),t.biquad_lowpass.configure(t.biquad_lowpass.Type_e.LOWPASS,t.lowpass_filter_f,t.sample_rate,t.invsqr2)},JNX.prototype.set_state=function(t){var e=this;t!=e.state&&(e.state=t,e.trace&&console.log("New state: "+e.states[e.state]))},JNX.prototype.process_data=function(t,e){for(var _=this,s=0;s<e;s++){var a=t[s],c=_.biquad_mark.filter(a),o=_.biquad_space.filter(a),n=Math.abs(c),i=Math.abs(o);_.audio_average+=(Math.max(n,i)-_.audio_average)*_.audio_average_tc,_.audio_average=Math.max(.1,_.audio_average);i=n-i;i/=_.audio_average,_.audio_average,_.audio_average,o/=_.audio_average;o=_.biquad_lowpass.filter(i),i=0<o;if(_.signal_accumulator+=i?1:-1,_.bit_duration++,null!=_.zero_crossings)if(i!=_.old_mark_state&&(_.bit_duration%_.bit_sample_count>_.half_bit_sample_count&&(l=Math.floor((_.sample_count-_.next_event_count+8*_.bit_sample_count)%_.bit_sample_count),_.zero_crossings[l/_.zero_crossings_divisor]++),_.bit_duration=0),_.old_mark_state=i,_.sample_count%_.bit_sample_count==0&&(_.zero_crossing_count++,_.zero_crossing_count>=_.zero_crossing_samples)){for(var r,u=0,l=0,p=0;p<_.zero_crossings.length;p++)r=_.zero_crossings[p],_.zero_crossings[p]=0,u<r&&(u=r,l=p);0<u&&(l=((l*=_.zero_crossings_divisor)+_.half_bit_sample_count)%_.bit_sample_count-_.half_bit_sample_count,l/=8,_.sync_delta=l,_.baud_error=l,_.baud_error_cb(_.baud_error)),_.zero_crossing_count=0}if(_.pulse_edge_event=_.sample_count>=_.next_event_count,_.pulse_edge_event&&(_.averaged_mark_state=0<_.signal_accumulator^_.inverted,_.signal_accumulator=0,_.next_event_count=_.sample_count+_.bit_sample_count+Math.floor(_.sync_delta+.5),_.sync_delta=0),_.scope_cb&&_.scope_cb(o,_.pulse_edge_event?1:0,_.averaged_mark_state?1:0),_.output_bit_cb&&_.pulse_edge_event&&_.output_bit_cb(_.averaged_mark_state?1:0),_.audio_average<_.audio_minimum&&_.state!=_.State_e.NOSIGNAL?_.set_state(_.State_e.NOSIGNAL):_.state==_.State_e.NOSIGNAL&&(_.sync_setup=1),_.pulse_edge_event){var b=_.averaged_mark_state?1:0;if(_.fp!=_.fp_START&&_.fp!=_.fp_PASS||(_.fp==_.fp_START&&(_.fp=_.fp_PASS),_.fp_count++,_.fp_count>_.fp_pass_bits&&(_.fp=_.fp_WAIT)),_.fp==_.fp_WAIT||_.fp==_.fp_WAIT2){if(_.fp==_.fp_WAIT&&(_.fp_count=0,_.fp=_.fp_WAIT2,_.trace&&console.log("fp_WAIT")),!(_.fp_count>=_.fp_mark_bits&&0==b)){1==b?_.fp_count++:_.fp_count=0,_.sample_count++;continue}_.fp_count=0,_.sync_setup=1,_.fp=_.fp_START,_.trace&&console.log("fp_START")}if(_.chu_dbg&&(_.fp==_.fp_START&&(_.chu_bn=0,_.chu_cc=0,_.chu_s1=""),0==_.chu_bn&&(_.chu_s=b+" ",_.chu_v=0),1<=_.chu_bn&&_.chu_bn<=8&&(_.chu_s+=b,_.chu_v>>=1,_.chu_v|=b?128:0),8==_.chu_bn&&(_.chu_s+=" "),9<=_.chu_bn&&_.chu_bn<=10&&(_.chu_s+=b,_.chu_s1+=b),10==_.chu_bn?(o=(15&(o=_.chu_v))<<4&240|(240&o)>>>4&15,_.chu_s=_.chu_cc.leadingZeros(2)+": "+_.chu_s+" "+o.toHex(-2)+" ^"+(255^o).toHex(-2)+" ",_.chu_s1+="_"+o.toHex(-2)+" ",_.chu_bn=0,_.chu_cc++,5==_.chu_cc&&(_.chu_s1+=" |  "),10==_.chu_cc&&(_.chu_bn=11,_.chu_cc=0,console.log(_.chu_s1))):_.chu_bn++),_.fp==_.fp_SYNC&&_.encoding.search_sync(b))_.sync_setup=1,_.fp=_.fp_SYNC_START,_.sample_count++;else{switch(_.sync_setup&&(_.bit_count=0,_.code_bits=0,_.error_count=0,_.valid_count=0,_.encoding.reset(),_.sync_chars=[],_.fp==_.fp_START||_.fp==_.fp_SYNC_START?_.set_state(_.State_e.FIXED_LENGTH):_.set_state(_.State_e.SYNC1),_.sync_setup=0),_.state){case _.State_e.NOSIGNAL:break;case _.State_e.SYNC1:_.code_bits=_.code_bits>>1|(b?_.msb:0),_.dbg&&console.log("SYNC1 "+(b?1:0)+" 0x"+_.code_bits.toString(16)),_.encoding.check_bits(_.code_bits)&&(_.sync_chars.push(_.code_bits),_.valid_count++,_.dbg&&console.log("SYNC1 OK: first valid sync_chars. len="+_.sync_chars.length),_.bit_count=0,_.code_bits=0,_.set_state(_.State_e.SYNC2),_.waiting=!0);break;case _.State_e.SYNC2:if(_.stop_variable&&_.waiting&&1==b){_.dbg&&console.log("SYNC2 waiting");break}if(_.waiting=!1,_.code_bits=_.code_bits>>1|(b?_.msb:0),_.dbg&&console.log("SYNC2-"+_.bit_count+" "+(b?1:0)+" 0x"+_.code_bits.toString(16)),_.bit_count++,_.bit_count==_.nbits){if(_.dbg&&console.log("SYNC2 0x"+_.code_bits.toString(16)),_.encoding.check_bits(_.code_bits)){if(_.sync_chars.push(_.code_bits),_.code_bits=0,_.bit_count=0,_.valid_count++,_.dbg&&console.log("SYNC2 OK: valid_count="+_.valid_count+" sync_chars.len="+_.sync_chars.length),4==_.valid_count){for(var d,f=0;f<_.sync_chars.length;f++)1==(d=_.encoding.process_char(_.sync_chars[f],0,_.output_char_cb)).tally?_.succeed_tally++:-1==d.tally&&_.fail_tally++;_.set_state(_.State_e.READ_DATA),_.dbg&&console.log("READ_DATA sync_chars.len="+_.sync_chars.length)}}else _.code_bits=0,_.bit_count=0,_.dbg&&console.log("SYNC2 BAD: restarting sync"),_.sync_setup=1;_.waiting=!0}break;case _.State_e.READ_DATA:if(_.stop_variable&&_.waiting&&1==b){_.dbg&&console.log("READ_DATA waiting");break}_.waiting=!1,_.code_bits=_.code_bits>>1|(b?_.msb:0),_.bit_count++,_.bit_count==_.nbits&&(0<_.error_count&&_.dbg&&console.log("READ_DATA: error count="+_.error_count),1==(d=_.encoding.process_char(_.code_bits,0,_.output_char_cb)).tally?_.succeed_tally++:-1==d.tally&&_.fail_tally++,d.success?0<_.error_count&&_.error_count--:(_.error_count++,2<_.error_count&&(_.dbg&&console.log("READ_DATA: returning to sync"),_.sync_setup=1)),_.bit_count=0,_.code_bits=0,_.waiting=!0);break;case _.State_e.FIXED_LENGTH:_.fp!=_.fp_START&&_.fp!=_.fp_SYNC_START||(_.fixed_start=1),_.code_bits=_.code_bits>>1|(b?_.msb:0),_.bit_count++,_.bit_count==_.nbits&&((d=_.encoding.process_char(_.code_bits,_.fixed_start,_.output_char_cb,_.show_errs)).resync&&(_.fp=_.fp_SYNC,_.set_state(_.State_e.NOSIGNAL)),_.bit_count=0,_.code_bits=0,_.fixed_start=0)}_.sample_count++}}else _.sample_count++}};



