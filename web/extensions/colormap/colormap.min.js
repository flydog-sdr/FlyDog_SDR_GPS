

/* web/extensions/colormap/colormap.min.js (web/extensions/colormap/colormap.js = Sat May  7 13:22:02 2022) */
var cmap={ext_name:"colormap",first_time:!0,which:0,R:0,G:1,B:2,color:["red","green","blue"],colors:["#ff0000","#00ff00","#2196F3"],rgb:0,draw_r:0,draw_g:0,draw_b:0,draw:0,draw_s:["points","lines"],draw_e:{points:0,lines:1},drawing:0,last_x:0,mousedown:0,w:384,h:128,h_ramp:32,button:0,gain_red:0,gain_green:0,gain_blue:0,n_custom:4,save:{},ef:0};function colormap_main(){ext_switch_to_client(cmap.ext_name,cmap.first_time,colormap_recv),cmap.first_time||colormap_controls_setup(),cmap.first_time=!1}function colormap_recv(a){if("DAT"!=arrayBufferToStringLen(a,3))for(var c=arrayBufferToString(a).substring(4).split(" "),r=0;r<c.length;r++){var o=c[r].split("=");switch(o[0]){case"ready":colormap_controls_setup();break;default:console.log("colormap_recv: UNKNOWN CMD "+o[0])}}else{var e=new Uint8Array(a,4),m=e[0],p=e.length-1;console.log("colormap_recv: DATA UNKNOWN cmd="+m+" len="+p)}}function colormap_plot(){}function colormap_controls_setup(){var a=w3_div("id-colormap-controls w3-text-white",w3_divs("",w3_div("w3-medium w3-text-aqua w3-margin-B-16","<b>Colormap control</b>"),w3_col_percent("w3-margin-T-16 w3-margin-B-16 w3-valign/",w3_div("w3-text-css-orange","<b>Colormap<br>designer</b>"),20,w3_select("w3-text-red","","colormap","wf.cmap",wf.cmap,kiwi.cmap_s,"wf_cmap_cb"),27,w3_div("w3-text-white","select custom colormap<br>then draw in box below"),40,w3_button("w3-btn w3-round-xlarge w3-padding-small w3-aqua","clear","colormap_clear_button_cb")),w3_divs("",w3_col_percent("w3-valign/",w3_radio_button("id-cmap-btn-red w3-btn w3-round-xlarge w3-padding-small","red",cmap.button,w3_SELECTED,"colormap_color_button_cb",0),17,w3_select("w3-text-red","","draw","cmap.draw_r",cmap.draw_r,cmap.draw_s,"colormap_draw_mode_cb",0),20,w3_slider("id-cmap-gain-red-slider","","cmap.gain_red",cmap.gain_red,-1.04,1.04,.01,"colormap_color_gain_cb",0),40,"&nbsp;",3,w3_div("id-cmap-gain-red-field")),w3_col_percent("w3-valign w3-margin-T-8/",w3_radio_button("id-cmap-btn-green w3-btn w3-round-xlarge w3-padding-small","green",cmap.button,w3_NOT_SELECTED,"colormap_color_button_cb",1),17,w3_select("w3-text-red","","draw","cmap.draw_g",cmap.draw_g,cmap.draw_s,"colormap_draw_mode_cb",1),20,w3_slider("id-cmap-gain-red-slider","","cmap.gain_green",cmap.gain_green,-1.04,1.04,.01,"colormap_color_gain_cb",1),40,"&nbsp;",3,w3_div("id-cmap-gain-green-field")),w3_col_percent("w3-valign w3-margin-T-8 w3-margin-B-16/",w3_radio_button("id-cmap-btn-blue w3-btn w3-round-xlarge w3-padding-small","blue",cmap.button,w3_NOT_SELECTED,"colormap_color_button_cb",2),17,w3_select("w3-text-red","","draw","cmap.draw_b",cmap.draw_b,cmap.draw_s,"colormap_draw_mode_cb",2),20,w3_slider("id-cmap-gain-red-slider","","cmap.gain_blue",cmap.gain_blue,-1.04,1.04,.01,"colormap_color_gain_cb",2),40,"&nbsp;",3,w3_div("id-cmap-gain-blue-field")),w3_div("|border: 16px solid rgba(255,255,255,0.2); border-radius: 10px; width: 416px",w3_div("|left:0px; width:"+px(cmap.w)+"; height:"+px(cmap.h)+"; overflow:hidden; position:relative;",'<canvas id="id-cmap-transfer-canvas" width="'+cmap.w+'" height="'+cmap.h+'" style="position:absolute"></canvas>','<canvas id="id-cmap-overlay-canvas" width="'+cmap.w+'" height="'+cmap.h+'" style="position:absolute"></canvas>')),w3_div("w3-margin-L-16 w3-margin-T-16|left:0px; width:"+px(cmap.w)+"; height:"+px(cmap.h_ramp)+"; background-color:black; overflow:hidden; position:relative;",'<canvas id="id-cmap-ramp-canvas" width="'+cmap.w+'" height="'+cmap.h_ramp+'" style="position:absolute"></canvas>'))));for(ext_panel_show(a,null),ext_set_controls_width_height(440,430),w3_set_highlight_color("id-cmap-btn-red","w3-red"),w3_set_highlight_color("id-cmap-btn-green","w3-green"),w3_set_highlight_color("id-cmap-btn-blue","w3-blue"),cmap.transfer_canvas=w3_el("id-cmap-transfer-canvas"),cmap.transfer_canvas.ctx=cmap.transfer_canvas.getContext("2d"),cmap.overlay_canvas=w3_el("id-cmap-overlay-canvas"),cmap.overlay_canvas.ctx=cmap.overlay_canvas.getContext("2d"),m=0;m<cmap.n_custom;m++)for(var c=cmap.save["cm"+m]={},r=0;r<3;r++){var o=c["rgb"[r]]={};o.gain_slider=0,o.gain=1,o.y=[];for(var e=0;e<cmap.w;e++)o.y[e]=0}var p=w3_el("id-colormap-controls");p.addEventListener("mousedown",colormap_transfer_mousedown_cb,!1),p.addEventListener("mousemove",colormap_transfer_mousemove_cb,!1),p.addEventListener("mouseup",colormap_transfer_mouseup_cb,!1),cmap.ramp_canvas=w3_el("id-cmap-ramp-canvas"),cmap.ramp_canvas.ctx=cmap.ramp_canvas.getContext("2d"),colormap_select()}function colormap_init(){var a=+ext_get_cfg_param("init.colormap",-1,EXT_NO_SAVE),c=readCookie("last_cmap",-1==a?0:a);-1!=wf.cmap_override&&(c=wf.cmap_override),wf_cmap_cb("wf.cmap",c,!1),wf.aper_w=parseFloat(w3_el("id-control").style.width),wf.aper_h=16,w3_el("id-aper-data").style.width=px(wf.aper_w);var r=w3_el("id-aper-canvas");r.width=wf.aper_w,wf.aper_ctx=r.getContext("2d"),wf.aper==kiwi.aper_e.man&&colormap_aper()}function colormap_select(){var a=cmap.which=wf.cmap>=kiwi.cmap_e.custom_1?wf.cmap-kiwi.cmap_e.custom_1:-1,c=kiwi_storeGet("colormap");if(cmap.transfer_canvas&&-1==a){var r=cmap.transfer_canvas.ctx;r.fillStyle="black",r.fillRect(0,0,cmap.w,cmap.h),r.strokeStyle="white",r.beginPath(),r.moveTo(0,0),r.lineTo(cmap.w,cmap.h),r.stroke(),r.beginPath(),r.moveTo(cmap.w,0),r.lineTo(0,cmap.h),r.stroke(),(r=cmap.ramp_canvas.ctx).fillStyle="black",r.fillRect(0,0,cmap.w,cmap.h_ramp)}if(-1!=a&&null!=c){var o=kiwi_JSON_parse("colormap_select",c);if(o)if(cmap.save=o,cmap.transfer_canvas){var e=cmap.save["cm"+a];colormap_color_gain_cb("cmap.gain_red",e.r.gain_slider,1,!1,0),colormap_color_gain_cb("cmap.gain_green",e.g.gain_slider,1,!1,1),colormap_color_gain_cb("cmap.gain_blue",e.b.gain_slider,1,!1,2)}else colormap_update_wf_colormap()}}function colormap_aper(){if(wf.aper_ctx)for(var a=-140,c=0;c<wf.aper_w;c++){var r=c/wf.aper_w*120-140,o=color_index_max_min(r,maxdb,mindb),e=color_map[o];(mindb>=a&&mindb<=r||maxdb>=a&&maxdb<=r)&&(e^=4294967295);var m="#"+(e>>>8).toString(16).leadingZeros(6);wf.aper_ctx.fillStyle=m,wf.aper_ctx.fillRect(c,0,1,wf.aper_h),(r>=mindb-3&&r<=mindb||r>=maxdb&&r<=maxdb+3)&&(m="#"+((e=4294967295^color_map[o])>>>8).toString(16).leadingZeros(6),wf.aper_ctx.fillStyle=m,wf.aper_ctx.fillRect(c,wf.aper_h/2,1,1)),a=r}}function colormap_color_button_cb(a,c,r,o){cmap.rgb=+o,cmap.draw=cmap["draw_"+"rgb"[cmap.rgb]]}function colormap_draw_mode_cb(a,c,r,o){c=+c,o=+o,cmap.rgb==o&&(cmap.draw=c),w3_num_cb(a,c)}function colormap_clear_button_cb(a,c){colormap_color_gain_cb("",0,!0,!1,cmap.R,0),colormap_color_gain_cb("",0,!0,!1,cmap.G,0),colormap_color_gain_cb("",0,!0,!1,cmap.B,0),kiwi_storeSet("colormap",JSON.stringify(cmap.save))}function colormap_color_gain_cb(a,c,r,o,e,m){if(!o){var p=+e,_=c=+c;c>0&&c<.05?_=c=0:c>=.05&&(c-=.04),c<0&&c>-.05?_=c=0:c<=-.05&&(c+=.04);var n=c<0?1+c:1+2*c,t=cmap.color[p];if(w3_innerHTML("id-cmap-gain-"+t+"-field","gain "+n.toFixed(2)),-1!=cmap.which){var i=cmap.save["cm"+cmap.which]["rgb"[p]];i.gain_slider=c,i.gain=n,w3_set_value(a,_),w3_color(a,null,_<0?"rgba(255,0,0,0.3)":_?"rgba(0,255,0,0.2)":""),colormap_draw_transfer(p,0,cmap.w-1,1,m)}}}function colormap_draw_transfer(a,c,r,o,e){var m=cmap.which;if(-1!=m){var p,_,n=cmap.transfer_canvas.ctx,t=cmap.save["cm"+m];++a>=3&&(a=0);var i=(p=t["rgb"[a]]).gain,l=p.y,w=cmap.colors[a];++a>=3&&(a=0);var s=(p=t["rgb"[a]]).gain,d=p.y,g=cmap.colors[a];++a>=3&&(a=0);for(var f=(p=t["rgb"[a]]).gain,b=p.y,v=cmap.colors[a],u=c;o>0&&u<=r||o<0&&u>=r;u+=o)n.fillStyle="black",n.fillRect(u,0,1,cmap.h),_=l[u]*i,_=w3_clamp(Math.round(_),0,cmap.h-1),n.fillStyle=w,n.fillRect(u,_,2,2),_=d[u]*s,_=w3_clamp(Math.round(_),0,cmap.h-1),n.fillStyle=g,n.fillRect(u,_,2,2),_=isArg(e)?b[u]=e:b[u],_*=f,_=w3_clamp(Math.round(_),0,cmap.h-1),n.fillStyle=v,n.fillRect(u,_,2,2);var h=t.r.gain,x=t.g.gain,y=t.b.gain,k=t.r.y,S=t.g.y,T=t.b.y,E=(n=cmap.ramp_canvas.ctx,cmap.h-1);for(u=0;u<cmap.w;u++){var R=w3_clamp(k[u]*h,0,E);R=R/E*255;var M=w3_clamp(S[u]*x,0,E);M=M/E*255;var C=w3_clamp(T[u]*y,0,E);C=C/E*255,n.fillStyle=kiwi_rgb(R,M,C),n.fillRect(u,0,1,cmap.h_ramp)}colormap_update_wf_colormap()}}function colormap_update_wf_colormap(){var a=cmap.which;if(-1!=a){var c=wf.custom_colormaps[a],r=cmap.h-1,o=cmap.save["cm"+a],e=o.r.gain,m=o.g.gain,p=o.b.gain,_=o.r.y,n=o.g.y,t=o.b.y;for(x=0;x<256;x++){var i=Math.round(x/255*(cmap.w-1)),l=w3_clamp(_[i]*e,0,r);l=l/r*255;var w=w3_clamp(n[i]*m,0,r);w=w/r*255;var s=w3_clamp(t[i]*p,0,r);s=s/r*255,c[3*x+0]=w3_clamp(Math.round(l),0,255),c[3*x+1]=w3_clamp(Math.round(w),0,255),c[3*x+2]=w3_clamp(Math.round(s),0,255)}mkcolormap(),spectrum_dB_bands(),colormap_aper()}}function colormap_mouseXY(a,c){var r=w3_el(a).getBoundingClientRect();return{x:Math.round(c.clientX-r.left),y:Math.round(c.clientY-r.top)}}function colormap_transfer_mousedown_cb(a){switch(cmap.draw){case cmap.draw_e.points:cmap.mousedown=1;break;case cmap.draw_e.lines:if(!cmap.drawing){var c=colormap_mouseXY("id-cmap-overlay-canvas",a);if(c.y<-16||c.y>cmap.h+16||c.x<-16||c.x>cmap.w+16)return;cmap.xy0=c,cmap.xy1=null,cmap.drawing=1}}}function colormap_transfer_mousemove_cb(a){if(-1!=cmap.which)switch(cmap.draw){case cmap.draw_e.points:var c=colormap_mouseXY("id-cmap-transfer-canvas",a);if(!a.buttons||c.y<-16||c.y>cmap.h+16)return;var r=w3_clamp(c.y,0,cmap.h-1),o=w3_clamp(c.x,0,cmap.w-1);cmap.mousedown&&(cmap.last_x=o,cmap.mousedown=0);var e=o>=cmap.last_x?1:-1;colormap_draw_transfer(cmap.rgb,cmap.last_x,o,e,r),cmap.last_x=o;break;case cmap.draw_e.lines:if(!cmap.drawing)return;var m=cmap.overlay_canvas.ctx;cmap.xy1&&m.clearRect(0,0,cmap.w,cmap.h);c=colormap_mouseXY("id-cmap-overlay-canvas",a);return m.strokeStyle="white",m.beginPath(),m.moveTo(cmap.xy0.x,cmap.xy0.y),m.lineTo(c.x,c.y),m.stroke(),void(cmap.xy1=c);default:return}}function colormap_transfer_mouseup_cb(a,c){switch(cmap.draw){case cmap.draw_e.lines:if(!cmap.drawing)return;if(!cmap.xy1)return void(c&&(cmap.drawing=0));if(cmap.overlay_canvas.ctx.clearRect(0,0,cmap.w,cmap.h),c)cmap.drawing=0;else{colormap_bresenham(cmap.xy0,cmap.xy1,function(a,c){colormap_draw_transfer(cmap.rgb,a,a,1,c)});var r=cmap.xy1;r.y<-16||r.y>cmap.h+16||r.x<-16||r.x>cmap.w+16?cmap.drawing=0:(cmap.xy0=cmap.xy1,cmap.xy1=null)}}var o=JSON.stringify(cmap.save);kiwi_storeSet("colormap",o)}function colormap_escape_key_cb(){return!(cmap.draw!=cmap.draw_e.lines||!cmap.drawing)&&(colormap_transfer_mouseup_cb(null,!0),!0)}function colormap_bresenham(a,c,r){for(var o=a.x,e=a.y,m=c.x,p=c.y,_=Math.abs(m-o),n=Math.abs(p-e),t=o<m?1:-1,i=e<p?1:-1,l=_-n;o!=m||e!=p;){var w=2*l;w>-1*n&&(l-=n,o+=t),w<_&&(l+=_,e+=i),r(o,e)}}function colormap_update(){wf_send("SET aper="+wf.aper+" algo="+wf.aper_algo+" param="+wf.aper_param.toFixed(2))}function colormap_exp_cb(a,c){c=+c,w3_num_cb(a,c),w3_set_label("Exp "+c.toFixed(2),a),cmap.ef=c,colormap_plot()}function colormap_gain_cb(a,c){c=+c,w3_num_cb(a,c),w3_set_label("Gain "+c.toFixed(2),a),colormap_plot()}


