

/* web/extensions/ext.min.js (web/extensions/ext.js = Wed Dec 27 10:23:48 2023) */
var extint={ws:null,extname:null,isAdmin_cb:null,srate:0,nom_srate:0,param:null,override_pb:false,displayed:false,help_displayed:false,current_ext_name:null,using_data_container:false,hide_func:null,default_w:525,default_h:300,prev_mode:null,mode_prior_to_dx_click:null,seq:0,scanning:0,in_rf_tab:false,web_socket_fragmentation:8192,send_hiwat:0,send_hiwat_msg:null,no_lockout:['noise_blank','noise_filter','ant_switch','iframe','colormap','devl','prefs'],use_rf_tab:[],excl_devl:['devl','digi_modes','s4285','prefs'],OPT_NOLOCAL:1,};var devl={p0:0,p1:0,p2:0,p3:0,p4:0,p5:0,p6:0,p7:0};function ext_switch_to_client(ext_name,first_time,recv_func){recv_websocket(extint.ws,recv_func);ext_send('SET ext_switch_to_client='+ext_name+' first_time='+(first_time?1:0)+' rx_chan='+rx_chan);w3_call(ext_name+'_focus');}
function ext_send(msg,ws){if(isNoArg(ws))ws=extint.ws;var len=msg.length;if(len>extint.send_hiwat){extint.send_hiwat_msg=msg;extint.send_hiwat=len;}
try{ws.send(msg);return 0;}catch(ex){console.log("CATCH ext_send('"+s+"') ex="+ex);kiwi_trace();}}
function ext_send_cfg(cfg,s){var ws=extint.ws;var len=s.length;var tr='='+len;var _send=function(seq,suffix,s){return('SET '+cfg.cmd+suffix+seq+' '+s);};var transaction_seq=cfg.seq;cfg.seq++;w3_do_when_cond(function(seq){var ba=ws.bufferedAmount?('['+ws.bufferedAmount+']'):'0';tr=w3_sb(tr,ba);if(ws.bufferedAmount!=0)return false;if(len>extint.web_socket_fragmentation){cfg.lock=1;ws.send(_send(seq,'_frag=',s.slice(0,extint.web_socket_fragmentation)));s=s.slice(extint.web_socket_fragmentation);len=s.length;tr=w3_sb(tr,'W'+extint.web_socket_fragmentation);return false;}else{ws.send(_send(seq,'=',s.slice(0,extint.web_socket_fragmentation)));cfg.lock=0;if(kiwi.log_cfg_save_seq)
kiwi_debug(w3_sb('save_config:',seq+'-'+cfg.name+tr,'w'+len,'DONE'),true);len=0;return true;}},null,transaction_seq,kiwi.test_cfg_save_seq?1000:50);}
function ext_send_after_cfg_save(msg,cfg_s){cfg_s=cfg_s||'cfg';var kiwi_cfg=kiwi[cfg_s];w3_do_when_cond(function(){if(kiwi.log_cfg_save_seq)
kiwi_debug('ext_send_after_cfg_save lock='+kiwi_cfg.lock+' msg=<'+msg+'>');return(kiwi_cfg.lock==0);},function(msg){ext_send(msg);},msg,100);}
function ext_panel_show(controls_html,data_html,show_func,hide_func){extint_panel_show(controls_html,data_html,show_func,hide_func);}
function ext_set_data_height(height){var el=w3_el('id-ext-data-container');if(!height){if(el)el.style.height='';}else{if(el)el.style.height=px(height);}}
function ext_set_controls_width_height(width,height){panel_set_width_height('ext-controls',width,height);}
var EXT_SAVE=true;var EXT_NO_SAVE=false;function ext_get_cfg_param(path,init_val,save,update_path_var){var cur_val;var cfg_path=w3_add_toplevel(path);try{cur_val=getVarFromString(cfg_path);}catch(ex){cur_val=null;}
if(isNoArg(cur_val)&&init_val!=undefined){cur_val=init_val;setVarFromString(cfg_path,cur_val);if((save==undefined&&isAdmin())||save==EXT_SAVE)
cfg_save_json('ext_get_cfg_param',cfg_path);}
if(update_path_var){if(path.startsWith('cfg.')||path.startsWith('adm.')){console.log('ext_get_cfg_param: update_path_var CAUTION: NOT SETTING path='+path+' cur_val='+cur_val);}else{setVarFromString(path,cur_val);}}
return cur_val;}
function ext_get_cfg_param_string(path,init_val,save){var s=ext_get_cfg_param(path,init_val,save);if(isNoArg(s))s='';return kiwi_decodeURIComponent(ext_get_cfg_param_string+':'+path,s);}
function ext_set_cfg_param(path,val,save){if(path.startsWith('id-')){console.log('$WARNING: ext_set_cfg_param path='+path);return;}
path=w3_add_toplevel(path);setVarFromString(path,val);save=(isArg(save)&&save==EXT_SAVE)?true:false;if(save){cfg_save_json('ext_set_cfg_param',path,val);}}
function ext_get_freq_range(){var offset=kiwi.freq_offset_kHz;return{lo_kHz:cfg.sdr_hu_lo_kHz+offset,hi_kHz:cfg.sdr_hu_hi_kHz+offset,offset_kHz:offset};}
var ext_zoom={TO_BAND:0,IN:1,OUT:-1,ABS:2,WHEEL:3,CUR:4,NOM_IN:8,MAX_IN:9,MAX_OUT:-9};var extint_ext_is_tuning=false;function ext_tune(freq_dial_kHz,mode,zoom,zlevel,low_cut,high_cut,opt){var pb_specified=(low_cut!=undefined&&high_cut!=undefined);extint_ext_is_tuning=true;freq_dial_kHz=freq_dial_kHz||(freq_displayed_Hz / 1000);freqmode_set_dsp_kHz(freq_dial_kHz,mode,opt);if(pb_specified)ext_set_passband(low_cut,high_cut);if(isArg(zoom)){if(zoom==ext_zoom.CUR)
zoom_step(ext_zoom.ABS,zoom_level);else
zoom_step(zoom,zlevel);}else{zoom_step(ext_zoom.TO_BAND);}
extint_ext_is_tuning=false;}
function ext_get_freq_Hz(){return{displayed:freq_displayed_Hz,carrier:freq_car_Hz,passband_center:freq_passband_center()};}
function ext_get_freq(){return freq_displayed_Hz;}
function ext_get_freq_kHz(){return(freq_displayed_Hz/1e3).toFixed(2);}
function ext_get_carrier_freq(){return freq_car_Hz;}
function ext_get_passband_center_freq(){return freq_passband_center();}
function ext_save_setup(){var mode=isArg(extint.mode_prior_to_dx_click)?extint.mode_prior_to_dx_click:cur_mode;console.log('ext_save_setup mode='+mode+' mode_prior_to_dx_click='+extint.mode_prior_to_dx_click+' cur_mode='+cur_mode);extint.mode_prior_to_dx_click=null;return{mode:mode,zoom:zoom_level};}
function ext_restore_setup(s){console.log('ext_restore_setup mode='+s.mode+' zoom='+s.zoom);ext_set_mode(s.mode);ext_set_zoom(ext_zoom.ABS,s.zoom);}
function ext_get_mode(){return cur_mode;}
function ext_mode(mode){var fail=false;if(isArg(mode)){mode=mode.toLowerCase();var str=mode.substr(0,2);if(str=='qa')str='sa';if(str=='nn')str='nb';}else{str='';fail=true;}
var o={fail:fail,str:str};o.AM=fail?false:(str=='am');o.LSB=fail?false:(str=='ls');o.USB=fail?false:(str=='us');o.CW=fail?false:(str=='cw');o.IQ=fail?false:(str=='iq');o.NBFM=fail?false:(str=='nb');o.SAx=fail?false:(str=='sa');o.DRM=fail?false:(str=='dr');o.AM=fail?false:(str=='am');o.LSB_SAL=fail?false:(o.LSB||mode=='sal');o.SSB=fail?false:(o.USB||o.LSB);o.SSB_CW=fail?false:(o.SSB||o.CW);o.STEREO=fail?false:(o.IQ||o.DRM||mode=='sas'||mode=='qam');o.AM_SAx_IQ_DRM=fail?false:(o.AM||o.SAx||o.SSB||o.DRM);return o;}
function ext_is_IQ_or_stereo_mode(mode){return ext_mode(mode).STEREO;}
function ext_is_IQ_or_stereo_curmode(){return ext_is_IQ_or_stereo_mode(cur_mode);}
function ext_get_prev_mode(){return extint.prev_mode;}
function ext_set_mode(mode,freq,opt){if(isUndefined(mode))return;var new_drm=(mode=='drm');if(new_drm)
extint.prev_mode=cur_mode;demodulator_analog_replace(mode,freq);var open_ext=w3_opt(opt,'open_ext',false);var no_drm_proc=w3_opt(opt,'no_drm_proc',false);var drm_active=(typeof(drm)!='undefined'&&drm.active);if(!no_drm_proc){if(new_drm&&open_ext){if(drm_active){toggle_panel("ext-controls",1);}else{extint_open('drm');}}else
if(!new_drm&&drm_active){extint_panel_hide();demodulator_analog_replace(mode,freq);}}}
function ext_get_passband(){var demod=demodulators[0];return{low:demod.low_cut,high:demod.high_cut};}
function ext_set_passband(low_cut,high_cut,set_mode_pb,freq_dial_Hz){var demod=demodulators[0];var filter=demod.filter;if(low_cut==undefined)low_cut=demod.low_cut;if(high_cut==undefined)high_cut=demod.high_cut;var bw=Math.abs(high_cut-low_cut);low_cut=(low_cut<filter.low_cut_limit)?filter.low_cut_limit:low_cut;high_cut=(high_cut>filter.high_cut_limit)?filter.high_cut_limit:high_cut;var bw=Math.abs(high_cut-low_cut);var okay=false;if(bw>=filter.min_passband&&low_cut<high_cut){demod.low_cut=low_cut;demod.high_cut=high_cut;okay=true;}
if(isArg(set_mode_pb)&&set_mode_pb&&okay){owrx.last_lo[cur_mode]=low_cut;owrx.last_hi[cur_mode]=high_cut;}
if(freq_dial_Hz!=undefined&&freq_dial_Hz!=null){freq_dial_Hz*=1000;freq_car_Hz=freq_dsp_to_car(freq_dial_Hz);}
extint_ext_is_tuning=true;demodulator_set_offset_frequency(owrx.FSET_EXT_SET_PB,freq_car_Hz-center_freq);extint_ext_is_tuning=false;}
function ext_get_tuning(){return{low:demod.low_cut,high:demod.high_cut,mode:cur_mode,freq_dial_kHz:freq_displayed_Hz/1000};}
function ext_get_zoom(){return zoom_level;}
function ext_set_zoom(zoom_mode,zoom_level){zoom_step(zoom_mode,zoom_level);}
function ext_get_audio_comp(){return btn_compression?true:false;}
function ext_set_audio_comp(comp){toggle_or_set_compression(toggle_e.SET,comp?1:0);}
function ext_set_scanning(scanning){extint.scanning=scanning?1:0;}
function ext_agc_delay(set_val){var prev_val=w3_el('input-decay').value;if(isDefined(set_val))setDecay_cb('',set_val,1);return prev_val;}
extint.optbars={'optbar-wf':0,'optbar-audio':1,'optbar-agc':2,'optbar-users':3,'optbar-status':4,'optbar-off':5};function ext_get_optbar(){var optbar=readCookie('last_optbar');return optbar;}
function ext_set_optbar(optbar,cb_param){if(extint.optbars[optbar]){writeCookie('last_optbar',optbar);w3_click_nav(optbar,'optbar',cb_param);}}
function ext_hasCredential(conn_type,cb,cb_param,ws){if(conn_type=='mfg')conn_type='admin';var pwd;if(conn_type=='admin'){deleteCookie('admin');deleteCookie('admin-pwd');pwd='';}else{pwd=readCookie(conn_type);pwd=pwd?decodeURIComponent(pwd):'';}
extint_pwd_cb=cb;extint_pwd_cb_param=cb_param;ext_valpwd(conn_type,pwd,ws);}
function ext_valpwd(conn_type,pwd,ws){if(conn_type=='mfg')conn_type='admin';pwd=encodeURIComponent(pwd);if(conn_type!='admin')
writeCookie(conn_type,pwd);extint_conn_type=conn_type;pwd=(pwd!='')?pwd:'#';var ipl=null;var iplimit_cookie=readCookie('iplimit');var iplimit_pwd=kiwi_url_param(['pwd','password'],'','');if(iplimit_pwd!=''){ipl=iplimit_pwd;}else
if(iplimit_cookie&&iplimit_cookie!=''){ipl=iplimit_cookie;}
ipl=ipl?(' ipl='+ipl):'';if(kiwi_url_param(['p','prot','protected'],'true',null)!=null&&conn_type!='admin')
conn_type='prot';var options=0;if(kiwi_url_param('nolocal'))options|=extint.OPT_NOLOCAL;if(options!=0)ext_send('SET options='+options);ext_send('SET auth t='+conn_type+' p='+pwd+ipl,ws);}
function ext_isAdmin(cb){extint.isAdmin_cb=cb;ext_send('SET is_admin');}
var extint_authkey_cb;function ext_get_authkey(func){ext_send('SET get_authkey');extint_authkey_cb=func;}
var extint_adc_clock_Hz=0;function ext_adc_clock_Hz(){return extint_adc_clock_Hz;}
var extint_adc_gps_clock_corr=0;function ext_adc_gps_clock_corr(){return extint_adc_gps_clock_corr;}
var extint_adc_clock_nom_Hz=0;function ext_adc_clock_nom_Hz(){return extint_adc_clock_nom_Hz;}
function ext_sample_rate(){return extint.srate;}
function ext_nom_sample_rate(){return extint.nom_srate;}
var extint_audio_data_cb=null;function ext_register_audio_data_cb(func){extint_audio_data_cb=func;}
function ext_unregister_audio_data_cb(){extint_audio_data_cb=null;}
function ext_param(){var p=extint.param;extint.param=null;return p;}
function ext_panel_set_name(name){extint.current_ext_name=name;}
function ext_get_name(){return extint.current_ext_name;}
function ext_mobile_info(last){var w=window.innerWidth;var h=window.innerHeight;var rv={width:w,height:h};var isPortrait;if(owrx.popup_keyboard_active){isPortrait=last?last.isPortrait:1;}else{isPortrait=(w<h||mobile_laptop_test)?1:0;}
rv.orient_unchanged=(last&&last.isPortrait==isPortrait)?1:0;rv.isPortrait=isPortrait?1:0;rv.iPad=(isPortrait&&w<=768)?1:0;rv.small=(isPortrait&&w<768)?1:0;rv.narrow=(isPortrait&&w<=600)?1:0;return rv;}
function ext_get_menus_cb(ctx,freqs,retry_cb,done_cb,done_cb_param){var fault=false;if(!freqs){console.log('ext_get_menus_cb: freqs='+freqs);fault=true;}else
if(freqs.AJAX_error&&freqs.AJAX_error=='timeout'){console.log('ext_get_menus_cb: TIMEOUT');ctx.using_default=true;fault=true;}else
if(freqs.AJAX_error&&freqs.AJAX_error=='status'){console.log('ext_get_menus_cb: status='+freqs.status);ctx.using_default=true;fault=true;}else
if(!isObject(freqs)){console.log('ext_get_menus_cb: not array');fault=true;}else
if(isDefined(freqs.AJAX_error)){console.log('ext_get_menus_cb: AJAX_error');fault=true;}
var url;if(fault){if(ctx.double_fault){console.log('ext_get_menus_cb: default freq list fetch FAILED');console.log(freqs);return;}
console.log(freqs);url=ctx.int_url;console.log('ext_get_menus_cb: using default freq list '+url);ctx.using_default=true;ctx.double_fault=true;kiwi_ajax(url,retry_cb,0,10000);return;}else{url=ctx.ext_url;}
console.log('ext_get_menus_cb: from '+url);if(dbgUs)console.log(freqs);w3_call(done_cb,done_cb_param);}
function ext_render_menus(ctx,ext_name,ctx_name){var new_menu=function(i,o,menu_s){ctx.n_menu++;ctx.menus[i]=o;ctx.menu_s[i]=menu_s;var s=w3_div('id-'+menu_s+' w3-margin-between-24',w3_select_hier(ctx.sfmt,menu_s,'select',ctx_name+'.menu'+i,-1,o,ext_name+'_pre_select_cb'));return s;};if(isUndefined(ctx_name))ctx_name=ext_name;var s='';ctx.n_menu=0;w3_obj_enum(ctx.freqs,function(menu_s,i,o2){s+=new_menu(i,o2,menu_s);});w3_innerHTML('id-'+ext_name+'-menus',s);console.log('ext_render_menus n_menu='+ctx.n_menu);}
function ext_panel_init(){w3_el('id-panels-container').innerHTML+='<div id="id-ext-controls" class="class-panel" data-panel-name="ext-controls" data-panel-pos="bottom-left" data-panel-order="0" '+'data-panel-size="'+extint.default_w+','+extint.default_h+'"></div>';var el=w3_el('id-ext-data-container');el=w3_el('id-ext-controls');el.innerHTML=w3_div('id-ext-controls-container w3-relative|width:100%;height:100%;')+
w3_div('id-ext-controls-vis class-vis')+
w3_div('id-ext-controls-help cl-ext-help',w3_button('id-ext-controls-help-btn w3-green w3-small w3-padding-small w3-disabled||onclick="extint_help_click()"','help'));w3_el('id-kiwi-body').addEventListener('keyup',function(evt){if(evt.key=='Escape'&&extint.displayed&&!confirmation.displayed){if(w3_call(extint.current_ext_name+'_escape_key_cb')!=true){console.log('EXT ESC: no _escape_key_cb() routine, so doing id-ext-controls-close.click()');w3_el('id-ext-controls-close').click();}}},true);}
function ext_show_spectrum(which){toggle_or_set_spec(toggle_e.SET|toggle_e.NO_CLOSE_EXT,which);}
function ext_hide_spectrum(){toggle_or_set_spec(toggle_e.SET|toggle_e.NO_CLOSE_EXT,spec.NONE);}
function extint_panel_show(controls_html,data_html,show_func,hide_func,show_help_button){var el;extint.using_data_container=(data_html?true:false);if(extint.using_data_container){toggle_or_set_spec(toggle_e.SET,spec.NONE);w3_hide('id-top-container');w3_show_block(w3_innerHTML('id-ext-data-container',data_html));}else{w3_hide('id-ext-data-container');if(spec.source==spec.NONE)
w3_show_block('id-top-container');}
if(extint.help_displayed==true){confirmation_panel_close();extint.help_displayed=false;}
var ext_name=extint.current_ext_name;el=w3_el('id-optbar-rf-container');if(extint.use_rf_tab.includes(ext_name)){console.log('extint_panel_show: rf optbar '+ext_name);el.innerHTML=controls_html;extint.in_rf_tab=true;keyboard_shortcut_nav('rf');return;}else{el.innerHTML='';extint.in_rf_tab=false;}
el=w3_el('id-ext-controls-close');el.onclick=function(){toggle_panel("ext-controls");extint_panel_hide();};ext_set_data_height();w3_el('id-ext-controls').style.zIndex=150;w3_create_attribute('id-ext-controls-close-img','src','icons/close.24.png');el=w3_el('id-ext-controls-container');el.innerHTML=controls_html;if(show_func)show_func();extint.hide_func=hide_func;el=w3_el('id-ext-controls');el.style.zIndex=150;w3_visible(el,true);el.panelShown=1;toggle_or_set_hide_panels(0);w3_el('id-confirmation-container').style.height='';show_help_button=isDefined(show_help_button)?show_help_button:w3_call(extint.current_ext_name+'_help',false);w3_set_props('id-ext-controls-help-btn','w3-disabled',isUndefined(show_help_button)||show_help_button==false);w3_show_hide('id-ext-controls-help-btn',show_help_button!='off');extint.displayed=true;}
function ext_panel_displayed(ext_name){return(extint.displayed&&(ext_name?(ext_name==extint.current_ext_name):true));}
function ext_panel_redisplay(s){w3_innerHTML('id-ext-controls-container',s);}
function extint_panel_hide(skip_calling_hide_spec){console.log('extint_panel_hide using_data_container='+extint.using_data_container+' skip_calling_hide_spec='+skip_calling_hide_spec);if(extint.using_data_container){w3_hide('id-ext-data-container');if(skip_calling_hide_spec!=true)
ext_hide_spectrum();w3_show_block('id-top-container');extint.using_data_container=false;if(extint.help_displayed==true){confirmation_panel_close();extint.help_displayed=false;}}
w3_visible('id-ext-controls',false);extint_blur_prev(1);w3_call(extint.hide_func);w3_select_value('id-select-ext',-1);resize_waterfall_container(true);extint.displayed=false;freqset_select();}
function extint_help_click_now(){extint.help_displayed=w3_call(extint.current_ext_name+'_help',true);}
function extint_help_click(delay){if(w3_contains('id-ext-controls-help-btn','w3-disabled'))return;console.log(extint.current_ext_name+'_help_click CLICKED');if(delay)
setTimeout(function(){extint_help_click_now();},2000);else
extint_help_click_now();}
function extint_environment_changed(changed){setTimeout(function(){if(extint.current_ext_name){w3_call(extint.current_ext_name+'_environment_changed',changed);}
if(changed.freq||changed.mode||changed.zoom||changed.waterfall_pan||changed.resize)
mouse_freq_remove();w3_call('injection_environment_changed',changed);},100);}
var extint_pwd_cb=null;var extint_pwd_cb_param=null;var extint_conn_type=null;function extint_valpwd_cb(badp){if(extint_pwd_cb)extint_pwd_cb(badp,extint_pwd_cb_param);}
function extint_open_ws_cb(){ext_hasCredential('kiwi',null,null);setTimeout(function(){setInterval(function(){ext_send("SET keepalive")},5000)},5000);}
function extint_connect_server(){extint.ws=open_websocket('EXT',extint_open_ws_cb,null,extint_msg_cb);return extint.ws;}
function extint_msg_cb(param,ws){switch(param[0]){case"keepalive":break;case"ext_client_init":console.log('ext_client_init is_locked='+ +param[1]);extint_focus(+param[1]);break;default:return false;}
return true;}
function extint_blur_prev(restore){if(extint.current_ext_name!=null){w3_call(extint.current_ext_name+'_blur');recv_websocket(extint.ws,null);if(restore)ext_set_controls_width_height();extint.current_ext_name=null;time_display_setup('id-topbar-right-container');}
if(extint.ws)
ext_send('SET ext_blur='+rx_chan);}
function extint_focus(is_locked){var ext_name=extint.current_ext_name;console.log('extint_focus: loading '+ext_name+'.js');if(is_locked&&!extint.no_lockout.includes(ext_name)){var s=w3_text('w3-medium w3-text-css-yellow','Cannot use extensions while <br> another channel is in DRM mode.');extint_panel_show(s,null,null,null,'off');ext_set_controls_width_height(300,75);return;}
kiwi_load_js_dir('extensions/'+ext_name+'/'+ext_name,['.js','.css'],function(){console.log('extint_focus: calling '+ext_name+'_main()');if(!extint.use_rf_tab.includes(ext_name))
ext_set_controls_width_height();w3_call(ext_name+'_main');if(isNonEmptyArray(shortcut.keys))
setTimeout(keyboard_shortcut_url_keys,3000);},function(loaded){console.log('extint_focus: '+ext_name+' loaded='+loaded);if(loaded&&!extint.use_rf_tab.includes(ext_name)){extint_panel_show('loading extension...',null,null,null,'off');ext_set_controls_width_height(325,45);if(kiwi.is_locked)
console.log('==== IS_LOCKED =================================================');}});}
var extint_first_ext_load=true;function extint_select(value){extint_blur_prev(0);w3_call(extint.hide_func);freqset_select();value=+value;var el=w3_el('id-select-ext');if(!el){setTimeout(extint_select,1000,value);return;}
w3_select_value(el,value);var menu=el.childNodes;var name=menu[value+1].innerHTML.toLowerCase();console.log('extint_select val='+value+' name='+name);var idx;extint_names_enum(function(i,value,id,id_en){if(name.startsWith(id.toLowerCase())){idx=i;}});extint.current_ext_name=extint_names[idx];if(extint_first_ext_load){extint.ws=extint_connect_server();extint_first_ext_load=false;}else{ext_send('SET ext_is_locked_status');}}
var extint_names;function extint_list_json(param){extint_names=kiwi_JSON_parse('extint_list_json',decodeURIComponent(param));}
function extint_names_enum(func){var i,value;for(i=value=0;i<extint_names.length;i++){var id=extint_names[i];if(!dbgUs&&extint.excl_devl.includes(id))continue;if(id=='sig_gen'&&rx_chan!=0)continue;if(id=='wspr')id='WSPR';var id_en=id.toLowerCase();if(id_en=='cw_decoder')id_en='cw';if(id_en=='drm')id_en='DRM';if(id_en=='s_meter')id_en='S_meter';if(id_en=='wspr')id_en='WSPR';func(i,value,id,id_en);value++;}}
function extint_select_build_menu(){var s='';if(extint_names&&isArray(extint_names)){extint_names_enum(function(i,value,id,id_en){var enable=ext_get_cfg_param(id_en+'.enable');if(enable==null||kiwi.is_local[rx_chan])enable=true;if(id=='DRM')kiwi.DRM_enable=enable;if(id=='NAVTEX')id='NAVTEX/DSC';else
if(id=='FT8')id='FT8/FT4';else;s+='<option value='+dq(value)+' kiwi_idx='+dq(i)+' '+(enable?'':'disabled')+'>'+id+'</option>';});}
return s;}
function extint_open(name,delay){name=name.toLowerCase();if(name=='dsc')name='navtex';else
if(name=='ft4')name='ft8';else;var found=0;extint_names_enum(function(i,value,id,id_en){var enable=ext_get_cfg_param(id_en+'.enable');if(enable==null||kiwi.is_local[rx_chan])enable=true;if(!found&&enable&&id.toLowerCase().includes(name)){if(delay){setTimeout(function(){extint_select(value);},delay);}else{extint_select(value);}
found=1;}});}
function extint_audio_data(data,samps){if(isFunction(extint_audio_data_cb))
extint_audio_data_cb(data,samps);}





/* web/kiwi/kiwi.min.js (web/kiwi/kiwi.js = Sun Dec 17 11:50:29 2023) */
var kiwi={d:{},KiwiSDR_1:1,KiwiSDR_2:2,model:1,PLATFORM_BBG_BBB:0,PLATFORM_BB_AI:1,PLATFORM_BB_AI64:2,PLATFORM_RPI:3,platform:-1,platform_s:['BBG/B','BBAI','BBAI-64','RPi'],cfg:{seq:0,name:'cfg',cmd:'save_cfg',lock:0,timeout:null},dxcfg:{seq:0,name:'dxcfg',cmd:'save_dxcfg',lock:0,timeout:null},adm:{seq:0,name:'adm',cmd:'save_adm',lock:0,timeout:null},test_cfg_save_seq:false,log_cfg_save_seq:false,BADP_OK:0,BADP_TRY_AGAIN:1,BADP_STILL_DETERMINING_LOCAL_IP:2,BADP_NOT_ALLOWED_FROM_IP:3,BADP_NO_ADMIN_PWD_SET:4,BADP_NO_MULTIPLE_CONNS:5,BADP_DATABASE_UPDATE_IN_PROGRESS:6,BADP_ADMIN_CONN_ALREADY_OPEN:7,conn_tstamp:0,isOffset:false,is_local:[],loaded_files:{},WSPR_rgrid:'',GPS_fixes:0,wf_fps:0,is_multi_core:0,log2_seq:0,w3_text:'w3-text-bottom w3-text-css-orange',inactivity_panel:false,no_admin_conns_pend:0,foff_error_pend:0,notify_seq:0,ident_min:16,volume:50,volume_f:1e-6,muted:1,unmuted_color:'lime',pan:0,queued:0,modes_lc:['am','amn','usb','lsb','cw','cwn','nbfm','iq','drm','usn','lsn','sam','sau','sal','sas','qam','nnfm'],modes_uc:[],modes_idx:{},mode_menu:['AM','AMN','USB','USN','LSB','LSN','CW','CWN','NBFM','NNFM','IQ','DRM','SAM','SAU','SAL','SAS','QAM'],ITU_s:['any','R1: Europe, Africa','R2: North & South America','R3: Asia / Pacific','show on band scale only','show on band menu only'],ITU_ANY:0,BAND_SCALE_ONLY:4,BAND_MENU_ONLY:5,RX4_WF4:0,RX8_WF2:1,RX3_WF3:2,RX14_WF0:3,cmap_s:['Kiwi','CSDR','grey','linear','turbo','SdrDx','cust1','cust2','cust3','cust4'],cmap_e:{kiwi:0,CuteSDR:1,greyscale:2,linear:3,turbo:4,SdrDx:5,custom_1:6,custom_2:7,custom_3:8,custom_4:9},aper_s:['man','auto'],aper_e:{man:0,auto:1},esc_lt:'\x11',esc_gt:'\x12',xdLocalStorage_ready:false,prefs_import_ch:-1,ADC_CLK_CORR_DISABLED:0,ADC_CLK_CORR_CONTINUOUS:1,ext_clk:false,pre_samps:0,pre_size:0,pre_last:0,pre_buf:null,pre_data:null,pre_off:0,pre_captured:false,pre_wrapped:false,pre_ping_pong:0,bands:null,bands_community:null,rf_attn:0,freq_memory:[],freq_memory_menu_shown:0,fmem_auto_save:1,fmem_mode_save:0,fmem_arr:null,no_reopen_retry:false,_ver_:1.578,_last_:null};kiwi.modes_lc.forEach(function(e,i){kiwi.modes_uc.push(e.toUpperCase());kiwi.modes_idx[e]=i});var WATERFALL_CALIBRATION_DEFAULT=-13;var SMETER_CALIBRATION_DEFAULT=-13;var rx_chans,wf_chans,wf_chans_real,max_camp;var rx_chan=null;var try_again="";var conn_type;var seriousError=false;var timestamp;var dbgUs=false;var dbgUsFirst=true;var gmap;function kiwi_bodyonload(error){if(error!=''){kiwi_serious_error(error);}
else
if(kiwi_isSmartTV()=='LG'&&kiwi_isChrome()<87){var s='Browser: '+navigator.userAgent+'<br>Sorry, KiwiSDR requires SmartTV Chrome version >= 87';kiwi_serious_error(s);}else{if(initCookie('ident',"").endsWith('KF6VO'))dbgUs=true;conn_type=w3_el('id-kiwi-container').getAttribute('data-type');if(conn_type=='undefined')conn_type='kiwi';console.log('conn_type='+conn_type);w3int_init();if(conn_type=='kiwi'){extint.ws=owrx_ws_open_snd(kiwi_open_ws_cb,{conn_type:conn_type});}else{extint.ws=kiwi_ws_open(conn_type,kiwi_open_ws_cb,{conn_type:conn_type});}}}
function kiwi_open_ws_cb(p){if(p.conn_type!='kiwi')
setTimeout(function(){setInterval(function(){ext_send("SET keepalive");},5000)},5000);if(seriousError)
return;ext_hasCredential(p.conn_type,kiwi_valpwd1_cb,p);}
function kiwi_load_js_polled(obj,js_files){if(!obj.started){kiwi_load_js(js_files,function(){obj.finished=true;});obj.started=true;obj.finished=false;}
return obj.finished;}
function kiwi_load_js_dir(dir,js_files,cb_post,cb_pre){if(isString(js_files))js_files=[js_files];for(var i=0;i<js_files.length;i++){js_files[i]=dir+js_files[i];}
kiwi_load_js(js_files,cb_post,cb_pre);}
function kiwi_load_js(js_files,cb_post,cb_pre){console.log('DYNLOAD START');if(isString(js_files))js_files=[js_files];js_files.push('kiwi/kiwi_js_load.js');console.log(js_files);var loaded_any=false;js_files.forEach(function(src,i){if(!kiwi.loaded_files[src]){if(!src.includes('kiwi_js_load.js')){kiwi.loaded_files[src]=1;loaded_any=true;}else{if(!loaded_any)return;}
var unknown_ext=false;var script;if(src.endsWith('.js')||src.includes('/js?key=')){script=document.createElement('script');script.src=src;script.type='text/javascript';if(src=='kiwi/kiwi_js_load.js'){script.kiwi_js=js_files[i-1];script.kiwi_cb=cb_post;}}else
if(src.endsWith('.css')){script=document.createElement('link');script.rel='stylesheet';script.href=src;script.type='text/css';}else
unknown_ext=true;if(unknown_ext){console.log('DYNLOAD UNKNOWN FILETYPE '+src);}else{script.async=false;document.head.appendChild(script);console.log('DYNLOAD loading '+src);}}else{console.log('DYNLOAD already loaded: '+src);}});console.log('DYNLOAD FINISH');if(!loaded_any){if(cb_pre){console.log('DYNLOAD call pre');w3_call(cb_pre,false);}
if(cb_post){console.log('DYNLOAD call post');w3_call(cb_post);}}else{if(cb_pre){console.log('DYNLOAD call pre subsequent');w3_call(cb_pre,true);}}}
function kiwi_ask_pwd_cb(path,val,first){ext_valpwd(conn_type,val);}
function kiwi_queue_or_camp_cb(path,val,first){var url=window.location.href;console.log(url);url=url+kiwi_add_search_param(window.location,'camp');console.log('--> '+url);window.location.href=url;}
function kiwi_ask_pwd(conn_kiwi){console.log('kiwi_ask_pwd chan_no_pwd_true='+chan_no_pwd_true+' client_public_ip='+client_public_ip);var s1='',s2='';if(conn_kiwi&&chan_no_pwd_true){s1='All channels busy that don\'t require a password ('+chan_no_pwd_true+'/'+rx_chans+')<br>';s2='<br> <b>OR</b> <br><br> click to queue for an available channel, <br>'+'or camp on an existing channel: <br>'+
w3_button('w3-medium w3-padding-smaller w3-aqua w3-margin-T-8','Queue or Camp','kiwi_queue_or_camp_cb');}
var prot=(kiwi_url_param(['p','prot','protected'],true,false)&&conn_kiwi);if(prot)s1='You have requested a password protected channel<br>';var s="KiwiSDR: software-defined receiver <br>"+s1+try_again+
w3_input('w3-retain-input-focus w3-margin-TB-8/w3-label-inline w3-label-not-bold/kiwi-pw|padding:1px|size=40','Password:','id-pwd','','kiwi_ask_pwd_cb')+
s2;kiwi_show_msg(s);w3_field_select('id-pwd',{mobile:1});}
var body_loaded=false;function kiwi_valpwd1_cb(badp,p){if(seriousError)
return;if(badp==kiwi.BADP_TRY_AGAIN){kiwi_ask_pwd(p.conn_type=='kiwi');try_again='Try again. ';}else
if(badp==kiwi.BADP_STILL_DETERMINING_LOCAL_IP){kiwi_show_msg('Still determining local interface address.<br>Please try reloading page in a few moments.');}else
if(badp==kiwi.BADP_NOT_ALLOWED_FROM_IP){kiwi_show_msg('Admin connection not allowed from this ip address.');}else
if(badp==kiwi.BADP_NO_ADMIN_PWD_SET){kiwi_show_msg('No admin password set. Can only connect from same local network as Kiwi.<br>Client ip = '+client_public_ip);}else
if(badp==kiwi.BADP_NO_MULTIPLE_CONNS){kiwi_show_msg('Multiple connections from the same ip address not allowed.<br>Client ip = '+client_public_ip);}else
if(badp==kiwi.BADP_DATABASE_UPDATE_IN_PROGRESS){kiwi_show_msg('Database update in progress.<br>Please try reloading page after one minute.');}else
if(badp==kiwi.BADP_ADMIN_CONN_ALREADY_OPEN){kiwi_show_msg('Another admin connection already open. Only one at a time allowed. <br>'+'Kick the other connection and retry? <br>'+
w3_button('w3-medium w3-padding-smaller w3-red w3-margin-T-8','Kick other admin','kick_other_admin_cb'));}else
if(badp==kiwi.BADP_OK){if(p.conn_type=='kiwi'){extint.ws=owrx_ws_open_wf(kiwi_open_ws_cb2,p);}else{kiwi_valpwd2_cb(0,p);}}}
function kick_other_admin_cb(){console.log('kick_other_admin_cb');msg_send('SET kick_admins');setTimeout(function(){window.location.reload(true);},1000);}
function kiwi_open_ws_cb2(p){ext_hasCredential(p.conn_type,kiwi_valpwd2_cb,p);}
function kiwi_valpwd2_cb(badp,p){if(seriousError)
return;kiwi_show_msg('');if(!body_loaded){body_loaded=true;if(p.conn_type!='kiwi'){w3_hide('id-kiwi-msg-container');w3_show_block('id-kiwi-container');w3_el('id-kiwi-body').style.overflow='hidden';}
try{w3_call(p.conn_type+'_main');}catch(ex){console.log('EX: '+ex);console.log('kiwi_valpwd2_cb: no interface routine for '+p.conn_type+'?');}}else{console.log("kiwi_valpwd2_cb: body_loaded previously!");return;}}
function kiwi_xdLocalStorage_init(){var iframeUrls=[];var N_PUB=2;for(var i=0;i<N_PUB;i++){iframeUrls[i]='http://pub'+i+'.kiwisdr.com/pkgs/xdLocalStorage/xdLocalStorage.php/?key=4e92a0c3194c62b2a067c494e2473e8dfe261138';}
xdLocalStorageHA.init({iframeUrls:iframeUrls,initCallback:function(){kiwi.xdLocalStorage_ready=true;console.log('xdLocalStorageHA READY');}});}
var override_freq,override_mode,override_zoom,override_max_dB,override_min_dB,override_9_10;function kiwi_get_init_settings(){var init_f=(init_frequency==undefined)?7020:init_frequency;init_f=ext_get_cfg_param('init.freq',init_f,EXT_NO_SAVE);init_frequency=override_freq?override_freq:init_f;var init_m=ext_get_cfg_param('init.mode',init_mode||'lsb',EXT_NO_SAVE);console.log('INIT init_mode='+init_mode+' init.mode='+init_m+' override_mode='+override_mode);init_mode=override_mode?override_mode:init_m;if(init_mode==='drm')init_mode='am';var init_z=(init_zoom==undefined)?0:init_zoom;init_z=ext_get_cfg_param('init.zoom',init_z,EXT_NO_SAVE);init_zoom=isNumber(override_zoom)?override_zoom:init_z;var init_max=(init_max_dB==undefined)?-10:init_max_dB;init_max=ext_get_cfg_param('init.max_dB',init_max,EXT_NO_SAVE);init_max_dB=override_max_dB?override_max_dB:init_max;var init_min=(init_min_dB==undefined)?-110:init_min_dB;init_min=ext_get_cfg_param('init.min_dB',init_min,EXT_NO_SAVE);init_min_dB=override_min_dB?override_min_dB:init_min;console.log('INIT f='+init_frequency+' m='+init_mode+' z='+init_zoom
+' min='+init_min_dB+' max='+init_max_dB);w3_call('init_scale_dB');var ant=ext_get_cfg_param('rx_antenna');var el=w3_el('rx-antenna');if(el!=undefined&&ant){el.innerHTML='Antenna: '+kiwi_decodeURIComponent('rx_antenna',ant);}
kiwi.WSPR_rgrid=ext_get_cfg_param_string('WSPR.grid','',EXT_NO_SAVE);}
var cfg={};var dxcfg=null;var dxcomm_cfg=null;var adm={};function config_save(cfg_s,cfg){var kiwi_cfg=kiwi[cfg_s];if(!isArg(kiwi_cfg)||!isArg(kiwi_cfg.cmd)){kiwi_debug('DANGER: config_save() cfg_s=<'+cfg_s+'> NOT FOUND in kiwi[] ???',true);return;}
var cfg_len=JSON.stringify(cfg).length;if(cfg_len<32){kiwi_debug('DANGER: config_save() cfg_s=<'+cfg_s+'> cfg_len='+cfg_len+' TOO SMALL???',true);return;}{config_save2(kiwi_cfg,cfg);}}
function config_save2(kiwi_cfg,cfg){var s=encodeURIComponent(JSON.stringify(cfg,null,3));ext_send_cfg(kiwi_cfg,s);}
function cfg_save_json(id,path,val){if(path=='cfg.ant_switch.denyswitching'&&!kiwi.ant_sw_first_set_ignored){kiwi.ant_sw_first_set_ignored=true;return;}
var s;if(path.startsWith('adm.')){config_save('adm',adm);}else
if(path.startsWith('dxcfg.')){if(dx.dxcfg_parse_error){console.log('$cfg_save_json dxcfg '+id+': NOT SAVED DUE TO dxcfg_parse_error');return;}
config_save('dxcfg',dxcfg);}else{config_save('cfg',cfg);}}
var geo={geo:'',json:'',retry:0,};function kiwi_geolocate(which){var ff=kiwi_isFirefox();if(ff&&ff<=28)return;if(which==undefined)which=(new Date()).getSeconds();which=which%3;var server;switch(which){case 0:server='https://ipapi.co/json';break;case 1:server='https://get.geojs.io/v1/ip/geo.json';break;case 2:server='http://ip-api.com/json?fields=49177';break;default:break;}
kiwi_ajax(server,function(json){if(isUndefined(json.AJAX_error)){console.log('GEOLOC '+server);console.log(json);geoloc_json(json);}else{if(geo.retry++<=3)
kiwi_geolocate(which+1);}},null,5000);}
function geoloc_json(json){if(isDefined(json.AJAX_error))
return;if(window.JSON&&window.JSON.stringify)
geo.json=JSON.stringify(json);else
geo.json=json.toString();var country=json.country_name||json.country;var region=json.regionName||json.region;if(country=="United States"&&region){country=region+', USA';}
geo.geo='';if(json.city)geo.geo+=json.city;if(country)geo.geo+=(json.city?', ':'')+country;console.log('GEOLOC '+geo.geo);}
function kiwi_geo(){return encodeURIComponent(geo.geo);}
function kiwi_geojson(){return encodeURIComponent(geo.json);}
var server_time_utc,server_time_local,server_time_tzid,server_time_tzname,server_tz;var time_display_current=true;function time_display_cb(o){if(isUndefined(o.tu))return;server_time_utc=o.tu;server_time_local=o.tl;server_time_tzid=decodeURIComponent(o.ti);server_time_tzname=decodeURIComponent(o.tn).replace(/\\/g,'').replace(/_/g,' ');server_tz=server_time_tzname;if(server_time_tzid)server_tz+=' ('+server_time_tzid+')';if(!time_display_started){time_display_periodic();time_display_started=true;}else
time_display(time_display_current);}
function time_display(display_time){var el=w3_el('id-time-display-text-inner');if(!el)return;var noLatLon=(server_time_local==''||server_time_tzname=='null');w3_innerHTML('id-time-display-UTC',server_time_utc?server_time_utc:'?');w3_innerHTML('id-time-display-local',noLatLon?'?':server_time_local);w3_innerHTML('id-time-display-tzname',noLatLon?'Lat/lon needed for local time':server_tz);w3_opacity('id-time-display-logo-inner',display_time?0:1);w3_opacity('id-time-display-inner',display_time?1:0);}
function time_display_periodic(){time_display(time_display_current);time_display_current^=1;setTimeout(function(){time_display_periodic();},time_display_current?50000:10000);}
var time_display_started=false;var time_display_prev;function time_display_setup(ext_name_or_id){if(ext_name_or_id.startsWith('id-')==false)
ext_name_or_id+='-time-display';var el;if(time_display_prev){el=w3_el(time_display_prev);if(el)el.innerHTML='';}
time_display_prev=ext_name_or_id;var el=w3_el(ext_name_or_id);el.innerHTML=w3_div('id-time-display-inner',w3_div('id-time-display-text-inner',w3_inline('',w3_div('id-time-display-UTC'),w3_div('cl-time-display-text-suffix','UTC')),w3_inline('',w3_div('id-time-display-local'),w3_div('cl-time-display-text-suffix','Local')),w3_div('id-time-display-tzname')))+
w3_div('id-time-display-logo-inner',w3_div('id-time-display-logo-text','Powered by'),'<a href="https://github.com/ha7ilm/openwebrx" target="_blank"><img id="id-time-display-logo" src="gfx/openwebrx-top-logo.png" /></a>');time_display(time_display_current);}
function time_display_height(){return 80;}
function time_display_width(){return 200;}
function time_display_html(ext_name,top){top=top||'50px';return w3_div(ext_name+'-time-display|top:'+top+'; background-color:black; position:relative;');}
var ansi={colors:[[0,0,0],[252,57,31],[49,231,34],[234,236,35],[88,51,255],[249,53,248],[68,249,249],[233,235,235],[0,0,0],[252,57,31],[49,231,34],[234,236,35],[88,51,255],[249,53,248],[68,249,249],[233,235,235],null],BRIGHT:8,RED:"\u001b[97m\u001b[101m",YELLOW:"\u001b[103m",GREEN:"\u001b[102m",CYAN:"\u001b[106m",BLUE:"\u001b[97m\u001b[104m",MAGENTA:"\u001b[97m\u001b[105m",GREY:"\u001b[47m",NORM:"\u001b[m",rolling:['RED','YELLOW','GREEN','CYAN','BLUE','MAGENTA','GREY'],rolling_n:7};function kiwi_output_sgr(p){var dbg_sgr=0;var msg='SGR',str='';var sgr,saw_reset=0,saw_color=0;var sa=p.esc.s.substr(1).split(';');var sl=sa.length;if(dbg_sgr)console.log('SGR '+kiwi_JSON(p.esc.s)+' sl='+sl);if(dbg_sgr)console.log(sa);if(p.isAltBuf)msg+='('+p.r+','+p.c+')';for(var ai=0;ai<sl&&!isNumber(msg);ai++){sgr=(sa[ai]==''||sa[ai]=='m')?0:parseInt(sa[ai]);if(dbg_sgr)console.log('sgr['+ai+']='+sgr);if(sgr==0){p.sgr.fg=p.sgr.bg=null;msg+=', reset';saw_reset=1;}else
if(isNaN(sgr)){msg=2;}else
if(sgr==1){p.sgr.bright=ansi.BRIGHT;msg+=', bright';}else
if(sgr==2){p.sgr.bright=0;msg+=', faint';}else
if(sgr==22){p.sgr.bright=0;msg+=', normal';}else
if(sgr==7){var tf=p.sgr.fg;p.sgr.fg=p.sgr.bg;p.sgr.bg=tf;if(p.sgr.fg==null)p.sgr.fg=[255,255,255];if(p.sgr.bg==null)p.sgr.bg=[0,0,0];msg+=', reverse video';saw_color=1;}else
if(sgr==27){p.sgr.fg=p.sgr.bg=null;msg+=', reverse video off';saw_reset=1;}else
if(sgr>=30&&sgr<=37){if(dbg_sgr)console.log('SGR='+sgr+' bright='+p.sgr.bright);p.sgr.fg=ansi.colors[sgr-30+p.sgr.bright];msg+=', fg color';saw_color=1;}else
if(sgr>=90&&sgr<=97){p.sgr.fg=ansi.colors[sgr-90+ansi.BRIGHT];msg+=', fg color bright';saw_color=1;}else
if(sgr==39){p.sgr.fg=null;msg+=', fg normal';saw_color=1;}else
if(sgr>=40&&sgr<=47){p.sgr.bg=ansi.colors[sgr-40+p.sgr.bright];msg+=', bg color';saw_color=1;}else
if(sgr>=100&&sgr<=107){p.sgr.bg=ansi.colors[sgr-100+ansi.BRIGHT];msg+=', bg color bright';saw_color=1;}else
if(sgr==49){p.sgr.bg=null;msg+=', bg normal';saw_color=1;}else
if(sgr==38||sgr==48){if(dbg_sgr)console.log('SGR-8/24 sl='+sl);var n8,r,g,b,color,ci;if(sl==3&&(parseInt(sa[1])==5)&&(!isNaN(n8=parseInt(sa[2])))){if(dbg_sgr)console.log('SGR n8='+n8);ai+=2;if(n8<=15){color=ansi.colors[n8];if(sgr==38)p.sgr.fg=color;else p.sgr.bg=color;msg+=', 38/48 mode color';saw_color=1;}else
if(n8<=231){n8-=16;r=Math.floor(n8/36);n8-=r*36;g=Math.floor(n8/6);n8-=g*6;b=n8;r=Math.floor(255*r/5);g=Math.floor(255*g/5);b=Math.floor(255*b/5);color=[r,g,b];if(sgr==38)p.sgr.fg=color;else p.sgr.bg=color;msg+=', color cube';saw_color=1;}else
if(n8<=255){ci=8+(n8-232)*10;if(dbg_sgr)console.log('n8='+n8+' ci='+ci);color=[ci,ci,ci];if(sgr==38)p.sgr.fg=color;else p.sgr.bg=color;msg+=', grayscale ramp';saw_color=1;}else
msg=2;}else
if(sl==5&&(parseInt(sa[1])==2)&&(!isNaN(r=parseInt(sa[2])))&&(!isNaN(g=parseInt(sa[3])))&&(!isNaN(b=parseInt(sa[4])))){r=w3_clamp(r,0,255);g=w3_clamp(g,0,255);b=w3_clamp(b,0,255);color=[r,g,b];if(sgr==38)p.sgr.fg=color;else p.sgr.bg=color;msg+=', 24-bit color';saw_color=1;}else
msg=2;}else
msg=2;}
if(saw_reset){if(dbg_sgr)console.log('SGR DONE');if(p.sgr.span){str+='</span>';p.sgr.span=0;}}else
if(saw_color){if(dbg_sgr){console.log('SGR saw_color fg='+kiwi_rgb(p.sgr.fg)+' bg='+kiwi_rgb(p.sgr.bg));console.log(p.sgr.fg);console.log(p.sgr.bg);}
if(p.sgr.span)str+='</span>';str+='<span style="'+(p.sgr.fg?('color:'+kiwi_rgb(p.sgr.fg)+';'):'')+(p.sgr.bg?('background-color:'+kiwi_rgb(p.sgr.bg)+';'):'')+'">';p.sgr.span=1;}else{if(dbg_sgr)console.log('SGR ERROR');}
return{msg:msg,str:str};}
function kiwi_output_msg(id,id_scroll,p){var i,j;var dbg=(0&&dbgUs);var dbg2=((0&&dbgUs)||dbg);if(dbgUs)kiwi.d.p=p;if(0&&dbg){console.log('$kiwi_output_msg id='+id+' init='+p.init+' isAltBuf='+p.isAltBuf+' s='+p.s);console.log('$ '+kiwi_JSON(p));}
var parent_el=w3_el(id);if(!parent_el){console.log('kiwi_output_msg NOT_FOUND id='+id);return;}
var appendEmptyLine=function(parent_el){var el=w3_create_appendElement(parent_el,'pre','');p.nlines++;while(p.nlines>p.max_lines){parent_el.removeChild(parent_el.firstChild);p.nlines--;}
return el;};var removeAllLines=function(parent_el){while(parent_el.firstChild){parent_el.removeChild(parent_el.firstChild);}
p.nlines=0;};var console_cursor=function(ch){ch=ch||'&nbsp;';return'<span class="cl-admin-console-cursor">'+ch+'</span>';};var render2=function(){var fg=null,bg=null,span=false;for(var r=1;r<=p.nrows;r++){if(!p.dirty[r])continue;p.dirty[r]=false;var s='';for(var c=1;c<=p.cols;c++){var color=p.color[r][c];if(isUndefined(color)){console_nv('color undef',{r},{c});}
if(color.fg!=fg||color.bg!=bg){if(span)s+='</span>';if(color.fg||color.bg){s+='<span style="'+(color.fg?('color:'+kiwi_rgb(color.fg)+';'):'')+
(color.bg?('background:'+kiwi_rgb(color.bg)+';'):'')+'">';}else{span=false;}
fg=color.fg;bg=color.bg;span=true;}
var ch=p.screen[r][c];if(ch=='<')ch='&lt;';else
if(ch=='>')ch='&gt;';else
if(ch=='&')ch='&amp;';else
if(ch=='\'')ch='&apos;';else
if(ch=='/')ch='&#47;';else;if(p.show_cursor&&r==p.r&&c==p.c){s+=console_cursor(ch);p.r_cursor=r;p.c_cursor=c;}else{s+=ch;}}
if(s=='')s='&nbsp;';else
if(span)s+='</span>';try{p.els[r].innerHTML=s;}catch(ex){if(dbg){console.log('r='+r);console.log(p.els[r]);console.log(ex);}}}};var render=function(){if(p.r_cursor!=p.r&&p.r_cursor!=0){p.dirty[p.r_cursor]=true;}
render2();};var sched=function(){p.sched_time=Date.now();if(!p.metronome_running){p.metronome_running=true;p.metronome_interval=setInterval(function(){if(p.sched_time<(Date.now()-200)){kiwi_clearInterval(p.metronome_interval);p.metronome_running=false;render();}},200);}};var dirty=function(){p.dirty[p.r]=true;};var screen_char=function(ch,color,shift_mode){var r=p.r,c=p.c;if(shift_mode!=p.NOSHIFT_MODE&&p.insertMode){for(i=r.cols-1;i>=c;i--){p.screen[r][i+1]=p.screen[r][i];p.color[r][i+1]=p.color[r][i];}}
try{p.screen[r][c]=ch;}catch(ex){if(dbg){console.log('r='+r+' c='+c);console.log(kiwi_JSON(ch));console.log(p);console.log(ex);}}
if(isUndefined(p.screen[r])){if(dbg){console_nv('screen_char',{r},{c},'kiwi.d.p.nrows');console.log(p);}
return;}
p.color[r][c]=color?color:{fg:p.sgr.fg,bg:p.sgr.bg};dirty();p.c++;if(p.c>p.cols){if(p.eol_wrap&&shift_mode!=p.NOSHIFT_MODE){p.c=1;p.r++;if(p.r>p.nrows){p.r=1;dirty();}}else{p.c=p.cols;}}
sched();};var move_in_display=function(dr_start,sr_start,sr_end,step){dr_start=w3_clamp(dr_start,0,p.nrows);sr_start=w3_clamp(sr_start,0,p.nrows);sr_end=w3_clamp(sr_end,0,p.nrows);var row=dr_start;var down=(step>0);for(var ri=sr_start;(down&&ri<=sr_end)||(!down&&ri>=sr_end);ri+=step){p.r=row;row+=step;p.c=1;for(var ci=1;ci<=p.cols;ci++){screen_char(p.screen[ri][ci],p.color[ri][ci]);}}};var erase_in_line=function(c_start,c_end){for(var c=c_start;c_start&&c<=c_end;c++){p.screen[p.r][c]=' ';p.color[p.r][c]={fg:null,bg:null};}
dirty();sched();};var erase_in_display=function(r_start,r_end,c_start,c_end){for(var r=r_start;r_start&&r<=r_end;r++){for(var c=c_start;c<=((r==p.r)?c_end:p.cols);c++){if(isUndefined(p.screen[r])){console_nv('erase_in_display',{r},{c},'kiwi.d.p.nrows','kiwi.d.p.ncols');console.log(p);}
p.screen[r][c]=' ';p.color[r][c]={fg:null,bg:null};}
p.dirty[r]=true;}
sched();};var snew_add=function(c){if(snew==''){p.snew_r=p.r;p.snew_c=p.c;}
snew+=c;};var snew_dump=function(where){if(snew!=''){if(dbg)console.log('> '+(p.isAltBuf?'ALT':'REG')+' '+where+' ('+p.snew_r+','+p.snew_c+') '+' CHARS #'+snew.length+' '+kiwi_JSON(snew));snew='';}};var html_add=function(c){if(isString(p.line_html[p.ccol]))
p.line_html[p.ccol]+=c;else
p.line_html[p.ccol]=c;};var line_s=function(){return kiwi_JSON(p.line.join(''));};var line_join=function(col_start,col_stop){col_stop=col_stop||p.cols;var s='';var a=[];var i;for(var c=col_start,i=0;c<col_stop;c++,i++){var sgr=(isString(p.line_sgr[c]))?p.line_sgr[c]:'';var html=(isString(p.line_html[c]))?p.line_html[c]:'';var ch=(isString(p.line[c]))?p.line[c]:'';s+=sgr+html+ch;a[i]={sgr:sgr,html:html,ch:ch,s:s};}
return{s:s,a:a};};var init_common=function(init){var r,c;if(dbg2)console_nv('init_common',{init},'kiwi.d.p.nrows');if(init==p.INIT_ONCE||init==p.INIT_RESIZE){p.screen=[];p.color=[];p.dirty=[];p.els=[];for(var r=0;r<=p.nrows;r++){p.screen[r]=[];p.color[r]=[];}}
if(init==p.INIT_ALTBUF||init==p.INIT_RESIZE){removeAllLines(parent_el);for(var r=1;r<=p.nrows;r++){try{for(var c=1;c<=p.cols;c++){p.screen[r][c]=' ';p.color[r][c]={fg:null,bg:null};}}catch(ex){if(dbg){console.log('--------');console.log('r='+r+' c='+c);console.log(p.screen);console.log(ex);}}
p.dirty[r]=false;p.els[r]=appendEmptyLine(parent_el);p.els[r].innerHTML='&nbsp;';}}};var s;if(isNoArg(p.no_decode)||p.no_decode!=true){try{s=kiwi_decodeURIComponent('kiwi_output_msg',p.s);}catch(ex){console.log('decodeURIComponent FAIL:');console.log(p.s);s=p.s;}
if(s==null)s='(kiwi_decodeURIComponent():null)';}else{s=p.s;}
if(p.intercept){p.intercept(s);}
if(p.init!=true){p.INIT_ONCE=0;p.INIT_RESIZE=1;p.INIT_ALTBUF=2;p.resized=false;removeAllLines(parent_el);p.el=appendEmptyLine(parent_el);p.cols=p.cols||140;p.NONE=0;p.ESC=1;p.CSI=2;p.NON_CSI=3;p.NOSHIFT_MODE=true;p.esc={s:'',state:p.NONE};p.sgr={span:0,bright:0,fg:null,bg:null};p.return_pending=false;p.must_scroll_down=false;p.traceEvery=false;p.ccol=1;p.line=[];p.line_sgr=[];p.line_html=[];p.inc=1;p.nrows=p.rows;p.r=p.c=1;p.margin_set=false;p.margin_top=1;p.margin_bottom=p.nrows;p.show_cursor=p.show_cursor||false;p.r_cursor=p.c_cursor=0;p.insertMode=true;p.eol_wrap=false;init_common(p.INIT_ONCE);p.isAltBuf=false;p.altbuf_via_cursor_visible=false;p.altbuf_via_cup=false;p.alt_save='';p.rend_seq=0;p.metronome_running=false;p.sched_time=0;p.init=true;}
if(p.resized&&p.isAltBuf){if(dbg2)console.log('console resized nrows: '+p.nrows+' => '+p.rows+' #############################################################################################');p.nrows=p.rows;init_common(p.INIT_RESIZE);p.margin_top=1;p.margin_bottom=p.nrows;p.r=p.c=1;dirty();p.r_cursor=p.c_cursor=0;render();p.resized=false;}
var snew='',stmp;var el_scroll=w3_el(id_scroll);var wasScrolledDown=null;if(p.process_return_alone&&s.charAt(0)=='\r'&&(s.length==1||s.charAt(1)!='\n')){if(p.isAltBuf){}else{s=s.substring(1);p.line=[];p.line_sgr=[];p.line_html=[];p.ccol=1;}}
if(0){if(dbg)console.log('kiwi_output_msg:');if(dbg)console.log(kiwi_JSON(p));if(dbg)console.log(kiwi_JSON(s));}
if(p.remove_returns)s=s.replace(/\r/g,'');if(p.inline_returns&&!p.isAltBuf){s=s.replace(/\r\n/g,'\n');s=s.replace(/\r\n/g,'\n');}
if(dbg)console.log('OUTPUT '+kiwi_JSON(s).replace(/\\u001b/g,'\\e'));var cnt=0;for(var si=0;si<s.length;si++){var result=null;var c=s.charAt(si);if(p.inline_returns&&p.return_pending&&c!='\r'){if(p.isAltBuf){}else{p.ccol=1;p.line_sgr[p.ccol]=null;p.line_html[p.ccol]=null;p.return_pending=false;}}
if(c=='\f'){if(p.isAltBuf){}else{if(dbg)console.log('console \f');removeAllLines(parent_el);p.el=appendEmptyLine(parent_el);p.line=[];p.line_sgr=[];p.line_html=[];p.ccol=1;}}else
if(c=='\r'){if(p.isAltBuf){p.c=1;dirty();}
if(p.inline_returns){p.return_pending=true;}
snew_dump('rtn');result='\\r col = 1 ('+p.r+',1)';}else
if(c=='\n'&&p.isAltBuf){if(p.margin_set){if(p.r<p.nrows){p.r++;p.c=1;dirty();result='\\n row++ ('+p.r+'('+p.nrows+'),'+p.c+')';}else{move_in_display(p.margin_top,p.margin_top+1,p.margin_bottom,+1);result='\\n (scroll text up) nrows='+p.nrows;}}else{p.c=1;if(p.r<p.rows)p.r++;dirty();result='\\n row++ ('+p.r+','+p.c+')';}
if(dbg)console.log('scroll text up FIN: '+p.r+' '+p.c+' '+p.r_cursor+' '+p.c_cursor+' '+result);}else
if(c=='\b'){result='backspace (arrow left)';if(p.isAltBuf){if(p.c>1){dirty();p.c--;}}else{if(p.ccol>1){p.ccol--;if(dbg)console.log('BACKSPACE col='+p.ccol+' '+line_s());}}}else
if(c=='\t'){result='tab';if(p.isAltBuf){}else{snew_add('&nbsp;');p.line[p.ccol]='&nbsp;';p.ccol++;while((p.ccol&7)!=0){snew_add('&nbsp;');p.line[p.ccol]='&nbsp;';p.ccol++;}}}else
if(c=='\x1b'){p.esc.s='';p.esc.state=p.ESC;p.traceEvery=false;}else
if(p.esc.state>=p.ESC){var interp=false;if(p.esc.state==p.ESC){if(c=='['){p.esc.state=p.CSI;}else{p.esc.state=p.NON_CSI;switch(c){case'(':case'O':cnt=2;break;case'>':case'=':cnt=1;break;default:if(dbg)console.log('$LEN? c='+c);cnt=1;break;}}}
if(p.esc.state==p.CSI){p.esc.s+=c;if(p.esc.s.length>1&&c>='@'&&c<='~')interp=true;}else
if(p.esc.state==p.NON_CSI&&cnt){p.esc.s+=c;cnt--;if(cnt==0)interp=true;}
if(interp){var first=p.esc.s.charAt(0);var second=p.esc.s.charAt(1);var last_hl=(c=='h'||c=='l');var enable=(c=='h');result=0;var error=0;var n1=1,n2=1;var t=p.esc.s.slice(1);if(t.length>1&&isNumber(+t[0])){var a=t.slice(0,t.length-1);a=a.split(';');n1=+a[0];n1=n1||1;if(a.length>1)n2=+a[1];n2=n2||1;}
if(first=='['){if(c=='m'){var rv=kiwi_output_sgr(p);result=rv.msg;if(p.isAltBuf){}else{snew_add(rv.str);p.line_sgr[p.ccol]=rv.str;if(dbg)console.log('AFTER SGR snew='+kiwi_JSON(snew));}
p.traceEvery=true;}else
if(c=='K'){if(p.isAltBuf){var c_start,c_end;result='erase in line: ';switch(second){case'0':case'K':c_start=p.c;c_end=p.cols;result+='cur to EOL';break;case'1':c_start=1;c_end=p.c;result+='BOL to cur';break;case'2':c_start=1;c_end=p.cols;result+='full line';break;default:c_start=0;break;}
erase_in_line(c_start,c_end);}else{if(second=='K'){if(dbg)console.log('EEOL BEFORE col='+p.ccol+' '+line_s());var col_stop=p.line.length;for(i=p.ccol;i<=col_stop;i++){p.line[i]=null;p.line_sgr[i]=null;p.line_html[i]=null;}
if(dbg)console.log('EEOL AFTER col='+p.ccol+' '+line_s());result='erase in line: cur to EOL';}}}else
if(c=='J'){if(p.isAltBuf){var r_start,r_end,c_start,c_end;if(second=='0'||second=='J'){r_start=p.r,r_end=p.nrows;c_start=p.c,c_end=p.cols;result='erase cur to EOS';}else
if(second=='2'||second=='3'){r_start=1,r_end=p.nrows;c_start=1,c_end=p.cols;result='erase full screen';}else
if(second=='1'){r_start=1,r_end=p.r;c_start=1,c_end=p.c;result='erase BOS to cur';}else{r_start=0;result=2;}
erase_in_display(r_start,r_end,c_start,c_end);}else{if(second=='2'||second=='3'){if(dbg)console.log('console ERASE FULL SCREEN');removeAllLines(parent_el);p.el=appendEmptyLine(parent_el);p.line=[];p.line_sgr=[];p.line_html=[];p.ccol=1;result='erase full screen';}}}else
if(c=='H'){result='move '+n1+','+n2;if(p.isAltBuf){if(w3_clamp3(n1,0,p.nrows)){dirty();p.r=n1;p.c=n2;dirty();}}else{error=1;}}else
if(c=='d'){result='move row '+n1;if(p.isAltBuf){if(w3_clamp3(n1,0,p.nrows)){dirty();p.r=n1;dirty();}}else{error=1;}}else
if(c=='G'){result='move col '+n1;if(p.isAltBuf){p.c=n1;dirty();}else{error=1;}}else
if((second=='?'&&last_hl)||(second=='!'&&c=='p')){var as=p.esc.s.substr(2);aa=as.split(';');n1=parseInt(aa[0]);n2=parseInt(aa[1]);if(dbg)console_nv(as,{n1},{n2});if(second=='?'){result=(enable?'SET':'RESET')+' ';}else{result='soft term reset: ';n1=1049;enable=false;}
var enter_altbuf=false,exit_altbuf=false,exit_altbuf_no_restore=false;switch(n1){case 1:result+='cursor keys mode';break;case 3:result+='col mode 132/80 (ignored)';break;case 4:result+='scrolling smooth/jump (ignored)';break;case 7:result+='vertical autowrap';break;case 12:result+='cursor bold ';if(n2!=25)break;case 25:result+='cursor visible';p.show_cursor=enable?true:false;if(!enable&&!p.isAltBuf){enter_altbuf=true;p.altbuf_via_cursor_visible=true;}else
if(enable&&p.isAltBuf&&p.altbuf_via_cursor_visible){exit_altbuf=true;}
break;case 69:result+='LR margins (ignored)';break;case 1049:result+='alt screen buf';if(enable&&!p.isAltBuf){if(dbg)console.log('1049: p.nrows='+p.nrows);enter_altbuf=true;p.altbuf_via_cup=true;}else
if(!enable&&p.isAltBuf&&p.altbuf_via_cup){exit_altbuf=true;}
break;default:result+='$UNKNOWN ='+n1;break;}
if(enter_altbuf){p.nrows=p.rows;if(dbg2)console.log('$ENTER alt buf via '+(p.altbuf_via_cup?'cup':'cursor_visible')+' nrows='+p.nrows+' rows='+p.rows+' ====================================');p.alt_save=parent_el.innerHTML.replace(/<pre><span class="cl-admin-console-cursor">.*<\/span><\/pre>$/,'');if(dbg)console.log(kiwi_JSON(p.alt_save));init_common(p.INIT_ALTBUF);if(isAdmin())console_is_char_oriented(true);p.margin_set=false;p.isAltBuf=true;p.r=p.c=1;dirty();if(dbg2)console.log('1049: '+p.r+' '+p.c+' '+p.r_cursor+' '+p.c_cursor);}else
if(exit_altbuf){if(dbg2)console.log('$EXIT alt buf via '+(p.altbuf_via_cup?'cup':'cursor_visible')+' nrows='+p.nrows+' rows='+p.rows+' ====================================');p.altbuf_via_cursor_visible=false;p.altbuf_via_cup=false;if(dbg)console.log(kiwi_JSON(p.alt_save));parent_el.innerHTML=p.alt_save;p.el=appendEmptyLine(parent_el);p.must_scroll_down=true;if(isAdmin())console_is_char_oriented();p.isAltBuf=false;}else
if(exit_altbuf_no_restore){if(dbg2)console.log('$EXIT alt buf NO RESTORE =====================================');p.must_scroll_down=true;if(isAdmin())console_is_char_oriented();p.isAltBuf=false;}}else
if(second=='4'&&last_hl){p.insertMode=enable;result=enable?'INSERT mode':'REPLACE mode';}else
if(c=='X'){if(n1==0)n1=1;if(p.isAltBuf){var col;for(var ci=0,col=p.c;ci<n1&&col<=p.cols;ci++,col++){p.screen[p.r][col]=' ';p.color[p.r][col]={fg:null,bg:null};}
dirty();sched();result='erase '+n1+' chars';}else{var col;for(var ci=0,col=p.ccol;ci<n1&&col<=p.line.length;ci++,col++){p.line[ci]=null;}}}else
if(c=='P'){if(n1==0)n1=1;if(p.isAltBuf){var save_col=p.c,src_col,dst_col;for(src_col=p.c+n1,dst_col=p.c;src_col<=p.cols;src_col++,dst_col++){p.screen[p.r][dst_col]=p.screen[p.r][src_col];p.color[p.r][dst_col]=p.color[p.r][src_col];}
for(;dst_col<p.cols;dst_col++){p.screen[p.r][dst_col]=' ';p.color[p.r][dst_col]={fg:null,bg:null};}
p.c=save_col;dirty();sched();}else{if(dbg)console.log('DEL-CHARS BEFORE col='+p.ccol+'/'+p.line.length+' '+line_s());for(i=0;i<n1;i++){var col_stop=p.line.length;for(j=p.ccol;j<col_stop;j++)p.line[j]=p.line[j+1];p.line[j]=null;}
if(dbg)console.log('DEL-CHARS AFTER col='+p.ccol+'/'+p.line.length+' '+line_s());}
result='del #'+n1+' chars';}else
if(c=='@'){if(n1==0)n1=1;if(p.isAltBuf){var save_col=p.c,src_col,dst_col;for(src_col=p.cols-n1,dst_col=p.cols;src_col>=save_col;src_col--,dst_col--){p.screen[p.r][dst_col]=p.screen[p.r][src_col];p.color[p.r][dst_col]=p.color[p.r][src_col];}
for(;dst_col>=save_col;dst_col--){p.screen[p.r][dst_col]=' ';p.color[p.r][dst_col]={fg:null,bg:null};}
p.c=save_col;dirty();sched();}else{if(dbg)console.log('INS-CHARS BEFORE col='+p.ccol+'/'+p.line.length+' '+line_s());for(i=0;i<n1;i++){var col_stop=p.line.length;for(j=col_stop;j>p.ccol;j--)p.line[j]=p.line[j-1];}
if(dbg)console.log('INS-CHARS AFTER col='+p.ccol+'/'+p.line.length+' '+line_s());}
result='ins #'+n1+' chars';}else
if(c=='r'&&p.isAltBuf){if(dbg)console.log('margin set: PREV p.nrows='+p.nrows+' NEW p.nrows='+n2);p.margin_top=n1;p.margin_bottom=n2;p.margin_set=true;p.nrows=n2;result='set margins, top='+n1+', bottom/nrows='+n2;}else
if(c=='S'&&p.isAltBuf){move_in_display(p.margin_top,p.margin_top+n1,p.margin_bottom,+1);if(p.r<p.nrows){p.r++;erase_in_display(p.r,p.margin_bottom,1,p.cols);}
p.insertMode=save_insertMode;p.r=p.c=1;dirty();result='pan down '+n1;}else
if(c=='T'&&p.isAltBuf){var save_insertMode=p.insertMode;p.insertMode=false;move_in_display(p.margin_bottom,p.margin_bottom-n1,p.margin_top,-1);erase_in_display(p.margin_top,p.margin_top+n1-1,1,p.cols);p.insertMode=save_insertMode;p.r=p.c=1;dirty();result='pan up '+n1;}else
if(c=='M'&&p.isAltBuf){var save_insertMode=p.insertMode;p.insertMode=false;move_in_display(p.r,p.r+1,p.r+n1,+1);erase_in_display(p.r+n1,p.r+n1,1,p.cols);p.insertMode=save_insertMode;result='delete line(s) '+n1;}else
if(c=='t'){result='set lines per page '+n1+' (ignored)';}else
if(c=='A'){if(p.isAltBuf){if(p.r>1){dirty();p.r--;dirty();}
result='arrow up';}else{}}else
if(c=='B'){if(p.isAltBuf){if(p.r<p.nrows){dirty();p.r++;dirty();}
result='arrow down';}else{}}else
if(c=='C'){if(p.isAltBuf){if(p.c<p.cols){dirty();p.c++;}}else{if(dbg)console.log('ARROW RIGHT col='+p.ccol+'/'+p.line.length+' '+sq(p.line[p.ccol])+' '+line_s());if(p.ccol<p.line.length)
p.ccol++;}
result='arrow right';}else
if(c=='D'){if(p.isAltBuf){if(p.c>1){dirty();p.c--;}
result='arrow left';}else{}}else{result=2;}}else
if(first=='('){result='define char set';}else
if(first==']'){result='define colors (ignored)';}else
switch(c){case'H':result='set horiz tab (nop)';break;case'M':if(p.isAltBuf){var save_insertMode=p.insertMode;p.insertMode=false;move_in_display(p.margin_bottom,p.margin_bottom-1,p.margin_top,-1);erase_in_display(p.margin_top,p.margin_top,1,p.cols);p.insertMode=save_insertMode;result='scroll text down';}
break;case'>':result='set numeric keypad';break;case'=':result='keypad application mode';break;case'7':result='save cursor';break;case'8':result='restore cursor';break;case'c':result='reset initial state (nop)';break;default:result=2;break;}
snew_dump('cmd');if(error)result+=' UNEXPECTED ====================================================================================';error=0;if(result===1){if(dbg)console.log('> ESC '+kiwi_JSON(p.esc.s)+' $IGNORED ==========================================================================================');}else
if(result===2){if(1||dbg)console.log('> ESC '+kiwi_JSON(p.esc.s)+' $UNKNOWN ======================================================================================');}else
if(isString(result)){if(dbg)console.log('> ESC '+(p.isAltBuf?'ALT':'REG')+' '+kiwi_JSON(p.esc.s)+' '+result);}
result=null;p.esc.state=p.NONE;}}else
if(c>=' '||c=='\n'||c=='\t'){var prt=false;if(!p.isAltBuf&&c=='<'){if(p.inc){snew_add('<');p.line[p.ccol]='&lt;';p.ccol+=p.inc;}
prt=true;}else
if(!p.isAltBuf&&c=='>'){if(p.inc){snew_add('>');p.line[p.ccol]='&gt;';p.ccol+=p.inc;}
prt=true;}else{if(c!='\n'){snew_add(c);if(p.isAltBuf){screen_char(c);}else{if(p.inc){p.line[p.ccol]=c;p.ccol++;}else{html_add(c);}
prt=true;}}
var at_EOL=(p.ccol==p.cols);if(c=='\n'||(at_EOL&&(!p.isAltBuf||(p.isAltBuf&&p.eol_wrap)))){wasScrolledDown=w3_isScrolledDown(el_scroll);if(p.isAltBuf){p.c=1;dirty();p.r++;dirty();if(p.r>p.nrows)p.r=1;}else{var stmp=line_join(1).s;p.el.innerHTML=(stmp=='')?'&nbsp;':stmp;if(dbg)console.log('TEXT-EMIT '+kiwi_JSON(stmp));p.line=[];p.line_sgr=[];p.line_html=[];p.el=appendEmptyLine(parent_el);p.ccol=1;}
if(w3_contains(el_scroll,'w3-scroll-down')&&(!p.scroll_only_at_bottom||(p.scroll_only_at_bottom&&wasScrolledDown)))
w3_scrollDown(el_scroll);}}}else
if(!p.isAltBuf&&c==kiwi.esc_lt){snew_add('<');html_add('<');p.inc=0;}else
if(!p.isAltBuf&&c==kiwi.esc_gt){snew_add('>');html_add('>');p.inc=1;}else
if(p.isAltBuf){if(dbg)console.log('> 0x7f CHAR '+ord(c)+' '+ord(c).toHex(-2));}
if(result){if(dbg)console.log('> '+result);}}
wasScrolledDown=w3_isScrolledDown(el_scroll);if(p.isAltBuf){}else{if(dbg)console.log('TEXT-ACCUM col='+p.ccol+'/'+p.line.length+' '+line_s());if(p.show_cursor){var first_s=line_join(1,p.ccol).s;var second_a=line_join(p.ccol,p.ccol+1).a;var third_s=line_join(p.ccol+1).s;if(second_a.length){stmp=first_s;stmp+=second_a[0].sgr+second_a[0].html+console_cursor(second_a[0].ch);stmp+=third_s;}else{stmp=first_s+console_cursor();}}else{stmp=line_join(1).s;}
p.el.innerHTML=stmp;if(dbg)console.log('TEXT-ACCUM col='+p.ccol+' '+kiwi_JSON(stmp));}
if(w3_contains(el_scroll,'w3-scroll-down')&&(!p.scroll_only_at_bottom||(p.scroll_only_at_bottom&&wasScrolledDown)||p.must_scroll_down)){w3_scrollDown(el_scroll);p.must_scroll_down=false;}
if(p.isAltBuf){sched();}
snew_dump('end');}
function gps_stats_cb(acquiring,tracking,good,fixes,adc_clock,adc_gps_clk_corrections){var s=(acquiring?'yes':'pause')+', track '+tracking+', good '+good+', fixes '+fixes.toUnits();w3_innerHTML('id-msg-gps','GPS: acquire '+s);w3_innerHTML('id-status-gps',w3_text('w3-text-css-orange','GPS'),w3_text('','acq '+s));extint_adc_clock_Hz=adc_clock*1e6;extint_adc_gps_clock_corr=adc_gps_clk_corrections;if(adc_gps_clk_corrections){s=adc_clock.toFixed(6)+' ('+adc_gps_clk_corrections.toUnits()+' avgs)';var el=w3_el('id-msg-gps');if(el)el.innerHTML+=', ADC clock '+s;w3_innerHTML('id-status-adc',w3_text('w3-text-css-orange','ADC clock '),w3_text('',s));}}
function admin_stats_cb(audio_dropped,underruns,seq_errors,dp_resets,dp_hist_cnt,dp_hist,in_hist_cnt,in_hist){if(audio_dropped==undefined)return;var el=w3_el('id-msg-errors');if(el)el.innerHTML='Stats: '+
audio_dropped.toUnits()+' dropped, '+
underruns.toUnits()+' underruns, '+
seq_errors.toUnits()+' sequence, '+
dp_resets.toUnits()+' realtime';el=w3_el('id-status-dp-hist');if(el){var s='Datapump: ';for(var i=0;i<dp_hist_cnt;i++){s+=(i?', ':'')+dp_hist[i].toUnits();}
el.innerHTML=s;}
el=w3_el('id-status-in-hist');if(el){var s='SoundInQ: ';for(var i=0;i<in_hist_cnt;i++){s+=(i?', ':'')+in_hist[i].toUnits();}
el.innerHTML=s;}}
function kiwi_too_busy(rx_chans){var s='Sorry, the KiwiSDR server is too busy right now ('+rx_chans+' users max). <br>'+'There is also a limit on the total number of channel queuers and campers. <br>'+'Please check <a href="http://rx.kiwisdr.com" target="_self">rx.kiwisdr.com</a> for more KiwiSDR receivers available world-wide.';kiwi_show_msg(s);}
function kiwi_exclusive_use(){var s='Sorry, this Kiwi has been locked for special use. <br>'+'This happens when using an extension (e.g. DRM decoder) that requires all available resources. <br>'+'Please check <a href="http://rx.kiwisdr.com" target="_self">rx.kiwisdr.com</a> for more KiwiSDR receivers available world-wide. <br><br>'+'申し訳ありませんが、このキーウィは特別な使用のためにロックされています。 <br>'+'これは、利用可能なすべてのリソースを必要とする拡張機能（DRM デコーダーなど）を使用している場合に発生します。 <br>'+'世界中で利用できる KiwiSDR レシーバーについては、<a href="http://rx.kiwisdr.com" target="_self">rx.kiwisdr.com</a> を確認してください。';kiwi_show_msg(s);}
function kiwi_ip_limit_pwd_cb(pwd){console.log('kiwi_ip_limit_pwd_cb pwd='+pwd);writeCookie('iplimit',encodeURIComponent(pwd));window.location.reload(true);}
function kiwi_show_error_ask_exemption_cb(path,val,first){kiwi_ip_limit_pwd_cb(val);}
function kiwi_show_error_ask_exemption(s){s+='<br><br>If you have an exemption password from the KiwiSDR owner/admin <br> please enter it here: '+
w3_input('w3-retain-input-focus w3-margin-TB-8/w3-label-inline w3-label-not-bold/kiwi-pw|padding:1px|size=40','Password:','id-epwd','','kiwi_show_error_ask_exemption_cb');kiwi_show_msg(s);w3_field_select('id-epwd',{mobile:1});}
function kiwi_inactivity_timeout(mins){var s='Sorry, this KiwiSDR has an inactivity timeout after '+mins+' minutes.<br>Reload the page to continue.';kiwi_show_msg(s);}
function kiwi_24hr_ip_limit(mins,ip){var s='Sorry, this KiwiSDR can only be used for '+mins+' minutes every 24 hours by each IP address.<br>'+'Please check <a href="http://rx.kiwisdr.com" target="_self">rx.kiwisdr.com</a> for more KiwiSDR receivers available world-wide.';kiwi_show_error_ask_exemption(s);}
function kiwi_password_entry_timeout(){var s='Timeout. Please reload page to continue.';kiwi_show_msg(s);}
function kiwi_up(up){if(!seriousError){w3_hide('id-kiwi-msg-container');w3_show_block('id-kiwi-container');w3_el('id-kiwi-body').style.overflow='hidden';}}
function kiwi_down(type,reason){var s;type=+type;if(type==1){s='Sorry, software update in progress. Please check back in a few minutes.<br>'+'Or check <a href="http://rx.kiwisdr.com" target="_self">rx.kiwisdr.com</a> for more KiwiSDR receivers available world-wide.';}else
if(type==2){s="Backup in progress.";}else{if(reason==null||reason==''){reason='Sorry, this KiwiSDR server is being used for development right now. <br>'+'Please check <a href="http://rx.kiwisdr.com" target="_self">rx.kiwisdr.com</a> for more KiwiSDR receivers available world-wide.';}
s=reason;}
kiwi_show_msg(s);}
var stats_interval=10000;var need_config=true;function stats_init(){if(need_config){msg_send('SET GET_CONFIG');need_config=false;}
stats_update();}
function stats_update(){msg_send('SET STATS_UPD ch='+rx_chan);var now=new Date();var aligned_interval=Math.ceil(now/stats_interval)*stats_interval-now;if(aligned_interval<stats_interval/2)aligned_interval+=stats_interval;setTimeout(stats_update,aligned_interval);}
function status_periodic(){w3_innerHTML('id-status-stats-cpu',kiwi_cpu_stats_str);w3_innerHTML('id-status-stats-xfer',kiwi_xfer_stats_str);w3_innerHTML('id-msg-stats-cpu',kiwi_cpu_stats_str_long);w3_innerHTML('id-msg-stats-xfer',kiwi_xfer_stats_str_long);}
var kiwi_xfer_stats_str="";var kiwi_xfer_stats_str_long="";function xfer_stats_cb(audio_kbps,waterfall_kbps,waterfall_fps,http_kbps,sum_kbps){kiwi_xfer_stats_str=w3_text('w3-text-css-orange','Net')+
w3_text('','aud '+audio_kbps.toFixed(0)+', wf '+waterfall_kbps.toFixed(0)+', http '+
http_kbps.toFixed(0)+', total '+sum_kbps.toFixed(0)+' kB/s');kiwi_xfer_stats_str_long='Network (all channels): audio '+audio_kbps.toFixed(0)+' kB/s, waterfall '+waterfall_kbps.toFixed(0)+' kB/s ('+waterfall_fps.toFixed(0)+' fps)'+', http '+http_kbps.toFixed(0)+' kB/s, total '+sum_kbps.toFixed(0)+' kB/s ('+(sum_kbps*8).toFixed(0)+' kb/s)';}
var kiwi_cpu_stats_str='';var kiwi_cpu_stats_str_long='';var kiwi_config_str='';var kiwi_config_str_long='';function cpu_stats_cb(o,uptime_secs,ecpu,waterfall_fps){idle%=100;var cputempC=o.cc?o.cc:0;var cputempF=cputempC*9/5+32;var temp_color=o.cc?((o.cc>=60)?'w3-text-css-red w3-bold':((o.cc>=50)?'w3-text-css-yellow':'w3-text-css-lime')):'';var cputemp=cputempC?(cputempC.toFixed(0)+'&deg;C '+cputempF.toFixed(0)+'&deg;F '):'';var cpufreq=(o.cf>=1000)?((o.cf/1000).toFixed(1)+' GHz'):(o.cf.toFixed(0)+' MHz');var platform=kiwi.platform_s[kiwi.platform];kiwi_cpu_stats_str=w3_text('w3-text-css-orange',platform+' ')+
w3_text('',o.cu[0]+','+o.cs[0]+','+o.ci[0]+' usi% ')+
(cputempC?w3_text(temp_color,cputemp):'')+
w3_text('',cpufreq+' ')+
w3_text('w3-text-css-orange','eCPU')+
w3_text('',ecpu.toFixed(0)+'%');kiwi.wf_fps=waterfall_fps;var user='',sys='',idle='';var first=true;for(var i=0;i<o.cu.length;i++){user+=(first?'':' ')+o.cu[i]+'%';sys+=(first?'':' ')+o.cs[i]+'%';idle+=(first?'':' ')+o.ci[i]+'%';first=false;}
var cpus='cpu';if(o.cu.length>1){cpus+='0';for(var i=1;i<o.cu.length;i++)
cpus+=' cpu'+i;}
kiwi_cpu_stats_str_long=w3_inline('',w3_text('w3-text-black',platform+': '+cpus+' '+user+' usr | '+sys+' sys | '+idle+' idle,'+(cputempC?'':' '))+
(cputempC?('&nbsp;'+w3_text(temp_color+' w3-text-outline w3-large',cputemp)+'&nbsp;'):'')+
w3_text('w3-text-black',cpufreq+', ')+
w3_text('w3-text-black','FPGA eCPU: '+ecpu.toFixed(0)+'%'));var t=uptime_secs;var sec=Math.trunc(t%60);t=Math.trunc(t/60);var min=Math.trunc(t%60);t=Math.trunc(t/60);var hr=Math.trunc(t%24);t=Math.trunc(t/24);var days=t;var s=' up ';if(days)s+=days+'d:';s+=hr+':'+min.leadingZeros(2)+':'+sec.leadingZeros(2);w3_innerHTML('id-status-config',w3_text('w3-text-css-orange','KiwiSDR '+kiwi.model),w3_text('',s+', '+kiwi_config_str));s=' | Uptime: ';if(days)s+=days+' '+((days>1)?'days':'day')+' ';s+=hr+':'+min.leadingZeros(2)+':'+sec.leadingZeros(2);var noLatLon=(server_time_local==''||server_time_tzname=='null');if(server_time_utc)s+=' | UTC: '+server_time_utc;if(isDefined(server_time_tzname)){s+=' | Local: ';if(!noLatLon)s+=server_time_local+' ';s+=noLatLon?'Lat/lon needed for local time':server_tz;}
w3_innerHTML('id-msg-config',kiwi_config_str_long+s);}
function config_str_update(rx_chans,gps_chans,vmaj,vmin){kiwi_config_str='v'+vmaj+'.'+vmin+', ch: '+rx_chans+' SDR '+gps_chans+' GPS';w3_innerHTML('id-status-config',kiwi_config_str);kiwi_config_str_long='KiwiSDR '+kiwi.model+', v'+vmaj+'.'+vmin+', '+rx_chans+' SDR channels, '+gps_chans+' GPS channels';w3_innerHTML('id-msg-config',kiwi_config_str);}
var config_net={};function config_cb(rx_chans,gps_chans,serno,pub,port_ext,pvt,port_int,nm,mac,vmaj,vmin,dmaj,dmin){var s;config_str_update(rx_chans,gps_chans,vmaj,vmin);w3_innerHTML('id-msg-debian','Debian '+dmaj+'.'+dmin);kiwi.debian_maj=dmaj;kiwi.debian_min=dmin;var net_config=w3_el("id-net-config");if(net_config){net_config.innerHTML=w3_div('',w3_col_percent('',w3_div('','Public IP address (outside your firewall/router): '+pub+' [port '+port_ext+']'),50,w3_div('','Ethernet MAC address: '+mac.toUpperCase()),30,w3_div('','KiwiSDR serial number: '+serno),20),w3_col_percent('',w3_div('','Private IP address (inside your firewall/router): '+pvt+' [port '+port_int+']'),50,w3_div('','Private netmask: /'+nm),50));config_net.pub_ip=pub;config_net.pub_port=port_ext;config_net.pvt_ip=pub;config_net.pvt_port=port_int;config_net.mac=mac;config_net.serno=serno;}}
function update_cb(fail_reason,pending,in_progress,rx_chans,gps_chans,vmaj,vmin,pmaj,pmin,build_date,build_time){config_str_update(rx_chans,gps_chans,vmaj,vmin);var msg_update=w3_el("id-msg-update");if(msg_update){var s;s='Installed version: v'+vmaj+'.'+vmin+', built '+build_date+' '+build_time;if(fail_reason){var r;switch(fail_reason){case 1:r='Filesystem is FULL!';break;case 2:r='No Internet connection? (can\'t ping 1.1.1.1 or 8.8.8.8)';break;case 3:r='No connection to github.com?';break;case 4:r='Git clone damaged!';break;case 5:r='Makefile update failed -- check /root/build.log file';break;case 6:r='Build failed, check /root/build.log file';break;default:r='Unknown reason, code='+fail_reason;break;}
s+='<br>'+r;w3_hide('id-build-restart');w3_hide('id-build-reboot');}else
if(in_progress){s+='<br>Update to version v'+ +pmaj+'.'+pmin+' in progress';}else
if(pending){s+='<br>Update check pending';}else
if(pmaj==-1){s+='<br>Error determining the latest version -- check log';}else{if(vmaj==pmaj&&vmin==pmin)
s+='<br>Running most current version';else
s+='<br>Available version: v'+pmaj+'.'+pmin;}
msg_update.innerHTML=s;}}
var users_interval=2500;var user_init=false;function users_init(called_from){kiwi.called_from_admin=called_from.admin;kiwi.called_from_user=called_from.user;kiwi.called_from_monitor=called_from.monitor;if(kiwi.called_from_admin||kiwi.called_from_monitor){var id_prefix=kiwi.called_from_admin?'id-admin-user-':'id-monitor-user-';var pad=kiwi.called_from_monitor?' w3-padding-LR-2':'';var s1='',s2;for(var i=0;i<rx_chans;i++){if(kiwi.called_from_admin){s1=w3_button('id-user-kick-'+i+' w3-hide w3-small w3-white w3-border w3-border-red w3-round-large w3-padding-0 w3-padding-LR-8','Kick','status_user_kick_cb',i);}
s2=w3_div('id-campers-'+i+' w3-css-orange w3-padding-LR-4');w3_el('id-users-list').innerHTML+=w3_inline('/w3-hspace-8',w3_div('id-user-'+i+pad,'RX'+i),w3_div(id_prefix+i),s1,s2);}}
users_update();w3_call('users_setup');user_init=true;}
function users_update(){msg_send('SET GET_USERS');setTimeout(users_update,users_interval);}
function user_cb(obj){var id_prefix=kiwi.called_from_admin?'id-admin-user-':'id-monitor-user-';var host=kiwi_url_origin();obj.forEach(function(obj){var s1='',s2='',s3='';var i=obj.i;var name=obj.n;var freq=obj.f;var geoloc=obj.g;var ip=(isDefined(obj.a)&&obj.a!='')?(obj.a+', '):'';var mode=obj.m;var zoom=obj.z;var connected=obj.t;var remaining='';if(obj.rt){var t=(obj.rt==1)?' act':' 24h';remaining=' '+w3_text('w3-text-css-orange|vertical-align:bottom',obj.rs+t);}
var ext=obj.e;if(isDefined(name)){var okay=false;var deco;do{try{deco=decodeURIComponent(name);okay=true;}catch(ex){name=name.slice(0,-1);}}while(!okay);var id=kiwi_strip_tags(deco,'');if(!kiwi.called_from_admin&&id=='')id='(no identity)';if(id!='')id='"'+id+'"';var g=(geoloc=='(null)'||geoloc=='')?(kiwi.called_from_admin?'unknown location':''):decodeURIComponent(geoloc);ip=ip.replace(/::ffff:/,'');g=(ip!=''||g!='')?('('+ip+g+')'):'';var f=freq+kiwi.freq_offset_Hz;var f=(f/1000).toFixed((f>100e6)?1:2);var f_s=f+' kHz ';var fo=(freq/1000).toFixed(2);var link,target;if(kiwi.called_from_admin){link=host+'/?f='+fo+mode+'z'+zoom;target=' target="_blank"';}else{link='javascript:'+(kiwi.called_from_user?('tune('+fo+','+sq(mode)+','+zoom+')'):('camp('+i+')'));target='';}
if(ext!='')ext=decodeURIComponent(ext)+' ';s1=w3_sb(id,g)+' ';s2=w3_link('w3-link-darker-color',link,f_s+(obj.wf?'WF':mode)+' z'+zoom)+' '+ext+connected+remaining;}
if(user_init){if(kiwi.called_from_user){w3_innerHTML('id-optbar-user-'+i,(s1!='')?(s1+'<br>'+s2):'');}else{w3_innerHTML(id_prefix+i,s1+s2+s3);w3_hide2('id-user-kick-'+i,s1=='');w3_hide2('id-user-bl32-'+i,s1=='');w3_hide2('id-user-bl24-'+i,s1=='');}}
if(i==rx_chan&&isDefined(obj.c)){var el=w3_el('id-sam-carrier');if(el)w3_innerHTML(el,'carrier '+obj.c.toFixed(1)+' Hz');}
w3_innerHTML('id-campers-'+i,obj.ca?(obj.ca+plural(obj.ca,' camper')):'');if(i==rx_chan&&obj.rn){if(obj.rn<=55&&!kiwi.inactivity_panel){var s=(obj.rt==1)?'Inactivity timeout in one minute.<br>Close this panel to avoid disconnection.':'Per 24-hour connection timeout in one minute.';confirmation_show_content(s,360,55,function(){msg_send('SET inactivity_ack');confirmation_panel_close();kiwi.inactivity_panel=false;},'red');kiwi.inactivity_panel=true;}}
if(i==rx_chan&&obj.rn>55&&kiwi.inactivity_panel){confirmation_panel_close();kiwi.inactivity_panel=false;}
if(i==rx_chan&&isNumber(obj.fo)&&obj.fo!=kiwi.freq_offset_kHz&&!confirmation.displayed){var s=w3_div('','Frequency scale offset changed. Page must be reloaded.',w3_inline('w3-halign-space-around/',w3_button('w3-margin-T-16 w3-aqua','OK','freq_offset_page_reload')));confirmation_show_content(s,425,100);}
if(i==rx_chan&&isNumber(obj.nc)&&obj.nc!=rx_chan&&isNumber(obj.ns)&&obj.ns!=kiwi.notify_seq){console.log('$ NOTIFY sn='+obj.ns);msg_send('SET notify_msg');kiwi.notify_seq=obj.ns;}});}
function freq_offset_page_reload(){window.location.reload(true);}
var toggle_e={SET:1,SET_URL:2,FROM_COOKIE:4,WRITE_COOKIE:8,NO_CLOSE_EXT:16};function kiwi_toggle(flags,val_set,val_default,cookie_id){var rv=null;if(flags&toggle_e.SET_URL&&(val_set!=null||val_set!=undefined)){rv=val_set;}else
if(flags&toggle_e.FROM_COOKIE){rv=readCookie(cookie_id);if(rv!=null){var rv_num=parseFloat(rv);if(!isNaN(rv_num))rv=rv_num;}}
if(rv==null){if(flags&toggle_e.SET){rv=val_set;}}
if(rv==null){rv=val_default;}
return rv;}
function kiwi_fft_mode(){if(0){toggle_or_set_spec(toggle_e.SET,spec.RF);setmaxdb(10);}else{setmaxdb(-30);}}
function kiwi_mapPinSymbol(fillColor,strokeColor){fillColor=fillColor||'red';strokeColor=strokeColor||'white';return{path:'M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z',fillColor:fillColor,fillOpacity:1,strokeColor:strokeColor,strokeWeight:1,scale:1,};}
function isAdmin(){return(Object.keys(adm).length!=0);}
function kiwi_force_admin_close_cb(path,val,first){if(first)return;val=+val;ext_send('SET close_admin_force');confirmation_panel_close();kiwi.no_admin_conns_pend=0;if(val){setTimeout(function(){dx_send_update_retry();},1000);}else{setTimeout(function(){cfg_save_json('kiwi_force_admin_close_cb','adm');},1000);}}
function kiwi_set_freq_offset(freq_offset_kHz){kiwi.isOffset=(freq_offset_kHz!=0);kiwi.freq_offset_kHz=freq_offset_kHz;kiwi.freq_offset_Hz=freq_offset_kHz*1000;kiwi.offset_frac=(freq_offset_kHz%1000)*1000;}
function kiwi_init_cfg(stream_name){kiwi_set_freq_offset(cfg.freq_offset);var page_title=kiwi_decodeURIComponent('PAGE_TITLE',cfg.index_html_params.PAGE_TITLE);if(page_title=='')page_title='KiwiSDR';var el=w3_el('id-page-title');if(el)el.innerHTML=((stream_name=='admin')?'Admin ':'')+page_title;w3_innerHTML('id-rx-photo-title',kiwi_decodeURIComponent('RX_PHOTO_TITLE',cfg.index_html_params.RX_PHOTO_TITLE));w3_innerHTML('id-rx-photo-desc',kiwi_decodeURIComponent('RX_PHOTO_DESC',cfg.index_html_params.RX_PHOTO_DESC));w3_innerHTML('id-rx-title',kiwi_decodeURIComponent('RX_TITLE',cfg.index_html_params.RX_TITLE));w3_innerHTML('id-owner-info',kiwi_decodeURIComponent('owner_info',cfg.owner_info));}
var reason_disabled='';var version_maj=-1,version_min=-1,debian_ver=-1;var tflags={INACTIVITY:1,WF_SM_CAL:2,WF_SM_CAL2:4};var chan_no_pwd,chan_no_pwd_true;var kiwi_output_msg_p={scroll_only_at_bottom:true,inline_returns:true,process_return_alone:false,remove_returns:false};var client_public_ip;function kiwi_msg(param,ws){var rtn=true;switch(param[0]){case"version_maj":version_maj=parseInt(param[1]);break;case"version_min":version_min=parseInt(param[1]);break;case"debian_ver":debian_ver=parseInt(param[1]);break;case"model":kiwi.model=parseInt(param[1]);break;case"platform":kiwi.platform=parseInt(param[1]);break;case"ext_clk":kiwi.ext_clk=parseInt(param[1]);break;case"client_public_ip":client_public_ip=param[1].replace(/::ffff:/,'');console.log('client public IP: '+client_public_ip);break;case"badp":extint_valpwd_cb(parseInt(param[1]));break;case"chan_no_pwd":chan_no_pwd=parseInt(param[1]);break;case"chan_no_pwd_true":chan_no_pwd_true=parseInt(param[1]);break;case"rx_chans":rx_chans=parseInt(param[1]);break;case"wf_chans":wf_chans=parseInt(param[1]);break;case"wf_chans_real":wf_chans_real=parseInt(param[1]);break;case"rx_chan":rx_chan=parseInt(param[1]);break;case"max_camp":max_camp=parseInt(param[1]);break;case"load_cfg":var cfg_json=decodeURIComponent(param[1]);console.log('### load_cfg '+ws.stream+' '+cfg_json.length);cfg=kiwi_JSON_parse('load_cfg',cfg_json);kiwi_init_cfg(ws.stream);break;case"load_dxcfg":var dxcfg_json=decodeURIComponent(param[1]);console.log('### load_dxcfg '+ws.stream+' '+dxcfg_json.length);dxcfg=kiwi_JSON_parse('load_dxcfg',dxcfg_json,function(ex){dx.dxcfg_parse_error=ex;});if(dx.dxcfg_parse_error){dxcfg={};dxcfg.dx_type=[];for(var i=0;i<16;i++){dxcfg.dx_type.push({key:i,name:'type-'+i,color:'white'});}
dxcfg.band_svc=[];dxcfg.bands=[];console.log(dxcfg);}
break;case"load_dxcomm_cfg":var dxcomm_cfg_json=decodeURIComponent(param[1]);console.log('### load_dxcomm_cfg '+ws.stream+' '+dxcomm_cfg_json.length);dxcomm_cfg=kiwi_JSON_parse('load_dxcomm_cfg',dxcomm_cfg_json,function(ex){dx.dxcomm_cfg_parse_error=ex;});if(dx.dxcomm_cfg_parse_error){dxcomm_cfg={};dxcomm_cfg.dx_type=[];for(var i=0;i<16;i++){dxcomm_cfg.dx_type.push({key:i,name:'type-'+i,color:'white'});}
dxcomm_cfg.band_svc=[];dxcomm_cfg.bands=[];console.log(dxcomm_cfg);}
break;case"load_adm":var adm_json=decodeURIComponent(param[1]);console.log('### load_adm '+ws.stream+' '+adm_json.length);adm=kiwi_JSON_parse('load_adm',adm_json);break;case"cfg_loaded":console.log('### cfg_loaded');owrx_init_cfg();break;case"no_admin_conns":var retry_dx_update=parseInt(param[1]);kiwi.no_admin_conns_pend++;if(kiwi.no_admin_conns_pend==1){confirmation_panel_close();confirmation_show_content('Must close admin connection before attempting this operation.'+
w3_button('w3-small w3-padding-smaller w3-yellow w3-margin-T-8','Close admin connection and complete original operation','kiwi_force_admin_close_cb',retry_dx_update),500,75,function(){confirmation_panel_close();kiwi.no_admin_conns_pend=0;},'red');}
break;case"foff_error":kiwi.foff_error_pend++;if(kiwi.foff_error_pend==1){setTimeout(function(){confirmation_panel_close();confirmation_show_content((+param[1]==0)?'"foff=" URL parameter available from local connections only.':'Must close admin connection before using "foff=" URL parameter.',500,55,function(){confirmation_panel_close();kiwi.foff_error_pend=0;},'red');},5000);}
break;case"request_dx_update":if(isAdmin()){if(dx.ignore_dx_update){dx.ignore_dx_update=false;}else{dx_update_admin();}}else{dx_update_request();}
break;case"mkr":var mkr=param[1];var obj=kiwi_JSON_parse('mkr',mkr);if(obj)dx_label_render_cb(obj);break;case"user_cb":var obj=kiwi_JSON_parse('user_cb',param[1]);if(obj)user_cb(obj);break;case"config_cb":var o=kiwi_JSON_parse('config_cb',param[1]);if(o)config_cb(o.r,o.g,o.s,o.pu,o.pe,o.pv,o.pi,o.n,o.m,o.v1,o.v2,o.d1,o.d2);break;case"update_cb":var o=kiwi_JSON_parse('update_cb',param[1]);if(o)update_cb(o.f,o.p,o.i,o.r,o.g,o.v1,o.v2,o.p1,o.p2,decodeURIComponent(o.d),decodeURIComponent(o.t));break;case"stats_cb":var o=kiwi_JSON_parse('stats_cb',param[1]);if(o){if(o.ce!=undefined)
cpu_stats_cb(o,o.ct,o.ce,o.fc);xfer_stats_cb(o.ac,o.wc,o.fc,o.ah,o.as);extint.srate=o.sr;extint.nom_srate=o.nsr;gps_stats_cb(o.ga,o.gt,o.gg,o.gf,o.gc,o.go);if(o.gr){kiwi.WSPR_rgrid=decodeURIComponent(o.gr);kiwi.GPS_fixes=o.gf;}
if(o.sh==-1){w3_innerHTML('id-rx-snr',', SNR ',o.sa,' dB');w3_innerHTML('id-msg-snr','SNR: All ',o.sa,' dB');}else{w3_innerHTML('id-rx-snr',', SNR ',o.sa,':',o.sh,' dB');w3_innerHTML('id-msg-snr','SNR: All ',o.sa,' dB, HF ',o.sh,' dB');}
admin_stats_cb(o.ad,o.au,o.ae,o.ar,o.an,o.ap,o.an2,o.ai);w3_call('config_status_cb',o);time_display_cb(o);}
break;case"status_msg_text":kiwi_output_msg_p.s=param[1];kiwi_output_msg('id-output-msg','id-output-msg',kiwi_output_msg_p);break;case"status_msg_html":var s=kiwi_decodeURIComponent('status_msg_html',param[1]);w3_innerHTML('id-status-msg',s);w3_innerHTML('id-msg-status',s);break;case"is_admin":extint.isAdmin_cb(param[1]);break;case"is_local":var p=param[1].split(',');console.log('kiwi_msg rx_chan='+p[0]+' is_local='+p[1]);kiwi.is_local[+p[0]]=+p[1];break;case"no_reopen_retry":kiwi.no_reopen_retry=true;break;case"is_multi_core":kiwi.is_multi_core=1;break;case"authkey_cb":extint_authkey_cb(param[1]);break;case"down":kiwi_down(param[1],reason_disabled);break;case"too_busy":kiwi_too_busy(parseInt(param[1]));break;case"monitor":kiwi_monitor();break;case"exclusive_use":kiwi_exclusive_use();break;case"inactivity_timeout":kiwi_inactivity_timeout(param[1]);break;case"ip_limit":var p=decodeURIComponent(param[1]).split(',');kiwi_24hr_ip_limit(parseInt(p[0]),p[1]);break;case"password_timeout":kiwi_password_entry_timeout();break;case"reason_disabled":reason_disabled='User connections disabled.'+
((param[1]!='')?(' Reason: '+kiwi_decodeURIComponent('reason_disabled',param[1])):'');break;case"sample_rate":extint.srate=parseFloat(param[1]);break;case'pref_import_ch':kiwi.prefs_import_ch=+param[1];break;case'pref_import':prefs_import_cb(param[1],kiwi.prefs_import_ch);break;case'adc_clk_nom':extint_adc_clock_nom_Hz=+param[1];break;case'notify_msg':var s=kiwi_decodeURIComponent('notify_msg',param[1]);console.log('notify_msg: '+s);if(confirmation.displayed)break;s=w3_div('',s);confirmation_show_content(s,425,50);setTimeout(confirmation_panel_close,3000);break;case'kiwi_kick':var s=param[1]+((cfg.reason_kicked!='')?('<br>Reason: '+cfg.reason_kicked):'');s=kiwi_decodeURIComponent('kiwi_kick',s);if(confirmation.displayed)break;s=w3_div('',s);confirmation_show_content(s,425,75,null,'red');break;default:rtn=false;break;}
return rtn;}
function kiwi_debug(msg,syslog){console.log(msg);msg_send('SET '+(syslog?'dbug_msg=':'x-DEBUG=')+encodeURIComponent(msg));}
function kiwi_show_msg(s){if(!w3_innerHTML('id-kiwi-msg',s))return;if(s==''){w3_hide('id-kiwi-msg-container');w3_el('id-kiwi-body').style.overflow='hidden';}else{w3_hide('id-kiwi-container');w3_show_block('id-kiwi-msg-container');w3_el('id-kiwi-body').style.overflow='scroll';}}
function kiwi_server_error(s){kiwi_show_msg('Hmm, there seems to be a problem. <br>'+'The server reported the error: <span style="color:red">'+s+'</span>');seriousError=true;}
function kiwi_serious_error(s){kiwi_show_msg(s);seriousError=true;console.log(s);}
function kiwi_trace(msg){if(msg)console.log('kiwi_trace: '+msg);try{console.trace();}catch(ex){}}
function kiwi_trace_mobile(msg){alert(msg+' '+Error().stack);}





/* web/kiwi/kiwi_ui.min.js (web/kiwi/kiwi_ui.js = Mon Dec 11 10:06:48 2023) */
function dx_get_value(v){return w3_get_value('dx.o.'+v+'_'+dx.o.gid);}
function dx_update_check(idx,upd,isPassband){var user=(idx==dx.IDX_USER);if(!user)dx.o.gid=idx=+idx;var dx_mode_idx,mode_menu_idx,mode_s;if(user){mode_menu_idx=+dx.o.mm;mode_s=kiwi.mode_menu[mode_menu_idx];dx_mode_idx=w3_array_el_seq(kiwi.modes_uc,mode_s);console.log('dx_update_check USER dx_mode_idx='+dx_mode_idx+' mode_menu_idx='+mode_menu_idx+' '+mode_s);}else{mode_menu_idx=+dx_get_value('mm');mode_s=kiwi.mode_menu[mode_menu_idx];dx_mode_idx=w3_array_el_seq(kiwi.modes_uc,mode_s);console.log('dx_update_check ADMIN dx_mode_idx='+dx_mode_idx+' mode_menu_idx='+mode_menu_idx+' '+mode_s);}
dx.o.fm=+dx_mode_idx;if(idx==dx.IDX_USER)return true;console.log('### dx_update_check gid(idx)='+idx+' '+((upd==dx.UPD_ADD)?'ADD':'MODIFY'));dx.o.fr=+dx_get_value('fr');dx.o.ft=+dx_get_value('ft');dx.o.fd=dx.o.last_fd[idx];dx.o.b=+dx_get_value('b');dx.o.e=+dx_get_value('e');dx.o.o=+dx_get_value('o');dx.o.s=+dx_get_value('s');dx.o.i=dx_get_value('i');dx.o.n=dx_get_value('n');dx.o.p=dx_get_value('p');if(!isPassband){if(idx>=0&&dx.o.last_pb[idx]){dx.o.lo=dx.o.last_pb[idx][0];dx.o.hi=dx.o.last_pb[idx][1];}else{dx.o.lo=dx.o.hi=0;}}
var flags=(dx.o.fd<<dx.DX_DOW_SFT)|(dx.o.ft<<dx.DX_TYPE_SFT)|dx_encode_mode(dx.o.fm);if(dx.o.fr<0)dx.o.fr=0;if(upd==dx.UPD_ADD)
dx.o.gid=-1;else
dx.ignore_dx_update=true;console.log('dx.o:');console.log(dx.o);var begin=+(dx.o.b),end=+(dx.o.e);if(begin==0&&end==0)end=2400;console.log('SET DX_UPD g='+dx.o.gid+' f='+dx.o.fr+' lo='+dx.o.lo+' hi='+dx.o.hi+' o='+dx.o.o.toFixed(0)+' s='+dx.o.s.toFixed(0)+' fl='+flags+'(dow='+dx.o.fd+'|ty='+dx.o.ft+'|mo='+dx.o.fm+') b='+begin+' e='+end+' i='+dx.o.i+' n='+dx.o.n+' p='+dx.o.p);ext_send('SET DX_UPD g='+dx.o.gid+' f='+dx.o.fr+' lo='+dx.o.lo.toFixed(0)+' hi='+dx.o.hi.toFixed(0)+' o='+dx.o.o.toFixed(0)+' s='+dx.o.s.toFixed(0)+' fl='+flags+' b='+begin+' e='+end+' i='+encodeURIComponent(dx.o.i+'x')+' n='+encodeURIComponent(dx.o.n+'x')+' p='+encodeURIComponent(dx.o.p+'x'));w3_call('dx_sched_save','id-dx-list-saved',1000);return false;}
function dx_num_cb(path,val,first){if(first)return;var o=w3_remove_trailing_index(path,'_');console.log('dx_num_cb path='+path+' val='+val+' o.idx='+o.idx);w3_num_cb(o.el,val);if(dx_update_check(o.idx,dx.UPD_MOD))dx_button_highlight();}
function dx_freq_cb(path,val,first){if(first)return;var o=w3_remove_trailing_index(path,'_');val=val.parseFloatWithUnits('kM',1e-3);console.log('dx_num_cb path='+path+' val='+val+' o.idx='+o.idx);w3_set_value(path,val);w3_num_cb(o.el,val);if(dx_update_check(o.idx,dx.UPD_MOD))dx_button_highlight();if(o.idx!=dx.IDX_USER){dx_update_admin();ext_send('SET MARKER search_freq='+val);}}
function dx_sel_cb(path,val,first){if(first)return;var o=w3_remove_trailing_index(path,'_');console.log('dx_sel_cb path='+path+' val='+val+' o.idx='+o.idx);w3_num_cb(o.el,+val);if(dx_update_check(o.idx,dx.UPD_MOD))dx_button_highlight();}
function dx_string_cb(path,val,first){if(first)return;var o=w3_remove_trailing_index(path,'_');console.log('dx_string_cb path='+path+' val='+val+' o.idx='+o.idx);w3_string_cb(o.el,val);if(dx_update_check(o.idx,dx.UPD_MOD))dx_button_highlight();}
function dx_dow_button(path,day_i){var o=w3_remove_trailing_index(path,'_');console.log('dx_dow_button path='+path+' o.idx='+o.idx);var user=(o.idx==dx.IDX_USER);var dow_b=1<<(6-(+day_i));var dow=user?dx.o.fd:dx.o.last_fd[o.idx];var before=dow;dow^=dow_b;if(user)
dx.o.fd=dow;else
dx.o.last_fd[o.idx]=dow;var sel=dow&dow_b;console.log('dx_dow_button day_i='+day_i+' dow_b='+dow_b.toHex(2)+' sel='+sel.toHex(2)+' before='+before.toHex(2)+' after='+dow.toHex(2)+' o.idx='+o.idx);w3_color(path,sel?'black':'white',sel?dx.dow_colors[day_i]:'darkGrey');if(dx_update_check(o.idx,dx.UPD_MOD))dx_button_highlight();}
function dx_sched_time_cb(path,val,first){val=(+val).toFixed(0).leadingZeros(4);dx_string_cb(path,val,first);w3_set_value(path,val);var o=w3_remove_trailing_index(path,'_');if(o.idx==dx.IDX_USER)dx_button_highlight();}
function dx_passband_cb(path,val,first){if(first)return;var a=val.split(/[,\s]/);var len=a.length;console.log('dx_passband_cb path='+path+' val='+val+' a.len='+len);console.log(a);if(len==1&&a[0]!=''){var hbw=Math.round(a[0].parseFloatWithUnits('kM')/ 2);dx.o.lo=-hbw;dx.o.hi=hbw;}else
if(len>=1&&a[0]!=''&&a[len-1]!=''){dx.o.lo=Math.round(a[0].parseFloatWithUnits('kM'));dx.o.hi=Math.round(a[len-1].parseFloatWithUnits('kM'));}else{dx.o.lo=dx.o.hi=0;}
var o=w3_remove_trailing_index(path,'_');dx.o.last_pb[o.idx]=[dx.o.lo,dx.o.hi];console.log('dx_passband_cb lo='+dx.o.lo+' hi='+dx.o.hi+' o.idx='+o.idx);if(dx_update_check(o.idx,dx.UPD_MOD,true))dx_button_highlight();}
function sd_backup_init(){kiwi.backup_size=kiwi.backup_progress=null;kiwi.sd_backup_icon=w3_icon('','fa-refresh fa-spin',20);}
function sd_backup_focus(){var re_rootfs_size=new RegExp('^rootfs_size ([0-9]*)M');var re_progress=new RegExp('^\\s*([0-9.]*)([MG])\\s*([0-9]*%).*$');kiwi_output_msg_p.intercept=function(s){s=s.replace(/\r/g,' ');s=s.replace(/\n/g,' ');var e=re_rootfs_size.exec(s);if(e&&e.length>=2){kiwi.backup_size=+e[1];if(e[2]=='G')kiwi.backup_size*=1024;console.log('backup_size='+kiwi.backup_size);}
e=re_progress.exec(s);if(e&&e.length>=3){kiwi.backup_progress=+e[1];if(e[2]=='G')kiwi.backup_progress*=1024;}};w3_do_when_cond(function(){return isNumber(kiwi.debian_maj);},function(){var ng_D11=(!dbgUs&&kiwi.debian_maj==11);var ng_D12=(kiwi.debian_maj>12||(kiwi.debian_maj==12&&kiwi.debian_min>2));if(ng_D11||ng_D12){w3_innerHTML('id-sd-backup-container',w3_div('w3-container w3-text w3-red','Debian '+kiwi.debian_maj+'.'+kiwi.debian_min+' does not yet support the backup function.'));}
w3_show('id-sd-backup-container','w3-show-inline');},null,250);}
function sd_backup_blur(){kiwi_output_msg_p.intercept=null;}
function sd_backup_click_cb(id,idx){console.log('sd_backup_click_cb debian_maj='+kiwi.debian_maj);if(!dbgUs&&kiwi.debian_maj>=11){w3_innerHTML('id-sd-backup-msg','SD write not supported yet');return;}
kiwi.backup_size=null;w3_innerHTML('id-sd-backup-msg','formatting micro-SD card');w3_color('id-sd-backup-msg','');w3_innerHTML('id-sd-progress-text','');w3_el('id-sd-progress').style.width='0%';kiwi.sd_progress=-1;kiwi.sd_interval=kiwi_setInterval(sd_backup_progress,1000);w3_innerHTML('id-sd-backup-icon',kiwi.sd_backup_icon);ext_send("SET microSD_write");}
function sd_backup_progress(){if(kiwi.backup_size&&kiwi.backup_progress){if(kiwi.backup_size==1){w3_el('id-sd-progress-text').innerHTML=w3_el('id-sd-progress').style.width='100%';w3_innerHTML('id-sd-backup-msg','finalizing micro-SD card');}else{var pct=((kiwi.backup_progress / kiwi.backup_size)*100).toFixed(0);if(pct==0)pct=1;if(pct<=99){w3_el('id-sd-progress-text').innerHTML=w3_el('id-sd-progress').style.width=pct+'%';}
w3_innerHTML('id-sd-backup-msg','copied '+kiwi.backup_progress.toFixed(0)+' of '+kiwi.backup_size.toFixed(0)+' MB');}}else{w3_innerHTML('id-sd-backup-msg','formatting micro-SD card');}
kiwi.sd_progress++;var secs=(kiwi.sd_progress%60).toFixed(0).leadingZeros(2);var mins=Math.floor(kiwi.sd_progress / 60).toFixed(0);w3_innerHTML('id-sd-backup-time',mins+':'+secs);}
function sd_backup_write_done(err){var msg='backup complete';var e;switch(err){case 0:e=null;break;case 1:e='no SD card inserted?';break;case 15:e='SD card I/O error';break;case 30:e='SD card already mounted?';break;case 31:e='SD card format error';break;case 88:e='(BBAI-64) must first update to latest Debian version';break;case 89:e='SD card flasher enable failed!';break;default:e='code '+err;break;}
if(e)msg='<b>ERROR: '+e+'</b>';if(!err){w3_el('id-sd-progress-text').innerHTML=w3_el('id-sd-progress').style.width='100%';}
kiwi_clearInterval(kiwi.sd_interval);w3_innerHTML('id-sd-backup-icon','');w3_innerHTML('id-sd-backup-msg',msg);w3_color('id-sd-backup-msg','red',null,err);}





/* web/kiwi/kiwi_util.min.js (web/kiwi/kiwi_util.js = Thu Dec 14 14:28:14 2023) */
function isUndefined(v){return(typeof(v)==='undefined');}
function isDefined(v){return(typeof(v)!=='undefined');}
function isNull(v){return(v===null);}
function isNumber(v){return(typeof(v)==='number'&&!isNaN(v));}
function isBoolean(v){return(typeof(v)==='boolean');}
function isString(v){return(typeof(v)==='string');}
function isNonEmptyString(v){return(isString(v)&&v!=='');}
function isArray(v){return(Array.isArray(v));}
function isNonEmptyArray(v){return(isArray(v)&&v.length>0);}
function isFunction(v){return(typeof(v)==='function');}
function isObject(v){return(typeof(v)==='object');}
function isArg(v){return(isUndefined(v)||isNull(v))?false:true;}
function isNoArg(v){return(isUndefined(v)||isNull(v))?true:false;}
function kiwi_typeof(v){return isNull(v)?'null':(isArray(v)?'array':typeof(v));}
function ifString(s,alt){return(isString(s)?s:alt);}
try{if(!String.prototype.includes){String.prototype.includes=function(str){return(this.indexOf(str)>=0);}}}catch(ex){console.log("kiwi_util: String.prototype.includes");}
try{if(!String.prototype.startsWith){String.prototype.startsWith=function(str){return this.indexOf(str)==0;}}}catch(ex){console.log("kiwi_util: String.prototype.startsWith");}
try{if(!String.prototype.endsWith){String.prototype.endsWith=function(search,this_len){if(this_len===undefined||this_len>this.length){this_len=this.length;}
return this.substring(this_len-search.length,this_len)===search;};}}catch(ex){console.log("kiwi_util: String.prototype.endsWith");}
var kiwi_util={};var kiwi_iOS,kiwi_iPhone,kiwi_MacOS,kiwi_linux,kiwi_Windows,kiwi_android;var kiwi_safari,kiwi_firefox,kiwi_chrome,kiwi_opera,kiwi_smartTV;document.onreadystatechange=function(){if(document.readyState=="complete"){var website=false;var el=w3_el('id-kiwi-container');if(el&&el.getAttribute('data-type')=='website')website=true;var s=navigator.userAgent;if(!website)console.log(s);kiwi_iOS=(s.includes('iPhone')||s.includes('iPad'));kiwi_iPhone=s.includes('iPhone');kiwi_MacOS=s.includes('OS X');kiwi_linux=s.includes('Linux');kiwi_Windows=s.includes('Win');kiwi_android=s.includes('Android');kiwi_safari=/safari\/([0-9]+)/i.exec(s);kiwi_browserVersion=/version\/([0-9]+)/i.exec(s);kiwi_firefox=/firefox\/([0-9]+)/i.exec(s);kiwi_chrome=/chrome\/([0-9]+)/i.exec(s);kiwi_opera=/opera\/([0-9]+)/i.exec(s);if(!kiwi_opera)kiwi_opera=/OPR\/([0-9]+)/i.exec(s);kiwi_smartTV=s.includes('SmartTV');if(!kiwi_smartTV)kiwi_smartTV=s.includes('SMART-TV');if(kiwi_smartTV){if(s.includes('Samsung'))kiwi_smartTV='Samsung';else
if(s.includes('LG'))kiwi_smartTV='LG';}
if(!website)console.log('MacOS='+kiwi_MacOS+' Linux='+kiwi_linux+' Windows='+kiwi_Windows+' iOS='+kiwi_iOS+' iPhone='+kiwi_iPhone+' Android='+kiwi_android+' SmartTV='+kiwi_smartTV);if(kiwi_opera){kiwi_chrome=kiwi_safari=null;}else
if(kiwi_chrome){kiwi_safari=null;}else
if(kiwi_safari){if(kiwi_browserVersion)kiwi_safari[1]=kiwi_browserVersion[1];}
if(!website)console.log('Safari='+kiwi_isSafari()+' Firefox='+kiwi_isFirefox()+' Chrome='+kiwi_isChrome()+' Opera='+kiwi_isOpera());if(!website){kiwi_load_js_dir('pkgs/js/',['sprintf/sprintf.js','SHA256.js'],function(){kiwi_load2();});}else{kiwi_load2();}}}
function kiwi_load2(){if(typeof(kiwi_check_js_version)!=='undefined'){kiwi_ajax("/VER",'kiwi_version_cb');}else{kiwi.conn_tstamp=(new Date()).getTime();if(typeof(kiwi_bodyonload)!=='undefined')
kiwi_bodyonload('');}}
function kiwi_is_iOS(){return kiwi_iOS;}
function kiwi_is_iPhone(){return kiwi_iPhone;}
function kiwi_isMacOS(){return kiwi_MacOS;}
function kiwi_isWindows(){return kiwi_Windows;}
function kiwi_isLinux(){return kiwi_linux;}
function kiwi_isAndroid(){return kiwi_android;}
function kiwi_isSmartTV(){return kiwi_smartTV;}
function kiwi_isMobile(){return(force_mobile||kiwi_is_iOS()||kiwi_isAndroid()||(kiwi_isSmartTV()=='Samsung')||mobile_laptop_test);}
function kiwi_isSafari(){return(kiwi_safari?kiwi_safari[1]:NaN);}
function kiwi_isFirefox(){return(kiwi_firefox?kiwi_firefox[1]:NaN);}
function kiwi_isChrome(){return(kiwi_chrome?kiwi_chrome[1]:NaN);}
function kiwi_isOpera(){return(kiwi_opera?kiwi_opera[1]:NaN);}
var kiwi_version_fail=false;function kiwi_version_cb(response_obj){version_maj=response_obj.maj;version_min=response_obj.min;var s='';kiwi_check_js_version.forEach(function(el){if(el.VERSION_MAJ!=version_maj||el.VERSION_MIN!=version_min){if(kiwi_version_fail==false){s='Your browser is trying to use incorrect versions of the KiwiSDR Javascript files.<br>'+'Please clear your browser cache and try again.<br>'+'Or click the button below to continue anyway.<br><br>'+'v'+version_maj+'.'+version_min+': KiwiSDR server<br>';kiwi_version_fail=true;}
s+='v'+el.VERSION_MAJ+'.'+el.VERSION_MIN+': '+el.file+'<br>';}});if(kiwi_version_fail)
s+='<br>'+w3_button('w3-css-yellow','Continue anyway','kiwi_version_continue_cb');kiwi.conn_tstamp=isDefined(response_obj.ts)?response_obj.ts:(new Date()).getTime();kiwi_bodyonload(s);}
function kiwi_version_continue_cb(){seriousError=false;kiwi_bodyonload('');}
function ord(c,base){if(isString(base))
return c.charCodeAt(0)-base.charCodeAt(0);else
return c.charCodeAt(0);}
function chr(i){return String.fromCharCode(i);}
function sq(s){return'\''+s+'\'';}
function dq(s){return'\"'+s+'\"';}
function dqc(s){return'"'+s+'":';}
function paren(s){return'('+s+')';}
function plural(num,word){if(num==1)return word;else return word+'s';}
function arrayBufferToString(buf){var s;try{if(0){s=String.fromCharCode.apply(null,new Uint8Array(buf));}else{var u8buf=new Uint8Array(buf);s='';for(var i=0;i<u8buf.length;i++)s+=String.fromCharCode(u8buf[i]);}}catch(ex){console.log(buf);console.log(ex);kiwi_trace('arrayBufferToString');s=null;}
return s;}
function arrayBufferToStringLen(buf,len){var u8buf=new Uint8Array(buf);var output=String();len=Math.min(len,u8buf.length);for(var i=0;i<len;i++)output+=String.fromCharCode(u8buf[i]);return output;}
function kiwi_dup_array(a){return a.slice();}
function kiwi_dedup_array(a,func){var ra=[];a.forEach(function(v,i){if(func){var rv=func(v);if(!rv||rv.err)return;v=rv.v;}
if(!ra.includes(v))ra.push(v);});return ra;}
function kiwi_shallow_copy(obj){return Object.assign({},obj);}
function kiwi_deep_copy(obj){return JSON.parse(JSON.stringify(obj));}
function kiwi_bitReverse(v,len){if(v==0)return 0;var rv=0;for(i=0;i<len;i++){rv|=((v>>i)&1)<<(len-1-i);}
return rv>>>0;}
function kiwi_bitCount(n){if(n==0)return 0;return n.toString(2).match(/1/g).length}
function getFirstChars(buf,len){arrayBufferToStringLen(buf,len);}
function removeEnding(str,ending){if(str.endsWith(ending))
return str.slice(0,-ending.length);else
return str;}
function kiwi_inet4_d2h(inet4_str,exclude_local){var s=inet4_str.split('.');if(s.length!=4)return null;var check=function(v){var n=parseInt(v);if(!isNumber(n)||n<0||n>255)return null;return n;}
var a,b,c,d;if((a=check(s[0]))==null)return null;if((b=check(s[1]))==null)return null;if((c=check(s[2]))==null)return null;if((d=check(s[3]))==null)return null;var ip=(a<<24)|(b<<16)|(c<<8)|d;if(exclude_local){if((ip>=kiwi_ip_10_lo&&ip<=kiwi_ip_10_hi)||(ip>=kiwi_ip_172_16_lo&&ip<=kiwi_ip_172_16_hi)||(ip>=kiwi_ip_192_168_lo&&ip<=kiwi_ip_192_168_hi)||(ip==kiwi_ip_loopback)){return null;}}
return ip;}
var kiwi_ip_10_lo=kiwi_inet4_d2h('10.0.0.0');var kiwi_ip_10_hi=kiwi_inet4_d2h('10.255.255.255');var kiwi_ip_172_16_lo=kiwi_inet4_d2h('172.16.0.0');var kiwi_ip_172_16_hi=kiwi_inet4_d2h('172.31.255.255');var kiwi_ip_192_168_lo=kiwi_inet4_d2h('192.168.0.0');var kiwi_ip_192_168_hi=kiwi_inet4_d2h('192.168.255.255');var kiwi_ip_loopback=kiwi_inet4_d2h('127.0.0.1');function kiwi_h2n_32(ip,o){var n;switch(o){case 0:n=ip>>24;break;case 1:n=ip>>16;break;case 2:n=ip>>8;break;case 3:n=ip;break;default:n=0;break;}
return n&0xff;}
function kiwi_ip_str(ip){var s='';if(isNumber(ip))
s=kiwi_h2n_32(ip,0)+'.'+kiwi_h2n_32(ip,1)+'.'+kiwi_h2n_32(ip,2)+'.'+kiwi_h2n_32(ip,3);else
if(isArray(ip))
s=ip[3]+'.'+ip[2]+'.'+ip[1]+'.'+ip[0];else
if(isObject(ip))
s=ip.a+'.'+ip.b+'.'+ip.c+'.'+ip.d;return s;}
Number.prototype.leadingZeros=function(size){var s=String(this);if(!isNumber(size))size=2;while(s.length<size)s='0'+s;return s;}
String.prototype.leadingZeros=function(size){var s=String(this);if(!isNumber(size))size=2;while(s.length<size)s='0'+s;return s;}
Number.prototype.fieldWidth=function(size){var s=String(this);if(!isNumber(size))return s;while(s.length<size)s=' '+s;return s;}
String.prototype.fieldWidth=function(size){var s=String(this);if(!isNumber(size))return s;while(s.length<size)s=' '+s;return s;}
String.prototype.filterInt=function(){var s=String(this);if(/^(\-|\+)?([0-9]+|Infinity)$/.test(s))
return Number(s);return NaN;}
String.prototype.parseIntEnd=function(){var s=String(this);var a=s.match(/[^-\d]+([-\d]+$)/);if(a.length==2&&isNumber(+a[1]))
return Number(a[1]);return NaN;}
String.prototype.withSign=function(){var s=this;var n=Number(s);return(n<0)?s:('+'+s);}
String.prototype.positiveWithSign=function(){var s=this;var n=Number(s);return(n<=0)?s:('+'+s);}
function isHexDigit(c){return('0123456789ABCDEFabcdef'.indexOf(c)>-1);}
Number.prototype.toHex=function(digits){if(!isNumber(digits))digits=0;var add_0x=(digits<0)?0:1;digits=Math.abs(digits);var n=Number(this);n=n>>>0;var s=n.toString(16);while(s.length<digits)s='0'+s;if(add_0x)s='0x'+s;return s;}
Number.prototype.toFixedNZ=function(d){var n=Number(this);var s=n.toFixed(d);while(s.endsWith('0'))
s=s.slice(0,-1);if(s.endsWith('.'))s=s.slice(0,-1);return s;}
Number.prototype.toUnits=function(){var n=Number(this);if(n<1000){return n.toString();}else
if(n<1e6){return(n/1e3).toFixed(1)+'k';}else
if(n<1e9){return(n/1e6).toFixed(1)+'M';}else{return(n/1e9).toFixed(1)+'G';}}
String.prototype.parseFloatWithUnits=function(allowed_suffixes,adj,frac_digits){var s=String(this);var v=parseFloat(s);if(isNaN(v))return NaN;if(!allowed_suffixes||allowed_suffixes.includes('k'))
if(new RegExp('([-0-9.]*k)').test(s)){v*=1e3;if(isNumber(adj))v*=adj;}
if(!allowed_suffixes||allowed_suffixes.includes('M'))
if(new RegExp('([-0-9.]*M)').test(s)){v*=1e6;if(isNumber(adj))v*=adj;}
return kiwi_round(v,frac_digits);}
function kiwi_round(v,frac_digits){if(!isNumber(frac_digits)||frac_digits<0)return v;var factor=Math.pow(10,frac_digits);return Math.round(v*factor)/ factor;}
Number.prototype.withSign=function(){var n=Number(this);var s=n.toString();return(n<0)?s:('+'+s);}
var kHz=function(f){return(f / 1e3).toFixed(3)+'k';}
function kiwi_setTimeout(func,msec,param){func(param);return setTimeout(func,msec,param);}
function kiwi_clearTimeout(timeout){try{clearTimeout(timeout);}catch(e){};}
function kiwi_setInterval(func,msec,param){func(param);return setInterval(func,msec,param);}
function kiwi_clearInterval(interval){try{clearInterval(interval);}catch(e){};}
var littleEndian=(function(){var buffer=new ArrayBuffer(2);new DataView(buffer).setInt16(0,256,true);return new Int16Array(buffer)[0]===256;})();function _nochange(v){if(arguments.length==0)return undefined;return(v===undefined);}
function _default(v){if(arguments.length==0)return NaN;return isNaN(v);}
function _change(v){return(!_nochange(v)&&!_default(v));}
function console_log(){var s;for(var i=0;i<arguments.length;i++){var arg=arguments[i];if(i==0){s=arg+': ';}else{s+='arg'+(i-1)+'='+arg+' ';}}
console.log('CONSOLE_LOG '+s);}
function console_nv(){var s;for(var i=0;i<arguments.length;i++){var arg=arguments[i];if(i==0){s=arg+': ';}else{var name,val;if(isObject(arg)){name=Object.keys(arg)[0];val=arg[name];s+=name+'='+JSON.stringify(val)+' ';}else
if(isString(arg)){try{val=getVarFromString(arg);}catch(ex){val='[not defined]';}
name=arg;s+=name+'='+val+' ';}else{s+='[arg'+(i-1)+' unknown] ';}}}
console.log('CONSOLE_NV '+s);}
function console_log_dbgUs(){if(!dbgUs)return;s='';for(var i=0;i<arguments.length;i++)
s+=arguments[i].toString();console.log(s);}
function kiwi_log(s){setTimeout(function(s){console.log(s);},1,s);}
function kiwi_trace_log(s){setTimeout(function(s){kiwi_trace(s);},1,s);}
function canvas_log_int(s){var el;if(!kiwi.canvas_log_init){el=w3_el('id-news');el.style.top='';el.style.bottom='';el.style.left='';el.style.right='';if(kiwi_isMobile()){var w=window.innerWidth;var h=window.innerHeight;if(w<=768&&h>=600){el.style.top='36px';el.style.left='0';el.style.width='350px';el.style.height='400px';}else{el.style.top='36px';el.style.right='0';el.style.width='150px';el.style.height='150px';}}else{el.style.bottom='0';el.style.left='0';el.style.width='350px';el.style.height='300px';}
el.style.visibility='visible';el.style.zIndex=9999;kiwi.canvas_log_init=true;}
el=w3_el('id-news-inner');w3_innerHTML(el,s);w3_scrollDown(el);}
function canvas_log_clear(){if(kiwi.canvas_log_init==true)
canvas_log('\f');}
function canvas_log(s){if(isUndefined(owrx.news_acc_s))owrx.news_acc_s='<br>';if(s=='\f'){owrx.news_acc_s='<br>';}else
if(s.charAt(0)=='$'){owrx.news_acc_s+='<br>'+s;}else{owrx.news_acc_s+=((owrx.news_acc_s!='<br>')?' | ':'')+s;}
canvas_log_int(owrx.news_acc_s);}
function canvas_log2(s){if(kiwi_isMobile())
toggle_or_set_hide_bars(owrx.HIDE_BANDBAR);w3_innerHTML('id-rx-title',kiwi.log2_seq+': '+s);kiwi.log2_seq++;}
function kiwi_pathToSelector(node){if(!node||!node.outerHTML){return null;}
var path;while(node.parentElement){var name=node.localName;if(!name)break;name=name.toLowerCase();var parent=node.parentElement;var domSiblings=[];if(parent.children&&parent.children.length>0){for(var i=0;i<parent.children.length;i++){var sibling=parent.children[i];if(sibling.localName&&sibling.localName.toLowerCase){if(sibling.localName.toLowerCase()===name){domSiblings.push(sibling);}}}}
if(domSiblings.length>1){name+=':eq('+domSiblings.indexOf(node)+')';}
path=name+(path?'>'+path:'');node=parent;}
return path;}
function kiwi_serializeEvent(e){if(e){var o={eventName:e.toString(),altKey:e.altKey,bubbles:e.bubbles,button:e.button,buttons:e.buttons,cancelBubble:e.cancelBubble,cancelable:e.cancelable,clientX:e.clientX,clientY:e.clientY,composed:e.composed,ctrlKey:e.ctrlKey,currentTarget:e.currentTarget?e.currentTarget.outerHTML:null,defaultPrevented:e.defaultPrevented,detail:e.detail,eventPhase:e.eventPhase,fromElement:e.fromElement?e.fromElement.outerHTML:null,isTrusted:e.isTrusted,layerX:e.layerX,layerY:e.layerY,metaKey:e.metaKey,movementX:e.movementX,movementY:e.movementY,offsetX:e.offsetX,offsetY:e.offsetY,pageX:e.pageX,pageY:e.pageY,path:kiwi_pathToSelector(e.path&&e.path.length?e.path[0]:null),relatedTarget:e.relatedTarget?e.relatedTarget.outerHTML:null,returnValue:e.returnValue,screenX:e.screenX,screenY:e.screenY,shiftKey:e.shiftKey,sourceCapabilities:e.sourceCapabilities?e.sourceCapabilities.toString():null,target:e.target?e.target.outerHTML:null,timeStamp:e.timeStamp,toElement:e.toElement?e.toElement.outerHTML:null,type:e.type,view:e.view?e.view.toString():null,which:e.which,x:e.x,y:e.y};var s=JSON.stringify(o,null,2);return s;}
return'(null)';}
function key_stringify(evt){if(!evt)return'(no evt?)';var s='';if(evt.shiftKey)s+='shift-';if(evt.ctrlKey)s+='ctrl-';if(evt.altKey)s+='alt-';if(evt.metaKey)s+='meta-';s+=evt.key?evt.key:'(no key?)';return s;}
function event_dump(evt,id,oneline){var k=evt.key||'(no key)';if(oneline){var trel=(isDefined(evt.relatedTarget)&&evt.relatedTarget)?(' Trel='+evt.relatedTarget.id):'';var key=key_stringify(evt);var ct_id=evt.currentTarget?evt.currentTarget.id:'(null)';console.log('event_dump '+id+' |'+evt.type+'| k='+key+' T='+evt.target.id+' Tcur='+ct_id+trel);}else{console.log('================================');if(isNoArg(evt)){console.log('EVENT_DUMP: '+id+' bad evt');kiwi_trace();return;}
console.log('EVENT_DUMP: '+id+' type='+evt.type);console.log('key: '+key_stringify(evt));var ct_id=evt.currentTarget?evt.currentTarget.id:'(null)';console.log('this.id='+this.id+' tgt.name='+evt.target.nodeName+' tgt.id='+evt.target.id+' ctgt.id='+ct_id);var buttons='';if(evt.buttons&1)buttons+='L';if(evt.buttons&4)buttons+='M';if(evt.buttons&2)buttons+='R';console.log('button='+"LMR"[evt.button]+' buttons='+buttons+' detail='+evt.detail);if(evt.type.startsWith('touch')){console.log('pageX='+evt.pageX+' clientX='+evt.clientX+' screenX='+evt.screenX);console.log('pageY='+evt.pageY+' clientY='+evt.clientY+' screenY='+evt.screenY);}else{console.log('pageX='+evt.pageX+' clientX='+evt.clientX+' screenX='+evt.screenX+' offX(EXP)='+evt.offsetX+' layerX(DEPR)='+evt.layerX);console.log('pageY='+evt.pageY+' clientY='+evt.clientY+' screenY='+evt.screenY+' offY(EXP)='+evt.offsetY+' layerY(DEPR)='+evt.layerY);}
console.log('evt, evt.target, evt.currentTarget, evt.relatedTarget, elementFromPoint:');console.log(evt);console.log(evt.target);console.log(evt.currentTarget);console.log(evt.relatedTarget);var el_s=w3_elementAtPointer(evt);if(el_s)
console.log(el_s);else
console.log('(no x,y)');console.log('----');}}
function kiwi_rateLimit(cb,time){var waiting=false;var rtn=function(){if(waiting)return;waiting=true;var args=arguments;setTimeout(function(){waiting=false;if(isString(cb))
w3_call(cb);else
cb.apply(this,args);},time);};return rtn;}
function kiwi_UTC_minutes(){var d=new Date();return(d.getUTCHours()*60+d.getUTCMinutes());}
function kiwi_hh_mm(hh_mm){if(isNumber(hh_mm))return hh_mm;if(isString(hh_mm)){var t=hh_mm.split(':');var hr=+t[0];if(t.length>1){var min=(+t[1])/ 60;hr=(hr<0)?(hr-min):(hr+min);}
if(t[0]=='-0'||t[0]=='-00')
hr=-hr;return hr;}
return null;}
function kiwi_UTCdoyToDate(doy,year,hour,min,sec){return new Date(Date.UTC(year,0,doy,hour,min,sec));}
function kiwi_decodeURIComponent(id,uri){var obj=null,double_fail=false;if(dbgUs&&arguments.length!=2){alert('kiwi_decodeURIComponent: requires exactly two args');kiwi_trace();return null;}
while(obj==null){try{obj=decodeURIComponent(uri);}catch(ex){console.log('$kiwi_decodeURIComponent('+id+'): decode fail');console.log(uri);console.log(ex);if(double_fail){console.log('kiwi_decodeURIComponent('+id+'): DOUBLE DECODE FAIL');console.log(uri);console.log(ex);return null;}
var i,j,k;for(i=0;i<uri.length-2;i++){var c1=uri.charAt(i+1);var c2=uri.charAt(i+2);if(uri.charAt(i)=='%'&&isHexDigit(c1)&&isHexDigit(c2)){if(c1>='8'){j=Math.max(i-5,0);k=Math.min(i+6,uri.length);console.log('BAD @'+i+' '+uri.slice(j,k));uri=uri.substr(0,i)+uri.substr(i+3);i=0;double_fail=true;}}}
console.log('FINAL FIX <'+uri+'>');obj=null;}}
return obj;}
kiwi_util.str_recode_lookup=[];var e1=function(c){kiwi_util.str_recode_lookup[ord(c)]=1;}
var e2=function(c){kiwi_util.str_recode_lookup[ord(c)]=2;}
var er=function(r1,r2,v){for(var i=r1;i<=r2;i++)
kiwi_util.str_recode_lookup[i]=v;}
er(0,127,0);e1('&');e1("'");e1('+');e1(';');e1('<');e1('>');e1('`');e2('"');e2('%');e2('\\');er(0x00,0x1f,2);er(0x7f,0x7f,2);function kiwi_str_decode_selective_inplace(src,fewer_encoded){var i,dst='';var src_len=src.length;var dst_len=src.length+1;var hex_digit=/[0-9a-fA-F]/;for(i=0;i<src_len;i++){if(src[i]=='%'&&i+2<src_len&&src[i+1].match(hex_digit)&&src[i+2].match(hex_digit)){var c=(parseInt(src[i+1],16)<<4)|parseInt(src[i+2],16);if(c<0x80&&(kiwi_util.str_recode_lookup[c]==0||(fewer_encoded&&kiwi_util.str_recode_lookup[c]==1))){dst+=chr(c);i+=2;}else{dst+='%';}}else{dst+=src[i];}}
return dst;}
function kiwi_JSON(json,pretty){return JSON.stringify(json,null,pretty?3:undefined);}
function kiwi_JSON_parse(tag,json,func){var obj;try{obj=JSON.parse(json);}catch(ex){console.log('kiwi_JSON_parse('+tag+'): JSON parse fail');console.log(json);console.log(ex);w3_call(func,ex);obj=null;}
return obj;}
function kiwi_remove_escape_sequences(s){var a1=s.split('');var a2=[];var inANSI=false,inHTML=false;for(var i=0;i<a1.length;i++){var c=a1[i];if(inANSI){if(c=='m')inANSI=false;}else
if(inHTML){if(c==kiwi.esc_gt)inHTML=false;}else{if(c=='\u001b'&&(i+1)<a1.length&&a1[i+1]=='['){i++;inANSI=true;}else
if(c==kiwi.esc_lt){inHTML=true;}else{if(c!='\f')
a2.push(c);}}}
return a2.join('');}
function kiwi_timestamp(){return new Date().toISOString().replace(/:/g,'_').replace(/\.[0-9]+Z$/,'Z');}
function kiwi_timestamp_filename(pre,post){var el=w3_el('id-freq-input');var freq_mode=el?('_'+el.value+'_'+ext_get_mode()):'';return pre+kiwi_host()+'_'+kiwi_timestamp()+freq_mode+post;}
function kiwi_clean_html(s){return s.replace(/\&/g,'&amp;').replace(/\</g,'&lt;').replace(/\>/g,'&gt;');}
function kiwi_clean_newline(s){return s.replace(/[\r\n\f\v]/g,'').replace(/\t/g,' ');}
function kiwi_SSL(){return window.location.protocol+'//';}
function kiwi_url_origin(){return window.location.origin;}
function kiwi_host_port(){return window.location.host;}
function kiwi_host(){return window.location.hostname;}
function kiwi_remove_protocol(url){return url.replace(/^http:\/\//,'').replace(/^https:\/\//,'');}
function kiwi_add_end(s,end){if(!s.endsWith(end))s=s+end;return s;}
function kiwi_url_param(pnames,default_val,not_found_val){var pn_isArray=isArray(pnames);if(isUndefined(default_val))default_val=true;if(isUndefined(not_found_val))not_found_val=null;var params=(window.location&&window.location.search&&window.location.search.substr(1));if(!params)return not_found_val;var rv=not_found_val;params.split("&").forEach(function(pv){var pv_a=pv.split("=");if(pn_isArray){pnames.forEach(function(pn){if(pn!=pv_a[0])return;rv=(pv_a.length>=2)?pv_a[1]:default_val;});}else{if(pnames==pv_a[0]){rv=(pv_a.length>=2)?pv_a[1]:default_val;}}});return rv;}
function kiwi_add_search_param(location,param){var p;var qs=location.search;console.log('qs=<'+qs+'>');if(qs=='')p='/?';else if(qs.includes('?'))p='&';else p='/?';return p+param;}
function kiwi_remove_search_param(url,p){url=url.replace('?'+p+'&','?').replace('&'+p+'&','&').replace('?'+p+'','').replace('&'+p+'','');return url;}
function html(el_id){return w3_el(el_id);}
function px(s){if(isNoArg(s)||s=='')return'0';var num=parseFloat(s);if(isNaN(num)){console.log('px num='+s);kiwi_trace();return'0';}
return num.toFixed(0)+'px';}
function unpx(s){return parseFloat(s);}
function css_style(el,prop){el=w3_el(el);if(!el)return null;var style=getComputedStyle(el,null);var val=style.getPropertyValue(prop);return val;}
function css_style_num(el,prop){el=w3_el(el);if(!el)return null;var v=parseInt(css_style(el,prop));if(isNaN(v))v=0;return v;}
function html_LR_border_pad(el){var bL=css_style_num(el,'border-left-width');var bR=css_style_num(el,'border-right-width');var pL=css_style_num(el,'padding-left');var pR=css_style_num(el,'padding-right');return bL+bR+pL+pR;}
function cancelEvent(ev){ev=ev?ev:window.event;if(ev.stopPropagation)ev.stopPropagation();if(ev.preventDefault)ev.preventDefault();if(ev.stopImmediatePropagation)ev.stopImmediatePropagation();ev.cancelBubble=true;ev.cancel=true;ev.returnValue=false;return false;}
function ignore(ev){return cancelEvent(ev);}
function kiwi_rgb(r,g,b){if(r==null)return'';if(isArray(r)){g=r[1];b=r[2];r=r[0];}
return'rgb('+Math.floor(r)+','+Math.floor(g)+','+Math.floor(b)+')';}
function hsl(h,s,l){s=Math.floor(s);if(s<0)s=0;if(s>100)s=100;l=Math.floor(l);if(l<0)l=0;if(l>100)l=100;return'hsl('+Math.round(h)+','+s+'%,'+l+'%)';}
function createCookie(name,value,days){var expires="";if(days){var date=new Date();date.setTime(date.getTime()+(days*24*60*60*1000));expires="; expires="+date.toGMTString();}
document.cookie=name+"="+value+expires+"; path=/; SameSite=Lax;";}
function readCookie(name,defaultValue){var nameEQ=name+"=";var ca=document.cookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==' ')c=c.substring(1,c.length);if(c.indexOf(nameEQ)==0)return c.substring(nameEQ.length,c.length);}
if(isDefined(defaultValue)){return defaultValue;}else{return null;}}
function writeCookie(cookie,value){createCookie(cookie,value,42*365);}
function initCookie(cookie,initValue){var v=readCookie(cookie);if(v==null){writeCookie(cookie,initValue);return initValue;}else{return v;}}
function updateCookie(cookie,initValue){var v=readCookie(cookie);if(v==null||v!=initValue){writeCookie(cookie,initValue);return true;}else{return false;}}
function deleteCookie(cookie){var v=readCookie(cookie);if(v==null)return;createCookie(cookie,0,-1);}
function kiwi_storeGet(s,init){var rv;if(isNoArg(s))return null;try{if(localStorage==null)return null;rv=localStorage.getItem(s);if(rv==null){rv=readCookie(s);if(rv!=null){console.log('$moving to storage api: '+s+'='+rv);kiwi_storeSet(s,rv);deleteCookie(s);}else{if(isDefined(init)){kiwi_storeSet(s,init);rv=init;}else{rv=null;}}}}catch(ex){console.log('$kiwi_storeGet CATCH: '+s);console.log('$kiwi_storeGet CATCH: '+ex);rv=null;}
if(rv==null)console.log('$ kiwi_storeGet warning: '+s+'=null');return rv;}
function kiwi_storeSet(s,v){if(isNoArg(v))return null;try{if(localStorage==null)return null;localStorage.setItem(s,v);}catch(ex){return null;}
return true;}
function getVarFromString(path){var scope=window;var scopeSplit=path.split('.');for(i=0;i<scopeSplit.length-1;i++){var scope_name=scopeSplit[i];scope=scope[scope_name];if(isUndefined(scope)){throw'no scope';}}
var r=scope[scopeSplit[scopeSplit.length-1]];return r;}
function setVarFromString(string,val){var scope=window;var scopeSplit=string.split('.');for(i=0;i<scopeSplit.length-1;i++){if(scope[scopeSplit[i]]==undefined){scope[scopeSplit[i]]={};}
scope=scope[scopeSplit[i]];}
scope[scopeSplit[scopeSplit.length-1]]=val;}
function getType(o){return o&&o.constructor&&o.constructor.name}
function kiwi_parseQuery(query){var Params=new Object();if(!query)return Params;var Pairs=query.split(/[;&]/);for(var i=0;i<Pairs.length;i++){var KeyVal=Pairs[i].split('=');if(!KeyVal||KeyVal.length!=2)continue;var key=unescape(KeyVal[0]);var val=unescape(KeyVal[1]);val=val.replace(/\+/g,' ');Params[key]=val;}
return Params;}
function getTextWidth(text,font){var canvas=getTextWidth.canvas||(getTextWidth.canvas=document.createElement("canvas"));var context=canvas.getContext("2d");context.font=font;var metrics=context.measureText(text);return metrics.width;}
function kiwi_GETrequest(id,url,opt){var debug=w3_opt(opt,'debug',0);var iframe=document.createElement("iframe");var uniqueString=id+'_'+(new Date()).toUTCString().substr(17,8);document.body.appendChild(iframe);iframe.style.display="none";iframe.contentWindow.name=uniqueString;w3_add(iframe,'id-kiwi_GETrequest');var form=document.createElement("form");form.target=uniqueString;form.action=url;form.method="GET";w3_add(form,'id-kiwi_GETrequest');if(debug)console.log('kiwi_GETrequest: '+uniqueString);return{iframe:iframe,form:form,debug:debug};}
function kiwi_GETrequest_submit(request,opt){var no_submit=w3_opt(opt,'no_submit',0);var gc=w3_opt(opt,'gc',0);if(no_submit){console.log('kiwi_GETrequest_submit: NO SUBMIT');}else{document.body.appendChild(request.form);request.form.submit();if(request.debug)console.log('kiwi_GETrequest_submit: SUBMITTED');}
if(gc)setTimeout(function(){document.body.removeChild(request.form);document.body.removeChild(request.iframe);},60000);}
function kiwi_GETrequest_param(request,name,value){var input=document.createElement("input");input.type="hidden";input.name=name;input.value=value;request.form.appendChild(input);if(request.debug)console.log('kiwi_GETrequest_param: '+name+'='+value);}
var ajax_state={DONE:4};function kiwi_ajax(url,callback,cb_param,timeout,debug){kiwi_ajax_prim('GET',null,url,callback,cb_param,timeout,undefined,undefined,debug);}
function kiwi_ajax_progress(url,callback,cb_param,timeout,progress_cb,progress_cb_param,debug){kiwi_ajax_prim('GET',null,url,callback,cb_param,timeout,progress_cb,progress_cb_param,debug);}
function kiwi_ajax_send(data,url,callback,cb_param,timeout,debug){kiwi_ajax_prim('PUT',data,url,callback,cb_param,timeout,undefined,undefined,debug);}
var ajax_id=0;var ajax_requests={};function kiwi_ajax_prim(method,data,url,callback,cb_param,timeout,progress_cb,progress_cb_param,debug){ajax_id++;var ajax;var dbug=function(msg){if(debug){console.log(msg);}};try{ajax=new XMLHttpRequest();}catch(ex){try{ajax=new ActiveXObject("Msxml2.XMLHTTP");}catch(ex){try{ajax=new ActiveXObject("Microsoft.XMLHTTP");}catch(ex){return false;}}}
ajax.kiwi_id=ajax_id;ajax_requests[ajax_id]={};ajax_requests[ajax_id].didTimeout=false;ajax_requests[ajax_id].timer=-1;timeout=timeout?timeout:0;if(timeout){ajax_requests[ajax_id].timer=setTimeout(function(){var id=ajax.kiwi_id;ajax_requests[id].didTimeout=true;ajax_requests[id].timer=-1;console.log('$AJAX TIMEOUT url='+url);var obj={AJAX_error:'timeout'};w3_call(callback,obj,cb_param);ajax.abort();delete ajax_requests[id];},Math.abs(timeout));}
if(progress_cb){dbug('AJAX with progress_cb='+progress_cb);ajax.onprogress=function(){var response=ajax.responseText.toString()||'';dbug('XHR.onprogress='+response);w3_call(progress_cb,response,progress_cb_param);};}
ajax.onerror=function(e){dbug('XHR.onerror='+e);if(debug)console.log(e);}
ajax.onabort=function(e){dbug('XHR.onabort='+e);if(debug)console.log(e);}
ajax.onload=function(e){dbug('XHR.onload='+e);if(debug)console.log(e);}
ajax.onloadstart=function(e){dbug('XHR.onloadstart='+e);if(debug)console.log(e);}
ajax.onreadystatechange=function(){dbug('XHR.onreadystatechange readyState='+ajax.readyState);if(ajax.readyState!=ajax_state.DONE){return false;}
var id=ajax.kiwi_id;var timer=ajax_requests[id].timer;dbug('AJAX ORSC ENTER recovered id='+id+' timer='+timer+' cb='+callback);if(timer!=-1){dbug('AJAX ORSC CLEAR_TIMER recovered id='+id+' timer='+timer);kiwi_clearTimeout(timer);ajax_requests[id].timer=-1;}
if(!ajax_requests[id].didTimeout){var obj;dbug('XHR.status='+ajax.status);dbug('XHR.statusText='+ajax.statusText);dbug('XHR.responseType='+ajax.responseType);dbug('XHR.response='+ajax.response);dbug('XHR.responseText='+ajax.responseText);dbug('XHR.responseURL='+ajax.responseURL);if(debug)console.log(ajax);if(ajax.status!=200){console.log('$AJAX BAD STATUS='+ajax.status+' url='+url);obj={AJAX_error:'status',status:ajax.status};}else{var response=ajax.responseText.toString();if(response==null)response='';if(response.startsWith('<?xml')){obj={XML:true,text:response};}else{var firstChar=response.charAt(0);if(firstChar!='{'&&firstChar!='['&&!(firstChar>='0'&&firstChar<='9')){dbug("AJAX: response didn't begin with JSON '{', '[' or digit? "+response);obj={AJAX_error:'JSON prefix',response:response};}else{try{response=kiwi_remove_cjson_comments(response);obj=JSON.parse(response);dbug('AJAX JSON response:');dbug(response);dbug(obj);}catch(ex){dbug("AJAX response JSON.parse failed: <"+response+'>');dbug(ex);var ex_s=ex.toString();var line=ex_s.match(/line ([0-9]*)/);line=(isArray(line)&&line.length>=1)?+line[1]:null;obj={AJAX_error:'JSON parse',JSON_line:line,JSON_ex:ex_s,lines:response.split('\n'),response:response};}}}}
dbug('AJAX ORSC CALLBACK recovered id='+id+' callback='+typeof(callback));w3_call(callback,obj,cb_param);}else{dbug('AJAX ORSC TIMED_OUT recovered id='+id);}
dbug('AJAX ORSC ABORT/DELETE');ajax.abort();delete ajax_requests[id];}
if(timeout>=0){ajax.open(method,url,true);dbug('AJAX SEND id='+ajax_id+' url='+url);ajax.send(data);}
return true;}
function kiwi_remove_cjson_comments(s){var removed=false;var c_begin,c_end;while((c_begin=s.indexOf('\n//'))!=-1){c_end=s.indexOf('\n',c_begin+3);s=s.slice(0,c_begin)+s.slice(c_end);removed=true;}
return s;}
function kiwi_scrollbar_width(){if(kiwi_isMacOS())return 10;return 15;}
function kiwi_strip_tags(input,allowed){allowed=(((allowed||'')+'').toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join('');var tags=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,commentsAndPhpTags=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;return input.replace(commentsAndPhpTags,'').replace(tags,function($0,$1){return allowed.indexOf('<'+$1.toLowerCase()+'>')>-1?$0:'';});}
function kiwi_pie(id,size,unfilled_color,filled_color){var size2=size*2;var s='<svg width="'+size2+'" height="'+size2+'" viewbox="0 0 '+size2+' '+size2+'">'+'<circle cx="'+size+'" cy="'+size+'" r="'+size+'" fill="'+unfilled_color+'" />'+'<path class="'+id+'" style="fill:'+filled_color+'" transform="translate('+size+', '+size+')" />'+'</svg>';return s;}
function kiwi_draw_pie(id,size,filled){var alpha=360*filled;var r=alpha*Math.PI / 180,x=Math.sin(r)*size,y=Math.cos(r)*-size,mid=(alpha>=180)?1:0;if(alpha==360){mid=1;x=-0.1;y=-size;}
var animate='M 0 0 v '+(-size)+' A '+size+' '+size+' 1 '+mid+' 1 '+x+' '+y+' z';w3_iterate_classname(id,function(el){el.setAttribute('d',animate);});};function page_draw_pie(which_s){var which=(which_s=='admin')?admin:mfg;var id_which=function(suffix){return('id-'+which_s+'-'+suffix);};w3_el(id_which('reload-secs')).innerHTML='Page reload in '+which.reload_rem+' secs';if(which.reload_rem>0){which.reload_rem--;kiwi_draw_pie(id_which('pie'),which.pie_size,(which.reload_secs-which.reload_rem)/ which.reload_secs);}else{try{window.location.reload(true);}catch(ex){console.log('RELOAD FAILED?');console.log(ex);}}};function wait_then_reload_page(secs,msg,which_s){if(isUndefined(which_s))which_s='admin';var isAdmin=(which_s=='admin');var which=isAdmin?admin:mfg;var ael=w3_el('id-'+which_s);var id_which=function(suffix){return('id-'+which_s+'-'+suffix);};var reload_msg=id_which('reload-msg');var s2;if(secs){s2=w3_divs('w3-valign w3-margin-T-8/w3-container',w3_div('w3-show-inline-block',kiwi_pie(id_which('pie'),which.pie_size,'#eeeeee','deepSkyBlue')),w3_div('w3-show-inline-block',w3_div(reload_msg),w3_div(id_which('reload-secs'))));}else{s2=w3_divs('w3-valign w3-margin-T-8/w3-container',w3_div(reload_msg));}
var s=(isAdmin?'<header class="w3-container w3-teal"><h5>Admin interface</h5></header>':'')+s2;ael.innerHTML=s;if(msg)w3_el(reload_msg).innerHTML=msg;if(secs){which.reload_rem=which.reload_secs=secs;setInterval(page_draw_pie,1000,which_s);page_draw_pie(which_s);}}
function enc(s){return s.replace(/./gi,function(c){return String.fromCharCode(c.charCodeAt(0)^3);});}
var sendmail=function(to,subject){var s="mailto:"+enc(decodeURIComponent(to))+(isDefined(subject)?('?subject='+subject):'');window.location.href=s;}
function line_stroke(ctx,vert,linew,color,x1,y1,x2,y2){var lineh=Math.floor(linew/2);var w=vert?linew:x2-x1+1;var h=vert?y2-y1+1:linew;var x=x1-(vert?lineh:0);var y=y1-(vert?0:lineh);ctx.fillStyle=color;ctx.fillRect(x,y,w,h);}
var wsockets=[];function msg_send(s){for(var i=0;i<wsockets.length;i++){var ws=wsockets[i].ws;if(!ws.up)continue;try{ws.send(s);return 0;}catch(ex){console.log("CATCH msg_send('"+s+"') ex="+ex);kiwi_trace();return-1;}}
return-1;}
function open_websocket(stream,open_cb,open_cb_param,msg_cb,recv_cb,error_cb,close_cb){if(!("WebSocket"in window)||!("CLOSING"in WebSocket)){console.log('WEBSOCKET TEST');kiwi_serious_error("Your browser does not support web sockets, which is required. <br> Please use an HTML5 compatible browser.");return null;}
var ws_url=kiwi_url_origin().split("://")[1];var ws_protocol='ws://';if(window.location.protocol==="https:"){ws_protocol='wss://';}
var no_wf=(window.location.href.includes('?no_wf')||window.location.href.includes('&no_wf'));ws_url=ws_protocol+ws_url+'/'+(no_wf?'no_wf/':'kiwi/')+kiwi.conn_tstamp+'/'+stream;if(isNonEmptyString(window.location.search))
ws_url+=window.location.search;if(no_wf)wf.no_wf=true;var ws=new WebSocket(ws_url);wsockets.push({'ws':ws,'name':stream});ws.up=false;ws.stream=stream;ws.open_cb=open_cb;ws.open_cb_param=open_cb_param;ws.msg_cb=msg_cb;ws.recv_cb=recv_cb;ws.error_cb=error_cb;ws.close_cb=close_cb;ws.onopen=function(){ws.up=true;if(ws.open_cb){try{ws.open_cb(ws.open_cb_param);}catch(ex){console.log(ex);}}};ws.onmessage=function(evt){on_ws_recv(evt,ws);};ws.onclose=function(evt){ws.up=false;console.log('WS-CLOSE: '+ws.stream);if(ws.close_cb){try{ws.close_cb(ws);}catch(ex){console.log(ex);}}};ws.binaryType="arraybuffer";ws.onerror=function(evt){if(ws.error_cb){try{ws.error_cb(evt,ws);}catch(ex){console.log(ex);}}};return ws;}
var kiwi_flush_recv_input=true;function recv_websocket(ws,recv_cb){if(ws.stream=='SND'||ws.stream=='W/F')return;ws.recv_cb=recv_cb;if(recv_cb==null)
kiwi_flush_recv_input=true;}
function on_ws_recv(evt,ws){var data=evt.data;if(!(data instanceof ArrayBuffer)){console.log("on_ws_recv: not an ArrayBuffer?");return;}
if(seriousError)
return;var firstChars=arrayBufferToStringLen(data,3);if(firstChars=="CLI")return;var claimed=false;if(firstChars=="MSG"){var stringData=arrayBufferToString(data);params=stringData.substring(4).split(" ");for(var i=0;i<params.length;i++){var msg_a=params[i].split("=");if(ws.stream=='EXT'&&msg_a[0]=='EXT-STOP-FLUSH-INPUT'){kiwi_flush_recv_input=false;}
claimed=kiwi_msg(msg_a,ws);if(claimed==false){if(ws.msg_cb){claimed=ws.msg_cb(msg_a,ws);}}
if(claimed==false)
console.log('>>> '+ws.stream+': message not claimed: '+params[i]);}}else{if(ws.recv_cb&&(ws.stream!='EXT'||kiwi_flush_recv_input==false)){ws.recv_cb(data,ws,firstChars);if(isDefined(kiwi_gc_recv)&&kiwi_gc_recv)data=null;}}}
window.onbeforeunload=function(){var i;for(i=0;i<wsockets.length;i++){var ws=wsockets[i].ws;if(ws){ws.onclose=function(){};ws.close();}}};





/* web/kiwi/w3_util.min.js (web/kiwi/w3_util.js = Wed Dec 27 10:18:19 2023) */
var w3={_last_:0};var w3int={menu_cur_id:null,menu_active:false,menu_debug:false,menu_close_func:null,prev_menu_hover_el:null,rate_limit:{},rate_limit_evt:{},_last_:0};function visible_block(){}
var w3_console={};w3_console.log=function(obj,prefix){var s=prefix?(prefix+': '):'';if(isString(obj)){s+='"'+obj.toString()+'"';}else
if(isObject(obj)){console.log(obj);var json='JSON '+JSON.stringify(obj,w3int_console_replacer);if(json.includes('\n'))
json=JSON.stringify(obj,w3int_console_replacer,1);s+=json;}else{s+=obj.toString();}
console.log(s);};function w3int_console_replacer(k,v){if(isUndefined(v))return'<undefined>';if(isNull(v))return'<null>';if(isFunction(v))return'<function>';return'<'+v.toString()+'>';}
function w3_strip_quotes(s){if(isString(s)&&(s.indexOf('\'')!=-1||s.indexOf('\"')!=-1))
return s.replace(/'/g,'').replace(/"/g,'')+' [quotes stripped]';return s;}
function w3_esc_dq(s){if(isString(s)&&s.indexOf('\"')!=-1)
return s.replace(/"/g,'&quot;');return s;}
function w3_call(func,arg0,arg1,arg2,arg3,arg4){var rv=undefined;if(isNoArg(func))return rv;try{if(isString(func)){var f=getVarFromString(func);if(isFunction(f)){rv=f(arg0,arg1,arg2,arg3,arg4);}else{}}else
if(isFunction(func)){rv=func(arg0,arg1,arg2,arg3,arg4);}else
console.log('w3_call: func not a string or function');}catch(ex){console.log('w3_call: while in func this exception occured:');console.log(ex);}
return rv;}
function w3_first_value(v){if(v==null)
return'null';var rv=null;var to_v=typeof(v);if(to_v==='number'||to_v==='boolean'||to_v==='string'){rv=v;}else
if(isArray(v)){rv=v[0];}else
if(to_v==='object'){rv=w3_obj_seq_el(v,0);}else{rv=to_v;}
return rv;}
function w3_second_value(v){var rv=null;if(isArray(v)&&v.length>1){if(v.length>1)
rv=v[1];}
return rv;}
function w3_opt(opt,elem,default_val){if(isDefined(opt)&&isDefined(opt[elem])){return opt[elem];}else{return default_val;}}
function w3_obj_num(o){if(isUndefined(o)||isNull(o)||isObject(o))return o;if(isNumber(o))return{num:o};if(isBoolean(o))return{num:(o?1:0)};if(isString(o))return{num:parseFloat(o)};return o;}
function w3_obj_seq_el(obj,idx){var keys_a=Object.keys(obj);if(!isNumber(idx)||idx<0||idx>=keys_a.length)return null;return obj[keys_a[idx]];}
function w3_obj_key_seq(obj,key){var seq=null;Object.keys(obj).forEach(function(_key,i){if(_key==key)seq=i;});return seq;}
function w3_array_el_seq(arr,el){var seq=null;arr.forEach(function(a_el,i){if(a_el==el)seq=i;});return seq;}
function w3_obj_enum(obj,func,opt){var key_match=w3_opt(opt,'key_match',undefined);var value_match=w3_opt(opt,'value_match',undefined);Object.keys(obj).forEach(function(key,i){var o=obj[key];if(isDefined(key_match)){if(key==key_match)func(key,i,o);}else
if(isDefined(value_match)){if(o==value_match)func(key,i,o);}else{func(key,i,o);}});}
function w3_enum_obj_or_array_of_objs(obj_arr,func){if(isArray(obj_arr)){obj_arr.forEach(function(obj){func(obj);});}else
if(isObject(obj_arr)){func(obj_arr);}}
function w3_ext_param_array_match_str(arr,s,func){var found=false;arr.forEach(function(a_el,i){var el=a_el.toString().toLowerCase();if(!found&&el.startsWith(s)){if(func)func(i,a_el.toString());found=true;}});return found;}
function w3_ext_param_array_match_num(arr,n,func){var found=false;arr.forEach(function(a_el,i){var a_num=parseFloat(a_el);if(!found&&a_num==n){if(func)func(i,n);found=true;}});return found;}
function w3_ext_param(s,param){var rv={match:false,full_match:false,has_value:false};var pu=param.split(':');var pl=param.toLowerCase().split(':');if(isNull(s)||s.startsWith(pl[0])){rv.match=true;if(isNull(s)){rv.has_value=true;rv.num=parseFloat(param);rv.string=param;rv.string_case=param;}else
if(pl.length>1){rv.has_value=true;rv.num=parseFloat(pl[1]);rv.string=pl[1];rv.string_case=pu[1];}else{rv.num=0;rv.string=rv.string_case='';}}
if(s&&s==pl[0])rv.full_match=true;return rv;}
function w3_clamp(v,min,max,clamp_val){if(isNaN(v))return(isDefined(clamp_val)?clamp_val:NaN);if(isObject(min)){var o=min;try{if(typeof(o.clamp)==='undefined'){v=Math.max(o.min,Math.min(o.max,v));}else{if(v<o.min||v>o.max)v=o.clamp;}}catch(ex){console.log('w3_clamp: bad obj:');console.log(o);return undefined;}}else{if(clamp_val==undefined)
v=Math.max(min,Math.min(max,v));else
if(v<min||v>max)v=clamp_val;}
return v;}
function w3_clamp3(v,min,max,clamp_min,clamp_max,clamp_NaN){if(isUndefined(clamp_min))clamp_min=NaN;if(isUndefined(clamp_max))clamp_max=NaN;if(isUndefined(clamp_NaN))clamp_NaN=NaN;if(isNaN(v))return clamp_NaN;if(v<min)return clamp_min;if(v>max)return clamp_max;return v;}
function w3_add_id(path,suffix){if(!isString(path))return path;path=path||'';if(path==''||path=='body')return path;path=path.startsWith('id-')?path:('id-'+path);suffix=suffix||'';return path+suffix;}
function w3int_w3_el(id_name_class){if(!id_name_class||id_name_class=='')return null;var el=document.getElementById(id_name_class);if(el==null){el=document.getElementsByName(id_name_class);if(el!=null)el=el[0];}
if(el==null){el=document.getElementsByClassName(id_name_class);if(el!=null)el=el[0];}
return el;}
function w3int_w3_els(id_name_class){if(!id_name_class||id_name_class=='')return null;var els=document.getElementById(id_name_class);var rv;if(els!=null){rv=[els];}else{els=document.getElementsByName(id_name_class);if(els==null||els.length==0){els=document.getElementsByClassName(id_name_class);}
rv=els;}
if(rv.length==0)rv=null;return rv;}
function w3_el(el_id){if(isString(el_id)){if(el_id=='')return null;if(el_id=='body')return document.body;var el=w3int_w3_el(el_id);if(el==null){el=w3int_w3_el(w3_add_id(el_id));if(el==null){el_id=w3_add_toplevel(el_id);el=w3int_w3_el(el_id);if(el==null){el=w3int_w3_el(w3_add_id(el_id));}}}
return el;}
return(el_id);}
function w3_els(el_id,func){if(isString(el_id)){if(el_id=='')return null;if(el_id=='body')return document.body;var els=w3int_w3_els(el_id);if(els==null){els=w3int_w3_els(w3_add_id(el_id));if(els==null){el_id=w3_add_toplevel(el_id);els=w3int_w3_els(el_id);if(els==null){els=w3int_w3_els(w3_add_id(el_id));}}}
if(els&&func)for(var i=0;i<els.length;i++){func(els[i],i);}
return els;}
var el=w3_el(el_id);if(func){func(el,0);}
return[el];}
function w3_id(el_id){var el=w3_el(el_id);if(!el)return null;if(el.id&&el.id.startsWith('id-'))return el.id;var done=false;var id=null;w3_iterate_classList(el,function(className,idx){if(className.startsWith('id-')&&!done){id=className;done=true;}});return id;}
function w3_innerHTML(id){var el=w3_el(id);if(!el)return null;var s='';var narg=arguments.length;for(var i=1;i<narg;i++){s+=arguments[i];}
el.innerHTML=s;return el;}
function w3_clearInnerHTML(id){w3_innerHTML(id,'');}
function w3_append_innerHTML(id){var el=w3_el(id);if(!el)return null;var s='';var narg=arguments.length;for(var i=1;i<narg;i++){s+=arguments[i];}
el.innerHTML+=s;return el;}
function w3_get_innerHTML(id){var el=w3_el(id);if(!el)return null;return el.innerHTML;}
function w3_iterate_classname(cname,func){var els=document.getElementsByClassName(w3_add_id(cname));if(els==null)return;for(var i=0;i<els.length;i++){func(els[i],i);}}
function w3_iterate_classList(el_id,func){var el=w3_el(el_id);if(el&&el.classList)for(var i=0;i<el.classList.length;i++){func(el.classList.item(i),i);}
return el;}
function w3_create_appendElement(el_parent,el_type,html){var el_child=document.createElement(el_type);w3_innerHTML(el_child,html);w3_el(el_parent).appendChild(el_child);return el_child;}
function w3_iterate_parent(el_id,func){var el=w3_el(el_id);var i=0;do{if(func(el,i)!=null)
break;el=el.parentNode;i++;}while(el);}
function w3_iterate_children(el_id,func){var el=w3_el(w3_add_id(el_id));for(var i=0;i<el.children.length;i++){var child_el=el.children[i];func(child_el,i);}}
function w3_iterateDeep_children(el_id,func){var el=w3_el(el_id);for(var i=0;i<el.children.length;i++){var child_el=el.children[i];func(child_el);if(child_el.hasChildNodes)
w3_iterateDeep_children(child_el,func);}}
function w3_iterate_childNodes(el_id,func){var el=w3_el(el_id);for(var i=0;i<el.childNodes.length;i++){var child_el=el.childNodes[i];func(child_el,i);}}
function w3_width_height(el_id,w,h){var el=w3_el(el_id);if(!el)return null;if(isArg(w)){if(isNumber(w))w=px(w);el.style.width=w;}
if(isArg(h)){if(isNumber(h))h=px(h);el.style.height=h;}}
function w3_boundingBox_children(el_id,debug){var bbox={x1:1e99,x2:0,y1:1e99,y2:0,w:0,h:0};w3_iterateDeep_children(el_id,function(el){if(el.nodeName!='DIV'&&el.nodeName!='IMG')
return;var position=css_style(el,'position');if(position=='static')
return;if(el.offsetHeight==0)
return;if(debug)console.log(el);if(debug)console.log(el.nodeName+' el.oL='+el.offsetLeft+' el.oW='+el.offsetWidth+' el.oT='+el.offsetTop+' el.oH='+el.offsetHeight+' '+position);bbox.x1=Math.min(bbox.x1,el.offsetLeft);var x2=el.offsetLeft+el.offsetWidth;bbox.x2=Math.max(bbox.x2,x2);bbox.y1=Math.min(bbox.y1,el.offsetTop);var y2=el.offsetTop+el.offsetHeight;bbox.y2=Math.max(bbox.y2,y2);});bbox.w=bbox.x2-bbox.x1;bbox.h=bbox.y2-bbox.y1;if(bbox.w==-1e+99){bbox.w=bbox.h=0;}
if(debug)w3_console.log(bbox,'w3_boundingBox_children');return bbox;}
function w3_center_in_window(el_id,id){var el=w3_el(el_id);var rv=window.innerHeight/2-el.clientHeight/2;return rv;}
function w3_field_select(el_id,opts){var el=w3_el(el_id);el=(el&&isFunction(el.select))?el:null;var trace=0;if(trace){var id=isObject(el_id)?el_id.id:el_id;console.log('w3_field_select id='+id+' el='+el+' v='+(el?el.value:null));console.log(el);console.log(opts);}
if(!el)return;var focus=0,select=0,blur=0;if(opts['mobile']&&kiwi_isMobile())blur=1;else focus=select=1;if(opts['blur'])blur=1;if(opts['focus_select'])focus=select=1;if(opts['focus_only']){focus=1;select=0;}
if(opts['select_only'])select=1;if(trace)console.log('w3_field_select focus='+focus+' select='+select+' blur='+blur);if(focus)el.focus();if(select)el.select();if(blur)el.blur();if(trace)kiwi_trace();}
function w3_add(el_id,props){if(!el_id)return null;var first_el=null;var el=w3_el(el_id);if(!el)return null;if(first_el)return;if(!el||!props)return null;props=props.replace(/\s+/g,' ').split(' ');props.forEach(function(p){el.classList.add(p);});if(!first_el)first_el=el;return first_el;}
function w3_remove(el_id,props){if(!el_id)return null;var first_el=null;var el=w3_el(el_id);if(!el)return null;if(!first_el)first_el=el;if(!el||!props)return null;props=props.replace(/\s+/g,' ').split(' ');props.forEach(function(p){el.classList.remove(p);});return first_el;}
function w3_match_wildcard(el_id,prefix){var el=w3_el(el_id);if(!el)return null;for(var i=0;i<el.classList.length;i++){var cl=el.classList.item(i);if(cl.startsWith(prefix))
return cl;}
return false;}
function w3_remove_wildcard(el_id,prefix){var el=w3_el(el_id);if(!el)return null;for(var i=0;i<el.classList.length;i++){var cl=el.classList.item(i);if(cl.startsWith(prefix))el.classList.remove(cl);}
return el;}
function w3_set_props(el_id,props,cond){var el=w3_el(el_id);if(!el)return el;cond=isArg(cond)?cond:true;if(cond)
w3_add(el,props);else
w3_remove(el,props);return el;}
function w3_remove_then_add(el_id,r_props,a_props){w3_remove(el_id,r_props);w3_add(el_id,a_props);}
function w3_remove_then_add_cond(el_id,cond,t_props,f_props){w3_remove(el_id,t_props+' '+f_props);w3_add(el_id,cond?t_props:f_props);}
function w3_contains(el_id,prop){var el=w3_el(el_id);if(!el)return 0;var clist=el.classList;return(!clist||!clist.contains(prop))?0:1;}
function w3_parent_with(el_id,prop){var el=w3_el(el_id);if(!el)return;var found=null;w3_iterate_parent(el,function(parent){if(!found&&w3_contains(parent,prop)){found=parent;}});return found;}
function w3_toggle(el_id,prop){var el=w3_el(el_id);if(!el)return;if(w3_contains(el,prop)){w3_remove(el,prop);}else{w3_add(el,prop);}
return el;}
function w3_appendAllClass(cname,prop){w3_iterate_classname(cname,function(el){el.classList.add(prop);});}
function w3_setAllHref(cname,href){w3_iterate_classname(cname,function(el){el.href=href;});}
function w3_show(el_id,display){var el=w3_el(el_id);if(!el)return el;w3_remove(el,'w3-hide');w3_add(el,display?display:'w3-show-inline-block');return el;}
function w3_create_attribute(el_id,name,val){var el=w3_el(el_id);if(el==null)return;var attr=document.createAttribute(name);attr.value=val;el.setAttributeNode(attr);}
function w3_attribute(el_id,name,val,cond){var el=w3_el(el_id);if(el==null)return null;if(isUndefined(cond)||cond==true)
el.setAttribute(name,val)
else
el.removeAttribute(name);}
function w3_show_block(el_id){return w3_show(el_id,'w3-show-block');}
function w3_show_inline_block(el_id){return w3_show(el_id,'w3-show-inline-block');}
function w3_show_inline(el_id){return w3_show(el_id,'w3-show-inline-new');}
function w3_show_table_cell(el_id){return w3_show(el_id,'w3-show-table-cell');}
function w3_hide(el_id){var el=w3_el(el_id);if(!el)return el;var el=w3_iterate_classList(el,function(className,idx){if(className.startsWith('w3-show-')){w3_remove(el,className);}});w3_add(el,'w3-hide');return el;}
function w3_hide2(el_id,cond){var el=w3_el(el_id);if(!el)return el;cond=isArg(cond)?cond:true;w3_set_props(el,'w3-hide',cond);return el;}
function w3_show_hide(el,show,display){var rv;if(show){rv=w3_show(el,display?display:'w3-show-block');}else{rv=w3_hide(el);}
return rv;}
function w3_show_hide_inline(el,show){w3_show_hide(el,show,'w3-show-inline-new');}
function w3_disable(el_id,disable){el=w3_el(el_id);w3_set_props(el,'w3-disabled',disable);if(isDefined(el.nodeName)&&(el.nodeName=='SELECT'||el.nodeName=='INPUT')){try{if(disable)
el.setAttribute('disabled','');else
el.removeAttribute('disabled');}catch(ex){console.log('w3_disable:Attribute');console.log(ex);}}
return el;}
function w3_visible(el_id,visible){var el=w3_el(el_id);el.style.visibility=visible?'visible':'hidden';return el;}
function w3_isVisible(el_id){var el=w3_el(el_id);if(!el)return null;return(el.style.visibility=='visible');}
var w3_highlight_time=250;var w3_highlight_color='w3-selection-green';var w3_selection_green='#4CAF50';function w3_highlight(el_id){var el=w3_el(el_id);w3_add(el,el.w3int_highlight_color||w3_highlight_color);}
function w3_unhighlight(el_id){var el=w3_el(el_id);w3_remove(el,el.w3int_highlight_color||w3_highlight_color);}
function w3_isHighlighted(el_id){var el=w3_el(el_id);return w3_contains(el,el.w3int_highlight_color||w3_highlight_color);}
function w3_schedule_highlight(el_id){var el=w3_el(el_id);w3_highlight(el);setTimeout(function(){w3_unhighlight(el);},w3_highlight_time);}
function w3_set_highlight_color(el_id,color){var el=w3_el(el_id);if(!el)return null;if(w3_isHighlighted(el)){w3_unhighlight(el);el.w3int_highlight_color=color;w3_highlight(el);}else{el.w3int_highlight_color=color;}
return el;}
var w3_flag_color='w3-override-yellow';function w3_flag(path){w3_add(w3_el(path),w3_flag_color);}
function w3_unflag(path){w3_remove(w3_el(path),w3_flag_color);}
function w3_color(el_id,color,bkgColor,cond){var el=w3_el(el_id);if(!el)return null;var prev_fg=el.style.color;var prev_bg=el.style.backgroundColor;cond=(isUndefined(cond)||cond);if(isArg(color))el.style.color=cond?color:'';if(isArg(bkgColor))el.style.backgroundColor=cond?bkgColor:'';return{color:prev_fg,backgroundColor:prev_bg};}
function w3_background_color(el_id,color){var el=w3_el(el_id);var prev=el.style.backgroundColor;if(color!=undefined&&color!=null)el.style.backgroundColor=color;return prev;}
function w3_colors(el_id,c1,c2,cond){var el=w3_el(el_id);if(!el)return null;cond=isArg(cond)?cond:true;var fg1=null,bg1=null;if(isArray(c1)){if(c1.length>0)fg1=c1[0];if(c1.length>1)bg1=c1[1];}else
if(isString(c1)){fg1=c1;}else{return null;}
if(fg1.startsWith('w3-')){w3_remove(el,fg1);if(!cond)w3_add(el,fg1);}else{if(!cond)el.style.color=fg1;}
if(bg1){el.style.backgroundColor=bg1;}
var fg2=null,bg2=null;if(isArray(c2)){if(c2.length>0)fg2=c2[0];if(c2.length>1)bg2=c2[1];}else
if(isString(c2)){fg2=c2;}else{return null;}
if(fg2.startsWith('w3-')){w3_remove(el,fg2);if(cond)w3_add(el,fg2);}else{if(cond)el.style.color=fg2;}
if(bg2){el.style.backgroundColor=bg2;}}
function w3_flip_colors(el_id,colors,cond){var el=w3_el(el_id);if(!el)return null;var ar=colors?colors.split(' '):null;if(!ar||ar.length!=2)return null;w3_remove(el,ar[0]);w3_remove(el,ar[1]);w3_add(el,ar[cond?1:0]);}
function w3_fg_color_with_opacity_against_bk_color(fg,opacity,bg){var fg_color=w3color(fg);if(!fg_color.valid)return null;var bg_color=w3color(bg);if(!bg_color.valid)return null;var _opacity=1-opacity;var red=Math.round(opacity*fg_color.red+_opacity*bg_color.red);var green=Math.round(opacity*fg_color.green+_opacity*bg_color.green);var blue=Math.round(opacity*fg_color.blue+_opacity*bg_color.blue);return w3color(kiwi_rgb(red,green,blue));}
function w3_opacity(el_id,opacity){var el=w3_el(el_id);if(!el)return null;el.style.opacity=opacity;}
function w3_flash_fade(el_id,color,dwell_ms,fade_ms,color2){var el=w3_el(el_id);if(!el)return el;el.style.transition='background 0s';el.style.background=color;setTimeout(function(){el.style.transition='background '+(fade_ms?(fade_ms/1000):0.3)+'s linear';el.style.background=isString(color2)?color2:'black';},dwell_ms?dwell_ms:50);return el;}
function w3_fillText_shadow(canvas,text,x,y,font,fontSize,color,strokeWidth){strokeWidth=strokeWidth||Math.floor(fontSize / 3);var ctx=canvas.getContext("2d");ctx.font=px(fontSize)+' '+font;ctx.miterLimit=2;ctx.lineJoin="circle";ctx.strokeStyle="black";ctx.lineWidth=strokeWidth;ctx.strokeText(text,x,y);ctx.fillStyle=color;ctx.lineWidth=1;ctx.fillText(text,x,y);};function w3_fillText(ctx,x,y,text,color,font,lineWidth,align,baseline){if(color)ctx.fillStyle=color;if(font)ctx.font=font;if(lineWidth)ctx.lineWidth=lineWidth;if(align)ctx.textAlign=align;if(baseline)ctx.textBaseline=baseline;var tw=ctx.measureText(text).width;ctx.fillText(text,x-tw/2,y);}
function w3_check_restart_reboot(el_id){var el=w3_el(el_id);if(!el)return;w3_iterate_parent(el,function(el){if(w3_contains(el,'w3-restart')){w3_restart_cb();return el;}
if(w3_contains(el,'w3-reboot')){w3_reboot_cb();return el;}
return null;});}
function w3_set_value(path,val){path=w3_add_id(path);if(1){w3_els(path,function(el){if(el)el.value=val;});}else{var el=w3_el(path);if(el)el.value=val;}}
function w3_set_decoded_value(path,val){w3_set_value(path,kiwi_decodeURIComponent('w3_set_decoded_value:'+path,val));}
function w3_get_value(path){var el=w3_el(path);if(!el)return null;return el.value;}
function w3_add_toplevel(path){if(!path.startsWith('cfg.')&&!path.startsWith('adm.'))
return'cfg.'+path;return path;}
function w3_not_toplevel(path){if(path.startsWith('cfg.')||path.startsWith('adm.'))
return path.substr(path.indexOf('.')+1);return path;}
function w3_basename(path){var i=path.lastIndexOf('.');if(i>=0){return path.substr(i+1);}
return path;}
function w3_psa3(psa3){psa3=psa3||'';a=psa3.split('/');var a0=(a[0]||'').replace(/&slash;/g,'/');var a1=(a[1]||'').replace(/&slash;/g,'/');var a2=(a[2]||'').replace(/&slash;/g,'/');if(a.length==1)
return{left:'',middle:'',right:a0};else
if(a.length==2)
return{left:'',middle:a0,right:a1};else
if(a.length==3)
return{left:a0,middle:a1,right:a2};else
return{left:'',middle:'',right:''};}
function w3_sb(){var a=[];for(var i=0;i<arguments.length;i++){var s=arguments[i];s=isString(s)?s.trim():(isNumber(s)?s.toString():'');if(s!='')a.push(s);}
return a.length?a.join(' '):'';}
function w3_sbc(c){var a=[];for(var i=1;i<arguments.length;i++){var s=arguments[i];s=isString(s)?s.trim():(isNumber(s)?s.toString():'');if(s!='')a.push(s);}
return a.length?a.join(c):'';}
function w3_sbew(ew){var a=[];for(var i=1;i<arguments.length;i++){var s=arguments[i];s=isString(s)?s.trim():(isNumber(s)?s.toString():'');if(s!=''){if(s[s.length-1]!=ew)s=s+ew;a.push(s);}}
return a.length?a.join(' '):'';}
function w3_nl(s){if(isArg(s)&&s!='')s+='\n';return s;}
function w3_br(s){if(isArg(s)&&s!='')s+='<br>';return s;}
function w3_psa(psa,extra_prop,extra_style,extra_attr){if(psa&&psa.startsWith('class=')){return psa;}
var a=psa?psa.split('|'):[];psa='';var prop=a[0]||'';if(extra_prop)prop=w3_sb(prop,extra_prop);if(prop!='')psa='class='+dq(prop);var style=a[1]||'';if(extra_style)style=w3_sbew(';',style,extra_style);if(style!='')psa=w3_sb(psa,'style='+dq(style));var attr=(a[2]||'').replace(/&vbar;/g,'|');if(extra_attr)attr=w3_sb(attr,extra_attr);if(attr!='')psa=w3_sb(psa,attr);return psa;}
function w3_psa_mix(psa,extra_prop,extra_style,extra_attr){var dump=psa.includes('w3-dump');if(dump)console.log('--- w3_psa_mix psa='+psa);var a=psa?psa.split('|'):[];var prop=a[0]||'';if(dump)console.log('prop=['+prop+']');if(dump)console.log('extra_prop=['+extra_prop+']');if(extra_prop)prop=w3_sb(prop,extra_prop);if(dump)console.log('mixed prop=['+prop+']');var style=a[1]||'';if(dump)console.log('style=['+style+']');if(dump)console.log('extra_style=['+extra_style+']');if(extra_style)style=w3_sbew(';',style,extra_style);if(dump)console.log('mixed style=['+style+']');var attr=a[2]||'';if(dump)console.log('attr=['+attr+']');if(dump)console.log('extra_attr=['+extra_attr+']');if(extra_attr)attr=w3_sb(attr,extra_attr);if(dump)console.log('mixed attr=['+attr+']');psa=prop+'|'+style+'|'+attr;if(dump)console.log('mix_out=['+psa+']');return psa;}
function w3_set_psa(el,psa){var el=w3_el(el);if(!el||!isNonEmptyString(psa))return null;psa=psa.split('/')[0];psa=psa.split('|');var _class=psa[0];var _style=psa[1];var _attr=psa[2];if(isArg(_class))w3_add(el,_class);if(isArg(_style))el.style=_style;}
function w3int_init(){}
function w3int_post_action(){w3_call('freqset_select');}
function w3_copy_to_clipboard(val){var el=document.createElement("input");el.setAttribute('type','text');el.setAttribute('value',val);document.body.appendChild(el);el.select();document.execCommand("copy");document.body.removeChild(el);}
function w3_isScrolling(id){var el=w3_el(id);if(!el)return null;return(el.scrollHeight>el.clientHeight)}
function w3_isScrolledDown(id){var el=w3_el(id);if(!el)return null;return(Math.abs(el.scrollHeight-el.clientHeight-el.scrollTop)<1)}
function w3_scrolledPosition(id){var el=w3_el(id);if(!el)return null;if(el.clientHeight==0)return-1;var scrollH=el.scrollHeight-el.clientHeight;if(scrollH<=0)return 0;return el.scrollTop / scrollH;}
function w3_scrollTo(id,pos,jog){var el=w3_el(id);if(!el)return null;var scrollH=el.scrollHeight-el.clientHeight;if(scrollH<0)scrollH=0;var top=scrollH*pos;var unchanged=(top==el.scrollTop);el.scrollTop=top;if(jog==true){el.scrollTop=top+1;el.scrollTop=top;}
return unchanged;}
function w3_scrollDown(id,cond){var el=w3_el(id);if(isArg(cond)?cond:true)el.scrollTop=el.scrollHeight;return el;}
function w3_scrollTop(id,cond){var el=w3_el(id);if(isArg(cond)?cond:true)el.scrollTop=0;return el;}
function w3_do_when_rendered(id,func,arg,poll_ms){var el=w3_el(id);poll_ms=isNumber(poll_ms)?poll_ms:500;if(isNoArg(el)){setTimeout(function(){w3_do_when_rendered(id,func,arg,poll_ms);},poll_ms);}else{if(isFunction(func))
func(el,arg);}}
function w3_do_when_cond(cond_func,func,arg,poll_ms){poll_ms=isNumber(poll_ms)?poll_ms:500;if(!cond_func(arg)){setTimeout(function(){w3_do_when_cond(cond_func,func,arg,poll_ms);},poll_ms);}else{if(isFunction(func))
func(arg);}}
function w3_elementAtPointer(x,y){if(isObject(x)){var evt=x;x=evt.pageX;y=evt.pageY;}
if(isNumber(x)&&isNumber(y)){return document.elementFromPoint(x,y);}
return null;}
function w3_hr(psa){var p=w3_psa(psa);var s='<hr '+p+'>';var narg=arguments.length;for(var i=1;i<narg;i++){s+=arguments[i];}
return s;}
function w3_click_nav(next_id,cb_next,cb_param){var next_id_nav='id-nav-'+next_id;var cur_id=null;var next_el=null;var cb_prev=null;w3_iterate_children(w3_el(next_id_nav).parentNode,function(el,i){if(el.nodeName!='A')return;if(w3_contains(el,'w3int-cur-sel')){cur_id=el.id.substring(7);w3_remove(el,'w3int-cur-sel');w3_iterate_classList(el,function(s,i){if(s.startsWith('id-nav-cb-'))
cb_prev=s.substring(10);});}
if(el.id==next_id_nav){next_el=el;}});if(cur_id)
w3_toggle(cur_id,'w3-show-block');if(cur_id&&cb_prev){w3_call(cb_prev+'_blur',cur_id);}
if(next_el){w3_add(next_el,'w3int-cur-sel');w3_check_restart_reboot(next_el);}
w3_toggle(next_id,'w3-show-block');if(cb_next!='null'){w3_call(cb_next+'_focus',next_id,cb_param);}}
function w3int_anchor(psa,text,id,cb,isSelected){if(cb===undefined)cb=id;var nav_cb=cb?('id-nav-cb-'+cb):'';var attr='id="id-nav-'+id+'" onclick="w3_click_nav('+sq(id)+', '+sq(cb)+')"';var p=w3_psa(psa,nav_cb+(isSelected?' w3int-cur-sel':''),'',attr);var s='<a '+p+' href="javascript:void(0)">'+text+'</a>';return s;}
function w3_navbar(psa){var p=w3_psa(psa,'w3-navbar');var s='<nav '+p+'>';var narg=arguments.length;for(var i=1;i<narg;i++){s+=arguments[i];}
s+='</nav>';return s;}
function w3_sidenav(psa){var p=w3_psa(psa,'w3-sidenav w3-static w3-left w3-sidenav-full-height w3-light-grey');var s='<nav '+p+'>';var narg=arguments.length;for(var i=1;i<narg;i++){s+=arguments[i];}
s+='</nav>';return s;}
function w3_nav(psa,text,id,cb,isSelected){return w3int_anchor(psa,text,id,cb,isSelected);}
function w3_navdef(psa,text,id,cb){setTimeout(function(){w3_toggle(id,'w3-show-block');},w3_highlight_time);return w3int_anchor(psa,text,id,cb,true);}
function w3_label(psa,text,path,extension){if(arguments.length>=4)console.log('### w3_label ext='+extension);psa=psa||'';text=text||'';extension=extension||'';if(psa==''&&text==''&&extension=='')return'';if(text.startsWith('<label '))return text;var id=w3_add_id(path,'-label');var p=w3_psa(psa,id);var s='<label '+p+'>'+text+extension+'</label>';return s;}
function w3_get_label(label,path){return w3_get_innerHTML(w3_add_id(path,'-label'));}
function w3_set_label(label,path){w3_innerHTML(w3_add_id(path,'-label'),label);}
function w3_title(id,text){var el=w3_el(id);if(!el)return null;w3_attribute(el,'title',text);return el;}
function w3int_link_click(ev,cb,cb_param){var el=ev.currentTarget;w3_check_restart_reboot(el);if(cb){w3_call(cb,el,cb_param,false);}
w3int_post_action();}
function w3_link(psa,url,inner,title,cb,cb_param){var qual_url=url;var href='';var target='';if(url!=''){if(!url.startsWith('javascript:')){if(!url.startsWith('http://')&&!url.startsWith('https://'))
qual_url='http://'+url;target=' target="_blank"';}
href='href='+dq(qual_url)+' ';}
inner=inner||'';title=title||'';if(title!='')title=' title='+dq(title);var pointer=(cb&&cb!='')?'w3-pointer':'';cb_param=cb_param||0;var onclick=cb?(' onclick="w3int_link_click(event, '+sq(cb)+', '+sq(cb_param)+')"'):'';var p=w3_psa(psa,pointer,'',href+target+title+onclick);var esc_html=psa.includes('w3-esc-html');var lt=esc_html?kiwi.esc_lt:'<';var gt=esc_html?kiwi.esc_gt:'>';var s=lt+'a '+p+gt+inner+lt+'/a'+gt;return s;}
function w3_link_set(path,url){var el=w3_el(path);if(el&&url!=''){if(!url.startsWith('http://')&&!url.startsWith('https://'))
url='http://'+url;w3_attribute(el,'href',url);w3_attribute(el,'target','_blank');}}
function w3_img_wh(src,func){var img=new Image();img.onload=function(){func(this.width,this.height);};img.src=src;}
var w3_SELECTED=true;var w3_NOT_SELECTED=false;function w3_radio_unhighlight(path){w3_iterate_classname(w3_add_id(path),function(el){w3_unhighlight(el);});}
function w3int_radio_click(ev,path,cb,cb_param){w3_radio_unhighlight(path);w3_highlight(ev.currentTarget);var idx=-1;w3_iterate_classname(w3_add_id(path),function(el,i){if(w3_isHighlighted(el))
idx=i;});w3_check_restart_reboot(ev.currentTarget);if(cb){w3_call(cb,path,idx,false,cb_param);}
w3int_post_action();}
function w3_radio_btn(text,path,isSelected,save_cb,prop){var prop=(arguments.length>4)?arguments[4]:null;var _class=' id-'+path+(isSelected?(' '+w3_highlight_color):'')+(prop?(' '+prop):'');var oc='onclick="w3int_radio_click(event, '+sq(path)+', '+sq(save_cb)+')"';var s='<button class="w3-btn w3-ext-btn'+_class+'" '+oc+'>'+text+'</button>';return s;}
function w3_radio_button(psa,text,path,isSelected,cb,cb_param){cb_param=cb_param||0;var onclick=cb?('onclick="w3int_radio_click(event, '+sq(path)+', '+sq(cb)+', '+sq(cb_param)+')"'):'';var p=w3_psa(psa,w3_add_id(path)+(isSelected?(' '+w3_highlight_color):'')+' w3-btn w3-ext-btn','',onclick);var s='<button '+p+'>'+text+'</button>';return s;}
function w3_radio_button_get_param(psa,text,path,selected_if_val,init_val,cb,cb_param){var cur_val=ext_get_cfg_param(path,(init_val==undefined)?null:init_val);var isSelected=(cur_val==selected_if_val)?w3_SELECTED:w3_NOT_SELECTED;return w3_radio_button(psa,text,path,isSelected,cb,cb_param);}
var w3_SWITCH_YES_IDX=0,w3_SWITCH_NO_IDX=1;function w3_switch(psa,text_0,text_1,path,text_0_selected,cb,cb_param){var s=w3_radio_button(w3_psa_mix(psa,'w3int-switch-0'),text_0,path,text_0_selected?1:0,cb,cb_param)+
w3_radio_button(w3_psa_mix(psa,'w3int-switch-1'),text_1,path,text_0_selected?0:1,cb,cb_param);return s;}
function w3_switch_label(psa,label,text_0,text_1,path,text_0_selected,cb,cb_param){var hasLabel=(label!='');var inline=psa.includes('w3-label-inline');var centered=psa.includes('w3-center');var left=psa.includes('w3-label-left');var bold=!psa.includes('w3-label-not-bold');var spacing=(hasLabel&&!inline)?'w3-margin-T-8':'';if(hasLabel&&inline)spacing+=left?' w3-margin-L-8':' w3-margin-R-8';if(centered)spacing+=' w3-halign-center';var psa3=w3_psa3(psa);var psa_outer=w3_psa_mix(psa3.left,(inline?'w3-show-inline-new':'')+(centered?' w3-halign-center w3-center':''));var psa_label=w3_psa_mix(psa3.middle,(hasLabel&&bold)?'w3-bold':'');var psa_inner=w3_psa();var ls=w3_label(psa_label,label,path);var cs=w3_inline(spacing+'/'+psa3.right,w3_radio_button('w3int-switch-0',text_0,path,text_0_selected?1:0,cb,cb_param)+
w3_radio_button('w3int-switch-1',text_1,path,text_0_selected?0:1,cb,cb_param));var s=w3_div(psa_outer,((left||!inline)?(ls+cs):(cs+ls)));return s;}
function w3_switch_get_param(psa,text_0,text_1,path,text_0_selected_if_val,init_val,cb,cb_param){var cur_val=ext_get_cfg_param(path,(init_val==undefined)?null:init_val);var text_0_selected=(cur_val==text_0_selected_if_val)?w3_SELECTED:w3_NOT_SELECTED;return w3_switch(psa,text_0,text_1,path,text_0_selected,cb,cb_param);}
function w3_switch_label_get_param(psa,label,text_0,text_1,path,text_0_selected_if_val,init_val,cb,cb_param){var cur_val=ext_get_cfg_param(path,(init_val==undefined)?null:init_val);var text_0_selected=(cur_val==text_0_selected_if_val)?w3_SELECTED:w3_NOT_SELECTED;return w3_switch_label(psa,label,text_0,text_1,path,text_0_selected,cb,cb_param);}
function w3_switch_set_value(path,switch_idx){var sw='w3int-switch-'+switch_idx;w3_iterate_classname(path,function(el,i){if(w3_contains(el,sw)){el.click();}});}
function w3_switch_idx(val){return(val?w3_SWITCH_YES_IDX:w3_SWITCH_NO_IDX);}
function w3int_btn_evt(ev,path,cb,cb_param){if(!w3_contains(path,'w3-disabled')){w3_check_restart_reboot(ev.currentTarget);var el=w3_el(path);var hold=w3_contains(el,'w3-hold');if(hold){if(ev.type=='mousedown'||ev.type=='touchstart'){el.hold_triggered=false;el.hold_timeout=setTimeout(function(){el.hold_triggered=true;if(cb){w3_call(cb,path,cb_param,false,{type:'hold'});}},500);return ignore(ev);}else{if((ev.type=='click'||ev.type=='touchend')&&isArg(el.hold_timeout)){var timeout=el.hold_timeout;var triggered=el.hold_triggered;el.hold_timeout=null;el.hold_triggered=false;kiwi_clearTimeout(timeout);if(triggered){if(w3_contains(el,'w3-hold-done')){w3_call(cb,path,cb_param,false,{type:'hold-done'});}
w3int_post_action();return ignore(ev);}}}}
if(cb){w3_call(cb,path,cb_param,false,ev);}}
w3int_post_action();}
var w3int_btn_grp_uniq=0;function w3_btn(text,cb){console.log('### DEPRECATED: w3_btn');return w3_button('',text,cb);}
function w3_cb_param_encode(cbp){if(isNoArg(cbp)){return 0;}
if(isObject(cbp)){return encodeURIComponent(JSON.stringify(cbp));}
return cbp;}
function w3_cb_param_decode(cbp){if(isNoArg(cbp)){return 0;}
if(isString(cbp)){cbp=decodeURIComponent(cbp);var obj;if(cbp[0]=='{'){try{obj=JSON.parse(cbp);}catch(ex){return cbp;}
return obj;}}
return cbp;}
function w3int_button(psa,path,text,cb,cb_param){var momentary=psa.includes('w3-momentary');var hold=psa.includes('w3-hold');var custom_events=psa.includes('w3-custom-events');cb_param=w3_cb_param_encode(cb_param);var ev_cb=function(cbp){return sprintf('"w3int_btn_evt(event,%s,%s,%s);"',sq(path),sq(cb),sq(cbp));}
var onclick=cb?('onclick='+ev_cb(cb_param)):'';if(cb&&momentary&&!hold&&!custom_events){onclick+=' onmousedown='+ev_cb(0);onclick+=' ontouchstart='+ev_cb(0);}else
if(cb&&hold&&!momentary&&!custom_events){onclick+=' onmousedown='+ev_cb(cb_param);onclick+=' ontouchstart='+ev_cb(cb_param);onclick+=' ontouchend='+ev_cb(cb_param);}else
if(cb&&(custom_events||hold)&&!momentary){onclick+=' onmouseenter='+ev_cb(cb_param);onclick+=' onmouseleave='+ev_cb(cb_param);onclick+=' onmousedown='+ev_cb(cb_param);onclick+=' onmousemove="ignore(event);"';onclick+=' onmouseup="ignore(event);"';onclick+=' ontouchstart='+ev_cb(cb_param);onclick+=' ontouchmove="ignore(event);"';onclick+=' ontouchend='+ev_cb(cb_param);}
var default_style=(psa.includes('w3-round')||psa.includes('w3-circle'))?'':' w3-round-large';var noactive=psa.includes('w3-noactive')?' class-button-noactive w3-ext-btn-noactive':'';var psa3=w3_psa3(psa);var psa_outer=w3_psa(psa3.left);var psa_inner=w3_psa(psa3.right,path+' w3-btn w3-ext-btn'+default_style+noactive,'',onclick);if(psa.includes('w3-dump')){console.log('w3_button');console.log(psa3);console.log('psa_outer='+psa_outer);console.log('psa_inner='+psa_inner);}
var s='<button '+psa_inner+'>'+text+'</button>';if(psa_outer!='')s='<div '+psa_outer+'>'+s+'</div>';if(psa_outer.includes('w3-dump'))console.log(s);return s;}
function w3_button(psa,text,cb,cb_param){var path='id-btn-grp-'+w3int_btn_grp_uniq.toString();w3int_btn_grp_uniq++;return w3int_button(psa,path,text,cb,cb_param);}
function w3_button_path(psa,path,text,cb,cb_param){return w3int_button(psa,path,text,cb,cb_param);}
function w3_button_text(path,text,color_or_add_color,remove_color){var el=w3_el(path);if(!el)return null;if(isArg(text))
el.innerHTML=text;if(color_or_add_color){if(color_or_add_color.startsWith('w3-')){w3_remove(el,remove_color);w3_add(el,color_or_add_color);}else
el.style.color=color_or_add_color;}
return el;}
function w3_icon(psa,fa_icon,size,color,cb,cb_param){var momentary=psa.includes('w3-momentary');var hold=psa.includes('w3-hold');var custom_events=psa.includes('w3-custom-events');var pointer=(cb&&cb!='')?' w3-pointer':'';var path='id-btn-grp-'+w3int_btn_grp_uniq.toString();w3int_btn_grp_uniq++;var font_size=null;if(isNumber(size)&&size>=0)font_size=px(size);else
if(isString(size))font_size=size;font_size=font_size?(' font-size:'+font_size+';'):'';color=color||'';var c=color.split('|');color='';if(c[0]!='')color=' color:'+c[0]+';';if(c.length>=2&&c[1]!='')color+=' background-color:'+c[1]+';';cb_param=w3_cb_param_encode(cb_param);var ev_cb=function(cbp){return sprintf('"w3int_btn_evt(event, %s, %s, %s)"',sq(path),sq(cb),sq(cbp));}
var onclick=cb?('onclick='+ev_cb(cb_param)):'';if(cb&&(momentary||hold)&&!custom_events){if(momentary)cb_param=0;onclick+=' onmousedown='+ev_cb(cb_param);onclick+=' ontouchstart='+ev_cb(cb_param);}else
if(cb&&(custom_events||hold)&&!momentary){onclick+=' onmouseenter='+ev_cb(cb_param);onclick+=' onmouseleave='+ev_cb(cb_param);onclick+=' onmousedown="ignore(event)"';onclick+=' onmousemove="ignore(event)"';onclick+=' onmouseup="ignore(event)"';onclick+=' ontouchstart='+ev_cb(cb_param);onclick+=' ontouchmove="ignore(event)"';onclick+=' ontouchend='+ev_cb(cb_param);}
var p=w3_psa(psa,path+pointer+' fa '+fa_icon,font_size+color,onclick);var s='<i '+p+'></i>';return s;}
function w3_spin(el,cond){var el=w3_el(el);if(!el)return null;cond=isArg(cond)?cond:true;w3_remove_then_add(el,'fa-spin',cond?'fa-spin':'');}
function w3int_input_keydown(ev,path,cb){var i,s;var k=ev.key.toUpperCase();var ctrl=ev.ctrlKey;var el=w3_el(path);if(!el)return;var input_any_key=w3_contains(el,'w3-input-any-key');var input_any_change=w3_contains(el,'w3-input-any-change');var disabled=w3_parent_with(el,'w3-disabled');var trace=w3_contains(el,'w3-trace');if(trace)console.log('w3int_input_keydown k='+k+(ctrl?' CTRL ':'')+' val=<'+el.value+'> cb='+cb+' disabled='+disabled);var cb_a=cb.split('|');if(disabled){if(trace)console.log('w3int_input_keydown w3-disabled');return;}
if(input_any_key&&cb_a[1]){w3_call(cb_a[1],ev,true);}
if(ev.key=='Enter'){if(input_any_change){s=el.value;for(i=el.selectionStart;i<el.textLength;i++){if(s.charAt(i)!='\n')
break;}
if(i==el.textLength){while(s.endsWith('\n'))
s=s.slice(0,-1);w3_set_value(el,s);}
if(trace)console.log('ss='+el.selectionStart+' se='+el.selectionEnd+' tl='+el.textLength);if((el.selectionStart==el.selectionEnd&&el.selectionStart==el.textLength)||(el.selectionStart==0&&el.selectionEnd==el.textLength)){if(trace)console.log('w3_input_change...');w3_input_change(path,cb,'kd');}}else
if(el.value==''){w3_input_change(path,cb,'kd');}}
if(ev.key=='Backspace'&&input_any_change&&el.selectionStart==0&&el.selectionEnd==el.value.length){el.value='';w3_input_change(path,cb,'kd');}}
function w3int_input_keyup(ev,path,cb){}
function w3_input_process(ev){var a=ev.detail.split('|');var path=a[0];var cb=a[1];var el=w3_el(path);if(el){var trace=w3_contains(el,'w3-trace');if(trace)console.log('w3_input_process path='+path+' val='+el.value+' cb='+cb);w3_input_change(path,cb,'w3_input_process');}}
function w3_input_change(path,cb,from){var el=w3_el(path);if(el){var trace=w3_contains(el,'w3-trace');if(trace)console.log('w3_input_change path='+path);w3_check_restart_reboot(el);w3_schedule_highlight(el);if(cb){var cb_a=cb.split('|');if(isArg(from))cb_a.push(from);w3_call(cb_a[0],path,el.value,false,cb_a);}}
if(w3_contains(el,'w3-retain-input-focus')||w3_contains(el,'w3-ext-retain-input-focus'))
w3_field_select(path,{mobile:1});else
w3int_post_action();}
function w3int_input_up_down_cb(path,cb_param,first,ev){if(ev.type!='click'&&ev.type!='touch')return;var cb_a=cb_param.split('|');var delta=+cb_a[0];var id_s=cb_a[1];var cb_s=cb_a[2];var val=+w3_el(id_s).value+delta;w3_input_force(id_s,cb_s,val.toFixed(0))}
function w3_input(psa,label,path,val,cb,placeholder){var dump=psa.includes('w3-dump');var id=w3_add_id(path);cb=cb||'';var phold=placeholder?('placeholder="'+placeholder+'"'):'';var custom=psa.includes('w3-custom-events');var onchange=' onchange="w3_input_change('+sq(path)+', '+sq(cb)+', '+sq('ev')+')"';var onkeydown=' onkeydown="w3int_input_keydown(event, '+sq(path)+', '+sq(cb)+')"';var onkeyup=' onkeyup="w3int_input_keyup(event, '+sq(path)+', '+sq(cb)+')"';var events=(path&&!custom)?(onchange+onkeydown+onkeyup):'';val=' value='+dq(w3_esc_dq(val)||'');var inline=psa.includes('w3-label-inline');var bold=!psa.includes('w3-label-not-bold');label=label||'';var label_spacing=(label!=''&&inline)?'w3int-margin-input':'';var psa3=w3_psa3(psa);if(dump)console.log(psa3);var psa_outer=w3_psa(psa3.left,inline?'w3-show-inline-new':'');var psa_label=w3_psa_mix(psa3.middle,(label!=''&&bold)?'w3-bold':'');var style=psa.includes('w3-no-styling')?'':'w3-input w3-border w3-hover-shadow';var type=psa3.right.includes('type=')?'':'type="text"';var psa_inner=w3_psa(psa3.right,w3_sb(id,style,label_spacing),'',w3_sb(type,phold));if(dump)console.log('O:['+psa_outer+'] L:['+psa_label+'] I:['+psa_inner+']');var in_s='<input id='+dq(id)+' '+psa_inner+val+events+'>';var cb_s='|'+id+'|'+cb;if(psa.includes('w3-up-down')){in_s=w3_inline('',w3_div('w3-flex-col w3-margin-R-4',w3_icon('w3-momentary w3-pointer w3-margin-B-1||title="up"','fa-arrow-up',15,'orange','w3int_input_up_down_cb','1'+cb_s),w3_icon('w3-momentary w3-pointer w3-margin-T-1||title="down"','fa-arrow-down',15,'cyan','w3int_input_up_down_cb','-1'+cb_s)),in_s);}
var s='<div '+psa_outer+'>'+
w3_label(psa_label,label,path)+
in_s+'</div>';return s;}
function w3_input_force(path,cb,input){var el=w3_el(path);if(!el)return;el.addEventListener('input',w3_input_process,true);el.value=input.replace('&vbar;','|');el.dispatchEvent(new CustomEvent('input',{detail:path+'|'+cb}));el.removeEventListener('input',w3_input_process,true);}
function w3_input_get(psa,label,path,cb,init_val,placeholder){var cur_val=ext_get_cfg_param(path,(init_val==undefined)?null:init_val);cur_val=kiwi_decodeURIComponent('w3_input_get:'+path,cur_val);return w3_input(psa,label,path,cur_val,cb,placeholder);}
function w3_input_get_param(label,path,cb,init_val,placeholder){var cur_val=ext_get_cfg_param(path,(init_val==undefined)?null:init_val);cur_val=kiwi_decodeURIComponent('w3_input_get_param:'+path,cur_val);return w3_input('',label,path,cur_val,cb,placeholder);}
function w3_textarea(psa,label,path,val,rows,cols,cb){var id=w3_add_id(path);var spacing=(label!='')?' w3-margin-T-8':'';var custom=psa.includes('w3-custom-events');var onchange=psa.includes('w3-input-any-change')?'':(' onchange="w3_input_change('+sq(path)+', '+sq(cb)+')"');var onkeydown=' onkeydown="w3int_input_keydown(event, '+sq(path)+', '+sq(cb)+')"';var onkeyup=' onkeyup="w3int_input_keyup(event, '+sq(path)+', '+sq(cb)+')"';var events=(path&&!custom)?(onchange+onkeydown+onkeyup):'';var val=val||'';var bold=!psa.includes('w3-label-not-bold');var psa3=w3_psa3(psa);var psa_label=w3_psa_mix(psa3.middle,(label!=''&&bold)?'w3-bold':'');var psa_inner=w3_psa(psa3.right,'w3-input w3-border w3-hover-shadow '+id+spacing,'','rows='+dq(rows)+' cols='+dq(cols));var s=w3_div(psa3.left,w3_label(psa_label,label,path)+'<textarea '+psa_inner+events+'>'+val+'</textarea>');if(psa.includes('w3-dump'))console.log('s='+s);return s;}
function w3_textarea_get_param(psa,label,path,rows,cols,cb,init_val){var cur_val=ext_get_cfg_param(path,(init_val==undefined)?null:init_val);cur_val=kiwi_decodeURIComponent('w3_textarea_get_param:'+path,cur_val);return w3_textarea(psa,label,path,cur_val,rows,cols,cb);}
function w3int_checkbox_change(path,cb,cb_param){var el=w3_el(path);w3_check_restart_reboot(el);if(cb){w3_schedule_highlight(el);w3_call(cb,path,el.checked,false,cb_param);}
if(w3_contains(el,'w3-retain-input-focus')||w3_contains(el,'w3-ext-retain-input-focus'))
w3_field_select(path,{mobile:1});else
w3int_post_action();}
function w3_checkbox(psa,label,path,checked,cb,cb_param){var id=w3_add_id(path);var onchange=' onchange="w3int_checkbox_change('+sq(path)+', '+sq(cb)+', '+sq(cb_param)+')"';var checked_s=checked?' checked':'';var inline=psa.includes('w3-label-inline');var left=psa.includes('w3-label-left');var bold=!psa.includes('w3-label-not-bold');var spacing=(label!=''&&inline)?(left?' w3-margin-L-8':' w3-margin-R-8'):'';var psa3=w3_psa3(psa);var psa_outer=w3_psa(psa3.left,inline?'w3-show-inline-new':'');var psa_label=w3_psa_mix(psa3.middle,(label!=''&&bold)?'w3-bold':'');var psa_inner=w3_psa(psa3.right,'w3-input w3-width-auto w3-border w3-pointer w3-hover-shadow '+id+spacing,'','type="checkbox"');var ls=w3_label(psa_label,label,path);var cs='<input '+psa_inner+checked_s+onchange+'>';var s='<div '+psa_outer+'>'+
(left?(ls+cs):(cs+ls))+'</div>';if(cb)
setTimeout(function(){w3_call(cb,path,checked,true,cb_param);},500);return s;}
function w3_checkbox_get_param(psa,label,path,cb,init_val){var update_path_var=psa.includes('w3-update');var cur_val=ext_get_cfg_param(path,(init_val==undefined)?null:init_val,undefined,update_path_var);return w3_checkbox(psa,label,path,cur_val,cb);}
function w3_checkbox_get(path){var el=w3_el(path);if(!el)return;return(el.checked?true:false);}
function w3_checkbox_set(path,checked){var el=w3_el(path);if(!el)return;el.checked=checked?true:false;}
var W3_SELECT_SHOW_TITLE=-1;function w3int_select_change(ev,path,cb,cb_param){var el=ev.currentTarget;w3_check_restart_reboot(el);if(cb){w3_call(cb,path,el.value,false,cb_param);}
w3int_post_action();}
function w3int_select(psa,label,title,path,sel,opts_s,cb,cb_param){var id=w3_add_id(path);var first='';if(title!=''){var as=title.split('<br>');as.forEach(function(s,i){first+='<option value="-1" '+((sel==W3_SELECT_SHOW_TITLE&&i==0)?'selected':'')+' disabled>'+s+'</option>';});}else{if(sel==W3_SELECT_SHOW_TITLE)sel=0;}
var inline=psa.includes('w3-label-inline');var bold=!psa.includes('w3-label-not-bold');var spacing=(label!=''&&!inline)?' w3-margin-T-8':'';if(inline)spacing+=' w3-margin-left';if(cb==undefined)cb='';var onchange='onchange="w3int_select_change(event, '+sq(path)+', '+sq(cb)+', '+sq(cb_param)+')"';var psa3=w3_psa3(psa);var psa_outer=w3_psa(psa3.left,inline?'w3-show-inline-new':'');var psa_label=w3_psa_mix(psa3.middle,(label!=''&&bold)?'w3-bold':'');var psa_inner=w3_psa(psa3.right,id+' w3-select-menu'+spacing,'',onchange);var s='<div '+psa_outer+'>'+
w3_label(psa_label,label,path)+
((!inline&&label!='')?'<br>':'')+'<select '+psa_inner+'>'+first+opts_s+'</select>'+'</div>';if(cb&&sel!=W3_SELECT_SHOW_TITLE)
setTimeout(function(){w3_call(cb,path,sel,true,cb_param);},500);return s;}
function w3int_select_options(sel,opts,show_empty){var s='';if(isString(opts)){var rng=opts.split(':');if(rng.length==2){var min=+rng[0];var max=+rng[1];var idx=0;for(var i=min;i<=max;i++){s+='<option value='+dq(idx)+' '+((idx==sel)?'selected':'')+'>'+i+'</option>';idx++;}}}else
if(isArray(opts)){opts.forEach(function(obj,i){if(obj==null)return;if(isObject(obj)){var hasName=isDefined(obj.name);if(hasName&&!show_empty&&obj.name=='')return;obj=hasName?obj.name:w3_obj_seq_el(obj,0);}
s+='<option value='+dq(i)+' '+((i==sel)?'selected':'')+'>'+obj+'</option>';});}else
if(isObject(opts)){w3_obj_enum(opts,function(key,i,obj){var value,text,disabled=false;if(isObject(obj)){value=isDefined(obj.value)?obj.value:i;var hasName=isDefined(obj.name);if(hasName&&!show_empty&&obj.name=='')return;text=hasName?obj.name:key;if(isDefined(obj.disabled)&&obj.disabled)disabled=true;}else{value=i;text=obj;}
s+='<option value='+dq(value)+((i==sel)?' selected':'')+(disabled?' disabled':'')+'>'+text+'</option>\n';});}
if(sel==null){s+='<option value=-1 selected disabled>(unknown)</option>\n';}
return s;}
function w3_select(psa,label,title,path,sel,opts,cb,cb_param){var s=w3int_select_options(sel,opts,psa.includes('w3-show-empty'));if(psa.includes('w3-dump'))console.log(s);return w3int_select(psa,label,title,path,sel,s,cb,cb_param);}
function w3int_select_hier(psa,label,title,path,sel,collapse,opts,cb,cb_param){var s='';var idx=0;if(!isObject(opts))return;w3_obj_enum(opts,function(key,i,a){if(!isNumber(+key)){as=key.split('_');as.forEach(function(e){if(!e||e!='')
s+='<option value='+dq(idx++)+' disabled>'+e+'</option> ';});}
if(!isArray(a))return;a.forEach(function(el,j){if(collapse&&j>=collapse)return;var v=w3_first_value(el);if(v=='null')return;var v2=w3_second_value(el);var _class=v2?(' class='+dq(v2)):'';s+='<option value='+dq(idx++)+' id="id-'+i+'-'+j+'"'+_class+'>'+v.toString()+'</option> ';});});return w3int_select(psa,label,title,path,sel,s,cb,cb_param);}
function w3_select_hier(psa,label,title,path,sel,opts,cb,cb_param){return w3int_select_hier(psa,label,title,path,sel,0,opts,cb,cb_param);}
function w3_select_hier_collapse(psa,label,title,path,sel,collapse,opts,cb,cb_param){return w3int_select_hier(psa,label,title,path,sel,collapse,opts,cb,cb_param);}
function w3_select_conditional(psa,label,title,path,sel,opts,cb,cb_param){var s='';var idx=0;if(!isArray(opts))return;opts.forEach(function(el){if(isArray(el))
s+='<option value='+dq(idx)+' '+((idx==sel)?'selected':'')+' '+(el[1]?'':'disabled')+'>'+el[0]+'</option> ';idx++;});return w3int_select(psa,label,title,path,sel,s,cb,cb_param);}
function w3_select_set_disabled(path,value,disabled,title){w3_iterate_children(path,function(el,i){if(el.value==value){el.disabled=disabled?true:false;if(isArg(title))el.title=title;}});}
function w3_select_get_param(psa,label,title,path,opts,cb,init_val){var update_path_var=psa.includes('w3-update');var cur_val=ext_get_cfg_param(path,(init_val==undefined)?0:init_val,undefined,update_path_var);return w3_select(psa,label,title,path,cur_val,opts,cb);}
function w3_select_enum(path,func){var path=w3_el(path);if(!path)return;w3_iterate_children(path,func);}
function w3_select_get_value(path,idx){var found=null,last_disabled=null;w3_select_enum(path,function(e){if(e.value==idx)
found=e.innerHTML;if(!found&&e.disabled)
last_disabled=e.innerHTML;});return{option:found,last_disabled:last_disabled};}
function w3_select_value(path,idx,opt){if(w3_opt(opt,'all')){w3_els(path,function(el){el.value=idx;});}else{var el=w3_el(path);if(!el)return;el.value=idx;}}
function w3_select_set_if_includes(path,s){var found=false;var re=RegExp(s);w3_select_enum(path,function(option){if(re.test(option.innerHTML)){if(!found){w3_select_value(path,option.value);found=true;}}});return found;}
function w3int_slider_change(ev,complete,path,cb,cb_param){var el=ev.currentTarget;w3_check_restart_reboot(el);if(cb){w3_call(cb,path,el.value,complete,false,cb_param);}
if(complete)
w3int_post_action();}
function w3int_slider_wheel(evt,path,cb,cb_param){w3int.rate_limit_evt[cb]=evt;w3int.rate_limit[cb](cb_param);evt.preventDefault();}
function w3_slider_wheel(cb,el,cur,slow,fast){var el=w3_el(el);if(!el)return null;var evt=w3int.rate_limit_evt[cb];var x=evt.deltaX;var y=evt.deltaY;var ay=Math.abs(y);var up_down=(ay<50)?slow:fast;if(y>0)up_down=-up_down;var nval=cur+up_down;return w3_clamp(nval,+el.min,+el.max);}
function w3_slider(psa,label,path,val,min,max,step,cb,cb_param){var dump=psa.includes('w3-dump');var id=w3_add_id(path);var inline=psa.includes('w3-label-inline');var bold=!psa.includes('w3-label-not-bold');var spacing=(label!=''&&inline)?' w3-margin-L-8':'';if(inline)spacing+=' w3-margin-left';value=(val==null)?'':w3_strip_quotes(val);value='value='+dq(value);cb_param=cb_param||0;var oc=' oninput="w3int_slider_change(event, 0, '+sq(path)+', '+sq(cb)+', '+sq(cb_param)+')"';var os=' onchange="w3int_slider_change(event, 1, '+sq(path)+', '+sq(cb)+', '+sq(cb_param)+')"';var ow='';if(psa.includes('w3-wheel')){var cb_wheel=removeEnding(cb,'_cb')+'_wheel_cb';ow=' onwheel="w3int_slider_wheel(event, '+sq(path)+', '+sq(cb_wheel)+', '+sq(cb_param)+')"';w3int.rate_limit[cb_wheel]=kiwi_rateLimit(cb_wheel,170);}
var psa3=w3_psa3(psa);var psa_outer=w3_psa(psa3.left,inline?'w3-show-inline-new':'');var psa_label=w3_psa_mix(psa3.middle,(label!=''&&bold)?'w3-bold':'');var psa_inner=w3_psa(psa3.right,id+spacing,'',value+' type="range" min='+dq(min)+' max='+dq(max)+' step='+dq(step)+oc+os+ow);var s=(label!='')?('<div '+psa_outer+'>'+
w3_label(psa_label,label,path)+
((!inline&&label!='')?'<br>':'')+'<input '+psa_inner+'>'+'</div>'):('<input '+psa_inner+'>');if(cb)
setTimeout(function(){w3_call(cb,path,val,true,true,cb_param);},500);if(dump)console.log(s);return s;}
function w3_slider_set(path,val,cb){w3_set_value(path,val);w3_call(cb,path,val,true,false);}
function w3_slider_setup(path,min,max,step,val){var el=w3_el(path);if(!el)return el;el.min=min;el.max=max;el.step=step;el.value=val;return el;}
function w3_slider_get_param(psa,label,path,min,max,step,cb,cb_param,init_val){var update_path_var=psa.includes('w3-update');var cur_val=ext_get_cfg_param(path,(init_val==undefined)?0:init_val,undefined,update_path_var);return w3_slider(psa,label,path,cur_val,min,max,step,cb,cb_param);}
function w3_menu(psa,cb){var id=psa.replace(/\s+/g,' ').split(' |')[0];cb=cb||'';var onclick='onclick="w3int_menu_onclick(event, '+sq(id)+', '+sq(cb)+')"'+' oncontextmenu="w3int_menu_onclick(event, '+sq(id)+', '+sq(cb)+')"';var p=w3_psa(psa,'w3-menu w3-menu-container w3-round-large','',onclick);var s='<div '+p+'></div>';w3_el('id-w3-misc-container').innerHTML+=s;}
function w3_menu_items(id,arr,max_vis){if(w3int.menu_debug)canvas_log('w3_menu_items cur='+w3int.menu_cur_id);w3_menu_close('open');w3int.menu_cur_id=id;var s='';var idx=0,prop,attr;var items;if(isArray(arr)){items=arr;}else{items=[];for(var i=1;i<arguments.length;i++)
items.push(arguments[i]);}
if(w3int.menu_debug)canvas_log('#='+items.length);for(var i=0;i<items.length;i++){if(w3int.menu_debug)canvas_log('i='+i+' '+items[i]);if(items[i]==null)continue;prop='w3-menu ';attr='id='+dq(idx);if(items[i]=='<hr>'){prop+='w3-menu-item-hr';idx++;}else
if(items[i].charAt(0)=='!'){prop+='w3-menu-item-disabled';items[i]=items[i].substr(1);idx++;}else{prop+='w3-menu-item';idx++;if(!kiwi_isMobile())prop+=' w3-menu-item-hover';}
var psa=w3_psa_mix('',prop,'',attr);s+=w3_div(psa,items[i]);}
if(w3int.menu_debug)canvas_log('s#='+s.length);var el=w3_el(id);el.innerHTML=s;if(w3int.menu_debug)
canvas_log('BUILD');max_vis=max_vis||items.length;if(items.length>max_vis){el.style.height=px((max_vis*(4+19.5+4))+2*8);w3_add(el,'w3-scroll-always-y');}else{el.style.height='';w3_remove(el,'w3-scroll-always-y');}
if(kiwi_isMobile()){if(mobile_laptop_test)console.log('w3_menu_items MOBILE '+id);w3_iterate_children(id,function(el,i){el.addEventListener('touchmove',w3int_menu_touch_move,false);if(mobile_laptop_test)
el.addEventListener('mousemove',w3int_menu_mouse_move,false);});}}
function w3int_menu_mouse_move(ev){var x=Math.round(ev.pageX);var y=Math.round(ev.pageY);w3int_menu_move('MMM',x,y);}
function w3int_menu_touch_move(ev){var x=Math.round(ev.touches[0].pageX);var y=Math.round(ev.touches[0].pageY);w3int_menu_move('MTM',x,y);}
function w3int_menu_move(which,x,y){var el=document.elementFromPoint(x,y);if(!el)return;if(w3_isScrolling(w3int.menu_cur_id))return;var rtn=(!el||!w3_contains(el,'w3-menu-item'));if(w3int.prev_menu_hover_el&&(rtn||(el!=w3int.prev_menu_hover_el))){w3int.prev_menu_hover_el.style.background='';w3int.prev_menu_hover_el.style.color='';if(rtn){return;}}
el.style.background='rgb(79, 157, 251)';el.style.color='white';w3int.prev_menu_hover_el=el;}
function w3_menu_popup(id,close_func,x,y){var x0=x,y0=y;var el=w3_el(id);x=x||window.innerWidth/2;y=y||window.innerHeight/2;var slop=16;el.w3_realigned=false;if((x+el.clientWidth)+slop>window.innerWidth){x=window.innerWidth-el.clientWidth-slop;el.w3_realigned_time=Date.now();el.w3_realigned=true;}
el.style.left=px(x);var yt=y+el.clientHeight+slop;if(yt>window.innerHeight){y=window.innerHeight-el.clientHeight-slop;el.w3_realigned_time=Date.now();el.w3_realigned=true;}
el.style.top=px(y);w3_visible(el,true);if(w3int.menu_debug)
canvas_log('VIS');w3int.menu_active=true;el.w3_menu_x=x;w3int.menu_close_func=close_func;w3int.menu_first=true;window.addEventListener("keyup",w3int_menu_event,false);window.addEventListener("mousedown",w3int_menu_event,false);window.addEventListener("touchstart",w3int_menu_event,false);window.addEventListener("click",w3int_menu_event,false);}
function w3_menu_active(){return w3int.menu_active;}
function w3int_menu_onclick(ev,id,cb,cb_param){if(w3int.menu_debug)
canvas_log('menu_onclick '+id+' from='+(cb_param||ev.type));var el=w3_el(id);if(el.w3_realigned){el.w3_realigned=false;var when=Date.now()-el.w3_realigned_time;if(when<50){if(w3int.menu_debug)canvas_log('XRe'+when);return cancelEvent(ev);}
if(w3int.menu_debug)canvas_log('XOK'+when);}
if(ev!=null&&cb!=null){var _id=ev.target.id;var idx=+_id;if(_id==''||isNaN(idx))_id=ev.target.parentNode.id;idx=+_id;if(_id==''||isNaN(idx))idx=-1;if(w3int.menu_debug)
canvas_log('CALL: '+idx);if(idx==-1)return;w3_call(cb,idx,el.w3_menu_x,cb_param,ev);}
w3_visible(el,false);if(w3int.menu_debug)
canvas_log('NOT_VIS');w3int.menu_active=false;window.removeEventListener("keyup",w3int_menu_event,false);window.removeEventListener("mousedown",w3int_menu_event,false);window.removeEventListener("touchstart",w3int_menu_event,false);window.removeEventListener("click",w3int_menu_event,false);if(ev!=null){if(w3int.menu_debug)canvas_log('Enull');return cancelEvent(ev);}}
function w3int_menu_event(evt){if(w3int.menu_debug)canvas_log('ME '+evt.type);var el=w3_el(w3int.menu_cur_id);if(el&&w3int.menu_close_func){var close=w3int.menu_close_func(evt,w3int.menu_first);w3int.menu_first=false;if(w3int.menu_debug)canvas_log('CLOSE='+close);if(close)w3_menu_close(evt.type);}}
function w3_menu_close(from){if(w3int.menu_debug)canvas_log('w3_menu_close '+from+' id='+w3int.menu_cur_id);if(!w3int.menu_cur_id)return;var el=w3_el(w3int.menu_cur_id);if(!el)return;el.w3_realigned=false;w3int_menu_onclick(null,w3int.menu_cur_id,null,'menu_close');w3int.menu_cur_id=null;}
function w3_num_cb(path,val){var v=parseFloat(val);if(val=='')v=0;if(isNaN(v)){w3_set_value(path,0);v=0;}
setVarFromString(path,v);}
function w3_bool_cb(path,val){v=+val;setVarFromString(path,v);}
function w3_string_cb(path,val){setVarFromString(path,val.toString());}
function w3_num_set_cfg_cb(path,val,first){var v=parseFloat(val);if(isNaN(v))v=0;var save=isArg(first)?(first?false:true):true;ext_set_cfg_param(path,v,save);}
function w3_int_set_cfg_cb(path,val,first){var v=parseInt(val);if(isNaN(v))v=0;w3_set_value(path,v);var save=isArg(first)?(first?false:true):true;ext_set_cfg_param(path,v,save);}
function w3_float_set_cfg_cb(path,val,first,cb_a){var prec=-1;if(cb_a&&cb_a.length>=2){prec=+(cb_a[1]);if(isNaN(prec))prec=-1;}
val=parseFloat(val);if(isNaN(val)){val=ext_get_cfg_param(path);}else{if(prec!=-1){var s=val.toFixed(prec);val=+s;}
var save=isArg(first)?(first?false:true):true;ext_set_cfg_param(path,val,save);}
w3_set_value(path,val);}
function w3_bool_set_cfg_cb(path,val,first){var v;if(val==true||val==1)v=true;else
if(val==false||val==0)v=false;else
v=false;var save=isArg(first)?(first?false:true):true;ext_set_cfg_param(path,v,save);}
function w3_string_set_cfg_cb(path,val,first){var save=isArg(first)?(first?false:true):true;ext_set_cfg_param(path,encodeURIComponent(val.toString()),save);}
function w3_json_set_cfg_cb(path,val,first){var save=isArg(first)?(first?false:true):true;ext_set_cfg_param(path,val,save);}
function w3_url_set_cfg_cb(path,val,first){if(val!=''&&!val.startsWith('http://')&&!val.startsWith('https://'))val='http://'+val;w3_string_set_cfg_cb(path,val,first);w3_set_value(path,val);}
function w3_remove_trailing_index(path,sep){sep=sep||'-';var re=new RegExp('(.*)'+sep+'([-]?[0-9]+)');var el=re.exec(path);var idx;if(!el){idx=null;el=path;}else{idx=el[2];el=el[1];}
return{el:el,idx:idx};}
var w3_MENU_NEXT=1;var w3_MENU_PREV=-1;function w3_select_next_prev_cb(path,cb_param,first){if(dbgUs)console.log('w3_select_next_prev_cb cb_param='+decodeURIComponent(cb_param));var cbp=w3_cb_param_decode(cb_param);if(!isObject(cbp)){console.log('w3_select_next_prev_cb cb_param is not an object');return;}
if(dbgUs)console.log('w3_select_next_prev_cb dir='+cbp.dir+' id='+cbp.id);var prev=0,capture_the_next=0,captured_next=0,captured_prev=0;var menu_s,el;for(var i=0;(el=w3_el(menu_s=cbp.id+i))!=null;i++){var val=el.value;if(dbgUs)console.log('menu_s='+menu_s+' value='+val);if(val==-1)continue;w3_select_enum(menu_s,function(option){var content_check=(isUndefined(cbp.isNumeric)||(cbp.isNumeric==true&&isNumber(parseInt(option.innerText))));if(option.disabled||!content_check)return;if(dbgUs)console.log('consider val='+option.value+' \"'+option.innerText+'\" content_check='+content_check);if(capture_the_next){captured_next=option.value;capture_the_next=0;}
if(option.value===val){captured_prev=prev;capture_the_next=1;}
prev=option.value;});break;}
if(dbgUs)console.log('i='+i+' captured_prev='+captured_prev+' captured_next='+captured_next);val=0;if(cbp.dir==w3_MENU_NEXT&&captured_next)val=captured_next;if(cbp.dir==w3_MENU_PREV&&captured_prev)val=captured_prev;if(dbgUs)console.log('w3_select_next_prev_cb val='+val);w3_call(cbp.func,menu_s,val,first);}
function w3_table(psa){var p=w3_psa(psa,'w3-table w3-table-default');var s='<table '+p+'>';for(var i=1;i<arguments.length;i++){s+=arguments[i];}
s+='</table>';return s;}
function w3_table_heads(psa){var p=w3_psa(psa,'w3-table-head');var s='';for(var i=1;i<arguments.length;i++){if(arguments[i]==null)continue;s+='<th '+p+'>';s+=arguments[i];s+='</th>';}
return s;}
function w3_table_row(psa){var p=w3_psa(psa,'w3-table-row');var s='<tr '+p+'>';for(var i=1;i<arguments.length;i++){if(arguments[i]==null)continue;s+=arguments[i];}
s+='</tr>';return s;}
function w3_table_cells(psa){var p=w3_psa(psa,'w3-table-cell');var s='';for(var i=1;i<arguments.length;i++){if(arguments[i]==null)continue;s+='<td '+p+'>';s+=arguments[i];s+='</td>';}
return s;}
function w3_inline(psa,attr){var narg=arguments.length;var dump=psa.includes('w3-dump');if(psa==''&&attr==''&&narg>2){console.log('### w3_inline OLD API DEPRECATED');var args=Array.prototype.splice.call(arguments,0);args.splice(0,1);return w3_inline.apply(null,args);}else{var psa3=w3_psa3(psa);var psa_outer=w3_psa(psa3.middle,'w3-show-inline-new');var psa_inner=w3_psa(psa3.right);if(dump)console.log('w3_inline psa_outer='+psa_outer+' psa_inner='+psa_inner);var s='<div w3d-inlo '+psa_outer+'>';for(var i=1;i<narg;i++){var psa;var a=arguments[i];if(!a)continue;if(dump)console.log('w3_inline i='+i+' a='+a);var psa_merge=false;if(a.startsWith('w3-')||a.startsWith('id-')){psa=w3_psa(psa3.right,a);i++;a=arguments[i];psa_merge=true;}else{psa=psa_inner;}
if(psa3.right==''&&!psa_merge&&a.startsWith('<div '))
s+=a;else
s+='<div w3d-inli-'+(i-1)+' '+psa+'>'+a+'</div>';}
s+='</div>';if(dump)console.log(s);return s;}}
function w3_inline_percent(psa){var psa3=w3_psa3(psa);var psa_outer=w3_psa(psa3.middle,'w3-show-inline-new');var narg=arguments.length;var total=0;var prop=psa.includes('w3-debug')?'w3_debug ':'';var last_halign_end=psa.includes('w3-last-halign-end');var s='<div w3d-inlpo '+psa_outer+'>';for(var i=1;i<narg;i+=2){var style;if(i+1<narg){style='flex-basis:'+arguments[i+1]+'%';total+=arguments[i+1];}else{style='flex-basis:'+(100-total)+'%';}
if(i==narg-1&&last_halign_end)prop+='w3-flex w3-halign-end';s+='<div w3d-inlpi-'+((i-1)/2)+' '+w3_psa(psa3.right,prop,style)+'>'+arguments[i]+'</div>';}
s+='</div>';return s;}
function w3_div(psa){var p=w3_psa(psa);var s='<div w3d-div '+p+'>';var narg=arguments.length;for(var i=1;i<narg;i++){s+=arguments[i];}
s+='</div>';return s;}
function w3_span(psa){var p=w3_psa(psa,'w3-show-span');var s='<div w3d-span '+p+'>';var narg=arguments.length;for(var i=1;i<narg;i++){s+=arguments[i];}
s+='</div>';return s;}
function w3_divs(psa,attr){var narg=arguments.length;var s;if(psa==''&&attr==''){console.log('### w3_divs OLD API 1 DEPRECATED');s=w3_div.apply(null,Array.prototype.splice.call(arguments,1));return s;}else
if(psa!=''&&attr==''&&narg>2){console.log('### w3_divs OLD API 2 DEPRECATED');var args=Array.prototype.splice.call(arguments,0);args.splice(1,1);s=w3_div.apply(null,args);return s;}else
if(psa==''&&attr&&attr.startsWith('w3-')&&narg>2){console.log('### w3_divs OLD API 3 DEPRECATED');var args=Array.prototype.splice.call(arguments,0);args.splice(0,1);s=w3_divs.apply(null,args);return s;}else
if(psa!=''&&attr&&attr.startsWith('w3-')&&narg>2){console.log('### w3_divs OLD API 4 DEPRECATED');var args=Array.prototype.splice.call(arguments,2);args.splice(0,0,arguments[0]+'/'+arguments[1]);s=w3_divs.apply(null,args);return s;}else{var psa3=w3_psa3(psa);var psa_outer=w3_psa(psa3.middle);var psa_inner=w3_psa(psa3.right);s='<div w3d-divso '+psa_outer+'>';for(var i=1;i<narg;i++){s+='<div w3d-divsi-'+(i-1)+' '+psa_inner+'>'+arguments[i]+'</div>';}
s+='</div>';return s;}}
function w3_col_percent(psa){var psa3=w3_psa3(psa);var psa_outer=w3_psa(psa3.middle,'w3-row');var narg=arguments.length;var s='<div w3d-colpo '+psa_outer+'>';for(var i=1;i<narg;i+=2){var prop,style;if(i+1<narg){prop='w3-col';style='width:'+arguments[i+1]+'%';}else{prop='w3-rest';style='';}
s+='<div w3d-colpi-'+((i-1)/2)+' '+w3_psa(psa3.right,prop,style)+'>'+arguments[i]+'</div>';}
s+='</div>';return s;}
function w3_text(psa,text){var style=(psa.includes('w3-padding')||psa.includes('w3-nopad'))?'':'padding:0 4px 0 0';if(!psa.includes('w3-nobk'))style+='; background-color:inherit';var s=w3_div(w3_psa_mix(psa,'w3-text',style),text?text:' ');return s;}
function w3_code(psa){var psa3=w3_psa3(psa);var narg=arguments.length;var s='<pre '+w3_psa(psa3.left)+'><code '+w3_psa(psa3.middle)+'>';for(var i=1;i<narg;i++){s+='<code '+w3_psa(psa3.right)+'>'+arguments[i]+'</code>';}
s+='</code></pre>';return s;}
function w3_half(prop_row,prop_col,left,right,prop_left,prop_right){if(prop_left==undefined)prop_left='';if(prop_right==undefined)prop_right='';var s='<div class="w3-row '+prop_row+'">'+'<div class="w3-col w3-half '+prop_col+prop_left+'">'+
left+'</div>'+'<div class="w3-col w3-half '+prop_col+prop_right+'">'+
(right?right:'')+'</div>'+'</div>';return s;}
function w3_third(prop_row,prop_col,left,middle,right){var s='<div class="w3-row '+prop_row+'">'+'<div class="w3-col w3-third '+prop_col+'">'+
left+'</div>'+'<div class="w3-col w3-third '+prop_col+'">'+
(middle?middle:'')+'</div>'+'<div class="w3-col w3-third '+prop_col+'">'+
(right?right:'')+'</div>'+'</div>';return s;}
function w3_quarter(prop_row,prop_col,left,middleL,middleR,right){var s='<div class="w3-row '+prop_row+'">'+'<div class="w3-col w3-quarter '+prop_col+'">'+
left+'</div>'+'<div class="w3-col w3-quarter '+prop_col+'">'+
(middleL?middleL:'')+'</div>'+'<div class="w3-col w3-quarter '+prop_col+'">'+
(middleR?middleR:'')+'</div>'+'<div class="w3-col w3-quarter '+prop_col+'">'+
(right?right:'')+'</div>'+'</div>';return s;}
function w3_canvas(psa,w,h,opt){var s='';var pad=w3_opt(opt,'pad',null);var pad_top=w3_opt(opt,'pad_top',0);var pad_bot=w3_opt(opt,'pad_bottom',0);if(!isNull(pad))pad_top=pad_bot=pad;pad=pad_top+pad_bot;if(pad){s+=sprintf(' padding-top:%dpx; padding-bottom:%dpx;',pad_top,pad_bot);}
var left=w3_opt(opt,'left','');if(left!='')s+=sprintf(' left:%dpx;',left);var right=w3_opt(opt,'right','');if(right!='')s+=sprintf(' right:%dpx;',right);var top=w3_opt(opt,'top','');if(top!='')s+=sprintf(' top:%dpx;',top);s='<canvas '+w3_psa(psa,null,'position:absolute;'+s,sprintf('width="%d" height="%d"',w,h))+'></canvas>';return s;}





/* web/kiwi/monitor.min.js (web/kiwi/monitor.js = Sun Sep 10 17:48:58 2023) */
var monitor={init:false};function kiwi_queue_cb(){kiwi.queued^=1;w3_innerHTML('id-queue-button',kiwi.queued?'Exit queue':'Enter queue');if(!kiwi.queued)w3_innerHTML('id-queue-pos','');msg_send('SET MON_QSET='+(kiwi.queued?1:0));}
function kiwi_monitor(){console.log('n_camp='+cfg.n_camp);var camp_s=cfg.n_camp?'To camp (listen) to the audio of an existing connection <br>'+'click on one of the channel links below.':'No audio camping allowed on this Kiwi.';var s=w3_div('',w3_text('w3-text-black','All Kiwi channels busy. Click button to wait in queue for an available channel.'),w3_inline('w3-margin-L-8 w3-margin-T-4/w3-margin-right w3-valign',w3_button('id-queue-button w3-medium w3-padding-smaller w3-green','Enter queue','kiwi_queue_cb'),w3_text('id-queue-pos w3-text-black'),w3_button('id-queue-button w3-medium w3-padding-smaller w3-yellow','Reload page','kiwi_queue_reload_cb')),w3_text('id-queue-status w3-margin-T-4 w3-text-black',''),w3_div('id-camp-container',w3_hr('w3-margin-16'),w3_text('id-monitor-disconnect w3-nobk w3-css-orange w3-width-fit w3-hide','&nbsp;Channel has disconnected'),w3_text('w3-margin-T-4 w3-text-black w3-show-block',camp_s),w3_text('id-camp-status w3-margin-T-4 w3-text-black','')),w3_hr('w3-margin-16'),w3_div('id-users-list w3-margin-T-10'));kiwi_show_msg(s);kiwi.unmuted_color='mediumSeaGreen';users_init({monitor:1});pwd_prot=chan_no_pwd_true?(rx_chans-chan_no_pwd_true):0;console.log('rx_chans='+rx_chans+' chan_no_pwd_true='+chan_no_pwd_true+' pwd_prot='+pwd_prot);var channels=plural(pwd_prot,' channel');var is_are=(pwd_prot==1)?'is':'are';if(pwd_prot){s='<br>Note that '+pwd_prot+channels+' on this Kiwi '+is_are+' password protected. <br>'+'This is why you may see empty channels you cannot access.';w3_innerHTML('id-queue-status',s);}else
w3_innerHTML('id-queue-status','');setInterval(function(){msg_send('SET keepalive');if(kiwi.queued)msg_send('SET MON_QPOS');},2500);ws_any().msg_cb=function(msg_a){var a=msg_a[1]?msg_a[1].split(','):null;switch(msg_a[0]){case'qpos':var pos=a[0],waiters=a[1],reload=+a[2];if(reload)kiwi_queue_reload_cb();var s='';if(kiwi.queued)s+='You are '+pos+' of '+waiters+' in queue.';w3_innerHTML('id-queue-pos',s);break;case'camp':var okay=+a[0],rx=+a[1];var s;if(okay){if(!monitor.init){check_suspended_audio_state();monitor.init=true;}
s=w3_div('',w3_inline('w3-margin-T-4/w3-margin-right w3-valign',w3_text('id-queue-pos w3-text-black','Camping on RX'+rx),w3_button('w3-medium w3-padding-smaller w3-red','Stop','kiwi_camp_stop_cb'),w3_slider('w3-margin-L-16/w3-label-inline w3-label-not-bold/','Volume','kiwi.volume',kiwi.volume,0,200,1,'setvolume'),w3_div('|background-color: #e0e0e0; padding:2px; border-radius:8px|title="mute"',w3_div('id-mute-no fa-stack|width:28px; color:'+kiwi.unmuted_color,w3_icon('','fa-volume-up fa-stack-2x fa-nudge-up',24,'inherit','toggle_or_set_mute')),w3_div('id-mute-yes fa-stack w3-hide|width:28px;color:magenta;',w3_icon('','fa-volume-off fa-stack-2x fa-nudge-left fa-nudge-up',24,'','toggle_or_set_mute'),w3_icon('','fa-times fa-right',12,'','toggle_or_set_mute')))),w3_inline('',w3_div('id-control-smeter w3-margin-T-4'),w3_text('id-monitor-masked w3-margin-left w3-red w3-text-white w3-hide','&nbsp;Frequency is masked')));}else{s='Too many campers on channel RX'+rx;rx=-1;}
kiwi_camp_update(rx,s);if(rx!=-1)smeter_init(true);toggle_or_set_mute(0);break;case'isMasked':var masked=(+a[0])?true:false;w3_show_hide('id-monitor-masked',masked);break;case'camp_disconnect':w3_show_hide('id-monitor-masked',false);w3_show_hide('id-monitor-disconnect',true);console.log('camp_disconnect');kiwi_camp_stop_cb();break;default:owrx_msg_cb(msg_a);break;}};}
function kiwi_queue_reload_cb(){var url=kiwi_remove_search_param(window.location.href,'camp');window.location.href=url;}
function kiwi_camp_update(rx,s){w3_innerHTML('id-camp-status',s);for(var i=0;i<rx_chans;i++){var el=w3_el('id-user-'+i);w3_remove(el,'w3-green');if(i==rx)
w3_add(el,'w3-green');}}
function camp(ch,freq,mode,zoom){console.log('camp ch'+ch);w3_show_hide('id-monitor-disconnect',false);if(cfg.n_camp)
msg_send('SET MON_CAMP='+ch);}
function kiwi_camp_stop_cb(){console.log('camp STOP');kiwi_camp_update(-1,'');msg_send('SET MON_CAMP=-1');}





/* web/kiwi/kiwi_map.min.js (web/kiwi/kiwi_map.js = Sun Sep 10 17:48:58 2023) */
var kmap={ADD_TO_MAP:true,NO_ADD_TO_MAP:false,DIR_LEFT:true,DIR_RIGHT:false,VISIBLE:true,NOT_VISIBLE:false,_last_last:0};function kiwi_map_init(ext_name,init_latlon,init_zoom,mapZoom_nom,move_cb,zoom_cb){var map_tiles;var maxZoom=19;map_tiles=function(){maxZoom=18;return L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{tileSize:256,zoomOffset:0,attribution:'<a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',crossOrigin:true});}
var tiles=map_tiles('hybrid');var map=L.map('id-'+ext_name+'-map',{maxZoom:maxZoom,minZoom:1,doubleClickZoom:false,zoomControl:false}).setView(init_latlon,init_zoom);map.on('baselayerchange',function(e){var tmap=e.target;var center=tmap.getCenter();kiwi_pan_zoom(tmap,[center.lat+0.1,center.lng],-1);kiwi_pan_zoom(tmap,[center.lat,center.lng],-1);});var kmap={ext_name:ext_name,map:map};map.on('click',function(e,kmap){w3_call(ext_name+'_map_click_cb',kmap,e);});map.on('move',function(e,kmap){w3_call(ext_name+'_map_move_cb',kmap,e);});map.on('zoom',function(e,kmap){w3_call(ext_name+'_map_zoom_cb',kmap,e);});map.on('moveend',function(e,kmap){w3_call(ext_name+'_map_move_end_cb',kmap,e);});map.on('zoomend',function(e,kmap){w3_call(ext_name+'_map_zoom_end_cb',kmap,e);});L.control.zoom_Kiwi({position:'topright',zoomNomText:'2',zoomNomLatLon:init_latlon}).addTo(map);tiles.addTo(map);var scale=L.control.scale()
scale.addTo(map);scale.setPosition('bottomleft');var day_night=new Terminator();day_night.setStyle({fillOpacity:0.35});day_night.addTo(map);kmap.day_night_interval=setInterval(function(){var t2=new Terminator();day_night.setLatLngs(t2.getLatLngs());day_night.redraw();},60000);day_night._path.style.cursor='grab';var graticule=L.latlngGraticule();graticule.addTo(map);kmap.map_layers=[graticule];kmap.graticule=graticule;kmap.day_night=day_night;kmap.init_latlon=init_latlon;kmap.init_zoom=init_zoom;kmap.mapZoom_nom=mapZoom_nom;return kmap;}
function kiwi_map_blur(kmap){kiwi_clearInterval(kmap.day_night_interval);}
function kiwi_map_add_marker_icon(kmap,addToMap,url,latlon,anchor,opacity,func){var kiwi_icon=L.icon({iconUrl:url,iconAnchor:anchor});var kiwi_mkr=L.marker(latlon,{'icon':kiwi_icon,'opacity':opacity});if(addToMap){kiwi_mkr.addTo(kmap.map);if(func)func(kiwi_mkr._icon);}}
function kiwi_map_add_marker_div(kmap,addToMap,latlon,className,iconAnchor,tooltipAnchor,opacity){var icon=L.divIcon({className:className,html:'',iconAnchor:iconAnchor,tooltipAnchor:tooltipAnchor});var marker=L.marker(latlon,{'icon':icon,'opacity':opacity});if(addToMap)marker.addTo(kmap.map);return marker;}
function kiwi_style_marker(kmap,addToMap,marker,name,className,left,func){marker.bindTooltip(name,{className:className,permanent:true,direction:left?'left':'right'});if(func)marker.on('add',function(ev){func(ev);});if(addToMap){marker.addTo(kmap.map);kmap.map_layers.push(marker);}}
function kiwi_map_day_night_visible(kmap,vis){var day_night=kmap.day_night;if(vis){day_night.addTo(kmap.map);kmap.map_layers.push(day_night);day_night._path.style.cursor='grab';}else{day_night.remove();kmap.map_layers=kmap.map_layers.filter(function(ae){ae!=day_night});}}
function kiwi_map_graticule_visible(kmap,vis){var graticule=kmap.graticule;if(vis){graticule.addTo(kmap.map);kmap.map_layers.push(graticule);}else{graticule.remove();kmap.map_layers=kmap.map_layers.filter(function(ae){ae!=graticule});}}
function kiwi_map_markers_visible(id,vis){w3_iterate_children('leaflet-marker-pane',function(el,i){if(el.className.includes(id)){w3_hide2(el,!vis);}});w3_iterate_children('leaflet-tooltip-pane',function(el,i){if(el.className.includes(id)){w3_hide2(el,!vis);}});}
function kiwi_pan_zoom(map,latlon,zoom){if(latlon==null)latlon=map.getCenter();if(zoom==-1)zoom=map.getZoom();map.setView(latlon,zoom,{duration:0,animate:false});}





/* web/openwebrx/openwebrx.min.js (web/openwebrx/openwebrx.js = Thu Jan  4 13:16:19 2024) */
var owrx={debug_drag:false,height_top_bar_parts:67,hide_bars:0,HIDE_TOPBAR:1,HIDE_BANDBAR:2,HIDE_ALLBARS:3,PB_NO_EDGE:0,PB_RIGHT_EDGE:1,PB_LEFT_EDGE:2,cfg_loaded:false,mobile:null,wf_snap:0,wf_cursor:'crosshair',last_shiftKey:false,last_pageX:0,last_pageY:0,mouse_freq:{},override_fmem:null,vfo_ab:0,vfo_first:true,last_freq:-1,last_mode:'',last_locut:-1,last_hicut:-1,last_lo:[],last_hi:[],last_selected_band:0,last_mode_el:null,dseq:0,sMeter_dBm_biased:0,sMeter_dBm:0,smeter_interval:null,force_no_agc_thresh_smeter:false,overload_mute:90,squelched_overload:false,prev_squelched_overload:false,touch_hold_pressed:false,show_cursor_freq:0,tuning_locked:0,dx_click_gid_last_stored:undefined,dx_click_gid_last_until_tune:undefined,sam_pll:1,sam_pll_s:['DX','med','fast'],chan_null:0,chan_null_s:['normal','null LSB','null USB'],SAM_opts:3,SAM_opts_s:['none','fade leveler','DC block','fade+block'],SAM_opts_sft:2,ovld_mute:0,ovld_mute_s:['off','on'],FSET_NOP:0,FSET_ADD:1,FSET_SET_FREQ:2,FSET_EXT_SET_PB:3,FSET_PB_CHANGE:4,FSET_SCALE_DRAG:5,FSET_SCALE_DRAG_END:6,FSET_SCALE_MOUSE_CLICK:7,FSET_SCALE_TOUCH_DRAG:8,FSET_SCALE_TOUCH_DRAG_END:9,fset_s:['nop','add','fset','extSetPB','pbChg','drag','dragEnd','mouseClick','touchDrag','touchClick'],WF_POS_AT_FREQ:0,WF_POS_RECENTER_IF_OUTSIDE:1,waterfall_tuned:0,scale_canvas:{mouse_out:false,target:null,restore_visibility:[],restore_visibility_delay:500},canvas:{target:null,restore_visibility:[],restore_visibility_delay:500},zoom_titles:[['passband narrow','passband widen'],['passband right edge','passband right edge'],['passband left edge','passband left edge']],__last:0};var bandwidth;var center_freq;var wf_fft_size;var cur_mode;var wf_fps,wf_fps_max;var ws_snd,ws_wf;var spectrum_show=0,spectrum_param=-1;var gen_freq=0,gen_attn=0;var squelch_threshold=0;var wf_rate='';var wf_mm='';var wf_auto=null;var wf_compression=1;var wf_interp=13;var wf_winf=2;var snd_winf=0;var debug_v=0;var sb_trace=0;var kiwi_gc=1;var kiwi_gc_snd=0;var kiwi_gc_wf=-1;var kiwi_gc_recv=-1;var kiwi_gc_wspr=-1;var override_ext=null;var muted_initially=0;var peak_initially1=null,peak_initially2=null;var param_nocache=false;var nocache=false;var param_ctrace=false;var ctrace=false;var no_clk_corr=false;var override_pbw='';var override_pbc='';var nb_click=false;var no_geoloc=false;var force_mobile=false;var mobile_laptop_test=false;var user_url=null;var url_1Hz=null;var wf_rates={'0':0,'off':0,'1':1,'1hz':1,'s':2,'slow':2,'m':3,'med':3,'f':4,'fast':4};var okay_wf_init=false;function kiwi_main(){w3_do_when_cond(function(){return owrx.cfg_loaded;},function(){kiwi_main_ready();},null,200);}
function kiwi_main_ready(){override_freq=parseFloat(readCookie('last_freq'));override_mode=readCookie('last_mode');override_zoom=parseFloat(readCookie('last_zoom'));override_9_10=parseFloat(readCookie('last_9_10'));override_max_dB=parseFloat(readCookie('last_max_dB'));override_min_dB=parseFloat(readCookie('last_min_dB'));var last_vol=readCookie('last_volume',50);setvolume(true,last_vol);console.log('LAST f='+override_freq+' m='+override_mode+' z='+override_zoom
+' 9_10='+override_9_10+' min='+override_min_dB+' max='+override_max_dB);var num_win=16;console.log('URL: '+window.location.href);var qs_parse=function(s){var qd={};if(s)s.split("&").forEach(function(item){var a=item.split("=");qd[a[0]]=a[1]?a[1]:1;});return qd;}
var q=window.location.search&&window.location.search.substr(1);var qs=[],qd=[];for(w=1;w<=num_win;w++){var win='&win'+(w+1)+'&';qs[w]=q&&q.split(win)[0];q=q&&q.split(win)[1];qd[w]=qs_parse(qs[w]);qd[w].WID=w;}
var host=window.location.href.split('?')[0];g_qs_idx=2;for(w=2;w<=num_win;w++){if(qs[w]){setTimeout(function(){var url=host+'?'+qs[g_qs_idx];g_qs_idx++;var win=window.open(url,'_blank');if(win==null)
alert('Do you have popups blocked for this site? '+url);},(w-1)*2000);}}
var q=qd[1];var s='f';if(q[s]){var p=parse_freq_pb_mode_zoom(q[s]);if(p[1])override_freq=p[1].replace(',','.').parseFloatWithUnits('M',1e-3);if(p[1])console.log('p='+p[1]+' override_freq='+override_freq);if(p[2])console.log('override_pbw/pbc='+p[2]);if(p[2]&&p[2].charAt(0)=='/')override_pbw=p[2].substr(1);if(p[2]&&p[2].charAt(0)==':')override_pbc=p[2].substr(1);if(p[3])override_mode=p[3].toLowerCase();if(p[4])override_zoom=+p[4];}
s='ext';if(q[s]&&isString(q[s])){var ext=q[s].split(',');override_ext=ext[0];extint.param=ext.slice(1).join(',');console.log('URL: ext='+override_ext+' ext_p='+extint.param);}
s='pbw';if(q[s])override_pbw=q[s];s='pb';if(q[s])override_pbw=q[s];s='pbc';if(q[s])override_pbc=q[s];s='z';if(q[s])override_zoom=+q[s];s='sp';if(q[s])spectrum_show=q[s];s='spec';if(q[s])spectrum_show=q[s];s='spp';if(q[s])spectrum_param=parseFloat(q[s]);s='vol';if(q[s]){setvolume(true,parseInt(q[s]));}
s='mute';if(q[s])muted_initially=parseInt(q[s]);s='wf';if(q[s])wf_rate=q[s];s='wfm';if(q[s])wf_mm=q[s];s='wfa';if(q[s])wf_auto=parseInt(q[s]);s='cmap';if(q[s])wf.cmap_override=w3_clamp(parseInt(q[s]),0,kiwi.cmap_s.length-1,0);s='sqrt';if(q[s])wf.sqrt=w3_clamp(parseInt(q[s]),0,4,0);s='wfts';if(q[s])wf.url_tstamp=w3_clamp(parseInt(q[s]),2,60*60,2);s='peak';if(q[s])peak_initially1=w3_clamp(parseInt(q[s],0,2));s='peak2';if(q[s])peak_initially2=w3_clamp(parseInt(q[s],0,2));s='no_geo';if(q[s])no_geoloc=true;s='keys';if(q[s])shortcut.keys=isNonEmptyString(q[s])?q[s].split(''):null;s='user';if(q[s])user_url=q[s];s='u';if(q[s])user_url=q[s];s='m';if(q[s])force_mobile=true;s='mobile';if(q[s])force_mobile=true;s='mem';if(q[s])owrx.override_fmem=q[s];s='1hz';if(q[s]||q['1Hz'])url_1Hz=true;s='sqth';if(q[s])squelch_threshold=parseFloat(q[s]);s='click';if(q[s])nb_click=true;s='nocache';if(q[s]){param_nocache=true;nocache=parseInt(q[s]);}
s='ncc';if(q[s])no_clk_corr=parseInt(q[s]);s='wfdly';if(q[s])waterfall_delay=parseFloat(q[s]);s='wf_comp';if(q[s])wf_compression=parseInt(q[s]);s='wfi';if(q[s])wf_interp=parseInt(q[s]);s='wfw';if(q[s])wf_winf=parseInt(q[s]);s='sndw';if(q[s])snd_winf=parseInt(q[s]);s='gen';if(q[s])gen_freq=q[s].parseFloatWithUnits('kM',1e-3);s='attn';if(q[s])gen_attn=Math.abs(parseInt(q[s]));s='blen';if(q[s])audio_buffer_min_length_sec=parseFloat(q[s])/1000;s='audio';if(q[s])audio_meas_dly_ena=parseFloat(q[s]);s='gc';if(q[s])kiwi_gc=parseInt(q[s]);s='gc_snd';if(q[s])kiwi_gc_snd=parseInt(q[s]);s='gc_wf';if(q[s])kiwi_gc_wf=parseInt(q[s]);s='gc_recv';if(q[s])kiwi_gc_recv=parseInt(q[s]);s='gc_wspr';if(q[s])kiwi_gc_wspr=parseInt(q[s]);s='ctrace';if(q[s]){param_ctrace=true;ctrace=parseInt(q[s]);}
s='tmobile';if(q[s])mobile_laptop_test=true;s='v';if(q[s])console.log('URL: debug_v = '+(debug_v=q[s]));if(kiwi_gc_snd==-1)kiwi_gc_snd=kiwi_gc;if(kiwi_gc_wf==-1)kiwi_gc_wf=kiwi_gc;if(kiwi_gc_recv==-1)kiwi_gc_recv=kiwi_gc;if(kiwi_gc_wspr==-1)kiwi_gc_wspr=kiwi_gc;console.log('GC: snd='+kiwi_gc_snd+' wf='+kiwi_gc_wf+' recv='+kiwi_gc_recv+' wspr='+kiwi_gc_wspr);if(wf_mm!=''){wf_mm=wf_mm.split(',');var m=parseInt(wf_mm[0]);if(!isNaN(m)&&m>=-190&&m<=-30)override_min_dB=m;if(wf_mm.length>=2){m=parseInt(wf_mm[1]);if(!isNaN(m)&&m>=-100&&m<=20)override_max_dB=m;}}
kiwi_get_init_settings();if(!no_geoloc)kiwi_geolocate();freq_memory_init();init_top_bar();init_rx_photo();right_click_menu_init();freq_memory_menu_init();keyboard_shortcut_init();confirmation_panel_init();ext_panel_init();place_panels();init_panels();okay_wf_init=true;confirmation_panel_init2();smeter_init();time_display_setup('id-topbar-right-container');window.setInterval(send_keepalive,5000);window.addEventListener("resize",openwebrx_resize);if(param_nocache){console.log('### nocache='+(nocache?1:0));}
if(param_ctrace){console.log('### ctrace='+(ctrace?1:0));}
snd_send("SERVER DE CLIENT openwebrx.js SND");snd_send("SET dbug_v="+debug_v+','+(dbgUs?1:0));w3_do_when_cond(function(){return(isArg(rx_chan)&&owrx.cfg_loaded);},function(){if(rx_chan!=0)return;var attn_ampl=0;if(gen_attn!=0){var dB=gen_attn+wf.cal;var ampl_gain=Math.pow(10,-dB/20);attn_ampl=0x01ffff*ampl_gain;}
set_gen(gen_freq,attn_ampl);},null,500);var _lo=kiwi_passbands(init_mode).lo;if(!isNumber(_lo))_lo=-4000;var _hi=kiwi_passbands(init_mode).hi;if(!isNumber(_hi))_hi=4000;snd_send('SET mod='+init_mode+' low_cut='+_lo+' high_cut='+_hi+' freq='+init_frequency);set_agc();snd_send("SET browser="+navigator.userAgent);if(snd_winf!=0)snd_send('SET window_func='+snd_winf);wf_send("SERVER DE CLIENT openwebrx.js W/F");wf_send("SET send_dB=1");wf_send("SET zoom=0 start=0");wf_send("SET maxdb=0 mindb=-100");if(wf_compression==0)wf_send('SET wf_comp=0');if(wf_interp!=-1)wf_send('SET interp='+wf_interp);if(wf_winf!=0)wf_send('SET window_func='+wf_winf);wf_speed=wf_rates[wf_rate];if(wf_speed==undefined)wf_speed=WF_SPEED_FAST;wf_send('SET wf_speed='+wf_speed);}
var ptype={HIDE:0,POPUP:1,TOGGLE:2};var popt={CLOSE:-1,PERSIST:0};var visBorder=10;var visIcon=24;var readme_color='blueViolet';var show_news=false;var news_color='#ff00bf';function init_panels(){init_panel_toggle(ptype.TOGGLE,'id-control',false,popt.PERSIST);var readme_firsttime=updateCookie('readme','seen2');if(kiwi_isMobile())readme_firsttime=false;init_panel_toggle(ptype.TOGGLE,'id-readme',false,readme_firsttime?popt.PERSIST:popt.CLOSE,readme_color);var news_firsttime=(readCookie('news','seen')==null);init_panel_toggle(ptype.POPUP,'id-news',false,show_news?(news_firsttime?popt.PERSIST:popt.CLOSE):popt.CLOSE);init_panel_toggle(ptype.POPUP,'id-ext-controls',false,popt.CLOSE);init_panel_toggle(ptype.POPUP,'id-confirmation',false,popt.CLOSE);}
function init_panel_toggle(type,panel,scrollable,timeo,color){var divPanel=w3_el(panel);divPanel.ptype=type;var divVis=w3_el(panel+'-vis');divPanel.scrollable=(scrollable==true)?true:false;var visHoffset=(divPanel.scrollable)?-kiwi_scrollbar_width():visBorder;var rightSide=(divPanel.getAttribute('data-panel-pos')=="right");divPanel.panelShown=1;if(type==ptype.TOGGLE){var hide=rightSide?'right':'left';var show=rightSide?'left':'right';divVis.innerHTML='<a id="'+panel+'-hide" onclick="toggle_panel('+sq(panel)+');"><img src="icons/hide'+hide+'.24.png" width="24" height="24" /></a>'+'<a id="'+panel+'-show" class="class-vis-show" onclick="toggle_panel('+sq(panel)+');"><img src="icons/hide'+show+'.24.png" width="24" height="24" /></a>';}else{divVis.innerHTML='<a id="'+panel+'-close" onclick="toggle_panel('+sq(panel)+');">'+'<img id='+dq(panel+'-close-img')+' src="icons/close.24.png" width="24" height="24" />'+'</a>';}
var visOffset=divPanel.activeWidth-visIcon;if(rightSide){divVis.style.right=px(0);}else{divVis.style.left=px(visOffset+visHoffset);}
divVis.style.top=px(visBorder);if(timeo!=undefined){if(timeo>0){setTimeout(function(){toggle_panel(panel);},timeo);}else
if(timeo==popt.CLOSE){toggle_panel(panel);}else
if(type==ptype.POPUP){divPanel.style.visibility="visible";}}
if(color!=undefined){var divShow=w3_el(panel+'-show');if(divShow!=undefined)divShow.style.backgroundColor=divShow.style.borderColor=color;}
divPanel.init=true;}
function toggle_panel(panel,set){var divPanel=w3_el(panel);var divVis=w3_el(panel+'-vis');if(isDefined(set))divPanel.panelShown=set^1;if(divPanel.ptype==ptype.POPUP){divPanel.style.visibility=divPanel.panelShown?'hidden':'visible';divPanel.panelShown^=1;updateCookie(panel,'seen');freqset_select();return;}
var arrow_width=12,hideWidth=divPanel.activeWidth+2*15;var rightSide=(divPanel.getAttribute('data-panel-pos')=="right");var from,to;hideWidth=rightSide?-hideWidth:-hideWidth;if(divPanel.panelShown){from=0;to=hideWidth;}else{from=hideWidth;to=kiwi_isMobile()?0:kiwi_scrollbar_width();}
if(panel=='id-control'&&divPanel.panel_isScaled==true&&divPanel.panelShown){mobile_scale_control_panel(null,false);}
animate(divPanel,rightSide?'right':'left',"px",from,to,0.93,kiwi_isMobile()?1:1000,60,0);w3_hide(panel+'-'+(divPanel.panelShown?'hide':'show'));w3_show_block(panel+'-'+(divPanel.panelShown?'show':'hide'));divPanel.panelShown^=1;var visOffset=divPanel.activeWidth-visIcon;var visHoffset=(divPanel.scrollable)?-kiwi_scrollbar_width():visBorder;console.log("toggle_panel "+panel+" right="+rightSide+" shown="+divPanel.panelShown);if(rightSide)
divVis.style.right=px(divPanel.panelShown?0:(visOffset+visIcon+visBorder*2));else
divVis.style.left=px(visOffset+(divPanel.panelShown?visHoffset:(visIcon+visBorder*2)));if(panel=='id-control'&&divPanel.panel_isScaled==true&&divPanel.panelShown){mobile_scale_control_panel(null,true);}
freqset_select();}
function openwebrx_resize(a){a=(isString(a)&&a.startsWith('orient'))?a:'event';resize_wf_canvases();resize_waterfall_container(true);extint_environment_changed({resize:1,passband_screen_location:1});resize_scale(a);check_top_bar_congestion();}
var offsetDiff_init=false;var p_left,p_owner,p_mid,p_right;function offsetDiff(name,color,lrw,p_lrw){var el=w3_el('id-tbar-'+name.toLowerCase()+'-bbox');el.style.left=px(lrw.x1);el.style.width=px(lrw.w);el.style.height=px(lrw.h);el.style.backgroundColor=color;console.log(name+' L/R/W='+lrw.x1+'/'+lrw.x2+'/'+lrw.w+' ('+
(p_lrw.x1-lrw.x1)+'/'+(p_lrw.x2-lrw.x2)+'/'+(p_lrw.w-lrw.w)+')');}
function check_top_bar_congestion(){var left=w3_boundingBox_children('id-left-info-container');var owner=w3_boundingBox_children('id-mid-owner-container');var mid=w3_boundingBox_children('id-mid-info-container');var right=w3_boundingBox_children('id-topbar-right-container');var owner_left=left.x2+(mid.x1-left.x2)/2-owner.w/2;w3_el('id-owner-info').style.left=px(owner_left);owner=w3_boundingBox_children('id-mid-owner-container');w3_visible('id-mid-owner-container',owner.x1>=left.x2);w3_visible('id-mid-info-container',mid.x1>=left.x2);w3_visible('id-topbar-right-container',right.x1>=left.x2);w3_el('id-rx-details-arrow').style.left=px(left.x2);}
function init_top_bar(){var rx_loc=kiwi_decodeURIComponent('RX_LOC',cfg.index_html_params.RX_LOC);w3_innerHTML('id-rx-desc',rx_loc+' | Grid '+
w3_link('','https://www.levinecentral.com/ham/grid_square.php?Grid='+cfg.index_html_params.RX_QRA,cfg.index_html_params.RX_QRA,'','dont_toggle_rx_photo')+', ASL '+cfg.index_html_params.RX_ASL+', '+
w3_link('id-rx-gmap','','[map]','','dont_toggle_rx_photo')+
w3_div('id-rx-snr w3-show-inline'));}
var rx_photo_spacer_height=owrx.height_top_bar_parts;function init_rx_photo(){var el=w3_el('id-top-photo-img');el.src=kiwi_decodeURIComponent('RX_PHOTO_FILE',cfg.index_html_params.RX_PHOTO_FILE);el.alt=el.title=kiwi_decodeURIComponent('RX_PHOTO_DESC',cfg.index_html_params.RX_PHOTO_DESC);if(el.src.endsWith('kiwi/pcb.png')){var st1=w3_el('id-rx-photo-title');var st2=w3_el('id-rx-photo-desc');st1.style.background=st2.style.background='darkViolet';if(st1.innerText!='')st1.style.padding='0 6px 2px';if(st2.innerText!='')st2.style.padding='0 6px 2px';}
el.style.paddingLeft=cfg.index_html_params.RX_PHOTO_LEFT_MARGIN?'50px':0;owrx.RX_PHOTO_HEIGHT=+(cfg.index_html_params.RX_PHOTO_HEIGHT)+rx_photo_spacer_height;w3_el("id-top-photo-clip").style.maxHeight=px(owrx.RX_PHOTO_HEIGHT);if(dbgUs||kiwi_isMobile()){close_rx_photo();}else{window.setTimeout(function(){close_rx_photo()},3000);}}
var rx_photo_state=1;function open_rx_photo(){rx_photo_state=1;w3_opacity("id-rx-photo-desc",1);w3_opacity("id-rx-photo-title",1);animate_to("id-top-photo-clip","maxHeight","px",owrx.RX_PHOTO_HEIGHT,0.93,kiwi_isMobile()?1:1000,60,function(){resize_waterfall_container(true);});w3_hide('id-rx-details-arrow-down');w3_show_block('id-rx-details-arrow-up');}
function close_rx_photo(){rx_photo_state=0;animate_to("id-top-photo-clip","maxHeight","px",rx_photo_spacer_height,0.93,kiwi_isMobile()?1:1000,60,function(){resize_waterfall_container(true);});w3_show_block('id-rx-details-arrow-down');w3_hide('id-rx-details-arrow-up');}
dont_toggle_rx_photo_flag=0;function dont_toggle_rx_photo(){dont_toggle_rx_photo_flag=1;}
function toggle_rx_photo(){if(dont_toggle_rx_photo_flag){dont_toggle_rx_photo_flag=0;return;}
if(rx_photo_state)
close_rx_photo();else
open_rx_photo();freqset_select();}
function animate(object,style_name,unit,from,to,accel,time_ms,fps,to_exec){if(isUndefined(to_exec))to_exec=0;object.style[style_name]=from.toString()+unit;object.anim_i=0;n_of_iters=time_ms/(1000/fps);if(n_of_iters<1)n_of_iters=1;change=(to-from)/(n_of_iters);if(isDefined(object.anim_timer)){window.clearInterval(object.anim_timer);}
object.anim_timer=window.setInterval(function(){if(object.anim_i++<n_of_iters){if(accel==1)object.style[style_name]=(parseFloat(object.style[style_name])+change).toString()+unit;else{remain=parseFloat(object.style[style_name])-to;if(Math.abs(remain)>9||unit!="px")new_val=(to+accel*remain);else{if(Math.abs(remain)<2)new_val=to;else new_val=to+remain-(remain/Math.abs(remain));}
object.style[style_name]=new_val.toString()+unit;}}
else{object.style[style_name]=to.toString()+unit;window.clearInterval(object.anim_timer);delete object.anim_timer;}
if(to_exec!=0)to_exec();},1000/fps);}
function animate_to(id,style_name,unit,to,accel,time_ms,fps,to_exec){var el=w3_el(id);if(!el)return;from=parseFloat(style_value(el,style_name));animate(el,style_name,unit,from,to,accel,time_ms,fps,to_exec);}
function style_value(of_what,which){if(of_what.currentStyle)
return of_what.currentStyle[which];else
if(window.getComputedStyle)
return document.defaultView.getComputedStyle(of_what,null)[which];else
return of_what.style[which];}
demodulators=[]
demodulator_color_index=0;demodulator_colors=["#ffff00","#00ff00","#00ffff","#058cff","#ff9600","#a1ff39","#ff4e39","#ff5dbd"]
function demodulators_get_next_color(){if(demodulator_color_index>=demodulator_colors.length)demodulator_color_index=0;return(demodulator_colors[demodulator_color_index++]);}
function demod_envelope_draw(range,from,to,color,line){if(isUndefined(color))color='lime';var env_bounding_line_w=5;var env_att_w=5;var env_h1=17;var env_h2=5;var env_lineplus=1;var env_line_click_area=8;var env_slop=15;var env_adj=20;var env_slope=env_bounding_line_w+env_att_w;var from_px=scale_px_from_freq(from,range);var to_px=scale_px_from_freq(to,range);if(to_px<from_px){var temp_px=to_px;to_px=from_px;from_px=temp_px;}
pb_adj_cf.style.left=px(from_px+env_adj);pb_adj_cf.style.width=px(Math.max(0,to_px-from_px-2*env_adj));pb_adj_lo.style.left=px(from_px-env_slope-env_adj);pb_adj_lo.style.width=px(env_slope+2*env_adj);pb_adj_hi.style.left=px(to_px-env_adj);pb_adj_hi.style.width=px(env_slope+2*env_adj);from_px-=(env_att_w+env_bounding_line_w);to_px+=(env_att_w+env_bounding_line_w);scale_ctx.lineWidth=3;scale_ctx.strokeStyle=color;scale_ctx.fillStyle=color;var drag_ranges={envelope_on_screen:false,line_on_screen:false,allow_pb_adj:false};if(!(to_px<0||from_px>window.innerWidth)){drag_ranges.beginning={x1:from_px-env_adj,x2:from_px+env_slope+env_adj};drag_ranges.ending={x1:to_px-env_slope-env_adj,x2:to_px+env_adj};drag_ranges.whole_envelope={x1:from_px,x2:to_px};drag_ranges.envelope_on_screen=true;drag_ranges.allow_pb_adj=((to_px-from_px)>=50);if(!drag_ranges.allow_pb_adj)
scale_ctx.strokeStyle=scale_ctx.fillStyle='yellow';scale_ctx.beginPath();scale_ctx.moveTo(from_px,env_h1);scale_ctx.lineTo(from_px+env_bounding_line_w,env_h1);scale_ctx.lineTo(from_px+env_slope,env_h2);scale_ctx.lineTo(to_px-env_bounding_line_w-env_att_w,env_h2);scale_ctx.lineTo(to_px-env_bounding_line_w,env_h1);scale_ctx.lineTo(to_px,env_h1);scale_ctx.globalAlpha=0.3;scale_ctx.fill();scale_ctx.globalAlpha=1;scale_ctx.stroke();}
if(isDefined(line)){line_px=scale_px_from_freq(line,range);if(!(line_px<0||line_px>window.innerWidth)){drag_ranges.line={x1:line_px-env_line_click_area/2,x2:line_px+env_line_click_area/2};drag_ranges.line_on_screen=true;scale_ctx.moveTo(line_px,env_h1+env_lineplus);scale_ctx.lineTo(line_px,env_h2-env_lineplus);scale_ctx.stroke();pb_adj_car.style.left=px(drag_ranges.line.x1);pb_adj_car.style.width=px(env_line_click_area);}}
return drag_ranges;}
function demod_envelope_where_clicked(x,y,drag_ranges,key_modifiers){in_range=function(x,g_range){return g_range.x1<=x&&g_range.x2>=x&&y<scale_canvas_h/2;}
dr=demodulator.draggable_ranges;if(key_modifiers.shiftKey){if(drag_ranges.line_on_screen&&in_range(x,drag_ranges.line))return dr.bfo;if(drag_ranges.envelope_on_screen&&in_range(x,drag_ranges.whole_envelope))return dr.pbs;}
if(key_modifiers.altKey){if(drag_ranges.envelope_on_screen&&in_range(x,drag_ranges.beginning))return dr.bwlo;if(drag_ranges.envelope_on_screen&&in_range(x,drag_ranges.ending))return dr.bwhi;}
if(drag_ranges.envelope_on_screen){if(drag_ranges.allow_pb_adj){if(in_range(x,drag_ranges.beginning))return dr.beginning;if(in_range(x,drag_ranges.ending))return dr.ending;}
if(in_range(x,drag_ranges.whole_envelope))return dr.anything_else;}
return dr.none;}
demodulator=function(offset_frequency){this.offset_frequency=offset_frequency;this.has_audio_output=true;this.has_text_output=false;this.envelope={};this.color=demodulators_get_next_color();this.stop=function(){};}
demodulator.draggable_ranges={none:0,beginning:1,ending:2,anything_else:3,bfo:4,pbs:5,bwlo:6,bwhi:7,}
demodulator_response_time=100;var passbands_fallback={am:{lo:-4900,hi:4900},amn:{lo:-2500,hi:2500},sam:{lo:-4900,hi:4900},sal:{lo:-4900,hi:0},sau:{lo:0,hi:4900},sas:{lo:-4900,hi:4900},qam:{lo:-4900,hi:4900},drm:{lo:-5000,hi:5000},lsb:{lo:-2700,hi:-300},lsn:{lo:-2400,hi:-300},usb:{lo:300,hi:2700},usn:{lo:300,hi:2400},cw:{lo:300,hi:700,pbw:400},cwn:{lo:470,hi:530,pbw:60},nbfm:{lo:-6000,hi:6000},nnfm:{lo:-3000,hi:3000},iq:{lo:-5000,hi:5000},};function kiwi_passbands(mode){var pb=cfg.passbands[mode];if(isDefined(pb)){return pb;}else{console.log('kiwi_passbands('+mode+') fallback:');if(isUndefined(mode)){kiwi_trace();return passbands_fallback['am'];}else{console.log(passbands_fallback[mode]);return passbands_fallback[mode];}}}
function demodulator_default_analog(offset_frequency,subtype,locut,hicut){if(kiwi_passbands(subtype)==null)subtype='am';demodulator.call(this,offset_frequency);this.subtype=subtype;this.envelope.dragged_range=demodulator.draggable_ranges.none;var sampleRateDiv2=audio_input_rate?audio_input_rate/2:5000;this.filter={min_passband:4,high_cut_limit:sampleRateDiv2,low_cut_limit:-sampleRateDiv2};this.server_mode=subtype;var lo=locut;if(isNaN(lo)){lo=owrx.last_lo[subtype];if(isNaN(lo)){lo=kiwi_passbands(subtype).lo;}}
owrx.last_lo[subtype]=lo;var hi=hicut;if(isNaN(hi)){hi=owrx.last_hi[subtype];if(isNaN(hi)){hi=kiwi_passbands(subtype).hi;}}
owrx.last_hi[subtype]=hi;if(override_pbw!=''){var center=lo+(hi-lo)/2;var min=this.filter.min_passband;override_pbw=decodeURIComponent(override_pbw);var p=override_pbw.split(',');console.log('p.len='+p.length);var nlo=p[0].parseFloatWithUnits('k');console.log('nlo="'+p[0]+'" '+nlo);var nhi=NaN;if(p.length>1){nhi=p[1].parseFloatWithUnits('k');console.log('nhi="'+p[1]+'" '+nlo);}
if(p.length==1&&!isNaN(nlo)&&nlo>=min){lo=center-nlo/2;hi=center+nlo/2;}else
if(p.length==2&&!isNaN(nlo)&&!isNaN(nhi)&&nlo<nhi&&(nhi-nlo)>=min){lo=nlo;hi=nhi;}
override_pbw='';extint.override_pb=true;}
if(override_pbc!=''){var cpbhw=(hi-lo)/2;var cpbc=lo+cpbhw;var min=this.filter.min_passband;override_pbc=decodeURIComponent(override_pbc);var p=override_pbc.split(',');var pbc=p[0].parseFloatWithUnits('k');console.log('pbc='+dq(p[0])+' '+pbc);var pbw=NaN;if(p.length>1){pbw=p[1].parseFloatWithUnits('k');console.log('pbw='+dq(p[1])+' '+pbw);}
if(p.length==1&&!isNaN(pbc)){lo=pbc-cpbhw;hi=pbc+cpbhw;}else
if(p.length==2&&!isNaN(pbc)&&!isNaN(pbw)&&pbw>=min){lo=pbc-pbw/2;hi=pbc+pbw/2;}
override_pbc='';extint.override_pb=true;}
this.low_cut=Math.max(lo,this.filter.low_cut_limit);this.high_cut=Math.min(hi,this.filter.high_cut_limit);this.usePBCenter=false;this.isCW=false;switch(subtype){case'am':case'amn':case'sam':case'sal':case'sau':case'sas':case'qam':case'drm':case'nbfm':case'nnfm':case'iq':break;case'lsb':case'lsn':case'usb':case'usn':this.usePBCenter=true;break;case'cw':case'cwn':this.usePBCenter=true;this.isCW=true;break;default:console.log('DEMOD-new: unknown subtype='+subtype);break;}
this.wait_for_timer=false;this.set_after=false;this.set=function(){if(!this.wait_for_timer){this.doset();this.set_after=false;this.wait_for_timer=true;timeout_this=this;window.setTimeout(function(){timeout_this.wait_for_timer=false;if(timeout_this.set_after)timeout_this.set();},demodulator_response_time);}else{this.set_after=true;}}
this.doset=function(){var freq=(freq_car_Hz/1000).toFixed(3);var mode=this.server_mode;var locut=this.low_cut.toString();var hicut=this.high_cut.toString();var mparam=(ext_mode(mode).SAx)?(' param='+(owrx.chan_null|(owrx.SAM_opts<<owrx.SAM_opts_sft))):'';var s='SET mod='+mode+' low_cut='+locut+' high_cut='+hicut+' freq='+freq+mparam;snd_send(s);var changed=null;if(freq!=owrx.last_freq){changed=changed||{};changed.freq=1;owrx.last_freq=freq;}
if(mode!=owrx.last_mode){changed=changed||{};changed.mode=1;owrx.last_mode=mode;}
if(locut!=owrx.last_locut||hicut!=owrx.last_hicut){changed=changed||{};changed.passband=1;owrx.last_locut=locut;owrx.last_hicut=hicut;}
if(changed!=null){changed.passband_screen_location=1;extint_environment_changed(changed);}
if(muted_until_freq_set){toggle_or_set_mute(muted_initially);muted_until_freq_set=false;}
if(audio_meas_dly_ena){audio_meas_dly_start=(new Date()).getTime();}}
this.envelope.parent=this;this.envelope.draw=function(visible_range){this.visible_range=visible_range;this.drag_ranges=demod_envelope_draw(g_range,center_freq+this.parent.offset_frequency+this.parent.low_cut,center_freq+this.parent.offset_frequency+this.parent.high_cut,this.color,center_freq+this.parent.offset_frequency);var isAdjPBT=(owrx.last_shiftKey||this.dragged_range==demodulator.draggable_ranges.pbs);var bw=Math.abs(this.parent.high_cut-this.parent.low_cut);var bw_pbt;if(isAdjPBT){bw_pbt=', PBT';}else{bw_pbt=', bw '+bw.toString();}
pb_adj_lo_ttip.innerHTML='lo '+this.parent.low_cut.toString()+bw_pbt;pb_adj_hi_ttip.innerHTML='hi '+this.parent.high_cut.toString()+bw_pbt;pb_adj_cf_ttip.innerHTML='cf '+(this.parent.low_cut+Math.abs(this.parent.high_cut-this.parent.low_cut)/2).toString()+bw_pbt;var isAdjBFO=(owrx.last_shiftKey||this.dragged_range==demodulator.draggable_ranges.bfo);var f_kHz=(center_freq+this.parent.offset_frequency)/1000+kiwi.freq_offset_kHz;pb_adj_car_ttip.innerHTML=(isAdjBFO?'BFO ':'')+f_kHz.toFixed(freq_field_prec(f_kHz))+' kHz';};this.envelope.env_drag_start=function(x,y,key_modifiers){this.key_modifiers=key_modifiers;this.dragged_range=demod_envelope_where_clicked(x,y,this.drag_ranges,key_modifiers);this.drag_origin={x:x,low_cut:this.parent.low_cut,high_cut:this.parent.high_cut,offset_frequency:this.parent.offset_frequency};return this.dragged_range!=demodulator.draggable_ranges.none;};this.envelope.drag_move=function(x){var dr=demodulator.draggable_ranges;if(this.dragged_range==dr.none){return false;}
freq_change=Math.round(this.visible_range.hpp*(x-this.drag_origin.x));var is_adj_BFO=this.dragged_range==dr.bfo;var is_adj_locut=this.dragged_range==dr.beginning;var is_adj_hicut=this.dragged_range==dr.ending;var is_adj_bwlo=this.dragged_range==dr.bwlo;var is_adj_bwhi=this.dragged_range==dr.bwhi;var is_BFO_PBS_BW=is_adj_BFO||this.dragged_range==dr.pbs||is_adj_bwlo||is_adj_bwhi;var minus_lo=(is_adj_BFO||is_adj_bwhi)?-1:1;var minus_hi=(is_adj_BFO||is_adj_bwlo)?-1:1;var new_lo=this.drag_origin.low_cut;var do_lo=is_adj_locut||is_BFO_PBS_BW;if(do_lo)new_lo+=minus_lo*freq_change;var new_hi=this.drag_origin.high_cut;var do_hi=is_adj_hicut||is_BFO_PBS_BW;if(do_hi)new_hi+=minus_hi*freq_change;if(do_lo){if(new_lo<this.parent.filter.low_cut_limit){return true;}
if(new_hi-new_lo<this.parent.filter.min_passband){return true;}
if(new_lo>=new_hi){return true;}}
if(do_hi){if(new_hi>this.parent.filter.high_cut_limit){return true;}
if(new_hi-new_lo<this.parent.filter.min_passband){return true;}
if(new_hi<=new_lo){return true;}}
if(do_lo){owrx.last_lo[this.parent.server_mode]=this.parent.low_cut=new_lo;}
if(do_hi){owrx.last_hi[this.parent.server_mode]=this.parent.high_cut=new_hi;}
if(this.dragged_range==dr.anything_else||is_adj_BFO){new_value=this.drag_origin.offset_frequency+freq_change;if(new_value>bandwidth/2||new_value<-bandwidth/2){return true;}
this.parent.offset_frequency=new_value;}
mkenvelopes(this.visible_range);freqset_car_Hz(this.parent.offset_frequency+center_freq);this.parent.set();freqset_update_ui((do_lo||do_hi)?owrx.FSET_PB_CHANGE:owrx.FSET_NOP);return true;};this.envelope.drag_end=function(x){to_return=this.dragged_range!=demodulator.draggable_ranges.none;this.dragged_range=demodulator.draggable_ranges.none;return to_return;};}
function add_shift_listener(el){el.addEventListener("mouseover",shift_event,true);}
function shift_event(evt,from){from=from||'mouseover';var ok=(evt&&(evt.type=='mouseover'||(evt.key&&evt.key=='Shift')));if(!ok)return;if(evt.key&&evt.key=='Shift'){owrx.last_shiftKey=evt.shiftKey;}
if(demodulators[0]&&demodulators[0].envelope.dragged_range==demodulator.draggable_ranges.none)
mkenvelopes(get_visible_freq_range());}
demodulator_default_analog.prototype=new demodulator();function mkenvelopes(visible_range){scale_ctx.clearRect(0,0,scale_ctx.canvas.width,22);scale_ctx.font='13px sans-serif';scale_ctx.textBaseline='top';scale_ctx.fillStyle='white';scale_ctx.textAlign="left";scale_ctx.fillText('database: '+dx.db_s[dx.db].split(' ')[0],20,7);for(var i=0;i<demodulators.length;i++){demodulators[i].envelope.draw(visible_range);}}
function demodulator_remove(which){demodulators[which].stop();demodulators.splice(which,1);}
function demodulator_add(what){demodulators.push(what);if(waterfall_setup_done)mkenvelopes(get_visible_freq_range());}
function demodulator_analog_replace(subtype,freq){if(kiwi_passbands(subtype)==null)subtype='am';var offset=0,prev_pbo=0;var wasCW=false,toCW=false,fromCW=false;if(demodulators.length){wasCW=demodulators[0].isCW;offset=demodulators[0].offset_frequency;prev_pbo=passband_offset();demodulator_remove(0);}else{var i_freqHz=Math.round((init_frequency-kiwi.freq_offset_kHz)*1000);offset=(i_freqHz<=0||i_freqHz>bandwidth)?0:(i_freqHz-center_freq);subtype=isArg(init_mode)?init_mode:'am';}
if(isArg(freq)){offset=freq-center_freq;}
demodulator_add(new demodulator_default_analog(offset,subtype,NaN,NaN));if(!wasCW&&demodulators[0].isCW)
toCW=true;if(wasCW&&!demodulators[0].isCW)
fromCW=true;if(isArg(freq)){freq_car_Hz=freq_dsp_to_car(freq);offset=freq_car_Hz-center_freq;wf.audioFFT_clear_wf=true;}else{var pbo=0;if(toCW)pbo=-passband_offset();if(fromCW)pbo=prev_pbo;offset+=pbo;if(toCW||fromCW)
wf.audioFFT_clear_wf=true;}
if(cur_mode!='drm')
extint.prev_mode=cur_mode;cur_mode=subtype;if(toCW||fromCW)
set_agc();demodulator_set_offset_frequency(owrx.FSET_ADD,offset);try_modeset_update_ui(subtype);}
function demodulator_set_offset_frequency(which,offset){if(offset>bandwidth/2||offset<-bandwidth/2)return;offset=Math.round(offset);freqset_car_Hz(offset+center_freq);var demod=demodulators[0];demod.offset_frequency=offset;demod.set();try_freqset_update_ui(which);}
function owrx_init_cfg(){w3_do_when_rendered('id-rx-gmap',function(){var rx_gmap=kiwi_decodeURIComponent('RX_GMAP',cfg.index_html_params.RX_GMAP);w3_link_set('id-rx-gmap','https://www.google.com/maps/place/'+rx_gmap);});owrx.cfg_loaded=true;}
var scale_ctx,band_ctx,dx_ctx;var pb_adj_cf,pb_adj_cf_ttip,pb_adj_lo,pb_adj_lo_ttip,pb_adj_hi,pb_adj_hi_ttip,pb_adj_car,pb_adj_car_ttip;var scale_canvas,band_canvas,dx_div,dx_canvas;function scale_setup(){w3_el('id-scale-container').addEventListener("mouseout",scale_container_mouseout,false);scale_canvas=w3_el("id-scale-canvas");scale_ctx=scale_canvas.getContext("2d");add_scale_listener(scale_canvas);pb_adj_car=w3_el("id-pb-adj-car");pb_adj_car.innerHTML='<span id="id-pb-adj-car-ttip" class="class-passband-adjust-car-tooltip class-tooltip-text"></span>';pb_adj_car_ttip=w3_el("id-pb-adj-car-ttip");add_scale_listener(pb_adj_car);add_shift_listener(pb_adj_car);pb_adj_lo=w3_el("id-pb-adj-lo");pb_adj_lo.innerHTML='<span id="id-pb-adj-lo-ttip" class="class-passband-adjust-cut-tooltip class-tooltip-text"></span>';pb_adj_lo_ttip=w3_el("id-pb-adj-lo-ttip");add_scale_listener(pb_adj_lo);add_shift_listener(pb_adj_lo);pb_adj_hi=w3_el("id-pb-adj-hi");pb_adj_hi.innerHTML='<span id="id-pb-adj-hi-ttip" class="class-passband-adjust-cut-tooltip class-tooltip-text"></span>';pb_adj_hi_ttip=w3_el("id-pb-adj-hi-ttip");add_scale_listener(pb_adj_hi);add_shift_listener(pb_adj_hi);pb_adj_cf=w3_el("id-pb-adj-cf");pb_adj_cf.innerHTML='<span id="id-pb-adj-cf-ttip" class="class-passband-adjust-cf-tooltip class-tooltip-text"></span>';pb_adj_cf_ttip=w3_el("id-pb-adj-cf-ttip");add_scale_listener(pb_adj_cf);add_shift_listener(pb_adj_cf);band_canvas=w3_el("id-band-canvas");band_ctx=band_canvas.getContext("2d");add_canvas_listener(band_canvas);dx_div=w3_el('id-dx-container');add_canvas_listener(dx_div);dx_canvas=w3_el("id-dx-canvas");dx_ctx=dx_canvas.getContext("2d");add_canvas_listener(dx_canvas);resize_scale('setup');}
function add_scale_listener(obj){obj.addEventListener("mousedown",scale_canvas_mousedown,false);obj.addEventListener("mousemove",scale_canvas_mousemove,false);obj.addEventListener("mouseup",scale_canvas_mouseup,false);obj.addEventListener("contextmenu",scale_canvas_contextmenu,false);obj.addEventListener("wheel",canvas_mousewheel,false);if(kiwi_isMobile()){obj.addEventListener('touchstart',scale_canvas_touchStart,false);obj.addEventListener('touchmove',scale_canvas_touchMove,false);obj.addEventListener('touchend',scale_canvas_touchEnd,false);}}
function scale_canvas_contextmenu(evt){return cancelEvent(evt);}
var scale_canvas_drag_params={mouse_down:false,drag:false,start_x:0,last_x:0,start_y:0,last_y:0,key_modifiers:{shiftKey:false,altKey:false,ctrlKey:false}};function scale_canvas_mousedown(evt){scale_canvas_drag_params.drag=false;scale_canvas_drag_params.start_x=evt.pageX;scale_canvas_drag_params.start_y=evt.pageY;scale_canvas_drag_params.key_modifiers.shiftKey=evt.shiftKey;scale_canvas_drag_params.key_modifiers.altKey=evt.altKey;scale_canvas_drag_params.key_modifiers.ctrlKey=evt.ctrlKey;scale_canvas_start_drag(evt,1);evt.preventDefault();}
function scale_canvas_touchStart(evt){scale_canvas_drag_params.drag=false;scale_canvas_drag_params.last_x=start_x=evt.targetTouches[0].pageX;scale_canvas_drag_params.last_y=start_y=evt.targetTouches[0].pageY;scale_canvas_drag_params.key_modifiers.shiftKey=false;scale_canvas_drag_params.key_modifiers.altKey=false;scale_canvas_drag_params.key_modifiers.ctrlKey=false;scale_canvas_start_drag(evt,0);touch_restore_tooltip_visibility(owrx.scale_canvas);evt.preventDefault();}
var scale_canvas_ignore_mouse_event=false;function scale_canvas_start_drag(evt,isMouse){if(evt.button==mouse.right&&!evt.ctrlKey){right_click_menu(scale_canvas_drag_params.start_x,scale_canvas_drag_params.start_y,1);scale_canvas_drag_params.mouse_down=owrx.scale_canvas.mouse_out=false;scale_canvas_ignore_mouse_event=true;return;}
scale_canvas_drag_params.mouse_down=true;owrx.scale_canvas.target=evt.target;if(isMouse)scale_canvas_mousemove(evt);}
function scale_offset_carfreq_from_px(x,visible_range){if(isUndefined(visible_range))visible_range=get_visible_freq_range();var offset=passband_offset();var f=visible_range.start+visible_range.bw*(x/wf_container.clientWidth);return f-center_freq-offset;}
function scale_canvas_drag(evt,x,y){if(scale_canvas_ignore_mouse_event)return;var event_handled=0;var relX=Math.abs(x-scale_canvas_drag_params.start_x);if(scale_canvas_drag_params.mouse_down&&!scale_canvas_drag_params.drag){scale_canvas_drag_params.drag=true;for(var i=0;i<demodulators.length;i++)
event_handled|=demodulators[i].envelope.env_drag_start(x,y,scale_canvas_drag_params.key_modifiers);evt.target.style.cursor="move";}
if(scale_canvas_drag_params.drag){for(var i=0;i<demodulators.length;i++)
event_handled|=demodulators[i].envelope.drag_move(x);if(!event_handled)
demodulator_set_offset_frequency(owrx.FSET_SCALE_DRAG,scale_offset_carfreq_from_px(x));scale_canvas_drag_params.last_x=x;}}
function scale_canvas_mousemove(evt){scale_canvas_drag(evt,evt.pageX,evt.offsetY);}
function scale_canvas_touchMove(evt){for(var i=0;i<evt.touches.length;i++){var offsetY=evt.touches[i].pageY-owrx.scale_offsetY;scale_canvas_drag(evt,evt.touches[i].pageX,offsetY);}
evt.preventDefault();}
function scale_canvas_end_drag(evt,x,canvas_mouse_up){if(scale_canvas_ignore_mouse_event){scale_canvas_ignore_mouse_event=scale_canvas_drag_params.mouse_down=false;return;}
if(scale_canvas_drag_params.mouse_down==true&&evt.type=="mouseout"){owrx.scale_canvas.mouse_out=true;return;}
scale_canvas_drag_params.drag=false;var event_handled=false;if(scale_canvas_drag_params.mouse_down==true){for(var i=0;i<demodulators.length;i++)event_handled|=demodulators[i].envelope.drag_end(x);if(!event_handled)demodulator_set_offset_frequency(owrx.FSET_SCALE_DRAG_END,scale_offset_carfreq_from_px(x));}
scale_canvas_drag_params.mouse_down=false;var target=owrx.scale_canvas.target;if(target&&target.style){target.style.cursor=null;}}
function scale_canvas_mouseup(evt){scale_canvas_end_drag(evt,evt.pageX);}
function touch_hide_tooltip(evt,state){var unHover='';var pe=state.target;if(w3_contains(pe,'class-tooltip')){var ce=pe.childNodes[0];if(w3_contains(ce,'class-tooltip-text')){unHover+='-T';state.restore_visibility_timeout=setTimeout(function(){ce.style.visibility='hidden';state.restore_visibility.push(ce);},state.restore_visibility_delay);}}}
function touch_restore_tooltip_visibility(state){kiwi_clearTimeout(state.restore_visibility_timeout);state.restore_visibility.forEach(function(el){el.style.visibility='';});state.restore_visibility=[];}
function scale_canvas_touchEnd(evt){scale_canvas_end_drag(evt,scale_canvas_drag_params.last_x);touch_hide_tooltip(evt,owrx.scale_canvas);evt.preventDefault();}
function scale_container_mouseout(evt){var trel=evt.relatedTarget;trel=(isObject(trel)&&trel!=null&&isDefined(trel.id))?trel.id:null;if(trel&&(trel.startsWith('id-pb-adj')||trel.startsWith('id-scale')))return;scale_canvas_mouseup(evt);}
function scale_px_from_freq(f,range){return Math.round(((f-range.start)/ range.bw)*wf_container.clientWidth);}
function scale_px_from_freq_offset(f,range){return Math.round(((f-range.start_offset)/ range.bw)*wf_container.clientWidth);}
function get_visible_freq_range(){out={};if(wf.audioFFT_active&&cur_mode&&demodulators.length!=0){var off,span;var srate=Math.round(audio_input_rate||12000);if(ext_is_IQ_or_stereo_curmode()){off=0;span=srate;}else
if(ext_mode(cur_mode).LSB_SAL){off=0;span=srate/2;}else{off=srate/4;span=srate/2;}
out.center=center_freq+demodulators[0].offset_frequency+off;out.start=out.center-span;out.end=out.center+span;x_bin=freq_to_bin(out.start);out.bw=out.end-out.start;out.hpp=out.bw / scale_canvas.clientWidth;}else{var bins=bins_at_cur_zoom();out.start=bin_to_freq(x_bin);out.center=bin_to_freq(x_bin+bins/2);out.end=bin_to_freq(x_bin+bins);out.bw=out.end-out.start;out.hpp=out.bw / scale_canvas.clientWidth;}
out.start_offset=out.start+kiwi.offset_frac;return out;}
var scale_markers_levels=[{"hz_per_large_marker":10000000,"estimated_text_width":70,"format":"{x} ","pre_divide":1000000,"decimals":0},{"hz_per_large_marker":5000000,"estimated_text_width":70,"format":"{x} ","pre_divide":1000000,"decimals":0},{"hz_per_large_marker":1000000,"estimated_text_width":70,"format":"{x} ","pre_divide":1000000,"decimals":0},{"hz_per_large_marker":500000,"estimated_text_width":70,"format":"{x} ","pre_divide":1000000,"decimals":1},{"hz_per_large_marker":100000,"estimated_text_width":70,"format":"{x} ","pre_divide":1000000,"decimals":1},{"hz_per_large_marker":50000,"estimated_text_width":70,"format":"{x} ","pre_divide":1000000,"decimals":2},{"hz_per_large_marker":10000,"estimated_text_width":70,"format":"{x} ","pre_divide":1000000,"decimals":2},{"hz_per_large_marker":5000,"estimated_text_width":70,"format":"{x} ","pre_divide":1000000,"decimals":3},{"hz_per_large_marker":1000,"estimated_text_width":70,"format":"{x} ","pre_divide":1000000,"decimals":3}];var scale_min_space_btwn_texts=50;var scale_min_space_btwn_small_markers=7;function get_scale_mark_spacing(range){out={};fcalc=function(mkr_spacing){out.numlarge=(range.bw/mkr_spacing);out.pxlarge=wf_container.clientWidth/out.numlarge;out.ratio=5;out.pxsmall=out.pxlarge/out.ratio;if(out.pxsmall<scale_min_space_btwn_small_markers)return false;if(out.pxsmall/2>=scale_min_space_btwn_small_markers&&mkr_spacing.toString()[0]!="5"){out.pxsmall/=2;out.ratio*=2;}
out.smallbw=mkr_spacing/out.ratio;return true;}
for(var i=scale_markers_levels.length-1;i>=0;i--){mp=scale_markers_levels[i];if(!fcalc(mp.hz_per_large_marker))continue;if(out.pxlarge-mp.estimated_text_width>scale_min_space_btwn_texts)break;}
out.params=mp;return out;}
var g_range;function mk_freq_scale(){g_range=get_visible_freq_range();mkenvelopes(g_range);scale_ctx.clearRect(0,22,scale_ctx.canvas.width,scale_ctx.canvas.height-22);scale_ctx.strokeStyle="#fff";scale_ctx.font="bold 12px sans-serif";scale_ctx.textBaseline="top";scale_ctx.fillStyle="#fff";var spacing=get_scale_mark_spacing(g_range);var marker_hz=Math.ceil(g_range.start_offset / spacing.smallbw)*spacing.smallbw;var marker_hz_offset=marker_hz+kiwi.freq_offset_Hz-kiwi.offset_frac;text_y_pos=22+10+(kiwi_isFirefox()?3:0);var text_to_draw;var ftext=function(fo){var f=fo;var pre_divide=spacing.params.pre_divide;var decimals=spacing.params.decimals;f+=kiwi.freq_offset_Hz-kiwi.offset_frac;if(f<1e6){pre_divide /=1000;decimals=0;}
text_to_draw=format_frequency(spacing.params.format+((f<1e6)?'kHz':'MHz'),f,pre_divide,decimals);}
var last_large;var conv_ct=0;for(;;){conv_ct++;if(conv_ct>1000)break;var x=scale_px_from_freq_offset(marker_hz,g_range);if(x>window.innerWidth)break;scale_ctx.beginPath();scale_ctx.moveTo(x,22);if(marker_hz_offset%spacing.params.hz_per_large_marker==0){if(isUndefined(first_large))var first_large=marker_hz;last_large=marker_hz;scale_ctx.lineWidth=3.5;scale_ctx.lineTo(x,22+11);ftext(marker_hz);var text_measured=scale_ctx.measureText(text_to_draw);scale_ctx.textAlign="center";if(zoom_level==0&&g_range.start+spacing.smallbw*spacing.ratio>marker_hz){if(x<=text_measured.width/2){if(scale_px_from_freq_offset(marker_hz+spacing.smallbw*spacing.ratio,g_range)-text_measured.width>=scale_min_space_btwn_texts){scale_ctx.textAlign="left";scale_ctx.fillText(text_to_draw,0,text_y_pos);}}else{scale_ctx.fillText(text_to_draw,x,text_y_pos);}}else
if(zoom_level==0&&g_range.end-spacing.smallbw*spacing.ratio<marker_hz){if(x>window.innerWidth-text_measured.width/2){if(window.innerWidth-text_measured.width-scale_px_from_freq_offset(marker_hz-spacing.smallbw*spacing.ratio,g_range)>=scale_min_space_btwn_texts){scale_ctx.textAlign="right";scale_ctx.fillText(text_to_draw,window.innerWidth,text_y_pos);}}else{scale_ctx.fillText(text_to_draw,x,text_y_pos);}}else{scale_ctx.fillText(text_to_draw,x,text_y_pos);}}else{scale_ctx.lineWidth=2;scale_ctx.lineTo(x,22+8);}
marker_hz+=spacing.smallbw;marker_hz_offset+=spacing.smallbw;scale_ctx.stroke();}
if(conv_ct>1000){console.log("CONV_CT > 1000!!!");kiwi_trace();}
if(zoom_level!=0){scale_ctx.textAlign="center";var f=first_large-spacing.smallbw*spacing.ratio;var x=scale_px_from_freq_offset(f,g_range);ftext(f);var w=scale_ctx.measureText(text_to_draw).width;if(x+w/2>0)scale_ctx.fillText(text_to_draw,x,22+10);f=last_large+spacing.smallbw*spacing.ratio;x=scale_px_from_freq_offset(f,g_range);ftext(f);w=scale_ctx.measureText(text_to_draw).width;if(x-w/2<window.innerWidth)scale_ctx.fillText(text_to_draw,x,22+10);}}
var dx_car_size=8;var dx_car_border=3;var dx_car_w=dx_car_h=dx_car_border*2+dx_car_size;function resize_scale(a){band_ctx.canvas.width=window.innerWidth;band_ctx.canvas.height=band_canvas_h;dx_div.style.width=px(window.innerWidth);dx_ctx.canvas.width=dx_car_w;dx_ctx.canvas.height=dx_car_h;dx_canvas.style.top=px(scale_canvas_top-dx_car_h+2);dx_canvas.style.left=0;dx_canvas.style.zIndex=100;dx_show(false);dx_ctx.miterLimit=2;dx_ctx.lineJoin="round";dx_ctx.beginPath();dx_ctx.lineWidth=dx_car_border-1;dx_ctx.strokeStyle='black';var o=dx_car_border;var x=dx_car_size;dx_ctx.moveTo(o-1,o);dx_ctx.lineTo(o+x,o);dx_ctx.lineTo(o+x/2,o+x);dx_ctx.lineTo(o,o);dx_ctx.stroke();dx_ctx.fillStyle="yellow";dx_ctx.fill();scale_ctx.canvas.width=window.innerWidth;scale_ctx.canvas.height=scale_canvas_h;mkscale();dx_schedule_update();}
function format_frequency(format,freq_hz,pre_divide,decimals){out=format.replace("{x}",(freq_hz/pre_divide).toFixed(decimals));if(0){at=out.indexOf(".")+4;while(decimals>3){out=out.substr(0,at)+","+out.substr(at);at+=4;decimals-=3;}}
return out;}
function mkscale(){mk_freq_scale();mk_bands_scale();}
function bins_at_zoom(zoom){var bins=wf_fft_size<<(zoom_levels_max-zoom);return bins;}
function bins_at_cur_zoom(){return bins_at_zoom(zoom_level);}
function norm_to_bins(norm){return Math.round(norm*bins_at_cur_zoom());}
function bin_to_freq(bin){var max_bins=wf_fft_size<<zoom_levels_max;return Math.round((bin / max_bins)*bandwidth);}
function freq_to_bin(freq){var max_bins=wf_fft_size<<zoom_levels_max;return Math.round(freq/bandwidth*max_bins);}
function bins_to_pixels_frac(cf,bins,zoom){var bin_ratio=bins / bins_at_zoom(zoom);if(sb_trace)console.log('bins_to_pixels_frac bins='+bins+' z='+zoom+' ratio='+bin_ratio);if(bin_ratio>1)bin_ratio=1;if(bin_ratio<-1)bin_ratio=-1;var f_pixels=wf_fft_size*bin_ratio;return f_pixels;}
function bins_to_pixels(cf,bins,zoom){var f_pixels=bins_to_pixels_frac(cf,bins,zoom);var i_pixels=Math.round(f_pixels);return i_pixels;}
function freq_to_pixel(freq){var bins=freq_to_bin(freq)-x_bin;if(!(bins>=0&&bins<bins_at_cur_zoom())){console.log("freq_to_pixel: bins="+bins+" bins_at_cur_zoom="+bins_at_cur_zoom());console.assert("assert fail");}
var pixels=bins_to_pixels(0,bins,zoom_level);return pixels;}
function clamp_xbin(xbin){if(xbin<0)xbin=0;var max_bins=wf_fft_size<<zoom_levels_max;var max_xbin_at_cur_zoom=max_bins-bins_at_cur_zoom();if(xbin>max_xbin_at_cur_zoom)xbin=max_xbin_at_cur_zoom;return xbin;}
function passband_visible(){if(isUndefined(demodulators[0]))return x_bin;var f=freq_passband_center();var pb_bin=freq_to_bin(f);pb_bin=(pb_bin>=x_bin&&pb_bin<(x_bin+bins_at_cur_zoom()))?pb_bin:-pb_bin-1;return pb_bin;}
var window_width;var waterfall_width;var main_container;var wf_container;var canvas_annotation;var canvas_phantom;var annotation_div;function create_canvas(id,w,h,style_w,style_h){var new_canvas=document.createElement('canvas');new_canvas.id=id;new_canvas.width=w;new_canvas.height=h;if(style_w)new_canvas.style.width=px(style_w);if(style_h)new_canvas.style.height=px(style_h);new_canvas.ctx=new_canvas.getContext("2d");return new_canvas;}
function init_wf_container(){window_width=window.innerWidth;wf_container=w3_el("id-waterfall-container");waterfall_width=wf_container.clientWidth;canvas_annotation=create_canvas('id-annotation-canvas',wf_fft_size,wf_canvas_default_height,waterfall_width,wf_canvas_default_height);canvas_annotation.style.zIndex=1;wf_container.appendChild(canvas_annotation);add_canvas_listener(canvas_annotation);w3_el('id-kiwi-body').addEventListener('keyup',mouse_freq_remove,false);annotation_div=w3_el('id-annotation-div');add_canvas_listener(annotation_div);annotation_div.style.pointerEvents='none';canvas_phantom=w3_el('id-phantom-canvas');add_canvas_listener(canvas_phantom);canvas_phantom.style.width=px(wf_container.clientWidth);add_wf_canvas();spec.canvas=create_canvas('id-spectrum-canvas',wf_fft_size,spec.height_spectrum_canvas,waterfall_width,spec.height_spectrum_canvas);w3_el('id-spectrum-container').appendChild(spec.canvas);spec.ctx=spec.canvas.ctx;add_canvas_listener(spec.canvas);spec.ctx.font="10px sans-serif";spec.ctx.textBaseline="middle";spec.ctx.textAlign="left";spec.af_left=50;spec.af_margins=spec.af_left*2;spec.af_canvas=create_canvas('id-spectrum-af-canvas',wf_fft_size,spec.height_spectrum_canvas,waterfall_width-spec.af_margins,spec.height_spectrum_canvas);w3_el('id-spectrum-container').appendChild(spec.af_canvas);spec.af_canvas.style.left=px(spec.af_left);spec.af_canvas.style.position='absolute';spec.af_ctx=spec.af_canvas.ctx;add_canvas_listener(spec.af_canvas);spec.dB=w3_el('id-spectrum-dB');spec.dB.style.height=px(spec.height_spectrum_canvas);spec.dB.style.width=px(waterfall_width);spec.dB.innerHTML='<span id="id-spectrum-dB-ttip" class="class-spectrum-dB-tooltip class-tooltip-text"></span>';add_canvas_listener(spec.dB);w3_do_when_rendered('id-spectrum-dB-ttip',function(el){spec.dB_ttip=el;});document.addEventListener("mousemove",mouse_freq_add,false);}
function add_canvas_listener(obj){obj.addEventListener("mouseover",canvas_mouseover,false);obj.addEventListener("mouseout",canvas_mouseout,false);obj.addEventListener("mousedown",canvas_mousedown,false);obj.addEventListener("mousemove",canvas_mousemove,false);obj.addEventListener("mouseup",canvas_mouseup,false);obj.addEventListener("contextmenu",canvas_contextmenu,false);obj.addEventListener("wheel",canvas_mousewheel,false);if(kiwi_isMobile()){obj.addEventListener('touchstart',canvas_touchStart,false);obj.addEventListener('touchmove',canvas_touchMove,false);obj.addEventListener('touchend',canvas_touchEnd,false);}}
function remove_canvas_listener(obj){obj.removeEventListener("mouseover",canvas_mouseover,false);obj.removeEventListener("mouseout",canvas_mouseout,false);obj.removeEventListener("mousedown",canvas_mousedown,false);obj.removeEventListener("mousemove",canvas_mousemove,false);obj.removeEventListener("mouseup",canvas_mouseup,false);obj.removeEventListener("contextmenu",canvas_contextmenu,false);obj.removeEventListener("wheel",canvas_mousewheel,false);if(kiwi_isMobile()){obj.removeEventListener('touchstart',canvas_touchStart,false);obj.removeEventListener('touchmove',canvas_touchMove,false);obj.removeEventListener('touchend',canvas_touchEnd,false);}}
function canvas_contextmenu(evt){if(evt.target.id=='id-wf-canvas'){}
if(evt&&evt.currentTarget&&evt.currentTarget.id=='id-dx-container'){dx.ctrl_click=true;if(evt.target.id!='')
w3_el(evt.target.id).click();}
return cancelEvent(evt);}
function canvas_mouseover(evt){if(!waterfall_setup_done)return;}
function canvas_mouseout(evt){if(!waterfall_setup_done)return;if(canvas_dragging){var ignore=evt.target.id.startsWith('id-spectrum-dB');if(owrx.debug_drag)canvas_log('C-MOUT'+(ignore?' SPEC-IGNORE':''));if(!ignore)
canvas_end_drag2();}
mouse_freq_remove(evt);}
function canvas_get_carfreq_offset(relativeX,incl_PBO){var freq;var norm=relativeX/waterfall_width;if(wf.audioFFT_active){var cur=center_freq+demodulators[0].offset_frequency;var iq=ext_is_IQ_or_stereo_curmode();norm-=iq?0.5:0.25;var incr=norm*audio_input_rate*(iq?2:1);freq=cur+incr;}else{var bin=x_bin+norm*bins_at_cur_zoom();freq=bin_to_freq(bin);}
var offset=incl_PBO?passband_offset():0;var f=Math.round(freq-offset);var cfo=f-(bandwidth/2);return cfo;}
function canvas_get_dspfreq(relativeX){return canvas_get_carfreq_offset(relativeX,false)+center_freq;}
canvas_dragging=false;canvas_drag_min_delta=1;canvas_mouse_down_or_touch=false;canvas_ignore_mouse_event=false;var mouse={'left':0,'middle':1,'right':2};function canvas_start_drag(evt,x,y){if(owrx.debug_drag)canvas_log('CSD');if(evt.button==mouse.right&&!evt.ctrlKey){canvas_ignore_mouse_event=true;if(owrx.debug_drag)console.log('CSD-Rclick IME=set-true');if(owrx.debug_drag)canvas_log('ordinary-RCM');right_click_menu(x,y,2);canvas_ignore_mouse_event=false;if(owrx.debug_drag)console.log('CSD-Rclick IME=set-false');return;}
if(owrx.scale_canvas.mouse_out){event_dump(evt,"CSD-scale");console.log('SHOULD NOT OCCUR');return;}
if(evt.shiftKey&&evt.target.id=='id-dx-container'){canvas_ignore_mouse_event=true;if(owrx.debug_drag)console.log('CSD-DX IME=set-true');dx_show_edit_panel(evt,-1);}else
if(evt.shiftKey&&(evt.ctrlKey||evt.altKey)){canvas_ignore_mouse_event=true;if(owrx.debug_drag)console.log('CSD-lookup IME=set-true');freq_database_lookup(canvas_get_dspfreq(x),evt.ctrlKey?owrx.rcm_lookup:owrx.rcm_cluster);}else
if(evt.ctrlKey){canvas_ignore_mouse_event=true;if(owrx.debug_drag)console.log('CSD-pageScroll1 IME=set-true');page_scroll(-page_scroll_amount);}else
if(evt.altKey){canvas_ignore_mouse_event=true;if(owrx.debug_drag)console.log('CSD-pageScroll2 IME=set-true');page_scroll(page_scroll_amount);}
owrx.drag_count=0;canvas_mouse_down_or_touch=true;canvas_dragging=false;owrx.canvas.drag_last_x=owrx.canvas.drag_start_x=x;owrx.canvas.drag_last_y=owrx.canvas.drag_start_y=y;owrx.canvas.target=evt.target;return cancelEvent(evt);}
function canvas_mousedown(evt){if(owrx.debug_drag)canvas_log('$C-MD');canvas_start_drag(evt,evt.pageX,evt.pageY);evt.preventDefault();}
function canvas_touchStart(evt){var touches=evt.targetTouches.length;var x=Math.round(evt.targetTouches[0].pageX);var y=Math.round(evt.targetTouches[0].pageY);if(owrx.debug_drag)canvas_log("$C-TS"+touches+'-x'+x+'-y'+y);owrx.double_touch_start=false;if(touches==1){if(evt.target.id.startsWith('id-spectrum')){owrx.canvas.drag_last_x=owrx.canvas.drag_start_x=x;owrx.canvas.drag_last_y=owrx.canvas.drag_start_y=y;if(owrx.debug_drag)canvas_log('*SPEC*');}else{canvas_start_drag(evt,x,y);}}else
if(touches>=2){canvas_start_drag(evt,x,y);canvas_ignore_mouse_event=true;if(owrx.debug_drag)console.log('CTS-doubleTouch IME=set-true');owrx.touches_first_startx=x;var deltaX=evt.touches[0].pageX-evt.touches[1].pageX;var deltaY=evt.touches[0].pageY-evt.touches[1].pageY;owrx.pinch_distance_first=Math.round(Math.hypot(deltaX,deltaY));owrx.pinch_distance_last=owrx.pinch_distance_first;owrx.double_touch_swipe=(Math.abs(deltaY)<50);owrx.double_touch_start=true;}
touch_restore_tooltip_visibility(owrx.canvas);evt.preventDefault();}
function canvas_drag(evt,idx,x,y,clientX,clientY){if(!waterfall_setup_done)return;spectrum_tooltip_update(evt,clientX,clientY);owrx.drag_count=!isNumber(owrx.drag_count)?0:(owrx.drag_count+1);if(owrx.scale_canvas.mouse_out){scale_canvas_drag(evt,x,y);return;}
var sx=canvas_mouse_down_or_touch?owrx.canvas.drag_start_x:x;if(owrx.debug_drag)canvas_log('CD#'+owrx.drag_count+' x'+x+' y'+y+' dx'+Math.abs(x-sx)+' CMDT'+(canvas_mouse_down_or_touch?1:0)+' IME'+(canvas_ignore_mouse_event?1:0)+' DG'+(canvas_dragging?1:0));if(canvas_mouse_down_or_touch&&(!canvas_ignore_mouse_event||owrx.double_touch_start)){var min_drag_cnt=kiwi_isMobile()?10:1;var drag_cnt_b=(owrx.drag_count>min_drag_cnt);var drag_delta_b=(Math.abs(x-owrx.canvas.drag_start_x)>canvas_drag_min_delta);if(!canvas_dragging&&drag_cnt_b&&drag_delta_b){if(owrx.debug_drag)canvas_log('### dc='+owrx.drag_count+' >? '+min_drag_cnt+' && '+
Math.abs(x-owrx.canvas.drag_start_x)+' >? '+canvas_drag_min_delta+' '+
(drag_cnt_b?'T':'F')+(drag_delta_b?'T':'F'));canvas_dragging=true;wf_container.style.cursor="move";}
if(canvas_dragging){var deltaX=owrx.canvas.drag_last_x-x;var deltaY=owrx.canvas.drag_last_y-y;if(owrx.double_touch_start){if(owrx.double_touch_swipe){if(idx==0&&evt.touches.length>=2){var relX=Math.round(Math.abs((evt.touches[0].pageX+evt.touches[1].pageX)/ 2));demodulator_set_offset_frequency(owrx.FSET_SCALE_TOUCH_DRAG,canvas_get_carfreq_offset(relX,true));}}else{var dist=Math.round(Math.hypot(deltaX,deltaY));var dist_delta=Math.abs(dist-owrx.pinch_distance_last);if(owrx.debug_drag)canvas_log(dist.toFixed(0)+' '+dist_delta.toFixed(0));if(dist_delta>25){if(owrx.debug_drag)canvas_log('*');var pinch_in=(dist<=owrx.pinch_distance_last);zoom_step(pinch_in?ext_zoom.OUT:ext_zoom.IN);if(owrx.debug_drag)canvas_log(pinch_in?'IN':'OUT');owrx.pinch_distance_last=dist;}}}else{var dbins=norm_to_bins(deltaX / waterfall_width);waterfall_pan_canvases(dbins);}
owrx.canvas.drag_last_x=x;owrx.canvas.drag_last_y=y;}}}
function mouse_freq_add(evt){if(isNumber(evt.pageX))owrx.last_pageX=evt.pageX;if(isNumber(evt.pageY))owrx.last_pageY=evt.pageY;if(kiwi_isMobile()||wf.audioFFT_active)return;var ctx=canvas_annotation.ctx;if(evt.target==canvas_annotation&&(any_modifier_key(evt)||owrx.show_cursor_freq)){var cx=evt.offsetX;var cy=evt.offsetY+16;var tw,th=15;ctx.font=px(th)+' monospace';if(owrx.mouse_freq.vis)
ctx.clearRect(owrx.mouse_freq.tx,owrx.mouse_freq.cy,owrx.mouse_freq.tw,th);var f_kHz=(canvas_get_dspfreq(cx)+kiwi.freq_offset_Hz)/1000;owrx.mouse_freq.text=format_frequency("{x}",f_kHz,1,freq_field_prec(f_kHz));tw=Math.ceil(ctx.measureText(owrx.mouse_freq.text).width);if(tw&1)tw++;owrx.mouse_freq.tw=tw;owrx.mouse_freq.th=th;owrx.mouse_freq.tx=cx-tw/2;ctx.fillStyle='black';ctx.fillRect(cx-tw/2,cy,tw,th);ctx.fillStyle='white';ctx.fillText(owrx.mouse_freq.text,owrx.mouse_freq.tx,cy+th-2);owrx.mouse_freq.cx=cx;owrx.mouse_freq.cy=cy;owrx.mouse_freq.vis=true;}else{mouse_freq_remove(evt);}}
function mouse_freq_remove(evt){if(owrx.mouse_freq.vis){canvas_annotation.ctx.clearRect(owrx.mouse_freq.tx,owrx.mouse_freq.cy,owrx.mouse_freq.tw,owrx.mouse_freq.th);owrx.mouse_freq.vis=false;}
if(evt&&evt.type=='keyup')
shift_event(evt,'keyup');}
function canvas_mousemove(evt){canvas_drag(evt,0,evt.pageX,evt.pageY,evt.clientX,evt.clientY);}
function canvas_touchMove(evt){if(evt.touches.length>=1){owrx.touches_first_lastx=evt.touches[0].pageX;}
for(var i=0;i<evt.touches.length;i++){var x=Math.round(evt.touches[i].pageX);var y=Math.round(evt.touches[i].pageY);canvas_drag(evt,i,x,y,x,y);}
evt.preventDefault();}
function canvas_end_drag2(){if(owrx.debug_drag)canvas_log("C-ED2");wf_container.style.cursor=owrx.wf_cursor;canvas_mouse_down_or_touch=false;canvas_ignore_mouse_event=false;if(owrx.debug_drag){console.log("C-ED2 IME=set-false");}}
function canvas_end_drag(evt,x){if(owrx.scale_canvas.mouse_out){owrx.scale_canvas.mouse_out=false;scale_canvas_end_drag(evt,x,true);}
if(owrx.debug_drag)canvas_log('C-ED IME'+(canvas_ignore_mouse_event?1:0)+' CD'+(canvas_dragging?1:0));if(!waterfall_setup_done)return;if(!canvas_dragging){if(owrx.debug_drag)canvas_log('CMDT'+(canvas_mouse_down_or_touch?1:0)+' TL'+owrx.tuning_locked);if(canvas_mouse_down_or_touch&&!canvas_ignore_mouse_event){if(owrx.tuning_locked){var el=w3_el('id-tuning-lock-container');el.style.opacity=0.8;w3_show(el);var el2=w3_el('id-tuning-lock');el2.style.marginTop=px(w3_center_in_window(el2,'TL'));setTimeout(function(){el.style.opacity=0;setTimeout(function(){w3_hide(el);},500);},300);}else{if(owrx.debug_drag)canvas_log('*click*');if((evt.shiftKey&&!(evt.ctrlKey||evt.altKey))||owrx.wf_snap){var fold=canvas_get_dspfreq(x);var b=find_band(fold);var rv=freq_step_amount(b);var step_Hz=rv.step_Hz;var trunc=fold / step_Hz;var fnew=Math.round(trunc)*step_Hz;freqmode_set_dsp_kHz(fnew/1000,null);}else{demodulator_set_offset_frequency(owrx.FSET_SCALE_MOUSE_CLICK,canvas_get_carfreq_offset(x,true));}}}}else{canvas_end_drag2();}
canvas_mouse_down_or_touch=false;canvas_ignore_mouse_event=false;if(owrx.debug_drag)console.log('C-ED IME=set-false');}
function canvas_mouseup(evt){if(owrx.debug_drag)console.log("C-MU");if(owrx.debug_drag)canvas_log("C-MU");canvas_end_drag(evt,evt.pageX);}
function canvas_touchEnd(evt){var x=owrx.canvas.drag_last_x,y=owrx.canvas.drag_last_y;if(owrx.debug_drag)
canvas_log('C-TE-x'+x+'-DTS'+(owrx.double_touch_start?1:0)+'-DTSw'+(owrx.double_touch_swipe?1:0)+'-DRAG'+(canvas_dragging?1:0));canvas_end_drag(evt,x);spectrum_tooltip_update(evt,x,y);if(owrx.double_touch_start){if(owrx.debug_drag)canvas_log('DTS-D='+(canvas_dragging?'T':'F'));demodulator_set_offset_frequency(owrx.FSET_SCALE_TOUCH_DRAG_END,freq_car_Hz-center_freq);if(!canvas_dragging){if(kiwi_isMobile()&&owrx.mobile&&owrx.mobile.small)
x=10;if(owrx.debug_drag)canvas_log('*-RCM');right_click_menu(x,y,3);}else{}
canvas_ignore_mouse_event=false;if(owrx.debug_drag)console.log('CTE-doubleTouch IME=set-false');owrx.double_touch_start=false;}
touch_hide_tooltip(evt,owrx.canvas);evt.preventDefault();}
var canvas_mousewheel_rlimit=kiwi_rateLimit(canvas_mousewheel_cb,170);function canvas_mousewheel(evt){canvas_mousewheel_rlimit(evt);evt.preventDefault();}
function canvas_mousewheel_cb(evt){if(!waterfall_setup_done)return;var x=evt.deltaX;var y=evt.deltaY;var inout=(x<0||(x==0&&y<0));if(evt.target&&evt.target.id&&(evt.target.id=='id-scale-canvas'||evt.target.id.startsWith('id-pb-'))){var edge=owrx.PB_LEFT_EDGE;var key_mod=shortcut_key_mod(evt);if(key_mod==shortcut.NO_MODIFIER)edge=owrx.PB_NO_EDGE;else
if(key_mod==shortcut.SHIFT)edge=owrx.PB_RIGHT_EDGE;passband_increment(inout,edge);}else{var to_passband=(evt.ctrlKey||x!=0);zoom_step(inout?ext_zoom.IN:ext_zoom.OUT,to_passband?undefined:evt.pageX);}}
function right_click_menu_init(){var i=0;var m=[];m.push('DX database1');owrx.rcm_db1=i;i++;m.push('DX database2');owrx.rcm_db2=i;i++;m.push('open DX label panel');owrx.rcm_open=i;i++;m.push('edit last selected DX label');owrx.rcm_edit=i;i++;m.push('DX label filter');owrx.rcm_filter=i;i++;m.push('<hr>');i++;m.push('database lookup');owrx.rcm_lookup=i;i++;m.push('DX Cluster lookup');owrx.rcm_cluster=i;i++;m.push('<hr>');i++;m.push('snap to nearest');owrx.rcm_snap=i;i++;owrx.show_cursor_freq=+kiwi_storeGet('wf_showCurF',0);m.push((owrx.show_cursor_freq?'hide':'show')+' cursor frequency');owrx.rcm_cur_freq=i;i++;m.push('🔒 lock tuning');owrx.rcm_lock=i;i++;m.push('restore passband');owrx.rcm_pb=i;i++;m.push('save waterfall as JPG');owrx.rcm_save=i;i++;m.push('<hr>');i++;m.push('<i style="pointer-events:none">cal ADC clock (admin)</i>');owrx.rcm_cal=i;i++;m.push('<i style="pointer-events:none">set freq offset (admin)</i>');owrx.rcm_foff=i;i++;m.push('<i style="pointer-events:none">save noise defaults (admin)</i>');owrx.rcm_noise=i;i++;owrx.right_click_menu_content=m;w3_menu('id-right-click-menu','right_click_menu_cb');var s=w3_div('id-tuning-lock-container class-overlay-container w3-hide',w3_div('id-tuning-lock',w3_icon('','fa-lock',192)+'<br>Tuning locked'));w3_create_appendElement('id-w3-misc-container','div',s);}
function right_click_menu(x,y,which){if(owrx.debug_drag)canvas_log('RCM'+which);var db1=(dx.db+1)%dx.DB_N;var db2=(dx.db+2)%dx.DB_N;owrx.right_click_menu_content[owrx.rcm_db1]='DX '+dx.db_short_s[db1]+' database';owrx.right_click_menu_content[owrx.rcm_db2]='DX '+dx.db_short_s[db2]+' database';var kHz=freq_displayed_Hz/1000;var b=band_info();var db;if(kHz>=b.NDB_lo&&kHz<b.NDB_hi)db='NDB';else
if(kHz<b.LW_lo)db='VLF/LF';else
if(kHz<b.MW_hi)db='LW/MW';else
db='SWBC';owrx.right_click_menu_content[owrx.rcm_lookup]=db+' database lookup';owrx.right_click_menu_content[owrx.rcm_snap]=owrx.wf_snap?'no snap':'snap to nearest';w3_menu_items('id-right-click-menu',owrx.right_click_menu_content);w3_menu_popup('id-right-click-menu',function(evt,first){var close=((evt.type=='keyup'&&evt.key=='Escape')||(evt.type=='click'&&evt.button!=mouse.right)||(evt.type=='touchend'&&!first&&!w3_contains(evt.target,'w3-menu')));return close;},x,y);}
function right_click_menu_cb(idx,x,cbp){idx=+idx;switch(idx){case owrx.rcm_db2:dx.db=(dx.db+1)%dx.DB_N;case owrx.rcm_db1:dx.db=(dx.db+1)%dx.DB_N;dx_database_cb('',dx.db);break;case owrx.rcm_lookup:case owrx.rcm_cluster:freq_database_lookup(canvas_get_dspfreq(x),idx);break;case owrx.rcm_snap:wf_snap();break;case owrx.rcm_cur_freq:owrx.show_cursor_freq^=1;kiwi_storeSet('wf_showCurF',owrx.show_cursor_freq);owrx.right_click_menu_content[owrx.rcm_cur_freq]=(owrx.show_cursor_freq?'hide':'show')+' cursor frequency';break;case owrx.rcm_lock:owrx.tuning_locked^=1;owrx.right_click_menu_content[owrx.rcm_lock]=(owrx.tuning_locked?'🔓 unlock':'🔒 lock')+' tuning';break;case owrx.rcm_pb:restore_passband(cur_mode);demodulator_analog_replace(cur_mode);break;case owrx.rcm_save:export_waterfall();break;case owrx.rcm_open:case owrx.rcm_edit:var gid=-1;var edit_gid=(idx==owrx.rcm_edit&&dx.db==dx.DB_STORED&&isDefined(owrx.dx_click_gid_last_stored));if(edit_gid)
gid=owrx.dx_click_gid_last_stored;console.log('RCM rcm_'+(edit_gid?'edit':'open')+' gid='+gid+' db='+dx.db);dx_show_edit_panel(null,gid);dx_schedule_update();break;case owrx.rcm_filter:dx_filter();break;case owrx.rcm_cal:admin_pwd_query(function(){var r1k_kHz=Math.round(freq_displayed_Hz / 1e3);var r1k_Hz=r1k_kHz*1e3;var clk_diff=r1k_Hz-freq_displayed_Hz;var clk_adj=Math.round(clk_diff*ext_adc_clock_Hz()/ r1k_Hz);console.log('cal ADC clock: dsp='+freq_displayed_Hz+' car='+freq_car_Hz+' r1k_kHz='+r1k_kHz+' clk_diff='+clk_diff+' clk_adj='+clk_adj);var new_adj=cfg.clk_adj+clk_adj;var ppm=new_adj*1e6 / ext_adc_clock_Hz();console.log('cal ADC clock: prev_adj='+cfg.clk_adj+' new_adj='+new_adj+' ppm='+ppm.toFixed(1));cal_adc_dialog(new_adj,clk_diff,r1k_kHz,ppm);});break;case owrx.rcm_foff:admin_pwd_query(function(){set_freq_offset_dialog();});break;case owrx.rcm_noise:admin_pwd_query(function(){w3_call('noise_blank_save_defaults');w3_call('noise_filter_save_defaults');});break;case-1:default:break;}}
function freq_database_lookup(Hz,utility){var kHz=Hz/1000;var kHz_r10=Math.round(Hz/10)/100;var kHz_r1k=Math.round(Hz/1000);var f;var url="https://";var b=band_info();if(utility==owrx.rcm_lookup){if(kHz>=b.NDB_lo&&kHz<b.NDB_hi){f=kHz_r1k.toFixed(0);url+='rxx.classaxe.com/en/rww/signals?types=DGPS,NAVTEX,NDB&khz='+f+'&limit=-1';}else
if(kHz<b.LW_lo){f=Math.round(Hz/100)/ 10;console.log('kHz='+kHz+' f='+f);url+="www.mwlist.org/vlf.php?kHz="+f.toFixed(1);}else
if(kHz<b.MW_hi){f=Math.round(kHz_r1k/b._9_10)*b._9_10;console.log('MW kHz='+kHz+' f='+f);var mwlist_area=[0,1,3,2];url+="www.mwlist.org/mwlist_quick_and_easy.php?area="+mwlist_area[b.ITU_region]+"&kHz="+f.toFixed(0);}else{f=Math.round(kHz_r1k/5)*5;url+="www.short-wave.info/index.php?freq="+f.toFixed(0)+"&timbus=NOW&ip="+client_public_ip+"&porm=4";}}else
if(utility==owrx.rcm_cluster){f=Math.floor(Hz)/ 1000;url='http://ve3sun.com/KiwiSDR/DX.php?Search='+f.toFixed(1);}
console.log('LOOKUP '+kHz+' -> '+f+' '+url);var win=window.open(url,'_blank');if(win)win.focus();}
function export_waterfall(){var fscale=w3_el('id-scale-canvas');var wfW=waterfall_width;var fscaleW=wfW;var fscaleH=Math.round(fscale.height);var legendH=50;var h=legendH;var specC=w3_el('id-spectrum-canvas');var specH=(specC&&spec.source==spec.RF)?specC.height:0;var e_canvas=document.createElement("canvas");var e_ctx=e_canvas.getContext("2d");var e_canW=e_canvas.width=wf_fft_size;var e_canH=e_canvas.height=legendH+fscaleH+specH+(old_canvases.length+wf_canvases.length)*wf_canvas_default_height;e_ctx.fillStyle="black";e_ctx.fillRect(0,0,e_canW,e_canH);if(specH){e_ctx.drawImage(specC,0,h);h+=specH;}
e_ctx.fillStyle="gray";e_ctx.fillRect(0,h,e_canW,fscaleH);e_ctx.drawImage(fscale,0,0,fscaleW,fscaleH,0,h,e_canW,fscaleH);h+=fscaleH;wf_canvases.forEach(function(wf_c,i){var wfH=wf_c.height;var wfY=0;if(i==0){var top=unpx(wf_c.style.top);wfH=wfH+top;wfY=-top;}
e_ctx.drawImage(wf_c,0,wfY,e_canW,wfH,0,h,e_canW,wfH);h+=wfH;});if(old_canvases.length>1){for(i=1;i<old_canvases.length;i++){e_ctx.drawImage(old_canvases[i],0,h);h+=old_canvases[i].height;}}
e_ctx.font="18px Arial";e_ctx.fillStyle="lime";var flabel=kiwi_host()+'     '+(new Date()).toUTCString()+'     '+freq_displayed_kHz_str+' kHz  '+cur_mode;var x=e_canW/2-e_ctx.measureText(flabel).width/2;e_ctx.fillText(flabel,x,35);var imgURL=e_canvas.toDataURL("image/jpeg",0.85);var dlLink=document.createElement('a');dlLink.download=kiwi_timestamp_filename('','.jpg');dlLink.href=imgURL;dlLink.target='_blank';dlLink.dataset.downloadurl=["image/jpeg",dlLink.download,dlLink.href].join(':');document.body.appendChild(dlLink);dlLink.click();document.body.removeChild(dlLink);}
function zoom_finally(){w3_innerHTML('id-nav-optbar-wf','WF'+zoom_level.toFixed(0));wf_gnd_value=wf_gnd_value_base-zoomCorrection();extint_environment_changed({zoom:1,passband_screen_location:1});freqset_select();}
var ZOOM_NOMINAL=10,ZOOM_BAND=6;var zoom_nom=0,zoom_old_nom=0;var zoom_levels_max=0;var zoom_level=0;var zoom_level_f=0;var zoom_freq=0;var zoom_maxin_s=['id-maxin','id-maxin-nom','id-maxin-max'];var x_bin=0;function zoom_step(dir,arg2){if(wf.audioFFT_active){audioFFT_update();return;}
var out=(dir==ext_zoom.OUT);var dir_in=(dir==ext_zoom.IN);var not_band_and_not_abs=(dir!=ext_zoom.TO_BAND&&dir!=ext_zoom.ABS);var ozoom=zoom_level;var x_obin=x_bin;var x_norm;var update_zoom_f=true;var b1,b2;if(dir==ext_zoom.WHEEL){if(arg2==undefined)return;update_zoom_f=false;var znew=Math.round(zoom_level_f);if(znew==ozoom)return;dir=(znew>ozoom)?ext_zoom.IN:ext_zoom.OUT;}
if(dir==ext_zoom.MAX_OUT){out=true;zoom_level=0;x_bin=0;}else{if(not_band_and_not_abs&&((out&&zoom_level==0)||(dir_in&&zoom_level>=zoom_levels_max))){zoom_finally();return;}
if(dir==ext_zoom.TO_BAND){var f=center_freq+demodulators[0].offset_frequency;var cf;var band=arg2;if(band!=undefined){b1=band.b1;b2=band.b2;zoom_level=b2.zoom_level;cf=b2.cfHz;if(sb_trace)
console.log("ZTB-user f="+f+" cf="+cf+" b="+b1.name+" z="+b2.zoom_level);}else{var ITU_region=cfg.init.ITU_region+1;var _dxcfg=dx_cfg_db();if(!_dxcfg){zoom_finally();return;};var _kiwi_bands=kiwi_bands_db(dx.INIT_BANDS_NO);for(i=0;i<_dxcfg.bands.length;i++){b1=_dxcfg.bands[i];b2=_kiwi_bands[i];if(!(b1.itu==kiwi.BAND_SCALE_ONLY||b1.itu==kiwi.ITU_ANY||b1.itu==ITU_region))continue;if(f>=b2.minHz&&f<=b2.maxHz){break;}}
if(i!=_dxcfg.bands.length){zoom_level=b2.zoom_level;cf=b2.cfHz;}else{zoom_level=ZOOM_BAND;cf=f;}}
out=(zoom_level<ozoom);x_bin=freq_to_bin(cf);x_bin-=norm_to_bins(0.5);}else
if(dir==ext_zoom.ABS){if(arg2==undefined){zoom_finally();return;}
var znew=arg2;if(znew<0||znew>zoom_levels_max||znew==zoom_level){zoom_finally();return;}
out=(znew<zoom_level);zoom_level=znew;x_bin=freq_to_bin(freq_passband_center());x_bin-=norm_to_bins(0.5);}else
if(dir==ext_zoom.NOM_IN||dir==ext_zoom.MAX_IN){if(dir==ext_zoom.NOM_IN&&arg2!=undefined&&arg2==1&&zoom_level>=zoom_nom){if(zoom_level==zoom_levels_max)
zoom_level=zoom_nom;else
zoom_level=zoom_levels_max;}else{zoom_level=(dir==ext_zoom.NOM_IN)?zoom_nom:zoom_levels_max;}
out=(zoom_level<ozoom);x_bin=freq_to_bin(freq_passband_center());x_bin-=norm_to_bins(0.5);}else{if(dbgUs){if(sb_trace)console.log('ZOOM IN/OUT');sb_trace=0;}
if(arg2!=undefined){var x_rel=arg2;x_norm=x_rel / waterfall_width;}else{var pb_bin=passband_visible();if(pb_bin>=0){x_norm=(pb_bin-x_bin)/ bins_at_cur_zoom();}else{x_norm=0.5;}}
x_bin+=norm_to_bins(x_norm);zoom_level+=dir;x_bin-=norm_to_bins(x_norm);}}
if(update_zoom_f)zoom_level_f=zoom_level;var nom=(zoom_level==zoom_levels_max)?2:((zoom_level>=zoom_nom)?1:0);if(nom!=zoom_old_nom){w3_hide(zoom_maxin_s[zoom_old_nom]);w3_show(zoom_maxin_s[nom],'w3-show-table-cell');zoom_old_nom=nom;}
if(zoom_level==0||ozoom==0){w3_show_hide('id-maxout',zoom_level!=0,'w3-show-table-cell');w3_show_hide('id-maxout-max',zoom_level==0,'w3-show-table-cell');}
x_bin=clamp_xbin(x_bin);var dbins=out?(x_obin-x_bin):(x_bin-x_obin);var pixel_dx=bins_to_pixels(1,dbins,out?zoom_level:ozoom);if(sb_trace)console.log("Zs z"+ozoom+'>'+zoom_level+' b='+x_bin+'/'+x_obin+'/'+dbins+' bz='+bins_at_zoom(ozoom)+' r='+(dbins / bins_at_zoom(ozoom))+' px='+pixel_dx);var dz=zoom_level-ozoom;if(sb_trace)console.log('zoom_step oz='+ozoom+' zl='+zoom_level+' dz='+dz+' pdx='+pixel_dx);waterfall_zoom_canvases(dz,pixel_dx);mkscale();dx_schedule_update();if(sb_trace)console.log("SET Z"+zoom_level+" xb="+x_bin);wf_send("SET zoom="+zoom_level+" start="+x_bin);need_maxmindb_update=true;writeCookie('last_zoom',zoom_level);freq_link_update();vfo_update();zoom_finally();if(0&&dbgUs){var f=get_visible_freq_range();console.log('^ZOOM z'+zoom_level+' '+(f.start/1e3).toFixed(0)+'|'+
(f.center/1e3).toFixed(0)+'|'+(f.end/1e3).toFixed(0)+' ('+(f.bw/1e3).toFixed(0)+' kHz)');}}
function passband_increment(wider,pb_edge){if(isUndefined(pb_edge))pb_edge=owrx.PB_NO_EDGE;var pb=ext_get_passband();var pb_width=Math.abs(pb.high-pb.low);var pb_inc;if(wider)
pb_inc=((pb_width*(1/0.80))-pb_width)/ 2;else
pb_inc=(pb_width-(pb_width*0.80))/ 2;var rnd=(pb_inc>10)?10:1;pb_inc=Math.round(pb_inc/rnd)*rnd;console.log('PB w='+pb_width+' inc='+pb_inc+' lo='+pb.low+' hi='+pb.high+' pb_edge='+pb_edge);if(pb_edge==owrx.PB_NO_EDGE||pb_edge==owrx.PB_RIGHT_EDGE){pb.high+=wider?pb_inc:-pb_inc;pb.high=Math.round(pb.high/rnd)*rnd;}
if(pb_edge==owrx.PB_NO_EDGE||pb_edge==owrx.PB_LEFT_EDGE){pb.low+=wider?-pb_inc:pb_inc;pb.low=Math.round(pb.low/rnd)*rnd;}
ext_set_passband(pb.low,pb.high,true);}
function zoom_click(evt,dir,arg2){if(any_alternate_click_event(evt)){var div=evt.currentTarget;var zin=w3_contains(div,'id-zoom-in');var zout=w3_contains(div,'id-zoom-out');if(!zin&&!zout)return;var edge;var key_mod=shortcut_key_mod(evt);if(key_mod==shortcut.SHIFT)edge=owrx.PB_NO_EDGE;else
if(key_mod==shortcut.CTL_ALT)edge=owrx.PB_RIGHT_EDGE;else
edge=owrx.PB_LEFT_EDGE;passband_increment(zin,edge);return;}
if(dir==ext_zoom.NOM_IN)
zoom_step(dir,1);else
zoom_step(dir);}
function zoom_over(evt){if(evt.target.nodeName!='IMG')return;var img=evt.target;var div=evt.currentTarget;var zin=w3_contains(div,'id-zoom-in');var key_mod=shortcut_key_mod(evt);if(key_mod!=shortcut.NO_MODIFIER){key_mod=(key_mod==shortcut.SHIFT)?0:((key_mod==shortcut.CTL_ALT)?1:2);img.title=owrx.zoom_titles[key_mod][zin];}else{img.removeAttribute('title');}}
function mobile_init(){var mobile=owrx.mobile=ext_mobile_info();if(mobile.small){toggle_or_set_hide_bars(owrx.HIDE_TOPBAR);optbar_focus('optbar-off','init');}
if(mobile.narrow){w3_hide('id-readme');if(mobile.width<600){toggle_or_set_hide_bars(owrx.HIDE_ALLBARS);}}
owrx.last_mobile={};owrx.rescale_cnt=owrx.rescale_cnt2=0;setInterval(function(){mobile=owrx.mobile=ext_mobile_info(owrx.last_mobile);owrx.last_mobile=mobile;var el=w3_el('id-control');if(0&&mobile_laptop_test){canvas_log('whu='+mobile.width+','+mobile.height+','+el.uiWidth+' psn='+mobile.isPortrait+','+mobile.small+','+mobile.narrow+' #'+owrx.dseq);owrx.dseq++;}
if(mobile.orient_unchanged)return;owrx.rescale_cnt++;if(owrx.rescale_cnt2!=0){toggle_panel('id-control',1);}
var doScale=(mobile.narrow&&!mobile_laptop_test);mobile_scale_control_panel(mobile,doScale);},500);}
function mobile_scale_control_panel(mobile,doScale){mobile=mobile||owrx.mobile;var el=w3_el('id-control');el.panel_isScaled=doScale;if(doScale){el.style.right='0px';var scale=mobile.width / el.uiWidth*0.95;el.style.transform='scale('+scale.toFixed(2)+')';el.style.transformOrigin='bottom right';owrx.rescale_cnt2++;}else{el.style.transform='none';}}
var spec={height_spectrum_canvas:200,tooltip_offset:100,canvas:null,ctx:null,spectrum_image:null,colormap:null,colormap_transparent:null,dB:null,dB_ttip:null,update:0,last_update:0,need_update:0,need_clear_avg:0,clear_avg:0,avg:[[],[]],slow_dev_color:'#d3d3d3',SPEC_RF:0,SPEC_AF:1,TRACE_0:0,TRACE_1:1,NONE:0,RF:1,AF:2,CHOICES:3,source:0,PEAK_OFF:0,PEAK_ON:1,PEAK_HOLD:2,peak_show:[0,0],peak_clear_spec:[0,0],peak_clear_btn:[0,0],peak:[[[],[]],[[],[]]],peak1_color:'yellow',peak2_color:'magenta',peak_alpha:1.0,dB_bands:[],redraw_dB_scale:false,};function spectrum_init(){spec.colormap=spec.ctx.createImageData(1,spec.canvas.height);spec.colormap_transparent=spec.ctx.createImageData(1,spec.canvas.height);update_maxmindb_sliders();spectrum_dB_bands();var spectrum_update_rate_Hz=kiwi_isMobile()?10:10;setInterval(function(){spec.update++},1000 / spectrum_update_rate_Hz);spec.spectrum_image=spec.ctx.createImageData(spec.canvas.width,spec.canvas.height)
if(!wf.audioFFT_active&&rx_chan>=wf_chans){var sw=spec.canvas.width;var sh=spec.canvas.height;spec.ctx.fillStyle="black";spec.ctx.fillRect(0,0,sw,sh);spec.ctx.font="18px sans-serif";spec.ctx.fillStyle="white";var text=wf_chans?('Spectrum not available for rx'+rx_chan):'Spectrum not allowed on this Kiwi';var tw=spec.ctx.measureText(text).width;spec.ctx.fillText(text,sw/2-tw/2,sh/2);}
kiwi_load_js_dir('extensions/',['waterfall/waterfall.js','colormap/colormap.js'],function(){waterfall_init();colormap_init();});}
function spectrum_dB_bands(){spec.dB_bands=[];var i=0;var color_shift_dB=-12;var s_maxdb=maxdb,s_mindb=mindb;if(s_mindb>=s_maxdb){s_maxdb=-10;s_mindb=-110;}
var s_full_scale=s_maxdb-s_mindb;var barmax=s_maxdb,barmin=s_mindb+color_shift_dB;var rng=barmax-barmin;rng=rng?rng:1;var last_norm=0;var anti_looping=0;for(var dB=Math.floor(s_maxdb/10)*10;(s_mindb-dB)<10;dB-=10){var norm=1-((dB-s_mindb)/ s_full_scale);if(norm>1)norm=1;var cmi=Math.round((dB-barmin)/ rng*255);var color=color_map[cmi];var color_transparent=color_map_transparent[cmi];var color_name='#'+(color>>>8).toString(16).leadingZeros(6);var ypos_f=function(norm){return Math.round(norm*spec.canvas.height)}
var ypos_last=ypos_f(last_norm);var ypos=ypos_f(norm);if(ypos_last==0&&ypos==0)continue;spec.dB_bands[i]={dB:dB,y1:ypos_last,y2:ypos,norm:norm.toFixed(2),color:color_name};for(var y=ypos_last;y<ypos;y++){for(var j=0;j<4;j++){spec.colormap.data[y*4+j]=((color>>>0)>>((3-j)*8))&0xff;spec.colormap_transparent.data[y*4+j]=((color_transparent>>>0)>>((3-j)*8))&0xff;}
if(anti_looping++>8192)break;}
last_norm=norm;i++;if(anti_looping++>8192)break;}
spec.redraw_dB_scale=true;w3_call('colormap_aper');}
function spectrum_tooltip_update(evt,clientX,clientY){var target=(evt.target==spec.dB||evt.currentTarget==spec.dB||evt.target==spec.dB_ttip||evt.currentTarget==spec.dB_ttip);if(target){if(owrx.debug_drag)canvas_log('*STTU*');var h=spec.height_spectrum_canvas;if(clientY>=0&&clientY<h){var cx=clientX-(kiwi_isMobile()?spec.tooltip_offset:0);spec.dB_ttip.style.left=px(cx);spec.dB_ttip.style.bottom=px(h+10-clientY);if(owrx.debug_drag)canvas_log('['+cx+','+clientY+']');var f_kHz,f_text;var rf=(spec.source==spec.RF);if(rf){f_kHz=(canvas_get_dspfreq(cx)+kiwi.freq_offset_Hz)/1000;f_text=format_frequency("{x}",f_kHz,1,freq_field_prec(f_kHz));}else{var norm=cx/waterfall_width-0.5;norm*=(waterfall_width+spec.af_margins)/waterfall_width;f_kHz=norm*audio_input_rate / 1000;f_text=format_frequency("{x}",f_kHz,1,freq_field_prec(f_kHz));}
var dB=(((h-clientY)/ h)*full_scale)+mindb;spec.dB_ttip.innerHTML=f_text+' kHz'+(rf?'':' AF')+'<br>'+dB.toFixed(0)+' dBm';}}else{if(owrx.debug_drag)canvas_log('STTU-ck');}}
function spectrum_update(data){if(spec.source==spec.NONE){return;}
var i,trace,x,y,z;spec.last_update=spec.update;var ctx=spec.ctx;var dBtext_w=25;var sw2=spec.canvas.width;var sw1=sw2-dBtext_w;var sw=(spec.source==spec.RF)?sw1:sw2;var sh=spec.canvas.height;w3_visible('id-spectrum-af-canvas',spec.source==spec.AF);ctx.fillStyle="black";ctx.fillRect(0,0,sw1,sh);spec.af_ctx.fillStyle="black";spec.af_ctx.fillRect(0,0,spec.canvas.width,sh);ctx.fillStyle="lightGray";spec.af_ctx.fillStyle="lightGray";for(i=0;i<spec.dB_bands.length;i++){var band=spec.dB_bands[i];y=Math.round(band.norm*sh);ctx.fillRect(0,y,sw1,1);spec.af_ctx.fillRect(0,y,sw2,1);}
if(spec.source==spec.AF){var sr=ext_nom_sample_rate();var frac=sr%1000;var sp=(sr-frac)-1000;for(i=1000+frac/2;i<=sp+frac/2;i+=1000){x=Math.round(spec.canvas.width*i/sr);spec.af_ctx.fillRect(x,0,1,sh);}
spec.af_ctx.fillStyle='lime';spec.af_ctx.fillRect(Math.round(spec.canvas.width/2)-1,0,3,sh);spec.af_ctx.fillStyle='red';spec.af_ctx.fillRect(0,0,3,sh);spec.af_ctx.fillRect(spec.canvas.width-3,0,3,sh);}
var rf_af=(spec.source==spec.RF)?spec.SPEC_RF:spec.SPEC_AF;if(spec.clear_avg||isNaN(spec.avg[rf_af][0])){for(x=0;x<sw;x++){spec.avg[rf_af][x]=color_index(data[x]);}
spec.clear_avg=false;spec.peak_clear_spec[1]=spec.peak_clear_spec[0]=true;}
for(trace=0;trace<2;trace++){if(spec.peak_clear_spec[trace]){for(x=0;x<sw1;x++){spec.peak[spec.SPEC_RF][trace][x]=0;}
for(x=0;x<sw2;x++){spec.peak[spec.SPEC_AF][trace][x]=0;}
spec.peak_clear_spec[trace]=false;}
if(spec.peak_clear_btn[trace]){for(x=0;x<sw;x++){spec.peak[rf_af][trace][x]=0;}
spec.peak_clear_btn[trace]=false;}}
if(spec.redraw_dB_scale){for(x=sw1;x<spec.canvas.width;x++){ctx.putImageData(spec.colormap_transparent,x,0,0,0,1,sh);}
ctx.fillStyle="white";for(i=0;i<spec.dB_bands.length;i++){var band=spec.dB_bands[i];y=Math.round(band.norm*sh);ctx.fillText(band.dB,sw1+3,y-4);}
spec.redraw_dB_scale=false;}
if(spec.source==spec.AF){ctx=spec.af_ctx;}
if(spectrum_slow_dev)
ctx.fillStyle=spec.slow_dev_color;for(x=0;x<sw;x++){z=color_index(wf_gnd?wf_gnd_value:data[x]);switch(spec_filter){case wf_sp_menu_e.IIR:var iir_gain=1-Math.exp(-sp_param*z/255);if(iir_gain<=0.01)iir_gain=0.01;var z1=spec.avg[rf_af][x];z1=z1+iir_gain*(z-z1);if(z1>255)z1=255;if(z1<0)z1=0;z=spec.avg[rf_af][x]=z1;break;case wf_sp_menu_e.MMA:if(z>255)z=255;if(z<0)z=0;spec.avg[rf_af][x]=((spec.avg[rf_af][x]*(sp_param-1))+z)/ sp_param;z=spec.avg[rf_af][x];break;case wf_sp_menu_e.EMA:if(z>255)z=255;if(z<0)z=0;spec.avg[rf_af][x]+=(z-spec.avg[rf_af][x])/ sp_param;z=spec.avg[rf_af][x];break;case wf_sp_menu_e.OFF:default:if(z>255)z=255;if(z<0)z=0;break;}
for(trace=0;trace<2;trace++){if(spec.peak_show[trace]==spec.PEAK_ON&&z>spec.peak[rf_af][trace][x])
spec.peak[rf_af][trace][x]=z;}
y=Math.round((1-z/255)*sh);if(spectrum_slow_dev){ctx.fillRect(x,y,1,sh-y);}else{var first=true;for(i=0;i<spec.dB_bands.length;i++){var b=spec.dB_bands[i];if(first&&y>b.y2)continue;first=false;ctx.fillStyle=b.color;var h=b.y2-y;ctx.fillRect(x,y,1,h);y=b.y2;}}}
for(trace=0;trace<2;trace++){if(spec.peak_show[trace]!=spec.PEAK_OFF){ctx.lineWidth=1;ctx.strokeStyle=trace?spec.peak2_color:spec.peak1_color;ctx.beginPath();y=Math.round((1-spec.peak[rf_af][trace][0]/255)*sh)-1;ctx.moveTo(0,y);for(x=1;x<sw;x++){y=Math.round((1-spec.peak[rf_af][trace][x]/255)*sh)-1;ctx.lineTo(x,y);}
ctx.globalAlpha=spec.peak_alpha;ctx.stroke();ctx.globalAlpha=1;}}
if(spec.switch_container){w3_show_hide('id-spectrum-container',true);w3_show_hide('id-top-container',false);spec.switch_container=false;}}
var waterfall_setup_done=0;var waterfall_timer;var waterfall_ms;var waterfall_scrollable_height;var wf_canvases=[];var old_canvases=[];var wf_cur_canvas=null;var wf_canvas_default_height=200;var wf_canvas_actual_line;var wf_canvas_id_seq=1;var wf_canvas_maxshift=0;function wf_init(){w3_do_when_cond(function(){return okay_wf_init;},function(){wf_init_ready();},null,200);}
function wf_init_ready(){init_wf_container();wf.audioFFT_active=(rx_chan>=wf_chans);resize_waterfall_container(false);resize_wf_canvases();bands_init();panels_setup();scale_setup();mkcolormap();mkscale();spectrum_init();dx_schedule_update();users_init({user:1});ident_init();stats_init();check_top_bar_congestion();if(spectrum_show)setTimeout(spec_show,2000);audioFFT_setup();waterfall_ms=900/wf_fps_max;waterfall_timer=window.setInterval(waterfall_dequeue,waterfall_ms);if(isNonEmptyArray(shortcut.keys)&&!override_ext)
setTimeout(keyboard_shortcut_url_keys,5000);wf_snap(kiwi_storeGet('wf_snap'));if(kiwi_isMobile())
mobile_init();dx_init();waterfall_setup_done=1;}
function add_wf_canvas(){var new_canvas=create_canvas('id-wf-canvas',wf_fft_size,wf_canvas_default_height,waterfall_width,wf_canvas_default_height);new_canvas.id_seq=wf_canvas_id_seq++;wf_canvas_actual_line=wf_canvas_default_height-1;new_canvas.style.left=0;new_canvas.openwebrx_height=wf_canvas_default_height;new_canvas.openwebrx_top=(-wf_canvas_default_height+1);new_canvas.style.top=px(new_canvas.openwebrx_top);new_canvas.oneline_image=new_canvas.ctx.createImageData(wf_fft_size,1);wf_container.appendChild(new_canvas);add_canvas_listener(new_canvas);wf_canvases.unshift(new_canvas);wf_cur_canvas=new_canvas;if(kiwi_gc_wf)new_canvas=null;}
function wf_shift_canvases(){wf_canvases.forEach(function(p){p.style.top=px(p.openwebrx_top++);});while(wf_canvases.length){var p=wf_canvases[wf_canvases.length-1];if(p==null||p.openwebrx_top<waterfall_scrollable_height){if(kiwi_gc_wf)p=null;break;}
var pp=wf_canvases[wf_canvases.length-2];if(pp)old_canvases.unshift(pp);if(old_canvases.length>15)old_canvases.pop();if(kiwi_gc_wf)remove_canvas_listener(p);wf_container.removeChild(p);if(kiwi_gc_wf)p=wf_canvases[wf_canvases.length-1]=null;wf_canvases.pop();}
wf_canvas_maxshift++;if(wf_canvas_maxshift<wf_container.clientHeight){canvas_phantom.style.top=px(wf_canvas_maxshift);canvas_phantom.style.height=px(wf_container.clientHeight-wf_canvas_maxshift);w3_show_block(canvas_phantom);}else
if(!canvas_phantom.hidden){w3_hide(canvas_phantom);canvas_phantom.hidden=true;}}
function resize_wf_canvases(){window_width=wf_container.innerWidth;waterfall_width=wf_container.clientWidth;new_width=px(waterfall_width);var zoom_value=0;wf_canvases.forEach(function(p){p.style.width=new_width;p.style.left=zoom_value;});canvas_annotation.width=waterfall_width;canvas_annotation.style.width=new_width;canvas_phantom.style.width=new_width;canvas_phantom.style.left=zoom_value;spec.canvas.style.width=new_width;if(wf.audioFFT_active&&!kiwi_isMobile()){var reason;if(wf.no_wf){reason='when \"no_wf\" URL option used.';}else{if(wf_chans==0){reason='because all waterfalls disabled<br>on this Kiwi.';}else{reason='on channels '+wf_chans_real+'-'+(rx_chans-1)+' of Kiwis<br>'+'configured for '+rx_chans+' channels.';}}
w3_innerHTML('id-annotation-div',w3_div('w3-section w3-container',w3_text('w3-large|color:cyan','Audio FFT<br>'),w3_text('w3-small|color:cyan','Zoom waterfall not available<br>'+reason),w3_text('w3-small|color:cyan','<br>For details see the Kiwi forum.')));}}
function waterfall_timestamp(){var tstamp=(wf.ts_tz==0)?((new Date()).toUTCString().substr(17,8)+' UTC'):((new Date()).toString().substr(16,8)+' L');var al=wf_canvas_actual_line;var c=wf_cur_canvas;var off=12;w3_fillText_shadow(c,tstamp,off,al+off,'Arial',14,'lime');if(al+10>c.height){var c2=wf_canvases[1];if(c2)w3_fillText_shadow(c2,tstamp,off,al-c.height+off,'Arial',14,'lime');}}
function wf_snap(set){owrx.wf_snap=isUndefined(set)?(owrx.wf_snap^1):(isNull(set)?0:(+set));w3_el('id-waterfall-container').style.cursor=owrx.wf_cursor=owrx.wf_snap?'col-resize':'crosshair';kiwi_storeSet('wf_snap',owrx.wf_snap);}
var page_scroll_amount=0.8;function page_scroll(norm_dir){if(!wf.audioFFT_active){var dbins=norm_to_bins(norm_dir);waterfall_pan_canvases(dbins);}
freqset_select();}
function page_scroll_icon_click(evt,norm_dir){if(any_alternate_click_event(evt)){dx_label_step((norm_dir<0)?-1:1);}else{page_scroll(norm_dir);}}
var waterfall_dont_scale=0;var need_maxmindb_update=false;var need_clear_wf_sp_avg=false;var need_clear_wfavg=false,clear_wfavg=true;var wfavg=[];var wf_swallow_samples=[2,4,8,18];var x_bin_server_last,wf_swallow=0;function waterfall_add(data_raw,audioFFT){var x,y,z;if(data_raw==null)return;var canvas=wf_cur_canvas;if(canvas==null)return;var data_arr_u8,data,decomp_data;var w=wf_fft_size;var x_bin_server;if(audioFFT==0){var u32View=new Uint32Array(data_raw,4,3);x_bin_server=u32View[0];var u32=u32View[1];if(kiwi_gc_wf)u32View=null;var x_zoom_server=u32&0xffff;var flags=(u32>>16)&0xffff;var wf_flags={COMPRESSED:1,NO_SYNC:2};data_arr_u8=new Uint8Array(data_raw,16);var bytes=data_arr_u8.length;if(need_maxmindb_update&&zoom_level==x_zoom_server){update_maxmindb_sliders();need_maxmindb_update=false;}
if(x_bin==x_bin_server&&zoom_level==x_zoom_server){if(need_clear_wf_sp_avg||spec.need_clear_avg)spec.clear_avg=true;if(need_clear_wf_sp_avg||need_clear_wfavg)clear_wfavg=true;need_clear_wf_sp_avg=need_clear_wfavg=spec.need_clear_avg=false;}
if(flags&wf_flags.COMPRESSED){decomp_data=new Uint8Array(bytes*2);var wf_adpcm={index:0,previousValue:0};decode_ima_adpcm_e8_u8(data_arr_u8,decomp_data,bytes,wf_adpcm);var ADPCM_PAD=10;data=decomp_data.subarray(ADPCM_PAD);}else{data=data_arr_u8;}
wf.no_sync=(flags&wf_flags.NO_SYNC);if(wf_swallow){wf_swallow--;return;}
if(x_bin_server!=x_bin_server_last){x_bin_server_last=x_bin_server;if(zoom_level>=11){wf_swallow=wf_swallow_samples[zoom_level-11];if(wf_fps!=wf_fps_max){wf_swallow=Math.round(wf_swallow*wf_fps / wf_fps_max);}}}}else{data=data_raw;if(spec.source==spec.RF&&spec.need_clear_avg){spec.clear_avg=true;spec.need_clear_avg=false;}}
if(spec.source==spec.RF&&spec.update!=spec.last_update){spectrum_update(data);}
var oneline_image=canvas.oneline_image;for(x=0;x<w;x++){z=color_index(wf_gnd?wf_gnd_value:data[x],wf.sqrt);switch(wf_filter){case wf_sp_menu_e.IIR:if(clear_wfavg)wfavg[x]=z;var iir_gain=1-Math.exp(-wf_param*z/255);if(iir_gain<=0.01)iir_gain=0.01;var z1=wfavg[x];z1=z1+iir_gain*(z-z1);if(z1>255)z1=255;if(z1<0)z1=0;wfavg[x]=z1;z=Math.round(wfavg[x]);break;case wf_sp_menu_e.MMA:if(clear_wfavg)wfavg[x]=z;wfavg[x]=((wfavg[x]*(wf_param-1))+z)/ wf_param;z=Math.round(wfavg[x]);break;case wf_sp_menu_e.EMA:if(clear_wfavg)wfavg[x]=z;wfavg[x]+=(z-wfavg[x])/ wf_param;z=Math.round(wfavg[x]);break;case wf_sp_menu_e.OFF:default:break;}
oneline_image.data[x*4]=color_map_r[z];oneline_image.data[x*4+1]=color_map_g[z];oneline_image.data[x*4+2]=color_map_b[z];oneline_image.data[x*4+3]=0xff;}
if(clear_wfavg)clear_wfavg=false;canvas.ctx.putImageData(oneline_image,0,wf_canvas_actual_line);if(audioFFT==0)
w3_call('IBP_scan_plot',oneline_image);if(typeof(wfext)!=='undefined'&&wfext.tstamp){var d=new Date();var secs=d.getUTCMinutes()*60+d.getUTCSeconds();var new_sec_mark=((secs%wfext.tstamp)==0);if(wf.prev_sec_mark==false&&new_sec_mark==true)waterfall_timestamp();wf.prev_sec_mark=new_sec_mark;}
var fixup=false;if(audioFFT==0&&!wf.no_sync){var pixel_dx;if(sb_trace)console.log('WF fixup bin='+x_bin+'/'+x_bin_server+' z='+zoom_level+'/'+x_zoom_server);if(zoom_level!=x_zoom_server){var dz=zoom_level-x_zoom_server;var out=dz<0;var dbins=out?(x_bin_server-x_bin):(x_bin-x_bin_server);var pixel_dx=bins_to_pixels(2,dbins,out?zoom_level:x_zoom_server);if(sb_trace)
console.log("WF Z fix z"+x_zoom_server+'>'+zoom_level+' out='+out+' b='+x_bin+'/'+x_bin_server+'/'+dbins+" px="+pixel_dx);waterfall_zoom(canvas,dz,wf_canvas_actual_line,pixel_dx);x_bin_server+=out?-dbins:dbins;if(sb_trace)console.log('WF z fixed');fixup=true;}
if(x_bin!=x_bin_server){pixel_dx=bins_to_pixels(3,x_bin-x_bin_server,zoom_level);if(sb_trace)
console.log("WF bin fix L="+wf_canvas_actual_line+" xb="+x_bin+" xbs="+x_bin_server+" pdx="+pixel_dx);waterfall_pan(canvas,wf_canvas_actual_line,pixel_dx);if(sb_trace)console.log('WF bin fixed');fixup=true;}
if(sb_trace&&x_bin==x_bin_server&&zoom_level==x_zoom_server){console.log('--WF FIXUP ALL DONE--');sb_trace=0;}}
if(wf.need_autoscale>1)wf.need_autoscale--;if(wf.need_autoscale==1&&!fixup){var pwr_dBm=[];var autoscale=wf.audioFFT_active?data.slice(256,768):data;var alen=autoscale.length;var j=0;for(var i=0;i<alen;i++){var pwr=dB_wire_to_dBm(autoscale[i]);if(pwr<=-190)continue;pwr_dBm[j]=pwr;j++}
var len=pwr_dBm.length;if(len){pwr_dBm.sort(function(a,b){return a-b});var noise=pwr_dBm[Math.floor(0.50*len)];var signal=pwr_dBm[Math.floor(0.95*len)];console_log_dbgUs('# autoscale len='+len+' min='+pwr_dBm[0]+' noise='+noise+' signal='+signal+' max='+pwr_dBm[len-1]);var _10=pwr_dBm[Math.floor(0.10*len)];var _20=pwr_dBm[Math.floor(0.20*len)];console_log_dbgUs('# autoscale min='+pwr_dBm[0]+' 10%='+_10+' 20%='+_20+' 50%(noise)='+noise+' 95%(signal)='+signal+' max='+pwr_dBm[len-1]);}else{signal=-110;noise=-120;}
signal+=30;if(signal<-80)signal=-80;noise-=10;if(wf.audioFFT_active){noise=-110;console_log_dbgUs('audioFFT_active: force noise = '+noise.toFixed(0)+' dBm');}
setmaxdb(1,signal);setmindb(1,noise);update_maxmindb_sliders();wf.need_autoscale=0;}
wf_canvas_actual_line--;wf_shift_canvases();if(wf_canvas_actual_line<0)add_wf_canvas();if(kiwi_gc_wf)canvas=data_raw=data_arr_u8=decomp_data=data=null;}
function waterfall_pan(cv,line,dx){var ctx=cv.ctx;var y,w,h;var w0=cv.width;if(line==-1){y=0;h=cv.height;}else{y=line;h=1;}
var clip=function(v,min,max){return((v<min)?min:((v>max)?max:v));};try{if(sb_trace)console.log('waterfall_pan h='+h+' dx='+dx);if(dx<0){dx=-dx;w=w0-dx;if(sb_trace)console.log('PAN-L w='+w+' dx='+dx);if(w>0)ctx.drawImage(cv,0,y,w,h,dx,y,w,h);ctx.fillStyle="Black";if(sb_trace)ctx.fillStyle=(line==-1)?"Lime":"Red";fx=clip(dx,0,w0);ctx.fillRect(0,y,fx,h);}else{w=w0-dx;if(sb_trace)console.log('PAN-R w='+w+' dx='+dx);if(w>0)ctx.drawImage(cv,dx,y,w,h,0,y,w,h);ctx.fillStyle="Black";if(sb_trace)ctx.fillStyle=(line==-1)?"Lime":"Red";fx=clip(w,0,w0);ctx.fillRect(fx,y,w0,h);}}catch(ex){console.log('EX WFPAN '+ex.toString()+' dx='+dx+' y='+y+' w='+w+' h='+h);}}
var last_pixels_frac=0;function waterfall_pan_canvases(bins){if(!bins)return;if(wf.audioFFT_active)return;var x_obin=x_bin;x_bin+=bins;x_bin=clamp_xbin(x_bin);var f_dx=bins_to_pixels_frac(4,x_bin-x_obin,zoom_level)+last_pixels_frac;var i_dx=Math.round(f_dx);last_pixels_frac=f_dx-i_dx;if(sb_trace)console.log("PAN-CAN z="+zoom_level+" xb="+x_bin+" db="+(x_bin-x_obin)+" f_dx="+f_dx+" i_dx="+i_dx+" lpf="+last_pixels_frac);if(!i_dx)return;wf_canvases.forEach(function(cv){waterfall_pan(cv,-1,i_dx);});wf_send("SET zoom="+zoom_level+" start="+x_bin);mkscale();need_clear_wf_sp_avg=true;dx_schedule_update();extint_environment_changed({waterfall_pan:1,passband_screen_location:1});if(passband_visible()<0)
check_band(true);}
function waterfall_zoom(cv,dz,line,x){var ctx=cv.ctx;var w=cv.width;var zf=1<<Math.abs(dz);var pw=w / zf;var fx;var y,h;var clip=function(v,min,max){return((v<min)?min:((v>max)?max:v));};if(line==-1){y=0;h=cv.height;}else{y=line;h=1;}
try{if(sb_trace)console.log('waterfall_zoom w='+w+' h='+h+' pw='+pw+' zf='+zf);if(dz<0){if(sb_trace)console.log('WFZ-out srcX=0/'+w+' dstX='+x+'/'+(x+pw)+' (pw='+pw+')');ctx.drawImage(cv,0,y,w,h,x,y,pw,h);ctx.fillStyle="Black";if(sb_trace){console.log('chocolate 0:'+x);ctx.fillStyle="chocolate";}
fx=clip(x,0,w);ctx.fillRect(0,y,fx,y+h);if(sb_trace){console.log('brown '+(x+pw)+':'+w);ctx.fillStyle="brown";}
fx=clip(x+pw,0,w);ctx.fillRect(fx,y,w,y+h);}else{if(w!=0){if(sb_trace)console.log('WFZ-in srcX='+x+'/'+(x+pw)+'(pw='+pw+') dstX=0/'+w);var fill_hi=false,fill_lo=false;if((x+pw)>w){fx=Math.round((w-x)*zf);if(sb_trace)
console.log('CLAMP HI fx='+fx);fill_hi=true;}
if(x<0){fx=Math.round(-x*zf);if(sb_trace)
console.log('CLAMP LO fx='+fx);fill_lo=true;}
ctx.drawImage(cv,x,y,pw,h,0,y,w,h);ctx.fillStyle="Black";if(sb_trace)ctx.fillStyle="deepPink";if(fill_hi)ctx.fillRect(fx,y,w,y+h);if(fill_lo)ctx.fillRect(0,y,fx,y+h);}}}catch(ex){console.log('EX WFZ '+ex.toString()+' dz='+dz+' x='+x+' y='+y+' w='+w+' h='+h);}}
function waterfall_zoom_canvases(dz,x){if(sb_trace)console.log("ZOOM-CAN z"+zoom_level+" xb="+x_bin+" x="+x);wf_canvases.forEach(function(cv){waterfall_zoom(cv,dz,-1,x);});need_clear_wf_sp_avg=true;}
function waterfall_position(pos,freq_kHz){var wf_middle_bin=x_bin+bins_at_cur_zoom()/2;if(pos==owrx.WF_POS_AT_FREQ){freq_kHz=freq_kHz||1e3;var dbin=freq_to_bin(freq_kHz*1e3)-wf_middle_bin;waterfall_pan_canvases(dbin);}else{var pb_bin=-passband_visible()-1;if(pb_bin>=0){waterfall_pan_canvases(pb_bin-wf_middle_bin);}}
check_band();}
function waterfall_tune(f_kHz){if(f_kHz==0){waterfall_position(owrx.WF_POS_AT_FREQ,+ext_get_freq_kHz());}else{waterfall_position(owrx.WF_POS_AT_FREQ,f_kHz);owrx.waterfall_tuned=1;}
w3_field_select('id-freq-input',{mobile:1,log:2});freqset_restore_ui();}
function waterfall_height(){var top_height=w3_el("id-top-container").clientHeight;var non_waterfall_height=w3_el("id-non-waterfall-container").clientHeight;var scale_height=w3_el("id-scale-container").clientHeight;owrx.scale_offsetY=top_height+non_waterfall_height-scale_height;var wf_height=window.innerHeight-top_height-non_waterfall_height;return wf_height;}
function resize_waterfall_container(check_init){if(check_init&&!waterfall_setup_done)return;var wf_height=waterfall_height();if(wf_height>=0){canvas_annotation.style.height=wf_container.style.height=px(wf_height);canvas_annotation.height=wf_height;waterfall_scrollable_height=wf_height*wf.scroll_multiple;}else{waterfall_scrollable_height=0;}}
var waterfall_delay=0;var waterfall_queue=[];var waterfall_last_add=0;function waterfall_add_queue(what,ws,firstChars){if(firstChars=='DAT'){var u8View=new Uint8Array(what,4);var cmd=u8View[0];if(cmd==0){for(var i=0;i<3*256;i++){downloaded_colormap[i]=u8View[i+1];}
mkcolormap();console.log('W/F DAT downloaded_colormap');}else
console.log('W/F DAT unknown cmd='+cmd);return;}
var u32View=new Uint32Array(what,4,3);var seq=u32View[2];if(kiwi_gc_wf)u32View=null;var now=Date.now();var spacing=waterfall_last_add?(now-waterfall_last_add):0;waterfall_last_add=now;waterfall_queue.push({data:what,audioFFT:0,seq:seq,spacing:spacing});if(kiwi_gc_wf)what=null;}
var init_zoom_set=false;var waterfall_last_out=0;var wf_dq_onesec=0;function waterfall_dequeue(){if(!init_zoom_set&&demodulators[0]){init_zoom=parseInt(init_zoom);if(init_zoom<0||init_zoom>zoom_levels_max)init_zoom=0;zoom_step(ext_zoom.ABS,init_zoom);init_zoom_set=true;}
if(!waterfall_setup_done||waterfall_queue.length==0)return;while(waterfall_queue.length!=0){var now=Date.now();if(!wf.no_sync){var seq=waterfall_queue[0].seq;var target=audio_ext_sequence+waterfall_delay;if(seq>target){return;}
if(seq==audio_ext_sequence&&now<(waterfall_last_out+waterfall_queue[0].spacing)){return;}}
waterfall_last_out=now;var data=waterfall_queue[0].data;if(kiwi_gc_wf)waterfall_queue[0].data=null;var audioFFT=waterfall_queue[0].audioFFT;waterfall_queue.shift();waterfall_add(data,audioFFT);if(kiwi_gc_wf)data=null;}}
var downloaded_colormap=new Uint8Array(3*256);turbo_colormap_data=[0.18995,0.07176,0.23217,0.19483,0.08339,0.26149,0.19956,0.09498,0.29024,0.20415,0.10652,0.31844,0.20860,0.11802,0.34607,0.21291,0.12947,0.37314,0.21708,0.14087,0.39964,0.22111,0.15223,0.42558,0.22500,0.16354,0.45096,0.22875,0.17481,0.47578,0.23236,0.18603,0.50004,0.23582,0.19720,0.52373,0.23915,0.20833,0.54686,0.24234,0.21941,0.56942,0.24539,0.23044,0.59142,0.24830,0.24143,0.61286,0.25107,0.25237,0.63374,0.25369,0.26327,0.65406,0.25618,0.27412,0.67381,0.25853,0.28492,0.69300,0.26074,0.29568,0.71162,0.26280,0.30639,0.72968,0.26473,0.31706,0.74718,0.26652,0.32768,0.76412,0.26816,0.33825,0.78050,0.26967,0.34878,0.79631,0.27103,0.35926,0.81156,0.27226,0.36970,0.82624,0.27334,0.38008,0.84037,0.27429,0.39043,0.85393,0.27509,0.40072,0.86692,0.27576,0.41097,0.87936,0.27628,0.42118,0.89123,0.27667,0.43134,0.90254,0.27691,0.44145,0.91328,0.27701,0.45152,0.92347,0.27698,0.46153,0.93309,0.27680,0.47151,0.94214,0.27648,0.48144,0.95064,0.27603,0.49132,0.95857,0.27543,0.50115,0.96594,0.27469,0.51094,0.97275,0.27381,0.52069,0.97899,0.27273,0.53040,0.98461,0.27106,0.54015,0.98930,0.26878,0.54995,0.99303,0.26592,0.55979,0.99583,0.26252,0.56967,0.99773,0.25862,0.57958,0.99876,0.25425,0.58950,0.99896,0.24946,0.59943,0.99835,0.24427,0.60937,0.99697,0.23874,0.61931,0.99485,0.23288,0.62923,0.99202,0.22676,0.63913,0.98851,0.22039,0.64901,0.98436,0.21382,0.65886,0.97959,0.20708,0.66866,0.97423,0.20021,0.67842,0.96833,0.19326,0.68812,0.96190,0.18625,0.69775,0.95498,0.17923,0.70732,0.94761,0.17223,0.71680,0.93981,0.16529,0.72620,0.93161,0.15844,0.73551,0.92305,0.15173,0.74472,0.91416,0.14519,0.75381,0.90496,0.13886,0.76279,0.89550,0.13278,0.77165,0.88580,0.12698,0.78037,0.87590,0.12151,0.78896,0.86581,0.11639,0.79740,0.85559,0.11167,0.80569,0.84525,0.10738,0.81381,0.83484,0.10357,0.82177,0.82437,0.10026,0.82955,0.81389,0.09750,0.83714,0.80342,0.09532,0.84455,0.79299,0.09377,0.85175,0.78264,0.09287,0.85875,0.77240,0.09267,0.86554,0.76230,0.09320,0.87211,0.75237,0.09451,0.87844,0.74265,0.09662,0.88454,0.73316,0.09958,0.89040,0.72393,0.10342,0.89600,0.71500,0.10815,0.90142,0.70599,0.11374,0.90673,0.69651,0.12014,0.91193,0.68660,0.12733,0.91701,0.67627,0.13526,0.92197,0.66556,0.14391,0.92680,0.65448,0.15323,0.93151,0.64308,0.16319,0.93609,0.63137,0.17377,0.94053,0.61938,0.18491,0.94484,0.60713,0.19659,0.94901,0.59466,0.20877,0.95304,0.58199,0.22142,0.95692,0.56914,0.23449,0.96065,0.55614,0.24797,0.96423,0.54303,0.26180,0.96765,0.52981,0.27597,0.97092,0.51653,0.29042,0.97403,0.50321,0.30513,0.97697,0.48987,0.32006,0.97974,0.47654,0.33517,0.98234,0.46325,0.35043,0.98477,0.45002,0.36581,0.98702,0.43688,0.38127,0.98909,0.42386,0.39678,0.99098,0.41098,0.41229,0.99268,0.39826,0.42778,0.99419,0.38575,0.44321,0.99551,0.37345,0.45854,0.99663,0.36140,0.47375,0.99755,0.34963,0.48879,0.99828,0.33816,0.50362,0.99879,0.32701,0.51822,0.99910,0.31622,0.53255,0.99919,0.30581,0.54658,0.99907,0.29581,0.56026,0.99873,0.28623,0.57357,0.99817,0.27712,0.58646,0.99739,0.26849,0.59891,0.99638,0.26038,0.61088,0.99514,0.25280,0.62233,0.99366,0.24579,0.63323,0.99195,0.23937,0.64362,0.98999,0.23356,0.65394,0.98775,0.22835,0.66428,0.98524,0.22370,0.67462,0.98246,0.21960,0.68494,0.97941,0.21602,0.69525,0.97610,0.21294,0.70553,0.97255,0.21032,0.71577,0.96875,0.20815,0.72596,0.96470,0.20640,0.73610,0.96043,0.20504,0.74617,0.95593,0.20406,0.75617,0.95121,0.20343,0.76608,0.94627,0.20311,0.77591,0.94113,0.20310,0.78563,0.93579,0.20336,0.79524,0.93025,0.20386,0.80473,0.92452,0.20459,0.81410,0.91861,0.20552,0.82333,0.91253,0.20663,0.83241,0.90627,0.20788,0.84133,0.89986,0.20926,0.85010,0.89328,0.21074,0.85868,0.88655,0.21230,0.86709,0.87968,0.21391,0.87530,0.87267,0.21555,0.88331,0.86553,0.21719,0.89112,0.85826,0.21880,0.89870,0.85087,0.22038,0.90605,0.84337,0.22188,0.91317,0.83576,0.22328,0.92004,0.82806,0.22456,0.92666,0.82025,0.22570,0.93301,0.81236,0.22667,0.93909,0.80439,0.22744,0.94489,0.79634,0.22800,0.95039,0.78823,0.22831,0.95560,0.78005,0.22836,0.96049,0.77181,0.22811,0.96507,0.76352,0.22754,0.96931,0.75519,0.22663,0.97323,0.74682,0.22536,0.97679,0.73842,0.22369,0.98000,0.73000,0.22161,0.98289,0.72140,0.21918,0.98549,0.71250,0.21650,0.98781,0.70330,0.21358,0.98986,0.69382,0.21043,0.99163,0.68408,0.20706,0.99314,0.67408,0.20348,0.99438,0.66386,0.19971,0.99535,0.65341,0.19577,0.99607,0.64277,0.19165,0.99654,0.63193,0.18738,0.99675,0.62093,0.18297,0.99672,0.60977,0.17842,0.99644,0.59846,0.17376,0.99593,0.58703,0.16899,0.99517,0.57549,0.16412,0.99419,0.56386,0.15918,0.99297,0.55214,0.15417,0.99153,0.54036,0.14910,0.98987,0.52854,0.14398,0.98799,0.51667,0.13883,0.98590,0.50479,0.13367,0.98360,0.49291,0.12849,0.98108,0.48104,0.12332,0.97837,0.46920,0.11817,0.97545,0.45740,0.11305,0.97234,0.44565,0.10797,0.96904,0.43399,0.10294,0.96555,0.42241,0.09798,0.96187,0.41093,0.09310,0.95801,0.39958,0.08831,0.95398,0.38836,0.08362,0.94977,0.37729,0.07905,0.94538,0.36638,0.07461,0.94084,0.35566,0.07031,0.93612,0.34513,0.06616,0.93125,0.33482,0.06218,0.92623,0.32473,0.05837,0.92105,0.31489,0.05475,0.91572,0.30530,0.05134,0.91024,0.29599,0.04814,0.90463,0.28696,0.04516,0.89888,0.27824,0.04243,0.89298,0.26981,0.03993,0.88691,0.26152,0.03753,0.88066,0.25334,0.03521,0.87422,0.24526,0.03297,0.86760,0.23730,0.03082,0.86079,0.22945,0.02875,0.85380,0.22170,0.02677,0.84662,0.21407,0.02487,0.83926,0.20654,0.02305,0.83172,0.19912,0.02131,0.82399,0.19182,0.01966,0.81608,0.18462,0.01809,0.80799,0.17753,0.01660,0.79971,0.17055,0.01520,0.79125,0.16368,0.01387,0.78260,0.15693,0.01264,0.77377,0.15028,0.01148,0.76476,0.14374,0.01041,0.75556,0.13731,0.00942,0.74617,0.13098,0.00851,0.73661,0.12477,0.00769,0.72686,0.11867,0.00695,0.71692,0.11268,0.00629,0.70680,0.10680,0.00571,0.69650,0.10102,0.00522,0.68602,0.09536,0.00481,0.67535,0.08980,0.00449,0.66449,0.08436,0.00424,0.65345,0.07902,0.00408,0.64223,0.07380,0.00401,0.63082,0.06868,0.00401,0.61923,0.06367,0.00410,0.60746,0.05878,0.00427,0.59550,0.05399,0.00453,0.58336,0.04931,0.00486,0.57103,0.04474,0.00529,0.55852,0.04028,0.00579,0.54583,0.03593,0.00638,0.53295,0.03169,0.00705,0.51989,0.02756,0.00780,0.50664,0.02354,0.00863,0.49321,0.01963,0.00955,0.47960,0.01583,0.01055];var spectrum_scale_color_map_transparency=200;var color_map=new Uint32Array(256);var color_map_transparent=new Uint32Array(256);var color_map_r=new Uint8Array(256);var color_map_g=new Uint8Array(256);var color_map_b=new Uint8Array(256);function mkcolormap(){var ccm;if(wf.cmap>=kiwi.cmap_e.custom_1)
ccm=wf.custom_colormaps[wf.cmap-kiwi.cmap_e.custom_1];for(var i=0;i<256;i++){var r0,g0,b0,s0,s1;var r,g,b;switch(wf.cmap){case kiwi.cmap_e.kiwi:if(i<32){r=0;g=0;b=i*255/31;}else if(i<72){r=0;g=(i-32)*255/39;b=255;}else if(i<96){r=0;g=255;b=255-(i-72)*255/23;}else if(i<116){r=(i-96)*255/19;g=255;b=0;}else if(i<184){r=255;g=255-(i-116)*255/67;b=0;}else{r=255;g=0;b=(i-184)*128/70;}
break;case kiwi.cmap_e.CuteSDR:if(i<43){r=0;g=0;b=i*255/43;}else if(i<87){r=0;g=(i-43)*255/43;b=255;}else if(i<120){r=0;g=255;b=255-(i-87)*255/32;}else if(i<154){r=(i-120)*255/33;g=255;b=0;}else if(i<217){r=255;g=255-(i-154)*255/62;b=0;}else{r=255;g=0;b=(i-217)*128/38;}
break;case kiwi.cmap_e.greyscale:black_level=0.0;white_level=48.0;var v=black_level+((255-black_level+white_level)*i/255);r=g=b=v;break;case kiwi.cmap_e.linear:var c_from={r:255,g:0,b:255};var c_to={r:0,g:255,b:0};var s=1.0;r=c_from.r*(i/255)+c_to.r*((255-i)/255);r=r*(s+(i/255)*(1-s));g=c_from.g*(i/255)+c_to.g*((255-i)/255);g=g*(s+(i/255)*(1-s));b=c_from.b*(i/255)+c_to.b*((255-i)/255);b=b*(s+(i/255)*(1-s));break;case kiwi.cmap_e.turbo:r=turbo_colormap_data[i*3+0]*255;g=turbo_colormap_data[i*3+1]*255;b=turbo_colormap_data[i*3+2]*255;break;case kiwi.cmap_e.SdrDx:if(i<=20){r0=0;g0=0;b0=0;r=0;g=0;b=0.5;s0=0;s1=20;}else
if(i<=60){r0=0;g0=0;b0=0.5;r=0;g=0;b=1.0;s0=21;s1=60;}else
if(i<=150){r0=0;g0=0;b0=1.0;r=1.0;g=1.0;b=0;s0=61;s1=150;}else
if(i<=180){r0=1.0;g0=1.0;b0=0;r=1.0;g=0;b=0;s0=151;s1=180;}else
if(i<=210){r0=1.0;g0=0;b0=0;r=1.0;g=1.0;b=1.0;s0=181;s1=210;}else{r0=1.0;g0=1.0;b0=1.0;r=1.0;g=1.0;b=1.0;s0=211;s1=255;}
var d=s1-s0;var ni=i-s0;var f=ni / d;r=(r0+((r-r0)*f))*255;g=(g0+((g-g0)*f))*255;b=(b0+((b-b0)*f))*255;break;default:r=ccm[i*3+0];g=ccm[i*3+1];b=ccm[i*3+2];break;}
r=Math.round(r);r=w3_clamp(r,0,255);g=Math.round(g);g=w3_clamp(g,0,255);b=Math.round(b);b=w3_clamp(b,0,255);color_map[i]=(r<<24)|(g<<16)|(b<<8)|0xff;color_map_transparent[i]=(r<<24)|(g<<16)|(b<<8)|spectrum_scale_color_map_transparency;color_map_r[i]=r;color_map_g[i]=g;color_map_b[i]=b;}}
function dB_wire_to_dBm(db_value){if(db_value<0)db_value=0;if(db_value>255)db_value=255;var dBm=-(255-db_value);return(dBm+wf.cal);}
function color_index(db_value,sqrt){var dBm=dB_wire_to_dBm(db_value);if(dBm<mindb)dBm=mindb;if(dBm>maxdb)dBm=maxdb;var relative_value=dBm-mindb;var value_percent_default=relative_value/full_scale;var value_percent=value_percent_default;if(isDefined(sqrt)){try{switch(+sqrt){case 0:default:break;case 1:value_percent=Math.sqrt(value_percent_default);break;case 2:if(value_percent_default>0.21&&value_percent_default<0.5)
value_percent=0.2+(4+Math.log10(value_percent_default-0.2))*0.09;break;case 3:if(value_percent_default>0.31&&value_percent_default<0.6)
value_percent=0.3+(5+Math.log10(value_percent_default-0.3))*0.07;break;case 4:if(value_percent_default>0.41&&value_percent_default<0.7)
value_percent=0.4+(6+Math.log10(value_percent_default-0.4))*0.055;break;}}catch(ex){value_percent=value_percent_default;}}
var i=value_percent*255;i=Math.round(i);if(i<0)i=0;if(i>255)i=255;return i;}
function waterfall_color_index_max_min(db_value,maxdb,mindb){db_value=-(255-db_value);if(db_value<mindb)db_value=mindb;if(db_value>maxdb)db_value=maxdb;var relative_value=db_value-mindb;var fullscale=maxdb-mindb;fullscale=fullscale?fullscale:1;var value_percent=relative_value / fullscale;var i=value_percent*255;i=Math.round(i);if(i<0)i=0;if(i>255)i=255;return i;}
function color_index_max_min(value,maxdb,mindb){if(value<mindb)value=mindb;if(value>maxdb)value=maxdb;var relative_value=value-mindb;var fullscale=maxdb-mindb;fullscale=fullscale?fullscale:1;var value_percent=relative_value / fullscale;var i=value_percent*255;i=Math.round(i);if(i<0)i=0;if(i>255)i=255;return i;}
var afft={init:false,comp_1x:false,prev_lsb:false,audioFFT_dynload:{},offt:0,i_re:0,i_im:0,o_re:0,o_im:0,window_512:[],window_1k:[],window_2k:[],pwr_dB:[],dBi:[],CUTESDR_MAX_VAL:32767,};function audioFFT_setup(){if(!wf.audioFFT_active)return;zoom_level=0;if(wf.aper!=kiwi.aper_e.auto){var last_AF_max_dB=readCookie('last_AF_max_dB',maxdb);var last_AF_min_dB=readCookie('last_AF_min_dB',mindb_un);setmaxdb(1,last_AF_max_dB);setmindb(1,last_AF_min_dB);update_maxmindb_sliders();}
var window=function(i,nsamp){return(0.5-0.5*Math.cos((2*Math.PI*i)/(nsamp-1)));};for(i=0;i<512;i++)afft.window_512[i]=window(i,512);for(i=0;i<1024;i++)afft.window_1k[i]=window(i,1024);for(i=0;i<2048;i++)afft.window_2k[i]=window(i,2048);}
function audioFFT_update(){mkscale();dx_schedule_update();freq_link_update();w3_innerHTML('id-nav-optbar-wf','WF');freqset_select();if(wf.audioFFT_clear_wf){wf_canvases.forEach(function(cv){cv.ctx.fillStyle="Black";cv.ctx.fillRect(0,0,cv.width,cv.height);});spec.need_clear_avg=true;wf.audioFFT_clear_wf=false;if(wf.aper==kiwi.aper_e.auto){if(wf.audioFFT_active)wf.need_autoscale=16;}}}
function wf_audio_FFT(audio_data,samps){if(!wf.audioFFT_active||!isDefined(cur_mode))return;if(!kiwi_load_js_polled(afft.audioFFT_dynload,'pkgs/js/Ooura_FFT32.js'))return;var i,j,k,ki;var iq=ext_is_IQ_or_stereo_curmode();var lsb=ext_mode(cur_mode).LSB_SAL;var fft_setup=(!afft.init||iq!=afft.iq||audio_compression!=afft.comp);if(fft_setup){console.log('audio_FFT: SWITCHING iq='+iq+' comp='+audio_compression);var type;if(iq){type='complex';afft.size=1024;afft.offt=ooura32.FFT(afft.size,{"type":"complex","radix":4});afft.i_re=ooura32.vectorArrayFactory(afft.offt);afft.i_im=ooura32.vectorArrayFactory(afft.offt);}else{type='real';afft.size=audio_compression?(afft.comp_1x?2048:1024):512;afft.offt=ooura32.FFT(afft.size,{"type":"real","radix":4});afft.i_re=ooura32.scalarArrayFactory(afft.offt);}
afft.o_re=ooura32.vectorArrayFactory(afft.offt);afft.o_im=ooura32.vectorArrayFactory(afft.offt);afft.scale=10.0*2.0 /(afft.size*afft.size*afft.size*afft.CUTESDR_MAX_VAL*afft.CUTESDR_MAX_VAL);if(!afft.init&&wf.aper!=kiwi.aper_e.auto&&wf_mm==''){wf.need_autoscale=16;}
afft.iq=iq;afft.comp=audio_compression;afft.init=true;}
if(fft_setup||(lsb!=afft.prev_lsb)){for(i=0;i<1024;i++)afft.pwr_dB[i]=0;afft.prev_lsb=lsb;}
if(afft.iq){for(i=0,j=0;i<1024;i+=2,j++){afft.i_re[j]=audio_data[i]*afft.window_512[j];afft.i_im[j]=audio_data[i+1]*afft.window_512[j];}
afft.offt.fft(afft.offt,afft.i_re.buffer,afft.i_im.buffer,afft.o_re.buffer,afft.o_im.buffer);for(j=0,k=512;j<256;j++,k++){var re=afft.o_re[j],im=afft.o_im[j];var pwr=re*re+im*im;var dB=10.0*Math.log10(pwr*afft.scale+1e-30);dB=Math.round(255+dB);afft.pwr_dB[k]=dB;}
for(j=256,k=256;j<512;j++,k++){var re=afft.o_re[j],im=afft.o_im[j];var pwr=re*re+im*im;var dB=10.0*Math.log10(pwr*afft.scale+1e-30);dB=Math.round(255+dB);afft.pwr_dB[k]=dB;}
waterfall_queue.push({data:afft.pwr_dB,audioFFT:1,seq:0,spacing:0});}else{if(audio_compression){if(afft.comp_1x){for(i=0;i<2048;i++){afft.i_re[i]=audio_data[i]*afft.window_2k[i];}
afft.offt.fft(afft.offt,afft.i_re.buffer,afft.o_re.buffer,afft.o_im.buffer);if(lsb)
k=512,ki=-1;else
k=256,ki=+1;for(j=0;j<1024;j++){var re=afft.o_re[j],im=afft.o_im[j];var pwr=re*re+im*im;afft.dBi[j&1]=Math.round(255+(10.0*Math.log10(pwr*afft.scale+1e-30)));if(j&1){afft.pwr_dB[k]=Math.max(afft.dBi[0],afft.dBi[1]);k+=ki;}}}else{for(i=0;i<1024;i++){afft.i_re[i]=audio_data[i]*afft.window_1k[i];}
afft.offt.fft(afft.offt,afft.i_re.buffer,afft.o_re.buffer,afft.o_im.buffer);if(lsb)
k=512,ki=-1;else
k=256,ki=+1;for(j=0;j<512;j++,k+=ki){var re=afft.o_re[j],im=afft.o_im[j];var pwr=re*re+im*im;afft.pwr_dB[k]=Math.round(255+(10.0*Math.log10(pwr*afft.scale+1e-30)));}
waterfall_queue.push({data:afft.pwr_dB,audioFFT:1,seq:0,spacing:0});for(i=1024;i<2048;i++){afft.i_re[i]=audio_data[i]*afft.window_2k[i-1024];}
afft.offt.fft(afft.offt,afft.i_re.buffer,afft.o_re.buffer,afft.o_im.buffer);if(lsb)
k=512,ki=-1;else
k=256,ki=+1;for(j=0;j<512;j++,k+=ki){var re=afft.o_re[j],im=afft.o_im[j];var pwr=re*re+im*im;afft.pwr_dB[k]=Math.round(255+(10.0*Math.log10(pwr*afft.scale+1e-30)));}}
waterfall_queue.push({data:afft.pwr_dB,audioFFT:1,seq:0,spacing:0});}else{for(i=0;i<512;i++){afft.i_re[i]=audio_data[i]*afft.window_512[i];}
afft.offt.fft(afft.offt,afft.i_re.buffer,afft.o_re.buffer,afft.o_im.buffer);if(lsb)
k=512,ki=-2;else
k=256,ki=+2;for(j=0;j<256;j++,k+=ki){var re=afft.o_re[j],im=afft.o_im[j];var pwr=re*re+im*im;afft.pwr_dB[k]=afft.pwr_dB[k+1]=Math.round(255+(10.0*Math.log10(pwr*afft.scale+1e-30)));}
waterfall_queue.push({data:afft.pwr_dB,audioFFT:1,seq:0,spacing:0});}}}
var freq_displayed_Hz,freq_displayed_kHz_str,freq_displayed_kHz_str_with_freq_offset,freq_car_Hz;var freqset_tout;function freq_dsp_to_car(fdsp){var demod=demodulators[0];if(isUndefined(demod)){console.log("freq_dsp_to_car no demod?");return fdsp;}
var offset=demod.low_cut+(demod.high_cut-demod.low_cut)/2;fcar=demod.isCW?fdsp-offset:fdsp;if(fcar<0)fcar=0;if(fcar>bandwidth)fcar=bandwidth;return fcar;}
function freq_car_to_dsp(fcar){var demod=demodulators[0];if(isUndefined(demod))return fcar;var offset=demod.low_cut+(demod.high_cut-demod.low_cut)/2;fdsp=demod.isCW?fcar+offset:fcar;return fdsp;}
function passband_offset(){var offset=0;var usePBCenter=false;var demod=demodulators[0];if(isDefined(demod)){usePBCenter=demod.usePBCenter;offset=usePBCenter?demod.low_cut+(demod.high_cut-demod.low_cut)/2:0;}
return offset;}
function freq_passband_center(){var freq=0;var demod=demodulators[0];if(isDefined(demod)){freq=center_freq+demod.offset_frequency;freq+=demod.low_cut+(demod.high_cut-demod.low_cut)/2;}
return freq;}
function passband_offset_dxlabel(mode,ext,pb_lo,pb_hi){if(pb_lo==0&&pb_hi==0){var pb=kiwi_passbands(mode);pb_lo=pb.lo;pb_hi=pb.hi;}
var ext_label_offset_ok=true;if(ext.startsWith('fax'))ext_label_offset_ok=false;var usePBCenter=ext_mode(mode).SSB;var offset=(usePBCenter&&ext_label_offset_ok)?pb_lo+(pb_hi-pb_lo)/2:0;return offset;}
function freqmode_set_dsp_kHz(fdsp,mode,opt){var dont_clear_wf=w3_opt(opt,'dont_clear_wf',false);var open_ext=w3_opt(opt,'open_ext',false);var no_set_freq=w3_opt(opt,'no_set_freq',0);var no_clear_last_gid=w3_opt(opt,'no_clear_last_gid',0);fdsp*=1000;if(dont_clear_wf==false)wf.audioFFT_clear_wf=true;if(!no_clear_last_gid)owrx.dx_click_gid_last_until_tune=undefined;dx.last_stepped_gid=-1;if(isArg(mode)&&(mode!=cur_mode||open_ext==true)){ext_set_mode(mode,fdsp,opt);}else{freq_car_Hz=freq_dsp_to_car(fdsp);if(!no_set_freq){demodulator_set_offset_frequency(owrx.FSET_SET_FREQ,freq_car_Hz-center_freq);}}}
function freqset_car_Hz(fcar){freq_car_Hz=fcar;}
var freq_dsp_set_last;function freq_field_prec(f_kHz){var limit=100e3-(cfg.max_freq?32e3:30e3);var prec=(kiwi.freq_offset_kHz>=limit)?2:((cfg.show_1Hz||url_1Hz)?3:2);return prec;}
function freq_field_width(){var limit=100e3-(cfg.max_freq?32e3:30e3);var width=(kiwi.freq_offset_kHz>=limit)?6.25:((cfg.show_1Hz||url_1Hz)?6.25:5.75);return(width+'em');}
function freqset_restore_ui(){var obj=w3_el('id-freq-input');if(isNoArg(obj))return null;var f_kHz_with_freq_offset=(freq_displayed_Hz+kiwi.freq_offset_Hz)/1000;freq_displayed_kHz_str_with_freq_offset=f_kHz_with_freq_offset.toFixed(freq_field_prec(f_kHz_with_freq_offset));obj.value=freq_displayed_kHz_str_with_freq_offset;freqset_select();return obj;}
function freqset_update_ui(from){freq_displayed_Hz=freq_car_to_dsp(freq_car_Hz);var f_kHz=freq_displayed_Hz/1000;freq_displayed_kHz_str=f_kHz.toFixed(freq_field_prec(f_kHz));if(!waterfall_setup_done)return;if(freqset_restore_ui()==null)return;waterfall_position(owrx.WF_POS_RECENTER_IF_OUTSIDE);writeCookie('last_freq',freq_displayed_kHz_str_with_freq_offset);freq_dsp_set_last=freq_displayed_kHz_str_with_freq_offset;freq_step_update_ui();freq_link_update();vfo_update();if(kiwi.fmem_auto_save&&from!=owrx.FSET_NOP&&from!=owrx.FSET_SCALE_DRAG&&from!=owrx.FSET_SCALE_TOUCH_DRAG&&from!=owrx.FSET_PB_CHANGE){freq_memory_add(freq_displayed_kHz_str_with_freq_offset);}
kiwi_clearTimeout(owrx.popup_keyboard_active_timeout);owrx.popup_keyboard_active_timeout=setTimeout(function(){owrx.popup_keyboard_active=false;},2000);}
function vfo_update(A_equal_B){if(owrx.vfo_first){var vfo_default=freq_displayed_kHz_str_with_freq_offset+cur_mode+'z'+zoom_level;var last_vfo_a=parseInt(initCookie('last_vfo_A',vfo_default));var last_vfo_b=parseInt(initCookie('last_vfo_B',vfo_default));if(freq_displayed_kHz_str_with_freq_offset!=last_vfo_a&&freq_displayed_kHz_str_with_freq_offset==last_vfo_b){owrx.vfo_ab=1;w3_flip_colors('id-freq-vfo','w3-aqua w3-orange',owrx.vfo_ab);w3_innerHTML('id-freq-vfo',"AB"[owrx.vfo_ab]);}
owrx.vfo_first=false;}
var flip=(A_equal_B==true)?1:0;var vfo=freq_displayed_kHz_str_with_freq_offset+cur_mode+'z'+zoom_level;writeCookie('last_vfo_'+"AB"[owrx.vfo_ab^flip],vfo);}
function popup_keyboard_touchstart(event){owrx.popup_keyboard_active=true;}
function freqset_select(){var ae=document.activeElement;var closed_ext_input_still_holding_focus=(ae&&w3_contains(ae,'w3-ext-retain-input-focus')&&!extint.displayed);if(closed_ext_input_still_holding_focus){}
var retain_input_focus=(ae&&(w3_contains(ae,'w3-retain-input-focus')||w3_contains(ae,'w3-ext-retain-input-focus')));if(retain_input_focus){}
if(extint.scanning){return;}
if(!ae||!retain_input_focus||closed_ext_input_still_holding_focus){w3_field_select('id-freq-input',{mobile:1,log:1});}else{}}
function modeset_update_ui(mode){if(owrx.last_mode_el!=null)owrx.last_mode_el.style.color="white";var kmode=ext_mode(mode);var el=w3_el('id-mode-'+kmode.str);el.innerHTML=mode.toUpperCase();if(el&&el.style)el.style.color="lime";owrx.last_mode_el=el;owrx.last_mode_col=parseInt(el.id);squelch_setup(toggle_e.FROM_COOKIE);writeCookie('last_mode',mode);freq_link_update();vfo_update();var disabled=ext_is_IQ_or_stereo_mode(mode);w3_els('id-button-compression',function(el){w3_disable(el,disabled);});w3_els('id-deemp',function(el){w3_disable(el,disabled);});w3_hide2('id-sam-carrier-container',!kmode.SAx);w3_hide2('id-chan-null',mode!='sam');w3_hide2('id-SAM-opts',kmode.SAx);w3_hide2('id-deemp1-ofm',kmode.NBFM);w3_hide2('id-deemp2-ofm',kmode.NBFM);w3_hide2('id-deemp1-nfm',!kmode.NBFM);w3_hide2('id-deemp2-nfm',!kmode.NBFM);}
function try_freqset_update_ui(from){if(waterfall_setup_done){freqset_update_ui(from);if(wf.audioFFT_active){if(cur_mode!=wf.audioFFT_prev_mode)
wf.audioFFT_clear_wf=true;audioFFT_update();wf.audioFFT_prev_mode=cur_mode;}else{mkenvelopes(get_visible_freq_range());}}else{setTimeout(try_freqset_update_ui,1000,from);}}
function try_modeset_update_ui(mode){if(waterfall_setup_done){modeset_update_ui(mode);}else{setTimeout(function(){try_modeset_update_ui(mode);},1000);}}
function freq_link_update(){var host=kiwi_url_origin();var url=host+'/?f='+freq_displayed_kHz_str_with_freq_offset+cur_mode+'z'+zoom_level;w3_innerHTML('id-freq-link',w3_icon('w3-text-css-lime||title='+dq('copy to clipboard:\n'+url),'fa-external-link-square',15,'','freq_link_update_cb',url));}
function freq_link_update_cb(path,param,first){if(first)return;w3_copy_to_clipboard(param);}
function freqset_complete(from){if(owrx.waterfall_tuned>0){owrx.waterfall_tuned--;return;}
var obj=w3_el('id-freq-input');kiwi_clearTimeout(freqset_tout);if(isUndefined(obj)||obj==null)return;var iPhone=kiwi_is_iPhone();var a,f,pb;var adj_pbw=obj.value.includes('/');var adj_pbc=obj.value.includes(':');var set_wf=obj.value.startsWith('#');if(!set_wf){if(!iPhone||adj_pbw||adj_pbc){a=obj.value.split(/[\/\:]/);f=a[0];pb=(a.length>=2)?a[1].split(','):null;}else{a=obj.value.split('.');f=(a.length==1)?a[0]:(a[0]+'.'+a[1]);pb=a;pb.shift();pb.shift();if(pb.length==0)pb=null;adj_pbw=true;}}
if(obj.value=='/'||(iPhone&&obj.value=='..')){restore_passband(cur_mode);demodulator_analog_replace(cur_mode);freqset_update_ui(owrx.FSET_NOP);return;}
if(set_wf){f=obj.value.slice(1);if(f==''){waterfall_tune(0);return;}}
var restore=true;if(f!=''){f=f.replace(',','.').parseFloatWithUnits('M',1e-3);if(f>0&&!isNaN(f)){f-=kiwi.freq_offset_kHz;if(f>0&&!isNaN(f)){if(set_wf){waterfall_tune(f);return;}else{freqmode_set_dsp_kHz(f,null);restore=false;}
w3_field_select(obj,{mobile:1,log:2});}}}
if(restore)freqset_update_ui(owrx.FSET_NOP);if(pb){var lo=pb[0].parseFloatWithUnits('k');var hi=NaN;if(pb.length>1)hi=pb[1].parseFloatWithUnits('k');var cpb=ext_get_passband();var cpbhw=(cpb.high-cpb.low)/2;var cpbcf=cpb.low+cpbhw;if(adj_pbw){if(pb.length==1){var pbhw=lo/2;lo=cpbcf-pbhw,hi=cpbcf+pbhw;}}else{var pbc=lo;if(pb.length==1){lo=pbc-cpbhw;hi=pbc+cpbhw;}else{var pbhw=Math.abs(hi/2);lo=pbc-pbhw;hi=pbc+pbhw;}}
ext_set_passband(lo,hi,true);}}
var ignore_next_keyup_event=false;function freqset_keyup(obj,evt){kiwi_clearTimeout(freqset_tout);if(evt!=undefined&&evt.key!=undefined){var klen=evt.key.length;if(any_alternate_click_event_except_shift(evt)||(klen!=1&&evt.key!='Backspace')){if(evt.key=='Escape'){freqset_update_ui(owrx.FSET_NOP);}
ignore_next_keyup_event=false;return;}}
if(ignore_next_keyup_event){ignore_next_keyup_event=false;return;}
if(!kiwi_isMobile())
freqset_tout=setTimeout(function(){freqset_complete('t/o');},3000);}
var num_step_buttons=6;var up_down={am:[0,-1,-0.1,0.1,1,0],amn:[0,-1,-0.1,0.1,1,0],sam:[0,-1,-0.1,0.1,1,0],sal:[0,-1,-0.1,0.1,1,0],sau:[0,-1,-0.1,0.1,1,0],sas:[0,-1,-0.1,0.1,1,0],qam:[0,-1,-0.1,0.1,1,0],drm:[0,-1,-0.1,0.1,1,0],usb:[0,-0.1,-0.01,0.01,0.1,0],usn:[0,-0.1,-0.01,0.01,0.1,0],lsb:[0,-0.1,-0.01,0.01,0.1,0],lsn:[0,-0.1,-0.01,0.01,0.1,0],cw:[0,-0.1,-0.01,0.01,0.1,0],cwn:[0,-0.1,-0.01,0.01,0.1,0],nbfm:[-5,-1,-0.1,0.1,1,5],nnfm:[-5,-1,-0.1,0.1,1,5],iq:[0,-1,-0.1,0.1,1,0],};var NDB_400_1000_mode=1;function freq_step_amount(b){var kmode=ext_mode(cur_mode);var step_Hz=kmode.SSB_CW?1000:5000;var s=kmode.SSB_CW?' 1k default':' 5k default';var ITU_region=cfg.init.ITU_region+1;var ham_80m_swbc_75m_overlap=(ITU_region==2&&b&&b.name=='75m');if(b&&b.name=='NDB'){if(kmode.CW){step_Hz=NDB_400_1000_mode;}
s=' NDB';}else
if(b&&(b.name=='LW'||b.name=='MW')){if(kmode.AM_SAx_IQ_DRM){step_Hz=step_9_10?9000:10000;}
s=' LW/MW';}else{var svc=b?band_svc_lookup(b.svc):null;if(svc&&svc.o.name.includes('Broadcast')&&!ham_80m_swbc_75m_overlap){if(kmode.AM_SAx_IQ_DRM){step_Hz=5000;s=' SWBC 5k';}}else
if(b&&b.chan!=0){step_Hz=b.chan*1000;s=' band='+b.name+' chan_kHz='+b.chan;}}
return{step_Hz:step_Hz,s:s};}
function special_step(b,sel,caller){var s='SPECIAL_STEP '+caller+' sel='+sel;var rv=freq_step_amount(b);var step_Hz=rv.step_Hz;s+=rv.s;if(sel<num_step_buttons/2)step_Hz=-step_Hz;s+=' step='+step_Hz;return step_Hz;}
function freqstep(sel,shiftKey){var step_Hz=up_down[cur_mode][sel]*1000;if(step_Hz==0){var b=find_band(freq_displayed_Hz);step_Hz=special_step(b,sel,'freqstep');}
var fnew=freq_displayed_Hz;var incHz=Math.abs(step_Hz);var posHz=(step_Hz>=0)?1:0;var trunc=fnew / incHz;trunc=(posHz?Math.ceil(trunc):Math.floor(trunc))*incHz;var took;if(incHz==NDB_400_1000_mode){if(shiftKey!=true){var kHz=fnew%1000;if(posHz)
kHz=(kHz<400)?400:((kHz<600)?600:1000);else
kHz=(kHz==0)?-400:((kHz<=400)?0:((kHz<=600)?400:600));trunc=Math.floor(fnew/1000)*1000;fnew=trunc+kHz;took='400/1000';}else{fnew+=Math.sign(step_Hz)*1000;took='SHIFT';}}else
if(shiftKey!=true&&freq_displayed_Hz!=trunc){fnew=trunc;took='TRUNC';}else{fnew+=step_Hz;took=(shiftKey==true)?'SHIFT':'INC';}
freqmode_set_dsp_kHz(fnew/1000,null,{dont_clear_wf:true});}
var freq_step_last_mode,freq_step_last_band;function freq_step_update_ui(force){if(isUndefined(cur_mode)||kiwi_passbands(cur_mode)==undefined)return;var b=find_band(freq_displayed_Hz);if(!force&&freq_step_last_mode==cur_mode&&freq_step_last_band==b)return;var show_9_10=(b&&(b.name=='LW'||b.name=='MW')&&ext_mode(cur_mode).AM_SAx_IQ_DRM)?true:false;if(kiwi_isMobile()){w3_hide2('id-9-10-cell',!show_9_10);}else{w3_hide2('id-9-10-cell',false);w3_disable('id-9-10-cell',!show_9_10);}
for(var i=0;i<num_step_buttons;i++){var step_Hz=up_down[cur_mode][i]*1000;if(step_Hz==0){step_Hz=special_step(b,i,'freq_step_update_ui');}
var title;var absHz=Math.abs(step_Hz);var posHz=(step_Hz>=0)?1:0;if(absHz>=1000)
title=(posHz?'+':'')+(step_Hz/1000).toString()+'k';else
if(absHz!=NDB_400_1000_mode)
title=(posHz?'+':'')+step_Hz.toString();else{title=(posHz?'+':'-')+'400/'+(posHz?'+':'-')+'1000';}
w3_el('id-step-'+i).title=title;}
freq_step_last_mode=cur_mode;freq_step_last_band=b;}
function freq_memory_init(){kiwi.fmem_auto_save=+kiwi_storeGet('fmem_auto_save',1);kiwi.fmem_mode_save=+kiwi_storeGet('fmem_mode_save',0);var fmem;if(isNonEmptyString(owrx.override_fmem)){fmem=owrx.override_fmem.split(',');}else{fmem=kiwi_JSON_parse('freq_memory_init',readCookie('freq_memory'));}
if(isNull(fmem))fmem=[10000];var prec=(cfg.show_1Hz||url_1Hz)?3:2;fmem.forEach(function(s,i){if(isNumber(s))s=s.toString();var as=s.split(' ');var f_n=as[0].parseFloatWithUnits('kM',1e-3);fmem[i]=w3_clamp(f_n,1,cfg.max_freq?32000:30000).toFixed(prec);if(as[1])fmem[i]+=' '+as[1];});if(fmem){kiwi.freq_memory=kiwi_dedup_array(fmem);}
kiwi.fmem_help=w3_div('',w3_inline_percent('w3-padding-tiny w3-bold w3-text-aqua','Frequency memory help'),w3_inline_percent('w3-padding-tiny','The current frequency is saved in the memory list in two different ways '+'depending on the <x1>auto save</x1> setting:<br>'+'<ul><li>enabled: saves occur automatically as you tune.</li>'+'<li>disabled: saves are done manually, via the <x1>save</x1> menu item or '+'click-holding the memory icon until it turns green '+
w3_icon('','fa-bars w3-text-css-lime',20)+'</li></ul>'+'If <x1>mode save</x1> is enabled the current mode is saved and restored along with '+'the frequency.<br><br>'+'These two save modes are remembered in browser storage and used when this Kiwi is '+'visited again.<br><br>'+'The shortcut keys ^1 thru ^9 (^ means the control key) recall the memory '+'from positions 1 thru 9 in the memory list.'),w3_inline_percent('w3-padding-tiny w3-bold w3-text-aqua w3-margin-T-8','Shortcut keys'),w3_inline_percent('w3-padding-tiny','m',15,'toggle frequency memory menu'),w3_inline_percent('w3-padding-tiny','^1 ^2 ...',15,'recall memory #1 #2 ... (^ is ctl key)'),w3_inline_percent('w3-padding-tiny','n N',15,w3_inline('','VFO A/B, VFO A=B or click-hold VFO icon until it turns red',w3_div('w3-margin-L-8 w3-text-in-circle w3-wh-20px w3-red','A'))));}
function freq_memory_menu_init(){w3_menu('id-freq-memory-menu','freq_memory_menu_item_cb');}
function freq_memory_menu_open(shortcut_key){if(w3_isVisible('id-freq-memory-menu')){kiwi.freq_memory_menu_shown=0;return;}
kiwi.freq_memory_menu_shown=1;var x=owrx.last_pageX,y=owrx.last_pageY;if(shortcut_key!=true)
x+=((x-128)>=0)?-128:16;var fmem_copy=kiwi_dup_array(kiwi.freq_memory);fmem_copy.unshift('<hr>');var s='freq';if(kiwi.fmem_mode_save)s+='/mode';if(kiwi.fmem_auto_save){fmem_copy.unshift('!save '+s);fmem_copy.unshift('disable auto save');}else{fmem_copy.unshift('save '+s);fmem_copy.unshift('enable auto save');}
fmem_copy.push('<hr>');fmem_copy.push('clear all');fmem_copy.push(kiwi.fmem_mode_save?'disable mode save':'enable mode save');fmem_copy.push('VFO A=B');fmem_copy.push('help');kiwi.fmem_arr=fmem_copy;w3_menu_items('id-freq-memory-menu',fmem_copy,Math.min(fmem_copy.length,10));w3_menu_popup('id-freq-memory-menu',function(evt,first){var close_keyup=(evt.type=='keyup'&&(evt.key!='m'||!kiwi.freq_memory_menu_shown));var tgt_isMenu=w3_contains(evt.target,'w3-menu');var tgt_isMenuButton=w3_contains(evt.target,'w3-menu-button');var menu_shown=kiwi.freq_memory_menu_shown;var click=((evt.type=='click'||((evt.type=='mousedown'||evt.type=='touchstart')&&!tgt_isMenuButton)||evt.type=='touchend'));var close_click=(click&&!first&&(!tgt_isMenu||!menu_shown));var close=(close_keyup||close_click);return close;},x,y);}
function freq_memory_menu_icon_cb(el,val,trace,ev){var hold=(!kiwi.fmem_auto_save&&ev&&ev.type=='hold');var hold_done=(!kiwi.fmem_auto_save&&ev&&ev.type=='hold-done');w3_colors('id-freq-menu','w3-text-white','w3-text-css-lime',hold);if(hold){freq_memory_add(freq_displayed_kHz_str_with_freq_offset);return;}else
if(hold_done){return;}
freq_memory_menu_open(false);}
function freq_memory_at(idx){if(idx<0||idx>=kiwi.freq_memory.length)return null;var as=kiwi.freq_memory[idx].split(' ');return{freq:as[0],mode:as[1]};}
function freq_memory_add(f,clear){if(!isNumber(+f))return;if(+f<1)f='1';if(kiwi.fmem_mode_save)f+=' '+cur_mode;if(clear==true){kiwi.freq_memory=[f];}else
if(f!=kiwi.freq_memory[0]){kiwi.freq_memory.unshift(f);kiwi.freq_memory=kiwi_dedup_array(kiwi.freq_memory);}
if(kiwi.freq_memory.length>25)kiwi.freq_memory.pop();writeCookie('freq_memory',JSON.stringify(kiwi.freq_memory));}
function freq_memory_menu_item_cb(idx,x,cb_param,ev){var rv=w3.CLOSE_MENU;idx=+idx;if(idx==-1)return rv;var f_m=null;var TOP=3;var BOT=TOP+kiwi.freq_memory.length;switch(idx){case 0:kiwi.fmem_auto_save^=1;kiwi_storeSet('fmem_auto_save',kiwi.fmem_auto_save);break;case 1:if(!kiwi.fmem_auto_save){freq_memory_add(freq_displayed_kHz_str_with_freq_offset);}
break;case 2:break;default:f_m=freq_memory_at(idx-TOP);if(f_m)freq_memory_add(f_m.freq);break;case BOT:break;case BOT+1:freq_memory_add(freq_displayed_kHz_str_with_freq_offset,true);break;case BOT+2:kiwi.fmem_mode_save^=1;kiwi_storeSet('fmem_mode_save',kiwi.fmem_mode_save);break;case BOT+3:vfo_update(true);break;case BOT+4:freq_memory_help();break;}
if(f_m){ext_tune(f_m.freq-kiwi.freq_offset_kHz,f_m.mode,ext_zoom.CUR);}else{freqset_select();}
return rv;}
function freq_memory_recall(idx){var f_m=freq_memory_at(Math.min(9,idx));if(f_m)ext_tune(f_m.freq-kiwi.freq_offset_kHz,f_m.mode,ext_zoom.CUR);}
function freq_memory_help(){confirmation_show_content(kiwi.fmem_help,550,380);}
function band_info(){var _9_10=(+cfg.init.AM_BCB_chan)?10:9;var ITU_region=cfg.init.ITU_region+1;var LW_lo=153-9/2,NDB_lo,NDB_hi,MW_hi;if(ITU_region==1){NDB_lo=279+9/2;NDB_hi=531-9/2;MW_hi=1602+9/2;}else
if(ITU_region==2){NDB_lo=191-1/2;NDB_hi=540-_9_10/2;MW_hi=1700+_9_10/2;}else{NDB_lo=191-1/2;NDB_hi=540-_9_10/2;MW_hi=1602+_9_10/2;}
return{ITU_region:ITU_region,_9_10:_9_10,LW_lo:LW_lo,NDB_lo:NDB_lo,NDB_hi:NDB_hi,MW_hi:MW_hi}}
function band_svc_lookup(svc_key){var idx=null;var _dxcfg=dx_cfg_db();if(!_dxcfg)return null;_dxcfg.band_svc.forEach(function(a,i){if(a.key==svc_key)
idx=i;});if(idx==null){console.log('$$$ band_svc_lookup NO KEY MATCH for <'+svc_key+'>');return null;}
return{o:_dxcfg.band_svc[idx],i:idx};}
function bands_init(){var i,j,k,z,b,bnew;var _dxcfg=dx_cfg_db();if(_dxcfg&&_dxcfg.bands&&_dxcfg.band_svc&&_dxcfg.dx_type){console.log('BANDS: using stored _dxcfg.bands db='+dx.db+' ---------------------------------');bands_addl_info(0);dx_color_init();return;}
console.log('BANDS: using old config.js/bands db='+dx.db+'-------------------------------------');if(dx.db!=dx.DB_STORED){console.log('bands_init: DANGER! dx_cfg_db() is null but db != DB_STORED?!?');return;}
dxcfg.dx_type=[];var max_i=-1;dx.legacy_stored_types.forEach(function(a,i){dxcfg.dx_type[i]={key:i,name:dx.legacy_stored_types[i],color:dx.legacy_stored_colors[i]};max_i=i;});j=dx_type2idx(dx.DX_MASKED);for(i=max_i+1;i<j;i++){dxcfg.dx_type[i]={key:i,name:'',color:''};}
dxcfg.dx_type[j]={key:i,name:'masked',color:'lightGrey'};dx_color_init();dxcfg.band_svc=[];w3_obj_enum(svc,function(key,i,o){if(key=='X'&&o.name=='Beacons'){svc.L=svc.X;key='L';delete svc.X;}
svc[key].key=key;dxcfg.band_svc[i]={key:key,name:o.name,color:o.color};if(o.name=='Industrial/Scientific'){dxcfg.band_svc[i].name='ISM';dxcfg.band_svc[i].longName='Industrial/Scientific';}});var _bands_new=[];for(i=j=0;i<bands.length;i++){b=bands[i];if(b.name=='LW'&&b.region=='E')b.region='1';if(b.name=='LW'&&b.region=='>')b.region='23';if(b.name=='MW'&&(b.region=='3'||b.region=='>3'))b.region='13';if(b.name=='NDB'&&b.region=='E')b.region='1';if(b.name=='NDB'&&b.region=='U')b.region='2';if(b.name=='NDB'&&b.region=='>')b.region='3';if(b.name=='MF'&&b.region=='>23')b.region='*';if(b.name.startsWith('Time ')&&b.region=='*')b.region='m';if(b.region){var len=b.region.length;if(len==1){_bands_new[j]=kiwi_shallow_copy(b);bnew=_bands_new[j];j++;var c=bnew.region.charAt(0);if(c>='1'&&c<='3')
bnew.itu=ord(c,'1')+1;else
if(c=='*'||c=='>')
bnew.itu=kiwi.ITU_ANY;else
if(c=='m')
bnew.itu=kiwi.BAND_MENU_ONLY;else
if(c=='-')
bnew.itu=kiwi.BAND_SCALE_ONLY;else{bnew.itu=kiwi.BAND_SCALE_ONLY;}}else{for(k=0;k<len;k++){var c=b.region.charAt(k);if(c=='>')continue;_bands_new[j]=kiwi_shallow_copy(b);bnew=_bands_new[j];j++;if(c>='1'&&c<='3')
bnew.itu=ord(c,'1')+1;else{bnew.itu=kiwi.BAND_SCALE_ONLY;}}}}else{_bands_new[j]=kiwi_shallow_copy(b);bnew=_bands_new[j];bnew.itu=kiwi.ITU_ANY;j++;}
if(isNumber(bnew.sel))bnew.sel=bnew.sel.toFixed(2);if(isUndefined(bnew.s))bnew.s=svc.L;if((bnew.s.key=='L'||bnew.s.key=='X')&&bnew.sel.includes('cw')&&bnew.region=='m'){if(!bnew.name.includes('IBP'))
bnew.name='IBP '+bnew.name;if(!bnew.sel.includes('cwn'))
bnew.sel=bnew.sel.replace('cw','cwn');}
if(bnew.name.includes('IBP'))
bnew.s='L';}
for(i=0;i<_bands_new.length;i++){bnew=_bands_new[i];if(isString(bnew.s))bnew.svc=bnew.s;else
if(isObject(bnew.s))
bnew.svc=bnew.s.key;else{}
delete bnew.s;delete bnew.region;}
dxcfg.bands=[];for(i=0;i<_bands_new.length;i++){b=_bands_new[i];var sel=b.sel||'';dxcfg.bands.push({min:b.min,max:b.max,name:b.name,svc:b.svc,itu:b.itu,sel:sel,chan:b.chan});}
console.log('_bands_new:');console.log(_bands_new);bands_addl_info(0);}
function dx_cfg_db(){var db=(dx.db==dx.DB_COMMUNITY)?dxcomm_cfg:dxcfg;if(db==null){console.log('dx_cfg_db DANGER db=null dxcfg='+dxcfg+' dxcomm_cfg='+dxcomm_cfg);console.log('dx_cfg_db DANGER dx.db('+dx.db+')='+((dx.db==dx.DB_COMMUNITY)?'DB_COMMUNITY':'DB_STORED'));}
return db;}
function kiwi_bands_db(init_bands){if(init_bands==dx.INIT_BANDS_YES){if(dx.db==dx.DB_STORED)kiwi.bands=[];else
if(dx.db==dx.DB_COMMUNITY)kiwi.bands_community=[];}
return(dx.db==dx.DB_COMMUNITY)?kiwi.bands_community:kiwi.bands;}
function bands_addl_info(isAdmin){var i,z,b1,b2;var offset_kHz=kiwi.freq_offset_kHz;console.log('BANDS: creating additional band info');if(isAdmin&&dx.db!=dx.DB_STORED){console.log('bands_addl_info: isAdmin=1 but dx.db='+dx.db+' !!!');return;}
var _dxcfg=dx_cfg_db();if(!_dxcfg)return;var _kiwi_bands=kiwi_bands_db(dx.INIT_BANDS_YES);for(i=0;i<_dxcfg.bands.length;i++){b1=_dxcfg.bands[i];b2=_kiwi_bands[i]={};_dxcfg.bands[i].chan=isUndefined(b1.chan)?0:b1.chan;var min=b1.min,max=b1.max;if(offset_kHz&&b1.min>=offset_kHz){min-=offset_kHz;max-=offset_kHz;b2.isOffset=true;}else
if(b1.min>32000)
b2.isOffset=true;else
if(b2.isOffset!=true)
b2.isOffset=false;b2.minHz=min*1000;b2.maxHz=max*1000;b2.chanHz=b1.chan*1000;var bw=b2.maxHz-b2.minHz;for(z=zoom_nom;z>=0;z--){var zbw=bandwidth /(1<<z);if(bw<=0.80*zbw)
break;}
b2.zoom_level=z;b2.cfHz=b2.minHz+(b2.maxHz-b2.minHz)/2;var svc=band_svc_lookup(b1.svc);if(svc!=null){var longName=svc.o.longName||svc.o.name;b2.longName=b1.name+' '+longName;}else{b2.longName=b1.name;}}}
var band_menu=[];function setup_band_menu(){var i,op=0,service=null;var s='<option value="0" selected disabled>select band</option>';band_menu[op++]=null;var ITU_region=cfg.init.ITU_region+1;var _dxcfg=dx_cfg_db();if(!_dxcfg)return'';var _kiwi_bands=kiwi_bands_db(dx.INIT_BANDS_NO);for(i=0;i<_dxcfg.bands.length;i++){var b1=_dxcfg.bands[i];var b2=_kiwi_bands[i];if(kiwi.isOffset){if(!b2.isOffset)continue;}else{if(b2.isOffset)continue;}
if(!(b1.itu==kiwi.BAND_MENU_ONLY||b1.itu==kiwi.ITU_ANY||b1.itu==ITU_region))continue;if(service!=b1.svc){service=b1.svc;var svc=band_svc_lookup(b1.svc);if(!svc)continue;s+='<option value='+dq(op)+' disabled>'+svc.o.name.toUpperCase()+'</option>';band_menu[op++]=null;}
s+='<option value='+dq(op)+'>'+b1.name+'</option>';band_menu[op]={};band_menu[op].b1=b1;band_menu[op].b2=b2;op++;}
return s;}
function mk_band_menu(){band_menu=[];owrx.last_selected_band=0;w3_innerHTML('id-select-band',setup_band_menu());}
function find_band(freq){var ITU_region=cfg.init.ITU_region+1;var _dxcfg=dx_cfg_db();if(!_dxcfg)return null;var _kiwi_bands=kiwi_bands_db(dx.INIT_BANDS_NO);for(var i=0;i<_dxcfg.bands.length;i++){var b1=_dxcfg.bands[i];var b2=_kiwi_bands[i];if(!(b1.itu==kiwi.BAND_SCALE_ONLY||b1.itu==kiwi.ITU_ANY||b1.itu==ITU_region))continue;var max=(b1.name=='MW')?1710000:b2.maxHz;if(freq>=b2.minHz&&freq<=max){return b1;}}
return null;}
band_canvas_h=30;band_canvas_top=0;band_scale_h=20;band_scale_top=5;band_scale_text_top=5;dx_container_h=80;dx_container_top=band_canvas_h;dx_label_top=5;dx_line_h=dx_container_h-dx_label_top;scale_canvas_h=47;scale_canvas_top=band_canvas_h+dx_container_h;scale_container_h=band_canvas_h+dx_container_h+scale_canvas_h;function mk_bands_scale(){var r=g_range;var tw=band_ctx.canvas.width;var i,x,y=band_scale_top,w,h=band_scale_h,ty=y+band_scale_text_top;var start=r.start;var end=r.end;band_ctx.globalAlpha=1;band_ctx.fillStyle="White";band_ctx.fillRect(0,band_canvas_top,tw,band_canvas_h);var ITU_region=cfg.init.ITU_region+1;var _dxcfg=dx_cfg_db();if(!_dxcfg)return;var _kiwi_bands=kiwi_bands_db(dx.INIT_BANDS_NO);for(i=0;i<_dxcfg.bands.length;i++){var b1=_dxcfg.bands[i];var b2=_kiwi_bands[i];if(kiwi.isOffset){if(!b2.isOffset)continue;}else{if(b2.isOffset)continue;}
if(!(b1.itu==kiwi.BAND_SCALE_ONLY||b1.itu==kiwi.ITU_ANY||b1.itu==ITU_region))continue;var x1=-1,x2;var bmin=b2.minHz,bmax=b2.maxHz;var min_inside=(bmin>=start&&bmin<=end)?1:0;var max_inside=(bmax>=start&&bmax<=end)?1:0;if(min_inside&&max_inside){x1=bmin;x2=bmax;}else
if(!min_inside&&max_inside){x1=start;x2=bmax;}else
if(min_inside&&!max_inside){x1=bmin;x2=end;}else
if(bmin<start&&bmax>end){x1=start;x2=end;}
if(x1==-1){continue;}
x=scale_px_from_freq(x1,g_range);var xx=scale_px_from_freq(x2,g_range);w=xx-x;if(w<3)continue;var svc=band_svc_lookup(b1.svc);band_ctx.fillStyle=svc?svc.o.color:'grey';band_ctx.globalAlpha=0.2;band_ctx.fillRect(x,y,w,h);band_ctx.globalAlpha=1;band_ctx.font="bold 12px sans-serif";band_ctx.textBaseline="top";var tx=x+w/2;var txt=b2.longName;var mt=band_ctx.measureText(txt);if(w>=mt.width+4){;}else{txt=b1.name;mt=band_ctx.measureText(txt);if(w>=mt.width+4){;}else{txt=null;}}
if(txt)band_ctx.fillText(txt,tx-mt.width/2,ty);}}
function parse_freq_pb_mode_zoom(s){return new RegExp('([0-9.,kM]*)([\/:][-0-9.,k]*)?([^z]*)?z?([0-9]*)').exec(s);}
function band_scroll(dir){if(band_menu.length==0||(band_menu.length==1&&band_menu[0]==null))return;var i=owrx.last_selected_band;var b;do{i+=dir;if(i<0)i=band_menu.length-1;if(i>=band_menu.length)i=0;b=band_menu[i];}while(b==null);select_band(i);w3_set_value('id-select-band',i);}
function select_band(v,mode_s){var b,v_num=+v;if(isNumber(v_num)){b=band_menu[v_num];}else{var i;for(i=0;i<band_menu.length-1;i++){if(band_menu[i]&&band_menu[i].b1.name==v)
break;}
if(i<band_menu.length-1)
select_band(i,mode_s);return;}
if(b==null){check_band(true);return;}
var b1=b.b1;var b2=b.b2;if(dbgUs){console.log(b);console.log(b1);console.log(b2);}
var freq=b2.cfHz/1000,mode=mode_s,zoom=null;if(b1.sel!=''){var p=parse_freq_pb_mode_zoom(b1.sel);if(p[1])freq=parseFloat(p[1]);if(p[3]&&isUndefined(mode_s))mode=p[3].toLowerCase();if(p[4])zoom=+p[4];}
owrx.last_selected_band=v_num;if(dbgUs){sb_trace=0;}
freqmode_set_dsp_kHz(freq,mode);if(isNumber(zoom))
zoom_step(ext_zoom.ABS,zoom);else
zoom_step(ext_zoom.TO_BAND,b);if(sb_trace){}}
function check_band(reset){if(owrx.last_selected_band){var b=band_menu[owrx.last_selected_band];var b1=b.b1;var b2=b.b2;var car=freq_car_Hz;var pbc=freq_passband_center();if((reset!=undefined&&reset==-1)||((car<b2.minHz||car>b2.maxHz)&&(pbc<b2.minHz||pbc>b2.maxHz))){w3_select_value('id-select-band',0);owrx.last_selected_band=0;}}}
function tune(fdsp,mode,zoom,zarg){ext_tune(fdsp,mode,ext_zoom.ABS,zoom,zarg);}
var maxdb;var mindb_un;var mindb;var full_scale;function init_scale_dB(){maxdb=init_max_dB;mindb_un=init_min_dB;mindb=mindb_un-zoomCorrection();full_scale=maxdb-mindb;full_scale=full_scale?full_scale:1;wf.save_maxdb=maxdb;wf.save_mindb_un=mindb_un;wf.auto_ceil.val=+initCookie('last_ceil_dB',cfg.init.ceil_dB);wf.auto_floor.val=+initCookie('last_floor_dB',cfg.init.floor_dB);}
var confirmation={displayed:false,close_cb:null,};function confirmation_panel_init(){w3_el('id-panels-container').innerHTML+=w3_div('id-confirmation class-panel|border: 1px solid white|data-panel-name="confirmation" data-panel-pos="center" data-panel-order="0" data-panel-size="600,100"');w3_innerHTML('id-confirmation',w3_divs('id-confirmation-container/class-panel-inner')+
w3_div('id-confirmation-vis class-vis'));}
function confirmation_panel_set_close_func(close_cb){w3_el('id-confirmation-close').onclick=close_cb;confirmation.close_cb=close_cb;}
function confirmation_panel_init2(){confirmation_panel_set_close_func(confirmation_panel_close);w3_el('id-kiwi-body').addEventListener('keyup',function(evt){if(evt.key=='Escape'){confirmation.close_cb();toggle_or_set_hide_panels(0);}},true);}
function confirmation_show_content(s,w,h,close_cb,bg_color){if(confirmation.displayed)
w3_color('id-confirmation',null,'');w3_innerHTML('id-confirmation-container',s);w3_color('id-confirmation',null,bg_color);if(close_cb)confirmation_panel_set_close_func(close_cb);confirmation_panel_show(w,h);toggle_or_set_hide_panels(0);}
function confirmation_panel_show(w,h){el=w3_el('id-confirmation');el.style.zIndex=1020;if(isNoArg(w))w=525;if(isNoArg(h))h=80;confirmation_panel_resize(w,h);confirmation.displayed=!confirmation.displayed;toggle_panel('id-confirmation');}
function confirmation_panel_resize(w,h){var el=w3_el('id-confirmation');panel_set_width_height('id-confirmation',w,h);el.style.left=px(window.innerWidth/2-el.activeWidth/2);el.style.bottom=px(window.innerHeight/2-el.uiHeight/2);}
function confirmation_panel_close(){if(confirmation.displayed){w3_color('id-confirmation',null,'');toggle_panel('id-confirmation');confirmation_panel_set_close_func(confirmation_panel_close);confirmation.displayed=false;}}
function set_freq_offset_dialog(){var s=w3_col_percent('/w3-text-aqua',w3_input_get('w3-margin-T-6','Frequency scale offset (kHz, 1 Hz resolution)','cfg.freq_offset','w3_float_set_cfg_cb|3'),80);confirmation_show_content(s,525,80);w3_field_select('id-cfg.freq_offset',{mobile:1});}
var cal_adc_new_adj;function cal_adc_dialog(new_adj,clk_diff,r1k,ppm){var s;var gps_correcting=(cfg.ADC_clk2_corr!=kiwi.ADC_CLK_CORR_DISABLED&&ext_adc_gps_clock_corr()>3)?1:0;if(gps_correcting){s=w3_col_percent('/w3-valign',w3_div('w3-show-inline-block','GPS is automatically correcting ADC clock. <br> No manual calibration available.')+
w3_button('w3-red w3-margin-left','Close','confirmation_panel_close'),80);}else{cal_adc_new_adj=new_adj;var adc_clock_ppm_limit=100;var hz_limit=ext_adc_clock_nom_Hz()*adc_clock_ppm_limit / 1e6;if(new_adj<-hz_limit||new_adj>hz_limit){console.log('cal ADC clock: ADJ TOO LARGE');s=w3_col_percent('/w3-valign',w3_div('w3-show-inline-block','ADC clock adjustment too large: '+clk_diff+' Hz<br>'+'(ADC clock '+ppm.toFixed(1)+' ppm, limit is +/- '+adc_clock_ppm_limit+' ppm)')+
w3_button('w3-red w3-margin-left','Close','confirmation_panel_close'),80);}else{s=w3_col_percent('/w3-valign',w3_div('w3-show-inline-block','ADC clock will be adjusted by<br>'+clk_diff+' Hz to '+r1k+' kHz<br>'+'(ADC clock '+ppm.toFixed(1)+' ppm)')+
w3_button('w3-green w3-margin-left','Confirm','cal_adc_confirm')+
w3_button('w3-red w3-margin-left','Cancel','confirmation_panel_close'),80);}}
confirmation_show_content(s,525,70);}
function cal_adc_confirm(){ext_send('SET clk_adj='+cal_adc_new_adj);ext_set_cfg_param('cfg.clk_adj',cal_adc_new_adj,EXT_SAVE);confirmation_panel_close();}
function admin_pwd_query(isAdmin_true_cb){ext_hasCredential('admin',admin_pwd_cb,isAdmin_true_cb,ws_wf);}
function admin_pwd_cb(badp,isAdmin_true_cb){console.log('admin_pwd_cb badp='+badp);if(badp==kiwi.BADP_OK){isAdmin_true_cb();return;}
var s=w3_col_percent('/w3-text-aqua',w3_input('kiwi-pw','Admin password','admin.pwd','','admin_pwd_cb2'),80);confirmation_show_content(s,525,80);w3_field_select('id-admin.pwd',{mobile:1});}
function admin_pwd_cb2(el,val){w3_string_cb(el,val);confirmation_panel_close();ext_valpwd('admin',val,ws_wf);}
var dx={step_dbg:0,step_superDARN:0,sig_bw_vis:'hidden',sig_bw_left:'0px',url_p:null,help:false,dxcfg_parse_error:null,dxcomm_cfg_parse_error:null,DB_STORED:0,DB_EiBi:1,DB_COMMUNITY:2,DB_N:3,db:0,db_s:['stored (writeable)','EiBi-A23 (read-only)','community (downloaded)'],db_short_s:['stored','EiBi','community'],ignore_dx_update:false,last_community_download:'',INIT_BANDS_NO:0,INIT_BANDS_YES:1,DX_STEP:2,DX_MKRS:4,DX_JSON:0,DX_CSV:1,IDX_USER:null,UPD_MOD:0,UPD_ADD:1,o:{},legacy_stored_types:['active','watch-list','sub-band','DGPS','special event','interference'],legacy_stored_colors:['cyan','lightPink','aquamarine','lavender','violet','violet','lightGrey'],stored_colors_light:[],stored_lightness:0.95,filter_tod:[1,1,1],dow_colors:['lightCoral','lightSalmon','gold','yellowGreen','springGreen','deepSkyBlue','violet'],eibi_colors:[],eibi_hue:['cyan',300,'deepSkyBlue','silver',50,'peachPuff','mediumAquaMarine',270,180,70,'springGreen',0],eibi_light:[0,80,0,0,70,0,0,80,80,45,0,75],eibi_colors_light:[],eibi_lightness:0.90,eibi_svc_s:['Bcast','Utility','Time','ALE','HFDL','Milcom','CW','FSK','FAX','Aero','Marine','Spy'],eibi_ext:['','','time','ale','hfdl','','cw','fsk','fax','','',''],DX_MODE:0x0000000f,DX_TYPE:0x000001f0,DX_TYPE_SFT:4,DX_N_STORED:16,DX_STORED:0x00000000,DX_QUICK_0:0x00000000,DX_QUICK_1:0x00000001,DX_MASKED:0x000000f0,DX_N_EiBi:12,DX_EiBi:0x00000100,DX_BCAST:0x00000100,DX_UTIL:0x00000110,DX_TIME:0x00000120,DX_ALE:0x00000130,DX_HFDL:0x00000140,DX_MILCOM:0x00000150,DX_CW:0x00000160,DX_FSK:0x00000170,DX_FAX:0x00000180,DX_AERO:0x00000190,DX_MARINE:0x000001a0,DX_SPY:0x000001b0,DX_DOW_SFT:9,DX_DOW:0x0000fe00,DX_MON:0x00008000,DX_FLAGS:0xffff0000,DX_FILTERED:0x00010000,DX_HAS_EXT:0x00020000,DX_MODE_16:0x00040000,eibi_types_mask:0xffffffff,DX_N_COMM:15,T0_RESERVED:0,T1_CHANNEL:1,T2_HAM:2,T3_BCAST:3,T4_UTIL:4,T5_TIME:5,T6_ALE:6,T7_HFDL:7,T8_MILCOM:8,T9_CW:9,T10_FSK:10,T11_FAX:11,T12_AERO:12,T13_MARINE:13,T14_SPY:14,list:[],displayed:[],sig_bw_render_gid:-1,last_stepped_gid:-1,filter_ident:'',filter_notes:'',filter_case:0,filter_wild:0,filter_grep:0,ctrl_click:false,};function dx_init(){var open=false;dx.DX_DOW_BASE=dx.DX_DOW>>dx.DX_DOW_SFT;if((dx.url_p=kiwi_url_param('dx','',null))!=null){dx.db=dx.DB_EiBi;w3_do_when_cond(function(){var el=w3_el('id-ext-controls');return el?el.init:false;},function(){console.log('DX URL '+dq(dx.url_p));var do_filter=false;if(dx.url_p!=''){var r,p=dx.url_p.split(',');p.forEach(function(a,i){console.log('DX URL <'+a+'>');if((i==0&&a==0)||w3_ext_param('sto',a).match){dx.db=dx.DB_STORED;dx.filter_tod[dx.db]=0;}else
if((i==0&&a==2)||w3_ext_param('com',a).match){dx.db=dx.DB_COMMUNITY;dx.filter_tod[dx.db]=0;}else
if(w3_ext_param('none',a).match){dx.eibi_types_mask=0;console.log('DX URL SET none dx.eibi_types_mask='+dx.eibi_types_mask);}else
if((r=w3_ext_param('filter',a)).match){dx.filter_tod[dx.db]=r.has_value?r.num:1;console.log('DX URL SET filter_tod='+dx.filter_tod[dx.db]+' r.has_value='+r.has_value+' r.num='+r.num);}else
if(w3_ext_param('open',a).match){open=true;}else
if(w3_ext_param('help',a).full_match){open=true;dx.help=true;}else
if((r=w3_ext_param('ident',a)).match){dx.filter_ident=r.string_case;do_filter=true;}else
if((r=w3_ext_param('notes',a)).match){dx.filter_notes=r.string_case;do_filter=true;}else
if(w3_ext_param('case',a).match){console.log('DX URL SET case');dx_filter_opt_cb('dx.filter_case',1);}else
if(w3_ext_param('grep',a).match){console.log('DX URL SET grep');dx_filter_opt_cb('dx.filter_grep',1);}else
w3_ext_param_array_match_str(dx.eibi_svc_s,a,function(i,a){var v=dx.eibi_types_mask&(1<<i);if(v)
dx.eibi_types_mask&=~(1<<i);else
dx.eibi_types_mask|=1<<i;console.log('DX URL MATCH '+a+' v='+v.toHex(8)+'('+i+') dx.eibi_types_mask='+dx.eibi_types_mask.toHex(8));});});}
console.log('DX URL DONE db='+dx.db+' open='+open+' eibi_types_mask='+dx.eibi_types_mask.toHex(8)+' help='+dx.help);if(do_filter){console.log('DX URL DONE ident=<'+dx.filter_ident+'> notes=<'+dx.filter_notes+'>');dx_filter_cb();}
dx_schedule_update();},null,500);}else{dx.db=kiwi_storeGet('last_db',cfg.dx_default_db);}
dx_database_cb('',dx.db,false,{open:open});if(dx.step_superDARN)setTimeout(function(){dx.filter_ident='superDARN';dx_filter_cb();},1000);}
function dx_decode_mode(flags){return((((flags)&dx.DX_MODE_16)?16:0)|((flags)&dx.DX_MODE));}
function dx_encode_mode(mode){return((((mode)>=16)?dx.DX_MODE_16:0)|((mode)&dx.DX_MODE));}
function dx_type2idx(type){var type=type&dx.DX_TYPE;if(type>=dx.DX_EiBi)type-=dx.DX_EiBi;return(type>>dx.DX_TYPE_SFT);}
function dx_eibi_type2mask(type){return(1<<dx_type2idx(type));}
function dx_set_type(type){dx.eibi_types_mask=dx_eibi_type2mask(type);}
function dx_is_single_type(type){return(dx.db==dx.DB_EiBi&&dx.eibi_types_mask==dx_eibi_type2mask(type));}
function dx_color_init(){if(dx.db!=dx.DB_EiBi){var _dxcfg=dx_cfg_db();if(!_dxcfg)return;for(var i=0;i<_dxcfg.dx_type.length;i++){var o=_dxcfg.dx_type[i];var color=(o.color=='')?'white':o.color;var colorObj=w3color(color);if(colorObj.valid){if(dx.db==dx.DB_STORED)
colorObj.lightness=dx.stored_lightness;dx.stored_colors_light[i]=colorObj.toHslString();}}}else{dx.eibi_hue.forEach(function(color_or_hue,i){if(isString(color_or_hue)){dx.eibi_colors[i]=color_or_hue;}else{dx.eibi_colors[i]='hsl('+color_or_hue+',100%,'+dx.eibi_light[i]+'%)';}
var color=w3color(dx.eibi_colors[i]);color.lightness=dx.eibi_lightness;dx.eibi_colors_light[i]=color.toHslString();});for(var i=0;i<dx.DX_N_EiBi;i++){w3_color('eibi-cbox'+i+'-label','black',dx.eibi_colors[i]);}}}
function dx_update_request(){w3_do_when_cond(function(){return waterfall_setup_done;},function(){dx_update();bands_init();mk_bands_scale();mk_band_menu();},null,200);}
function dx_show(show,gid){w3_visible(dx_canvas,show);dx.sig_bw_vis=dx_canvas.style.visibility;dx.sig_bw_left=dx_canvas.style.left;w3_hide2('id-dx-sig',!show);if(isArg(gid))dx.sig_bw_render_gid=gid;}
var dx_update_delay=350;var dx_update_timeout;function dx_schedule_update(){kiwi_clearTimeout(dx_update_timeout);dx_div.innerHTML='';dx_show(false);dx_update_timeout=setTimeout(dx_update,dx_update_delay);}
function dx_update(){var eibi=(dx.db==dx.DB_EiBi);var anti_clutter=(ext_panel_displayed('HFDL')&&dx_is_single_type(dx.DX_HFDL)&&zoom_level>=4)?0:1;var min=(g_range.start/1000+kiwi.freq_offset_kHz).toFixed(3);var max=(g_range.end/1000+kiwi.freq_offset_kHz).toFixed(3);wf_send('SET MARKER db='+dx.db+' min='+min+' max='+max+' zoom='+zoom_level+' width='+waterfall_width+' eibi_types_mask='+dx.eibi_types_mask.toHex()+' filter_tod='+dx.filter_tod[dx.db]+' anti_clutter='+anti_clutter);if(dx.step_dbg)console.log('UPDATE list');kiwi_clearTimeout(dx.dx_refresh_timeout);if(dx.filter_tod[dx.db]){var _5_min_ms=5*60*1e3;var ms_delay=2e3;var ms_rem=_5_min_ms-(Date.now()%_5_min_ms);dx.dx_refresh_timeout=setTimeout(function(){dx_div.innerHTML='';dx_show(false);dx_update();},ms_rem+ms_delay);}}
var dx_ibp_list,dx_ibp_interval,dx_ibp_server_time_ms,dx_ibp_local_time_epoch_ms=0;var dx_ibp_freqs={14:0,18:1,21:2,24:3,28:4};var dx_ibp_lastsec=0;var dx_ibp_stations={'4U1UN':{value:0,text:'New York'},'VE8AT':{value:1,text:'Nunavut'},'W6WX':{value:2,text:'California'},'KH6RS':{value:3,text:'Hawaii'},'ZL6B':{value:4,text:'New Zealand'},'VK6RBP':{value:5,text:'Australia'},'JA2IGY':{value:6,text:'Japan'},'RR9O':{value:7,text:'Siberia'},'VR2B':{value:8,text:'Hong Kong'},'4S7B':{value:9,text:'Sri Lanka'},'ZS6DN':{value:10,text:'South Africa'},'5Z4B':{value:11,text:'Kenya'},'4X6TU':{value:12,text:'Israel'},'OH2B':{value:13,text:'Finland'},'CS3B':{value:14,text:'Madeira'},'LU4AA':{value:15,text:'Argentina'},'OA4B':{value:16,text:'Peru'},'YV5B':{value:17,text:'Venezuela'}};function dx_label_render_cb(arr){var i,j,k;var hdr=arr[0];dx.last_hdr=hdr;var obj;var _dxcfg=dx_cfg_db();if(!_dxcfg)return;var stored=(dx.db==dx.DB_STORED);var eibi=(dx.db==dx.DB_EiBi);var community=(dx.db==dx.DB_COMMUNITY);var gap=eibi?40:35;var dbg_lbl=false;console_log_lbl=function(s){if(dbg_lbl)console.log(s);};dx_color_init();if(hdr.t==dx.DX_STEP){var dl=arr[1];if(dl){if(dx.step_dbg)console.log('dx_label_render_cb: DX_STEP [[[RESP]]] gid='+dl.g+' f='+dl.f);if(dx.step_dbg)console.log(JSON.stringify(dl));var mode=kiwi.modes_lc[dx_decode_mode(dl.fl)];freqmode_set_dsp_kHz(dl.f,mode);if(dl.lo!=0&&dl.hi!=0){ext_set_passband(dl.lo,dl.hi);}else{var dpb=kiwi_passbands(mode);ext_set_passband(dpb.lo,dpb.hi);}
dx.sig_bw_render_gid=dl.g;}else{if(dx.step_dbg)console.log('dx_label_render_cb: DX_STEP [[[RESP]]]: NO LABEL FOUND');dx.sig_bw_render_gid=-1;}
return;}
var errors=hdr.pe+hdr.fe;if(errors){var el=w3_el('id-dxcfg-err');if(el&&!el.innerHTML.startsWith('Warning')){el.innerHTML='Warning: dx.json file has '+errors+' label'+plural(errors,' error');w3_add(el,'w3-text-css-orange');}}
kiwi_clearInterval(dx_ibp_interval);dx_ibp_list=[];dx_ibp_server_time_ms=hdr.s*1000+(+hdr.m);dx_ibp_local_time_epoch_ms=Date.now();if(eibi&&isDefined(hdr.ec))for(i=0;i<dx.DX_N_EiBi;i++){if(isDefined(hdr.ec[i]))
w3_innerHTML('eibi-cbox'+i+'-label',dx.eibi_svc_s[i]+' ('+hdr.ec[i]+')');}
if(community&&isDefined(hdr.tc))for(i=0;i<=dx.DX_N_COMM;i++){if(isDefined(hdr.tc[i]))
w3_innerHTML('id-dxcomm'+i+'-label',dxcomm_cfg.dx_type[i].name+' ('+hdr.tc[i]+')');}
dx.types_n=hdr.tc;dx_filter_field_err(+hdr.f);var dx_idx,dx_z=120;dx_div.innerHTML='';dx.displayed=[];dx.last_freq=0;dx.last_ident='';dx.last_f_base=-1;dx.post_render=[];dx.color_fixup=[];dx.f_same=[];var same_x,lock_z=0;var center_x1=Math.floor(wf_container.clientWidth/2)-1;var center_x2=center_x1+2;var s_a=[];var optimize_label_layout=function(x,z,f){var i,j,k;var spacing=6;var n=Math.ceil(gap / spacing);if(dx.font){dx.f_same.forEach(function(idx,i){idx++;var o=arr[idx];o.di=kiwi_decodeURIComponent('',o.i);o.tw=getTextWidth(o.di,dx.font);});dx.f_same.sort(function(i1,i2){var o1=arr[i1+1];var o2=arr[i2+1];return o2.tw-o1.tw;});}
for(i=0;i<=dx.f_same.length;i++){var idx=dx.f_same[i];j=i%(n+1);dx.post_render[idx]={top:dx_label_top+(j*spacing),ltop:dx_label_top,x:x+j*(spacing-1),z:z+i};if(j==n){x+=gap;}}};if(dbg_lbl){console.log('######## dx_label_render_cb db='+dx.db+' arr.len='+arr.length);console.log(arr);}
for(i=1;i<arr.length;i++){dx_idx=i-1;obj=arr[i];var freq=obj.f;var flags=obj.fl;var type=flags&dx.DX_TYPE;var color_idx=dx_type2idx(type);var filtered=flags&dx.DX_FILTERED;var ident=obj.i;if(eibi&&ident==dx.last_ident&&freq==dx.last_freq){console_log_lbl('1111 dx_idx='+dx_idx+' '+freq+' SAME AS LAST filtered='+(filtered?1:0)+' '+ident);if(filtered==0)dx.color_fixup[dx.last_idx]=dx.eibi_colors[color_idx];continue;}
dx.last_idx=dx_idx;dx.last_freq=freq;dx.last_ident=ident;console_log_lbl('1111 dx_idx='+dx_idx+' '+freq+' OK filtered='+(filtered?1:0)+' '+ident);var gid=obj.g;var f_base=freq-kiwi.freq_offset_kHz;var mkr_off=obj.o;var notes=isDefined(obj.n)?obj.n:'';var params=isDefined(obj.p)?obj.p:'';if(eibi&&(flags&dx.DX_HAS_EXT)){var ext_name=dx.eibi_ext[dx_type2idx(type)];if(ident.includes('CHU'))ext_name='fsk';params=ext_name+',*';}
var f_baseHz=f_base*1000;var f_base_label_Hz=f_baseHz+passband_offset_dxlabel(kiwi.modes_lc[dx_decode_mode(flags)],params,obj.lo,obj.hi);var x=scale_px_from_freq(f_base_label_Hz,g_range)-1;var cmkr_x=0;var carrier=f_baseHz-mkr_off;if(mkr_off)cmkr_x=scale_px_from_freq(carrier,g_range);if(eibi&&f_base_label_Hz==dx.last_f_base){dx.f_same.push(dx_idx);same_x=x;if(lock_z==0)lock_z=dx_z;}else{if(eibi){if(dx.f_same.length>2)optimize_label_layout(same_x,lock_z,dx.last_f_base/1e3);dx.f_same=[];dx.f_same.push(dx_idx);lock_z=0;}}
var top=dx_label_top+(gap*(dx_idx&1));dx.post_render[dx_idx]={top:top,ltop:top,x:x};dx.last_f_base=f_base_label_Hz;var color;if(eibi){color=filtered?dx.eibi_colors_light[color_idx]:dx.eibi_colors[color_idx];}else{var c=_dxcfg.dx_type[color_idx].color;if(c=='')c='white';color=filtered?dx.stored_colors_light[color_idx]:c;}
if(!eibi&&color_idx==0&&(ident=='IBP'||ident=='IARU%2fNCDXF')){color='aquamarine';}
console_log_lbl('DX '+dx_idx+' f='+freq+' k='+mkr_off+' FL='+flags.toHex(8)
+' m='+kiwi.modes_uc[dx_decode_mode(flags)]+' <'+ident+'> <'+notes+'>');carrier=freq*1000-mkr_off;carrier /=1000;var center=(x>=center_x1&&x<=center_x2)?1:0;dx.list[gid]={gid:gid,carrier:carrier,lo:obj.lo,hi:obj.hi,freq:freq,f_label:f_base_label_Hz,mkr_off:mkr_off,sig_bw:obj.s,flags:flags,begin:obj.b,end:obj.e,ident:ident,notes:notes,params:params,color:color,center:center};console_log_lbl('dx_label_render_cb db='+dx.db+' dx_idx='+dx_idx+'/'+arr.length+' gid='+gid+' dx.list.len='+dx.list.length+' '+freq.toFixed(2)+' x='+center_x1+'|'+x+'|'+center_x2+' center='+center);dx.displayed[dx_idx]=dx.list[gid];console_log_lbl(dx.list[gid]);var has_ext=(params!='');var _class=w3_sb('w3-custom-events w3-hold cl-dx-label',has_ext?'dx-has-ext':'',filtered?'cl-dx-label-filtered':'',(has_ext&&!filtered)?'cl-dx-label-ext':'');var _style_attr=sprintf('|left:%s; z-index:%d; background:%s|id="id-dx-label_%s"',px(x-10),dx_z,color,dx_idx);s_a[dx_idx]=w3_button_path(_class+_style_attr,'dx-'+gid,'','dx_evt',w3_sbc(',',gid,cmkr_x))+
w3_div(sprintf('cl-dx-line|left:%s; z-index:110|id="id-dx-line_%s"',px(x),dx_idx));dx_z++;}
if(eibi&&dx.f_same.length>2)optimize_label_layout(same_x,lock_z,-1);console_log_lbl(dx.list);console_log_lbl(dx.displayed);w3_innerHTML(dx_div,w3_div('id-dx-sig cl-dx-sig w3-hide'));if(dx.step_dbg)console.log('RENDER START func='+hdr.t+' len='+(arr.length-1)+' sig_bw_render_gid='+dx.sig_bw_render_gid);var j=0;var ds='';for(i=0;i<arr.length-1;i++){if(!isDefined(s_a[i]))continue;w3_create_appendElement(dx_div,'div',s_a[i]);gid=dx.displayed[i].gid;if(dx.step_dbg)ds+=' '+gid+'('+i+')';if(gid==dx.sig_bw_render_gid){if(dx.step_dbg)console.log('RENDER dx_sig_bw() gid='+gid);dx_sig_bw(gid);dx.last_stepped_gid=gid;}
j++;}
if(dx.step_dbg)console.log('RENDER '+j+' labels'+ds);dx.last_freq=0;dx.last_ident='';if(!dx.font){var el=w3_el('id-dx-label_0');if(el){dx.font=css_style(el,'font-size')+' '+css_style(el,'font-family');console_log_lbl('dx.font=<'+dx.font+'>');}}
var dx_title=function(obj){var dow_s='';var dow=obj.fl&dx.DX_DOW;if(dow==dx.DX_DOW)dow=0;if(obj.b==0&&obj.e==0){obj.e=2400;kiwi_trace('$SHOULD NOT OCCUR');}
if(dow)for(var i=0;i<7;i++){var bit=dx.DX_MON>>i;var match=bit&dow;var c=match?'MTWTFSS'[i]:'_';dow_s+=c;}else
dow_s='7-days';var s=obj.b.leadingZeros(4)+'-'+obj.e.leadingZeros(4)+' '+dow_s;if(eibi){var lang='';if(obj.l!=''&&obj.l.charAt(0)!='-')lang=' lang: '+obj.l;s+=lang+' target: '+obj.t;}
return s;};for(i=1;i<arr.length;i++){dx_idx=i-1;obj=arr[i];var el;var ident=obj.i;var freq=obj.f;var flags=obj.fl;if(eibi){if(ident==dx.last_ident&&freq==dx.last_freq){console_log_lbl('2222 dx_idx='+dx_idx+' last_dx_idx='+dx.last_dx_idx+' '+obj.f+' SAME AS LAST '+ident);el=w3_el('id-dx-label_'+dx.last_dx_idx);el.title+='\n'+dx_title(obj);continue;}}
dx.last_dx_idx=dx_idx;dx.last_freq=freq;dx.last_ident=ident;if(eibi)console_log_lbl('2222 dx_idx='+dx_idx+' '+obj.f+' OK '+ident);var notes=(isDefined(obj.n))?obj.n:'';el=w3_el('id-dx-label_'+dx_idx);if(!el)continue;var _ident=kiwi_decodeURIComponent('dx_ident2',ident).trim();if(_ident=='')_ident='&nbsp;&nbsp;';el.innerHTML=_ident.replace(/\\n/g,'<br>');var idx=dx_type2idx(obj.fl&dx.DX_TYPE);if(eibi){el.title=dx.eibi_svc_s[idx]+' // home country: '+obj.c+'\n'+dx_title(obj);}else{var title=kiwi_decodeURIComponent('dx_notes',notes);title=title.replace(/<br>/g,'\n');title=title.replace(/\\n/g,'\n');var dow=obj.fl&dx.DX_DOW;if(dow!=dx.DX_DOW||(obj.b!=0||!(obj.b==0&&obj.e==2400)))
title=w3_nl(title)+dx_title(obj);el.title=title;}
if(dx_idx<dx.post_render.length){var sparse=dx.post_render[dx_idx];if(sparse){var top=sparse.top;var left=sparse.x-10;el.style.top=px(top);el.style.left=px(left);if(isDefined(sparse.z))el.style.zIndex=sparse.z;var el_line=w3_el('id-dx-line_'+dx_idx);top=sparse.ltop;el_line.style.top=px(top);el_line.style.height=px(dx_container_h-top);}}
if(dx_idx<dx.color_fixup.length){var sparse=dx.color_fixup[dx_idx];if(sparse){el.style.backgroundColor=sparse;}}
if(!eibi&&(ident=='IBP'||ident=='IARU%2fNCDXF')){var off=dx_ibp_freqs[Math.trunc(freq / 1000)];dx_ibp_list.push({idx:dx_idx,off:off});kiwi_clearInterval(dx_ibp_interval);dx_ibp_interval=setInterval(function(){var d=new Date(dx_ibp_server_time_ms+(Date.now()-dx_ibp_local_time_epoch_ms));var min=d.getMinutes();var sec=d.getSeconds();var rsec=sec%10;if((rsec==0)&&dx_ibp_lastsec==9){var slot=(min%3)*6+Math.trunc(sec/10);for(var i=0;i<dx_ibp_list.length;i++){var s=slot-dx_ibp_list[i].off;if(s<0)s=18+s;el=w3_el('id-dx-label_'+dx_ibp_list[i].idx);var call,location;w3_obj_enum(dx_ibp_stations,function(key,i,o){if(i==s){call=key;location=o.text;}});if(el)el.innerHTML='IBP: '+call+' '+location;}}
dx_ibp_lastsec=rsec;},500);}}}
function dx_filter(shift_plus_ctl_alt){if(shift_plus_ctl_alt==true){dx_filter_opt_cb('dx.filter_case',0);dx_filter_opt_cb('dx.filter_grep',0);dx.filter_ident=dx.filter_notes='';dx_filter_cb(null,null,false,true);return;}
var s=w3_div('w3-medium w3-text-aqua w3-bold','DX label filter')+
w3_divs('w3-text-aqua',w3_col_percent('',w3_divs('/w3-margin-T-8',w3_input('w3-label-inline/id-dx-filter-ident w3-retain-input-focus w3-input-any-change w3-padding-small','Ident','dx.filter_ident',dx.filter_ident,'dx_filter_cb'),w3_input('w3-label-inline/id-dx-filter-notes w3-retain-input-focus w3-input-any-change w3-padding-small','Notes','dx.filter_notes',dx.filter_notes,'dx_filter_cb')),90),w3_inline('w3-halign-space-around w3-margin-T-8 w3-text-white/',w3_checkbox('w3-retain-input-focus w3-label-inline w3-label-not-bold','case sensitive','dx.filter_case',dx.filter_case,'dx_filter_opt_cb'),w3_inline('',w3_text('','pattern match:'),w3_checkbox('w3-margin-left w3-retain-input-focus w3-label-inline w3-label-not-bold','grep','dx.filter_grep',dx.filter_grep,'dx_filter_opt_cb'))));confirmation_show_content(s,450,140,dx_filter_panel_close);w3_field_select('id-dx-filter-ident',{mobile:1});}
function dx_filter_panel_close(){var ae=document.activeElement;if(ae&&ae.id&&(ae.id.startsWith('id-dx-filter')||ae.id.startsWith('id-dx.filter'))){ae.blur();}
confirmation_panel_close();}
function dx_filter_cb(path,val,first,no_close){if(first)return;if(path)w3_string_cb(path,val);var filtered=(dx.filter_ident!=''||dx.filter_notes!='');wf_send('SET DX_FILTER i='+encodeURIComponent(dx.filter_ident+'x')+' n='+encodeURIComponent(dx.filter_notes+'x')+' c='+dx.filter_case+' w='+dx.filter_wild+' g='+dx.filter_grep);w3_remove_then_add('id-dx-container','whiteSmoke cl-dx-filtered',filtered?'cl-dx-filtered':'whiteSmoke');if(!filtered&&!no_close)dx_filter_panel_close();}
function dx_filter_opt_cb(path,val,first){if(first)return;val=+val;w3_bool_cb(path,val);dx_filter_cb('dx.filter_ident',dx.filter_ident,false,true);console.log('dx_filter_opt_cb path='+path+' val='+val);w3_checkbox_set(path,val);if(val&&path!='dx.filter_case'){dx_filter_opt_cb((path=='dx.filter_wild')?'dx.filter_grep':'dx.filter_wild',0);}
w3_field_select('id-dx-filter-ident',{mobile:1});}
function dx_filter_field_err(err){w3_set_props('id-dx-filter-ident','w3-pink',err&1);w3_set_props('id-dx-filter-notes','w3-pink',err&2);}
function dx_label_step(dir){var i,dl;var eibi=(dx.db==dx.DB_EiBi);var f_pbc_Hz=freq_passband_center();if(dir==1){for(i=0;i<dx.displayed.length;i++){dl=dx.displayed[i];if(!dl)continue;var f=Math.round(dl.f_label);var same_gid=(dl.gid==dx.last_stepped_gid);var f_ok=(f>f_pbc_Hz);if(same_gid)continue;if(f_ok)break;}
if(i==dx.displayed.length){wf_send('SET MARKER db='+dx.db+' dir=1 freq='+(freq_displayed_Hz/1e3).toFixed(3)
+' eibi_types_mask='+dx.eibi_types_mask.toHex()
+' filter_tod='+dx.filter_tod[dx.db]);if(dx.step_dbg)console.log('>>> STEP DX_STEP [[[REQ]]]');dx.last_stepped_gid=-1;return;}}else{for(i=dx.displayed.length-1;i>=0;i--){dl=dx.displayed[i];if(!dl)continue;var f=Math.round(dl.f_label);var same_gid=(dl.gid==dx.last_stepped_gid);var f_ok=(f<f_pbc_Hz);if(same_gid)continue;if(f_ok)break;}
if(i<0){wf_send('SET MARKER db='+dx.db+' dir=-1 freq='+(freq_displayed_Hz/1e3).toFixed(3)
+' eibi_types_mask='+dx.eibi_types_mask.toHex()
+' filter_tod='+dx.filter_tod[dx.db]);if(dx.step_dbg)console.log('<<< STEP DX_STEP [[[REQ]]]');dx.last_stepped_gid=-1;return;}}
var mode_s=kiwi.modes_lc[dx_decode_mode(dl.flags)];if(dx.step_dbg)console.log('STEP FOUND #'+i+' f='+(f/1e3).toFixed(2)+' f_pbc_Hz='+(f_pbc_Hz/1e3).toFixed(2)+' dl.freq='+dl.freq+' '+dl.ident+' '+mode_s+' '+dl.lo+' '+dl.hi);freqmode_set_dsp_kHz(dl.freq,mode_s);if(dl.lo!=0&&dl.hi!=0){ext_set_passband(dl.lo,dl.hi);}else{var dpb=kiwi_passbands(mode_s);ext_set_passband(dpb.lo,dpb.hi);}
if(dx.step_dbg)console.log('STEP RENDER dx_sig_bw() gid='+dl.gid);dx_sig_bw(dl.gid);dx.last_stepped_gid=dl.gid;}
function dx_check_corrupt(){if(dx.dxcfg_parse_error){var el=w3_el('id-dxcfg-err');w3_innerHTML(el,'Warning: corrupt dx_config.json file');w3_add(el,'w3-text-css-orange');}
if(dx.dxcomm_cfg_parse_error){var el=w3_el('id-dxcomm-cfg-err');w3_innerHTML(el,'Warning: corrupt dx_community_config.json file');w3_remove(el,'w3-text-css-yellow');w3_add(el,'w3-text-css-orange');}}
function dx_admin_pwd_cb(path,val){w3_string_cb(path,val);ext_valpwd('admin',val,ws_wf);}
function dx_show_edit_panel(ev,gid,from_shortcut){dx.keys=ev?{shift:ev.shiftKey,alt:ev.altKey,ctrl:ev.ctrlKey,meta:ev.metaKey}:{shift:0,alt:0,ctrl:0,meta:0};dx.o.gid=gid;if(dx.db==dx.DB_STORED){ext_hasCredential('admin',function(badp){if(badp!=kiwi.BADP_OK){extint_panel_hide();var s=w3_inline('',w3_div('w3-medium w3-text-aqua w3-bold','DX labels'),w3_select('w3-margin-L-32/w3-label-inline w3-text-white /w3-text-red','database:','','dx.db',dx.db,dx.db_s,'dx_database_cb',0))+
w3_div('w3-margin-T-16',w3_checkbox('/w3-label-inline w3-label-not-bold w3-text-white/','filter by time/day-of-week',dx.DB_STORED.toString()+'-filter-tod',dx.filter_tod[dx.DB_STORED],'dx_time_dow_cb'),w3_text('id-dxcfg-err w3-block'))+
w3_div('w3-margin-T-16',w3_input('//w3-margin-T-8 w3-padding-small|width:80%','Admin password','dx.pwd','','dx_admin_pwd_cb'),w3_text('w3-margin-T-4','editing the stored DX labels of this Kiwi requires admin privileges'));ext_panel_set_name('dx');ext_panel_show(s,null,null,null,true);ext_set_controls_width_height(550,290);if(from_shortcut!=true)
w3_field_select('id-dx.pwd',{mobile:1});dx_check_corrupt();}else{dx_show_edit_panel2();}},null,ws_wf);}else{dx_show_edit_panel2();}}
function dx_show_edit_panel2(){dx_color_init();if(dx.db!=dx.DB_COMMUNITY){var gid=dx.o.gid;var mode=isArg(cur_mode)?cur_mode:'am';var freq_kHz_str=isArg(freq_displayed_kHz_str)?freq_displayed_kHz_str:'10000';if(gid==-1){console.log('DX EDIT new f='+freq_car_Hz+'|'+freq_displayed_Hz+'|'+freq_kHz_str+' m='+mode);dx.o.fr=+(freq_kHz_str)+kiwi.freq_offset_kHz;dx.o.lo=dx.o.hi=dx.o.o=dx.o.s=0;dx.o.fm=kiwi.modes_idx[mode];dx.o.ft=dx.DX_QUICK_0;dx.o.fd=dx.DX_DOW_BASE;dx.o.begin=0;dx.o.end=0;dx.o.i=dx.o.n=dx.o.p='';}else{var label=dx.list[gid];console.log('DX EDIT entry #'+gid+' prev: f='+label.freq+'|'+label.carrier.toFixed(2)+' flags='+label.flags.toHex()+' i='+label.ident+' n='+label.notes);dx.o.fr=label.carrier.toFixed(2);dx.o.lo=label.lo;dx.o.hi=label.hi;dx.o.o=label.mkr_off;dx.o.s=label.sig_bw;dx.o.fm=dx_decode_mode(label.flags);dx.o.ft=((label.flags&dx.DX_TYPE)>>dx.DX_TYPE_SFT);dx.o.fd=((label.flags&dx.DX_DOW)>>dx.DX_DOW_SFT);if(dx.o.fd==0){dx.o.fd=dx.DX_DOW_BASE;kiwi_trace('$SHOULD NOT OCCUR');}
dx.o.begin=label.begin;dx.o.end=label.end;dx.o.i=kiwi_decodeURIComponent('dx_ident',label.ident);dx.o.n=kiwi_decodeURIComponent('dx_notes',label.notes);dx.o.p=kiwi_decodeURIComponent('dx_params',label.params);}
dx.o.mm=w3_array_el_seq(kiwi.mode_menu,kiwi.modes_uc[dx.o.fm]);if(dx.db==dx.DB_STORED&&gid!=-1&&dx.keys.shift&&dx.keys.alt){var type=dx.o.ft;type=(type==dx.DX_QUICK_0)?dx.DX_QUICK_1:dx.DX_QUICK_0;dx.o.ft=type;var flags=(dx.o.fd<<dx.DX_DOW_SFT)|(type<<dx.DX_TYPE_SFT)|dx_encode_mode(dx.o.fm);dx_send_update('DX_QUICK',dx.o.gid,dx.o.fr,flags,dx.o);return;}
dx.o.fr=(parseFloat(dx.o.fr)).toFixed(2);dx.o.pb='';if(dx.o.lo||dx.o.hi){if(dx.o.lo==-dx.o.hi){dx.o.pb=(Math.abs(dx.o.hi)*2).toFixed(0);}else{dx.o.pb=dx.o.lo.toFixed(0)+', '+dx.o.hi.toFixed(0);}}}
extint_panel_hide();var s1=w3_inline('',w3_div('w3-medium w3-text-aqua w3-bold','DX labels'),w3_select('w3-margin-L-32/w3-label-inline w3-text-white /w3-text-red','database:','','dx.db',dx.db,dx.db_s,'dx_database_cb',0));var s2;if(dx.db==dx.DB_STORED){var dow_s='';var dow=dx.o.fd;if(dow==0)dow=dx.o.fd=dx.DX_DOW_BASE;console.log('DX g='+gid+' dow='+dow+'|'+dow.toHex(2)+' f='+(+dx.o.fr).toFixed(2)+' b='+dx.o.begin+' e='+dx.o.end+' '+dx.o.i);for(var i=0;i<7;i++){var day=dow&(1<<(6-i));var fg=day?'black':'white';var bg=day?dx.dow_colors[i]:'darkGrey';dow_s+=w3_button('w3-dummy//w3-round w3-padding-tiny'+
(i?' w3-margin-L-4':'')+'|color:'+fg+'; background:'+bg,'MTWTFSS'[i],'dx_dow_button',i);}
dow_s=w3_inline('',dow_s);var begin_s,end_s;var begin=+(dx.o.begin),end=+(dx.o.end);if(begin==0&&(end==0||end==2400)){begin_s=end_s='';}else{begin_s=begin.toFixed(0).leadingZeros(4);end_s=end.toFixed(0).leadingZeros(4);}
var type_menu=kiwi_deep_copy(dxcfg.dx_type);if(dx.types_n){for(i=0;i<dx.DX_N_STORED;i++){if(dx.types_n[i]!=0&&type_menu[i].name==''){type_menu[i].name='(T'+i+')';}}}
s2=w3_divs('w3-text-white/w3-margin-T-8',w3_inline('w3-halign-space-between/',w3_input('w3-padding-small||size=10','Freq','dx.o.fr',dx.o.fr,'dx_freq_cb'),w3_select('w3-text-red','Mode','','dx.o.mm',dx.o.mm,kiwi.mode_menu,'dx_sel_cb'),w3_input('w3-padding-small||size=10','Passband','dx.o.pb',dx.o.pb,'dx_passband_cb'),w3_select('w3-text-red','Type','','dx.o.ft',dx.o.ft,type_menu,'dx_sel_cb'),w3_input('w3-padding-small||size=8','Offset','dx.o.o',dx.o.o,'dx_num_cb')),w3_input('w3-label-inline/w3-padding-small','Ident','dx.o.i','','dx_string_cb'),w3_input('w3-label-inline/w3-padding-small','Notes','dx.o.n','','dx_string_cb'),w3_inline('w3-halign-space-between/',w3_input('w3-label-inline/w3-padding-small||size=40','Extension','dx.o.p','','dx_string_cb'),w3_input('/w3-flex-noshrink w3-label-inline/w3-padding-small||size=5','Sig bw','dx.o.s',dx.o.s,'dx_num_cb')),w3_inline('w3-hspace-16',w3_text('w3-text-white w3-bold','Schedule (UTC)'),dow_s,w3_input('w3-label-inline/w3-padding-small','Begin','dx.o.begin',begin_s,'dx_sched_time_cb'),w3_input('w3-label-inline/w3-padding-small','End','dx.o.end',end_s,'dx_sched_time_cb')),w3_inline('w3-hspace-16',w3_button('id-dx-modify w3-yellow','Modify','dx_modify_cb'),w3_button('id-dx-add w3-green','Add','dx_add_cb'),w3_button('w3-red','Delete','dx_delete_cb'),w3_div('w3-margin-T-4',w3_checkbox('/w3-label-inline w3-label-not-bold w3-text-white/','filter by time/day-of-week',dx.DB_STORED.toString()+'-filter-tod',dx.filter_tod[dx.DB_STORED],'dx_time_dow_cb'),w3_text('id-dxcfg-err w3-margin-T-4','Create new label with Add button'))));}else
if(dx.db==dx.DB_EiBi){var cbox_container='w3-halign-space-around/|flex-basis:130px';var cbox='/w3-label-inline w3-label-not-bold w3-round w3-padding-small/';var checkbox=function(type){var idx=dx_type2idx(type);var svc=(dx.eibi_types_mask&(1<<idx))?1:0;return w3_checkbox(cbox,dx.eibi_svc_s[idx],'eibi-cbox'+idx,svc,'dx_eibi_svc_cb',idx);};s2=w3_inline('',w3_checkbox('w3-margin-TB-16/w3-label-inline w3-label-not-bold w3-text-white/w3-hspace-32','select all','eibi-all',dx.eibi_types_mask==0xffffffff,'dx_eibi_all_cb'),w3_checkbox('/w3-label-inline w3-label-not-bold w3-text-white/w3-margin-L-32','filter by time/day-of-week',dx.DB_EiBi.toString()+'-filter-tod',dx.filter_tod[dx.DB_EiBi],'dx_time_dow_cb'))+
w3_div('w3-valign-col w3-round w3-padding-TB-10 w3-gap-10|background:whiteSmoke',w3_inline(cbox_container,checkbox(dx.DX_BCAST),checkbox(dx.DX_UTIL),checkbox(dx.DX_TIME)),w3_inline(cbox_container,checkbox(dx.DX_ALE),checkbox(dx.DX_HFDL),checkbox(dx.DX_MILCOM)),w3_inline(cbox_container,checkbox(dx.DX_CW),checkbox(dx.DX_FSK),checkbox(dx.DX_FAX)),w3_inline(cbox_container,checkbox(dx.DX_AERO),checkbox(dx.DX_MARINE),checkbox(dx.DX_SPY)));}else{var cbox_container='w3-margin-L-32 w3-halign-space-around/|flex-basis:130px';var cbox='w3-round w3-padding-small';var label=function(idx){var dx_type=dxcomm_cfg.dx_type[idx];return w3_label(cbox,dx_type.name,'dxcomm'+idx);};s2=w3_checkbox('w3-margin-T-8/w3-label-inline w3-label-not-bold w3-text-white/','filter by time/day-of-week',dx.DB_COMMUNITY.toString()+'-filter-tod',dx.filter_tod[dx.DB_COMMUNITY],'dx_time_dow_cb')+
w3_text('id-dxcomm-cfg-err w3-margin-T-4 w3-margin-B-12 w3-text-css-yellow','The community database is read-only and downloaded periodically. <br>'+dx.last_community_download);if(!dx.dxcomm_cfg_parse_error)
s2+=w3_div('w3-valign-col w3-round w3-padding-TB-15 w3-gap-15|background:whiteSmoke',w3_inline(cbox_container,label(dx.T3_BCAST),label(dx.T4_UTIL),label(dx.T5_TIME)),w3_inline(cbox_container,label(dx.T6_ALE),label(dx.T7_HFDL),label(dx.T8_MILCOM)),w3_inline(cbox_container,label(dx.T9_CW),label(dx.T10_FSK),label(dx.T11_FAX)),w3_inline(cbox_container,label(dx.T12_AERO),label(dx.T13_MARINE),label(dx.T14_SPY)),w3_inline(cbox_container,label(dx.T2_HAM),label(dx.T1_CHANNEL),label(dx.T0_RESERVED)));}
ext_panel_set_name('dx');ext_panel_show(s1+s2,null,function(){if(dx.db==dx.DB_STORED){var el=w3_el('dx.o.i');el.value=dx.o.i;w3_el('dx.o.n').value=dx.o.n;w3_el('dx.o.p').value=dx.o.p;}else
if(dx.db==dx.DB_EiBi){for(var i=0;i<dx.DX_N_EiBi;i++){w3_color('eibi-cbox'+i+'-label','black',dx.eibi_colors[i]);}}else{for(var i=0;i<=dx.DX_N_COMM;i++){w3_color('id-dxcomm'+i+'-label','black',dx.stored_colors_light[i]);}}
if(dx.help){setTimeout(function(){extint_help_click_now();},1000);dx.help=false;}},function(){},true);ext_set_controls_width_height(550,290);dx_check_corrupt();}
function dx_database_cb(path,idx,first,opt,from_shortcut){if(first)return;dx.list=[];console_log_dbgUs('DX DB-SWITCHED db='+idx+'|'+dx.db+' opt='+kiwi_JSON(opt)+' from_shortcut='+from_shortcut);if(w3_opt(opt,'toggle')){dx.filter_tod[dx.db]^=1;dx_time_dow_cb(dx.db.toString()+'-filter-tod',dx.filter_tod[dx.db]);}else{dx.db=+idx;var called_from_menu=(opt=='0');if(w3_opt(opt,'open')){dx_show_edit_panel(null,-1,from_shortcut);}else{if(!called_from_menu&&ext_panel_displayed('dx')){dx_close_edit_panel();}
if(called_from_menu){dx_show_edit_panel(null,-1,from_shortcut);}}}
kiwi_storeSet('last_db',dx.db);bands_init();mkscale();mk_band_menu();dx_schedule_update();}
function dx_eibi_all_cb(path,checked,first){if(first)return;var v=checked?1:0;for(var i=0;i<dx.DX_N_EiBi;i++)
dx_eibi_svc_cb('eibi-cbox'+i,v,false,i);}
function dx_time_dow_cb(path,checked,first){if(first)return;var db=parseInt(path);dx.filter_tod[db]=checked?1:0;w3_checkbox_set(path,checked);dx_schedule_update();}
function dx_eibi_svc_cb(path,checked,first,cbp){if(first)return;var idx=+cbp;var v=checked?1:0;w3_checkbox_set(path,checked);if(v)
dx.eibi_types_mask|=1<<idx;else
dx.eibi_types_mask&=~(1<<idx);dx_schedule_update();}
function dx_close_edit_panel(id){if(id)w3_radio_unhighlight(id);extint_panel_hide();}
function dx_send_update(from,gid,fr,flags,dx_o){dx.retry=isNull(dx_o)?{}:kiwi_deep_copy(dx_o);dx.retry.gid=gid;dx.retry.fr=fr;dx.retry.flags=flags;if(gid!=-1&&fr==-1){wf_send('SET DX_UPD g='+gid+' f=-1');}else{wf_send('SET DX_UPD g='+gid+' f='+fr+' lo='+dx_o.lo.toFixed(0)+' hi='+dx_o.hi.toFixed(0)+' o='+dx_o.o.toFixed(0)+' s='+dx_o.s.toFixed(0)+' fl='+flags+' b='+dx_o.begin+' e='+dx_o.end+' i='+encodeURIComponent(dx_o.i+'x')+' n='+encodeURIComponent(dx_o.n+'x')+' p='+encodeURIComponent(dx_o.p+'x'));}}
function dx_send_update_retry(){dx_send_update('dx_send_update_retry',dx.retry.gid,dx.retry.fr,dx.retry.flags,dx.retry);}
function dx_button_highlight(){var el=w3_el((dx.o.gid==-1)?'id-dx-add':'id-dx-modify');el.style.border='5px double red';}
function dx_modify_cb(id,val){console_log_dbgUs('DX COMMIT modify entry #'+dx.o.gid+' f='+dx.o.fr);console_log_dbgUs(dx.o);if(dx.o.gid==-1)return;var flags=(dx.o.fd<<dx.DX_DOW_SFT)|(dx.o.ft<<dx.DX_TYPE_SFT)|dx_encode_mode(dx.o.fm);if(dx.o.fr<0)dx.o.fr=0;dx_send_update('DX_MODIFY',dx.o.gid,dx.o.fr,flags,dx.o);var el=w3_el('id-dx-modify');setTimeout(function(){dx_close_edit_panel(id);el.style.border='';},250);}
function dx_add_cb(id,val){var flags=(dx.o.fd<<dx.DX_DOW_SFT)|(dx.o.ft<<dx.DX_TYPE_SFT)|dx_encode_mode(dx.o.fm);if(dx.o.fr<0)dx.o.fr=0;dx_send_update('DX_ADD',-1,dx.o.fr,flags,dx.o);setTimeout(function(){dx_close_edit_panel(id);},250);owrx.dx_click_gid_last_until_tune=owrx.dx_click_gid_last_stored=undefined;dx_show(false,-1);}
function dx_delete_cb(id,val){if(dx.o.gid==-1)return;dx_send_update('DX_DELETE',dx.o.gid,-1,0,null);setTimeout(function(){dx_close_edit_panel(id);},250);owrx.dx_click_gid_last_until_tune=owrx.dx_click_gid_last_stored=undefined;dx_show(false,-1);}
function dx_evt(path,cb_param,first,evt){var p=cb_param.split(',');var gid=p[0];var cmkr_x=p[1];var rv=true;switch(evt.type){case'mouseenter':rv=dx_enter(evt,cmkr_x);break;case'mouseleave':rv=dx_leave(evt,cmkr_x);break;case'click':case'hold':case'touchend':rv=dx_click(evt,gid);break;default:rv=ignore(evt);break;}
return rv;}
function dx_sig_bw(gid){var label=(gid>=0)?dx.list[gid]:null;if(label&&isArg(label.sig_bw)&&label.sig_bw!=0){var el=w3_el('id-dx-sig');if(!el){dx.sig_bw_render_gid=gid;if(dx.step_dbg)console.log('$dx_sig_bw OFF SCREEN sig_bw_render_gid='+gid);return;}
var hbw=label.sig_bw/2;var f_base=label.freq-kiwi.freq_offset_kHz;var f_baseHz=f_base*1000;var xl=scale_px_from_freq((f_base-hbw)*1000,g_range);var xr=scale_px_from_freq((f_base+hbw)*1000,g_range);var mkr_Hz=f_baseHz+passband_offset_dxlabel(kiwi.modes_lc[dx_decode_mode(label.flags)],label.params,label.lo,label.hi);el.style.left=px(xl);el.style.width=px(xr-xl);el.style.background=label.color;if(label.mkr_off!=0)return;dx_canvas.style.left=px(scale_px_from_freq(mkr_Hz,g_range)-dx_car_w/2);dx_show(true);if(dx.step_dbg)console.log('$dx_sig_bw SHOW gid='+gid);dx.sig_bw_render_gid=gid;}else{if(dx.step_dbg)console.log('$dx_sig_bw OFF');dx_show(false);dx.sig_bw_render_gid=-1;}}
function dx_click(ev,gid){var hold=(ev.type=='hold');if(!hold&&ev.shiftKey&&dx.db==dx.DB_STORED){dx_show_edit_panel(ev,gid);}else{w3_menu_close('dx_click');dx_sig_bw(gid);if(ev.target.nodeName=='A'){console.log('dx_click: link within label');dx.ctrl_click=false;return ev;}
owrx.dx_click_gid_last_stored=(dx.db==dx.DB_STORED)?gid:undefined;owrx.dx_click_gid_last_until_tune=gid;var label=dx.list[gid];var freq=label.freq;var f_base=freq-kiwi.freq_offset_kHz;var mode=kiwi.modes_lc[dx_decode_mode(label.flags)];var lo=label.lo;var hi=label.hi;var params=label.params;extint.extname=extint.param=null;if(isArg(params)){params=decodeURIComponent(params);var ext=(params=='')?[]:params.split(',');if(mode=='drm'){extint.extname='drm';ext.push('lo:'+lo);ext.push('hi:'+hi);}else{extint.extname=ext[0];ext=ext.slice(1);}
if(ext[0]=='*')ext[0]=freq.toFixedNZ(2);extint.param=ext.join(',');}
var extname=extint.extname?extint.extname:'';if(dx.db==dx.DB_EiBi){}
extint.mode_prior_to_dx_click=cur_mode;freqmode_set_dsp_kHz(f_base,mode,{open_ext:true,no_clear_last_gid:1});if(lo||hi){ext_set_passband(lo,hi,false,f_base);}
var check_ext;if(kiwi_isMobile()){check_ext=hold;}else{check_ext=(!hold&&!any_alternate_click_event(ev));}
if(mode!='drm'&&check_ext&&!dx.ctrl_click&&params){console_log_dbgUs('dx_click ext='+extint.extname+' <'+extint.param+'>');{extint_open(extint.extname,250);}}
dx.ctrl_click=false;}
return cancelEvent(ev);}
function dx_enter(ev,cmkr_x){var tgt=ev.target;dx.z_save=tgt.style.zIndex;tgt.style.zIndex=999;dx.bg_color_save=tgt.style.backgroundColor;tgt.style.backgroundColor=w3_contains(tgt,'cl-dx-label-filtered')?'lightGrey':(w3_contains(tgt,'dx-has-ext')?'magenta':'yellow');var dx_line=w3_el('id-dx-line_'+tgt.id.parseIntEnd());dx_line.zIndex=998;dx_line.style.width='3px';if(+cmkr_x){dx_canvas.style.left=px(cmkr_x-dx_car_w/2);w3_visible(dx_canvas,true);}}
function dx_leave(ev,cmkr_x){var tgt=ev.target;tgt.style.zIndex=dx.z_save;tgt.style.backgroundColor=dx.bg_color_save;var dx_line=w3_el('id-dx-line_'+tgt.id.parseIntEnd());dx_line.zIndex=110;dx_line.style.width='1px';if(+cmkr_x){dx_canvas.style.visibility=dx.sig_bw_vis;dx_canvas.style.left=dx.sig_bw_left;}}
function dx_help(show){if(show){var s=w3_text('w3-medium w3-bold w3-text-aqua','DX label help')+
w3_div('w3-margin-T-8 w3-scroll-y|height:90%',w3_div('w3-margin-R-8','There are three types of DX labels seen in the area above the frequency scale: <br>'+'1) Labels from a stored database, editable by the Kiwi owner/admin. <br>'+'2) Labels from a read-only copy of the <a href="http://www.eibispace.de" target="_blank">EiBi database</a> that cannot be modified. <br>'+'3) Labels from a downloaded, read-only, community database aggregated from contributions made on the Kiwi forum. <br>'+'<br>'+'The DX label control panel has a <i>database</i> menu to select between these three. '+'Similarly, there are selection entries in the right-click menu (double-finger tap on mobile devices). '+'The keyboard shortcut keys "\\" and "|" also switch between the databases with the later also opening the control panel.'+'<br><br>'+'When zoomed out the number of labels shown is limited to prevent overwhelming the display. '+'This is why some labels will only appear as you zoom in. The same is true if too many EiBi categories '+'are selected enabling a large number of labels.'+'<br><br>'+'Information about using the controls for editing the stored labels can be found '+'<a href="http://kiwisdr.com/quickstart/index.html#id-user-marker" target="_blank">here</a>.'+'<br><br>'+'Because there are so many EiBi labels (about 6000) they are organized into 12 categories with visibility '+'selected by checkboxes on the control panel.'+'<br><br>'+'Labels from any of the databases can be filtered by their schedule (UTC time & day-of-week) '+'specified in the database. If filtering is disabled labels outside their scheduled time appear with a lighter category color and a dashed border. '+'When filtering is enabled the label display will refresh every 5 minutes so it reflects the current schedule.'+'<br><br>'+'When a label is moused-over a popup is shown with additional information. '+'On Safari and Chrome the popups take a few seconds to appear. EiBi information includes the station\'s home country, transmission schedule, '+'language and target area (if any). '+'Information about the EiBi database, including descriptions of the language and target codes seen in the mouse-over popups, '+'<a href="http://kiwisdr.com/files/EiBi/README.txt" target="_blank">can be found here.</a>'+'<br><br>'+'Labels that have an extension specified have a black bar on the right part of the label. <br>'+'This is for consistency between the desktop and mobile interfaces. <br>'+'Other behavior is device specific: <br><br>'+'Desktop:'+'<ul>'+'<li>Extension labels are magenta when moused-over as opposed to the usual yellow.</li>'+'<li>Labels outside their scheduled time (if any) will mouse-over grey.</li>'+'<li>Clicking the label sets the freq/mode and opens the extension.</li>'+'<li>For the stored database shift-clicking opens the DX labels panel (admin only).</li>'+'<li>PC</li><ul>'+'<li>Alt-click sets the freq/mode without openning the extension.</li>'+'<li>Shift-alt-click to toggle the label active (admin only).</li>'+'</ul>'+'<li>Mac</li><ul>'+'<li>Alt/option-click sets the freq/mode without openning the extension.</li>'+'<li>Shift-alt/option-click to toggle the label active (admin only).</li>'+'<li>On Mac the control key can be used in place of alt/option.</li>'+'</ul>'+'</ul>'+'Mobile:'+'<ul>'+'<li>Touching a label sets the freq/mode.</li>'+'<li>Touch-hold a label to set freq/mode and open the extension.</li>'+'<li>After touching a label use the right-click menu to open edit panel for that label.</li>'+'</ul>'+'For stored labels the extension is set per-label in the DX labels panel and the extension opened when the label is clicked. '+'For EiBi labels an extension is automatically assumed for many of the categories, '+'but is only opened if the label is shift-clicked (note difference from stored label behavior, '+'a non-shift click simply selects the frequency/mode).'+'<br><br>'+'URL parameters: (use "dx=<i>comma separated parameters</i>" in the browser URL)<br>'+'Select database: '+w3_text('|color:orange','[012] <i>or</i> stored eibi community')+'<br>'+'All: '+w3_text('|color:orange','open filter[:0] <br>')+'<br> EiBi: '+w3_text('|color:orange','none bcast utility time ale hfdl milcom cw fsk fax aero marine spy <br>')+'<br>'+'An optional first digit specifies the database to display (EiBi "1" is the default). Or use the database name. '+'Specify <i>open</i> to also open the DX labels panel. '+'For EiBi: By default all the category checkboxes and "<i>filter by time/day-of-week</i>" are checked. '+'Specifying <i>none</i> will uncheck all the categories. Specifying the individual category names will then toggle the checkbox state.'+'<br><br>'+'For example, to select only the EiBi ALE and FAX categories: <i>dx=none,ale,fax</i> <br>'+'To select all except the CW and Time categories: <i>dx=cw,time</i> <br>'+'To just select the EiBi database: <i>dx</i> (e.g. <i>my_kiwi:8073/?dx</i>)<br>'+'To also bring up the EiBi control panel: <i>dx=op</i> (e.g. <i>my_kiwi:8073/?dx=op</i>)<br>'+'Keywords are case-insensitive and can be abbreviated. For example: <br>'+'<i>dx=n,bc,f:0</i> (show only broadcast stations without time/day filtering) <br>'+'To select the stored label database: <i>dx=0</i> or <i>dx=sto</i><br>'+''));confirmation_show_content(s,650,375);w3_el('id-confirmation-container').style.height='100%';}
return true;}
var smeter_width;var SMETER_RHS=38;var SMETER_SCALE_HEIGHT=29;var SMETER_BIAS=127;var SMETER_INPUT_MAX=3.4;var SMETER_INPUT_RANGE=(SMETER_BIAS+SMETER_INPUT_MAX);var SMETER_DISPLAY_MAX=-6;var SMETER_DISPLAY_RANGE=(SMETER_BIAS+SMETER_DISPLAY_MAX);var sMeter_ctx;var bars={dBm:[-121,-109,-97,-85,-73,-63,-53,-33,-13],text:['S1','S3','S5','S7','S9','+10','+20','+40','+60']};function smeter_dBm_biased_to_x(dBm_biased){if(dBm_biased>SMETER_DISPLAY_RANGE)
dBm_biased=SMETER_DISPLAY_RANGE;return Math.round(dBm_biased / SMETER_DISPLAY_RANGE*smeter_width);}
function smeter_init(force_no_agc_thresh_smeter){owrx.force_no_agc_thresh_smeter=force_no_agc_thresh_smeter;var smeter_control=w3_el('id-control-smeter');if(!smeter_control)return;w3_innerHTML(smeter_control,'<canvas id="id-smeter-scale" class="class-smeter-scale" width="0" height="0"></canvas>',w3_div('id-smeter-dbm-value'),w3_div('id-smeter-dbm-units','dBm'),w3_div('id-smeter-ovfl w3-hide','OV'),w3_div('id-smeter-attn w3-hide','Attn'));var sMeter_canvas=w3_el('id-smeter-scale');var width=divControl?divControl.activeWidth:350;var canvas_LR_border_pad=html_LR_border_pad(sMeter_canvas);smeter_width=width-SMETER_RHS-canvas_LR_border_pad;var w=smeter_width,h=SMETER_SCALE_HEIGHT,y=h-8;var tw=w+SMETER_RHS;smeter_control.style.width=px(tw+canvas_LR_border_pad);sMeter_ctx=sMeter_canvas.getContext("2d");sMeter_ctx.canvas.width=tw;sMeter_ctx.canvas.height=h;sMeter_ctx.fillStyle="gray";sMeter_ctx.globalAlpha=1;sMeter_ctx.fillRect(0,0,tw,h);sMeter_ctx.font="11px Verdana";sMeter_ctx.textBaseline="middle";sMeter_ctx.textAlign="center";sMeter_ctx.fillStyle="white";for(var i=0;i<bars.text.length;i++){var x=smeter_dBm_biased_to_x(bars.dBm[i]+SMETER_BIAS);line_stroke(sMeter_ctx,1,3,"white",x,y-8,x,y+8);sMeter_ctx.fillText(bars.text[i],x,y-15);}
line_stroke(sMeter_ctx,0,5,"black",0,y,w,y);kiwi_clearInterval(owrx.smeter_interval);owrx.smeter_interval=setInterval(update_smeter,100);}
var sm_px=0,sm_timeout=0,sm_interval=10;var sm_ovfl_showing=false;var sm_timer=0;function update_smeter(){var x=smeter_dBm_biased_to_x(owrx.sMeter_dBm_biased);var y=SMETER_SCALE_HEIGHT-8;var w=smeter_width;sMeter_ctx.globalAlpha=1;line_stroke(sMeter_ctx,0,5,"lime",0,y,x,y);if(cfg.agc_thresh_smeter&&owrx.force_no_agc_thresh_smeter!=true){var thold=ext_mode(cur_mode).CW?threshCW:thresh;var x_thr=smeter_dBm_biased_to_x(-thold);line_stroke(sMeter_ctx,0,2,"white",0,y-3,w-x_thr,y-3);line_stroke(sMeter_ctx,0,2,"black",w-x_thr,y-3,w,y-3);}
if(sm_timeout--==0){sm_timeout=sm_interval;if(x<sm_px)line_stroke(sMeter_ctx,0,5,"black",x,y,sm_px,y);sm_px=x;}else{if(x<sm_px){line_stroke(sMeter_ctx,0,5,"red",x,y,sm_px,y);}else{sm_px=x;sm_timeout=sm_interval;}}
sm_timer++;var attn_period=((sm_timer&0x1f)<=0x07);if(kiwi.rf_attn&&attn_period){w3_show('id-smeter-attn');w3_innerHTML('id-smeter-dbm-value',(kiwi.rf_attn).toFixed(1));}else{w3_hide('id-smeter-attn');if(audio_ext_adc_ovfl&&!sm_ovfl_showing){w3_hide('id-smeter-dbm-units');w3_show('id-smeter-ovfl');w3_call('S_meter_adc_ovfl',true);sm_ovfl_showing=true;}else
if(!audio_ext_adc_ovfl&&sm_ovfl_showing){w3_hide('id-smeter-ovfl');w3_show('id-smeter-dbm-units');w3_call('S_meter_adc_ovfl',false);sm_ovfl_showing=false;}
var prec=(owrx.sMeter_dBm<=-100)?0:1;w3_innerHTML('id-smeter-dbm-value',(owrx.sMeter_dBm).toFixed(prec));}}
var ident_tout;var ident_user='';var send_ident=false;function ident_init(){var len=Math.max(cfg.ident_len,kiwi.ident_min);if(user_url){user_url=kiwi_decodeURIComponent('user_url',user_url);user_url=kiwi_strip_tags(user_url,'').substring(0,len);writeCookie('ident',user_url);}
var ident=initCookie('ident','');ident=kiwi_strip_tags(ident,'').substring(0,len);ident=kiwi_strip_tags(ident,'').substring(0,len);var el=w3_el('id-ident-input1');var el2=w3_el('id-ident-input2');w3_attribute(el,'maxlength',len);w3_attribute(el2,'maxlength',len);el.value=ident;el2.value=ident;ident_user=ident;send_ident=true;}
function ident_complete(from,which){var el=w3_el('id-ident-input'+which);var el2=w3_el('id-ident-input'+((which==1)?2:1));var ident=el.value;var len=Math.max(cfg.ident_len,kiwi.ident_min);ident=kiwi_strip_tags(ident,'').substring(0,len);el.value=ident;el2.value=ident;kiwi_clearTimeout(ident_tout);w3_schedule_highlight(el);w3_schedule_highlight(el2);freqset_select();writeCookie('ident',ident);ident_user=ident;send_ident=true;}
function ident_keyup(el,evt,which){kiwi_clearTimeout(ident_tout);if(evt!=undefined&&evt.key!=undefined){var klen=evt.key.length;if(any_alternate_click_event_except_shift(evt)||klen!=1&&evt.key!='Backspace'&&evt.key!='Shift'){if(evt.key=='Enter'){ident_complete('Enter',which);}
return;}}
if(!send_ident){ident_tout=setTimeout(function(){ident_complete('t/o',which);},5000);}}
var shortcut={nav_off:0,keys:null,NO_MODIFIER:0,SHIFT:1,CTL_ALT:2,SHIFT_PLUS_CTL_ALT:3,KEYCODE_SFT:16,KEYCODE_CTL:17,KEYCODE_ALT:18};function shortcut_key_mod(evt){var sft=evt.shiftKey;var ctl=evt.ctrlKey;var alt=evt.altKey;var meta=evt.metaKey;var ctlAlt=(ctl||alt);var rv=((sft&&!ctlAlt)?shortcut.SHIFT:((!sft&&ctlAlt)?shortcut.CTL_ALT:((sft&&ctlAlt)?shortcut.SHIFT_PLUS_CTL_ALT:shortcut.NO_MODIFIER)));return rv;}
function keyboard_shortcut_init(){if((kiwi_isMobile()&&!mobile_laptop_test)||kiwi_isFirefox()<47||kiwi_isChrome()<=49||kiwi_isOpera()<=36)return;shortcut.help=w3_div('',w3_inline_percent('w3-padding-tiny w3-bold w3-text-aqua','Shortcut keys',25,'Function'),w3_inline_percent('w3-padding-tiny','g =',25,'select frequency entry field'),w3_inline_percent('w3-padding-tiny','j i LR-arrow-keys',25,'frequency step down/up, add shift or alt for faster,<br>shift plus alt to step to next/prev DX label'),w3_inline_percent('w3-padding-tiny','m n N',25,'toggle frequency memory menu, VFO A/B, VFO A=B'),w3_inline_percent('w3-padding-tiny','b B',25,'scroll band menu'),w3_inline_percent('w3-padding-tiny','e E',25,'scroll extension menu'),w3_inline_percent('w3-padding-tiny','a A d l u c f q',25,'toggle modes: AM SAM DRM LSB USB CW NBFM IQ,<br>add alt to toggle backwards (e.g. SAM modes)'),w3_inline_percent('w3-padding-tiny','p P alt-p',25,'passband narrow/widen, restore default'),w3_inline_percent('w3-padding-tiny','UD-arrow-keys',25,'passband adjust both, right(shift), left(alt) edges'),w3_inline_percent('w3-padding-tiny','r',25,'toggle audio recording'),w3_inline_percent('w3-padding-tiny','z Z',25,'zoom in/out, add alt for max in/out'),w3_inline_percent('w3-padding-tiny','< >',25,'waterfall page down/up'),w3_inline_percent('w3-padding-tiny','w W',25,'waterfall min dB slider -/+ 1 dB, add alt for -/+ 10 dB'),w3_inline_percent('w3-padding-tiny','S D',25,'waterfall auto-scale, spectrum slow device mode'),w3_inline_percent('w3-padding-tiny','s alt-s',25,'spectrum RF/AF/off toggle, add alt to toggle backwards'),w3_inline_percent('w3-padding-tiny','v V space',25,'volume less/more, mute'),w3_inline_percent('w3-padding-tiny','o',25,'toggle between option bar <x1>off</x1> and <x1>stats</x1> mode,<br>others selected by related shortcut key'),w3_inline_percent('w3-padding-tiny','!',25,'toggle aperture manual/auto menu'),w3_inline_percent('w3-padding-tiny','@ alt-@',25,'open DX label filter, quick clear'),w3_inline_percent('w3-padding-tiny','\\ |',25,'toggle (& open) DX stored/EiBi/community database,<br>alt to toggle <x1>filter by time/day-of-week</x1> checkbox'),w3_inline_percent('w3-padding-tiny','x y',25,'toggle visibility of control panels, top bar'),w3_inline_percent('w3-padding-tiny','esc',25,'close/cancel action'),w3_inline_percent('w3-padding-tiny','? h',25,'toggle this help list'),w3_inline_percent('w3-padding-tiny','H',25,'toggle extension or frequency entry field help'),w3_inline_percent('w3-padding-tiny w3-bold w3-text-aqua','',25,'Windows, Linux: use alt key, not control key'),w3_inline_percent('w3-padding-tiny w3-bold w3-text-aqua','',25,'Mac: use alt/option or control key'));shortcut.freq_help=w3_div('',w3_inline_percent('w3-padding-tiny w3-bold w3-text-aqua','Frequency entry field options'),w3_inline_percent('w3-padding-tiny','<i>freq</i>',15,'set rx frequency in kHz or MHz using <x1>M</x1> suffix<br>e.g. <x1>7020</x1> or <x1>10M</x1>'),w3_inline_percent('w3-padding-tiny','<i>pb</i>',15,'set passband (described below) without changing frequency'),w3_inline_percent('w3-padding-tiny','<i>freq pb</i>',15,'set frequency and passband together, e.g. <x1>7020/2k</x1>'),w3_inline_percent('w3-padding-tiny','#<i>wf-freq</i>',15,'set waterfall frequency, e.g. <x1>#7020</x1> or <x1>#10M</x1>'),w3_inline_percent('w3-padding-tiny','#',15,'returns waterfall to rx frequency'),w3_inline_percent('w3-padding-tiny w3-bold w3-text-aqua w3-margin-T-8','Passband specification'),w3_inline_percent('w3-padding-tiny','',15,'Passband values below are in Hz or kHz if followed by <x1>k</x1> <br>'+'Positive values are above the carrier, negative below. <br>'+'So a <i>low,high</i> of <x1>300,3k</x1> describes a USB passband <br>'+'and <x1>-2.7k,300</x1> a LSB passband.'),w3_inline_percent('w3-padding-tiny','/<i>low,high</i>',15,'set passband low and high values'),w3_inline_percent('w3-padding-tiny','/<i>width</i>',15,'set width about current passband center'),w3_inline_percent('w3-padding-tiny','/',15,'returns passband to default for current mode'),w3_inline_percent('w3-padding-tiny',':<i>pbc</i>',15,'sets passband center retaining current width'),w3_inline_percent('w3-padding-tiny',':<i>pbc,pbw</i>',15,'sets passband by center and width'));w3_el('id-kiwi-body').addEventListener('keydown',keyboard_shortcut_event,true);}
function keyboard_shortcut_help(){confirmation_show_content(shortcut.help,550,625);}
function freq_input_help(){confirmation_show_content(shortcut.freq_help,550,380);}
function keyboard_shortcut_nav(nav){w3_el('id-nav-optbar-'+nav).click();shortcut.nav_click=true;}
function keyboard_shortcut_url_keys(){if(!isNonEmptyArray(shortcut.keys)){shortcut.keys=null;return;}
var key=shortcut.keys.shift();console.log('URL shortcut key='+key);keyboard_shortcut(key,0,0);setTimeout(keyboard_shortcut_url_keys,200);}
function keyboard_shortcut(key,key_mod,ctlAlt,evt){var action=true;var dir=ctlAlt?-1:1;shortcut.nav_click=false;var no_step=false;switch(key){case'a':mode_button(null,w3_el('id-button-am'),dir);break;case'A':mode_button(null,w3_el('id-button-sam'),dir);break;case'd':ext_set_mode('drm',null,{open_ext:true});break;case'l':mode_button(null,w3_el('id-button-lsb'),dir);break;case'u':mode_button(null,w3_el('id-button-usb'),dir);break;case'c':mode_button(null,w3_el('id-button-cw'),dir);break;case'f':mode_button(null,w3_el('id-button-nbfm'),dir);break;case'q':ext_set_mode('iq');break;case'j':case'J':case'ArrowLeft':if(key_mod!=shortcut.SHIFT_PLUS_CTL_ALT)
freqstep(owrx.wf_snap?key_mod:(2-key_mod));else
dx_label_step(-1);break;case'i':case'I':case'ArrowRight':if(key_mod!=shortcut.SHIFT_PLUS_CTL_ALT)
freqstep(owrx.wf_snap?(5-key_mod):(3+key_mod));else
dx_label_step(+1);break;case'p':case'P':if(key_mod==shortcut.CTL_ALT){restore_passband(cur_mode);demodulator_analog_replace(cur_mode);}else{passband_increment(key=='P',owrx.PB_NO_EDGE);}
break;case'ArrowUp':case'ArrowDown':var edge=owrx.PB_LEFT_EDGE;if(key_mod==shortcut.NO_MODIFIER)edge=owrx.PB_NO_EDGE;else
if(key_mod==shortcut.SHIFT)edge=owrx.PB_RIGHT_EDGE;passband_increment(key=='ArrowUp',edge);break;case'v':setvolume(1,kiwi.volume-5);toggle_or_set_mute(0);keyboard_shortcut_nav('audio');break;case'V':setvolume(1,kiwi.volume+5);toggle_or_set_mute(0);keyboard_shortcut_nav('audio');break;case' ':toggle_or_set_mute();shortcut.nav_click=true;break;case'g':case'=':freqset_select();break;case'm':freq_memory_menu_open(true);break;case'b':band_scroll(1);break;case'B':band_scroll(-1);break;case'n':freq_vfo_cb();break;case'N':vfo_update(true);break;case'<':page_scroll(-page_scroll_amount);break;case'>':page_scroll(+page_scroll_amount);break;case'z':zoom_step(ctlAlt?ext_zoom.NOM_IN:ext_zoom.IN);break;case'Z':zoom_step(ctlAlt?ext_zoom.MAX_OUT:ext_zoom.OUT);break;case'w':incr_mindb(1,ctlAlt?-10:-1);keyboard_shortcut_nav('wf');break;case'W':incr_mindb(1,ctlAlt?+10:+1);keyboard_shortcut_nav('wf');break;case's':toggle_or_set_spec(null,null,dir);keyboard_shortcut_nav('wf');break;case'S':wf_autoscale_cb();keyboard_shortcut_nav('wf');break;case'D':toggle_or_set_slow_dev();keyboard_shortcut_nav('wf');break;case'!':keyboard_shortcut_nav('wf');wf_aper_cb('wf.aper',wf.aper^1,false);break;case'o':keyboard_shortcut_nav(shortcut.nav_off?'status':'off');shortcut.nav_off^=1;break;case'r':toggle_or_set_rec();break;case'x':toggle_or_set_hide_panels();break;case'y':toggle_or_set_hide_bars();break;case'@':dx_filter(key_mod==shortcut.SHIFT_PLUS_CTL_ALT);shortcut.nav_click=true;break;case'e':extension_scroll(1);break;case'E':extension_scroll(-1);break;case'?':case'h':keyboard_shortcut_help();break;case'H':if(extint.current_ext_name)
w3_call(extint.current_ext_name+'_help',true);else
freq_input_help();break;case'|':if(!ext_panel_displayed('dx'))no_step=true;case'\\':if(key_mod==shortcut.CTL_ALT||key_mod==shortcut.SHIFT_PLUS_CTL_ALT)no_step=true;if(!no_step)dx.db=(dx.db+1)%dx.DB_N;var opt={};if(key_mod==shortcut.CTL_ALT||key_mod==shortcut.SHIFT_PLUS_CTL_ALT)opt.toggle=1;else
if(key_mod==shortcut.SHIFT)opt.open=1;dx_database_cb('',dx.db,false,opt,true);break;case'0':case'1':case'2':case'3':case'4':case'5':case'6':case'7':case'8':case'9':if(key_mod==shortcut.CTL_ALT){freq_memory_recall(key-'0'-1);}
break;default:if(evt&&evt.keyCode!=shortcut.KEYCODE_SFT&&evt.keyCode!=shortcut.KEYCODE_CTL&&evt.keyCode!=shortcut.KEYCODE_ALT){console.log('no shortcut key: '+key_stringify(evt)+'('+evt.keyCode+')');}
action=false;break;}
ignore_next_keyup_event=true;}
function keyboard_shortcut_event(evt){if(!evt.target){return;}
var k=evt.key;if(k=='Escape'||k.match(/F[1-9][12]?/)){return;}
shift_event(evt,'keydown');var id=evt.target.id;var suffix='';if(id==''){w3_iterate_classList(evt.target,function(className,idx){if(className.startsWith('id-')){id=className;suffix=' (class)';}});}
var sft=evt.shiftKey;var ctl=evt.ctrlKey;var alt=evt.altKey;var meta=evt.metaKey;var ctlAlt=(ctl||alt);var key_mod=shortcut_key_mod(evt);var field_input_key=((k>='0'&&k<='9'&&!ctl)||k=='.'||k==','||k=='/'||k==':'||k=='-'||k=='#'||k=='k'||k=='M'||k=='Enter'||k=='Backspace'||k=='Delete');if(k=='h'||k=='?'){var el=w3_elementAtPointer(owrx.last_pageX,owrx.last_pageY);if(el&&el.id=='id-freq-input'){freq_input_help();return cancelEvent(evt);}
if(w3_contains(el,'id-freq-menu')){freq_memory_help();return cancelEvent(evt);}}
if(evt.target.nodeName!='INPUT'||(id=='id-freq-input'&&!field_input_key)){if(kiwi_isMacOS()){if(meta){return;}}else{if(ctl){return;}}
if(alt&&!k.startsWith('Arrow')){k=String.fromCharCode(evt.keyCode).toLowerCase();if(sft)k=k.toUpperCase();}
keyboard_shortcut(k,key_mod,ctlAlt,evt);return cancelEvent(evt);}else{}}
function extension_scroll(dir){console.log('extension_scroll dir='+dir);console.log(extint_names);var el=w3_el('id-select-ext');console.log(el);var ext_menu=el.childNodes;console.log(ext_menu);var menu;var i=(+el.value)+1;console.log('extension_scroll initial i='+i);do{i+=dir;if(i<1)i=ext_menu.length-1;if(i>=ext_menu.length)i=1;menu=ext_menu[i];}while(menu.disabled);var value=+(menu.value);var idx=+(menu.getAttribute('kiwi_idx'));console.log('extension_scroll i='+i+' val='+value+' idx='+idx+' '+menu.innerHTML);w3_select_value('id-select-ext',value);if(owrx.sel_ext_to)kiwi_clearTimeout(owrx.sel_ext_to);owrx.sel_ext_to=setTimeout(function(){extint_select(value);},2000);}
var panel_margin=10;var ac_play_button;function check_suspended_audio_state(){try{window.AudioContext=window.AudioContext||window.webkitAudioContext;ac_play_button=new AudioContext();if(kiwi_isSafari()){var bufsrc=ac_play_button.createBufferSource();bufsrc.connect(ac_play_button.destination);try{bufsrc.start(0);}catch(ex){bufsrc.noteOn(0);}}
setTimeout(test_audio_suspended,500);}catch(e){console.log('#### no AudioContext?');}}
function test_audio_suspended(){if(ac_play_button.state!="running"){var s=w3_div('id-play-button-container class-overlay-container||onclick="play_button()"',w3_div('id-play-button','<img src="gfx/openwebrx-play-button.png" width="150" height="150" /><br><br>'+
(kiwi_isMobile()?'Tap to':'Click to')+' start OpenWebRX'));w3_create_appendElement('id-kiwi-body','div',s);el=w3_el('id-play-button');el.style.marginTop=px(w3_center_in_window(el));}}
function play_button(){try{if(kiwi_is_iOS()){var actx=audio_context;var bufsrc=actx.createBufferSource();bufsrc.connect(actx.destination);try{bufsrc.start(0);}catch(ex){bufsrc.noteOn(0);}}else{try{if(audio_context)audio_context.resume();}catch(ex){console.log('#### audio_context.resume() FAILED');}}}catch(ex){add_problem("audio start");}
w3_opacity('id-play-button-container',0);setTimeout(function(){w3_hide('id-play-button-container');},1100);audio_reset();freqset_select();}
function panels_setup(){var el;var s;w3_el("id-ident").innerHTML=w3_input('w3-label-not-bold/w3-custom-events|padding:1px|size=20'+' onchange="ident_complete(\'el\', 1)" onkeyup="ident_keyup(this, event, 1)"','Your name or callsign:','ident-input1');var mobile=kiwi_isMobile()?(' inputmode='+dq(kiwi_is_iOS()?'decimal':'tel')+' ontouchstart="popup_keyboard_touchstart(event)" onclick="this.select()"'):'';w3_el("id-control-freq1").innerHTML=w3_inline('w3-halign-space-between/',w3_div('id-freq-cell','<form id="id-freq-form" name="form_freq" action="#" onsubmit="freqset_complete(0); return false;">'+
w3_input('w3-custom-events w3-font-16px|margin: 2px 0 0 2px; padding:0 4px; width:'+freq_field_width()+'|type="text" title="type h or ? for help"'+mobile+' onchange="freqset_complete(1)" onkeyup="freqset_keyup(this, event)"','','id-freq-input')+'</form>')+'<select id="id-select-band" class="w3-pointer w3-select-menu" onchange="select_band(this.value)">'+
setup_band_menu()+'</select>'
+'<select id="id-select-ext" class="w3-pointer w3-select-menu" onchange="freqset_select(); extint_select(this.value)">'+'<option value="-1" selected disabled>extension</option>'+
extint_select_build_menu()+'</select>');check_suspended_audio_state();w3_el("id-control-freq2").innerHTML=w3_inline('w3-halign-space-between w3-margin-T-4/',w3_icon('id-freq-menu w3-menu-button w3-hold w3-hold-done||title="freq memory\nclick-hold to save\ntype h or ? for help"','fa-bars w3-text-white',20,'','freq_memory_menu_icon_cb'),w3_button('id-freq-vfo w3-text-in-circle w3-wh-20px w3-aqua w3-hold w3-hold-done||title="VFO A&slash;B\nclick-hold for A=B"','A','freq_vfo_cb'),kiwi_isMobile()?null:w3_div('id-freq-link|padding-left:0px'),w3_div('id-9-10-cell w3-hide',w3_div('id-button-9-10 class-button-small||title="LW/MW 9/10 kHz tuning step" onclick="button_9_10()"','10')),w3_div('id-step-freq','<img id="id-step-0" src="icons/stepdn.20.png" onclick="freqstep(0, event.shiftKey)" />','<img id="id-step-1" src="icons/stepdn.18.png" onclick="freqstep(1, event.shiftKey)" style="padding-bottom:1px" />','<img id="id-step-2" src="icons/stepdn.16.png" onclick="freqstep(2, event.shiftKey)" style="padding-bottom:2px" />','<img id="id-step-3" src="icons/stepup.16.png" onclick="freqstep(3, event.shiftKey)" style="padding-bottom:2px" />','<img id="id-step-4" src="icons/stepup.18.png" onclick="freqstep(4, event.shiftKey)" style="padding-bottom:1px" />','<img id="id-step-5" src="icons/stepup.20.png" onclick="freqstep(5, event.shiftKey)" />'),w3_div('',w3_button('id-button-spectrum class-button|font-size: 12px|title="toggle spectrum display"','Spec','toggle_or_set_spec')),w3_div('',w3_div('fa-stack||title="record"',w3_icon('id-rec1','fa-repeat fa-stack-1x w3-text-pink',22,'','toggle_or_set_rec'))),w3_div('|width:8%|title="mute"',w3_div('id-mute-no fa-stack|width:100%; color:lime',w3_icon('','fa-volume-up fa-stack-2x',24,'inherit','toggle_or_set_mute')),w3_div('id-mute-yes fa-stack w3-hide|width:100%;color:magenta;',w3_icon('','fa-volume-off fa-stack-2x fa-nudge-left',24,'','toggle_or_set_mute'),w3_icon('','fa-times fa-right',12,'','toggle_or_set_mute')),w3_div('id-mute-exclaim fa-stack w3-hide|width:100%; color:yellow',w3_icon('','fa-exclamation-triangle fa-stack-1x',20,'inherit','freqset_select'))));if(!isNaN(override_9_10)){step_9_10=override_9_10;}else{var init_AM_BCB_chan=ext_get_cfg_param('init.AM_BCB_chan');if(init_AM_BCB_chan==null||init_AM_BCB_chan==undefined){step_9_10=0;}else{step_9_10=init_AM_BCB_chan?0:1;}}
button_9_10(step_9_10);s='';mode_buttons.forEach(function(mba,i){var ms=mba.s[0];var mslc=ms.toLowerCase();var disabled=mba.dis||(mslc=='drm'&&!kiwi.DRM_enable);var attr=disabled?'':' onclick="mode_button(event, this)"';attr+=' onmouseover="mode_over(event, this)"';s+=w3_div('id-button-'+mslc+' id-mode-'+ext_mode(mslc).str+' class-button'+(disabled?' class-button-disabled':'')+' ||id="'+i+'-id-mode-col"'+attr+' onmousedown="cancelEvent(event)"',ms);});w3_el("id-control-mode").innerHTML=w3_inline('w3-halign-space-between/',s);var d=wf.audioFFT_active?' w3-disabled':'';var d2=wf.audioFFT_active?' w3-disabled||onclick="audioFFT_update()"':'';w3_el("id-control-zoom").innerHTML=w3_inline('w3-halign-space-between/',w3_div('id-zoom-in class-icon'+d+'||onclick="zoom_click(event,1)" onmouseover="zoom_over(event)" title="zoom in"','<img src="icons/zoomin.png" width="32" height="32" />'),w3_div('id-zoom-out class-icon'+d+'||onclick="zoom_click(event,-1)" onmouseover="zoom_over(event)" title="zoom out"','<img src="icons/zoomout.png" width="32" height="32" />'),w3_div('id-maxin'+d2,w3_div('class-icon||onclick="zoom_click(event,8)" title="max in"','<img src="icons/maxin.png" width="32" height="32" />')),w3_div('id-maxin-nom w3-hide'+d2,w3_div('class-icon||onclick="zoom_click(event,8)" title="max in"','<img src="icons/maxin.nom.png" width="32" height="32" />')),w3_div('id-maxin-max w3-hide'+d2,w3_div('class-icon||onclick="zoom_click(event,8)" title="max in"','<img src="icons/maxin.max.png" width="32" height="32" />')),w3_div('id-maxout'+d2,w3_div('class-icon||onclick="zoom_click(event,-9)" title="max out"','<img src="icons/maxout.png" width="32" height="32" />')),w3_div('id-maxout-max w3-hide'+d2,w3_div('class-icon||onclick="zoom_click(event,-9)" title="max out"','<img src="icons/maxout.max.png" width="32" height="32" />')),w3_div('class-icon'+d+'||onclick="zoom_click(event,0)" title="zoom to band"','<img src="icons/zoomband.png" width="32" height="16" style="padding-top:13px; padding-bottom:13px;"/>'),w3_div('class-icon'+d+'||onclick="page_scroll_icon_click(event,'+ -page_scroll_amount+')" title="page down\nalt: label step"','<img src="icons/pageleft.png" width="32" height="32" />'),w3_div('class-icon'+d+'||onclick="page_scroll_icon_click(event,'+page_scroll_amount+')" title="page up\nalt: label step"','<img src="icons/pageright.png" width="32" height="32" />'));var optbar_colors=['w3-green','w3-pink','w3-blue','w3-purple','w3-aqua','w3-yellow','w3-black','w3-red','w3-amber','w3-green','w3-orange','w3-lime','w3-indigo','w3-brown','w3-teal'];var ci=0;var psa1=' w3-center|width:12.8%';var psa2=psa1+';margin-right:6px';w3_el('id-optbar').innerHTML=w3_navbar('cl-optbar',w3_navdef(optbar_colors[ci++]+psa2,'RF','optbar-rf','optbar'),w3_nav(optbar_colors[ci++]+psa2,'WF','optbar-wf','optbar'),w3_nav(optbar_colors[ci++]+psa2,'Audio','optbar-audio','optbar'),w3_nav(optbar_colors[ci++]+psa2,'AGC','optbar-agc','optbar'),w3_nav(optbar_colors[ci++]+psa2,'User','optbar-users','optbar'),w3_nav(optbar_colors[ci++]+psa2,'Stat','optbar-status','optbar'),w3_nav(optbar_colors[ci++]+psa1,'Off','optbar-off','optbar'));wf_filter=readCookie('last_wf_filter',wf_sp_menu_e.OFF);spec_filter=readCookie('last_spec_filter',wf_sp_menu_e.IIR);if(isString(spectrum_show)){var ss=spectrum_show.toLowerCase();wf_sp_menu_s.forEach(function(e,i){if(ss==e.toLowerCase())spec_filter=i;});}
wf.max_min_sliders=w3_col_percent('w3-valign/class-slider',w3_text('w3-text-css-orange','WF max'),19,w3_slider('id-input-maxdb w3-wheel','','',maxdb,-100,20,1,'setmaxdb_cb'),60,w3_div('id-field-maxdb class-slider'),19)+
w3_col_percent('w3-valign/class-slider',w3_text('w3-text-css-orange','WF min'),19,w3_slider('id-input-mindb w3-wheel','','',mindb,-190,-30,1,'setmindb_cb'),60,w3_div('id-field-mindb class-slider'),19);wf.floor_ceil_sliders=w3_col_percent('w3-valign/class-slider',w3_text('w3-text-css-orange','WF ceil'),19,w3_slider('id-input-ceildb w3-wheel','','',wf.auto_ceil.val,-30,30,1,'setceildb_cb'),60,w3_div('id-field-ceildb class-slider'),19)+
w3_col_percent('w3-valign/class-slider',w3_text('w3-text-css-orange','WF floor'),19,w3_slider('id-input-floordb w3-wheel','','',wf.auto_floor.val,-30,30,1,'setfloordb_cb'),60,w3_div('id-field-floordb class-slider'),19);kiwi.rf_attn=(kiwi.model==kiwi.KiwiSDR_1)?0:+initCookie('last_rf_attn',cfg.init.rf_attn);w3_el("id-optbar-rf").innerHTML=w3_col_percent('w3-valign/class-slider',w3_text('w3-text-css-orange','RF attn'),19,w3_slider('id-rf-attn w3-wheel','','',kiwi.rf_attn,0,31.5,0.5,'rf_attn_cb'),60,w3_div('id-field-rf-attn class-slider'),19)+
w3_hr('|border-color:grey; margin:4px 6px 4px 0')+
w3_div('id-optbar-rf-container');if(kiwi.model==kiwi.KiwiSDR_1){var el=w3_el('id-rf-attn');w3_disable(el,true);el.title='no RF attenuator available';}
w3_el("id-optbar-wf").innerHTML=w3_div('id-aper-data w3-hide w3-margin-B-5|left:0px; width:256px; height:16px; background-color:#575757; overflow:hidden; position:relative;','<canvas id="id-aper-canvas" width="256" height="16" style="position:absolute"></canvas>')+
w3_col_percent('',w3_div('',w3_div('id-wf-sliders',wf.max_min_sliders),w3_col_percent('w3-valign/class-slider',w3_text('w3-text-css-orange','WF rate'),19,w3_slider('id-slider-rate w3-wheel'+d,'','',wf_speed,0,4,1,'setwfspeed_cb'),60,w3_div('slider-rate-field class-slider'),19),w3_col_percent('w3-valign/class-slider',w3_button('id-wf-sp-button class-button w3-font-12px','Spec &Delta;','toggle_or_set_wf_sp_button'),19,w3_slider('id-wf-sp-slider w3-wheel','','wf_sp_param',wf_sp_param,0,10,1,'wf_sp_slider_cb'),60,w3_div('id-wf-sp-slider-field class-slider'),19)),84,w3_divs('/w3-tspace-4 w3-hcenter w3-font-11_25px',w3_button('id-button-wf-autoscale class-button||title="waterfall auto scale"','Auto<br>Scale','wf_autoscale_cb'),w3_button('id-button-slow-dev class-button||title="slow device mode"','Slow<br>Dev','toggle_or_set_slow_dev'),w3_inline('',w3_button('id-button-spec-peak0 class-button w3-noactive w3-hold|border: 2px solid yellow; padding: 1px 3px|'+'title="toggle peak hold\n#1: off-on-hold\nshift: toggle backwards"','P1','toggle_or_set_spec_peak',0),w3_button('id-button-spec-peak1 w3-margin-L-4 class-button w3-noactive w3-hold|border: 2px solid magenta; padding: 1px 3px|'+'title="toggle peak hold\n#2: off-on-hold\nshift: toggle backwards"','P2','toggle_or_set_spec_peak',1))),16)+
w3_inline('w3-halign-space-between w3-margin-T-2/',w3_select('w3-text-red||title="colormap selection"','','color<br>map','wf.cmap',wf.cmap,kiwi.cmap_s,'wf_cmap_cb'),w3_select('w3-text-red||title="aperture selection"','','aper','wf.aper',wf.aper,kiwi.aper_s,'wf_aper_cb'),w3_select('w3-text-red||title="waterfall filter selection"','','wf','wf_filter',wf_filter,wf_sp_menu_s,'wf_sp_menu_cb',1),w3_select('w3-text-red||title="spectrum filter selection"','','spec','spec_filter',spec_filter,wf_sp_menu_s,'wf_sp_menu_cb',0),w3_icon('id-wf-gnd w3-momentary||title="disable waterfall input"','fa-caret-down',22,'white','wf_gnd_cb',1),w3_button('id-button-wf-more class-button w3-text-orange||onclick="extint_open(\'waterfall\'); freqset_select();" title="more waterfall params"','More'));setwfspeed_cb('',wf_speed,1);toggle_or_set_slow_dev(toggle_e.FROM_COOKIE|toggle_e.SET,0);toggle_or_set_spec_peak(toggle_e.FROM_COOKIE|toggle_e.SET_URL,peak_initially1,0);toggle_or_set_spec_peak(toggle_e.FROM_COOKIE|toggle_e.SET_URL,peak_initially2,1);toggle_or_set_wf_sp_button(toggle_e.FROM_COOKIE|toggle_e.SET,0);var nb_algo_s=[['off',1],['std',1],['Wild',1]];var nr_algo_s=[['off',1],['wdsp',1],['LMS',1],['spec',1]];de_emphasis=readCookie('last_de_emphasis',0);de_emphasis=w3_clamp(de_emphasis,0,2,0);de_emphasis_nfm=readCookie('last_de_emphasis_nfm',0);de_emphasis_nfm=w3_clamp(de_emphasis_nfm,0,2,0);kiwi.pan=readCookie('last_pan',0);w3_el('id-optbar-audio').innerHTML=w3_inline_percent('w3-valign/w3-last-halign-end',w3_text('w3-text-css-orange cl-closer-spaced-label-text','Noise'),17,w3_select_conditional('w3-text-red||title="noise blanker selection"','','blanker','nb_algo',0,nb_algo_s,'nb_algo_cb','m'),24,w3_div('w3-hcenter',w3_div('class-button w3-text-orange||onclick="extint_open(\'noise_blank\'); freqset_select();" title="noise blanker parameters"','More')),19,w3_div('w3-hcenter ',w3_select_conditional('w3-text-red||title="noise filter selection"','','filter','nr_algo',0,nr_algo_s,'nr_algo_cb','m')),27,w3_div('class-button w3-text-orange||onclick="extint_open(\'noise_filter\'); freqset_select();" title="noise filter parameters"','More'))+
w3_inline_percent('id-vol w3-valign w3-margin-T-2 w3-hide/class-slider w3-last-halign-end',w3_text('w3-text-css-orange','Volume'),17,w3_slider('id-input-volume w3-wheel','','',kiwi.volume,0,200,1,'setvolume_cb'),50,'&nbsp;',8,w3_div('',w3_select('id-deemp id-deemp1-ofm w3-text-red||title="de-emphasis"','','de-<br>emp','de_emphasis',de_emphasis,de_emphasis_s,'de_emp_cb',0),w3_select('id-deemp id-deemp1-nfm w3-text-red w3-hide||title="de-emphasis"','','de-<br>emp','de_emphasis_nfm',de_emphasis_nfm,de_emphasis_nfm_s,'de_emp_cb',1)))+
w3_inline_percent('id-vol-comp w3-valign w3-margin-T-2/class-slider w3-last-halign-end',w3_text('w3-text-css-orange','Volume'),17,w3_slider('id-input-volume w3-wheel','','',kiwi.volume,0,200,1,'setvolume_cb'),50,w3_div('',w3_select('id-deemp id-deemp2-ofm w3-text-red||title="de-emphasis"','','de-<br>emp','de_emphasis',de_emphasis,de_emphasis_s,'de_emp_cb',0),w3_select('id-deemp id-deemp2-nfm w3-text-red w3-hide','','de-<br>emp','de_emphasis_nfm',de_emphasis_nfm,de_emphasis_nfm_s,'de_emp_cb',1)),28,w3_button('id-button-compression class-button w3-hcenter||title="compression"','Comp','toggle_or_set_compression'))+
w3_inline_percent('id-pan w3-valign w3-hide/class-slider w3-last-halign-end',w3_text('w3-text-css-orange','Pan'),17,w3_slider('id-pan-value w3-wheel','','',kiwi.pan,-1,1,0.01,'setpan_cb'),50,'&nbsp;',3,w3_div('id-pan-field'),8,'&nbsp;',7,w3_button('id-button-compression class-button w3-hcenter||title="compression"','Comp','toggle_or_set_compression'))+
w3_inline_percent('id-squelch w3-valign/class-slider w3-last-halign-end',w3_text('id-squelch-label','Squelch'),15,w3_icon('||title="toggle squelch"','fa-caret-down',22,'lime','squelch_zero_cb',1),3,w3_slider('id-squelch-value w3-wheel','','',squelch,0,99,1,'set_squelch_cb'),42,w3_div('id-squelch-field w3-center class-slider'),14,w3_select('id-pre-rec w3-margin-R-4 w3-hide w3-text-red||title="pre-record time"','','pre','pre_record',pre_record,pre_record_s,'pre_record_cb'),16,w3_select('id-squelch-tail w3-hide w3-text-red||title="squelch tail length"','','tail','squelch_tail',squelch_tail,squelch_tail_s,'squelch_tail_cb'))+
w3_inline_percent('id-sam-carrier-container w3-hide w3-valign/',w3_inline('w3-halign-space-between/w3-last-halign-end',w3_text('w3-text-css-orange','SAM'),w3_text('id-sam-carrier')),50,w3_div(),5,w3_inline('w3-halign-space-between/w3-last-halign-end',w3_select('w3-text-red||title="PLL speed"','','PLL','owrx.sam_pll',owrx.sam_pll,owrx.sam_pll_s,'sam_pll_cb'),w3_button('class-button w3-hcenter||title="PLL reset"','Reset','sam_pll_reset_cb')))+
w3_inline('w3-margin-T-2 w3-valign w3-halign-end/class-slider',w3_select('id-chan-null w3-text-red w3-margin-R-6 w3-hide||title="channel null"','','channel<br>null','owrx.chan_null',owrx.chan_null,owrx.chan_null_s,'chan_null_cb'),w3_select('id-ovld-mute w3-text-red||title="overload mute"','','ovld<br>mute','owrx.ovld_mute',owrx.ovld_mute,owrx.ovld_mute_s,'ovld_mute_cb'));kiwi_load_js_dir('extensions/',['noise_blank/noise_blank.js','noise_filter/noise_filter.js'],function(){noise_blank_init();noise_filter_init();});toggle_or_set_compression(toggle_e.FROM_COOKIE|toggle_e.SET,1);squelch_setup(toggle_e.FROM_COOKIE);audio_panner_ui_init();w3_el('id-optbar-agc').innerHTML=w3_col_percent('w3-valign w3-margin-B-4/class-slider','<div id="id-button-agc" class="class-button" onclick="toggle_agc(event)" onmousedown="cancelEvent(event)" onmouseover="agc_over(event)">AGC</div>',13,'<div id="id-button-hang" class="class-button" onclick="toggle_or_set_hang();">Hang</div>',17,w3_divs('w3-show-inline-block/id-label-man-gain cl-closer-spaced-label-text','Manual<br>gain'),15,w3_slider('id-input-man-gain w3-wheel','','',manGain,0,120,1,'setManGain_cb'),40,w3_div('id-field-man-gain w3-show-inline-block',manGain.toString())+' dB',15)+
w3_div('',w3_col_percent('w3-valign/class-slider',w3_div('label-threshold w3-show-inline-block','Threshold'),20,w3_slider('id-input-threshold w3-wheel','','',thresh,-130,0,1,'setThresh_cb'),52,w3_div('id-field-threshold w3-show-inline-block',thresh.toString())+' dBm'),w3_col_percent('w3-valign/class-slider',w3_div('label-threshCW w3-show-inline-block','Thresh CW'),20,w3_slider('id-input-threshCW w3-wheel','','',threshCW,-130,0,1,'setThreshCW_cb'),52,w3_div('id-field-threshCW w3-show-inline-block',threshCW.toString())+' dBm'),w3_col_percent('w3-valign/class-slider',w3_div('label-slope w3-show-inline-block','Slope'),20,w3_slider('id-input-slope w3-wheel','','',slope,0,10,1,'setSlope_cb'),52,w3_div('id-field-slope w3-show-inline-block',slope.toString())+' dB'),w3_col_percent('w3-valign/class-slider',w3_div('label-decay w3-show-inline-block','Decay'),20,w3_slider('id-input-decay w3-wheel','','',decay,20,5000,10,'setDecay_cb'),52,w3_div('id-field-decay w3-show-inline-block',decay.toString())+' msec'));setup_agc(toggle_e.FROM_COOKIE|toggle_e.SET);w3_click_nav(kiwi_toggle(toggle_e.FROM_COOKIE|toggle_e.SET,'optbar-wf','optbar-wf','last_optbar'),'optbar','init');w3_el('id-news').style.backgroundColor=news_color;w3_el("id-news-inner").innerHTML='<span style="font-size: 14pt; font-weight: bold;">'+'KiwiSDR now available on '+'<a href="https://www.kickstarter.com/projects/1575992013/kiwisdr-beaglebone-software-defined-radio-sdr-with" target="_blank">'+'<img class="class-KS" src="icons/kickstarter-logo-light.150x18.png" />'+'</a>'+'</span>'+'';el=w3_el('id-readme');el.style.backgroundColor=readme_color;w3_el("id-readme-inner").innerHTML='<span style="font-size: 15pt; font-weight: bold;">Welcome!</span>'+'&nbsp;&nbsp;&nbsp;Project website: <a href="http://kiwisdr.com" target="_blank">kiwisdr.com</a>&nbsp;&nbsp;&nbsp;&nbsp;Here are some tips:'+'<ul style="padding-left: 12px;">'+'<li> Windows: Firefox, Chrome & Edge work; IE does not work. </li>'+'<li> Mac & Linux: Safari, Firefox, Chrome & Opera should work fine. </li>'+'<li> Open and close the panels by using the circled arrows at the top right corner. </li>'+'<li> You can click and/or drag almost anywhere on the page to change settings. </li>'+'<li> Enter a numeric frequency in the box marked "kHz" at right. </li>'+'<li> Or use the "select band" menu to jump to a pre-defined band. </li>'+'<li> Use the zoom icons to control the waterfall span. </li>'+'<li> Tune by clicking on the waterfall, spectrum or the cyan/red-colored station labels. </li>'+'<li> Control-shift or alt-shift click in the waterfall to lookup frequency in online databases. </li>'+'<li> Control or alt click to page spectrum down and up in frequency. </li>'+'<li> Adjust the "WF min" slider for best waterfall colors or use the "Auto Scale" button. </li>'+"<li> Type 'h' or '?' to see the list of keyboard shortcuts. </li>"+'<li> See the <a href="http://www.kiwisdr.com/quickstart/" target="_blank">Operating information</a> page '+'and <a href="http://kiwisdr.com/docs/KiwiSDR/KiwiSDR.design.review.pdf" target="_blank">Design review document</a>. </li>'+'</ul>';var contact_admin=ext_get_cfg_param('contact_admin');if(isUndefined(contact_admin)){contact_admin=true;}
var admin_email=ext_get_cfg_param('admin_email');admin_email=(contact_admin!='undefined'&&contact_admin!=null&&contact_admin==true&&admin_email!='undefined'&&admin_email!=null)?admin_email:null;if(admin_email!=null)admin_email=encodeURIComponent(encodeURIComponent(enc(admin_email)));w3_el('id-optbar-status').innerHTML=w3_div('id-status-msg')+
w3_div('',w3_text('w3-text-css-orange','Links'),w3_text('',(admin_email?'<a href="javascript:sendmail(\''+admin_email+'\');">Owner/Admin</a> | ':'')+'<a href="http://kiwisdr.com" target="_blank">KiwiSDR</a> '+'| <a href="http://forum.kiwisdr.com/discussions" target="_blank">Forum</a> '+'| <a href="https://kiwiirc.com/client/chat.freenode.net/#kiwisdr" target="_blank">Chat</a> '))+
w3_div('id-status-adc')+
w3_div('id-status-config')+
w3_div('id-status-gps')+
w3_inline('w3-valign',w3_div('id-status-audio'),' ',w3_div('id-status-problems'))+
w3_div('id-status-stats-cpu')+
w3_div('id-status-stats-xfer');setTimeout(function(){setInterval(status_periodic,5000);},1000);}
var prev_optbar=null;function optbar_focus(next_id,cb_arg){writeCookie('last_optbar',next_id);var h;if(next_id=='optbar-off'){if(cb_arg!='init'&&prev_optbar=='optbar-off')toggle_or_set_hide_bars();w3_hide('id-optbar-content');w3_el('id-control-top').style.paddingBottom='8px';}else{w3_show_block('id-optbar-content');w3_el('id-control-top').style.paddingBottom='';}
w3_el('id-control').style.height='';prev_optbar=next_id;freqset_select();}
function optbar_blur(cur_id){}
function zoomCorrection(){return 3*zoom_level;}
function rf_attn_cb(path,val,done,first,update){if(kiwi.model==kiwi.KiwiSDR_1)return;var attn=parseFloat(val);var input_attn=w3_el('id-rf-attn');var field_attn=w3_el('id-field-rf-attn');if(!input_attn||!field_attn)return;kiwi.rf_attn=attn;input_attn.value=attn;field_attn.innerHTML=attn.toFixed(1)+' dB';field_attn.style.color="white";if(update==true)return;if(!done||first){snd_send('SET rf_attn='+attn.toFixed(1));}else{writeCookie('last_rf_attn',val);freqset_select();}}
function rf_attn_wheel_cb(){var nval=w3_slider_wheel('rf_attn_wheel_cb','id-rf-attn',kiwi.rf_attn,0.5,1);rf_attn_cb(null,nval);}
var WF_SPEED_OFF=0;var WF_SPEED_1HZ=1;var WF_SPEED_SLOW=2;var WF_SPEED_MED=3;var WF_SPEED_FAST=4;var wf_speed=WF_SPEED_FAST;var wf_speeds=['off','1 Hz','slow','med','fast'];var wf={no_wf:false,cal:0,url_tstamp:0,ts_tz:0,scroll_multiple:3,no_sync:false,cmap:0,cmap_override:-1,custom_colormaps:[new Uint8Array(3*256),new Uint8Array(3*256),new Uint8Array(3*256),new Uint8Array(3*256)],aper:0,aper_algo:3,aper_param:0,sqrt:0,contr:0,last_zoom:-1,need_autoscale:0,auto_ceil:{min:0,val:5,max:30},auto_floor:{min:-30,val:0,max:0},auto_maxdb:0,auto_mindb:0,audioFFT_active:false,audioFFT_prev_mode:'',audioFFT_clear_wf:false,};var wf_contr_s={0:'normal',1:'scheme 1',2:'scheme 2',3:'scheme 3',4:'scheme 4'};function wf_contr_cb(path,idx,first){}
var wf_gnd=0,wf_gnd_value_base=150,wf_gnd_value=wf_gnd_value_base;function wf_gnd_cb(path,idx,first){idx=+idx;w3_color(path,idx?'white':'lime');wf_gnd=!idx;if(idx==0)freqset_select();}
var wf_sp_param=0;var wf_param=0,sp_param=0;var wf_sp_which=0;var wf_filter=0,spec_filter=0;var wf_sp_menu_s=['IIR','MMA','EMA','off'];var wf_sp_menu_e={IIR:0,MMA:1,EMA:2,OFF:3};var wf_sp_slider_s=['gain','avgs','avgs',''];var wf_sp_slider_d=[1,0,0,0];var wf_sp_filter_p=[{IIR_min:0,IIR_max:1,IIR_step:0.1,IIR_def:0.2,IIR_val:undefined,MMA_min:1,MMA_max:32,MMA_step:1,MMA_def:8,MMA_val:undefined,EMA_min:1,EMA_max:32,EMA_step:1,EMA_def:8,EMA_val:undefined,off_min:0,off_max:0,off_step:0,off_def:0,off_val:undefined},{IIR_min:0,IIR_max:2,IIR_step:0.1,IIR_def:0.8,IIR_val:undefined,MMA_min:1,MMA_max:16,MMA_step:1,MMA_def:2,MMA_val:undefined,EMA_min:1,EMA_max:16,EMA_step:1,EMA_def:2,EMA_val:undefined,off_min:0,off_max:0,off_step:0,off_def:0,off_val:undefined}];function spec_show(){toggle_or_set_spec(toggle_e.SET,spec.RF);var sp=-1;spectrum_param=parseFloat(spectrum_param);if(!isNaN(spectrum_param)&&spectrum_param!=-1)sp=spectrum_param;wf_sp_which=0;var f=wf_sp_menu_s[spec_filter];var f_p=wf_sp_filter_p[0];if(sp>=f_p[f+'_min']&&sp<=f_p[f+'_max']){wf_sp_slider_cb('id-wf-sp-slider',sp,true,false);toggle_or_set_wf_sp_button(toggle_e.SET,0);}}
function wf_sp_menu_cb(path,idx,first,param){idx=+idx;wf_sp_which=+param;if(wf_sp_which)wf_filter=idx;else spec_filter=idx;var f_val=wf_sp_which?wf_filter:spec_filter;var f=wf_sp_menu_s[f_val];var f_p=wf_sp_filter_p[wf_sp_which];var val=f_p[f+'_val'];wf_sp_slider_cb('id-wf-sp-slider',val,true,false);toggle_or_set_wf_sp_button(toggle_e.SET,wf_sp_which);writeCookie(wf_sp_which?'last_wf_filter':'last_spec_filter',f_val.toString());if(wf_sp_which)need_clear_wfavg=true;else spec.need_clear_avg=true;freqset_select();}
function spectrum_filter(filter){wf_sp_menu_cb('',filter,false,0);}
function toggle_or_set_wf_sp_button(set,val){if(isNumber(set))
wf_sp_which=+kiwi_toggle(set,+val,+val,'last_wf_sp_filter');else
wf_sp_which^=1;w3_innerHTML('id-wf-sp-button',wf_sp_which?'WF &Delta;':'Spec &Delta;');var f_val=wf_sp_which?wf_filter:spec_filter;var f=wf_sp_menu_s[f_val];var f_p=wf_sp_filter_p[wf_sp_which];wf_sp_slider_cb('id-wf-sp-slider',f_p[f+'_val'],true,false);freqset_select();}
function wf_sp_slider_cb(path,val,done,first){if(first)return;val=+val;var f_val=wf_sp_which?wf_filter:spec_filter;var f=wf_sp_menu_s[f_val];var f_p=wf_sp_filter_p[wf_sp_which];if(val==undefined||isNaN(val)){val=f_p[f+'_def'];var lsf=parseFloat(readCookie(wf_sp_which?'last_wf_filter':'last_spec_filter'));var lsfp=parseFloat(readCookie(wf_sp_which?'last_wf_filter_param':'last_spec_filter_param'));if(lsf==f_val&&!isNaN(lsfp)){val=lsfp;}}
if(wf_sp_which)wf_param=val;else sp_param=val;f_p[f+'_val']=val;w3_slider_setup('id-wf-sp-slider',f_p[f+'_min'],f_p[f+'_max'],f_p[f+'_step'],val);w3_el('id-wf-sp-slider-field').innerHTML=(f_val==wf_sp_menu_e.OFF)?'':(val.toFixed(wf_sp_slider_d[f_val])+' '+wf_sp_slider_s[f_val]);if(done){writeCookie(wf_sp_which?'last_wf_filter_param':'last_spec_filter_param',val.toFixed(2));freqset_select();}}
function wf_sp_slider_wheel_cb(){var el=w3_el('id-wf-sp-slider')
var param=wf_sp_which?wf_param:sp_param;var nval=w3_slider_wheel('wf_sp_slider_wheel_cb',el,param,+el.step,+el.step*5);wf_sp_slider_cb('',nval,1);}
function wf_cmap_cb(path,idx,first){if(first)return;idx=+idx;wf.cmap=w3_clamp(idx,0,kiwi.cmap_s.length-1,0);w3_select_value(path,idx,{all:1});writeCookie('last_cmap',idx);mkcolormap();spectrum_dB_bands();update_maxmindb_sliders();wf_send('SET cmap='+wf.cmap);w3_call('colormap_select');freqset_select();}
function wf_aper_cb(path,idx,first){if(first)return;idx=+idx;wf.aper=w3_clamp(idx,0,kiwi.aper_s.length-1,0);w3_select_value(path,idx);writeCookie('last_aper',idx);var auto=(wf.aper==kiwi.aper_e.auto);w3_innerHTML('id-wf-sliders',auto?wf.floor_ceil_sliders:wf.max_min_sliders);w3_color('id-button-wf-autoscale',null,auto?w3_selection_green:'');if(auto){wf.save_maxdb=maxdb;wf.save_mindb_un=mindb_un;if(wf.audioFFT_active)
wf.need_autoscale=16;}else{setmaxdb(1,wf.save_maxdb);setmindb(1,wf.save_mindb_un-zoomCorrection());}
spectrum_dB_bands();update_maxmindb_sliders();w3_show_hide_inline('id-wfext-maxmin',auto);w3_show_hide_inline('id-wfext-maxmin-spacer',!auto);colormap_update();freqset_select();}
function setwfspeed_cb(path,str,done){if(wf.audioFFT_active){freqset_select();return;}
wf_speed=+str;w3_set_value('slider-rate',wf_speed)
var el=w3_el('slider-rate-field');el.innerHTML=wf_speeds[wf_speed];el.style.color=wf_speed?'white':'orange';wf_send('SET wf_speed='+wf_speed.toFixed(0));if(done)freqset_select();}
function setwfspeed_wheel_cb(){var nval=w3_slider_wheel('setwfspeed_wheel_cb','id-slider-rate',wf_speed,1,1);setwfspeed_cb('',nval,1);}
function setmaxdb_cb(path,val,done,first){setmaxdb(done,val,false);}
function setmaxdb(done,str,no_freqset_select){var strdb=parseFloat(str);var write_cookies=false;if(wf.aper==kiwi.aper_e.auto){maxdb=strdb+wf.auto_ceil.val;}else{var input_max=w3_el('id-input-maxdb');var field_max=w3_el('id-field-maxdb');var field_min=w3_el('id-field-mindb');if(!input_max||!field_max||!field_min)return;write_cookies=true;if(strdb<=mindb){maxdb=mindb+1;input_max.value=maxdb;field_max.innerHTML=maxdb.toFixed(0)+' dB';field_max.style.color="red";}else{maxdb=strdb;input_max.value=maxdb;field_max.innerHTML=strdb.toFixed(0)+' dB';field_max.style.color="white";field_min.style.color="white";}}
setmaxmindb(done,write_cookies,no_freqset_select);}
function setmaxdb_wheel_cb(){var nval=w3_slider_wheel('setmaxdb_wheel_cb','id-input-maxdb',maxdb,1,10);setmaxdb(1,nval);}
function incr_mindb(done,incr){if(wf.aper!=kiwi.aper_e.man)return;var incrdb=(+mindb)+incr;var val=Math.max(-190,Math.min(-30,incrdb));setmindb(done,val.toFixed(0));}
function setmindb_cb(path,val,done,first){setmindb(done,val,false);}
function setmindb(done,str,no_freqset_select){var strdb=parseFloat(str);var write_cookies=false;if(wf.aper==kiwi.aper_e.auto){mindb=strdb+wf.auto_floor.val;}else{var input_min=w3_el('id-input-mindb');var field_max=w3_el('id-field-maxdb');var field_min=w3_el('id-field-mindb');if(!input_min||!field_max||!field_min)return;write_cookies=true;if(maxdb<=strdb){mindb=maxdb-1;input_min.value=mindb;field_min.innerHTML=mindb.toFixed(0)+' dB';field_min.style.color="red";}else{mindb=strdb;input_min.value=mindb;field_min.innerHTML=strdb.toFixed(0)+' dB';field_min.style.color="white";field_max.style.color="white";}}
mindb_un=mindb+zoomCorrection();setmaxmindb(done,write_cookies,no_freqset_select);}
function setmindb_wheel_cb(){var nval=w3_slider_wheel('setmindb_wheel_cb','id-input-mindb',mindb,1,10);setmindb(1,nval);}
function setmaxmindb(done,write_cookies,no_freqset_select){full_scale=maxdb-mindb;full_scale=full_scale?full_scale:1;spectrum_dB_bands();wf_send("SET maxdb="+maxdb.toFixed(0)+" mindb="+mindb.toFixed(0));need_clear_wf_sp_avg=true;if(done){if(no_freqset_select!=true)
freqset_select();if(write_cookies){writeCookie(wf.audioFFT_active?'last_AF_max_dB':'last_max_dB',maxdb.toFixed(0));writeCookie(wf.audioFFT_active?'last_AF_min_dB':'last_min_dB',mindb_un.toFixed(0));}}}
function update_maxmindb_sliders(){var auto=(wf.aper==kiwi.aper_e.auto);if(!auto)mindb=mindb_un-zoomCorrection();full_scale=maxdb-mindb;full_scale=full_scale?full_scale:1;spectrum_dB_bands();var db1,db2,db1_s,db2_s,field1,field2;if(auto){db1=wf.auto_ceil.val;db2=wf.auto_floor.val;db1_s=db1.toFixed(0).positiveWithSign();db2_s=db2.toFixed(0).positiveWithSign();w3_el('id-input-ceildb').value=db1;w3_el('id-input-floordb').value=db2;field1=w3_el('id-field-ceildb');field2=w3_el('id-field-floordb');}else{db1=maxdb;db2=mindb;db1_s=db1.toFixed(0);db2_s=db2.toFixed(0);w3_el('id-input-maxdb').value=db1;w3_el('id-input-mindb').value=db2;field1=w3_el('id-field-maxdb');field2=w3_el('id-field-mindb');}
field1.innerHTML=db1_s+' dB';field2.innerHTML=db2_s+' dB';}
function setceildb_cb(path,str,done){var input_ceil=w3_el('id-input-ceildb');var field_ceil=w3_el('id-field-ceildb');if(!input_ceil||!field_ceil)return;var ceildb=parseFloat(str);input_ceil.value=ceildb;w3_innerHTML(field_ceil,ceildb.toFixed(0).positiveWithSign()+' dB');wf.auto_ceil.val=ceildb;set_ceilfloordb(done);}
function setceildb_wheel_cb(){var nval=w3_slider_wheel('setceildb_wheel_cb','id-input-ceildb',wf.auto_ceil.val,1,5);setceildb_cb('',nval,1);}
function setfloordb_cb(path,str,done){var input_floor=w3_el('id-input-floordb');var field_floor=w3_el('id-field-floordb');if(!input_floor||!field_floor)return;var floordb=parseFloat(str);input_floor.value=floordb;w3_innerHTML(field_floor,floordb.toFixed(0).positiveWithSign()+' dB');wf.auto_floor.val=floordb;set_ceilfloordb(done);}
function setfloordb_wheel_cb(){var nval=w3_slider_wheel('setfloordb_wheel_cb','id-input-floordb',wf.auto_floor.val,1,5);setfloordb_cb('',nval,1);}
function set_ceilfloordb(done){maxdb=wf.auto_maxdb+wf.auto_ceil.val;mindb=wf.auto_mindb+wf.auto_floor.val;mindb_un=mindb+zoomCorrection();setmaxmindb(done,false);w3_call('waterfall_maxmin_cb');if(done){freqset_select();writeCookie('last_ceil_dB',wf.auto_ceil.val.toFixed(0));writeCookie('last_floor_dB',wf.auto_floor.val.toFixed(0));}}
function wf_autoscale_cb(){wf.need_autoscale=1;colormap_update();freqset_select();}
var spectrum_slow_dev=0;function toggle_or_set_slow_dev(set,val){if(isNumber(set))
spectrum_slow_dev=kiwi_toggle(set,val,spectrum_slow_dev,'last_slow_dev');else
spectrum_slow_dev^=1;w3_color('id-button-slow-dev',spectrum_slow_dev?'lime':'white');freqset_select();writeCookie('last_slow_dev',spectrum_slow_dev.toString());if(spectrum_slow_dev&&wf_speed==WF_SPEED_FAST)
setwfspeed_cb('',WF_SPEED_MED,1);}
function toggle_or_set_spec_peak(set,val,trace,ev){var hold=(ev&&ev.type=='hold');var shift_click=(ev&&ev.type=='click'&&ev.shiftKey);if(hold){trace=+val;console.log('toggle_or_set_spec_peak HOLD trace='+trace);if(spec.peak_show[trace]==spec.PEAK_ON){spec.peak_clear_btn[trace]=true;}
return;}
var prev;if(isNumber(set)){trace=+trace;prev=spec.peak_show[trace];spec.peak_show[trace]=kiwi_toggle(set,val,spec.peak_show[trace],'last_spec_peak'+(trace?'1':''));}else{trace=+val;prev=spec.peak_show[trace];if(shift_click){spec.peak_show[trace]--;if(spec.peak_show[trace]<0)spec.peak_show[trace]=2;}else{spec.peak_show[trace]=(spec.peak_show[trace]+1)%3;}}
var peak_clear_btn=(prev!=spec.PEAK_OFF&&spec.peak_show[trace]==spec.PEAK_OFF);if(peak_clear_btn)spec.peak_clear_btn[trace]=true;w3_color('id-button-spec-peak'+trace,['white','lime','orange'][spec.peak_show[trace]]);freqset_select();writeCookie('last_spec_peak'+(trace?'1':''),(spec.peak_show[trace]==spec.PEAK_ON)?'1':'0');}
var muted_until_freq_set=true;var recording=false;function setvolume_cb(path,val,done,first,cb_param){setvolume(done,val);}
function setvolume(done,str){kiwi.volume=+str
if(!isNumber(kiwi.volume))kiwi.volume=50;kiwi.volume=w3_clamp3(kiwi.volume,0,200,0,50,50);kiwi.volume_f=(kiwi.muted||kiwi.volume==0)?1e-6:(kiwi.volume/100);if(done){w3_set_value('id-input-volume',kiwi.volume);writeCookie('last_volume',kiwi.volume);freqset_select();}}
function setvolume_wheel_cb(){var nval=w3_slider_wheel('setvolume_wheel_cb','id-input-volume',kiwi.volume,5,15);setvolume(1,nval);}
function toggle_or_set_mute(set){if(isNumber(set))
kiwi.muted=set;else
kiwi.muted^=1;if(!owrx.squelched_overload){w3_show_hide('id-mute-no',!kiwi.muted);w3_show_hide('id-mute-yes',kiwi.muted);}
kiwi.volume_f=(kiwi.muted||kiwi.volume==0)?1e-6:(kiwi.volume/100);freqset_select();canvas_log_clear();if(owrx.debug_drag)owrx.drag_count=0;}
var de_emphasis=0,de_emphasis_nfm=0;var de_emphasis_s=['off','75 uS','50 uS'];var de_emphasis_nfm_s=['off','on','+LF'];function de_emp_cb(path,idx,first,nfm){var kmode=ext_mode(cur_mode);if(+nfm){de_emphasis_nfm=+idx;snd_send('SET de_emp='+de_emphasis_nfm+' nfm=1');writeCookie('last_de_emphasis_nfm',de_emphasis_nfm.toString());}else{de_emphasis=+idx;snd_send('SET de_emp='+de_emphasis+' nfm=0');writeCookie('last_de_emphasis',de_emphasis.toString());}}
function setpan_cb(path,val,done,first,cb_param){setpan(done,val);}
function setpan(done,str,no_write_cookie){var pan=+str;if(pan>-0.1&&pan<+0.1)pan=0;w3_set_value('id-pan-value',pan);w3_color('id-pan-value',null,(pan<0)?'rgba(255,0,0,0.3)':(pan?'rgba(0,255,0,0.2)':''));w3_innerHTML('id-pan-field',pan?((Math.abs(pan)*100).toFixed(0)+' '+((pan<0)?'L':'R')):'L=R');audio_set_pan(pan);kiwi.pan=pan;if(done){if(no_write_cookie!=true)
writeCookie('last_pan',pan.toString());freqset_select();}}
function setpan_wheel_cb(){var nval=w3_slider_wheel('setpan_wheel_cb','id-pan-value',kiwi.pan,0.1,0.1);setpan(1,nval);}
function audio_panner_ui_init(){if(audio_panner){w3_hide2('id-vol-comp');w3_hide2('id-vol',false);w3_hide2('id-pan',false);setpan(1,kiwi.pan,true);}}
function toggle_or_set_hide_bars(set){if(isNumber(set))
owrx.hide_bars=set;else{owrx.hide_bars=(owrx.hide_bars+1)&owrx.HIDE_ALLBARS;if((owrx.hide_bars&owrx.HIDE_TOPBAR)&&(extint.using_data_container||spec.source!=spec.NONE))
owrx.hide_bars=(owrx.hide_bars+1)&owrx.HIDE_ALLBARS;}
w3_set_props('id-top-container','w3-panel-override-hide',owrx.hide_bars&owrx.HIDE_TOPBAR);w3_set_props('id-band-container','w3-panel-override-hide',owrx.hide_bars&owrx.HIDE_BANDBAR);openwebrx_resize();}
var hide_panels=0;function toggle_or_set_hide_panels(set){if(isNumber(set))
hide_panels=set;else
hide_panels^=1;w3_iterate_children('id-panels-container',function(el){if(w3_contains(el,'class-panel')){w3_set_props(el,'w3-panel-override-hide',hide_panels);}});}
var test_button;function toggle_or_set_test(set){if(isNumber(set))
test_button=set;else
test_button^=1;console.log('toggle_or_set_test set='+set+' test_button='+test_button);w3_color('id-button-test',test_button?'lime':'white');snd_send('SET test='+(test_button?1:0));freqset_select();}
function toggle_or_set_rec(set){console.log('toggle_or_set_rec set='+set+' recording='+recording);if(isBoolean(set)||isNumber(set))
recording=set;else
recording=!recording;w3_spin('id-rec1',recording);w3_spin('id-rec2',recording);w3_remove_then_add('id-rec1','w3-text-white','w3-text-pink');w3_remove_then_add('id-rec2','w3-text-white','w3-text-pink');if(recording){window.recording_meta={buffers:[],data:null,offset:0,total_size:0,filename:kiwi_timestamp_filename('','.wav')};window.recording_meta.buffers.push(new ArrayBuffer(65536));window.recording_meta.data=new DataView(window.recording_meta.buffers[0]);}else
if(window.recording_meta){var wav_header=new ArrayBuffer(44);var wav_data=new DataView(wav_header);wav_data.setUint32(0,0x52494646);wav_data.setUint32(4,window.recording_meta.total_size+36,true);wav_data.setUint32(8,0x57415645);wav_data.setUint32(12,0x666d7420);wav_data.setUint32(16,16,true);wav_data.setUint16(20,1,true);var nch=ext_is_IQ_or_stereo_curmode()?2:1;wav_data.setUint16(22,nch,true);var srate=Math.round(audio_input_rate||12000);wav_data.setUint32(24,srate,true);var bpsa=16;var Bpsa=bpsa/8;wav_data.setUint32(28,srate*nch*Bpsa,true);wav_data.setUint16(32,nch*Bpsa,true);wav_data.setUint16(34,bpsa,true);wav_data.setUint32(36,0x64617461);wav_data.setUint32(40,window.recording_meta.total_size,true);window.recording_meta.buffers.unshift(wav_header);var wav_file=new Blob(window.recording_meta.buffers,{type:'octet/stream'});var a=document.createElement('a');a.style='display: none';a.href=window.URL.createObjectURL(wav_file);a.download=window.recording_meta.filename;document.body.appendChild(a);a.click();window.URL.revokeObjectURL(a.href);document.body.removeChild(a);delete window.recording_meta;audio_pre_record_buf_init();}}
var squelched=0;var squelch=0;var pre_record=0;var pre_record_s=['0s','1s','2s','5s','10s'];var pre_record_v=[0,1,2,5,10];var squelch_tail=0;var squelch_tail_s=['0s','.2s','.5s','1s','2s'];var squelch_tail_v=[0,0.2,0.5,1,2];function squelch_action(sq){squelched=sq;var mute_color=squelched?'white':kiwi.unmuted_color;var sq_color=mute_color;owrx.squelched_overload=(owrx.sMeter_dBm>=cfg.overload_mute);if(owrx.prev_squelched_overload!=owrx.squelched_overload){w3_show_hide('id-mute-exclaim',owrx.squelched_overload);w3_show_hide('id-mute-no',owrx.squelched_overload?false:!kiwi.muted);w3_show_hide('id-mute-yes',owrx.squelched_overload?false:kiwi.muted);owrx.prev_squelched_overload=owrx.squelched_overload;}
w3_color('id-squelch-label',sq_color);w3_color('id-mute-no',mute_color);if(recording){var stop=(squelched||owrx.squelched_overload);w3_spin('id-rec1',!stop);w3_spin('id-rec2',!stop);w3_remove_then_add('id-rec1','w3-text-white w3-text-pink',stop?'w3-text-white':'w3-text-pink');w3_remove_then_add('id-rec2','w3-text-white w3-text-pink',stop?'w3-text-white':'w3-text-pink');}}
function squelch_setup(flags){var nbfm=ext_mode(cur_mode).NBFM;if(flags&toggle_e.FROM_COOKIE){var sq=readCookie('last_squelch'+(nbfm?'':'_efm'));squelch=sq?+sq:0;w3_el('id-squelch-value').max=nbfm?99:40;w3_set_value('id-squelch-value',squelch);var pre=kiwi_storeGet('last_pre',0);pre_record=pre?+pre:0;w3_select_value('id-pre-rec',pre_record);var tail=kiwi_storeGet('last_tail',0);squelch_tail=tail?+tail:0;w3_select_value('id-squelch-tail',squelch_tail);}
set_squelch_cb('',squelch,true,false,true);pre_record_cb('',pre_record,false,true);squelch_tail_cb('',squelch_tail,false,true);if(nbfm){squelch_action(squelched);}else{w3_color('id-mute-no',kiwi.unmuted_color);}
w3_hide2('id-pre-rec',nbfm);w3_hide2('id-squelch-tail',nbfm);w3_hide2('id-squelch',cur_mode=='drm');}
function send_squelch(){var nbfm=ext_mode(cur_mode).NBFM;snd_send("SET squelch="+squelch.toFixed(0)+' param='+(nbfm?squelch_threshold:squelch_tail_v[squelch_tail]).toFixed(2));}
function set_squelch_cb(path,str,done,first,no_write_cookie){var nbfm=ext_mode(cur_mode).NBFM;if(first)return;squelch=parseFloat(str);var sq_s=squelch.toFixed(0);w3_el('id-squelch-field').innerHTML=squelch?(sq_s+(nbfm?'':' dB')):'off';w3_set_value('id-squelch-value',squelch);w3_color('id-squelch-value',null,squelch?'':'rgba(255,0,0,0.3)');send_squelch();if(done){if(no_write_cookie!=true){writeCookie('last_squelch'+(nbfm?'':'_efm'),sq_s);}
freqset_select();}}
function set_squelch_wheel_cb(){var nval=w3_slider_wheel('set_squelch_wheel_cb','id-squelch-value',squelch,1,5);set_squelch_cb('',nval,1);}
var squelch_enable=1;var squelch_save=null;function squelch_zero_cb(path,idx,first){squelch_enable^=1;w3_color(path,squelch_enable?'lime':'magenta');var squelch_new;if(squelch_enable){squelch_new=(squelch_save==null)?squelch:squelch_save;freqset_select();w3_disable('id-squelch-value',false);}else{squelch_save=squelch;squelch_new=0;}
set_squelch_cb('',squelch_new,true,false,true);if(!squelch_enable)
w3_disable('id-squelch-value',true);}
function pre_record_cb(path,val,first,no_write_cookie){if(first)return;pre_record=+val;audio_pre_record_buf_init();if(no_write_cookie!=true&&!ext_mode(cur_mode).NBFM)
kiwi_storeSet('last_pre',pre_record);}
function squelch_tail_cb(path,val,first,no_write_cookie){if(first)return;squelch_tail=+val;send_squelch();if(no_write_cookie!=true&&!ext_mode(cur_mode).NBFM)
kiwi_storeSet('last_tail',squelch_tail);}
function sam_pll_reset_cb(path,val,first){snd_send('SET sam_pll=-1');}
function sam_pll_cb(path,val,first){owrx.sam_pll=+val;snd_send('SET sam_pll='+owrx.sam_pll);}
function chan_null_cb(path,val,first){if(first)return;owrx.chan_null=+val;ext_set_mode(cur_mode);}
function SAM_opts_cb(path,val,first){if(first)return;owrx.SAM_opts=+val;ext_set_mode(cur_mode);}
function ovld_mute_cb(path,val,first){if(first)return;owrx.ovld_mute=+val;snd_send('SET ovld_mute='+(owrx.ovld_mute?1:0));}
var btn_less_buffering=0;function toggle_or_set_audio(set,val){if(isNumber(set))
btn_less_buffering=kiwi_toggle(set,val,btn_less_buffering,'last_audio');else
btn_less_buffering^=1;var el=w3_el('id-button-buffering');if(el){el.style.color=btn_less_buffering?'lime':'white';el.style.visibility='visible';freqset_select();}
writeCookie('last_audio',btn_less_buffering.toString());if(!isNumber(set)){window.location.reload(true);}}
var btn_compression=0;function toggle_or_set_compression(set,val){if(recording){return;}
if(isNumber(set))
btn_compression=kiwi_toggle(set,val,btn_compression,'last_compression');else
btn_compression^=1;w3_els('id-button-compression',function(el){el.style.color=btn_compression?'lime':'white';el.style.visibility='visible';freqset_select();});writeCookie('last_compression',btn_compression.toString());snd_send('SET compression='+btn_compression.toFixed(0));}
function set_agc(){var isCW=ext_mode(cur_mode).CW;w3_color('label-threshold',(!isCW&&agc)?'orange':'white');w3_color('label-threshCW',(isCW&&agc)?'orange':'white');var thold=isCW?threshCW:thresh;snd_send('SET agc='+agc+' hang='+hang+' thresh='+thold+' slope='+slope+' decay='+decay+' manGain='+manGain);}
var agc=0;function toggle_agc(evt){if(any_alternate_click_event(evt)){setup_agc(toggle_e.SET);}else{toggle_or_set_agc();}
return cancelEvent(evt);}
function agc_over(evt){w3_el('id-button-agc').title=any_alternate_click_event(evt)?'restore AGC params':'';}
var default_agc=1;var default_hang=0;var default_manGain=50;var default_thresh=-100;var default_threshCW=-130;var default_slope=6;var default_decay=1000;function setup_agc(toggle_flags){agc=kiwi_toggle(toggle_flags,default_agc,agc,'last_agc');toggle_or_set_agc(agc);hang=kiwi_toggle(toggle_flags,default_hang,hang,'last_hang');toggle_or_set_hang(hang);manGain=kiwi_toggle(toggle_flags,default_manGain,manGain,'last_manGain');setManGain_cb('',manGain,1);thresh=kiwi_toggle(toggle_flags,default_thresh,thresh,'last_thresh');setThresh_cb('',thresh,1);threshCW=kiwi_toggle(toggle_flags,default_threshCW,threshCW,'last_threshCW');setThreshCW_cb('',threshCW,1);slope=kiwi_toggle(toggle_flags,default_slope,slope,'last_slope');setSlope_cb('',slope,1);decay=kiwi_toggle(toggle_flags,default_decay,decay,'last_decay');setDecay_cb('',decay,1);}
function toggle_or_set_agc(set){if(set!=undefined)
agc=set;else
agc^=1;w3_el('id-button-agc').style.color=agc?'lime':'white';if(agc){w3_el('id-label-man-gain').style.color='white';w3_el('id-button-hang').style.borderColor=w3_el('label-slope').style.color=w3_el('label-decay').style.color='orange';}else{w3_el('id-label-man-gain').style.color='orange';w3_el('id-button-hang').style.borderColor=w3_el('label-slope').style.color=w3_el('label-decay').style.color='white';}
set_agc();writeCookie('last_agc',agc.toString());freqset_select();}
var hang=0;function toggle_or_set_hang(set){if(set!=undefined)
hang=set;else
hang^=1;w3_el('id-button-hang').style.color=hang?'lime':'white';set_agc();writeCookie('last_hang',hang.toString());freqset_select();}
var manGain=0;function setManGain_cb(path,str,done,first){if(first)return;manGain=parseFloat(str);w3_el('id-input-man-gain').value=manGain;w3_el('id-field-man-gain').innerHTML=str;set_agc();writeCookie('last_manGain',manGain.toString());if(done)freqset_select();}
function setManGain_wheel_cb(){var nval=w3_slider_wheel('setManGain_wheel_cb','id-input-man-gain',manGain,1,10);setManGain_cb('',nval,1);}
var thresh=0;function setThresh_cb(path,str,done,first){if(first)return;thresh=parseFloat(str);w3_el('id-input-threshold').value=thresh;w3_el('id-field-threshold').innerHTML=str;set_agc();writeCookie('last_thresh',thresh.toString());if(done)freqset_select();}
function setThresh_wheel_cb(){var nval=w3_slider_wheel('setThresh_wheel_cb','id-input-threshold',thresh,1,10);setThresh_cb('',nval,1);}
var threshCW=0;function setThreshCW_cb(path,str,done,first){if(first)return;threshCW=parseFloat(str);w3_el('id-input-threshCW').value=threshCW.toFixed(0);w3_el('id-field-threshCW').innerHTML=str;set_agc();writeCookie('last_threshCW',threshCW.toString());if(done)freqset_select();}
function setThreshCW_wheel_cb(){var nval=w3_slider_wheel('setThreshCW_wheel_cb','id-input-threshCW',threshCW,1,10);setThreshCW_cb('',nval,1);}
var slope=0;function setSlope_cb(path,str,done,first){if(first)return;slope=parseFloat(str);w3_el('id-input-slope').value=slope;w3_el('id-field-slope').innerHTML=str;set_agc();writeCookie('last_slope',slope.toString());if(done)freqset_select();}
function setSlope_wheel_cb(){var nval=w3_slider_wheel('setSlope_wheel_cb','id-input-slope',slope,1,1);setSlope_cb('',nval,1);}
var decay=0;function setDecay_cb(path,str,done,first){if(first)return;decay=parseFloat(str);w3_el('id-input-decay').value=decay;w3_el('id-field-decay').innerHTML=str;set_agc();writeCookie('last_decay',decay.toString());if(done)freqset_select();}
function setDecay_wheel_cb(){var nval=w3_slider_wheel('setDecay_wheel_cb','id-input-decay',decay,100,500);setDecay_cb('',nval,1);}
function users_setup(){var s='';for(var i=0;i<rx_chans;i++){s+=w3_div('',w3_div('w3-show-inline-block w3-left w3-margin-R-5 '+
((i==rx_chan)?'w3-text-css-lime':'w3-text-css-orange'),'RX'+i),w3_div('id-optbar-user-'+i+' w3-show-inline-block'));}
var mobile1=kiwi_isMobile()?' w3-font-16px':'';var mobile2=' ontouchstart="popup_keyboard_touchstart(event)"';s+=w3_input('w3-margin-TB-4 w3-width-half/w3-label-not-bold/w3-custom-events'+mobile1+'|padding:1px|size=20 onchange="ident_complete(\'el\', 2)" onkeyup="ident_keyup(this, event, 2)"'+mobile2,'Your name or callsign:','ident-input2');w3_innerHTML('id-optbar-users',w3_div('w3-nowrap',s));}
function freq_vfo_cb(el,val,trace,ev){if(ev){var hold=(ev.type=='hold');var hold_done=(ev.type=='hold-done');if(hold){w3_remove_then_add(el,'w3-aqua w3-orange','w3-red');vfo_update(true);return;}else
if(hold_done){w3_remove_then_add(el,'w3-red',owrx.vfo_ab?'w3-orange':'w3-aqua');return;}}
owrx.vfo_ab^=1;w3_flip_colors('id-freq-vfo','w3-aqua w3-orange',owrx.vfo_ab);w3_innerHTML('id-freq-vfo',"AB"[owrx.vfo_ab]);var vfo=parse_freq_pb_mode_zoom(readCookie('last_vfo_'+"AB"[owrx.vfo_ab]));var mode=undefined,zoom=0;if(vfo[3])mode=vfo[3].toLowerCase();if(vfo[4])zoom=+vfo[4];ext_tune(vfo[1],mode,ext_zoom.ABS,zoom);}
function toggle_or_set_spec(set,val,dir,ev){var no_close_ext=false;var shift_click=(ev&&ev.type=='click'&&ev.shiftKey);if(isNumber(set)&&(set&toggle_e.SET)){spec.source=+val;no_close_ext=((set&toggle_e.NO_CLOSE_EXT)!=0);}else{if((isUndefined(dir)||dir==false||dir==1)&&!shift_click){spec.source=(spec.source+1)%spec.CHOICES;}else{spec.source--;if(spec.source<0)spec.source=spec.CHOICES-1;}}
var isSpec=(spec.source!=spec.NONE);if(!no_close_ext&&extint.using_data_container&&isSpec){extint_panel_hide(true);}
var el=w3_el('id-button-spectrum');el.innerHTML=['Spec','Spec RF','Spec AF'][spec.source];el.style.color=isSpec?'lime':'white';if(isSpec){spec.switch_container=true;}else{w3_show_hide('id-spectrum-container',false);w3_show_hide('id-top-container',true);}
freqset_select();snd_send('SET spc_='+spec.source);}
function mode_over(evt,el){var mode=el.innerHTML.toLowerCase();var s;switch(mode){case'sam':s='synchronous AM';break;case'sal':s='synchronous AM LSB';break;case'sau':s='synchronous AM USB';break;case'sas':s='synchronous AM stereo';break;case'qam':s='C-QUAM AM stereo';break;default:s='';break;}
el.title=evt.shiftKey?'restore passband':s;}
function any_alternate_click_event(evt){return(evt&&(evt.shiftKey||evt.ctrlKey||evt.altKey||evt.button==mouse.middle||evt.button==mouse.right));}
function any_alternate_click_event_except_shift(evt){return(evt&&(evt.ctrlKey||evt.altKey||evt.button==mouse.middle||evt.button==mouse.right));}
function any_modifier_key(evt){return(evt&&(evt.shiftKey||evt.ctrlKey||evt.altKey));}
function restore_passband(mode){owrx.last_lo[mode]=kiwi_passbands(mode).lo;owrx.last_hi[mode]=kiwi_passbands(mode).hi;}
var mode_buttons=[{s:['AM','AMN'],dis:0},{s:['SAM','SAL','SAU','SAS','QAM'],dis:0},{s:['DRM'],dis:0},{s:['LSB','LSN'],dis:0},{s:['USB','USN'],dis:0},{s:['CW','CWN'],dis:0},{s:['NBFM','NNFM'],dis:0},{s:['IQ'],dis:0},];function mode_button(evt,el,dir){var mode=el.innerHTML.toLowerCase();if(isUndefined(dir))dir=1;if(any_alternate_click_event(evt)){if(evt.shiftKey||evt.button==mouse.middle){restore_passband(mode);ext_set_mode(mode,null,{open_ext:true});return;}
dir=-1;}
var col=parseInt(el.id);if(isUndefined(owrx.last_mode_col)){owrx.last_mode_col=parseInt(owrx.last_mode_el.id);}
if(owrx.last_mode_col!=col){if(recording){var c_iq_or_stereo=ext_is_IQ_or_stereo_curmode()?1:0;var m_iq_or_stereo=ext_is_IQ_or_stereo_mode(mode)?1:0;if(c_iq_or_stereo^m_iq_or_stereo||mode=='drm')
return;}
owrx.last_mode_col=col;}else{var sa=mode_buttons[col].s;var mode_uc=mode.toUpperCase();var i=sa.indexOf(mode_uc)+dir;if(i<=-1)i=sa.length-1;if(i>=sa.length)i=0;mode_uc=sa[i];mode=mode_uc.toLowerCase();if(recording){var c_iq_or_stereo=ext_is_IQ_or_stereo_curmode()?1:0;var m_iq_or_stereo=ext_is_IQ_or_stereo_mode(mode)?1:0;if(c_iq_or_stereo^m_iq_or_stereo||mode=='drm')
return;}
el.innerHTML=mode_uc;}
ext_set_mode(mode,null,{open_ext:true});}
var step_9_10;function button_9_10(set){if(set!=undefined)
step_9_10=set;else
step_9_10^=1;writeCookie('last_9_10',step_9_10);freq_step_update_ui(true);var el=w3_el('id-button-9-10');el.innerHTML=step_9_10?'9':'10';freqset_select();}
function pop_bottommost_panel(from){min_order=parseInt(from[0].getAttribute('data-panel-order'));min_index=0;for(var i=0;i<from.length;i++){actual_order=parseInt(from[i].getAttribute('data-panel-order'));if(actual_order<min_order){min_index=i;min_order=actual_order;}}
to_return=from[min_index];from.splice(min_index,1);return to_return;}
function place_panels(){var left_col=[];var right_col=[];w3_iterate_children('id-panels-container',function(c){if(c.classList.contains('class-panel')){var position=c.getAttribute('data-panel-pos');if(!position)return;var newSize=c.getAttribute('data-panel-size').split(",");if(position=="left"){left_col.push(c);}
else if(position=="right"){right_col.push(c);}
c.idName=c.id.replace('id-','');c.style.width=newSize[0]+"px";c.style.height=newSize[1]+"px";c.style.margin=px(panel_margin);c.uiWidth=parseInt(newSize[0]);c.uiHeight=parseInt(newSize[1]);c.defaultWidth=parseInt(newSize[0]);c.defaultHeight=parseInt(newSize[1]);var border_pad=html_LR_border_pad(c);c.activeWidth=c.uiWidth-border_pad;if(position=='center'){c.style.left=px(window.innerWidth/2-c.activeWidth/2);c.style.bottom=px(window.innerHeight/2-c.uiHeight/2);c.style.visibility="hidden";}
if(position=='bottom-left'){c.style.left=0;c.style.bottom=0;c.style.visibility="hidden";}}});y=0;while(left_col.length>0){p=pop_bottommost_panel(left_col);p.style.left=0;p.style.bottom=px(y);p.style.visibility="visible";y+=p.uiHeight+3*panel_margin;w3_call('panel_setup_'+p.idName,p);}
y=0;while(right_col.length>0){p=pop_bottommost_panel(right_col);p.style.right=kiwi_isMobile()?0:px(kiwi_scrollbar_width());p.style.bottom=px(y);p.style.visibility="visible";y+=p.uiHeight+3*panel_margin;w3_call('panel_setup_'+p.idName,p);}}
var divControl;var OPTBAR_CONTENT_HEIGHT=150;function panel_setup_control(el){divControl=el;el.style.marginBottom='0';var el2=w3_el('id-control-inner');el2.innerHTML=w3_div('id-control-top',w3_div('id-control-freq1'),w3_div('id-control-freq2'),w3_div('id-control-mode w3-margin-T-6'),w3_div('id-control-zoom w3-margin-T-6'),w3_div('id-optbar w3-margin-T-4'))+
w3_div('id-optbar-content w3-margin-T-6 w3-scroll-y|height:'+px(OPTBAR_CONTENT_HEIGHT),w3_div('id-optbar-rf w3-hide'),w3_div('id-optbar-wf w3-hide'),w3_div('id-optbar-audio w3-hide'),w3_div('id-optbar-agc w3-hide'),w3_div('id-optbar-users w3-hide w3-scroll-x'),w3_div('id-optbar-status w3-hide'))+
w3_div('id-control-smeter');w3_el('id-control-freq1').style.width=px(el.activeWidth-visIcon-6);w3_show_hide('id-mute-no',!kiwi.muted);w3_show_hide('id-mute-yes',kiwi.muted);}
function panel_set_vis_button(id){var el=w3_el(id);var vis=w3_el(id+'-vis');var visOffset=el.activeWidth-visIcon;vis.style.left=px(visOffset+visBorder);}
function panel_set_width_height(id,width,height){var panel=w3_el(id);if(width==undefined)
width=panel.defaultWidth;panel.style.width=px(width);panel.uiWidth=width;if(height==undefined)
height=panel.defaultHeight;panel.style.height=px(height);panel.uiHeight=height;var border_pad=html_LR_border_pad(panel);panel.activeWidth=panel.uiWidth-border_pad;panel_set_vis_button(id);}
function add_problem(what,append,sticky,el_id){var id=el_id?el_id:'id-status-problems'
el=w3_el(id);if(!el)return;if(isDefined(el.children)){for(var i=0;i<el.children.length;i++){if(el.children[i].innerHTML==what){return;}}
if(append==false){while(el.firstChild){el.removeChild(el.firstChild);}}}
var new_span=w3_create_appendElement(el,"span",what);if(sticky!=true){window.setTimeout(function(ps,ns){try{ps.removeChild(ns);}catch(ex){}},1000,el,new_span);}}
function set_gen(freq,attn_ampl){snd_send("SET genattn="+attn_ampl.toFixed(0));snd_send("SET gen="+freq+" mix=-1");}
var bin_server=0;var zoom_server=0;function owrx_msg_cb(param,ws){switch(param[0]){case"wf_setup":wf_init();break;case"extint_list_json":extint_list_json(param[1]);if(override_ext){w3_do_when_cond(function(){return waterfall_setup_done;},function(){extint_open(override_ext,3000);},null,200);}
break;case"bandwidth":bandwidth=parseInt(param[1]);break;case"center_freq":center_freq=parseInt(param[1]);break;case"wf_fft_size":wf_fft_size=parseInt(param[1]);break;case"wf_fps_max":wf_fps_max=parseInt(param[1]);break;case"wf_fps":wf_fps=parseInt(param[1]);break;case"wf_cal":wf.cal=parseInt(param[1]);break;case"start":bin_server=parseInt(param[1]);break;case"zoom":zoom_server=parseInt(param[1]);break;case"zoom_max":zoom_levels_max=parseInt(param[1]);zoom_nom=Math.min(ZOOM_NOMINAL,zoom_levels_max);break;case"audio_init":toggle_or_set_audio(toggle_e.FROM_COOKIE|toggle_e.SET,1);audio_init(+param[1],btn_less_buffering,kiwi_toggle(toggle_e.FROM_COOKIE|toggle_e.SET,1,1,'last_compression'));break;case"audio_camp":var p=param[1].split(',');audio_camp(+p[0],+p[1],false,false);break;case"audio_rate":audio_rate(parseFloat(param[1]));break;case"audio_adpcm_state":var p=param[1].split(',');audio_adpcm_state(+p[0],+p[1]);break;case"audio_passband":var p=param[1].split(',');audio_recompute_LPF(1,+p[0],+p[1]);break;case"audio_flags2":audio_recv_flags2(param[1]);break;case"kiwi_up":kiwi_up(parseInt(param[1]));break;case"gps":toggle_or_set_spec(toggle_e.SET,spec.RF);break;case"fft_mode":kiwi_fft_mode();break;case"maxdb":wf.auto_maxdb=+param[1];setmaxdb(1,wf.auto_maxdb,true);break;case"mindb":wf.auto_mindb=+param[1];setmindb(1,wf.auto_mindb,true);w3_call('waterfall_maxmin_cb');update_maxmindb_sliders(true);break;case"max_thr":owrx.overload_mute=Math.round(+param[1]);break;case"freq_offset":break;case"last_community_download":dx.last_community_download=decodeURIComponent(param[1]);break;case"rf_attn":rf_attn_cb(null,+param[1],false,false,true);break;default:return false;}
return true;}
function owrx_ws_open_snd(cb,cbp){ws_snd=open_websocket('SND',cb,cbp,owrx_msg_cb,audio_recv,on_ws_error,owrx_close_cb);return ws_snd;}
function owrx_ws_open_wf(cb,cbp){ws_wf=open_websocket('W/F',cb,cbp,owrx_msg_cb,waterfall_add_queue,on_ws_error);return ws_wf;}
function owrx_close_cb(){toggle_or_set_rec(0);}
function on_ws_error(){console.log("WebSocket error");}
function snd_send(s){try{ws_snd.send(s);return 0;}catch(ex){console.log("CATCH snd_send('"+s+"') ex="+ex);kiwi_trace();return-1;}}
function wf_send(s){try{ws_wf.send(s);return 0;}catch(ex){console.log("CATCH wf_send('"+s+"') ex="+ex);kiwi_trace();return-1;}}
function ws_any(){if(ws_snd)return ws_snd;if(ws_wf)return ws_wf;return null;}
var need_geo=true;var need_status=true;function send_keepalive(){for(var i=0;i<1;i++){if(!ws_snd.up||snd_send("SET keepalive")<0)
break;if(need_geo&&kiwi_geo()!=""){if(msg_send("SET geoloc="+kiwi_geo())<0)
break;if(msg_send("SET geojson="+kiwi_geojson())<0)
break;need_geo=false;}
if(send_ident){if(!ident_user)ident_user='';if(snd_send("SET ident_user="+encodeURIComponent(ident_user))<0)
break;send_ident=false;}
if(need_status){if(snd_send("SET need_status=1")<0)
break;need_status=false;}}
if(!ws_wf.up||wf_send("SET keepalive")<0)
return;}





/* web/openwebrx/audio.min.js (web/openwebrx/audio.js = Sun Sep 10 17:48:59 2023) */
var audio={d:false,last_flags:0,trim_bufs:false,buffer_size:8192,lo_cut:0,hi_cut:0,SND_FLAG_LPF:0x0001,SND_FLAG_ADC_OVFL:0x0002,SND_FLAG_NEW_FREQ:0x0004,SND_FLAG_MODE_IQ:0x0008,SND_FLAG_COMPRESSED:0x0010,SND_FLAG_RESTART:0x0020,SND_FLAG_SQUELCH_UI:0x0040,SND_FLAG_LITTLE_ENDIAN:0x0080,SND_FLAG_SET_ACTIVE:0x0100,SND_FLAG_CLR_ACTIVE:0x0200,SND_FLAG_TUNE_ACK:0x0400,cur_flags2:0,last_msec:0,_last:0};var audio_periodic_interval_ms=1000;var audio_ext_sequence=0;var audio_meas_dly_ena=0;var audio_initial_connect=false;var audio_watchdog_restart=false;var audio_stat_input_size=0;var audio_stat_total_input_size=0;var audio_reconnect=0;var audio_silence_count=0;var audio_restart_count=0;var audio_stat_output_bufs;var audio_underrun_errors=0;var audio_overrun_errors=0;var audio_last_underruns=0;var audio_last_reconnect=0;var audio_last_restart_count=0;var audio_stat_last_time;var audio_running;var audio_started;var audio_last_output_offset;var audio_mode_iq;var audio_compression;var audio_use_first_sent_comp_value=false;var audio_stat_input_epoch;var audio_prepared_buffers;var audio_prepared_buffers2;var audio_prepared_seq;var audio_prepared_flags;var audio_prepared_smeter;var audio_buffering;var audio_convolver_running;var audio_meas_dly;var audio_meas_dly_start;var resample_new_default=false;var resample_new;var resample_old;var resample_init1;var resample_init2;var resample_input_buffer;var resample_input_available;var resample_input_processed;var resample_last_taps_delay;var resample_output_buffer;var resample_output_buffer2;var resample_output_size;var resample_taps;var resample_taps_length;var resample_last;var resample_last2;var audio_adpcm={index:0,previousValue:0};var audio_ext_adc_ovfl;var audio_need_stats_reset;var audio_change_LPF_latch;var audio_change_freq_latch;var audio_change_sq_UI_latch;var audio_last_sq;var audio_panner=null;var audio_gain;var audio_instance=0;var audio_camping=0;var audio_init_disconnect=0;var comp_lpf_freq;var comp_lpf_taps;var comp_lpf_taps_length;var audio_buffer_size;var audio_buffer_min_length_sec;var audio_buffer_max_length_sec;var audio_data,audio_data_unsquelched;var audio_last_output_buffer,audio_last_output_buffer2;var audio_silence_buffer;var audio_stats_interval;var audio_periodic_interval;var audio_context;var audio_output_rate;var audio_last_is_local,audio_last_compression;var audio_input_rate;var audio_interpolation;var audio_decimation;var audio_resample_ratio;var audio_transition_bw;var audio_min_nbuf;var audio_max_nbuf;var audio_stat_output_epoch;var audio_channels;var audio_source;var audio_watchdog;var audio_firefox_watchdog=0;var audio_change_LPF_delayed;var audio_disconnected;var audio_convolver;function audio_camp(disconnect,is_local,less_buffering,compression){audio_use_first_sent_comp_value=true;audio_camping=disconnect?0:1;audio_init_disconnect=disconnect;audio_init(is_local,less_buffering,compression);audio_ext_sequence=0;audio_meas_dly_ena=0;audio_initial_connect=false;audio_watchdog_restart=false;;}
function audio_reset(){audio.trim_bufs=true;}
function audio_init(is_local,less_buffering,compression){audio_running=false;kiwi_clearInterval(audio_periodic_interval);console.log('--------------------------');if(audio.d)console.log('AUDIO audio_init CALLED audio_init_disconnect='+audio_init_disconnect+' is_local='+is_local+' less_buffering='+less_buffering+' compression='+compression);less_buffering=false;if(audio.d)console.log('AUDIO audio_init LAST audio_last_is_local='+audio_last_is_local+' audio_last_compression='+audio_last_compression);if(is_local==null)is_local=audio_last_is_local;audio_last_is_local=is_local;if(compression==null)compression=audio_last_compression;audio_last_compression=compression;console.log('AUDIO audio_init FINAL is_local='+is_local+' less_buffering='+less_buffering+' compression='+compression);if(audio_init_disconnect||audio_source!=undefined){if(audio.d)console.log('AUDIO audio_init audio_disconnect');audio_disconnect();}
audio_started=false;audio_last_output_offset=0;audio_mode_iq=false;audio_compression=compression?true:false;audio_stat_input_epoch=-1;audio_prepared_buffers=[];audio_prepared_buffers2=[];audio_prepared_seq=[];audio_prepared_flags=[];audio_prepared_smeter=[];audio_buffering=false;audio_convolver_running=false;audio_meas_dly=0;audio_meas_dly_start=0;resample_new=kiwi_isMobile()?false:resample_new_default;resample_old=!resample_new;resample_init1=false;resample_init2=false;resample_input_buffer=[];resample_input_available=0;resample_input_processed=0;resample_last_taps_delay=0;resample_output_buffer=[];resample_output_buffer2=[];resample_taps=[];resample_last=0;resample_last2=0;comp_lpf_freq=0;comp_lpf_taps=[];comp_lpf_taps_length=255;audio_adpcm.index=0;audio_adpcm.previousValue=0;audio_ext_adc_ovfl=false;audio_need_stats_reset=true;audio_change_LPF_latch=false;audio_change_freq_latch=false;audio_change_sq_UI_latch=false;audio_last_sq=undefined;audio_firefox_watchdog=0;kiwi_clearInterval(audio_stats_interval);if(audio_init_disconnect){if(audio.d)console.log('AUDIO audio_init DISCONNECT');audio_init_disconnect=0;return false;}
var buffering_scheme=0;var scheme_s;var a=kiwi_url_param('abuf',null,null);var abuf=0;if(a!=null){var a2=a.split(',');abuf=parseFloat(a2[0]);if(!isNaN(abuf)&&abuf>=0.25&&abuf<=5.0){console.log('AUDIO override abuf='+a);var max=abuf*3;if(a2.length>=2){var m=parseFloat(a2[1]);if(!isNaN(m)&&m>=0.25&&m<=5.0&&m>abuf){max=m;}}else{max=abuf*3;}
audio_buffer_min_length_sec=abuf;audio_buffer_max_length_sec=max;audio_buffer_size=audio.buffer_size;buffering_scheme=9;scheme_s='abuf=';}else{abuf=0;}}
if(abuf==0){if(less_buffering){if(is_local)
buffering_scheme=2;else
buffering_scheme=1;}else{buffering_scheme=0;}
if(buffering_scheme==2){audio_buffer_size=audio.buffer_size;audio_buffer_min_length_sec=0.37;audio_buffer_max_length_sec=2.00;scheme_s='less buf, local';}else
if(buffering_scheme==1){audio_buffer_size=audio.buffer_size;audio_buffer_min_length_sec=0.74;audio_buffer_max_length_sec=3.00;scheme_s='less buf, remote';}else
if(buffering_scheme==0){audio_buffer_size=audio.buffer_size;audio_buffer_min_length_sec=0.85;audio_buffer_max_length_sec=3.40;scheme_s='more buf';}}
audio_data=new Int16Array(audio_buffer_size);audio_data_unsquelched=new Int16Array(audio_buffer_size);audio_last_output_buffer=new Float32Array(audio_buffer_size)
audio_last_output_buffer2=new Float32Array(audio_buffer_size)
audio_silence_buffer=new Float32Array(audio_buffer_size);console.log('AUDIO buffer_size='+audio_buffer_size+' buffering_scheme: '+scheme_s);audio_stats_interval=setInterval(audio_stats,1000);try{window.AudioContext=window.AudioContext||window.webkitAudioContext;audio_context=new AudioContext();audio_context.sampleRate=44100;audio_output_rate=audio_context.sampleRate;try{audio_panner=audio_context.createStereoPanner();audio_panner_ui_init();}catch(e){audio_panner=null;}
if(kiwi_isSmartTV()=='LG')audio_gain=audio_context.createGain();}catch(e){kiwi_serious_error("Your browser does not support Web Audio API, which is required for OpenWebRX to run. Please use an HTML5 compatible browser.");audio_context=null;audio_output_rate=0;return true;}
audio_instance++;setTimeout(function(inst){snd_send('SET little-endian');},10000,audio_instance);audio_running=true;return false;}
function audio_rate(input_rate){audio_input_rate=input_rate;if(audio_input_rate==0){kiwi_debug("user's browser gave zero audio_input_rate?");kiwi_serious_error("Audio initialization problem.");}else
if(audio_output_rate==0){kiwi_debug("user's browser doesn't support WebAudio");kiwi_debug(""+navigator.userAgent);kiwi_serious_error("Browser doesn\'t support WebAudio:<br>"+navigator.userAgent+"<br><br>"+"Please update to the latest version of your browser.");}else{if(resample_old){audio_interpolation=audio_output_rate / audio_input_rate;audio_decimation=1;}else{audio_interpolation=0;if(audio_interpolation==0){var interp,i_decim;for(interp=2;interp<=1024;interp++){var decim=(input_rate*interp)/ audio_output_rate;i_decim=Math.floor(decim);var frac=Math.abs(decim-i_decim);if(frac<0.00001)break;}
if(interp>1024){snd_send("SET UAR in="+input_rate+" out="+audio_output_rate);kiwi_serious_error("Your system uses an audio output rate of "+audio_output_rate+" sps which we do not support.");}else{audio_interpolation=interp;audio_decimation=i_decim;}}}}
if(audio_interpolation!=0){audio_transition_bw=0.001;audio_resample_ratio=audio_output_rate / audio_input_rate;snd_send("SET AR OK in="+input_rate+" out="+audio_output_rate);}else{audio_resample_ratio=1;}
audio_min_nbuf=Math.ceil((audio_buffer_min_length_sec*audio_output_rate)/ audio_buffer_size);audio_max_nbuf=Math.ceil((audio_buffer_max_length_sec*audio_output_rate)/ audio_buffer_size);console.log('AUDIO audio_input_rate='+audio_input_rate+' audio_output_rate='+audio_output_rate);console.log('AUDIO min_length_sec='+audio_buffer_min_length_sec+'('+audio_min_nbuf+' bufs) max_length_sec='+audio_buffer_max_length_sec+'('+audio_max_nbuf+' bufs)');}
function audio_start(){if(audio.d)console.log('AUDIO audio_start');if(audio_context==null)return;audio_started=true;audio_connect(0);audio_periodic_interval=setInterval(audio_periodic,audio_periodic_interval_ms);try{var mode=isArg(init_mode)?init_mode:'am';demodulator_analog_replace(mode);}catch(ex){kiwi_debug("audio_start.demodulator_analog_replace: catch: "+ex.toString());}}
function audio_disconnect(){if(audio.d)console.log('AUDIO audio_disconnect');if(audio_source){audio_disconnected=true;audio_source.disconnect();audio_source.onaudioprocess=null;audio_source=null;}
if(audio_convolver_running){audio_convolver.disconnect();audio_convolver_running=false;}
if(audio_watchdog){audio_watchdog.disconnect();audio_watchdog.onaudioprocess=null;audio_watchdog=null;}
if(audio_panner){audio_panner.disconnect();}}
function audio_connect_destination(src){if(kiwi_isSmartTV()=='LG'){audio_gain.gain.value=0.3;src.connect(audio_gain);src=audio_gain;}
if(audio_panner){src.connect(audio_panner);audio_panner.connect(audio_context.destination);}else{src.connect(audio_context.destination);}}
function audio_set_pan(pan){if(audio_panner){try{audio_panner.pan.value=pan;}catch(ex){}}}
function audio_connect(reconnect){if(audio_context==null)return;if(!audio_initial_connect&&reconnect){return;}
if(!reconnect)audio_initial_connect=true;if(reconnect){audio_disconnect();resample_init1=resample_init2=false;audio_reconnect++;kiwi_log('AUDIO reconnect BUFFERING true');audio_buffering=true;}
audio_stat_output_epoch=-1;audio_change_LPF_delayed=false;audio_source=audio_context.createScriptProcessor(audio_buffer_size,0,audio_channels);audio_source.onaudioprocess=audio_onprocess;audio_disconnected=false;if(audio_convolver_running){audio_source.connect(audio_convolver);audio_connect_destination(audio_convolver);}else{audio_connect_destination(audio_source);}
if(kiwi_isFirefox()){audio_watchdog=audio_context.createScriptProcessor(audio_buffer_size,audio_channels,0);audio_watchdog.onaudioprocess=audio_watchdog_process;if(audio_convolver_running)
audio_convolver.connect(audio_watchdog);else
audio_source.connect(audio_watchdog);}
audio_pre_record_buf_init();}
function audio_watchdog_process(ev){if(kiwi.muted||audio_buffering){audio_silence_count=0;return;}
var silence_buf=ev.inputBuffer.getChannelData(0);var silent=(silence_buf[0]==0);if(kiwi_gc_snd)silence_buf=null;audio_silence_count=silent?audio_silence_count+1:0;if(audio_silence_count>16){audio_connect(1);audio_silence_count=0;audio_restart_count++;add_problem("FF silence");kiwi_log('AUDIO FF SILENCE');}}
function audio_onprocess(ev){audio_firefox_watchdog++;if(audio_disconnected)return;if(audio_stat_output_epoch==-1){audio_stat_output_epoch=(new Date()).getTime();audio_stat_output_bufs=0;}
audio_stat_output_bufs++;if(audio_started&&audio_prepared_buffers.length==0){audio_underrun_errors++;audio_buffering=true;}
if(!audio_started||audio_buffering){audio_need_stats_reset=true;ev.outputBuffer.copyToChannel(audio_silence_buffer,0);if(audio_channels==2)ev.outputBuffer.copyToChannel(audio_silence_buffer,1);return;}
ev.outputBuffer.copyToChannel(audio_prepared_buffers.shift(),0);if(audio_channels==2)ev.outputBuffer.copyToChannel(audio_prepared_buffers2.shift(),1);audio_ext_sequence=audio_prepared_seq.shift();if(audio_change_LPF_delayed){audio_recompute_LPF(0);audio_change_LPF_delayed=false;}
owrx.sMeter_dBm_biased=audio_prepared_smeter.shift()/ 10;owrx.sMeter_dBm=owrx.sMeter_dBm_biased-SMETER_BIAS;var flags=audio_prepared_flags.shift();audio_ext_adc_ovfl=(flags&audio.SND_FLAG_ADC_OVFL)?true:false;if(flags&audio.SND_FLAG_LPF){audio_change_LPF_delayed=true;}
var sq=(flags&audio.SND_FLAG_SQUELCH_UI)?true:false;if(sq!=audio_last_sq&&isDefined(squelch_action)){setTimeout(function(_sq){squelch_action(_sq);},1,sq);audio_last_sq=sq;}
if(flags&audio.SND_FLAG_TUNE_ACK){setTimeout(function(tune_freq){w3_call('ale_2g_tune_ack',tune_freq);},10,audio.tune_freq);}
if(audio_meas_dly_ena&&audio_meas_dly_start&&(flags&audio.SND_FLAG_NEW_FREQ)){audio_meas_dly=(new Date()).getTime()-audio_meas_dly_start;kiwi_log('AUDIO dly='+audio_meas_dly);audio_meas_dly_start=0;}}
var audio_watchdog_restart_cnt=0;function audio_periodic(){if(audio_context.state!='running'){while(audio_prepared_buffers.length>0){audio_prepared_buffers.shift();if(audio_channels==2)audio_prepared_buffers2.shift();audio_prepared_seq.shift();audio_prepared_flags.shift();audio_prepared_smeter.shift();}
return;}
if(audio_started&&audio_prepared_buffers.length&&audio_firefox_watchdog==0&&kiwi_isFirefox()&&!cfg.disable_recent_changes){add_problem("FF watchdog");console.log('AUDIO FF WATCHDOG Q'+audio_prepared_buffers.length+' WD='+audio_firefox_watchdog+' ============================================');audio_init(null,false,null);audio_initial_connect=false;audio_watchdog_restart=true;snd_send("SET reinit");}
var overran=false;while(audio_prepared_buffers.length>audio_max_nbuf){overran=true;audio_prepared_buffers.shift();if(audio_channels==2)audio_prepared_buffers2.shift();audio_prepared_seq.shift();audio_prepared_flags.shift();audio_prepared_smeter.shift();}
if(overran){add_problem("audio overrun");audio_overrun_errors++;}
if(audio_last_underruns!=audio_underrun_errors){add_problem("audio underrun");snd_send("SET underrun="+audio_underrun_errors);audio_last_underruns=audio_underrun_errors;}}
function audio_adpcm_state(index,previousValue){audio_adpcm.index=index;audio_adpcm.previousValue=previousValue;audio_camping=2;}
function audio_pre_record_buf_init(){if(pre_record==0||isUndefined(cur_mode)){kiwi.pre_buf=null;return;}
var srate=Math.round(audio_input_rate||12000);var nch=ext_is_IQ_or_stereo_curmode()?2:1;var secs=pre_record_v[pre_record]+1;var pre_samps=Math.round(secs*nch*srate);if(pre_samps&1)pre_samps++;console.log('AUDIO pre_record init: samps='+pre_samps+' time='+pre_record_v[pre_record]);kiwi.pre_samps=pre_samps;kiwi.pre_size=pre_samps*2;kiwi.pre_last=kiwi.pre_size-2;kiwi.pre_buf=new ArrayBuffer(kiwi.pre_size);kiwi.pre_data=new DataView(kiwi.pre_buf);kiwi.pre_off=0;kiwi.pre_wrapped=false;kiwi.pre_captured=false;kiwi.pre_ping_pong=0;}
function audio_recv(data,ws,firstChars){if(!audio_running)return;if(firstChars!='SND'){var spec=new Uint8Array(data,5);spectrum_update(spec);return;}
var h8=new Uint8Array(data,0,8);var flags=h8[3];var squelched=flags&audio.SND_FLAG_SQUELCH_UI;var seq=(h8[7]<<24)|(h8[6]<<16)|(h8[5]<<8)|h8[4];if(audio_camping==1&&(flags&audio.SND_FLAG_COMPRESSED))return;if(audio_camping&&audio_use_first_sent_comp_value){audio_compression=(flags&audio.SND_FLAG_COMPRESSED)?true:false;audio_use_first_sent_comp_value=false;}
var sm8=new Uint8Array(data,8,2);var smeter=(sm8[0]<<8)|sm8[1];var isIQ=(flags&audio.SND_FLAG_MODE_IQ);var offset=isIQ?20:10;var data_view=new DataView(data,offset);var bytes=data_view.byteLength;var i,samps;if(audio_watchdog_restart){if(!(flags&audio.SND_FLAG_RESTART))return;audio_watchdog_restart=false;audio_prepared_buffers=[];audio_prepared_buffers2=[];audio_prepared_seq=[];audio_prepared_flags=[];audio_prepared_smeter=[];if(audio_mode_iq){resample_new=false;resample_old=!resample_new;}else{audio_adpcm.index=audio_adpcm.previousValue=0;resample_new=kiwi_isMobile()?false:resample_new_default;resample_old=!resample_new;}
audio_connect(1);}else
if(isIQ){if(!audio_mode_iq){audio_prepared_buffers=[];audio_prepared_buffers2=[];audio_prepared_seq=[];audio_prepared_flags=[];audio_prepared_smeter=[];resample_new=false;resample_old=!resample_new;audio_mode_iq=true;audio_channels=2;if(audio.d)console.log('AUDIO !IQ -> IQ transition');audio_connect(1);}
audio_last_compression=audio_compression=false;audio_mode_iq=true;}else{var compressed=(flags&audio.SND_FLAG_COMPRESSED)?true:false;if(audio_mode_iq||(audio_compression!=compressed)){audio_prepared_buffers=[];audio_prepared_buffers2=[];audio_prepared_seq=[];audio_prepared_flags=[];audio_prepared_smeter=[];audio_adpcm.index=audio_adpcm.previousValue=0;resample_new=kiwi_isMobile()?false:resample_new_default;resample_old=!resample_new;if(audio.d){if(audio_mode_iq)
console.log('AUDIO IQ -> !IQ transition, compressed='+compressed);else
console.log('AUDIO !IQ, compression change='+(audio_compression!=compressed)+' compressed='+compressed);}
audio_mode_iq=false;audio_channels=1;audio_last_compression=audio_compression=compressed;audio_connect(1);}
audio_last_compression=audio_compression=compressed;audio_mode_iq=false;}
audio_channels=audio_mode_iq?2:1;if(audio_compression){if(audio.d){var now=Date.now();var msec=now-audio.last_msec;audio.last_msec=now;console.log('AC Q'+audio_prepared_buffers.length+' '+audio_channels+'ch '+msec);}
decode_ima_adpcm_e8_i16(data_view,audio_data,audio_data_unsquelched,squelched,bytes,audio_adpcm);samps=bytes*2;}else{if(audio.d){var now=Date.now();var msec=now-audio.last_msec;audio.last_msec=now;if(isIQ)
console.log('ANC IQ Q'+audio_prepared_buffers.length+'/'+audio_prepared_buffers2.length+' '+audio_channels+'ch '+msec);else
console.log('ANC Q'+audio_prepared_buffers.length+' '+audio_channels+'ch '+msec);}
samps=bytes/2;for(i=0;i<samps;i++){audio_data_unsquelched[i]=data_view.getInt16(i*2,(flags&audio.SND_FLAG_LITTLE_ENDIAN)?true:false);audio_data[i]=squelched?1:audio_data_unsquelched[i];}}
audio_prepare(audio_data,samps,seq,flags,smeter);if(!audio_started){var enough_buffered=audio_prepared_buffers.length>audio_min_nbuf;if(enough_buffered)
audio_start();}
if(audio_need_stats_reset)
audio_stats_reset();audio_stat_input_size+=samps;audio_stat_total_input_size+=samps;extint_audio_data(audio_data,samps);if(wf.audioFFT_active){wf_audio_FFT(audio_data,samps);}
audio_record(audio_compression);}
function audio_record(compressed){var samples=audio_mode_iq?1024:(compressed?2048:512);var pre_record_buffer=function(){if(!kiwi.pre_buf)return;for(var i=0;i<samples;i++){var samp=audio_data_unsquelched[i];kiwi.pre_data.setInt16(kiwi.pre_off,samp,true);kiwi.pre_off+=2;if(kiwi.pre_off>=kiwi.pre_size){kiwi.pre_off=0;kiwi.pre_wrapped=true;kiwi.pre_ping_pong^=1;}}
kiwi.pre_captured=true;}
if(window.recording){var check_grow=function(){if(window.recording_meta.offset==65536){window.recording_meta.buffers.push(new ArrayBuffer(65536));window.recording_meta.data=new DataView(window.recording_meta.buffers[window.recording_meta.buffers.length-1]);window.recording_meta.offset=0;}};if(audio_last_sq==true){pre_record_buffer();}else{if(kiwi.pre_captured){if(kiwi.pre_wrapped){console.log('AUDIO pre_record WRAPPED insert pre_off='+kiwi.pre_off+' '+
(kiwi.pre_size-kiwi.pre_off)+'+'+kiwi.pre_off+'='+kiwi.pre_size+' ping_pong='+kiwi.pre_ping_pong);for(var i=kiwi.pre_off;i<kiwi.pre_size;i+=2){var samp=kiwi.pre_data.getInt16(i,true);window.recording_meta.data.setInt16(window.recording_meta.offset,samp,true);window.recording_meta.offset+=2;check_grow();}
window.recording_meta.total_size+=kiwi.pre_size-kiwi.pre_off;for(var i=0;i<kiwi.pre_off;i+=2){var samp=kiwi.pre_data.getInt16(i,true);window.recording_meta.data.setInt16(window.recording_meta.offset,samp,true);window.recording_meta.offset+=2;check_grow();}
window.recording_meta.total_size+=kiwi.pre_off;}else{console.log('AUDIO pre_record NOT-WRAPPED insert pre_off='+kiwi.pre_off+'/'+kiwi.pre_size+' ping_pong='+kiwi.pre_ping_pong);for(var i=0;i<kiwi.pre_off;i+=2){var samp=kiwi.pre_data.getInt16(i,true);window.recording_meta.data.setInt16(window.recording_meta.offset,samp,true);window.recording_meta.offset+=2;check_grow();}
window.recording_meta.total_size+=kiwi.pre_off;}
kiwi.pre_off=0;kiwi.pre_wrapped=false;kiwi.pre_captured=false;kiwi.pre_ping_pong=0;}
for(var i=0;i<samples;++i){window.recording_meta.data.setInt16(window.recording_meta.offset,audio_data[i],true);window.recording_meta.offset+=2;check_grow();}
window.recording_meta.total_size+=samples*2;}}else{pre_record_buffer();}}
function audio_recv_flags2(p){var ap=p.split(':');switch(ap[0]){case'active':var active=+ap[1];console.log('$ active='+active);audio.cur_flags2|=active?audio.SND_FLAG_SET_ACTIVE:SND_FLAG_CLR_ACTIVE;break;case'tune_ack':audio.tune_freq=+ap[1];console.log('$ tune_ack='+audio.tune_freq);audio.cur_flags2|=audio.SND_FLAG_TUNE_ACK;break;}}
var audio_push_ct=0;function audio_prepare(data,data_len,seq,flags,smeter){var resample_new_decomp=resample_new&&audio_compression&&comp_lpf_taps_length;var dopush=function(){audio_prepared_buffers.push(audio_last_output_buffer);if(audio_channels==2)audio_prepared_buffers2.push(audio_last_output_buffer2);audio_prepared_seq.push(seq);if(audio_change_LPF_latch){audio_change_LPF_latch=false;flags|=audio.SND_FLAG_LPF;}
if(audio_change_freq_latch){audio_change_freq_latch=false;flags|=audio.SND_FLAG_NEW_FREQ;}
if(audio_change_sq_UI_latch){audio_change_sq_UI_latch=false;flags|=audio.SND_FLAG_SQUELCH_UI;}
if(audio.cur_flags2){flags|=audio.cur_flags2;audio.cur_flags2=0;}
audio_prepared_flags.push(flags);audio_prepared_smeter.push(smeter);audio_last_output_offset=0;audio_last_output_buffer=new Float32Array(audio_buffer_size);if(audio_channels==2)audio_last_output_buffer2=new Float32Array(audio_buffer_size);};var copy=function(d,di,s,si,len){var i;for(i=0;i<len;i++)d[di+i]=s[si+i];};var idata,idata2,idata_length;if(data_len==0)return;if(audio_resample_ratio!=1){if(!resample_init1){resample_taps_length=Math.round(4.0/audio_transition_bw);if(resample_taps_length%2==0)resample_taps_length++;rational_resampler_get_lowpass_f(resample_taps,resample_taps_length,audio_interpolation,audio_decimation);resample_init1=true;}
if(!resample_init2&&resample_init1&&(resample_new_decomp||resample_old)&&(audio_source!=undefined)){var lpf_taps,lpf_taps_length;audio_recompute_LPF(1);lpf_taps=comp_lpf_taps;lpf_taps_length=comp_lpf_taps_length;audio_convolver=audio_context.createConvolver();audio_convolver.normalize=false;audio_reload_convolver_buffer(lpf_taps,lpf_taps_length);if(audio.d)console.log('AUDIO splice in convolver');audio_source.disconnect();audio_source.connect(audio_convolver);audio_connect_destination(audio_convolver);if(kiwi_isFirefox()){audio_convolver.connect(audio_watchdog);}
audio_convolver_running=true;resample_init2=true;}
if(resample_old){if(audio_channels==2){resample_output_size=Math.round(data_len/2*audio_resample_ratio);var incr=1.0 / audio_resample_ratio;var di=0;var frac=0;var xc,xc2,xl;for(i=0;i<resample_output_size;i++){xc=data[di*2];xl=resample_last;resample_output_buffer[i]=(xc-xl)*frac+xl;xc2=data[di*2+1];xl=resample_last2;resample_output_buffer2[i]=(xc2-xl)*frac+xl;frac+=incr;if(frac>=1){frac-=1;resample_last=xc;resample_last2=xc2;di++;}}
resample_last=xc;resample_last2=xc2;}else{resample_output_size=Math.round(data_len*audio_resample_ratio);var incr=1.0 / audio_resample_ratio;var di=0;var frac=0;var xc,xl;for(i=0;i<resample_output_size;i++){xc=data[di];xl=resample_last;resample_output_buffer[i]=(xc-xl)*frac+xl;frac+=incr;if(frac>=1){frac-=1;resample_last=xc;di++;}}
resample_last=xc;}}else{if(resample_input_processed!=0){var new_available=resample_input_available-resample_input_processed;copy(resample_input_buffer,0,resample_input_buffer,resample_input_processed,new_available);resample_input_available=new_available;resample_input_processed=0;}
copy(resample_input_buffer,resample_input_available,data,0,data_len);resample_input_available+=data_len;if(audio_channels==2){rational_resampler_cc(resample_input_buffer,resample_output_buffer,resample_output_buffer2,resample_input_available,audio_interpolation,audio_decimation,resample_taps,resample_taps_length,resample_last_taps_delay);}else{rational_resampler_ff(resample_input_buffer,resample_output_buffer,resample_input_available,audio_interpolation,audio_decimation,resample_taps,resample_taps_length,resample_last_taps_delay);}}
idata=resample_output_buffer;idata2=resample_output_buffer2;idata_length=resample_output_size;}else{idata=data;idata_length=data_len;}
if(flags&audio.SND_FLAG_LPF){audio_change_LPF_latch=true;}
if((flags&audio.SND_FLAG_NEW_FREQ)||audio.trim_bufs){audio_change_freq_latch=true;audio.trim_bufs=false;var len=audio_prepared_buffers.length;var min=audio_min_nbuf;var pop=(len>min)?(len-min):0;while(audio_prepared_buffers.length>min){audio_prepared_buffers.pop();if(audio_channels==2)audio_prepared_buffers2.pop();audio_prepared_seq.pop();audio_prepared_flags.pop();audio_prepared_smeter.pop();}}
if(flags&audio.SND_FLAG_SQUELCH_UI){audio_change_sq_UI_latch=true;}
if(audio_last_output_offset+idata_length<=audio_buffer_size){if(audio_channels==2){for(var i=0;i<idata_length;i++){audio_last_output_buffer[i+audio_last_output_offset]=idata[i]/ 32768*kiwi.volume_f;audio_last_output_buffer2[i+audio_last_output_offset]=idata2[i]/ 32768*kiwi.volume_f;}}else{for(var i=0;i<idata_length;i++)
audio_last_output_buffer[i+audio_last_output_offset]=idata[i]/ 32768*kiwi.volume_f;}
audio_last_output_offset+=idata_length;if(audio_last_output_offset==audio_buffer_size)dopush();}else{var copied=audio_buffer_size-audio_last_output_offset;var remain=idata_length-copied;if(audio_channels==2){for(var i=0;i<audio_buffer_size-audio_last_output_offset;i++){audio_last_output_buffer[i+audio_last_output_offset]=idata[i]/ 32768*kiwi.volume_f;audio_last_output_buffer2[i+audio_last_output_offset]=idata2[i]/ 32768*kiwi.volume_f;}}else{for(var i=0;i<audio_buffer_size-audio_last_output_offset;i++)
audio_last_output_buffer[i+audio_last_output_offset]=idata[i]/ 32768*kiwi.volume_f;}
dopush();do{var i;for(i=0;i<remain;i++){if(i==audio_buffer_size){dopush();break;}
audio_last_output_buffer[i]=idata[i+copied]/ 32768*kiwi.volume_f;if(audio_channels==2)audio_last_output_buffer2[i]=idata2[i+copied]/ 32768*kiwi.volume_f;}
remain-=i;copied+=i;}while(remain);audio_last_output_offset+=i;}
if(audio_buffering){var enough_buffered=audio_prepared_buffers.length>audio_min_nbuf;if(enough_buffered){audio_buffering=false;}}}
try{if(!AudioBuffer.prototype.copyToChannel){AudioBuffer.prototype.copyToChannel=function(input,channel){var cd=this.getChannelData(channel);for(var i=0;i<input.length;i++)cd[i]=input[i];}}}catch(ex){console.log("CATCH: AudioBuffer.prototype.copyToChannel");}
function audio_stats_reset(){audio_stat_input_epoch=(new Date()).getTime();audio_stat_last_time=audio_stat_input_epoch;audio_stat_input_size=audio_stat_total_input_size=0;audio_need_stats_reset=false;}
function audio_stats(){if(audio_stat_input_epoch==-1||audio_stat_output_epoch==-1)
return;var time_now=(new Date()).getTime();var secs_since_last_call=(time_now-audio_stat_last_time)/1000;var secs_since_reset=(time_now-audio_stat_input_epoch)/1000;var secs_since_first_output=(time_now-audio_stat_output_epoch)/1000;audio_stat_last_time=time_now;var net_sps=audio_stat_input_size / secs_since_last_call;var net_avg=audio_stat_total_input_size / secs_since_reset;var out_sps=(audio_stat_output_bufs*audio_buffer_size)/ secs_since_first_output;if(audio.d){var s="Audio: network "+
net_sps.toFixed(0)+" sps ("+
net_avg.toFixed(0)+" avg), output "+
out_sps.toFixed(0)+" sps";s+=', Qlen '+audio_prepared_buffers.length;if(audio_underrun_errors)s+=', underruns '+audio_underrun_errors.toString();if(audio_restart_count)s+=', restart '+audio_restart_count.toString();console.log(s);}
if(isNaN(out_sps))out_sps=0;w3_innerHTML('id-status-audio',w3_text('w3-text-css-orange','WF'),w3_text('',kiwi.wf_fps.toFixed(0)+' fps'),w3_text('w3-text-css-orange','Audio'),w3_text('',(out_sps/1000).toFixed(1)+'k, Qlen '+audio_prepared_buffers.length));audio_stat_input_size=0;}
function audio_recompute_LPF(force,lo_cut,hi_cut){if(isDefined(lo_cut)&&isDefined(hi_cut)){audio.lo_cut=Math.abs(lo_cut);audio.hi_cut=Math.abs(hi_cut);}
if(audio_camping){lo_cut=audio.lo_cut;hi_cut=audio.hi_cut;}else{if(isDefined(demodulators[0])){hi_cut=Math.abs(demodulators[0].high_cut);if(isNaN(hi_cut))console.log(demodulators[0]);lo_cut=Math.abs(demodulators[0].low_cut);}else{lo_cut=0,hi_cut=4000;}}
var lpf_freq=Math.max(hi_cut,lo_cut);if(force||lpf_freq!=comp_lpf_freq){var cutoff=lpf_freq / audio_output_rate;firdes_lowpass_f(comp_lpf_taps,comp_lpf_taps_length,cutoff);comp_lpf_freq=lpf_freq;if(audio_convolver_running){audio_reload_convolver_buffer(comp_lpf_taps,comp_lpf_taps_length);}}else{}}
function audio_reload_convolver_buffer(lpf_taps,lpf_taps_length){var audio_lpf_buffer=audio_context.createBuffer(2,lpf_taps_length,audio_output_rate);var audio_lpf=audio_lpf_buffer.getChannelData(0);audio_lpf.set(lpf_taps);audio_lpf=audio_lpf_buffer.getChannelData(1);audio_lpf.set(lpf_taps);audio_convolver.buffer=audio_lpf_buffer;}
function rational_resampler_ff(input,output,input_size,interpolation,decimation,taps,taps_length,last_taps_delay){var output_size=Math.round(input_size*interpolation/decimation);var i,oi;var startingi,delayi,last_delayi=-1;for(oi=0;oi<output_size;oi++){startingi=Math.floor((oi*decimation+interpolation-1-last_taps_delay)/ interpolation);delayi=Math.floor((last_taps_delay+startingi*interpolation-oi*decimation)%interpolation);if(startingi+taps_length/interpolation+1>input_size)
break;var end=Math.floor((taps_length-delayi)/ interpolation);var acc=0;for(i=0;i<end;i++){acc+=input[startingi+i]*taps[delayi+i*interpolation];}
output[oi]=acc*interpolation;}
resample_input_processed=startingi;resample_output_size=oi;resample_last_taps_delay=delayi;}
function rational_resampler_cc(input,outputI,outputQ,input_size,interpolation,decimation,taps,taps_length,last_taps_delay){console.log('WARNING rational_resampler_cc() not working yet!');return;}
function rational_resampler_get_lowpass_f(output,output_size,interpolation,decimation){var cutoff_for_interpolation=1.0/interpolation;var cutoff_for_decimation=1.0/decimation;var cutoff=(cutoff_for_interpolation<cutoff_for_decimation)?cutoff_for_interpolation:cutoff_for_decimation;firdes_lowpass_f(output,output_size,cutoff/2);}
function firdes_lowpass_f(output,length,cutoff_rate){var i;var middle=Math.floor(length/2);output[middle]=2*Math.PI*cutoff_rate*firdes_wkernel_hamming(0);for(i=1;i<=middle;i++){output[middle-i]=output[middle+i]=(Math.sin(2*Math.PI*cutoff_rate*i)/i)*firdes_wkernel_hamming(i/middle);}
var sum=0;for(i=0;i<length;i++){sum+=output[i];}
for(i=0;i<length;i++){output[i]/=sum;}}
function firdes_wkernel_hamming(rate){rate=0.5+rate/2;return 0.54-0.46*Math.cos(2*Math.PI*rate);}





/* web/openwebrx/ima_adpcm.min.js (web/openwebrx/ima_adpcm.js = Tue Sep 13 11:59:05 2022) */
var indexAdjustTable=[-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8];var stepSizeTable=[7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767];function ImaAdpcmDecode(deltaCode,state){var step=stepSizeTable[state.index];var difference=step>>3;if(deltaCode&1)difference+=step>>2;if(deltaCode&2)difference+=step>>1;if(deltaCode&4)difference+=step;if(deltaCode&8)difference=-difference;state.previousValue+=difference;if(state.previousValue>state.pos_clamp)state.previousValue=state.pos_clamp;else if(state.previousValue<state.neg_clamp)state.previousValue=state.neg_clamp;state.index+=indexAdjustTable[deltaCode];if(state.index<0)state.index=0;else if(state.index>88)state.index=88;return state.previousValue;}
function decode_ima_adpcm_e8_i16(input,output,output_unsquelched,squelched,input_length,state){state.pos_clamp=+32767;state.neg_clamp=-32768;var i,k=0;for(i=0;i<input_length;i++){var byte=input.getUint8(i);output_unsquelched[k]=ImaAdpcmDecode(byte&0xf,state);output[k]=squelched?1:output_unsquelched[k];k++;output_unsquelched[k]=ImaAdpcmDecode((byte>>4)&0xf,state);output[k]=squelched?1:output_unsquelched[k];k++;}}
function decode_ima_adpcm_e8_u8(input,output,input_length,state){state.pos_clamp=255;state.neg_clamp=0;var i,k=0;for(i=0;i<input_length;i++){output[k++]=ImaAdpcmDecode(input[i]&0xf,state);output[k++]=ImaAdpcmDecode((input[i]>>4)&0xf,state);}}





/* web/pkgs/w3color.min.js (web/pkgs/w3color.js = Tue Oct 12 08:26:57 2021) */
(function(){function w3color(color,elmnt){if(!(this instanceof w3color)){return new w3color(color,elmnt);}
if(typeof color=="object"){return color;}
this.attachValues(toColorObject(color));if(elmnt){elmnt.style.backgroundColor=this.toRgbString();}}
w3color.prototype={toRgbString:function(){return"rgb("+this.red+", "+this.green+", "+this.blue+")";},toRgbaString:function(){return"rgba("+this.red+", "+this.green+", "+this.blue+", "+this.opacity+")";},toHwbString:function(){return"hwb("+this.hue+", "+Math.round(this.whiteness*100)+"%, "+Math.round(this.blackness*100)+"%)";},toHwbStringDecimal:function(){return"hwb("+this.hue+", "+this.whiteness+", "+this.blackness+")";},toHwbaString:function(){return"hwba("+this.hue+", "+Math.round(this.whiteness*100)+"%, "+Math.round(this.blackness*100)+"%, "+this.opacity+")";},toHslString:function(){return"hsl("+this.hue+", "+Math.round(this.sat*100)+"%, "+Math.round(this.lightness*100)+"%)";},toHslStringDecimal:function(){return"hsl("+this.hue+", "+this.sat+", "+this.lightness+")";},toHslaString:function(){return"hsla("+this.hue+", "+Math.round(this.sat*100)+"%, "+Math.round(this.lightness*100)+"%, "+this.opacity+")";},toCmykString:function(){return"cmyk("+Math.round(this.cyan*100)+"%, "+Math.round(this.magenta*100)+"%, "+Math.round(this.yellow*100)+"%, "+Math.round(this.black*100)+"%)";},toCmykStringDecimal:function(){return"cmyk("+this.cyan+", "+this.magenta+", "+this.yellow+", "+this.black+")";},toNcolString:function(){return this.ncol+", "+Math.round(this.whiteness*100)+"%, "+Math.round(this.blackness*100)+"%";},toNcolStringDecimal:function(){return this.ncol+", "+this.whiteness+", "+this.blackness;},toNcolaString:function(){return this.ncol+", "+Math.round(this.whiteness*100)+"%, "+Math.round(this.blackness*100)+"%, "+this.opacity;},toName:function(){var r,g,b,colorhexs=getColorArr('hexs');for(i=0;i<colorhexs.length;i++){r=parseInt(colorhexs[i].substr(0,2),16);g=parseInt(colorhexs[i].substr(2,2),16);b=parseInt(colorhexs[i].substr(4,2),16);if(this.red==r&&this.green==g&&this.blue==b){return getColorArr('names')[i];}}
return"";},toHexString:function(){var r=toHex(this.red);var g=toHex(this.green);var b=toHex(this.blue);return"#"+r+g+b;},toRgb:function(){return{r:this.red,g:this.green,b:this.blue,a:this.opacity};},toHsl:function(){return{h:this.hue,s:this.sat,l:this.lightness,a:this.opacity};},toHwb:function(){return{h:this.hue,w:this.whiteness,b:this.blackness,a:this.opacity};},toCmyk:function(){return{c:this.cyan,m:this.magenta,y:this.yellow,k:this.black,a:this.opacity};},toNcol:function(){return{ncol:this.ncol,w:this.whiteness,b:this.blackness,a:this.opacity};},isDark:function(n){var m=(n||128);return(((this.red*299+this.green*587+this.blue*114)/ 1000)<m);},saturate:function(n){var x,rgb,color;x=(n / 100||0.1);this.sat+=x;if(this.sat>1){this.sat=1;}
rgb=hslToRgb(this.hue,this.sat,this.lightness);color=colorObject(rgb,this.opacity,this.hue,this.sat);this.attachValues(color);},desaturate:function(n){var x,rgb,color;x=(n / 100||0.1);this.sat-=x;if(this.sat<0){this.sat=0;}
rgb=hslToRgb(this.hue,this.sat,this.lightness);color=colorObject(rgb,this.opacity,this.hue,this.sat);this.attachValues(color);},lighter:function(n){var x,rgb,color;x=(n / 100||0.1);this.lightness+=x;if(this.lightness>1){this.lightness=1;}
rgb=hslToRgb(this.hue,this.sat,this.lightness);color=colorObject(rgb,this.opacity,this.hue,this.sat);this.attachValues(color);},darker:function(n){var x,rgb,color;x=(n / 100||0.1);this.lightness-=x;if(this.lightness<0){this.lightness=0;}
rgb=hslToRgb(this.hue,this.sat,this.lightness);color=colorObject(rgb,this.opacity,this.hue,this.sat);this.attachValues(color);},attachValues:function(color){this.red=color.red;this.green=color.green;this.blue=color.blue;this.hue=color.hue;this.sat=color.sat;this.lightness=color.lightness;this.whiteness=color.whiteness;this.blackness=color.blackness;this.cyan=color.cyan;this.magenta=color.magenta;this.yellow=color.yellow;this.black=color.black;this.ncol=color.ncol;this.opacity=color.opacity;this.valid=color.valid;}};function toColorObject(c){var x,y,typ,arr=[],arrlength,i,opacity,match,a,hue,sat,rgb,colornames=[],colorhexs=[];c=w3trim(c.toLowerCase());x=c.substr(0,1).toUpperCase();y=c.substr(1);a=1;if((x=="R"||x=="Y"||x=="G"||x=="C"||x=="B"||x=="M"||x=="W")&&!isNaN(y)){if(c.length==6&&c.indexOf(",")==-1){}else{c="ncol("+c+")";}}
if(c.length!=3&&c.length!=6&&!isNaN(c)){c="ncol("+c+")";}
if(c.indexOf(",")>0&&c.indexOf("(")==-1){c="ncol("+c+")";}
if(c.substr(0,3)=="rgb"||c.substr(0,3)=="hsl"||c.substr(0,3)=="hwb"||c.substr(0,4)=="ncol"||c.substr(0,4)=="cmyk"){if(c.substr(0,4)=="ncol"){if(c.split(",").length==4&&c.indexOf("ncola")==-1){c=c.replace("ncol","ncola");}
typ="ncol";c=c.substr(4);}else if(c.substr(0,4)=="cmyk"){typ="cmyk";c=c.substr(4);}else{typ=c.substr(0,3);c=c.substr(3);}
arrlength=3;opacity=false;if(c.substr(0,1).toLowerCase()=="a"){arrlength=4;opacity=true;c=c.substr(1);}else if(typ=="cmyk"){arrlength=4;if(c.split(",").length==5){arrlength=5;opacity=true;}}
c=c.replace("(","");c=c.replace(")","");arr=c.split(",");if(typ=="rgb"){if(arr.length!=arrlength){return emptyObject();}
for(i=0;i<arrlength;i++){if(arr[i]==""||arr[i]==" "){arr[i]="0";}
if(arr[i].indexOf("%")>-1){arr[i]=arr[i].replace("%","");arr[i]=Number(arr[i]/ 100);if(i<3){arr[i]=Math.round(arr[i]*255);}}
if(isNaN(arr[i])){return emptyObject();}
if(parseInt(arr[i])>255){arr[i]=255;}
if(i<3){arr[i]=parseInt(arr[i]);}
if(i==3&&Number(arr[i])>1){arr[i]=1;}}
rgb={r:arr[0],g:arr[1],b:arr[2]};if(opacity==true){a=Number(arr[3]);}}
if(typ=="hsl"||typ=="hwb"||typ=="ncol"){while(arr.length<arrlength){arr.push("0");}
if(typ=="hsl"||typ=="hwb"){if(parseInt(arr[0])>=360){arr[0]=0;}}
for(i=1;i<arrlength;i++){if(arr[i].indexOf("%")>-1){arr[i]=arr[i].replace("%","");arr[i]=Number(arr[i]);if(isNaN(arr[i])){return emptyObject();}
arr[i]=arr[i]/ 100;}else{arr[i]=Number(arr[i]);}
if(Number(arr[i])>1){arr[i]=1;}
if(Number(arr[i])<0){arr[i]=0;}}
if(typ=="hsl"){rgb=hslToRgb(arr[0],arr[1],arr[2]);hue=Number(arr[0]);sat=Number(arr[1]);}
if(typ=="hwb"){rgb=hwbToRgb(arr[0],arr[1],arr[2]);}
if(typ=="ncol"){rgb=ncolToRgb(arr[0],arr[1],arr[2]);}
if(opacity==true){a=Number(arr[3]);}}
if(typ=="cmyk"){while(arr.length<arrlength){arr.push("0");}
for(i=0;i<arrlength;i++){if(arr[i].indexOf("%")>-1){arr[i]=arr[i].replace("%","");arr[i]=Number(arr[i]);if(isNaN(arr[i])){return emptyObject();}
arr[i]=arr[i]/ 100;}else{arr[i]=Number(arr[i]);}
if(Number(arr[i])>1){arr[i]=1;}
if(Number(arr[i])<0){arr[i]=0;}}
rgb=cmykToRgb(arr[0],arr[1],arr[2],arr[3]);if(opacity==true){a=Number(arr[4]);}}}else if(c.substr(0,3)=="ncs"){rgb=ncsToRgb(c);}else{match=false;colornames=getColorArr('names');for(i=0;i<colornames.length;i++){if(c.toLowerCase()==colornames[i].toLowerCase()){colorhexs=getColorArr('hexs');match=true;rgb={r:parseInt(colorhexs[i].substr(0,2),16),g:parseInt(colorhexs[i].substr(2,2),16),b:parseInt(colorhexs[i].substr(4,2),16)};break;}}
if(match==false){c=c.replace("#","");if(c.length==3){c=c.substr(0,1)+c.substr(0,1)+c.substr(1,1)+c.substr(1,1)+c.substr(2,1)+c.substr(2,1);}
for(i=0;i<c.length;i++){if(!isHex(c.substr(i,1))){return emptyObject();}}
arr[0]=parseInt(c.substr(0,2),16);arr[1]=parseInt(c.substr(2,2),16);arr[2]=parseInt(c.substr(4,2),16);for(i=0;i<3;i++){if(isNaN(arr[i])){return emptyObject();}}
rgb={r:arr[0],g:arr[1],b:arr[2]};}}
return colorObject(rgb,a,hue,sat);}
function colorObject(rgb,a,h,s){var hsl,hwb,cmyk,ncol,color,hue,sat;if(!rgb){return emptyObject();}
if(a===null){a=1;}
hsl=rgbToHsl(rgb.r,rgb.g,rgb.b);hwb=rgbToHwb(rgb.r,rgb.g,rgb.b);cmyk=rgbToCmyk(rgb.r,rgb.g,rgb.b);hue=(h||hsl.h);sat=(s||hsl.s);ncol=hueToNcol(hue);color={red:rgb.r,green:rgb.g,blue:rgb.b,hue:hue,sat:sat,lightness:hsl.l,whiteness:hwb.w,blackness:hwb.b,cyan:cmyk.c,magenta:cmyk.m,yellow:cmyk.y,black:cmyk.k,ncol:ncol,opacity:a,valid:true};color=roundDecimals(color);return color;}
function emptyObject(){return{red:0,green:0,blue:0,hue:0,sat:0,lightness:0,whiteness:0,blackness:0,cyan:0,magenta:0,yellow:0,black:0,ncol:"R",opacity:1,valid:false};}
function getColorArr(x){if(x=="names"){return['AliceBlue','AntiqueWhite','Aqua','Aquamarine','Azure','Beige','Bisque','Black','BlanchedAlmond','Blue','BlueViolet','Brown','BurlyWood','CadetBlue','Chartreuse','Chocolate','Coral','CornflowerBlue','Cornsilk','Crimson','Cyan','DarkBlue','DarkCyan','DarkGoldenRod','DarkGray','DarkGrey','DarkGreen','DarkKhaki','DarkMagenta','DarkOliveGreen','DarkOrange','DarkOrchid','DarkRed','DarkSalmon','DarkSeaGreen','DarkSlateBlue','DarkSlateGray','DarkSlateGrey','DarkTurquoise','DarkViolet','DeepPink','DeepSkyBlue','DimGray','DimGrey','DodgerBlue','FireBrick','FloralWhite','ForestGreen','Fuchsia','Gainsboro','GhostWhite','Gold','GoldenRod','Gray','Grey','Green','GreenYellow','HoneyDew','HotPink','IndianRed','Indigo','Ivory','Khaki','Lavender','LavenderBlush','LawnGreen','LemonChiffon','LightBlue','LightCoral','LightCyan','LightGoldenRodYellow','LightGray','LightGrey','LightGreen','LightPink','LightSalmon','LightSeaGreen','LightSkyBlue','LightSlateGray','LightSlateGrey','LightSteelBlue','LightYellow','Lime','LimeGreen','Linen','Magenta','Maroon','MediumAquaMarine','MediumBlue','MediumOrchid','MediumPurple','MediumSeaGreen','MediumSlateBlue','MediumSpringGreen','MediumTurquoise','MediumVioletRed','MidnightBlue','MintCream','MistyRose','Moccasin','NavajoWhite','Navy','OldLace','Olive','OliveDrab','Orange','OrangeRed','Orchid','PaleGoldenRod','PaleGreen','PaleTurquoise','PaleVioletRed','PapayaWhip','PeachPuff','Peru','Pink','Plum','PowderBlue','Purple','RebeccaPurple','Red','RosyBrown','RoyalBlue','SaddleBrown','Salmon','SandyBrown','SeaGreen','SeaShell','Sienna','Silver','SkyBlue','SlateBlue','SlateGray','SlateGrey','Snow','SpringGreen','SteelBlue','Tan','Teal','Thistle','Tomato','Turquoise','Violet','Wheat','White','WhiteSmoke','Yellow','YellowGreen'];}
if(x=="hexs"){return['f0f8ff','faebd7','00ffff','7fffd4','f0ffff','f5f5dc','ffe4c4','000000','ffebcd','0000ff','8a2be2','a52a2a','deb887','5f9ea0','7fff00','d2691e','ff7f50','6495ed','fff8dc','dc143c','00ffff','00008b','008b8b','b8860b','a9a9a9','a9a9a9','006400','bdb76b','8b008b','556b2f','ff8c00','9932cc','8b0000','e9967a','8fbc8f','483d8b','2f4f4f','2f4f4f','00ced1','9400d3','ff1493','00bfff','696969','696969','1e90ff','b22222','fffaf0','228b22','ff00ff','dcdcdc','f8f8ff','ffd700','daa520','808080','808080','008000','adff2f','f0fff0','ff69b4','cd5c5c','4b0082','fffff0','f0e68c','e6e6fa','fff0f5','7cfc00','fffacd','add8e6','f08080','e0ffff','fafad2','d3d3d3','d3d3d3','90ee90','ffb6c1','ffa07a','20b2aa','87cefa','778899','778899','b0c4de','ffffe0','00ff00','32cd32','faf0e6','ff00ff','800000','66cdaa','0000cd','ba55d3','9370db','3cb371','7b68ee','00fa9a','48d1cc','c71585','191970','f5fffa','ffe4e1','ffe4b5','ffdead','000080','fdf5e6','808000','6b8e23','ffa500','ff4500','da70d6','eee8aa','98fb98','afeeee','db7093','ffefd5','ffdab9','cd853f','ffc0cb','dda0dd','b0e0e6','800080','663399','ff0000','bc8f8f','4169e1','8b4513','fa8072','f4a460','2e8b57','fff5ee','a0522d','c0c0c0','87ceeb','6a5acd','708090','708090','fffafa','00ff7f','4682b4','d2b48c','008080','d8bfd8','ff6347','40e0d0','ee82ee','f5deb3','ffffff','f5f5f5','ffff00','9acd32'];}}
function roundDecimals(c){c.red=Number(c.red.toFixed(0));c.green=Number(c.green.toFixed(0));c.blue=Number(c.blue.toFixed(0));c.hue=Number(c.hue.toFixed(0));c.sat=Number(c.sat.toFixed(2));c.lightness=Number(c.lightness.toFixed(2));c.whiteness=Number(c.whiteness.toFixed(2));c.blackness=Number(c.blackness.toFixed(2));c.cyan=Number(c.cyan.toFixed(2));c.magenta=Number(c.magenta.toFixed(2));c.yellow=Number(c.yellow.toFixed(2));c.black=Number(c.black.toFixed(2));c.ncol=c.ncol.substr(0,1)+Math.round(Number(c.ncol.substr(1)));c.opacity=Number(c.opacity.toFixed(2));return c;}
function hslToRgb(hue,sat,light){var t1,t2,r,g,b;hue=hue / 60;if(light<=0.5){t2=light*(sat+1);}else{t2=light+sat-(light*sat);}
t1=light*2-t2;r=hueToRgb(t1,t2,hue+2)*255;g=hueToRgb(t1,t2,hue)*255;b=hueToRgb(t1,t2,hue-2)*255;return{r:r,g:g,b:b};}
function hueToRgb(t1,t2,hue){if(hue<0)hue+=6;if(hue>=6)hue-=6;if(hue<1)return(t2-t1)*hue+t1;else if(hue<3)return t2;else if(hue<4)return(t2-t1)*(4-hue)+t1;else return t1;}
function hwbToRgb(hue,white,black){var i,rgb,rgbArr=[],tot;rgb=hslToRgb(hue,1,0.50);rgbArr[0]=rgb.r / 255;rgbArr[1]=rgb.g / 255;rgbArr[2]=rgb.b / 255;tot=white+black;if(tot>1){white=Number((white / tot).toFixed(2));black=Number((black / tot).toFixed(2));}
for(i=0;i<3;i++){rgbArr[i]*=(1-(white)-(black));rgbArr[i]+=(white);rgbArr[i]=Number(rgbArr[i]*255);}
return{r:rgbArr[0],g:rgbArr[1],b:rgbArr[2]};}
function cmykToRgb(c,m,y,k){var r,g,b;r=255-((Math.min(1,c*(1-k)+k))*255);g=255-((Math.min(1,m*(1-k)+k))*255);b=255-((Math.min(1,y*(1-k)+k))*255);return{r:r,g:g,b:b};}
function ncolToRgb(ncol,white,black){var letter,percent,h,w,b;h=ncol;if(isNaN(ncol.substr(0,1))){letter=ncol.substr(0,1).toUpperCase();percent=ncol.substr(1);if(percent==""){percent=0;}
percent=Number(percent);if(isNaN(percent)){return false;}
if(letter=="R"){h=0+(percent*0.6);}
if(letter=="Y"){h=60+(percent*0.6);}
if(letter=="G"){h=120+(percent*0.6);}
if(letter=="C"){h=180+(percent*0.6);}
if(letter=="B"){h=240+(percent*0.6);}
if(letter=="M"){h=300+(percent*0.6);}
if(letter=="W"){h=0;white=1-(percent / 100);black=(percent / 100);}}
return hwbToRgb(h,white,black);}
function hueToNcol(hue){while(hue>=360){hue=hue-360;}
if(hue<60){return"R"+(hue / 0.6);}
if(hue<120){return"Y"+((hue-60)/ 0.6);}
if(hue<180){return"G"+((hue-120)/ 0.6);}
if(hue<240){return"C"+((hue-180)/ 0.6);}
if(hue<300){return"B"+((hue-240)/ 0.6);}
if(hue<360){return"M"+((hue-300)/ 0.6);}}
function ncsToRgb(ncs){var black,chroma,bc,percent,black1,chroma1,red1,factor1,blue1,red1,red2,green2,blue2,max,factor2,grey,r,g,b;ncs=w3trim(ncs).toUpperCase();ncs=ncs.replace("(","");ncs=ncs.replace(")","");ncs=ncs.replace("NCS","NCS ");ncs=ncs.replace(/  /g," ");if(ncs.indexOf("NCS")==-1){ncs="NCS "+ncs;}
ncs=ncs.match(/^(?:NCS|NCS\sS)\s(\d{2})(\d{2})-(N|[A-Z])(\d{2})?([A-Z])?$/);if(ncs===null)return false;black=parseInt(ncs[1],10);chroma=parseInt(ncs[2],10);bc=ncs[3];if(bc!="N"&&bc!="Y"&&bc!="R"&&bc!="B"&&bc!="G"){return false;}
percent=parseInt(ncs[4],10)||0;if(bc!=='N'){black1=(1.05*black-5.25);chroma1=chroma;if(bc==='Y'&&percent<=60){red1=1;}else if((bc==='Y'&&percent>60)||(bc==='R'&&percent<=80)){if(bc==='Y'){factor1=percent-60;}else{factor1=percent+40;}
red1=((Math.sqrt(14884-Math.pow(factor1,2)))-22)/ 100;}else if((bc==='R'&&percent>80)||(bc==='B')){red1=0;}else if(bc==='G'){factor1=(percent-170);red1=((Math.sqrt(33800-Math.pow(factor1,2)))-70)/ 100;}
if(bc==='Y'&&percent<=80){blue1=0;}else if((bc==='Y'&&percent>80)||(bc==='R'&&percent<=60)){if(bc==='Y'){factor1=(percent-80)+20.5;}else{factor1=(percent+20)+20.5;}
blue1=(104-(Math.sqrt(11236-Math.pow(factor1,2))))/ 100;}else if((bc==='R'&&percent>60)||(bc==='B'&&percent<=80)){if(bc==='R'){factor1=(percent-60)-60;}else{factor1=(percent+40)-60;}
blue1=((Math.sqrt(10000-Math.pow(factor1,2)))-10)/ 100;}else if((bc==='B'&&percent>80)||(bc==='G'&&percent<=40)){if(bc==='B'){factor1=(percent-80)-131;}else{factor1=(percent+20)-131;}
blue1=(122-(Math.sqrt(19881-Math.pow(factor1,2))))/ 100;}else if(bc==='G'&&percent>40){blue1=0;}
if(bc==='Y'){green1=(85-17/20*percent)/ 100;}else if(bc==='R'&&percent<=60){green1=0;}else if(bc==='R'&&percent>60){factor1=(percent-60)+35;green1=(67.5-(Math.sqrt(5776-Math.pow(factor1,2))))/ 100;}else if(bc==='B'&&percent<=60){factor1=(1*percent-68.5);green1=(6.5+(Math.sqrt(7044.5-Math.pow(factor1,2))))/ 100;}else if((bc==='B'&&percent>60)||(bc==='G'&&percent<=60)){green1=0.9;}else if(bc==='G'&&percent>60){factor1=(percent-60);green1=(90-(1/8*factor1))/ 100;}
factor1=(red1+green1+blue1)/3;red2=((factor1-red1)*(100-chroma1)/ 100)+red1;green2=((factor1-green1)*(100-chroma1)/ 100)+green1;blue2=((factor1-blue1)*(100-chroma1)/ 100)+blue1;if(red2>green2&&red2>blue2){max=red2;}else if(green2>red2&&green2>blue2){max=green2;}else if(blue2>red2&&blue2>green2){max=blue2;}else{max=(red2+green2+blue2)/ 3;}
factor2=1 / max;r=parseInt((red2*factor2*(100-black1)/ 100)*255,10);g=parseInt((green2*factor2*(100-black1)/ 100)*255,10);b=parseInt((blue2*factor2*(100-black1)/ 100)*255,10);if(r>255){r=255;}
if(g>255){g=255;}
if(b>255){b=255;}
if(r<0){r=0;}
if(g<0){g=0;}
if(b<0){b=0;}}else{grey=parseInt((1-black / 100)*255,10);if(grey>255){grey=255;}
if(grey<0){grey=0;}
r=grey;g=grey;b=grey;}
return{r:r,g:g,b:b};}
function rgbToHsl(r,g,b){var min,max,i,l,s,maxcolor,h,rgb=[];rgb[0]=r / 255;rgb[1]=g / 255;rgb[2]=b / 255;min=rgb[0];max=rgb[0];maxcolor=0;for(i=0;i<rgb.length-1;i++){if(rgb[i+1]<=min){min=rgb[i+1];}
if(rgb[i+1]>=max){max=rgb[i+1];maxcolor=i+1;}}
if(maxcolor==0){h=(rgb[1]-rgb[2])/(max-min);}
if(maxcolor==1){h=2+(rgb[2]-rgb[0])/(max-min);}
if(maxcolor==2){h=4+(rgb[0]-rgb[1])/(max-min);}
if(isNaN(h)){h=0;}
h=h*60;if(h<0){h=h+360;}
l=(min+max)/ 2;if(min==max){s=0;}else{if(l<0.5){s=(max-min)/(max+min);}else{s=(max-min)/(2-max-min);}}
s=s;return{h:h,s:s,l:l};}
function rgbToHwb(r,g,b){var h,w,bl;r=r / 255;g=g / 255;b=b / 255;max=Math.max(r,g,b);min=Math.min(r,g,b);chroma=max-min;if(chroma==0){h=0;}else if(r==max){h=(((g-b)/ chroma)%6)*360;}else if(g==max){h=((((b-r)/ chroma)+2)%6)*360;}else{h=((((r-g)/ chroma)+4)%6)*360;}
w=min;bl=1-max;return{h:h,w:w,b:bl};}
function rgbToCmyk(r,g,b){var c,m,y,k;r=r / 255;g=g / 255;b=b / 255;max=Math.max(r,g,b);k=1-max;if(k==1){c=0;m=0;y=0;}else{c=(1-r-k)/(1-k);m=(1-g-k)/(1-k);y=(1-b-k)/(1-k);}
return{c:c,m:m,y:y,k:k};}
function toHex(n){var hex=n.toString(16);while(hex.length<2){hex="0"+hex;}
return hex;}
function cl(x){console.log(x);}
function w3trim(x){return x.replace(/^\s+|\s+$/g,'');}
function isHex(x){return('0123456789ABCDEFabcdef'.indexOf(x)>-1);}
window.w3color=w3color;})();function w3SetColorsByAttribute(){var z,i,att;z=document.getElementsByTagName("*");for(i=0;i<z.length;i++){att=z[i].getAttribute("data-w3-color");if(att){z[i].style.backgroundColor=w3color(att).toRgbString();}}}



