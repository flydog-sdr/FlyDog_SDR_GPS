

/* web/kiwi/mfg.min.js */
var ws_mfg,ver_maj,ver_min;function mfg_main(){}function kiwi_ws_open(e,r,i){return open_websocket(e,r,i,null,mfg_recv)}function mfg_draw(){var e=w3_div("","<h4><strong>Manufacturing interface</strong>&nbsp;&nbsp;<small>(software version v"+ver_maj+"."+ver_min+")</small></h4>");e+=ver_maj?w3_div("w3-text-css-lime","<h2>Everything gets ready.</h2>"):w3_div('w3-text-red"',"<h2>WARNING: Use for testing only!</h2>"),e+=w3_div("","EEPROM serial number: ",w3_div('id-ee-write w3-btn w3-round-large||onclick="mfg_ee_write()"'))+"<br>"+w3_col_percent("/w3-hcenter",w3_div('id-seq-override w3-btn w3-round-large w3-yellow||onclick="mfg_seq_override()"'),40,'<input id="id-seq-input" class="w3-input w3-border w3-width-auto w3-hover-shadow w3-hidden" type="text" size=9 onchange="mfg_seq_set()">',20,w3_div('id-power-off w3-btn w3-round-large|background-color:fuchsia||onclick="mfg_power_off()"'),40)+"<hr>"+w3_third("","",w3_div('id-sd-write w3-btn w3-round-large w3-aqua||onclick="mfg_sd_write()"'),w3_div("",w3_div("w3-progress-container w3-round-large w3-white w3-show-inline-block",w3_div("id-progress w3-progressbar w3-round-large w3-light-green w3-width-zero",w3_div("id-progress-text w3-container w3-text-black"))),w3_div("w3-margin-T-8",w3_div("id-progress-time w3-show-inline-block"),w3_div("id-progress-icon w3-show-inline-block w3-margin-left"))),w3_div("id-sd-status class-sd-status"))+"<hr>"+w3_div("id-output-msg class-mfg-status w3-scroll-down w3-small");e=w3_innerHTML("id-mfg",w3_div("w3-container w3-section w3-dark-grey w3-half",e));e.style.top=e.style.left="10px";w3_innerHTML("id-sd-write","click to backup"),w3_innerHTML("id-power-off","click to halt<br>and power off");w3_show_block(e)}function mfg_recv(e){var r=-1,e=arrayBufferToString(e);params=e.substring(4).split(" ");for(var i=0;i<params.length;i++)switch(param=params[i].split("="),param[0]){case"ver_maj":ver_maj=parseFloat(param[1]);break;case"ver_min":ver_min=parseFloat(param[1]),mfg_draw();break;case"serno":var s,o=parseFloat(param[1]);console.log("MFG next_serno="+r+" serno="+o),button_color=o<=0?(s="invalid, click to write EEPROM<br>with next serial number: "+r,"red"):(s="valid = "+o.toString()+"<br>click to change to "+r,"#4CAF50");o=w3_innerHTML("id-ee-write",s);w3_background_color(o,button_color),w3_innerHTML("id-seq-override","next serial number = "+r+"<br>click to override"),(o=w3_remove("id-seq-input","w3-visible")).value=r;break;case"next_serno":r=parseFloat(param[1]);break;case"microSD_done":mfg_sd_write_done(parseFloat(param[1]));break;default:console.log("MFG UNKNOWN: "+param[0]+"="+param[1])}}function mfg_ee_write(){ext_send("SET write")}function mfg_seq_override(){w3_add("id-seq-input","w3-visible")}function mfg_seq_set(){var e=parseFloat(w3_el("id-seq-input").value).toFixed(0);0<=e&&e<=9999&&ext_send("SET set_serno="+e)}var sd_progress,mfg_sd_interval,sd_progress_max=10,refresh_icon='<i class="fa fa-refresh fa-spin" style="font-size:24px"></i>';function mfg_sd_write(){var e=w3_innerHTML("id-sd-write","Backup in<br>progress...");w3_add(e,"w3-override-yellow"),e=w3_innerHTML("id-sd-status","Backup in progress..."),w3_color(e,"white"),w3_el("id-progress-text").innerHTML=w3_el("id-progress").style.width="0%",sd_progress=-1,mfg_sd_progress(),mfg_sd_interval=setInterval(mfg_sd_progress,1e3),w3_innerHTML("id-progress-icon",refresh_icon),ext_send("SET microSD_write")}function mfg_sd_progress(){var e=(++sd_progress/sd_progress_max*100).toFixed(0);e<=95&&(w3_el("id-progress-text").innerHTML=w3_el("id-progress").style.width=e+"%");var r=(sd_progress%60).toFixed(0).leadingZeros(2),e=Math.floor(sd_progress/60).toFixed(0);w3_innerHTML("id-progress-time",e+":"+r)}function mfg_sd_write_done(e){var r=w3_innerHTML("id-sd-write","click to backup");w3_remove(r,"w3-override-yellow");var i=e?"FAILED error "+e.toString():"WORKED";1==e&&(i+="<br>Internet is not connected"),15==e&&(i+="<br>Failed to upload archive");r=w3_innerHTML("id-sd-status",i);w3_color(r,e?"red":"lime"),e||(w3_el("id-progress-text").innerHTML=w3_el("id-progress").style.width="100%"),kiwi_clearInterval(mfg_sd_interval),w3_innerHTML("id-progress-icon","")}function mfg_power_off(){var e=w3_innerHTML("id-power-off","halting and<br>powering off...");w3_background_color(e,"red"),ext_send("SET mfg_power_off")}

