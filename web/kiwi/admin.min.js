var admin={is_multi_core:!1,reg_status:{}};function status_html(){var e=admin_sdr_mode?"<hr>"+w3_div("id-msg-errors w3-container")+w3_div("w3-container w3-section",w3_inline("",w3_div("","Realtime response histograms:"),w3_button("w3-padding-smaller w3-aqua|margin-left:10px","Reset","status_dpump_hist_reset_cb")),w3_div("w3-container",w3_div("id-status-dp-hist"),w3_div("id-status-in-hist"))):"",t=w3_div("id-status w3-hide","<hr>"+w3_div("id-problems w3-container")+w3_div("id-msg-config w3-container")+w3_div("id-msg-gps w3-container")+w3_div("id-msg-snr w3-container")+"<hr>"+w3_div("id-msg-stats-cpu w3-container")+w3_div("id-msg-stats-xfer w3-container")+e+"<hr>"+w3_div("id-users-list w3-container")+"<hr>");return t}function status_dpump_hist_reset_cb(){ext_send("SET dpump_hist_reset")}function status_user_kick_cb(e,t){console.log("status_user_kick_cb="+t),ext_send("SET user_kick="+t)}var mode_icon_snd12=w3_icon("w3-text-blue","fa-volume-up",28)+"&nbsp;",mode_icon_snd20=w3_icon("w3-text-red","fa-volume-up",28)+"&nbsp;",mode_icon_fft=w3_icon("w3-text-green","fa-bar-chart",28)+"&nbsp;",mode_icon_wf=w3_icon("w3-text-amber","fa-area-chart",28)+"&nbsp;";function mode_html(){var e=px(235),t=px(113),a=0,n=w3_div("id-mode w3-hide","<hr>",w3_div("w3-container",w3_div("w3-flex w3-margin-B-8",w3_div("w3-text-teal|width:"+t," "),w3_div("w3-text-teal w3-center w3-bold|width:"+e,"select FPGA mode"),w3_div("id-fw-hdr w3-flex w3-margin-left")),w3_div("",w3_div("w3-left",w3_div("w3-flex w3-halign-center w3-margin-B-5","<img src=\"gfx/kiwi.73x73.jpg\" width=\"73\" height=\"73\" />"),w3_div("w3-flex w3-halign-center w3-margin-B-5","<img src=\"gfx/cowbelly.73x73.jpg\" width=\"73\" height=\"73\" />"),w3_div("w3-flex","<img src=\"gfx/kiwi.derp.113x73.jpg\" width=\"113\" height=\"73\" />"),admin.is_multi_core?w3_div("w3-flex","<img src=\"gfx/kiwi.derp.113x73.jpg\" width=\"113\" height=\"73\" />"):""),w3_sidenav("id-fw-nav|width:"+e+";border-collapse:collapse",w3_nav(admin_colors[a++]+" w3-border w3-padding-xxlarge w3-restart","Kiwi classic",kiwi.RX4_WF4,"firmware_sel_cb",adm.firmware_sel==kiwi.RX4_WF4),w3_nav(admin_colors[a++]+" w3-border w3-padding-xxlarge w3-restart","More receivers",kiwi.RX8_WF2,"firmware_sel_cb",adm.firmware_sel==kiwi.RX8_WF2),w3_nav(admin_colors[a++]+" w3-border w3-padding-xxlarge w3-restart","More bandwidth",kiwi.RX3_WF3,"firmware_sel_cb",adm.firmware_sel==kiwi.RX3_WF3),admin.is_multi_core?w3_nav(admin_colors[a++]+" w3-border w3-padding-xxlarge w3-restart","MCORE rx14_wf0",kiwi.RX14_WF0,"firmware_sel_cb",adm.firmware_sel==kiwi.RX14_WF0):""),w3_div("w3-margin-left w3-left",w3_div("id-fw-44 w3-flex w3-padding-TB-7"),w3_div("id-fw-82 w3-flex w3-padding-TB-7"),w3_div("id-fw-22 w3-flex w3-padding-TB-7"))),w3_div("w3-clear"," "),w3_div("w3-margin-T-16","<hr>"),w3_col_percent("w3-section/ w3-hspace-16",w3_div("w3-text-black",w3_text("w3-bold w3-margin-B-8 w3-text-teal","Trade-offs: receiver channels, audio bandwidth and waterfalls"),w3_div("w3-flex w3-valign-center",w3_div("|width:40px",mode_icon_snd12),w3_div("","Audio output, 12 kHz max bandwidth")),w3_div("w3-flex w3-valign-center",w3_div("|width:40px",mode_icon_snd20),w3_div("","Audio output, 20 kHz max bandwidth")),w3_div("w3-flex w3-margin-B-8 w3-valign-center",w3_div("|width:40px",mode_icon_wf),w3_div("","Tuneable waterfall/spectrum, 30 MHz bandwidth, 14-level zoom")),w3_div("w3-flex w3-margin-B-8 w3-valign-center",w3_div("|width:40px",mode_icon_fft),w3_div("","Audio FFT display, 12 kHz max bandwidth ")),"The original Kiwi FPGA with its 4 tuneable audio/waterfall receiver channels and 12 GPS channels was completely full. But it is now possible to load a different FPGA configuration where 2 of the waterfalls have been traded for adding more audio-only receiver channels. "),48,w3_div("w3-text-black"," "),4,w3_div("w3-text-black","Having more receiver channels per Kiwi is especially important with the recently added features that are channel intensive. Namely the TDoA service, WSPR autorun and external connection via the kiwirecorder program for using other software such as WSJT-X and Dream (DRM). When these kinds of connections are made channels rx2 - rx7 will be used first leaving rx0 and rx1 available for normal browser connections where it is desirable to view the waterfall. However rx0 and rx1 will be used last if necessary. The configurable TDoA channel limit still applies.<br><br>To compensate for lack of the waterfall/spectrum on the new channels an audio-bandwidth FFT is presented instead. This requires no additional FPGA resources."),48),w3_div("w3-margin-T-16","<hr>"),w3_col_percent("w3-section/ w3-hspace-16",w3_div("w3-text-black","And now a third option \"More bandwidth\". The audio bandwidth is increased from 12 to 20 kHz. This supports wide passbands for hi-fidelity listening of AM BCB and SW stations. And also wide IQ bandwidths for external applications processing large parts of the spectrum. "),48,w3_div("w3-text-black"," "),4,w3_div("w3-text-black","In exchange the number of channels drops from four to three. It may have to drop to two in the future depending on how stable operation is with three channels."),48),w3_div("w3-margin-T-16","<hr>")));return n}function mode_focus(){console.log("mode_focus");var e,t,a=px(90);for(t="",e=0;8>e;e++)t+=w3_div("w3-margin-left w3-bold w3-center|width:"+a,"rx"+e);w3_innerHTML("id-fw-hdr",t);var n=w3_div("w3-margin-left w3-border w3-border-light-blue w3-center|width:"+a,mode_icon_snd12,"<br>",mode_icon_wf),r=w3_div("w3-margin-left w3-border w3-border-light-blue w3-center|width:"+a,mode_icon_snd20,"<br>",mode_icon_wf),o=w3_div("w3-margin-left w3-border w3-border-light-blue w3-center|width:"+a,mode_icon_snd12,"<br>",mode_icon_fft);for(t="",e=0;4>e;e++)t+=n;for(w3_innerHTML("id-fw-44",t),t="",e=0;2>e;e++)t+=n;for(e=2;8>e;e++)t+=o;for(w3_innerHTML("id-fw-82",t),t="",e=0;3>e;e++)t+=r;w3_innerHTML("id-fw-22",t)}function firmware_sel_cb_focus(e){console.log("firmware_sel_cb_focus path="+e),ext_set_cfg_param("adm.firmware_sel",+e,!0)}function control_html(){var e="<hr>"+w3_half("w3-valign","",w3_div("",w3_div("",w3_button("w3-aqua w3-margin","KiwiSDR server restart","control_restart_cb"),w3_button("w3-blue w3-margin","Beagle reboot","control_reboot_cb"),w3_button("w3-red w3-margin","Beagle power off","control_power_off_cb")),w3_div("id-confirm w3-valign w3-hide",w3_button("w3-green w3-margin","Confirm","control_confirm_cb"),w3_button("w3-yellow w3-margin","Cancel","control_confirm_cancel_cb"))),w3_div("w3-container w3-center","<b>Daily restart?</b> "+w3_switch("","Yes","No","adm.daily_restart",adm.daily_restart,"admin_radio_YN_cb"),w3_div("w3-text-black","Set if you're having problems with the server<br>after it has run for a period of time.<br>Restart occurs at the same time as updates (0200-0600 UTC)<br> and will wait until there are no connections."))),t=ext_get_cfg_param("ext_api_nchans",-1);-1==t&&(t=rx_chans);for(var a=Math.min(t,rx_chans),n={0:"none"},r=1;r<=rx_chans;r++)n[r]=r.toFixed(0);var o="<hr>"+w3_third("w3-container w3-valign","",w3_divs("/w3-center w3-tspace-8",w3_inline("w3-halign-space-around/",w3_divs("w3-center/w3-margin-T-8",w3_div("","<b>Enable user<br>connections?</b>"),w3_switch("","Yes","No","adm.server_enabled",adm.server_enabled,"server_enabled_cb")),w3_divs("w3-center/w3-margin-T-8",w3_div("","<b>Close all active<br>user connections</b>"),w3_button("w3-red","Kick","control_user_kick_cb")))),w3_divs("/w3-center w3-tspace-8",w3_select("","Number of simultaneous channels available<br>for connection by non-Kiwi apps","","ext_api_nchans",a,n,"admin_select_cb"),w3_div("w3-text-black","If you want to limit incoming connections from <br> non-Kiwi apps like kiwirecorder set this value. <br>This overrides similar value in TDoA extension settings.")),w3_divs("w3-restart/w3-center w3-tspace-8",w3_div("","<b>Disable waterfalls/spectrum?</b>"),w3_switch("","Yes","No","cfg.no_wf",cfg.no_wf,"admin_radio_YN_cb"),w3_text("w3-text-black w3-center","Set \"yes\" to save Internet bandwidth by preventing <br>the waterfall and spectrum from being displayed.")))+w3_div("w3-container w3-margin-top",w3_input_get("","Reason if disabled","reason_disabled","reason_disabled_cb","","will be shown to users attempting to connect"))+w3_divs("w3-margin-top/w3-container","<label><b>Reason HTML preview</b></label>",w3_div("id-reason-disabled-preview w3-text-black w3-background-pale-aqua","")),s=ext_get_cfg_param("n_camp",-1);console.log("rx_chans="+rx_chans+" n_camp="+s+" max_camp="+max_camp);for(var l=["disable camping"],r=1;r<=max_camp;r++)l[r]=r.toFixed(0);var d="<hr>"+w3_third("w3-margin-bottom w3-text-teal","w3-container",w3_div("",w3_input_get("","Inactivity time limit (min, 0 = no limit)","inactivity_timeout_mins","admin_int_cb"),w3_div("w3-text-black","Connections from the local network are exempt.")),w3_div("",w3_input_get("","24hr per-IP addr time limit (min, 0 = no limit)","ip_limit_mins","admin_int_cb"),w3_div("w3-text-black","Connections from the local network are exempt.")),w3_div("",w3_input_get("","Time limit exemption password","adm.tlimit_exempt_pwd","w3_string_set_cfg_cb"),w3_div("w3-text-black","Password users can give to override time limits.")))+"<hr>"+w3_third("w3-margin-bottom w3-text-teal","w3-container",w3_divs("w3-restart/w3-center w3-tspace-8",w3_select("","Number of audio campers per channel","","n_camp",s,l,"admin_select_cb"),w3_div("w3-text-black","Reduce this value if your Kiwi is experiencing <br>performance problems from too many audio campers.")),w3_divs("/w3-center w3-tspace-8",w3_select("","SNR measurement interval","","cfg.snr_meas_interval_hrs",cfg.snr_meas_interval_hrs,["disable","hourly","4 hours","6 hours","24 hours"],"admin_select_cb"),w3_text("w3-text-black w3-center","Enables automatic sampling of <br>signal-to-noise ratio (SNR) at the specified interval. <br>Access SNR data in JSON format using <br>URL of the form: <i>my_kiwi:8073/snr</i>")),w3_divs("/w3-center w3-tspace-8",w3_div("","<b>Timestamp SNR with local time?</b>"),w3_switch("","Yes","No","cfg.snr_local_time",cfg.snr_local_time,"admin_radio_YN_cb")))+"<hr>";return w3_div("id-control w3-text-teal w3-hide",e+(admin_sdr_mode?o+d:""))}function control_focus(){w3_innerHTML("id-reason-disabled-preview",admin_preview_status_box("disabled_preview_1",cfg.reason_disabled))}function server_enabled_cb(e,t,a){t=+t;var n=0==t;a||ext_send("SET server_enabled="+(n?1:0)),admin_bool_cb(e,n,a)}function control_user_kick_cb(){ext_send("SET user_kick=-1")}function reason_disabled_cb(e,t){w3_string_set_cfg_cb(e,t),w3_el("id-reason-disabled-preview").innerHTML=admin_preview_status_box("disabled_preview_2",cfg.reason_disabled)}var pending_restart=!1,pending_reboot=!1,pending_power_off=!1;function control_restart_cb(){pending_restart=!0,w3_show_block("id-confirm")}function control_reboot_cb(){pending_reboot=!0,w3_show_block("id-confirm")}function control_power_off_cb(){pending_power_off=!0,w3_show_block("id-confirm")}function control_confirm_cb(){pending_restart?admin_restart_now_cb():pending_reboot?admin_reboot_now_cb():pending_power_off&&(ext_send("SET power_off"),admin_wait_then_reload(0,"Powering off Beagle"))}function control_confirm_cancel_cb(){w3_hide("id-confirm")}var connect={focus:0,timeout:null},connect_dom_sel={NAM:0,DUC:1,PUB:2,SIP:3,REV:4},duc_update_i={0:"5 min",1:"10 min",2:"15 min",3:"30 min",4:"60 min"},duc_update_v={0:5,1:10,2:15,3:30,4:60};function connect_html(){"kiwisdr.example.com"==ext_get_cfg_param("server_url")&&ext_set_cfg_param("cfg.server_url","",!0),"kiwisdr.example.com"==ext_get_cfg_param("sdr_hu_dom_name")&&ext_set_cfg_param("cfg.sdr_hu_dom_name","",!0);var e=0,t=w3_div("w3-valign","<header class=\"w3-container w3-yellow\"><h5>If you are not able to make an incoming connection from the Internet to your Kiwi because of problems <br> with your router or Internet Service Provider (ISP) then please consider using the KiwiSDR <a href=\"http://p.sdrotg.com\" target=\"_blank\">reverse proxy service</a>.</h5></header>")+"<hr>"+w3_divs("w3-container/w3-tspace-8",w3_label("w3-bold","What domain name or IP address will people use to connect to your KiwiSDR?<br>If you are listing on rx.kiwisdr.com this information will be part of your entry.<br>Click one of the five options below and enter any additional information:<br><br>"),w3_sidenav("id-admin-nav-dom w3-margin-R-16 w3-restart",w3_nav(admin_colors[e++]+" w3-border","Domain Name","connect_dom_nam","connect_dom_nam",cfg.sdr_hu_dom_sel==connect_dom_sel.NAM),w3_nav(admin_colors[e++]+" w3-border","DUC Domain","connect_dom_duc","connect_dom_duc",cfg.sdr_hu_dom_sel==connect_dom_sel.DUC),w3_nav(admin_colors[e++]+" w3-border","Reverse Proxy","connect_dom_rev","connect_dom_rev",cfg.sdr_hu_dom_sel==connect_dom_sel.REV),w3_nav(admin_colors[e++]+" w3-border","Public IP","connect_dom_pub","connect_dom_pub",cfg.sdr_hu_dom_sel==connect_dom_sel.PUB),w3_nav(admin_colors[e++]+" w3-border","Specified IP","connect_dom_sip","connect_dom_sip",cfg.sdr_hu_dom_sel==connect_dom_sel.SIP)),w3_divs("w3-padding-L-16/w3-padding-T-1",w3_div("w3-show-inline-block|width:70%;",w3_input_get("","","sdr_hu_dom_name","connect_dom_name_cb","","Enter domain name that you will point to Kiwi public IP address, e.g. kiwisdr.my_domain.com (don't include port number)")),w3_div("id-connect-duc-dom w3-padding-TB-8"),w3_div("id-connect-rev-dom w3-padding-TB-8"),w3_div("id-connect-pub-ip w3-padding-TB-8"),w3_div("w3-show-inline-block|width:70%;",w3_input_get("","","sdr_hu_dom_ip","connect_dom_ip_cb","","Enter known public IP address of the Kiwi (don't include port number)"))),w3_div("w3-margin-T-16",w3_label("id-connect-url-text-label w3-show-inline-block w3-margin-R-16 w3-text-teal")+w3_div("id-connect-url w3-show-inline-block w3-text-black w3-background-pale-aqua"))),a="<hr>"+w3_div("w3-container w3-text-teal|width:80%",w3_input_get("","Next Kiwi URL redirect","adm.url_redirect","connect_url_redirect_cb"),w3_div("w3-text-black","Use this setting to get multiple Kiwis to respond to a single URL.<br>When all the channels of this Kiwi are busy further connection attempts will be redirected to the above URL.<br>Example: Your Kiwi is known as \"mykiwi.com:8073\". Configure another Kiwi to use port 8074 and be known as \"mykiwi.com:8074\".<br>On the port 8073 Kiwi set the above field to \"http://mykiwi.com:8074\".<br>On the port 8074 Kiwi leave the above field blank.<br>Configure the port 8074 Kiwi as normal (i.e. router port open, dynamic DNS, proxy etc.)<br><br><b>CAUTION:</b> Do not create a cycle by redirecting Kiwis like: A -> B -> A &nbsp;Always create a chain that stops redirecting at the end: A -> B <br>This prevents the browser from going into a loop when all channels on all Kiwis are full.")),n="<hr>"+w3_divs("/w3-tspace-8",w3_div("w3-container w3-valign","<header class=\"w3-container w3-yellow\"><h6>Please read these instructions before use: <a href=\"http://kiwisdr.com/quickstart/index.html#id-net-duc\" target=\"_blank\">dynamic DNS update client (DUC)</a></h6></header>"),w3_col_percent("w3-text-teal/w3-container",w3_div("w3-text-teal w3-bold","Dynamic DNS update client (DUC) configuration"),50,w3_div("w3-text-teal w3-bold w3-center w3-light-grey","Account at noip.com"),50),w3_col_percent("w3-text-teal/w3-container",w3_div(),50,w3_input_get("","Username or email","adm.duc_user","w3_string_set_cfg_cb","","required"),25,w3_input_get("","Password","adm.duc_pass","w3_string_set_cfg_cb","","required"),25),w3_col_percent("w3-text-teal/w3-container",w3_div("w3-center","<b>Enable DUC at startup?</b><br>"+w3_switch("w3-margin-T-8","Yes","No","adm.duc_enable",adm.duc_enable,"connect_DUC_enabled_cb")),20,w3_div("w3-center",w3_select("","Update","","adm.duc_update",adm.duc_update,duc_update_i,"admin_select_cb")),10,w3_div("w3-center w3-tspace-8",w3_button("w3-aqua","Click to (re)start DUC","connect_DUC_start_cb"),w3_div("w3-text-black","After changing username or password click to test changes.")),20,w3_input_get("","Host","adm.duc_host","connect_DUC_host_cb","","required"),50),w3_div("w3-container",w3_label("w3-show-inline-block w3-margin-R-16 w3-text-teal","Status:")+w3_div("id-net-duc-status w3-show-inline-block w3-text-black w3-background-pale-aqua",""))),r="<hr>"+w3_divs("/w3-tspace-8",w3_div("w3-container w3-valign","<header class=\"w3-container w3-yellow\"><h6>Please read these instructions before use: <a href=\"http://p.sdrotg.com\" target=\"_blank\">reverse proxy service</a></h6></header>"),w3_text("id-proxy-menu w3-margin-left w3-valign w3-nopad w3-width-min w3-red w3-hide","When adding or making changes to the proxy user key or host name fields <br>you must click the re-register button below AND select \"Reverse proxy\" <br>in the menu at the top of the page."),w3_col_percent("w3-text-teal/w3-container",w3_div("w3-text-teal w3-bold","Reverse proxy configuration"),50,w3_div("id-proxy-hdr w3-text-teal w3-bold w3-center w3-light-grey","Proxy information for p.sdrotg.com"),50),w3_col_percent("w3-text-teal/w3-container",w3_div(),50,w3_input_get("","User key (see instructions)","adm.rev_user","connect_rev_user_cb","","required"),50),w3_col_percent("w3-text-teal/w3-container",w3_div("w3-center w3-tspace-8",w3_button("w3-aqua","Click to (re)register","connect_rev_register_cb"),w3_div("w3-text-black","After changing user key or<br>host name click to register proxy.")),50,w3_div("",w3_div("w3-show-inline-block|width:60%;",w3_input_get("","Host name (your choice, see instructions)","adm.rev_host","connect_rev_host_cb","","required"))+w3_div("id-connect-proxy_server w3-show-inline-block")),50),w3_div("w3-container",w3_label("w3-show-inline-block w3-margin-R-16 w3-text-teal","Status:")+w3_div("id-connect-rev-status w3-show-inline-block w3-text-black w3-background-pale-aqua","")))+"<hr>";return w3_div("id-connect w3-text-teal w3-hide",t+a+n+r)}function connect_focus(){connect.focus=1,connect_update_url(),w3_el("id-proxy-hdr").innerHTML="Proxy information for "+adm.proxy_server,ext_send("SET DUC_status_query"),w3_hide("id-proxy-menu"),cfg.sdr_hu_dom_sel==connect_dom_sel.REV&&ext_send("SET rev_status_query")}function connect_blur(){connect.focus=0}function connect_update_url(){var e,t;e=adm.duc_host&&""!=adm.duc_host,t=e?"w3-background-pale-aqua":"w3-override-yellow",w3_el("id-connect-duc-dom").innerHTML="Use domain name from DUC configuration below: "+w3_div("w3-show-inline-block w3-text-black "+t,e?adm.duc_host:"(none currently set)"),e=adm.rev_host&&""!=adm.rev_host,t=e?"w3-background-pale-aqua":"w3-override-yellow";var a=e?adm.rev_host+"."+adm.proxy_server:"(none currently set)";w3_el("id-connect-rev-dom").innerHTML="Use domain name from reverse proxy configuration below: "+w3_div("w3-show-inline-block w3-text-black "+t,a),w3_el("id-connect-proxy_server").innerHTML="."+adm.proxy_server,e=config_net.pub_ip,t=e?"w3-background-pale-aqua":"w3-override-yellow",w3_el("id-connect-pub-ip").innerHTML="Public IP address detected by Kiwi: "+w3_div("w3-show-inline-block w3-text-black "+t,e?config_net.pub_ip:"(no public IP address detected)");var n=decodeURIComponent(cfg.server_url),r=n;cfg.sdr_hu_dom_sel==connect_dom_sel.REV?(r+="",8073!=adm.port_ext&&(r+=" (proxy always uses port 80 even though your external port is "+adm.port_ext+")"),w3_set_label("Based on the above selection the URL to connect to your Kiwi is:","connect-url-text")):(r+=":"+adm.port_ext,w3_set_label("Based on above selection, and external port from Network tab, the URL to connect to your Kiwi is:","connect-url-text")),e=""!=n,w3_color("id-connect-url",null,e?"hsl(180, 100%, 95%)":"#ffeb3b"),w3_el("id-connect-url").innerHTML=e?"http://"+r:"(incomplete information)"}function connect_dom_nam_focus(){console.log("connect_dom_nam_focus server_url="+cfg.sdr_hu_dom_name),ext_set_cfg_param("cfg.server_url",cfg.sdr_hu_dom_name,!0),ext_set_cfg_param("cfg.sdr_hu_dom_sel",connect_dom_sel.NAM,!0),connect_update_url()}function connect_dom_duc_focus(){console.log("connect_dom_duc_focus server_url="+adm.duc_host),ext_set_cfg_param("cfg.server_url",adm.duc_host,!0),ext_set_cfg_param("cfg.sdr_hu_dom_sel",connect_dom_sel.DUC,!0),connect_update_url()}function connect_dom_rev_focus(){var e=""==adm.rev_host?"":adm.rev_host+"."+adm.proxy_server;console.log("connect_dom_rev_focus server_url="+e),ext_set_cfg_param("cfg.server_url",e,!0),ext_set_cfg_param("cfg.sdr_hu_dom_sel",connect_dom_sel.REV,!0),connect_update_url()}function connect_dom_pub_focus(){console.log("connect_dom_pub_focus server_url="+config_net.pub_ip),ext_set_cfg_param("cfg.server_url",config_net.pub_ip,!0),ext_set_cfg_param("cfg.sdr_hu_dom_sel",connect_dom_sel.PUB,!0),connect_update_url()}function connect_dom_sip_focus(){console.log("connect_dom_sip_focus server_url="+cfg.sdr_hu_dom_ip),ext_set_cfg_param("cfg.server_url",cfg.sdr_hu_dom_ip,!0),ext_set_cfg_param("cfg.sdr_hu_dom_sel",connect_dom_sel.SIP,!0),connect_update_url()}function connect_dom_name_cb(e,t,a){connect_remove_port(e,t,a),cfg.sdr_hu_dom_sel==connect_dom_sel.NAM&&connect_dom_nam_focus()}function connect_dom_ip_cb(e,t,a){connect_remove_port(e,t,a),cfg.sdr_hu_dom_sel==connect_dom_sel.SIP&&connect_dom_sip_focus()}function connect_remove_port(e,t,a){var n={bad:0,number:1,alpha:2,remove:3},r=n.bad;t=t.replace("http://","");for(var o,l=t.length,d=l-1;0<=d;d--){if(o=t.charAt(d),"0"<=o&&"9">=o){r=n.number;continue}if(":"==o){r==n.number&&(r=n.remove);break}if(r=n.alpha,"]"==o)break}r==n.remove&&(t=t.substr(0,d)),w3_string_set_cfg_cb(e,t,a),admin_set_decoded_value(e)}function connect_url_redirect_cb(e,t,a){""==t||t.startsWith("http://")||(t="http://"+t),w3_string_set_cfg_cb(e,t,a),w3_set_value("id-"+e,t)}function connect_DUC_enabled_cb(e,t,a){t=+t;var n=0==t;!a,admin_bool_cb(e,n,a)}function connect_DUC_start_cb(){var e="-u "+sq(decodeURIComponent(adm.duc_user))+" -p "+sq(decodeURIComponent(adm.duc_pass))+" -H "+sq(decodeURIComponent(adm.duc_host))+" -U "+duc_update_v[adm.duc_update];console.log("start DUC: "+e),w3_innerHTML("id-net-duc-status","Getting status from DUC server..."),ext_send("SET DUC_start args="+encodeURIComponent(e))}function connect_DUC_host_cb(e,t,a){w3_string_set_cfg_cb(e,t,a),cfg.sdr_hu_dom_sel==connect_dom_sel.DUC?connect_dom_duc_focus():connect_update_url()}function connect_DUC_status_cb(e){e=+e,console.log("DUC_status="+e);var t;switch(e){case 0:t="DUC started successfully";break;case 100:t="Incorrect username or password";break;case 101:t="No hosts defined on your account at noip.com; please correct and retry";break;case 102:t="Please specify a host";break;case 103:t="Host given isn't defined on your account at noip.com; please correct and retry";break;case 300:t="DUC start failed";break;case 301:t="DUC enabled and running";break;default:t="DUC internal error: "+e;}w3_el("id-net-duc-status").innerHTML=t}function connect_rev_usage(){w3_show("id-proxy-menu"),w3_scrollDown("id-kiwi-container")}function connect_rev_register_cb(){if(""==adm.rev_user||""==adm.rev_host)return connect_rev_status_cb(100);connect_rev_usage(),kiwi_clearTimeout(connect.timeout),w3_innerHTML("id-connect-rev-status","Getting status from proxy server...");var e="user="+adm.rev_user+" host="+adm.rev_host;console.log("start rev: "+e),ext_send("SET rev_register "+e)}function connect_rev_user_cb(e,t,a){connect_rev_usage(),w3_clearInnerHTML("id-connect-rev-status"),w3_string_set_cfg_cb(e,t,a)}function connect_rev_host_cb(e,t,a){connect_rev_usage(),w3_clearInnerHTML("id-connect-rev-status"),w3_string_set_cfg_cb(e,t,a),cfg.sdr_hu_dom_sel==connect_dom_sel.REV?connect_dom_rev_focus():connect_update_url()}function connect_rev_status_cb(e){if(connect.focus){e=+e,console.log("rev_status="+e);var t;switch(0<=e&&99>=e&&cfg.sdr_hu_dom_sel==connect_dom_sel.REV&&connect_dom_rev_focus(),e){case 0:t="Existing account, registration successful";break;case 1:t="New account, registration successful";break;case 2:t="Updating host name, registration successful";break;case 100:t="User key or host name field blank";break;case 101:t="User key invalid. Did you email your user/API key to support@kiwisdr.com as per the instructions?";break;case 102:t="Host name already in use; please choose another and retry";break;case 103:t="Invalid characters in user key or host name field (use a-z, 0-9, -, _)";break;case 200:t="Reverse proxy enabled and running";break;case 201:t="Reverse proxy enabled and pending";break;case 900:t="Problem contacting proxy server; please check Internet connection";break;case 901:t="Proxy server returned invalid status data?";break;default:t="Reverse proxy internal error: "+e;}w3_innerHTML("id-connect-rev-status",t),201==e&&(connect.timeout=setTimeout(function(){ext_send("SET rev_status_query")},5e3))}}function update_html(){var e=w3_div("id-update w3-hide","<hr>"+w3_div("id-msg-update w3-container")+"<hr>"+w3_div("w3-margin-bottom",w3_half("w3-container","w3-text-teal",w3_div("","<b>Automatically check for software updates?</b> "+w3_switch("","Yes","No","adm.update_check",adm.update_check,"admin_radio_YN_cb")),w3_div("","<b>Automatically install software updates?</b> "+w3_switch("","Yes","No","adm.update_install",adm.update_install,"admin_radio_YN_cb"))),w3_half("w3-container w3-tspace-16","w3-text-teal",w3_div("",w3_select("w3-label-inline","After a restart","","adm.restart_update",adm.restart_update,restart_update_u,"admin_select_cb")),w3_div("",w3_select("w3-label-inline","After an update","","adm.update_restart",adm.update_restart,update_restart_u,"admin_select_cb"))))+"<hr>"+w3_half("w3-container","w3-text-teal",w3_div("w3-valign","<b>Check for software update </b> "+w3_button("w3-aqua w3-margin","Check now","update_check_now_cb")),w3_div("w3-valign","<b>Force software build </b> "+w3_button("w3-aqua w3-margin","Build now","update_build_now_cb")))+"<hr>"+w3_half("w3-margin-bottom w3-text-teal w3-restart","w3-container",w3_divs("w3-tspace-8",w3_div("","<b>Disable recent changes?</b>"),w3_switch("","Yes","No","disable_recent_changes",cfg.disable_recent_changes,"admin_radio_YN_cb"),w3_text("w3-text-black","Currently:<br><ul><li>The Firefox audio hang workaround.</li></ul>")),"")+"<hr>"+w3_div("w3-container","TODO: alt github name")+"<hr>");return e}var restart_update_u={0:"install updates",1:"delay updates until overnight"},update_restart_u={0:"restart server",1:"reboot Beagle"};function update_check_now_cb(){ext_send("SET force_check=1 force_build=0"),w3_el("msg-update").innerHTML=w3_icon("","fa-refresh fa-spin",20)}function update_build_now_cb(){ext_send("SET force_check=1 force_build=1"),0==adm.update_restart?w3_show_block("id-build-restart"):w3_show_block("id-build-reboot")}function backup_html(){var e=w3_div("id-backup w3-hide","<hr>",w3_div("w3-section w3-text-teal w3-bold","Backup configuration by uploading archive to <a href=\"https://transfer.sh\" target=\"_blank\">Transfer.sh</a>"),"<hr>",w3_third("w3-container","w3-valign",w3_button("w3-aqua w3-margin","Click to backup","backup_sd_write"),w3_div("",w3_div("id-progress-container w3-progress-container w3-round-large w3-gray w3-show-inline-block",w3_div("id-progress w3-progressbar w3-round-large w3-light-green w3-width-zero",w3_div("id-progress-text w3-container"))),w3_div("w3-margin-T-8",w3_div("id-progress-time w3-show-inline-block")+w3_div("id-progress-icon w3-show-inline-block w3-margin-left"))),w3_div("id-sd-status class-sd-status")),"<hr>",w3_div("id-output-msg w3-container w3-text-output w3-scroll-down w3-small w3-margin-B-16"));return e}function backup_focus(){w3_el("id-progress-container").style.width=px(300),w3_el("id-output-msg").style.height=px(300)}var sd_progress,backup_sd_interval,sd_progress_max=10,backup_refresh_icon=w3_icon("","fa-refresh fa-spin",20);function backup_sd_write(){var e=w3_el("id-sd-status");e.innerHTML="Backup in progress...",w3_el("id-progress-text").innerHTML=w3_el("id-progress").style.width="0%",sd_progress=-1,backup_sd_progress(),backup_sd_interval=setInterval(backup_sd_progress,1e3),w3_el("id-progress-icon").innerHTML=backup_refresh_icon,ext_send("SET microSD_write")}function backup_sd_progress(){sd_progress++;var e=(100*(sd_progress/sd_progress_max)).toFixed(0);95>=e&&(w3_el("id-progress-text").innerHTML=w3_el("id-progress").style.width=e+"%");var t=(sd_progress%60).toFixed(0).leadingZeros(2),a=Math.floor(sd_progress/60).toFixed(0);w3_el("id-progress-time").innerHTML=a+":"+t}function backup_sd_write_done(e){var t=w3_el("id-sd-status"),a=e?"FAILED error "+e.toString():"WORKED";1==e&&(a+="<br>Internet is not connected"),15==e&&(a+="<br>Failed to upload archive"),t.innerHTML=a,t.style.color=e?"red":"lime",e||(w3_el("id-progress-text").innerHTML=w3_el("id-progress").style.width="100%"),kiwi_clearInterval(backup_sd_interval),w3_el("id-progress-icon").innerHTML=""}var network={auto_nat_color:null,show_updating:!0,ip_blacklist_check_mtime:!0,ip_blacklist_input_prev:null,ethernet_speed_s:["100 Mbps","10 Mbps"],ethernet_mtu_s:["1500 (default)","1440","1400"]};function network_html(){var e=ext_get_cfg_param("adm.ip_address.commit_use_static");console.log("commit_use_static="+e),e==null&&(e=!1),ext_set_cfg_param("adm.ip_address.use_static",e,EXT_SAVE),w3_switch_set_value("adm.ip_address.use_static",e?w3_SWITCH_NO_IDX:w3_SWITCH_YES_IDX),network.ip_blacklist_check_mtime&&(network.ip_blacklist_double_fault=!1,kiwi_ajax("http://kiwisdr.com/ip_blacklist/ip_blacklist.cjson.mtime","network_blacklist_mtime_cb",0,1e4),network.ip_blacklist_check_mtime=!1);var t=w3_div("id-net-auto-nat-msg w3-valign w3-hide")+w3_div("id-net-need-update w3-valign w3-margin-T-8 w3-hide",w3_button("w3-yellow","Are you sure? Click to update interface DHCP/static IP configuration","network_dhcp_static_update_cb"))+"<hr>"+w3_div("id-net-reboot",w3_inline("w3-halign-space-around w3-margin-bottom w3-text-teal/",w3_divs("w3-valign w3-flex-col w3-restart/w3-tspace-6",w3_input_get("","Internal port","adm.port","admin_int_cb"),w3_input_get("","External port","adm.port_ext","admin_int_cb")),w3_divs("w3-center/",w3_select("","Ethernet interface speed","","ethernet_speed",cfg.ethernet_speed,network.ethernet_speed_s,"network_ethernet_speed"),w3_div("w3-text-black","Select 10 Mbps to reduce Ethernet spurs. <br> Try changing while looking at waterfall.")),w3_divs("w3-center/",w3_select("","Ethernet interface MTU","","ethernet_mtu",cfg.ethernet_mtu,network.ethernet_mtu_s,"network_ethernet_mtu"),w3_div("w3-text-black","Select 1440 when having connection <br> problems using 4G networks."))),w3_div("id-net-static w3-hide",w3_div("",w3_third("w3-margin-B-8 w3-text-teal","w3-container",w3_input_get("","IP address (n.n.n.n where n = 0..255)","adm.ip_address.ip","network_ip_address_cb",""),w3_input_get("","Netmask (n.n.n.n where n = 0..255)","adm.ip_address.netmask","network_netmask_cb",""),w3_input_get("","Gateway (n.n.n.n where n = 0..255)","adm.ip_address.gateway","network_gw_address_cb","")),w3_third("w3-margin-B-8 w3-text-teal","w3-container",w3_div("id-network-check-ip w3-green"),w3_div("id-network-check-nm w3-green"),w3_div("id-network-check-gw w3-green")),w3_third("w3-valign w3-margin-bottom w3-text-teal","w3-container",w3_input_get("","DNS-1 (n.n.n.n where n = 0..255)","adm.ip_address.dns1","w3_string_set_cfg_cb",""),w3_input_get("","DNS-2 (n.n.n.n where n = 0..255)","adm.ip_address.dns2","w3_string_set_cfg_cb",""),w3_div("",w3_label("","<br>")+w3_button("w3-show-inline w3-aqua","Use well-known public DNS servers","net_public_dns_cb")))),w3_text("w3-margin-left w3-text-black","If DNS fields are blank the DNS servers specified by your router's DHCP will be used."))),a="<hr>"+w3_div("id-net-config w3-container")+"<hr>"+w3_half("w3-container","",w3_div("",w3_div("",w3_label("w3-show-inline w3-bold w3-text-teal","Check if your external router port is open:")+w3_button("w3-show-inline w3-aqua|margin-left:10px","Check port open","net_port_open_cb")),"Does kiwisdr.com successfully connect to your Kiwi using these URLs?<br>If both respond \"NO\" then check the NAT port mapping on your router.<br>If first responds \"NO\" and second \"YES\" then domain name of the first<br>isn't resolving to the ip address of the second. Check DNS.",w3_div("",w3_label("id-net-check-port-dom-q w3-show-inline-block w3-margin-LR-16 w3-text-teal")+w3_div("id-net-check-port-dom-s w3-show-inline-block w3-text-black w3-background-pale-aqua")),w3_div("",w3_label("id-net-check-port-ip-q w3-show-inline-block w3-margin-LR-16 w3-text-teal")+w3_div("id-net-check-port-ip-s w3-show-inline-block w3-text-black w3-background-pale-aqua"))),w3_div("w3-center",w3_label("w3-bold w3-text-teal","Register this Kiwi on my.kiwisdr.com<br>on each reboot?<br>"),w3_switch("w3-margin-T-8 w3-margin-B-8","Yes","No","adm.my_kiwi",adm.my_kiwi,"admin_radio_YN_cb"),w3_text("w3-block w3-center w3-text-black","Registering on <a href=\"http://my.kiwisdr.com\" target=\"_blank\">my.kiwisdr.com</a> allows the local ip address of Kiwis <br>to be easily discovered. Set to \"no\" if you don't want your Kiwi <br>sending information to kiwisdr.com. Defaults to \"yes\"."))),n="<hr>"+w3_div("w3-container w3-text-teal",w3_inline("w3-valign w3-halign-space-between/",w3_div("",w3_text("w3-bold w3-text-teal","IP address blacklist"),w3_text("w3-text-black w3-show-block","IP addresses/ranges listed here are blocked <br>from accessing your Kiwi (via Linux iptables). <br>Use CIDR notation for ranges, e.g. CIDR \"ip/24\" <br>is equivalent to netmask \"255.255.255.0\" <br>More information at the "+w3_link("w3-link-darker-color","http://forum.kiwisdr.com/index.php?p=/discussion/2352/call-for-ip-address-blacklist-contributions/p1","Kiwi forum")+".")),w3_divs("/w3-center w3-tspace-8",w3_div("",w3_div("w3-margin-T-16","<b>Download IP address blacklist?</b>"),w3_inline("w3-valign w3-halign-space-evenly w3-margin-T-10/",w3_button("id-ip-blacklist-download w3-aqua","Download","network_download_button_cb"),w3_text("id-ip-blacklist-new w3-text-red w3-hide","New blacklist available"))),w3_text("w3-text-black w3-center","WARNING: Download will overwrite anything you have manually entered <br>in the blacklist text area below. Re-enter any changes afterwards. <br>Downloads a standard blacklist definition from kiwisdr.com")),w3_div("w3-center w3-margin-B-24","<b>Prevent multiple connections from<br>the same IP address?</b><br>",w3_switch("w3-margin-T-8 w3-margin-B-8","Yes","No","adm.no_dup_ip",adm.no_dup_ip,"admin_radio_YN_cb"))),w3_inline("w3-valign w3-margin-top/",w3_text("w3-text-teal","Blacklist status:"),w3_div("id-ip-blacklist-status w3-margin-left w3-text-black w3-background-pale-aqua","")),w3_textarea_get_param("w3-margin-T-16//w3-input-any-change|width:100%","","adm.ip_blacklist",8,100,"network_ip_blacklist_cb",""))+"<hr>"+w3_half("w3-margin-bottom w3-text-teal","w3-container",w3_div("w3-restart",w3_input_get("id-proxy-server","Proxy server hostname","adm.proxy_server","network_proxy_server_cb"),w3_div("w3-text-black","Change <b>only</b> if you have implemented a private proxy server. <br>Set to \"p.sdrotg.com\" for the default proxy service.")),w3_div())+"<hr>";return w3_div("id-network w3-hide",t+a+n)}function network_download_button_cb(e,t,a){a||(w3_innerHTML("id-ip-blacklist-status","updating.."+w3_icon("w3-margin-left","fa-refresh fa-spin",20)),kiwi_ajax("http://kiwisdr.com/ip_blacklist/ip_blacklist.cjson","network_download_blacklist_cb",0,1e4))}function network_user_blacklist_cb(e,t){console.log("network_user_blacklist_cb="+t)}function network_download_blacklist_cb(e){var t=!1;if(e?e.AJAX_error?(console.log("network_download_blacklist_cb: "+e.AJAX_error),console.log(e),t=!0):!isArray(e)&&(console.log("network_download_blacklist_cb: not array"),console.log(e),t=!0):(console.log("network_download_blacklist_cb: bl="+e),t=!0),t){if(network.ip_blacklist_double_fault)return console.log("network_download_blacklist_cb: default blacklist fetch FAILED"),console.log(e),void w3_innerHTML("id-ip-blacklist-status","download failed: could not contact kiwisdr.com or find default file");w3_innerHTML("id-ip-blacklist-status","download failed, using default.."+w3_icon("w3-margin-left","fa-refresh fa-spin",20)),network.show_updating=!1;var a=kiwi_url_origin()+"/kiwi/ip_blacklist.default.cjson";return console.log("network_download_blacklist_cb: using default station list "+a),network.ip_blacklist_double_fault=!0,void kiwi_ajax(a,"network_download_blacklist_cb",0,1e4)}network.ip_blacklist_double_fault=!1;var r=[];e.forEach(function(e){if(isString(e)){var t,n=e.split("/");t=1==n.length?32:+n[1];var a=4294967295&~((1<<32-t)-1),o=kiwi_inet4_d2h(n[0]),s=o&a;o!=s&&console.log("ip/netmask mismatch: "+kiwi_ip_str(o)+"|"+o.toHex(8)+" "+kiwi_ip_str(s)+"|"+s.toHex(8)+" "+a.toHex(8)+"/"+t),r.push({ip:s,nm:a,nmd:t,del:0})}}),r.sort(function(e,t){return e.nm-t.nm}),!1;var n=kiwi_dup_array(r);r.forEach(function(e,t){var a=!1;n.forEach(function(n,r){a||r<=t||0==n.ip||(n.ip&e.nm)==e.ip&&(console.log("blacklist: #"+r+" "+kiwi_ip_str(n.ip)+"|"+n.ip.toHex(8)+" "+n.nm.toHex(8)+"/"+n.nmd+" is a subset of #"+t+" "+kiwi_ip_str(e.ip)+"|"+e.ip.toHex(8)+" "+e.nm.toHex(8)+"/"+e.nmd),n.del=1,a=!0)})}),!1;var s=[];n.forEach(function(e){e.del||s.push(e)}),console.log("blacklist post dup entries: #"+s.length),!1;var l="";s.forEach(function(e){l=l+" "+kiwi_ip_str(e.ip)+"/"+e.nmd}),network_ip_blacklist_cb("adm.ip_blacklist",l),network.show_updating=!0,kiwi_ajax("http://kiwisdr.com/ip_blacklist/ip_blacklist.cjson.mtime","network_blacklist_mtime_cb",1,1e4)}function network_blacklist_mtime_cb(e,t){var a=!1;if(e?e.AJAX_error&&"timeout"==e.AJAX_error&&(console.log("network_blacklist_mtime_cb: TIMEOUT"),a=!0):(console.log("network_blacklist_mtime_cb: mt="+e),a=!0),a)return void console.log(e);var n=parseInt(e.response);dbgUs&&console.log("network_blacklist_mtime_cb: "+(t?"UPDATE":"AVAIL")+" mtime="+n+" adm.ip_blacklist_mtime="+adm.ip_blacklist_mtime),t?(w3_remove_then_add("id-ip-blacklist-download","w3-red","w3-aqua"),w3_hide2("id-ip-blacklist-new",!0),w3_int_set_cfg_cb("adm.ip_blacklist_mtime",n)):adm.ip_blacklist_mtime!=n&&(w3_remove_then_add("id-ip-blacklist-download","w3-aqua","w3-red"),w3_hide2("id-ip-blacklist-new",!1))}function network_proxy_server_cb(e,t){t=t.trim(),""==t&&(t="p.sdrotg.com",w3_set_value("id-proxy-server",t)),w3_string_set_cfg_cb(e,t)}function network_ip_blacklist_cb(e,t){var a=t.match(/([^,;\s]+)/gm);null==a&&(a=[]);var n="";return a.forEach(function(e){n+=e+" "}),n==network.ip_blacklist_input_prev?(console.log("blacklist unchanged"),void w3_innerHTML("id-ip-blacklist-status","blacklist up-to-date")):void(network.ip_blacklist_input_prev=n,ext_send("SET network_ip_blacklist_clear"),network.show_updating&&w3_innerHTML("id-ip-blacklist-status","updating.."+w3_icon("w3-margin-left","fa-refresh fa-spin",20)),w3_set_value(e,n),w3_string_set_cfg_cb(e,n),network.seq=0,network.ip_address_error=!1,a.forEach(function(e){ext_send("SET network_ip_blacklist="+encodeURIComponent(e))}),ext_send("SET network_ip_blacklist_enable"))}function network_ip_blacklist_status(e,t){console.log("network_ip_blacklist_status #"+network.seq+" status="+e+" ip="+t),network.seq++;0==e||(network.ip_address_error=!0,w3_innerHTML("id-ip-blacklist-status","ip address error: "+dq(t)))}function network_ethernet_speed(e,t,a){t=+t;a||admin_select_cb(e,t,a)}function network_ethernet_mtu(e,t,a){t=+t;a||admin_select_cb(e,t,a)}function network_port_open_init(){w3_do_when_rendered("id-net-check-port-dom-q",function(){var e=w3_el("id-net-check-port-dom-q"),t=cfg.sdr_hu_dom_sel==connect_dom_sel.REV?80:adm.port_ext;e.innerHTML=""==cfg.server_url?"(incomplete information -- on \"connect\" tab please use a valid setting in menu) :":"http://"+cfg.server_url+":"+t+" :",w3_el("id-net-check-port-dom-s").innerHTML="",w3_el("id-net-check-port-ip-s").innerHTML=""}),w3_do_when_cond(function(){return isArg(config_net.pvt_ip)},function(){w3_el("id-net-check-port-ip-q").innerHTML="http://"+config_net.pvt_ip+":"+adm.port_ext+" :"})}function network_focus(){network_static_init(),network_port_open_init(),network.status_interval=setInterval(network_auto_nat_status_poll,1e3)}function network_blur(){kiwi_clearInterval(network.status_interval)}function network_auto_nat_status_poll(){ext_send("SET auto_nat_status_poll")}function network_check_port_status_cb(e){if(console.log("network_check_port_status_cb status="+e.toHex()),0>e)w3_el("id-net-check-port-dom-s").innerHTML="Error checking port status",w3_el("id-net-check-port-ip-s").innerHTML="Error checking port status";else{w3_el("id-net-check-port-dom-s").innerHTML=240&e?"NO":"YES",w3_el("id-net-check-port-ip-s").innerHTML=15&e?"NO":"YES"}}function net_port_open_cb(){w3_el("id-net-check-port-dom-s").innerHTML=w3_icon("","fa-refresh fa-spin",20),w3_el("id-net-check-port-ip-s").innerHTML=w3_icon("","fa-refresh fa-spin",20),ext_send("SET check_port_open")}function network_dhcp_static_update_cb(){var e=adm.ip_address.use_static;e?(ext_send("SET static_ip="+kiwi_ip_str(network_ip)+" static_nm="+kiwi_ip_str(network_nm)+" static_gw="+kiwi_ip_str(network_gw)),ext_send("SET dns dns1=x"+encodeURIComponent(adm.ip_address.dns1)+" dns2=x"+encodeURIComponent(adm.ip_address.dns2))):ext_send("SET use_DHCP"),ext_set_cfg_param("adm.ip_address.commit_use_static",e,EXT_SAVE),w3_hide("id-net-need-update"),w3_reboot_cb()}function network_static_init(){w3_do_when_rendered("id-net-static",function(){var e=ext_get_cfg_param("adm.ip_address.use_static",!1);network_use_static_cb("adm.ip_address.use_static",e,!0)})}function network_use_static_cb(e,t,a){t=+t;var n=0==t;n?w3_hide("id-net-static"):w3_show_block("id-net-static"),a?(network_ip_address_cb("adm.ip_address.ip",adm.ip_address.ip,!0),network_netmask_cb("adm.ip_address.netmask",adm.ip_address.netmask,!0),network_gw_address_cb("adm.ip_address.gateway",adm.ip_address.gateway,!0)):n?w3_show_block("id-net-need-update"):network_show_update(!1),admin_bool_cb(e,n?0:1,a)}function network_ip_nm_check(e,t){var n,r,o,s,l=/^([0-9]*).([0-9]*).([0-9]*).([0-9]*)$/.exec(e);return null!=l&&(n=parseInt(l[1]),n=255<n?Math.NaN:n,r=parseInt(l[2]),r=255<r?Math.NaN:r,o=parseInt(l[3]),o=255<o?Math.NaN:o,s=parseInt(l[4]),s=255<s?Math.NaN:s),null==l||isNaN(n)||isNaN(r)||isNaN(o)||isNaN(s)?t.ok=!1:(t.ok=!0,t.a=n,t.b=r,t.c=o,t.d=s),t.ok}network_ip={ok:!1,a:null,b:null,c:null,d:null},network_nm={ok:!1,a:null,b:null,c:null,d:null},network_gw={ok:!1,a:null,b:null,c:null,d:null};function network_show_update(e){!e&&network_ip.ok&&network_nm.ok&&network_gw.ok?w3_show_block("id-net-need-update"):w3_hide("id-net-need-update")}function network_show_check(e,t,a,n,r,o,s){if(""!=n){var l=w3_el(e),d=network_ip_nm_check(n,r),c=!0;!0==d&&s!=null&&(c=s(n,r)),!1==d||!1==c?(l.innerHTML="bad "+t+" entered",w3_remove(l,"w3-green"),w3_add(l,"w3-red")):(l.innerHTML=t+" okay, check: "+r.a+"."+r.b+"."+r.c+"."+r.d,w3_remove(l,"w3-red"),w3_add(l,"w3-green"),w3_string_set_cfg_cb(a,n,o)),network_show_update(o)}}function network_ip_address_cb(e,t,a){network_show_check("network-check-ip","IP address",e,t,network_ip,a)}function network_netmask_cb(e,t,a){network_nm.nm=-1,network_show_check("network-check-nm","netmask",e,t,network_nm,a,function(e,t){var a=kiwi_inet4_d2h(e);t.nm=0;for(var n=0;32>n;n++)if(a&1<<n)for(t.nm=32-n;32>n;n++)if(0==(a&1<<n))return t.nm=-1,t.ok=!1,!1;return t.ok=!0,!0}),-1!=network_nm.nm&&(w3_el("network-check-nm").innerHTML+=" (/"+network_nm.nm+")")}function network_gw_address_cb(e,t,a){network_show_check("network-check-gw","gateway",e,t,network_gw,a)}function net_public_dns_cb(){w3_string_set_cfg_cb("adm.ip_address.dns1","1.1.1.1"),w3_set_value("adm.ip_address.dns1","1.1.1.1"),w3_string_set_cfg_cb("adm.ip_address.dns2","8.8.8.8"),w3_set_value("adm.ip_address.dns2","8.8.8.8")}var pin={green:w3_div("cl-leaflet-marker cl-legend-marker|background-color:lime"),red:w3_div("cl-leaflet-marker cl-legend-marker|background-color:red"),yellow:w3_div("cl-leaflet-marker cl-legend-marker|background-color:yellow")},_gps={leaflet:!0,gps_map_loaded:!1,pkgs_maps_js:["pkgs_maps/pkgs_maps.js","pkgs_maps/pkgs_maps.css"],gmap_js:["http://maps.googleapis.com/maps/api/js?key="],RSSI:0,AZEL:1,POS:2,MAP:3,IQ:4,IQ_data:null,iq_ch:0,map_init:0,map_needs_height:0,map_locate:0,map_mkr:[],legend_sep:w3_inline("",pin.green,"Navstar/QZSS only",pin.yellow,"Galileo only",pin.red,"all sats"),legend_all:w3_inline("",pin.green,"all sats (Navstar/QZSS/Galileo)")},E1B_offset_i={0:"-1",1:"-3/4",2:"-1/2",3:"-1/4",4:"0",5:"+1/4",6:"+1/2",7:"+3/4",8:"+1"};function gps_html(){var e=w3_div("id-gps w3-hide|line-height:1.5",w3_inline("w3-valign w3-halign-space-between w3-margin-T-16/",w3_div("w3-valign w3-text-teal",w3_text("w3-text-teal w3-bold w3-small","Acquire"),w3_div("w3-flex-col w3-valign-start w3-margin-L-4",w3_checkbox("w3-label-inline w3-label-not-bold w3-small/w3-small","Navstar","adm.acq_Navstar",adm.acq_Navstar,"gps_acq_cb"),w3_inline("",w3_checkbox("w3-label-inline w3-label-not-bold w3-small/w3-small","QZSS","adm.acq_QZSS",adm.acq_QZSS,"gps_acq_cb"),w3_checkbox("w3-label-inline w3-label-not-bold w3-small w3-margin-left/w3-small/","Priority","adm.QZSS_prio",adm.QZSS_prio,"gps_acq_cb")),w3_checkbox("w3-label-inline w3-label-not-bold w3-small/w3-small","Galileo","adm.acq_Galileo",adm.acq_Galileo,"gps_acq_cb"))),w3_div("w3-valign w3-text-teal",w3_checkbox("w3-label-inline w3-small/w3-small","Acquire<br>if Kiwi<br>busy? [n]","adm.always_acq_gps",adm.always_acq_gps,"w3_bool_set_cfg_cb")),w3_div("w3-valign w3-text-teal",w3_checkbox("w3-label-inline w3-small/w3-small","Set date<br>from GPS?","adm.gps_set_date",adm.gps_set_date,"w3_bool_set_cfg_cb")),w3_div("w3-valign w3-text-teal",w3_checkbox("w3-label-inline w3-small/w3-small","Include<br>alerted sats in<br>solutions? [n]","adm.include_alert_gps",adm.include_alert_gps,"w3_bool_set_cfg_cb")),w3_div("w3-valign w3-text-teal",w3_checkbox("w3-label-inline w3-small/w3-small","Include<br>Galileo in<br>solutions? [y]","adm.include_E1B",adm.include_E1B,"w3_bool_set_cfg_cb")),w3_div("w3-valign w3-text-teal",w3_checkbox("w3-label-inline w3-small/w3-small","Use<br>Kalman<br>filter? [y]","adm.use_kalman_position_solver",adm.use_kalman_position_solver,"w3_bool_set_cfg_cb")),w3_div("w3-valign w3-hcenter w3-text-teal",w3_div("w3-margin-right","<b>Select<br>Graph</b>")+w3_radio_button("w3-margin-R-4","RSSI","adm.rssi_azel_iq",adm.rssi_azel_iq==_gps.RSSI,"gps_graph_cb"),w3_radio_button("w3-margin-R-4","Az/El","adm.rssi_azel_iq",adm.rssi_azel_iq==_gps.AZEL,"gps_graph_cb"),w3_radio_button("w3-margin-R-4","Pos","adm.rssi_azel_iq",adm.rssi_azel_iq==_gps.POS,"gps_graph_cb"),w3_radio_button("w3-margin-R-4","Map","adm.rssi_azel_iq",adm.rssi_azel_iq==_gps.MAP,"gps_graph_cb"),w3_radio_button("","IQ","adm.rssi_azel_iq",adm.rssi_azel_iq==_gps.IQ,"gps_graph_cb")),w3_divs("w3-hcenter w3-text-teal/w3-center",w3_div("id-gps-pos-scale w3-center w3-hide w3-small","<b>Scale</b> ",w3_select("w3-margin-L-5 w3-text-red","","","_gps.pos_scale",9,"1:20","gps_pos_scale_cb")),w3_div("id-gps-iq-ch w3-center w3-hide w3-small","<b>Chan</b> ",w3_select("w3-margin-L-5 w3-text-red","","","_gps.iq_ch",0,"1:12","gps_iq_ch_cb"))))+w3_div("w3-valign",w3_div("id-gps-loading-maps w3-container w3-section w3-card-8 w3-round-xlarge w3-pale-blue|width:100%","loading map..."),w3_div("id-gps-channels w3-container w3-section w3-card-8 w3-round-xlarge w3-pale-blue|width:100%",w3_table("id-gps-ch w3-table-6-8 w3-striped")),w3_div("id-gps-azel-container w3-hide",w3_div("w3-hcenter w3-relative","<img id=\"id-gps-azel-graph\" src=\"gfx/gpsEarth.png\" width=\"400\" height=\"400\" style=\"position:absolute; top:-2px\" />","<canvas id=\"id-gps-azel-canvas\" width=\"400\" height=\"400\" style=\"position:absolute\"></canvas>")),w3_div("id-gps-map-container",w3_div("||id=\"id-gps-map\"",""),w3_div("id-gps-map-legend w3-small w3-margin-left","")))+w3_div("w3-container w3-section w3-card-8 w3-round-xlarge w3-pale-blue",w3_table("id-gps-info w3-table-6-8")));return e}function gps_acq_cb(e,t,a){a||(console.log("gps_acq_cb path="+e+" val="+t),w3_bool_set_cfg_cb(e,t))}function gps_graph_cb(e,t){t=+t,admin_int_cb(e,t),ext_send("SET gps_IQ_data_ch="+(t==_gps.IQ?_gps.iq_ch:0)),w3_show_hide("id-gps-pos-scale",t==_gps.POS),w3_show_hide("id-gps-iq-ch",t==_gps.IQ);var a=w3_el("id-gps-channels");t==_gps.AZEL||t==_gps.MAP?(a.style.width="65%",w3_el("id-gps-azel-container").style.width="35%",w3_el("id-gps-map-container").style.width="35%",_gps.map_needs_height=1):a.style.width="100%",w3_show_hide("id-gps-azel-container",t==_gps.AZEL),w3_show_hide("id-gps-map-container",t==_gps.MAP),gps_update_admin_cb(),t==_gps.AZEL&&ext_send("SET gps_az_el_history")}function gps_E1B_offset_cb(e,t){t=+t,-1==t&&(t=4)}function gps_pos_scale_cb(e,t,a){t=+t,(-1==t||a)&&(t=9),_gps.pos_scale=t+1}function gps_iq_ch_cb(e,t,a){t=+t,(-1==t||a)&&(t=0),_gps.iq_ch=t+1,ext_send("SET gps_IQ_data_ch="+_gps.iq_ch),_gps.IQ_data=null}function gps_gain_cb(e,t,a){t=+t,(-1==t||a)&&(t=0),_gps.gain=t+1,ext_send("SET gps_gain="+_gps.gain)}var gps_interval,gps_azel_interval,gps_has_lat_lon,gps_az_el_history_running=!1;function gps_schedule_azel(){!1==gps_az_el_history_running&&(gps_az_el_history_running=!0,ext_send("SET gps_az_el_history"),gps_azel_interval=setInterval(function(){ext_send("SET gps_az_el_history")},6e4))}function gps_focus(e){_gps.gps_map_loaded?gps_focus2(e):(kiwi_load_js(_gps.leaflet?_gps.pkgs_maps_js:_gps.gmap_js,"gps_focus2"),_gps.gps_map_loaded=!0)}function gps_focus2(){w3_hide("id-gps-loading-maps"),gps_schedule_azel(),ext_send("SET gps_update"),gps_interval=setInterval(function(){ext_send("SET gps_update")},1e3),gps_graph_cb("adm.rssi_azel_iq",adm.rssi_azel_iq)}function gps_blur(){kiwi_clearInterval(gps_interval),kiwi_clearInterval(gps_azel_interval),gps_az_el_history_running=!1,ext_send("SET gps_IQ_data_ch=0")}var gps_nsamp,gps_nsats,gps_now,gps_prn,gps_az=null,gps_el=null,gps_qzs3_az=0,gps_qzs3_el=0,gps_shadow_map=null;function gps_az_el_history_cb(e){gps_nsats=e.n_sats,gps_nsamp=e.n_samp,gps_now=e.now,gps_prn=Array(gps_nsats),gps_az=Array(gps_nsamp*gps_nsats),gps_az.fill(0),gps_el=Array(gps_nsamp*gps_nsats),gps_el.fill(0);for(var t,a=e.sat_seen.length,n=0;n<a;n++)t=e.sat_seen[n],gps_prn[t]=e.prn_seen[n];for(var r=0;r<gps_nsamp;r++)for(var n=0;n<a;n++){var o=r*a+n,s=e.az[o],l=e.el[o],t=e.sat_seen[n],d=r*gps_nsats+t;gps_az[d]=s,gps_el[d]=l}gps_qzs3_az=e.qzs3.az,gps_qzs3_el=e.qzs3.el,gps_shadow_map=kiwi_dup_array(e.shadow_map),gps_update_azel()}var gps_canvas,SUBFRAMES=5,max_rssi=1,refresh_icon=w3_icon("","fa-refresh",20),sub_colors=["w3-red","w3-green","w3-blue","w3-yellow","w3-orange"],gps_last_good_el=[],gps_rssi_azel_iq_s=["RSSI","Az/el","Position solution map","Map","LO PLL IQ"];function gps_update_admin_cb(){if(gps){var e=w3_table_row("",w3_table_heads("w3-right-align","chan","acq","&nbsp;PRN","SNR","eph age","hold","wdog"),w3_table_heads("w3-center","status","subframe"),w3_table_heads("w3-right-align","ov","az","el"),adm.rssi_azel_iq==_gps.RSSI?null:w3_table_heads("w3-right-align","RSSI"),adm.rssi_azel_iq==_gps.AZEL||adm.rssi_azel_iq==_gps.MAP?null:w3_table_heads("w3-center|width:35%",(adm.rssi_azel_iq==_gps.IQ&&_gps.iq_ch?"Channel "+_gps.iq_ch+" ":"")+gps_rssi_azel_iq_s[adm.rssi_azel_iq]));for(var t=0;t<gps.ch.length;t++)e+=w3_table_row("id-gps-ch-"+t,"");w3_el("id-gps-ch").innerHTML=e;for(var a,n=0==gps.stype?"w3-green":1==gps.stype?"w3-yellow":"w3-red",t=0;t<gps.ch.length;t++){a=gps.ch[t],a.rssi>max_rssi&&(max_rssi=a.rssi);var r=0,o="";-1!=a.prn&&("N"!=a.prn_s&&(o=a.prn_s),r=a.prn);for(var l=a.alert?"A":1==a.ACF?"+":2==a.ACF?"-":"U",d=w3_table_cells("w3-right-align",t+1)+w3_table_cells("w3-center",t==gps.FFTch?refresh_icon:"")+w3_table_cells("w3-right-align",r?o+r:"",a.snr?a.snr:"")+w3_table_cells("w3-right-align"+(a.old?" w3-text-red w3-bold":""),a.age)+w3_table_cells("w3-right-align",a.hold?a.hold:"",a.rssi?a.wdog:"")+w3_table_cells("w3-center","<span class=\"w3-tag "+(a.alert?1==a.alert?"w3-red":"w3-green":a.unlock?"w3-yellow":"w3-white")+"\">"+l+"</span><span class=\"w3-tag "+(a.parity?"w3-yellow":"w3-white")+"\">P</span><span class=\"w3-tag "+(a.soln?n:"w3-white")+"\">S</span>"),c="",w=!1,_=4;0<=_;_--){var p;if(a.sub_renew&1<<_)p="w3-grey";else{var m=a.sub&1<<_;p=m?sub_colors[_]:"w3-white",m&&(w=!0)}c+="<span class=\"w3-tag "+p+"\">"+(_+1)+"</span>"}if(d+=w3_table_cells("w3-center",c),d+=w3_table_cells("w3-right-align",a.novfl?a.novfl:"",a.el?a.az:"",a.el?a.el:"",adm.rssi_azel_iq==_gps.RSSI?null:a.rssi?a.rssi:""),adm.rssi_azel_iq==_gps.RSSI){var g=(100*(a.rssi/max_rssi)).toFixed(0),u=w?"w3-light-green":"w3-red";d+=w3_table_cells("",w3_div("w3-progress-container w3-round-xlarge w3-white",w3_div("w3-progressbar w3-round-xlarge "+u+"|width:"+g+"%",w3_div("w3-container w3-text-white",a.rssi))))}else(adm.rssi_azel_iq!=_gps.RSSI||adm.rssi_azel_iq!=_gps.AZEL||adm.rssi_azel_iq!=_gps.MAP)&&0==t&&(d+=w3_table_cells("|vertical-align:top;position:relative;|rowspan="+gps.ch.length,w3_div("w3-hcenter","<canvas id=\"id-gps-canvas\" width=\"400\" height=\"400\" style=\"position:absolute; z-index:2; pointer-events:none\"></canvas>")));w3_el("id-gps-ch-"+t).innerHTML=d}if(e=w3_table_row("",w3_table_heads("","acq","track","good","fixes","f/min","run","TTFF","UTC offset","ADC clock","lat","lon","alt","map"))+w3_table_row("",w3_table_cells("",gps.acq?"yes":"paused",gps.track?gps.track:"",gps.good?gps.good:"",gps.fixes?gps.fixes.toUnits():"",gps.fixes_min,gps.run,gps.ttff?gps.ttff:"",gps.utc_offset?gps.utc_offset:"",gps.adc_clk.toFixed(6)+" ("+gps.adc_corr.toUnits()+")",gps.lat?gps.lat:"",gps.lat?gps.lon:"",gps.lat?gps.alt:"",gps.lat?gps.map:"")),w3_el("id-gps-info").innerHTML=e,gps_canvas=w3_el("id-gps-canvas"),null!=gps_canvas){gps_canvas.ctx=gps_canvas.getContext("2d");var b=gps_canvas.ctx;if(adm.rssi_azel_iq!=_gps.RSSI){if(_gps.map_needs_height){var f=css_style_num(w3_el("id-gps-channels"),"height");f&&(w3_el("id-gps-azel-container").style.height=px(f-24),w3_el("id-gps-map").style.height=px(f-24),_gps.a=enc(gps.a),_gps.map_needs_height=0)}if(adm.rssi_azel_iq==_gps.MAP){if(!_gps.map_init&&!_gps.map_needs_height){if(_gps.leaflet){var h;maxZoom=19;var k={MapTiler_Vector:0,MapTiler_Raster_512:1,MapTiler_Raster_256:2,OSM_Raster:3},v=k.OSM_Raster;if(v==k.MapTiler_Vector&&(h=function(e){return L.mapboxGL({attribution:"<a href=\"https://www.maptiler.com/license/maps/\" target=\"_blank\">&copy; MapTiler</a> <a href=\"https://www.openstreetmap.org/copyright\" target=\"_blank\">&copy; OpenStreetMap contributors</a>",accessToken:"not-needed",style:"https://api.maptiler.com/maps/"+e+"/style.json"+_gps.a})}),v==k.MapTiler_Raster_512||v==k.MapTiler_Raster_256){var S=v==k.MapTiler_Raster_256?"/256":"";h=function(e){return L.tileLayer("hybrid"==e?"https://api.maptiler.com/maps/"+e+S+"/{z}/{x}/{y}{r}.jpg"+_gps.a:"https://api.maptiler.com/maps/"+e+S+"/{z}/{x}/{y}.png"+_gps.a,{tileSize:v==k.MapTiler_Raster_256?256:512,zoomOffset:v==k.MapTiler_Raster_256?0:-1,attribution:"<a href=\"https://www.maptiler.com/copyright/\" target=\"_blank\">&copy; MapTiler</a> <a href=\"https://www.openstreetmap.org/copyright\" target=\"_blank\">&copy; OpenStreetMap contributors</a>",crossOrigin:!0})}}v==k.OSM_Raster&&(h=function(){return maxZoom=18,L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{tileSize:256,zoomOffset:0,attribution:"<a href=\"https://www.openstreetmap.org/copyright\" target=\"_blank\">&copy; OpenStreetMap contributors</a>",crossOrigin:!0})});var T=h("hybrid");_gps.map=L.map("id-gps-map",{maxZoom:maxZoom,minZoom:1}).setView([0,0],1),T.addTo(_gps.map),v!=k.OSM_Raster&&L.control.layers({Satellite:T,Basic:h("basic"),Bright:h("bright"),Positron:h("positron"),Street:h("streets"),Topo:h("topo")},null).addTo(_gps.map)}else{var P=new google.maps.LatLng(0,0),q=w3_el("id-gps-map");_gps.map=new google.maps.Map(q,{zoom:1,center:P,navigationControl:!1,mapTypeControl:!1,streetViewControl:!1,mapTypeId:google.maps.MapTypeId.SATELLITE})}_gps.map_init=1}if(w3_innerHTML("id-gps-map-legend",adm.plot_E1B?_gps.legend_sep:_gps.legend_all),!_gps.MAP_data||!_gps.map_init)return;if(!_gps.map_locate){if(_gps.leaflet)_gps.map.setView([_gps.MAP_data.ref_lat,_gps.MAP_data.ref_lon],15,{duration:0,animate:!1});else{var P=new google.maps.LatLng(_gps.MAP_data.ref_lat,_gps.MAP_data.ref_lon);_gps.map.panTo(P),_gps.map.setZoom(18)}_gps.map_locate=1}for(var M=_gps.MAP_data.MAP.length,R=0;R<M;R++){var A=_gps.MAP_data.MAP[R],u=0==A.nmap?_gps.leaflet?"lime":"green":1==A.nmap?"red":"yellow";if(_gps.leaflet){var E=L.divIcon({className:"fooLM",iconAnchor:[12,12],labelAnchor:[-6,0],popupAnchor:[0,-36],html:"<span class=\"cl-leaflet-marker\" style=\"background-color:"+u+";\"/>"}),N=L.marker([A.lat,A.lon],{icon:E,opacity:1});for(N.addTo(_gps.map),_gps.map_mkr.push(N);12<_gps.map_mkr.length;)_gps.map_mkr.shift().remove()}else{var P=new google.maps.LatLng(A.lat,A.lon),N=new google.maps.Marker({position:P,icon:"http://maps.google.com/mapfiles/ms/icons/"+u+"-dot.png",map:_gps.map});for(_gps.map_mkr.push(N);12<_gps.map_mkr.length;)_gps.map_mkr.shift().setMap(null)}}return void(_gps.MAP_data=null)}if(adm.rssi_azel_iq==_gps.IQ){var D=400;if(b.fillStyle="hsl(0, 0%, 90%)",b.fillRect(0,0,D,D),b.fillStyle="yellow",b.fillRect(D/2,0,1,D),b.fillRect(0,D/2,D,1),!_gps.IQ_data)return;b.fillStyle="black";for(var H=D/2/32768*8,C=_gps.IQ_data.IQ.length,_=0;_<C;_+=2){var z=_gps.IQ_data.IQ[_],I=_gps.IQ_data.IQ[_+1];if(0!=z||0!=I){var U=Math.round(z*H+D/2),B=Math.round(I*H+D/2);(0>U||U>=D)&&(U=0>U?0:D-1),(0>B||B>=D)&&(B=0>B?0:D-1),b.fillRect(U,B,2,2)}}return}if(adm.rssi_azel_iq==_gps.POS){var D=400;if(b.fillStyle="hsl(0, 0%, 90%)",b.fillRect(0,0,D,D),!_gps.POS_data)return;b.fillStyle="black";var O=.001*_gps.pos_scale,H=D/2/O,C=_gps.POS_data.POS.length,K=0;b.globalAlpha=1;var F,Y,Q,W,G,Z,V,X;F=Q=G=V=Number.MAX_VALUE,Y=W=Z=X=Number.MIN_VALUE;for(var _=0;_<C&&(adm.plot_E1B||!(_>=C/2));_+=2){b.fillStyle=_<C/2?"DeepSkyBlue":"black";var J=_gps.POS_data.POS[_];if(0!=J){var $=_gps.POS_data.POS[_+1];J-=_gps.POS_data.ref_lat,$-=_gps.POS_data.ref_lon;var U=Math.round($*H+D/2),B=Math.round(-J*H+D/2);(0>U||U>=D)&&(U=0>U?0:D-1,K++),(0>B||B>=D)&&(B=0>B?0:D-1,K++);_<C/2?(b.fillRect(U-2,B-2,5,5),U+8>Y?Y=U+8:U-8<F&&(F=U-8),B+8>W?W=B+8:B-8<Q&&(Q=B-8)):(b.fillRect(U,B-2,1,5),b.fillRect(U-2,B,5,1),U+8>Z?Z=U+8:U-8<G&&(G=U-8),B+8>X?X=B+8:B-8<V&&(V=B-8))}}Y>=D&&(Y=D-1),0>F&&(F=0),W>=D&&(W=D-1),0>Q&&(Q=0),line_stroke(b,0,1,"DeepSkyBlue",F,Q,Y,Q),line_stroke(b,0,1,"DeepSkyBlue",F,W,Y,W),line_stroke(b,1,1,"DeepSkyBlue",F,Q,F,W),line_stroke(b,1,1,"DeepSkyBlue",Y,Q,Y,W),adm.plot_E1B&&(Z>=D&&(Z=D-1),0>G&&(G=0),X>=D&&(X=D-1),0>V&&(V=0),line_stroke(b,0,1,"black",G,V,Z,V),line_stroke(b,0,1,"black",G,X,Z,X),line_stroke(b,1,1,"black",G,V,G,X),line_stroke(b,1,1,"black",Z,V,Z,X));var U=16,B=D-32;return b.font="15px Courier",b.fillStyle="DeepSkyBlue",b.fillRect(U-2,B-2-4,5,5),U+=12,b.fillStyle="black",b.fillText((adm.plot_E1B?" w/o Galileo span: ":"All sats span: ")+_gps.POS_data.y0span.toFixed(0).fieldWidth(4)+"m Ylat "+_gps.POS_data.x0span.toFixed(0).fieldWidth(4)+"m Xlon",U,B),void(adm.plot_E1B&&(U-=12,B+=18,b.fillStyle="black",b.fillRect(U,B-2-4,1,5),b.fillRect(U-2,B-4,5,1),U+=12,b.fillText("with Galileo span: "+_gps.POS_data.y1span.toFixed(0).fieldWidth(4)+"m Ylat "+_gps.POS_data.x1span.toFixed(0).fieldWidth(4)+"m Xlon",U,B)))}}}}}function gps_update_azel(){if(adm.rssi_azel_iq==_gps.AZEL&&null!=gps_el){var e=w3_el("id-gps-azel-canvas");if(null!=e){e.ctx=e.getContext("2d");var t=e.ctx;if(t.clearRect(0,0,400,400),adm.rssi_azel_iq==_gps.AZEL&&gps_shadow_map){t.fillStyle="cyan",t.globalAlpha=.1;for(var a=4,o=2*a+1,s=0;360>s;s++)for(var l=s*Math.PI/180,d=gps_shadow_map[s],c=0,w=1;32>c;c++,w<<=1)if(d&w){var _=90*(c/31),p=180*((90-_)/90),h=Math.round(p*Math.sin(l)),g=Math.round(p*Math.cos(l));t.fillRect(h+200-a-1,200-g-a-1,o+2,o+2)}t.globalAlpha=1}if(t.strokeStyle="black",t.miterLimit=2,t.lineJoin="circle",t.font="13px Verdana",0<gps_qzs3_el){var l=gps_qzs3_az*Math.PI/180,p=180*((90-gps_qzs3_el)/90),h=Math.round(p*Math.sin(l)),g=Math.round(p*Math.cos(l));h+=200,g=200-g,t.lineWidth=1,t.beginPath(),t.arc(h,g,10,0,2*Math.PI),t.stroke(),h=12,g=30,t.lineWidth=1,t.beginPath(),t.arc(h,g,10,0,2*Math.PI),t.stroke();t.fillStyle="black",t.lineWidth=1,t.fillText("QZS-3",h+16,g+4)}t.fillStyle="black";for(var u=0;u<gps_nsats;u++)gps_last_good_el[u]=-1;for(var f=gps_nsamp-10;-1<=f;f--)for(var k,u=0;u<gps_nsats;u++)if(k=-1==f?gps_last_good_el[u]:f,-1!=f||-1!=k){var v=gps_now-k;0>v&&(v+=gps_nsamp),i=v*gps_nsats+u;var s=gps_az[i],_=gps_el[i];if(0!=_){gps_last_good_el[u]=f;var l=s*Math.PI/180,p=180*((90-_)/90),h=Math.round(p*Math.sin(l)),g=Math.round(p*Math.cos(l));if(-1==f){var S=gps_prn[u],T=t.measureText(S).width,P=180>=s?-T-8:8;t.fillStyle=1<k?"pink":"yellow",t.lineWidth=3,t.strokeText(S,h+P+200,200-g+5),t.lineWidth=1,t.fillText(S,h+P+200,200-g+5);var a=3,o=7;t.fillStyle="black",t.fillRect(h+200-3-1,200-g-3-1,9,9),t.fillStyle=1<k?"red":"yellow",t.fillRect(h+200-3,200-g-3,7,7)}else t.fillStyle="black",t.fillRect(h+200,200-g,2,2)}}}}}var log={},nlog=256;function log_html(){var e=w3_div("id-log w3-text-teal w3-hide","<hr>"+w3_div("w3-container",w3_inline("w3-valign w3-halign-space-between/",w3_div("",w3_label("w3-show-inline","KiwiSDR server log (scrollable list, first and last set of messages)"),w3_button("w3-aqua|margin-left:10px","Dump","log_dump_cb"),w3_button("w3-blue|margin-left:10px","Clear Histogram","log_clear_hist_cb")),w3_div("","<b>Log connections from local ip addresses?</b> ",w3_switch("","Yes","No","adm.log_local_ip",adm.log_local_ip,"admin_radio_YN_cb"))),w3_div("id-log-msg w3-margin-T-8 w3-text-output w3-small w3-text-black","")));return e}function log_setup(){for(var e=w3_el("id-log-msg"),t="<pre>",a=0;a<nlog;a++)a==nlog/2&&(t+="<code id=\"id-log-not-shown\"></code>"),t+="<code id=\"id-log-"+a+"\"></code>";t+="</pre>",e.innerHTML=t,ext_send("SET log_update=1")}function log_dump_cb(){ext_send("SET log_dump")}function log_clear_hist_cb(){ext_send("SET log_clear_hist")}function log_resize(){var e=w3_el("id-log-msg");if(e){var t=window.innerHeight-w3_el("id-admin-header-container").clientHeight-100;e.style.height=px(t)}}var log_interval;function log_focus(){log_resize(),log_update(),log_interval=setInterval(log_update,3e3)}function log_blur(){kiwi_clearInterval(log_interval)}function log_update(){ext_send("SET log_update=0")}var console_status_msg_p={scroll_only_at_bottom:!0,inline_returns:!0,process_return_alone:!1,remove_returns:!1,ncol:160};function console_html(){var e=w3_div("id-console w3-section w3-text-teal w3-hide",w3_div("w3-container",w3_div("",w3_label("w3-show-inline","Beagle Debian console")+w3_button("w3-aqua|margin-left:10px","Connect","console_connect_cb")),w3_div("id-console-msg w3-margin-T-8 w3-text-output w3-scroll-down w3-small w3-text-black|background-color:#a8a8a8","<pre><code id=\"id-console-msgs\"></code></pre>"),w3_div("w3-margin-top",w3_input("","","console_input","","console_input_cb|console_ctrl_cb","enter shell command")),w3_text("w3-text-black w3-margin-top","Control characters (^C, ^D, ^\\) and empty lines may now be typed directly into shell command field.")));return e}function console_input_cb(e,t){ext_send("SET console_w2c="+encodeURIComponent(t+"\n")),w3_set_value(e,"")}function console_connect_cb(){ext_send("SET console_open")}function console_ctrl_cb(e){ext_send("SET console_ctrl="+e)}function console_setup(){}function console_resize(){var e=w3_el("id-console-msg");if(e){var t=window.innerHeight-w3_el("id-admin-header-container").clientHeight-200;e.style.height=px(t)}}function console_focus(){console_resize()}function console_blur(){}function security_html(){var e=ext_get_cfg_param("chan_no_pwd",0);e=Math.min(e,rx_chans-1);for(var t={0:"none"},a=1;a<rx_chans;a++)t[a]=a.toFixed(0);var n="<hr>"+w3_inline_percent("w3-container/w3-hspace-16 w3-text-teal",w3_div("",w3_div("","<b>User auto-login from local net<br>even if password set?</b><br>",w3_switch("w3-margin-T-8","Yes","No","adm.user_auto_login",adm.user_auto_login,"admin_radio_YN_cb"))),25,w3_div("w3-center",w3_select("","Number of channels<br>not requiring a password<br>even if password set","","chan_no_pwd",e,t,"admin_select_cb"),w3_div("w3-margin-T-8 w3-text-black","Set this and a password to create two sets of channels. Some that have open-access requiring no password and some that are password protected.")),30,w3_div(""),1,w3_div("",w3_input("w3-encrypted","User password","adm.user_password","","security_set_upw_cb","No password set: unrestricted Internet access to SDR")),40)+"<hr>"+w3_inline_percent("w3-container/w3-hspace-16 w3-text-teal",w3_div("",w3_div("","<b>Admin auto-login from local net<br>even if password set?</b><br>",w3_switch("w3-margin-T-8","Yes","No","adm.admin_auto_login",adm.admin_auto_login,"admin_radio_YN_cb"))),25,w3_div("w3-text-teal",""),30,w3_div(""),1,w3_div("",w3_input("w3-encrypted","Admin password","adm.admin_password","","security_set_apw_cb","No password set: no admin access from Internet allowed")),40),r="<hr>"+w3_inline_percent("w3-container/w3-hspace-16 w3-text-teal",w3_div("",w3_div("","<b>Allow GPS timestamp information <br> to be sent on the network?</b><br>",w3_switch("w3-margin-T-8","Yes","No","adm.GPS_tstamp",adm.GPS_tstamp,"admin_radio_YN_cb"))),25,w3_div("w3-text-black","Set to \"No\" to prevent timestamp information from your GPS (assuming it is working) from being used by applications on the Internet such as the TDoA service. You would only do this if you had some concern about your publicly-listed Kiwi participating in these kinds of projects. "),33,w3_div("w3-text-black"),1,w3_div("w3-text-black","However we expect most Kiwi owners will want to participate and we encourage you to do so. Your precise GPS location is not revealed by the timestamp information. For more discussion please see the "+w3_link("w3-link-darker-color","http://forum.kiwisdr.com/discussion/1218/participation-of-kiwis-in-the-tdoa-process/p1","Kiwi forum")+"."),33)+"<hr>";return w3_div("id-security w3-hide",n+r)}function security_focus(){admin_set_decoded_value("adm.user_password"),admin_set_decoded_value("adm.admin_password")}function security_set_upw_cb(e,t,a){adm.user_pwd_seq=+adm.user_pwd_seq+1,w3_string_set_cfg_cb(e,t,a)}function security_set_apw_cb(e,t,a){adm.admin_pwd_seq=+adm.admin_pwd_seq+1,w3_string_set_cfg_cb(e,t,a)}var admin_colors=["w3-hover-red","w3-hover-blue","w3-hover-purple","w3-hover-black","w3-hover-aqua","w3-hover-pink","w3-hover-yellow","w3-hover-khaki","w3-hover-green","w3-hover-orange","w3-hover-grey","w3-hover-lime","w3-hover-indigo","w3-hover-brown","w3-hover-teal","w3-hover-blue-grey"];function admin_main(){window.addEventListener("resize",admin_resize)}function admin_resize(){log_resize(),console_resize()}function kiwi_ws_open(e,t,a){return open_websocket(e,t,a,admin_msg,admin_recv)}function admin_draw(e){var t=w3_el("id-admin"),a=0,n="";e||(n+=w3_nav(admin_colors[a++],"GPS","gps","admin_nav")),n+=w3_nav(admin_colors[a++],"Status","status","admin_nav")+w3_nav(admin_colors[a++],"Mode","mode","admin_nav")+w3_nav(admin_colors[a++],"Control","control","admin_nav")+w3_nav(admin_colors[a++],"Connect","connect","admin_nav"),e&&(n+=w3_nav(admin_colors[a++],"Config","config","admin_nav")+w3_nav(admin_colors[a++],"Webpage","webpage","admin_nav")+w3_nav(admin_colors[a++],"Public","sdr_hu","admin_nav")+w3_nav(admin_colors[a++],"DX","dx","admin_nav")),n+=w3_nav(admin_colors[a++],"Backup","backup","admin_nav")+w3_nav(admin_colors[a++],"Network","network","admin_nav")+(e?w3_nav(admin_colors[a++],"GPS","gps","admin_nav"):"")+w3_nav(admin_colors[a++],"Log","log","admin_nav")+(e?w3_nav(admin_colors[a++],"Extensions","extensions","admin_nav"):"")+w3_nav(admin_colors[a++],"Security","security","admin_nav"),t.innerHTML=w3_div("id-admin-header-container","<header class=\"w3-container w3-teal\"><h5>Admin interface</h5></header>"+w3_navbar("w3-border w3-light-grey",n)+w3_divs("id-restart w3-hide/w3-valign","<header class=\"w3-show-inline-block w3-container w3-red\"><h5>Restart required for changes to take effect</h5></header>"+w3_div("w3-show-inline-block",w3_button("w3-green w3-margin","KiwiSDR server restart","admin_restart_now_cb"))+w3_div("w3-show-inline-block",w3_button("w3-yellow w3-margin","cancel","admin_restart_cancel_cb")))+w3_divs("id-reboot w3-hide/w3-valign","<header class=\"w3-show-inline-block w3-container w3-red\"><h5>Reboot required for changes to take effect</h5></header>"+w3_div("w3-show-inline-block",w3_button("w3-green w3-margin","Beagle reboot","admin_reboot_now_cb"))+w3_div("w3-show-inline-block",w3_button("w3-yellow w3-margin","cancel","admin_reboot_cancel_cb")))+w3_div("id-build-restart w3-valign w3-hide","<header class=\"w3-container w3-blue\"><h5>Server will restart after build</h5></header>")+w3_div("id-build-reboot w3-valign w3-hide","<header class=\"w3-container w3-red\"><h5>Beagle will reboot after build</h5></header>")),n=e?status_html():gps_html()+status_html(),n+=mode_html()+control_html()+connect_html(),e&&(n+=config_html()+webpage_html()+kiwi_reg_html()+dx_html()),n+=update_html()+backup_html()+network_html()+(e?gps_html():"")+log_html()+console_html()+(e?extensions_html():"")+security_html(),t.innerHTML+=n,log_setup(),console_setup(),stats_init(),e?users_init({admin:1}):gps_focus(),w3_show_block("id-admin");var r=e?"status":"gps";w3_click_nav(kiwi_toggle(toggle_e.FROM_COOKIE|toggle_e.SET,r,r,"last_admin_navbar"),"admin_nav"),setTimeout(function(){setInterval(status_periodic,5e3)},1e3)}function admin_nav_focus(e){w3_click_nav(e,e),writeCookie("last_admin_navbar",e)}function admin_nav_blur(e){w3_call(e+"_blur")}var gps=null;function admin_msg(e){switch(e[0]){case"gps_update_cb":gps=kiwi_JSON_parse("gps_update_cb",decodeURIComponent(e[1])),w3_call("gps_update_admin_cb");break;case"gps_IQ_data_cb":_gps.IQ_data=kiwi_JSON_parse("gps_IQ_data_cb",decodeURIComponent(e[1]));break;case"gps_POS_data_cb":_gps.POS_data=kiwi_JSON_parse("gps_POS_data_cb",decodeURIComponent(e[1]));break;case"gps_MAP_data_cb":_gps.MAP_data=kiwi_JSON_parse("gps_MAP_data_cb",decodeURIComponent(e[1]));break;case"gps_az_el_history_cb":var t=kiwi_JSON_parse("gps_az_el_history_cb",decodeURIComponent(e[1]));t&&w3_call("gps_az_el_history_cb",t);break;case"dx_json":console.log("dx_json len="+e[1].length);var a=kiwi_JSON_parse("dx_json",kiwi_decodeURIComponent("dx_json",e[1]));a&&dx_json(a);break;default:return!1;}return!0}var log_msg_idx,log_msg_not_shown=0,admin_sdr_mode=1;function admin_recv(e){for(var t,a=arrayBufferToString(e),n=a.substring(4).split(" "),r=0;r<n.length;r++)switch(t=n[r].split("="),t[0]){case"admin_sdr_mode":admin_sdr_mode=+t[1]?1:0;break;case"is_multi_core":admin.is_multi_core=!0;break;case"init":rx_chans=rx_chan=+t[1],-1==rx_chans?w3_innerHTML("id-admin","<header class=\"w3-container w3-red\"><h5>Admin interface</h5></header><p>To use the new admin interface you must edit the configuration parameters from your current kiwi.config/kiwi.cfg into kiwi.config/kiwi.json<br>Use the file kiwi.config/kiwi.template.json as a guide.</p>"):(admin_draw(admin_sdr_mode),ext_send("SET extint_load_extension_configs"));break;case"ext_call":var o=decodeURIComponent(t[1]).split("="),l=o[0],d=1<o.length?o[1]:null;w3_call(l,d);break;case"public_update":public_update(t[1]);break;case"auto_nat":var c,w,_=+t[1],m=w3_el("id-net-auto-nat-msg");switch(_){case 0:break;case 1:c="succeeded",w="w3-green";break;case 2:c="no device found",w="w3-orange";break;case 3:c="rule already exists",w="w3-yellow";break;case 4:c="command failed",w="w3-red";break;case 5:c="pending",w="w3-yellow";break;default:}_&&m&&(m.innerHTML="<header class=\"w3-container\"><h5>Automatic add of NAT rule on firewall / router: "+c+"</h5></header>",w3_remove_then_add(m,network.auto_nat_color,w),network.auto_nat_color=w,w3_show_block(m));break;case"log_msg_not_shown":if(log_msg_not_shown=parseInt(t[1]),log_msg_not_shown){var m=w3_el("id-log-not-shown");m.innerHTML="---- "+log_msg_not_shown.toString()+" lines not shown ----\n"}break;case"log_msg_idx":log_msg_idx=parseInt(t[1]);break;case"log_msg_save":var m=w3_el("id-log-"+log_msg_idx);if(!m)break;var h=w3_el("id-log-msg"),g=kiwi_isScrolledDown(h),u=kiwi_decodeURIComponent("log_msg_save",t[1]).replace(/</g,"&lt;").replace(/>/g,"&gt;");m.innerHTML=u,w3_scrollDown(h,g);break;case"log_update":log_update(t[1]);break;case"microSD_done":backup_sd_write_done(parseFloat(t[1]));break;case"DUC_status":connect_DUC_status_cb(parseFloat(t[1]));break;case"rev_status":connect_rev_status_cb(parseFloat(t[1]));break;case"check_port_status":network_check_port_status_cb(parseInt(t[1]));break;case"console_c2w":console_status_msg_p.s=t[1],kiwi_output_msg("id-console-msgs","id-console-msg",console_status_msg_p);break;case"console_done":console.log("## console_done");break;case"config_clone_status":config_clone_status_cb(parseInt(t[1]));break;case"network_ip_blacklist_status":_=decodeURIComponent(t[1]).split(","),network_ip_blacklist_status(parseInt(_[0]),_[1]);break;case"network_ip_blacklist_enabled":network.ip_address_error||w3_innerHTML("id-ip-blacklist-status","updated");break;default:console.log("ADMIN UNKNOWN: "+t[0]+"="+t[1]);}}function w3_restart_cb(){w3_show_block("id-restart"),w3_scrollTop("id-kiwi-container")}function w3_reboot_cb(){w3_show_block("id-reboot"),w3_scrollTop("id-kiwi-container")}var admin_reload_secs,admin_reload_rem,admin_pie_size=25;function admin_draw_pie(){w3_el("id-admin-reload-secs").innerHTML="Admin page reload in "+admin_reload_rem+" secs",0<admin_reload_rem?(admin_reload_rem--,kiwi_draw_pie("id-admin-pie",admin_pie_size,(admin_reload_secs-admin_reload_rem)/admin_reload_secs)):window.location.reload(!0)}function admin_wait_then_reload(e,t){var a,n=w3_el("id-admin");a=e?w3_divs("w3-valign w3-margin-T-8/w3-container",w3_div("w3-show-inline-block",kiwi_pie("id-admin-pie",admin_pie_size,"#eeeeee","deepSkyBlue")),w3_div("w3-show-inline-block",w3_div("id-admin-reload-msg"),w3_div("id-admin-reload-secs"))):w3_divs("w3-valign w3-margin-T-8/w3-container",w3_div("id-admin-reload-msg"));var r="<header class=\"w3-container w3-teal\"><h5>Admin interface</h5></header>"+a;n.innerHTML=r,t&&(w3_el("id-admin-reload-msg").innerHTML=t),e&&(admin_reload_rem=admin_reload_secs=e,setInterval(admin_draw_pie,1e3),admin_draw_pie())}function admin_restart_now_cb(){ext_send("SET restart"),admin_wait_then_reload(60,"Restarting KiwiSDR server")}function admin_restart_cancel_cb(){w3_hide("id-restart")}function admin_reboot_now_cb(){ext_send("SET reboot"),admin_wait_then_reload(90,"Rebooting Beagle")}function admin_reboot_cancel_cb(){w3_hide("id-reboot")}function admin_int_cb(e,t){t=parseInt(t),isNaN(t)?t=ext_get_cfg_param(e):ext_set_cfg_param(e,t,!0),w3_set_value(e,t)}function admin_float_cb(e,t){t=parseFloat(t),isNaN(t)?(t=ext_get_cfg_param(e),w3_set_value(e,t)):ext_set_cfg_param(e,t,!0)}function admin_bool_cb(e,t,a){ext_set_cfg_param(e,!!t,!(a!=null)||!a)}function admin_set_decoded_value(e){var t=ext_get_cfg_param(e);w3_set_decoded_value(e,t)}function admin_radio_YN_cb(e,t){admin_bool_cb(e,t?0:1)}function admin_select_cb(e,t,a){if(t=+t,-1!=t){ext_set_cfg_param(e,t,!a)}}function admin_slider_cb(e,t,a,n){!a||n||(t=+t,ext_set_cfg_param(e,t,!0))}function admin_preview_status_box(e,t){var a=kiwi_decodeURIComponent("admin_preview_status_box:"+e,t);return a&&""!=a||(a="&nbsp;"),a}