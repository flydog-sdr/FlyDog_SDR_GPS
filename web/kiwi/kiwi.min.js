

/* web/kiwi/kiwi.min.js (web/kiwi/kiwi.js = Mon Oct 17 06:26:42 2022) */
var kiwi={d:{},isOffset:false,is_local:[],loaded_files:{},WSPR_rgrid:'',GPS_fixes:0,wf_fps:0,is_multi_core:0,log2_seq:0,inactivity_panel:false,no_admin_conns_pend:0,foff_error_pend:0,notify_seq:0,ident_min:16,volume:50,volume_f:1e-6,muted:1,unmuted_color:'lime',pan:0,queued:0,modes_l:['am','amn','usb','lsb','cw','cwn','nbfm','iq','drm','usn','lsn','sam','sal','sau','sas','qam'],modes_u:[],modes_s:{},cfg_fields:['min','max','chan'],ITU_s:['any','R1: Europe, Africa','R2: North & South America','R3: Asia / Pacific','show on band scale only','show on band menu only'],ITU_ANY:0,BAND_SCALE_ONLY:4,BAND_MENU_ONLY:5,RX4_WF4:0,RX8_WF2:1,RX3_WF3:2,RX14_WF0:3,cmap_s:['Kiwi','CuteSDR','grey','linear','turbo','SdrDx','custom 1','custom 2','custom 3','custom 4'],cmap_e:{kiwi:0,CuteSDR:1,greyscale:2,linear:3,turbo:4,SdrDx:5,custom_1:6,custom_2:7,custom_3:8,custom_4:9},aper_s:['man','auto'],aper_e:{man:0,auto:1},esc_lt:'\x11',esc_gt:'\x12',xdLocalStorage_ready:false,prefs_import_ch:-1,ADC_CLK_CORR_DISABLED:0,ADC_CLK_CORR_CONTINUOUS:1,pre_samps:0,pre_size:0,pre_last:0,pre_buf:null,pre_data:null,pre_off:0,pre_captured:false,pre_wrapped:false,pre_ping_pong:0,_last_:null};kiwi.modes_l.forEach(function(e,i){kiwi.modes_u.push(e.toUpperCase());kiwi.modes_s[e]=i});var WATERFALL_CALIBRATION_DEFAULT=-13;var SMETER_CALIBRATION_DEFAULT=-13;var rx_chans,wf_chans,wf_chans_real,max_camp;var rx_chan=null;var try_again="";var conn_type;var seriousError=false;var timestamp;var optbar_prefix_color='w3-text-css-orange';var dbgUs=false;var dbgUsFirst=true;var gmap;function kiwi_bodyonload(error){if(error!=''){kiwi_serious_error(error);}
else
if(kiwi_isSmartTV()=='LG'&&kiwi_isChrome()<87){var s='Browser: '+navigator.userAgent+'<br>Sorry, KiwiSDR requires SmartTV Chrome version >= 87';kiwi_serious_error(s);}else{if(initCookie('ident',"").startsWith('ZL/KF6VO'))dbgUs=true;conn_type=html('id-kiwi-container').getAttribute('data-type');if(conn_type=='undefined')conn_type='kiwi';console.log('conn_type='+conn_type);w3int_init();var d=new Date();timestamp=d.getTime();if(conn_type=='kiwi'){extint.ws=owrx_ws_open_snd(kiwi_open_ws_cb,{conn_type:conn_type});}else{extint.ws=kiwi_ws_open(conn_type,kiwi_open_ws_cb,{conn_type:conn_type});}}}
function kiwi_open_ws_cb(p){if(p.conn_type!='kiwi')
setTimeout(function(){setInterval(function(){ext_send("SET keepalive")},5000)},5000);if(seriousError)
return;ext_hasCredential(p.conn_type,kiwi_valpwd1_cb,p);}
function kiwi_load_js_polled(obj,js_files){if(!obj.started){kiwi_load_js(js_files,function(){obj.finished=true;});obj.started=true;obj.finished=false;}
return obj.finished;}
function kiwi_load_js_dir(dir,js_files,cb_post,cb_pre){for(var i=0;i<js_files.length;i++){js_files[i]=dir+js_files[i];}
kiwi_load_js(js_files,cb_post,cb_pre);}
function kiwi_load_js(js_files,cb_post,cb_pre){console.log('DYNLOAD START');js_files.push('kiwi/kiwi_js_load.js');console.log(js_files);var loaded_any=false;js_files.forEach(function(src,i){if(!kiwi.loaded_files[src]){if(!src.includes('kiwi_js_load.js')){kiwi.loaded_files[src]=1;loaded_any=true;}else{if(!loaded_any)return;}
var unknown_ext=false;var script;if(src.endsWith('.js')||src.includes('/js?key=')){script=document.createElement('script');script.src=src;script.type='text/javascript';if(src=='kiwi/kiwi_js_load.js'){script.kiwi_js=js_files[i-1];script.kiwi_cb=cb_post;}}else
if(src.endsWith('.css')){script=document.createElement('link');script.rel='stylesheet';script.href=src;script.type='text/css';}else
unknown_ext=true;if(unknown_ext){console.log('DYNLOAD UNKNOWN FILETYPE '+src);}else{script.async=false;document.head.appendChild(script);console.log('DYNLOAD loading '+src);}}else{console.log('DYNLOAD already loaded: '+src);}});console.log('DYNLOAD FINISH');if(!loaded_any){if(cb_pre){console.log('DYNLOAD call pre');w3_call(cb_pre,false);}
if(cb_post){console.log('DYNLOAD call post');w3_call(cb_post);}}else{if(cb_pre){console.log('DYNLOAD call pre subsequent');w3_call(cb_pre,true);}}}
function kiwi_ask_pwd_cb(path,val,first){ext_valpwd(conn_type,val);}
function kiwi_queue_or_camp_cb(path,val,first){var url=window.location.href;console.log(url);url=url+kiwi_add_search_param(window.location,'camp');console.log('--> '+url);window.location.href=url;}
function kiwi_ask_pwd(conn_kiwi){console.log('kiwi_ask_pwd chan_no_pwd_true='+chan_no_pwd_true+' client_public_ip='+client_public_ip);var s1='',s2='';if(conn_kiwi&&chan_no_pwd_true){s1='All channels busy that don\'t require a password ('+chan_no_pwd_true+'/'+rx_chans+')<br>';s2='<br> <b>OR</b> <br><br> click to queue for an available channel, <br>'+'or camp on an existing channel: <br>'+
w3_button('w3-medium w3-padding-smaller w3-aqua w3-margin-T-8','Queue or Camp','kiwi_queue_or_camp_cb');}
var prot=(kiwi_url_param(['p','prot','protected'],true,false)&&conn_kiwi);if(prot)s1='You have requested a password protected channel<br>';var s="KiwiSDR: software-defined receiver <br>"+s1+try_again+
w3_input('w3-retain-input-focus w3-margin-TB-8/w3-label-inline w3-label-not-bold/kiwi-pw|padding:1px|size=40','Password:','id-pwd','','kiwi_ask_pwd_cb')+
s2;kiwi_show_msg(s);w3_field_select('id-pwd',{mobile:1});}
var body_loaded=false;function kiwi_valpwd1_cb(badp,p){if(seriousError)
return;if(badp==1){kiwi_ask_pwd(p.conn_type=='kiwi');try_again='Try again. ';}else
if(badp==2){kiwi_show_msg('Still determining local interface address.<br>Please try reloading page in a few moments.');}else
if(badp==3){kiwi_show_msg('Admin connections not allowed from this ip address.');}else
if(badp==4){kiwi_show_msg('No admin password set. Can only connect from same local network as Kiwi.<br>Client ip = '+client_public_ip);}else
if(badp==5){kiwi_show_msg('Multiple connections from the same ip address not allowed.<br>Client ip = '+client_public_ip);}else
if(badp==6){kiwi_show_msg('Database update in progress.<br>Please try reloading page after one minute.');}else
if(badp==0){if(p.conn_type=='kiwi'){extint.ws=owrx_ws_open_wf(kiwi_open_ws_cb2,p);}else{kiwi_valpwd2_cb(0,p);}}}
function kiwi_open_ws_cb2(p){ext_hasCredential(p.conn_type,kiwi_valpwd2_cb,p);}
function kiwi_valpwd2_cb(badp,p){if(seriousError)
return;kiwi_show_msg('');if(!body_loaded){body_loaded=true;if(p.conn_type!='kiwi'){w3_hide('id-kiwi-msg-container');w3_show_block('id-kiwi-container');w3_el('id-kiwi-body').style.overflow='hidden';}
try{kiwi_init();w3_call(p.conn_type+'_main');}catch(ex){console.log('EX: '+ex);console.log('kiwi_valpwd2_cb: no interface routine for '+p.conn_type+'?');}}else{console.log("kiwi_valpwd2_cb: body_loaded previously!");return;}}
function kiwi_init(){}
function kiwi_xdLocalStorage_init(){var iframeUrls=[];var N_PUB=2;for(var i=0;i<N_PUB;i++){iframeUrls[i]='http://pub'+i+'.kiwisdr.com/pkgs/xdLocalStorage/xdLocalStorage.php/?key=4e92a0c3194c62b2a067c494e2473e8dfe261138';}
xdLocalStorageHA.init({iframeUrls:iframeUrls,initCallback:function(){kiwi.xdLocalStorage_ready=true;console.log('xdLocalStorageHA READY');}});}
var override_freq,override_mode,override_zoom,override_max_dB,override_min_dB,override_9_10;function kiwi_get_init_settings(){var init_f=(init_frequency==undefined)?7020:init_frequency;init_f=ext_get_cfg_param('init.freq',init_f,EXT_NO_SAVE);init_frequency=override_freq?override_freq:init_f;var init_m=(init_mode==undefined)?kiwi.modes_s['lsb']:kiwi.modes_s[init_mode];init_m=ext_get_cfg_param('init.mode',init_m,EXT_NO_SAVE);init_mode=override_mode?override_mode:kiwi.modes_l[init_m];if(init_mode==='drm')init_mode='am';var init_z=(init_zoom==undefined)?0:init_zoom;init_z=ext_get_cfg_param('init.zoom',init_z,EXT_NO_SAVE);init_zoom=isNumber(override_zoom)?override_zoom:init_z;var init_max=(init_max_dB==undefined)?-10:init_max_dB;init_max=ext_get_cfg_param('init.max_dB',init_max,EXT_NO_SAVE);init_max_dB=override_max_dB?override_max_dB:init_max;var init_min=(init_min_dB==undefined)?-110:init_min_dB;init_min=ext_get_cfg_param('init.min_dB',init_min,EXT_NO_SAVE);init_min_dB=override_min_dB?override_min_dB:init_min;console.log('INIT f='+init_frequency+' m='+init_mode+' z='+init_zoom
+' min='+init_min_dB+' max='+init_max_dB);w3_call('init_scale_dB');var ant=ext_get_cfg_param('rx_antenna');var el=w3_el('rx-antenna');if(el!=undefined&&ant){el.innerHTML='Antenna: '+kiwi_decodeURIComponent('rx_antenna',ant);}
kiwi.WSPR_rgrid=ext_get_cfg_param_string('WSPR.grid','',EXT_NO_SAVE);}
var cfg={};var adm={};function cfg_save_json(id,path){var s;if(path.startsWith('adm.')){s=encodeURIComponent(JSON.stringify(adm,null,3));console.log('save_adm len='+s.length);extint.ws.send('SET save_adm='+s);}else{s=encodeURIComponent(JSON.stringify(cfg,null,3));console.log('save_cfg len='+s.length);var frag_size=65000;while(s.length>frag_size){extint.ws.send('SET save_cfg_part='+s.slice(0,frag_size));s=s.slice(frag_size);}
extint.ws.send('SET save_cfg='+s);}
console.log('cfg_save_json: from='+id+' path='+path+' DONE');}
var geo={geo:'',json:'',retry:0,};function kiwi_geolocate(which){var ff=kiwi_isFirefox();if(ff&&ff<=28)return;if(which==undefined)which=(new Date()).getSeconds();which=which%3;var server;switch(which){case 0:server='https://ipapi.co/json';break;case 1:server='https://get.geojs.io/v1/ip/geo.json';break;case 2:server='http://ip-api.com/json?fields=49177';break;default:break;}
kiwi_ajax(server,function(json){if(isUndefined(json.AJAX_error)){console.log('GEOLOC '+server);console.log(json);geoloc_json(json);}else{if(geo.retry++<=3)
kiwi_geolocate(which+1);}},null,5000);}
function geoloc_json(json){if(isDefined(json.AJAX_error))
return;if(window.JSON&&window.JSON.stringify)
geo.json=JSON.stringify(json);else
geo.json=json.toString();var country=json.country_name||json.country;var region=json.regionName||json.region;if(country=="United States"&&region){country=region+', USA';}
geo.geo='';if(json.city)geo.geo+=json.city;if(country)geo.geo+=(json.city?', ':'')+country;console.log('GEOLOC '+geo.geo);}
function kiwi_geo(){return encodeURIComponent(geo.geo);}
function kiwi_geojson(){return encodeURIComponent(geo.json);}
var server_time_utc,server_time_local,server_time_tzid,server_time_tzname,server_tz;var time_display_current=true;function time_display_cb(o){if(isUndefined(o.tu))return;server_time_utc=o.tu;server_time_local=o.tl;server_time_tzid=decodeURIComponent(o.ti);server_time_tzname=decodeURIComponent(o.tn).replace(/\\/g,'').replace(/_/g,' ');server_tz=server_time_tzname;if(server_time_tzid)server_tz+=' ('+server_time_tzid+')';if(!time_display_started){time_display_periodic();time_display_started=true;}else
time_display(time_display_current);}
function time_display(display_time){var el=w3_el('id-time-display-text-inner');if(!el)return;var noLatLon=(server_time_local==''||server_time_tzname=='null');w3_innerHTML('id-time-display-UTC',server_time_utc?server_time_utc:'?');w3_innerHTML('id-time-display-local',noLatLon?'?':server_time_local);w3_innerHTML('id-time-display-tzname',noLatLon?'Lat/lon needed for local time':server_tz);w3_el('id-time-display-logo-inner').style.opacity=display_time?0:1;w3_el('id-time-display-inner').style.opacity=display_time?1:0;}
function time_display_periodic(){time_display(time_display_current);time_display_current^=1;setTimeout(function(){time_display_periodic();},time_display_current?50000:10000);}
var time_display_started=false;var time_display_prev;function time_display_setup(ext_name_or_id){if(ext_name_or_id.startsWith('id-')==false)
ext_name_or_id+='-time-display';var el;if(time_display_prev){el=w3_el(time_display_prev);if(el)el.innerHTML='';}
time_display_prev=ext_name_or_id;var el=w3_el(ext_name_or_id);el.innerHTML=w3_div('id-time-display-inner',w3_div('id-time-display-text-inner',w3_inline('',w3_div('id-time-display-UTC'),w3_div('cl-time-display-text-suffix','UTC')),w3_inline('',w3_div('id-time-display-local'),w3_div('cl-time-display-text-suffix','Local')),w3_div('id-time-display-tzname')))+
w3_div('id-time-display-logo-inner',w3_div('id-time-display-logo-text','Powered by'),'<a href="https://github.com/ha7ilm/openwebrx" target="_blank"><img id="id-time-display-logo" src="gfx/openwebrx-top-logo.png" /></a>');time_display(time_display_current);}
function time_display_height(){return 80;}
function time_display_width(){return 200;}
function time_display_html(ext_name,top){top=top||'50px';return w3_div(ext_name+'-time-display|top:'+top+'; background-color:black; position:relative;');}
var ansi={colors:[[0,0,0],[194,54,33],[37,188,36],[173,173,39],[73,46,225],[211,56,211],[51,187,200],[203,204,205],[129,131,131],[252,57,31],[49,231,34],[234,236,35],[88,51,255],[249,53,248],[20,240,240],[233,235,235]],BRIGHT:8,RED:"\u001b[97m\u001b[101m",YELLOW:"\u001b[103m",GREEN:"\u001b[102m",CYAN:"\u001b[106m",BLUE:"\u001b[97m\u001b[104m",MAGENTA:"\u001b[97m\u001b[105m",GREY:"\u001b[47m",NORM:"\u001b[m",rolling:['RED','YELLOW','GREEN','CYAN','BLUE','MAGENTA','GREY'],rolling_n:7};function kiwi_output_sgr(p){var msg='SGR',str='';var sgr,saw_reset=0,saw_color=0;var sa=p.esc.s.substr(1).split(';');var sl=sa.length;if(p.isAltBuf)msg+='('+p.r+','+p.c+')';for(var ai=0;ai<sl&&!isNumber(msg);ai++){sgr=(sa[ai]==''||sa[ai]=='m')?0:parseInt(sa[ai]);if(sgr==0){p.sgr.fg=p.sgr.bg=null;msg+=', reset';saw_reset=1;}else
if(isNaN(sgr)){msg=2;}else
if(sgr==1){p.sgr.bright=ansi.BRIGHT;msg+=', bright';}else
if(sgr==2){p.sgr.bright=0;msg+=', faint';}else
if(sgr==22){p.sgr.bright=0;msg+=', normal';}else
if(sgr==7){var tf=p.sgr.fg;p.sgr.fg=p.sgr.bg;p.sgr.bg=tf;if(p.sgr.fg==null)p.sgr.fg=[255,255,255];if(p.sgr.bg==null)p.sgr.bg=[0,0,0];msg+=', reverse video';saw_color=1;}else
if(sgr==27){p.sgr.fg=p.sgr.bg=null;msg+=', reverse video off';saw_color=1;}else
if(sgr>=30&&sgr<=37){p.sgr.fg=ansi.colors[sgr-30+p.sgr.bright];msg+=', fg color';saw_color=1;}else
if(sgr>=90&&sgr<=97){p.sgr.fg=ansi.colors[sgr-90+ansi.BRIGHT];msg+=', fg color bright';saw_color=1;}else
if(sgr==39){p.sgr.fg=null;msg+=', fg normal';saw_color=1;}else
if(sgr>=40&&sgr<=47){p.sgr.bg=ansi.colors[sgr-40+p.sgr.bright];msg+=', bg color';saw_color=1;}else
if(sgr>=100&&sgr<=107){p.sgr.bg=ansi.colors[sgr-100+ansi.BRIGHT];msg+=', bg color bright';saw_color=1;}else
if(sgr==49){p.sgr.bg=null;msg+=', bg normal';saw_color=1;}else
if(sgr==38||sgr==48){var n8,r,g,b,color,ci;if(sl==3&&(parseInt(sa[1])==5)&&(!isNaN(n8=parseInt(sa[2])))){ai+=2;if(n8<=15){color=ansi.colors[n8];if(sgr==38)p.sgr.fg=color;else p.sgr.bg=color;msg+=', 38/48 mode color';saw_color=1;}else
if(n8<=231){n8-=16;r=Math.floor(n8/36);n8-=r*36;g=Math.floor(n8/6);n8-=g*6;b=n8;r=Math.floor(255*r/5);g=Math.floor(255*g/5);b=Math.floor(255*b/5);color=[r,g,b];if(sgr==38)p.sgr.fg=color;else p.sgr.bg=color;msg+=', color cube';saw_color=1;}else
if(n8<=255){ci=8+(n8-232)*10;color=[ci,ci,ci];if(sgr==38)p.sgr.fg=color;else p.sgr.bg=color;msg+=', grayscale ramp';saw_color=1;}else
msg=2;}else
if(sl==5&&(parseInt(sa[1])==2)&&(!isNaN(r=parseInt(sa[2])))&&(!isNaN(g=parseInt(sa[3])))&&(!isNaN(b=parseInt(sa[4])))){r=w3_clamp(r,0,255);g=w3_clamp(g,0,255);b=w3_clamp(b,0,255);color=[r,g,b];if(sgr==38)p.sgr.fg=color;else p.sgr.bg=color;msg+=', 24-bit color';saw_color=1;}else
msg=2;}else
msg=2;}
if(saw_reset){if(p.sgr.span){str+='</span>';p.sgr.span=0;}}else
if(saw_color){if(p.sgr.span)str+='</span>';str+='<span style="'+(p.sgr.fg?('color:'+kiwi_rgb(p.sgr.fg)+';'):'')+(p.sgr.bg?('background-color:'+kiwi_rgb(p.sgr.bg)+';'):'')+'">';p.sgr.span=1;}else{}
return{msg:msg,str:str};}
function kiwi_output_msg(id,id_scroll,p){var i,j;var dbg=(1&&dbgUs);if(dbg)kiwi.d.p=p;if(0&&dbg){console.log('$kiwi_output_msg id='+id+' init='+p.init+' isAltBuf='+p.isAltBuf+' s='+p.s);console.log('$ '+kiwi_JSON(p));if(!p.init)kiwi_trace();}
var parent_el=w3_el(id);if(!parent_el){console.log('kiwi_output_msg NOT_FOUND id='+id);return;}
var appendEmptyLine=function(parent_el){return w3_create_appendElement(parent_el,'pre','');};var removeAllLines=function(parent_el){while(parent_el.firstChild){parent_el.removeChild(parent_el.firstChild);}};var console_cursor=function(ch){ch=ch||'&nbsp;';return'<span class="cl-admin-console-cursor">'+ch+'</span>';};var render2=function(){var fg=null,bg=null,span=false;for(var r=1;r<=p.rows;r++){if(!p.dirty[r])continue;p.dirty[r]=false;var s='';for(var c=1;c<=p.cols;c++){var color=p.color[r][c];if(color.fg!=fg||color.bg!=bg){if(span)s+='</span>';if(color.fg||color.bg){s+='<span style="'+(color.fg?('color:'+kiwi_rgb(color.fg)+';'):'')+
(color.bg?('background:'+kiwi_rgb(color.bg)+';'):'')+'">';}else{span=false;}
fg=color.fg;bg=color.bg;span=true;}
var ch=p.screen[r][c];if(ch=='<')ch='&lt;';else
if(ch=='>')ch='&gt;';else
if(ch=='&')ch='&amp;';else
if(ch=='\'')ch='&apos;';else
if(ch=='/')ch='&#47;';else;if(p.show_cursor&&r==p.r&&c==p.c){if(dbg)console.log('cursor '+p.r+','+p.c);s+=console_cursor(ch);p.r_cursor=r;p.c_cursor=c;}else{s+=ch;}}
if(s=='')s='&nbsp;';else
if(span)s+='</span>';try{p.els[r].innerHTML=s;}catch(ex){if(dbg){console.log('r='+r);console.log(p.els[r]);console.log(ex);}}}};var render=function(){if(p.r_cursor!=p.r&&p.r_cursor!=0){p.dirty[p.r_cursor]=true;}
render2();};var sched=function(){kiwi_clearTimeout(p.rend_timeout);p.rend_timeout=setTimeout(function(){render();},250);};var dirty=function(){p.dirty[p.r]=true;};var screen_char=function(ch,shift_mode){var r=p.r,c=p.c;if(shift_mode!=p.NOSHIFT_MODE&&p.insertMode){for(i=r.cols-1;i>=c;i--){p.screen[r][i+1]=p.screen[r][i];p.color[r][i+1]=p.color[r][i];}}
try{p.screen[r][c]=ch;}catch(ex){if(dbg){console.log('r='+r+' c='+c);console.log(kiwi_JSON(ch));console.log(p);console.log(ex);}}
p.color[r][c]={fg:p.sgr.fg,bg:p.sgr.bg};dirty();p.c++;if(p.c>p.cols){if(p.eol_wrap&&shift_mode!=p.NOSHIFT_MODE){p.c=1;p.r++;if(p.r>p.rows){p.r=1;dirty();}}else{p.c=p.cols;}}
sched();};var move_in_display=function(dr_start,sr_start,sr_end,step){var row=dr_start;var down=(step>0);for(var ri=sr_start;(down&&ri<=sr_end)||(!down&&ri>=sr_end);ri+=step){p.r=row;row+=step;p.c=1;for(var ci=1;ci<=p.cols;ci++){screen_char(p.screen[ri][ci]);}}};var erase_in_line=function(c_start,c_end){for(var c=c_start;c_start&&c<=c_end;c++){p.screen[p.r][c]=' ';p.color[p.r][c]={fg:null,bg:null};}
dirty();sched();};var erase_in_display=function(r_start,r_end,c_start,c_end){for(var r=r_start;r_start&&r<=r_end;r++){for(var c=c_start;c<=((r==p.r)?c_end:p.cols);c++){p.screen[r][c]=' ';p.color[r][c]={fg:null,bg:null};}
p.dirty[r]=true;}
sched();};var snew_add=function(c){if(snew==''){p.snew_r=p.r;p.snew_c=p.c;}
snew+=c;};var snew_dump=function(where){if(snew!=''){if(dbg)console.log('> '+(p.isAltBuf?'ALT':'REG')+' '+where+' ('+p.snew_r+','+p.snew_c+') '+' CHARS #'+snew.length+' '+kiwi_JSON(snew));snew='';}};var html_add=function(c){if(isString(p.line_html[p.ccol]))
p.line_html[p.ccol]+=c;else
p.line_html[p.ccol]=c;};var line_s=function(){return kiwi_JSON(p.line.join(''));};var line_join=function(col_start,col_stop){col_stop=col_stop||p.cols;var s='';for(var c=col_start;c<col_stop;c++){if(isString(p.line_sgr[c]))s+=p.line_sgr[c];if(isString(p.line_html[c]))s+=p.line_html[c];if(isString(p.line[c]))s+=p.line[c];}
return s;};var s;try{s=kiwi_decodeURIComponent('kiwi_output_msg',p.s);}catch(ex){console.log('decodeURIComponent FAIL:');console.log(p.s);s=p.s;}
if(p.init!=true){removeAllLines(parent_el);p.el=appendEmptyLine(parent_el);p.cols=p.cols||80;p.NONE=0;p.ESC=1;p.CSI=2;p.NON_CSI=3;p.NOSHIFT_MODE=true;p.esc={s:'',state:p.NONE};p.sgr={span:0,bright:0,fg:null,bg:null};p.return_pending=false;p.must_scroll_down=false;p.traceEvery=false;p.ccol=1;p.line=[];p.line_sgr=[];p.line_html=[];p.inc=1;p.r=p.c=1;p.margin_set=false;p.margin_top=1;p.margin_bottom=p.rows;p.show_cursor=p.show_cursor||false;p.r_cursor=p.c_cursor=0;p.insertMode=true;p.eol_wrap=false;p.screen=[];p.color=[];p.dirty=[];p.els=[];for(var r=0;r<=p.rows;r++){p.screen[r]=[];p.color[r]=[];}
p.isAltBuf=false;p.altbuf_via_cursor_visible=false;p.altbuf_via_cup=false;p.alt_save='';p.rend_timeout=null;p.init=true;}
var snew='',stmp;var el_scroll=w3_el(id_scroll);var wasScrolledDown=null;if(p.process_return_alone&&s.charAt(0)=='\r'&&(s.length==1||s.charAt(1)!='\n')){if(p.isAltBuf){}else{s=s.substring(1);p.line=[];p.line_sgr=[];p.line_html=[];p.ccol=1;}}
if(0){if(dbg)console.log('kiwi_output_msg:');if(dbg)console.log(kiwi_JSON(p));if(dbg)console.log(kiwi_JSON(s));}
if(p.remove_returns)s=s.replace(/\r/g,'');if(p.inline_returns&&!p.isAltBuf){s=s.replace(/\r\n/g,'\n');s=s.replace(/\r\n/g,'\n');}
if(dbg)console.log('OUTPUT '+kiwi_JSON(s).replace(/\\u001b/g,'\\e'));var cnt=0;for(var si=0;si<s.length;si++){var result=null;var c=s.charAt(si);if(p.inline_returns&&p.return_pending&&c!='\r'){if(p.isAltBuf){}else{p.ccol=1;p.return_pending=false;}}
if(c=='\f'){if(p.isAltBuf){}else{if(dbg)console.log('console \f');removeAllLines(parent_el);p.el=appendEmptyLine(parent_el);p.line=[];p.line_sgr=[];p.line_html=[];p.ccol=1;}}else
if(c=='\r'){if(p.isAltBuf){p.c=1;dirty();}
if(p.inline_returns){p.return_pending=true;}
snew_dump('rtn');result='\\r col = 1 ('+p.r+',1)';}else
if(c=='\n'&&p.isAltBuf){if(p.margin_set){move_in_display(p.margin_top,p.margin_top+1,p.margin_bottom,+1);result='\\n (scroll text up)';}else{p.c=1;if(p.r<p.rows)p.r++;dirty();result='\\n row++ ('+p.r+','+p.c+')';}}else
if(c=='\b'){result='backspace (arrow left)';if(p.isAltBuf){if(p.c>1){dirty();p.c--;}}else{if(p.ccol>1){p.ccol--;if(dbg)console.log('BACKSPACE col='+p.ccol+' '+line_s());}}}else
if(c=='\t'){result='tab';if(p.isAltBuf){}else{snew_add('&nbsp;');p.line[p.ccol]='&nbsp;';p.ccol++;while((p.ccol&7)!=0){snew_add('&nbsp;');p.line[p.ccol]='&nbsp;';p.ccol++;}}}else
if(c=='\x1b'){p.esc.s='';p.esc.state=p.ESC;p.traceEvery=false;}else
if(p.esc.state>=p.ESC){var interp=false;if(p.esc.state==p.ESC){if(c=='['){p.esc.state=p.CSI;}else{p.esc.state=p.NON_CSI;switch(c){case'(':case'O':cnt=2;break;case'>':case'=':cnt=1;break;default:if(dbg)console.log('$LEN? c='+c);cnt=1;break;}}}
if(p.esc.state==p.CSI){p.esc.s+=c;if(p.esc.s.length>1&&c>='@'&&c<='~')interp=true;}else
if(p.esc.state==p.NON_CSI&&cnt){p.esc.s+=c;cnt--;if(cnt==0)interp=true;}
if(interp){var first=p.esc.s.charAt(0);var second=p.esc.s.charAt(1);var last_hl=(c=='h'||c=='l');var enable=(c=='h');result=0;var error=0;var n1=1,n2=1;var t=p.esc.s.slice(1);if(t.length>1&&isNumber(+t[0])){var a=t.slice(0,t.length-1);a=a.split(';');n1=+a[0];n1=n1||1;if(a.length>1)n2=+a[1];n2=n2||1;}
if(first=='['){if(c=='m'){var rv=kiwi_output_sgr(p);result=rv.msg;if(p.isAltBuf){}else{snew_add(rv.str);p.line_sgr[p.ccol]=rv.str;if(dbg)console.log('AFTER SGR snew='+kiwi_JSON(snew));}
p.traceEvery=true;}else
if(c=='K'){if(p.isAltBuf){var c_start,c_end;result='erase in line: ';switch(second){case'0':case'K':c_start=p.c;c_end=p.cols;result+='cur to EOL';break;case'1':c_start=1;c_end=p.c;result+='BOL to cur';break;case'2':c_start=1;c_end=p.cols;result+='full line';break;default:c_start=0;break;}
erase_in_line(c_start,c_end);}else{if(second=='K'){if(dbg)console.log('EEOL BEFORE col='+p.ccol+' '+line_s());var col_stop=p.line.length;for(i=p.ccol;i<=col_stop;i++)p.line[i]=null;if(dbg)console.log('EEOL AFTER col='+p.ccol+' '+line_s());result='erase in line: cur to EOL';}}}else
if(c=='J'){if(p.isAltBuf){var r_start,r_end,c_start,c_end;if(second=='0'||second=='J'){r_start=p.r,r_end=p.rows;c_start=p.c,c_end=p.cols;result='erase cur to EOS';}else
if(second=='2'||second=='3'){r_start=1,r_end=p.rows;c_start=1,c_end=p.cols;result='erase full screen';}else
if(second=='1'){r_start=1,r_end=p.r;c_start=1,c_end=p.c;result='erase BOS to cur';}else{r_start=0;result=2;}
erase_in_display(r_start,r_end,c_start,c_end);}else{if(second=='2'||second=='3'){if(dbg)console.log('console ERASE FULL SCREEN');removeAllLines(parent_el);p.el=appendEmptyLine(parent_el);p.line=[];p.line_sgr=[];p.line_html=[];p.ccol=1;result='erase full screen';}}}else
if(c=='H'){result='move '+n1+','+n2;if(p.isAltBuf){dirty();p.r=n1;p.c=n2;dirty();}else{error=1;}}else
if(c=='d'){result='move row '+n1;if(p.isAltBuf){dirty();p.r=n1;dirty();}else{error=1;}}else
if(c=='G'){result='move col '+n1;if(p.isAltBuf){p.c=n1;dirty();}else{error=1;}}else
if(second=='?'&&last_hl){n1=parseInt(p.esc.s.substr(2));result=(enable?'SET':'RESET')+' ';var enter_altbuf=false,exit_altbuf=false,exit_altbuf_no_restore=false;switch(n1){case 1:result+='cursor keys mode';break;case 7:result+='vertical autowrap';break;case 12:result+='cursor bold';break;case 25:result+='cursor visible';p.show_cursor=enable?true:false;if(!enable&&!p.isAltBuf){enter_altbuf=true;p.altbuf_via_cursor_visible=true;}else
if(enable&&p.isAltBuf&&p.altbuf_via_cursor_visible){exit_altbuf=true;}
break;case 1049:result+='alt screen buf';if(enable&&!p.isAltBuf){enter_altbuf=true;p.altbuf_via_cup=true;}else
if(!enable&&p.isAltBuf&&p.altbuf_via_cup){exit_altbuf=true;}
break;default:result+='$UNKNOWN ='+n1;break;}
if(enter_altbuf){if(dbg)console.log('$ENTER alt buf via '+(p.altbuf_via_cup?'cup':'cursor_visible')+' ====================================');p.alt_save=parent_el.innerHTML.replace(/<pre><span class="cl-admin-console-cursor">.*<\/span><\/pre>$/,'');if(dbg)console.log(kiwi_JSON(p.alt_save));removeAllLines(parent_el);for(var r=1;r<=p.rows;r++){p.dirty[r]=false;try{for(var c=1;c<=p.cols;c++){p.screen[r][c]=' ';p.color[r][c]={fg:null,bg:null};}}catch(ex){if(dbg){console.log('--------');console.log('r='+r+' c='+c);console.log(p.screen);console.log(ex);}}
p.els[r]=appendEmptyLine(parent_el);p.els[r].innerHTML='&nbsp;';}
console_is_char_oriented(true);p.margin_set=false;p.isAltBuf=true;}else
if(exit_altbuf){if(dbg)console.log('$EXIT alt buf via '+(p.altbuf_via_cup?'cup':'cursor_visible')+' ====================================');p.altbuf_via_cursor_visible=false;p.altbuf_via_cup=false;if(dbg)console.log(kiwi_JSON(p.alt_save));parent_el.innerHTML=p.alt_save;p.el=appendEmptyLine(parent_el);p.must_scroll_down=true;console_is_char_oriented();p.isAltBuf=false;}else
if(exit_altbuf_no_restore){if(dbg)console.log('$EXIT alt buf NO RESTORE =====================================');p.must_scroll_down=true;console_is_char_oriented();p.isAltBuf=false;}}else
if(second=='4'&&p.isAltBuf&&last_hl){p.insertMode=enable;result=enable?'INSERT mode':'REPLACE mode';}else
if(c=='X'&&p.isAltBuf){if(n1==0)n1=1;var col;for(var ci=0,col=p.c;ci<n1&&col<=p.cols;ci++,col++){p.screen[p.r][col]=' ';p.color[p.r][col]={fg:null,bg:null};}
dirty();sched();result='erase '+n1+' chars';}else
if(c=='P'){if(n1==0)n1=1;if(p.isAltBuf){var save_col=p.c,src_col,dst_col;for(src_col=p.c+n1,dst_col=p.c;src_col<=p.cols;src_col++,dst_col++){p.screen[p.r][dst_col]=p.screen[p.r][src_col];p.color[p.r][dst_col]=p.color[p.r][src_col];}
for(;dst_col<p.cols;dst_col++){p.screen[p.r][dst_col]=' ';p.color[p.r][dst_col]={fg:null,bg:null};}
p.c=save_col;dirty();sched();}else{if(dbg)console.log('DEL-CHARS BEFORE col='+p.ccol+'/'+p.line.length+' '+line_s());for(i=0;i<n1;i++){var col_stop=p.line.length;for(j=p.ccol;j<col_stop;j++)p.line[j]=p.line[j+1];p.line[j]=null;}
if(dbg)console.log('DEL-CHARS AFTER col='+p.ccol+'/'+p.line.length+' '+line_s());}
result='del #'+n1+' chars';}else
if(c=='@'){if(n1==0)n1=1;if(p.isAltBuf){var save_col=p.c,src_col,dst_col;for(src_col=p.cols-n1,dst_col=p.cols;src_col>=save_col;src_col--,dst_col--){p.screen[p.r][dst_col]=p.screen[p.r][src_col];p.color[p.r][dst_col]=p.color[p.r][src_col];}
for(;dst_col>=save_col;dst_col--){p.screen[p.r][dst_col]=' ';p.color[p.r][dst_col]={fg:null,bg:null};}
p.c=save_col;dirty();sched();}else{if(dbg)console.log('INS-CHARS BEFORE col='+p.ccol+'/'+p.line.length+' '+line_s());for(i=0;i<n1;i++){var col_stop=p.line.length;for(j=col_stop;j>p.ccol;j--)p.line[j]=p.line[j-1];}
if(dbg)console.log('INS-CHARS AFTER col='+p.ccol+'/'+p.line.length+' '+line_s());}
result='ins #'+n1+' chars';}else
if(c=='r'&&p.isAltBuf){p.margin_top=n1;p.margin_bottom=n2;p.margin_set=true;result='set margins, top='+n1+', bottom='+n2;}else
if(c=='S'&&p.isAltBuf){move_in_display(p.margin_top,p.margin_top+n1,p.margin_bottom,+1);erase_in_display(p.r,p.margin_bottom,1,p.cols);p.insertMode=save_insertMode;result='pan down '+n1;}else
if(c=='T'&&p.isAltBuf){var save_insertMode=p.insertMode;p.insertMode=false;move_in_display(p.margin_bottom,p.margin_top+n1-1,p.margin_top,-1);erase_in_display(p.margin_top,p.margin_top+n1-1,1,p.cols);p.insertMode=save_insertMode;result='pan up '+n1;}else
if(c=='M'&&p.isAltBuf){var save_insertMode=p.insertMode;p.insertMode=false;move_in_display(p.r,p.r+1,p.r+n1,+1);erase_in_display(p.r+n1,p.r+n1,1,p.cols);p.insertMode=save_insertMode;result='delete line(s) '+n1;}else
if(c=='A'){if(p.isAltBuf){if(p.r>1){dirty();p.r--;dirty();}
result='arrow up';}else{}}else
if(c=='B'){if(p.isAltBuf){if(p.r<p.rows){dirty();p.r++;dirty();}
result='arrow down';}else{}}else
if(c=='C'){if(p.isAltBuf){if(p.c<p.cols){dirty();p.c++;}}else{if(dbg)console.log('ARROW RIGHT col='+p.ccol+'/'+p.line.length+' '+sq(p.line[p.ccol])+' '+line_s());if(p.ccol<p.line.length)
p.ccol++;}
result='arrow right';}else
if(c=='D'){if(p.isAltBuf){if(p.c>1){dirty();p.c--;}
result='arrow left';}else{}}else{result=2;}}else
if(first=='('){result='define char set';}else
switch(c){case'H':result='set horiz tab (nop)';break;case'M':if(p.isAltBuf){var save_insertMode=p.insertMode;p.insertMode=false;move_in_display(p.margin_bottom,p.margin_bottom-1,p.margin_top,-1);erase_in_display(p.margin_top,p.margin_top,1,p.cols);p.insertMode=save_insertMode;result='scroll text down';}
break;case'>':result='set numeric keypad';break;case'=':result='keypad application mode';break;case'7':result='save cursor';break;case'8':result='restore cursor';break;case'c':result='reset initial state (nop)';break;default:result=2;break;}
snew_dump('cmd');if(error)result+=' UNEXPECTED ====================================================================================';error=0;if(result===1){if(dbg)console.log('> ESC '+kiwi_JSON(p.esc.s)+' $IGNORED ==========================================================================================');}else
if(result===2){if(1||dbg)console.log('> ESC '+kiwi_JSON(p.esc.s)+' $UNKNOWN ======================================================================================');}else
if(isString(result)){if(dbg)console.log('> ESC '+(p.isAltBuf?'ALT':'REG')+' '+kiwi_JSON(p.esc.s)+' '+result);}
result=null;p.esc.state=p.NONE;}}else
if(c>=' '||c=='\n'||c=='\t'){var prt=false;if(!p.isAltBuf&&c=='<'){if(p.inc){snew_add('<');p.line[p.ccol]='&lt;';p.ccol+=p.inc;}
prt=true;}else
if(!p.isAltBuf&&c=='>'){if(p.inc){snew_add('>');p.line[p.ccol]='&gt;';p.ccol+=p.inc;}
prt=true;}else{if(c!='\n'){snew_add(c);if(p.isAltBuf){screen_char(c);}else{if(p.inc){p.line[p.ccol]=c;p.ccol++;}else{html_add(c);}
prt=true;}}
var at_EOL=(p.ccol==p.cols);if(c=='\n'||(at_EOL&&(!p.isAltBuf||(p.isAltBuf&&p.eol_wrap)))){wasScrolledDown=w3_isScrolledDown(el_scroll);if(p.isAltBuf){p.c=1;dirty();p.r++;dirty();if(p.r>p.rows)p.r=1;}else{var stmp=line_join(1);p.el.innerHTML=(stmp=='')?'&nbsp;':stmp;p.line=[];p.line_sgr=[];p.line_html=[];p.el=appendEmptyLine(parent_el);p.ccol=1;}
if(w3_contains(el_scroll,'w3-scroll-down')&&(!p.scroll_only_at_bottom||(p.scroll_only_at_bottom&&wasScrolledDown)))
w3_scrollDown(el_scroll);}}}else
if(!p.isAltBuf&&c==kiwi.esc_lt){snew_add('<');html_add('<');p.inc=0;}else
if(!p.isAltBuf&&c==kiwi.esc_gt){snew_add('>');html_add('>');p.inc=1;}else
if(p.isAltBuf){if(dbg)console.log('> 0x7f CHAR '+ord(c)+' '+ord(c).toHex(-2));}
if(result){if(dbg)console.log('> '+result);}}
wasScrolledDown=w3_isScrolledDown(el_scroll);if(p.isAltBuf){}else{if(p.show_cursor){var first=line_join(1,p.ccol);var second=line_join(p.ccol);if(second.length){stmp=first+console_cursor(second[0])+second.slice(1);}else{stmp=first+console_cursor();}}else{stmp=line_join(1);}
p.el.innerHTML=stmp;}
if(w3_contains(el_scroll,'w3-scroll-down')&&(!p.scroll_only_at_bottom||(p.scroll_only_at_bottom&&wasScrolledDown)||p.must_scroll_down)){w3_scrollDown(el_scroll);p.must_scroll_down=false;}
if(p.isAltBuf)sched();snew_dump('end');}
function gps_stats_cb(acquiring,tracking,good,fixes,adc_clock,adc_gps_clk_corrections){var s=(acquiring?'yes':'pause')+', track '+tracking+', good '+good+', fixes '+fixes.toUnits();w3_innerHTML('id-msg-gps','GPS: acquire '+s);w3_innerHTML('id-status-gps',w3_text(optbar_prefix_color,'GPS'),w3_text('','acq '+s));extint_adc_clock_Hz=adc_clock*1e6;extint_adc_gps_clock_corr=adc_gps_clk_corrections;if(adc_gps_clk_corrections){s=adc_clock.toFixed(6)+' ('+adc_gps_clk_corrections.toUnits()+' avgs)';var el=w3_el('id-msg-gps');if(el)el.innerHTML+=', ADC clock '+s;w3_innerHTML('id-status-adc',w3_text(optbar_prefix_color,'ADC clock '),w3_text('',s));}}
function admin_stats_cb(audio_dropped,underruns,seq_errors,dp_resets,dp_hist_cnt,dp_hist,in_hist_cnt,in_hist){if(audio_dropped==undefined)return;var el=w3_el('id-msg-errors');if(el)el.innerHTML='Stats: '+
audio_dropped.toUnits()+' dropped, '+
underruns.toUnits()+' underruns, '+
seq_errors.toUnits()+' sequence, '+
dp_resets.toUnits()+' realtime';el=w3_el('id-status-dp-hist');if(el){var s='Datapump: ';for(var i=0;i<dp_hist_cnt;i++){s+=(i?', ':'')+dp_hist[i].toUnits();}
el.innerHTML=s;}
el=w3_el('id-status-in-hist');if(el){var s='SoundInQ: ';for(var i=0;i<in_hist_cnt;i++){s+=(i?', ':'')+in_hist[i].toUnits();}
el.innerHTML=s;}}
function kiwi_too_busy(rx_chans){var s='Sorry, the KiwiSDR server is too busy right now ('+rx_chans+' users max). <br>'+'There is also a limit on the total number of channel queuers and campers. <br>'+'Please check <a href="http://rx.kiwisdr.com" target="_self">rx.kiwisdr.com</a> for more KiwiSDR receivers available world-wide.';kiwi_show_msg(s);}
function kiwi_exclusive_use(){var s='Sorry, this Kiwi has been locked for special use. <br>'+'This happens when using an extension (e.g. DRM decoder) that requires all available resources. <br>'+'Please check <a href="http://rx.kiwisdr.com" target="_self">rx.kiwisdr.com</a> for more KiwiSDR receivers available world-wide. <br><br>'+'申し訳ありませんが、このキーウィは特別な使用のためにロックされています。 <br>'+'これは、利用可能なすべてのリソースを必要とする拡張機能（DRM デコーダーなど）を使用している場合に発生します。 <br>'+'世界中で利用できる KiwiSDR レシーバーについては、<a href="http://rx.kiwisdr.com" target="_self">rx.kiwisdr.com</a> を確認してください。';kiwi_show_msg(s);}
function kiwi_ip_limit_pwd_cb(pwd){console.log('kiwi_ip_limit_pwd_cb pwd='+pwd);writeCookie('iplimit',encodeURIComponent(pwd));window.location.reload(true);}
function kiwi_show_error_ask_exemption_cb(path,val,first){kiwi_ip_limit_pwd_cb(val);}
function kiwi_show_error_ask_exemption(s){s+='<br><br>If you have an exemption password from the KiwiSDR owner/admin <br> please enter it here: '+
w3_input('w3-retain-input-focus w3-margin-TB-8/w3-label-inline w3-label-not-bold/kiwi-pw|padding:1px|size=40','Password:','id-epwd','','kiwi_show_error_ask_exemption_cb');kiwi_show_msg(s);w3_field_select('id-epwd',{mobile:1});}
function kiwi_inactivity_timeout(mins){var s='Sorry, this KiwiSDR has an inactivity timeout after '+mins+' minutes.<br>Reload the page to continue.';kiwi_show_msg(s);}
function kiwi_24hr_ip_limit(mins,ip){var s='Sorry, this KiwiSDR can only be used for '+mins+' minutes every 24 hours by each IP address.<br>'+'Please check <a href="http://rx.kiwisdr.com" target="_self">rx.kiwisdr.com</a> for more KiwiSDR receivers available world-wide.';kiwi_show_error_ask_exemption(s);}
function kiwi_password_entry_timeout(){var s='Timeout. Please reload page to continue.';kiwi_show_msg(s);}
function kiwi_up(up){if(!seriousError){w3_hide('id-kiwi-msg-container');w3_show_block('id-kiwi-container');w3_el('id-kiwi-body').style.overflow='hidden';}}
function kiwi_down(type,reason){var s;type=+type;if(type==1){s='Sorry, software update in progress. Please check back in a few minutes.<br>'+'Or check <a href="http://rx.kiwisdr.com" target="_self">rx.kiwisdr.com</a> for more KiwiSDR receivers available world-wide.';}else
if(type==2){s="Backup in progress.";}else{if(reason==null||reason==''){reason='Sorry, this KiwiSDR server is being used for development right now. <br>'+'Please check <a href="http://rx.kiwisdr.com" target="_self">rx.kiwisdr.com</a> for more KiwiSDR receivers available world-wide.';}
s=reason;}
kiwi_show_msg(s);}
var stats_interval=10000;var need_config=true;function stats_init(){if(need_config){msg_send('SET GET_CONFIG');need_config=false;}
stats_update();}
function stats_update(){msg_send('SET STATS_UPD ch='+rx_chan);var now=new Date();var aligned_interval=Math.ceil(now/stats_interval)*stats_interval-now;if(aligned_interval<stats_interval/2)aligned_interval+=stats_interval;setTimeout(stats_update,aligned_interval);}
function status_periodic(){w3_innerHTML('id-status-stats-cpu',kiwi_cpu_stats_str);w3_innerHTML('id-status-stats-xfer',kiwi_xfer_stats_str);w3_innerHTML('id-msg-stats-cpu',kiwi_cpu_stats_str_long);w3_innerHTML('id-msg-stats-xfer',kiwi_xfer_stats_str_long);}
var kiwi_xfer_stats_str="";var kiwi_xfer_stats_str_long="";function xfer_stats_cb(audio_kbps,waterfall_kbps,waterfall_fps,http_kbps,sum_kbps){kiwi_xfer_stats_str=w3_text(optbar_prefix_color,'Net')+
w3_text('','aud '+audio_kbps.toFixed(0)+', wf '+waterfall_kbps.toFixed(0)+', http '+
http_kbps.toFixed(0)+', total '+sum_kbps.toFixed(0)+' kB/s');kiwi_xfer_stats_str_long='Network (all channels): audio '+audio_kbps.toFixed(0)+' kB/s, waterfall '+waterfall_kbps.toFixed(0)+' kB/s ('+waterfall_fps.toFixed(0)+' fps)'+', http '+http_kbps.toFixed(0)+' kB/s, total '+sum_kbps.toFixed(0)+' kB/s ('+(sum_kbps*8).toFixed(0)+' kb/s)';}
var kiwi_cpu_stats_str='';var kiwi_cpu_stats_str_long='';var kiwi_config_str='';var kiwi_config_str_long='';function cpu_stats_cb(o,uptime_secs,ecpu,waterfall_fps){idle%=100;var cputempC=o.cc?o.cc:0;var cputempF=cputempC*9/5+32;var temp_color=o.cc?((o.cc>=60)?'w3-text-css-red w3-bold':((o.cc>=50)?'w3-text-css-yellow':'w3-text-css-lime')):'';var cputemp=cputempC?(cputempC.toFixed(0)+'&deg;C '+cputempF.toFixed(0)+'&deg;F '):'';var cpufreq=(o.cf>=1000)?((o.cf/1000).toFixed(1)+' GHz'):(o.cf.toFixed(0)+' MHz');kiwi_cpu_stats_str=w3_text(optbar_prefix_color,'BB ')+
w3_text('',o.cu[0]+','+o.cs[0]+','+o.ci[0]+' usi% ')+
(cputempC?w3_text(temp_color,cputemp):'')+
w3_text('',cpufreq+' ')+
w3_text(optbar_prefix_color,'FPGA')+
w3_text('',ecpu.toFixed(0)+'%');kiwi.wf_fps=waterfall_fps;var user='',sys='',idle='';var first=true;for(var i=0;i<o.cu.length;i++){user+=(first?'':' ')+o.cu[i]+'%';sys+=(first?'':' ')+o.cs[i]+'%';idle+=(first?'':' ')+o.ci[i]+'%';first=false;}
var cpus='cpu';if(o.cu.length>1){cpus+='0';for(var i=1;i<o.cu.length;i++)
cpus+=' cpu'+i;}
kiwi_cpu_stats_str_long=w3_inline('',w3_text('w3-text-black','Beagle: '+cpus+' '+user+' usr | '+sys+' sys | '+idle+' idle,'+(cputempC?'':' '))+
(cputempC?('&nbsp;'+w3_text(temp_color+' w3-text-outline w3-large',cputemp)+'&nbsp;'):'')+
w3_text('w3-text-black',cpufreq+', ')+
w3_text('w3-text-black','FPGA eCPU: '+ecpu.toFixed(0)+'%'));var t=uptime_secs;var sec=Math.trunc(t%60);t=Math.trunc(t/60);var min=Math.trunc(t%60);t=Math.trunc(t/60);var hr=Math.trunc(t%24);t=Math.trunc(t/24);var days=t;var s=' ';if(days)s+=days+'d:';s+=hr+':'+min.leadingZeros(2)+':'+sec.leadingZeros(2);w3_innerHTML('id-status-config',w3_text(optbar_prefix_color,'Up'),w3_text('',s+', '+kiwi_config_str));s=' | Uptime: ';if(days)s+=days+' '+((days>1)?'days':'day')+' ';s+=hr+':'+min.leadingZeros(2)+':'+sec.leadingZeros(2);var noLatLon=(server_time_local==''||server_time_tzname=='null');if(server_time_utc)s+=' | UTC: '+server_time_utc;if(isDefined(server_time_tzname)){s+=' | Local: ';if(!noLatLon)s+=server_time_local+' ';s+=noLatLon?'Lat/lon needed for local time':server_tz;}
w3_innerHTML('id-msg-config',kiwi_config_str_long+s);}
function config_str_update(rx_chans,gps_chans,vmaj,vmin){kiwi_config_str='v'+vmaj+'.'+vmin+', '+rx_chans+' SDR ch, '+gps_chans+' GPS ch';w3_innerHTML('id-status-config',kiwi_config_str);kiwi_config_str_long='Config: v'+vmaj+'.'+vmin+', '+rx_chans+' SDR channels, '+gps_chans+' GPS channels';w3_innerHTML('id-msg-config',kiwi_config_str);}
var config_net={};function config_cb(rx_chans,gps_chans,serno,pub,port_ext,pvt,port_int,nm,mac,vmaj,vmin){var s;config_str_update(rx_chans,gps_chans,vmaj,vmin);var net_config=w3_el("id-net-config");if(net_config){net_config.innerHTML=w3_div('',w3_col_percent('',w3_div('','Public IP address (outside your firewall/router): '+pub+' [port '+port_ext+']'),50,w3_div('','Ethernet MAC address: '+mac.toUpperCase()),30,w3_div('','KiwiSDR serial number: '+serno),20),w3_col_percent('',w3_div('','Private IP address (inside your firewall/router): '+pvt+' [port '+port_int+']'),50,w3_div('','Private netmask: /'+nm),50));config_net.pub_ip=pub;config_net.pub_port=port_ext;config_net.pvt_ip=pub;config_net.pvt_port=port_int;config_net.mac=mac;config_net.serno=serno;}}
function update_cb(fail_reason,pending,in_progress,rx_chans,gps_chans,vmaj,vmin,pmaj,pmin,build_date,build_time){config_str_update(rx_chans,gps_chans,vmaj,vmin);var msg_update=w3_el("id-msg-update");if(msg_update){var s;s='Installed version: v'+vmaj+'.'+vmin+', built '+build_date+' '+build_time;if(fail_reason){var r;switch(fail_reason){case 1:r='Filesystem is FULL!';break;case 2:r='No Internet connection? (can\'t ping 1.1.1.1)';break;case 3:r='No connection to github.com?';break;case 4:r='Git clone damaged!';break;case 5:r='Makefile update failed -- check /root/build.log file';break;case 6:r='Build failed, check /root/build.log file';break;default:r='Unknown reason, code='+fail_reason;break;}
s+='<br>'+r;w3_hide('id-build-restart');w3_hide('id-build-reboot');}else
if(in_progress){s+='<br>Update to version v'+ +pmaj+'.'+pmin+' in progress';}else
if(pending){s+='<br>Update check pending';}else
if(pmaj==-1){s+='<br>Error determining the latest version -- check log';}else{if(vmaj==pmaj&&vmin==pmin)
s+='<br>Running most current version';else
s+='<br>Available version: v'+pmaj+'.'+pmin;}
msg_update.innerHTML=s;}}
var users_interval=2500;var user_init=false;function users_init(called_from){kiwi.called_from_admin=called_from.admin;kiwi.called_from_user=called_from.user;kiwi.called_from_monitor=called_from.monitor;if(kiwi.called_from_admin||kiwi.called_from_monitor){var id_prefix=kiwi.called_from_admin?'id-admin-user-':'id-monitor-user-';var pad=kiwi.called_from_monitor?' w3-padding-LR-2':'';var s1='',s2;for(var i=0;i<rx_chans;i++){if(kiwi.called_from_admin){s1=w3_button('id-user-kick-'+i+' w3-hide w3-small w3-white w3-border w3-border-red w3-round-large w3-padding-0 w3-padding-LR-8','Kick','status_user_kick_cb',i);}
s2=w3_div('id-campers-'+i+' w3-css-orange w3-padding-LR-8');w3_el('id-users-list').innerHTML+=w3_inline('/w3-hspace-8',w3_div('id-user-'+i+pad,'RX'+i),w3_div(id_prefix+i),s1,s2);}}
users_update();w3_call('users_setup');user_init=true;}
function users_update(){msg_send('SET GET_USERS');setTimeout(users_update,users_interval);}
function user_cb(obj){var id_prefix=kiwi.called_from_admin?'id-admin-user-':'id-monitor-user-';var host=kiwi_url_origin();obj.forEach(function(obj){var s1='',s2='',s3='';var i=obj.i;var name=obj.n;var freq=obj.f;var geoloc=obj.g;var ip=(isDefined(obj.a)&&obj.a!='')?(obj.a+', '):'';var mode=obj.m;var zoom=obj.z;var connected=obj.t;var remaining='';if(obj.rt){var t=(obj.rt==1)?' act':' 24h';remaining=' '+w3_text('w3-text-css-orange|vertical-align:bottom',obj.rs+t);}
var ext=obj.e;if(isDefined(name)){var okay=false;var deco;do{try{deco=decodeURIComponent(name);okay=true;}catch(ex){name=name.slice(0,-1);}}while(!okay);var id=kiwi_strip_tags(deco,'');if(!kiwi.called_from_admin&&id=='')id='(no identity)';if(id!='')id='"'+id+'"';var g=(geoloc=='(null)'||geoloc=='')?(kiwi.called_from_admin?'unknown location':''):decodeURIComponent(geoloc);ip=ip.replace(/::ffff:/,'');g=(ip!=''||g!='')?('('+ip+g+')'):'';var f=freq+kiwi.freq_offset_Hz;var f=(f/1000).toFixed((f>100e6)?1:2);var f_s=f+' kHz ';var fo=(freq/1000).toFixed(2);var link,target;if(kiwi.called_from_admin){link=host+'/?f='+fo+mode+'z'+zoom;target=' target="_blank"';}else{link='javascript:'+(kiwi.called_from_user?('tune('+fo+','+sq(mode)+','+zoom+')'):('camp('+i+')'));target='';}
if(ext!='')ext=decodeURIComponent(ext)+' ';s1=w3_sb(id,g)+' ';s2=w3_link('w3-link-darker-color',link,f_s+(obj.wf?'WF':mode)+' z'+zoom)+' '+ext+connected+remaining;}
if(user_init){if(kiwi.called_from_user){w3_innerHTML('id-optbar-user-'+i,(s1!='')?(s1+'<br>'+s2):'');}else{w3_innerHTML(id_prefix+i,s1+s2+s3);w3_hide2('id-user-kick-'+i,s1=='');w3_hide2('id-user-bl32-'+i,s1=='');w3_hide2('id-user-bl24-'+i,s1=='');}}
if(i==rx_chan&&isDefined(obj.c)){var el=w3_el('id-sam-carrier');if(el)w3_innerHTML(el,'carrier '+obj.c.toFixed(1)+' Hz');}
w3_innerHTML('id-campers-'+i,obj.ca?(obj.ca+plural(obj.ca,' camper')):'');if(i==rx_chan&&obj.rn){if(obj.rn<=55&&!kiwi.inactivity_panel){var s=(obj.rt==1)?'Inactivity timeout in one minute.<br>Close this panel to avoid disconnection.':'Per 24-hour connection timeout in one minute.';confirmation_show_content(s,360,55,function(){msg_send('SET inactivity_ack');confirmation_panel_close();kiwi.inactivity_panel=false;},'red');kiwi.inactivity_panel=true;}}
if(i==rx_chan&&obj.rn>55&&kiwi.inactivity_panel){confirmation_panel_close();kiwi.inactivity_panel=false;}
if(i==rx_chan&&isNumber(obj.fo)&&obj.fo!=kiwi.freq_offset_kHz&&!confirmation.displayed){var s=w3_div('','Frequency scale offset changed. Page must be reloaded.',w3_inline('w3-halign-space-around/',w3_button('w3-margin-T-16 w3-aqua','OK','freq_offset_page_reload')));confirmation_show_content(s,425,100);}
if(i==rx_chan&&isNumber(obj.nc)&&obj.nc!=rx_chan&&isNumber(obj.ns)&&obj.ns!=kiwi.notify_seq){console.log('$ NOTIFY sn='+obj.ns);msg_send('SET notify_msg');kiwi.notify_seq=obj.ns;}});}
function freq_offset_page_reload(){window.location.reload(true);}
var toggle_e={SET:1,SET_URL:2,FROM_COOKIE:4,WRITE_COOKIE:8};function kiwi_toggle(flags,val_set,val_default,cookie_id){var rv=null;if(flags&toggle_e.SET_URL&&(val_set!=null||val_set!=undefined)){rv=val_set;}else
if(flags&toggle_e.FROM_COOKIE){rv=readCookie(cookie_id);if(rv!=null){var rv_num=parseFloat(rv);if(!isNaN(rv_num))rv=rv_num;}}
if(rv==null){if(flags&toggle_e.SET){rv=val_set;}}
if(rv==null){rv=val_default;}
return rv;}
function kiwi_plot_max(b){var t=bi[b];var plot_max=1024 /(t.samplerate/t.plot_samplerate);return plot_max;}
function kiwi_fft_mode(){if(0){toggle_or_set_spec(toggle_e.SET,1);setmaxdb(10);}else{setmaxdb(-30);}}
function kiwi_mapPinSymbol(fillColor,strokeColor){fillColor=fillColor||'red';strokeColor=strokeColor||'white';return{path:'M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z',fillColor:fillColor,fillOpacity:1,strokeColor:strokeColor,strokeWeight:1,scale:1,};}
function isAdmin(){return(Object.keys(adm).length!=0);}
function kiwi_force_admin_close_cb(path,val,first){if(first)return;ext_send('SET close_admin_force');confirmation_panel_close();kiwi.no_admin_conns_pend=0;}
var reason_disabled='';var version_maj=-1,version_min=-1,debian_ver=-1;var tflags={INACTIVITY:1,WF_SM_CAL:2,WF_SM_CAL2:4};var chan_no_pwd,chan_no_pwd_true;var kiwi_output_msg_p={scroll_only_at_bottom:true,process_return_alone:false};var client_public_ip;function kiwi_msg(param,ws){var rtn=true;switch(param[0]){case"version_maj":version_maj=parseInt(param[1]);break;case"version_min":version_min=parseInt(param[1]);break;case"debian_ver":debian_ver=parseInt(param[1]);break;case"client_public_ip":client_public_ip=param[1].replace(/::ffff:/,'');console.log('client public IP: '+client_public_ip);break;case"badp":extint_valpwd_cb(parseInt(param[1]));break;case"chan_no_pwd":chan_no_pwd=parseInt(param[1]);break;case"chan_no_pwd_true":chan_no_pwd_true=parseInt(param[1]);break;case"rx_chans":rx_chans=parseInt(param[1]);break;case"wf_chans":wf_chans=parseInt(param[1]);break;case"wf_chans_real":wf_chans_real=parseInt(param[1]);break;case"rx_chan":rx_chan=parseInt(param[1]);break;case"max_camp":max_camp=parseInt(param[1]);break;case"load_cfg":var cfg_json=decodeURIComponent(param[1]);console.log('### load_cfg '+ws.stream+' '+cfg_json.length);cfg=kiwi_JSON_parse('load_cfg',cfg_json);kiwi.isOffset=(cfg.freq_offset!=0);kiwi.freq_offset_kHz=cfg.freq_offset;kiwi.freq_offset_Hz=cfg.freq_offset*1000;kiwi.offset_frac=(cfg.freq_offset%1000)*1000;owrx_cfg();break;case"load_adm":var adm_json=decodeURIComponent(param[1]);console.log('### load_adm '+ws.stream+' '+adm_json.length);adm=kiwi_JSON_parse('load_adm',adm_json);break;case"no_admin_conns":kiwi.no_admin_conns_pend++;if(kiwi.no_admin_conns_pend==1){confirmation_panel_close();confirmation_show_content('Must close all admin connections before attempting this operation.'+
w3_button('w3-small w3-padding-smaller w3-yellow w3-margin-T-8','Close all admin connections','kiwi_force_admin_close_cb'),500,75,function(){confirmation_panel_close();kiwi.no_admin_conns_pend=0;},'red');}
break;case"foff_error":kiwi.foff_error_pend++;if(kiwi.foff_error_pend==1){setTimeout(function(){confirmation_panel_close();confirmation_show_content((+param[1]==0)?'"foff=" URL parameter available from local connections only.':'Must close all admin connections before using "foff=" URL parameter.',500,55,function(){confirmation_panel_close();kiwi.foff_error_pend=0;},'red');},5000);}
break;case"request_dx_update":if(isAdmin()){if(dx.ignore_dx_update){dx.ignore_dx_update=false;}else{dx_update_admin();}}else{dx_update_request();}
break;case"mkr":var mkr=param[1];var obj=kiwi_JSON_parse('mkr',mkr);if(obj)dx_label_cb(obj);break;case"user_cb":var obj=kiwi_JSON_parse('user_cb',param[1]);if(obj)user_cb(obj);break;case"config_cb":var o=kiwi_JSON_parse('config_cb',param[1]);if(o)config_cb(o.r,o.g,o.s,o.pu,o.pe,o.pv,o.pi,o.n,o.m,o.v1,o.v2,o.ai);break;case"update_cb":var o=kiwi_JSON_parse('update_cb',param[1]);if(o)update_cb(o.f,o.p,o.i,o.r,o.g,o.v1,o.v2,o.p1,o.p2,decodeURIComponent(o.d),decodeURIComponent(o.t));break;case"stats_cb":var o=kiwi_JSON_parse('stats_cb',param[1]);if(o){if(o.ce!=undefined)
cpu_stats_cb(o,o.ct,o.ce,o.fc);xfer_stats_cb(o.ac,o.wc,o.fc,o.ah,o.as);extint.srate=o.sr;extint.nom_srate=o.nsr;gps_stats_cb(o.ga,o.gt,o.gg,o.gf,o.gc,o.go);if(o.gr){kiwi.WSPR_rgrid=decodeURIComponent(o.gr);kiwi.GPS_fixes=o.gf;}
if(o.sh==-1){w3_innerHTML('id-rx-snr',', SNR ',o.sa,' dB');w3_innerHTML('id-msg-snr','SNR: All ',o.sa,' dB');}else{w3_innerHTML('id-rx-snr',', SNR ',o.sa,':',o.sh,' dB');w3_innerHTML('id-msg-snr','SNR: All ',o.sa,' dB, HF ',o.sh,' dB');}
admin_stats_cb(o.ad,o.au,o.ae,o.ar,o.an,o.ap,o.an2,o.ai);w3_call('config_status_cb',o);time_display_cb(o);}
break;case"status_msg_text":kiwi_output_msg_p.s=param[1];kiwi_output_msg('id-output-msg','id-output-msg',kiwi_output_msg_p);break;case"status_msg_html":var s=kiwi_decodeURIComponent('status_msg_html',param[1]);w3_innerHTML('id-status-msg',s);w3_innerHTML('id-msg-status',s);break;case"is_admin":extint_isAdmin_cb(param[1]);break;case"is_local":var p=param[1].split(',');console.log('kiwi_msg rx_chan='+p[0]+' is_local='+p[1]);kiwi.is_local[+p[0]]=+p[1];break;case"no_admin_reopen_retry":admin.no_admin_reopen_retry=true;break;case"is_multi_core":kiwi.is_multi_core=1;break;case"authkey_cb":extint_authkey_cb(param[1]);break;case"down":kiwi_down(param[1],reason_disabled);break;case"too_busy":kiwi_too_busy(parseInt(param[1]));break;case"monitor":kiwi_monitor();break;case"exclusive_use":kiwi_exclusive_use();break;case"inactivity_timeout":kiwi_inactivity_timeout(param[1]);break;case"ip_limit":var p=decodeURIComponent(param[1]).split(',');kiwi_24hr_ip_limit(parseInt(p[0]),p[1]);break;case"password_timeout":kiwi_password_entry_timeout();break;case"reason_disabled":reason_disabled=kiwi_decodeURIComponent('reason_disabled',param[1]);break;case"sample_rate":extint.srate=parseFloat(param[1]);break;case'pref_import_ch':kiwi.prefs_import_ch=+param[1];break;case'pref_import':prefs_import_cb(param[1],kiwi.prefs_import_ch);break;case'adc_clk_nom':extint_adc_clock_nom_Hz=+param[1];break;case'notify_msg':var s=kiwi_decodeURIComponent('notify_msg',param[1]);console.log('notify_msg: '+s);if(confirmation.displayed)break;s=w3_div('',s);confirmation_show_content(s,425,50);setTimeout(confirmation_panel_close,3000);break;default:rtn=false;break;}
return rtn;}
function kiwi_debug(msg){console.log(msg);msg_send('SET dbug_msg='+encodeURIComponent(msg));}
function kiwi_show_msg(s){html('id-kiwi-msg').innerHTML=s;if(s==''){w3_hide('id-kiwi-msg-container');w3_el('id-kiwi-body').style.overflow='hidden';}else{w3_hide('id-kiwi-container');w3_show_block('id-kiwi-msg-container');w3_el('id-kiwi-body').style.overflow='scroll';}}
function kiwi_server_error(s){kiwi_show_msg('Hmm, there seems to be a problem. <br>'+'The server reported the error: <span style="color:red">'+s+'</span>');seriousError=true;}
function kiwi_serious_error(s){kiwi_show_msg(s);seriousError=true;console.log(s);}
function kiwi_trace(msg){if(msg)console.log('kiwi_trace: '+msg);try{console.trace();}catch(ex){}}
function kiwi_trace_mobile(msg){alert(msg+' '+Error().stack);}



